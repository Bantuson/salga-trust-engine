name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  # Test environment variables
  ENVIRONMENT: testing
  DEBUG: "true"
  DATABASE_URL: "sqlite+aiosqlite:///./test.db"
  REDIS_URL: ""
  SECRET_KEY: "test-secret-key-for-ci"
  SUPABASE_URL: "https://test.supabase.co"
  SUPABASE_ANON_KEY: "test-anon-key"
  SUPABASE_SERVICE_ROLE_KEY: "test-service-role-key"
  ALLOWED_ORIGINS: '["http://localhost:5173","http://localhost:5174"]'
  USES_SQLITE_TESTS: "1"

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install ruff
      - run: ruff check src/ tests/
      - run: ruff format --check src/ tests/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: pip install -e ".[dev]"
      - run: pytest tests/ -v --tb=short --timeout=120 -x
      - run: pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml

  frontend-dashboard:
    name: Dashboard Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend-dashboard
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend-dashboard/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run build

  frontend-public:
    name: Public Dashboard Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend-public
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend-public/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run build
