# Render Blueprint — SALGA Trust Engine Staging
# Deploy: render.com -> New Blueprint Instance -> link this repo

services:
  # Main FastAPI API server
  - type: web
    name: salga-api
    runtime: python
    plan: starter  # $7/month — sufficient for staging
    buildCommand: pip install -e "."
    startCommand: uvicorn src.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: "false"
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SECRET_KEY
        generateValue: true
      - key: SUPABASE_URL
        sync: false  # Set manually in Render dashboard
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: SUPABASE_JWT_SECRET
        sync: false  # Required by verify_supabase_token() in src/core/security.py
      - key: ALLOWED_ORIGINS
        value: '["https://salga-public.vercel.app","https://salga-dashboard.vercel.app"]'
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_WHATSAPP_NUMBER
        sync: false
      - key: DEEPSEEK_API_KEY
        sync: false
      - key: CREW_SERVER_API_KEY
        generateValue: true

  # CrewAI server (separate process)
  - type: web
    name: salga-crew-server
    runtime: python
    plan: starter
    buildCommand: pip install -e "."
    startCommand: uvicorn src.api.v1.crew_server:crew_app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/v1/health
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DEEPSEEK_API_KEY
        sync: false
      - key: CREW_SERVER_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        value: "dummy-key-for-crewai-validation"

  # Celery worker (background tasks: SLA checks, notifications)
  - type: worker
    name: salga-celery
    runtime: python
    plan: starter  # Workers need paid plan on Render
    buildCommand: pip install -e "."
    startCommand: celery -A src.tasks.celery_app worker --loglevel=info --concurrency=2
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: SUPABASE_JWT_SECRET
        sync: false  # Defensive: future Celery tasks may need JWT verification
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_WHATSAPP_NUMBER
        sync: false

  # Redis for Celery broker + rate limiting + conversation state
  - type: redis
    name: salga-redis
    plan: starter  # $7/month
    maxmemoryPolicy: allkeys-lru

databases:
  # PostgreSQL with PostGIS
  - name: salga-db
    plan: starter  # $7/month
    postgresMajorVersion: "15"
