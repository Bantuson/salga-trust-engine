gbv_intake_task:
  description: >
    Support a citizen reporting a gender-based violence or abuse incident.
    The citizen's message: {message}
    Language: {language}
    User ID: {user_id}
    Tenant ID (municipality): {tenant_id}

    TRAUMA-INFORMED PROTOCOL — follow strictly:
    1. SAFETY FIRST: Ask "Are you safe right now?" if not already confirmed.
    2. VALIDATE: Acknowledge their bravery. "I'm sorry this is happening to you."
    3. COLLECT ONLY ESSENTIALS: incident type, general location (area, not exact address),
       danger level (are they still in danger?), do they need SAPS response immediately?
    4. DO NOT over-question. Maximum 3-4 questions total.
    5. CALL create_municipal_ticket tool with category="gbv" to create the report.
       Set is_sensitive=True behavior is automatic for gbv category.
    6. CALL notify_saps tool to log the incident for SAPS (internal log in v1).

    Tool parameters for create_municipal_ticket:
    - category: "gbv" (ALWAYS use this value)
    - description: brief summary of the incident (NO victim identifying details)
    - user_id: {user_id}
    - tenant_id: {tenant_id}
    - language: {language}
    - severity: "critical" if immediate danger, "high" otherwise
    - address: general area only (NOT exact home address)

    Emergency numbers to share at any point if citizen is in danger:
    - SAPS: 10111
    - GBV Command Centre: 0800 150 150
  expected_output: >
    A trauma-informed response confirming the report has been logged with a
    tracking number, and emergency contact information. Include the SAPS number
    (10111) and GBV Helpline (0800 150 150) in every response.

municipal_intake_task:
  description: >
    Conduct intake for a municipal service report from a citizen.
    The citizen's message: {message}
    Language: {language}
    Municipality (tenant_id): {tenant_id}
    User ID: {user_id}

    Gather the following information from the citizen's message:
    1. Service category (water, roads, electricity, waste, sanitation)
    2. Exact location (address or landmarks)
    3. Detailed description of the issue
    4. Severity assessment (low, medium, high, critical)

    MANDATORY: You MUST call the create_municipal_ticket tool to persist the ticket
    to the database. This is the ONLY way tickets are created. Do NOT just return
    data — you MUST invoke the tool. Your task is NOT complete until the tool has
    been called and returned a tracking number.

    Tool parameters (all required):
    - category: one of water, roads, electricity, waste, sanitation, other
    - description: detailed description (minimum 20 characters)
    - user_id: {user_id}
    - tenant_id: {tenant_id}
    - language: {language}
    - severity: low, medium, high, or critical
    - address: the location described by the citizen

    If the citizen's message contains enough information to determine category,
    location, description, and severity, call the tool immediately.
    If critical information is missing, ask ONE clarifying question.
  expected_output: >
    The JSON result returned by the create_municipal_ticket tool, which contains
    the tracking_number (format TKT-YYYYMMDD-XXXXXX), ticket id, status, category,
    and severity. Include a brief confirmation message for the citizen with their
    tracking number.

auth_task:
  description: >
    Authenticate a citizen for municipal service reporting.
    Phone: {phone}
    Language: {language}
    User exists: {user_exists}
    Session status: {session_status}

    Greeting and persona are handled by the agent backstory. Do NOT add your
    own greeting or self-introduction — the agent identity layer handles this.

    If returning user with expired session: request OTP re-authentication only.
    If new user: offer phone or email registration path, then collect full details.
    Proof of residence is REQUIRED before municipality assignment.
  expected_output: >
    Authenticated user with active session, or clear error message explaining
    what step failed and how to retry.

manager_task:
  description: >
    Handle this citizen message as the first-contact manager.

    Message: {message}
    Phone: {phone}
    Language: {language}
    Session status: {session_status}
    User exists: {user_exists}
    User ID: {user_id}
    Conversation history: {conversation_history}
    Pending intent (if returning from auth): {pending_intent}

    STEP 1 — GREET AND COLLECT NAME + LANGUAGE (new sessions only):
    If this is a new session (no conversation history), you MUST do the following
    before anything else:
    1a. Greet the citizen warmly as Gugu and ask for their NAME.
        Example: "Hi! I'm Gugu from the SALGA Trust Engine. What is your name? /
        Ngubani igama lakho? / Wat is jou naam?"
    1b. After receiving their name, ask which LANGUAGE they prefer:
        "Welcome [name]! Which language do you prefer? English, isiZulu, or Afrikaans?"
    1c. Only AFTER you have their name and language preference, ask how you can help:
        "Great, [name]! How can I help you today?"

    These three sub-steps (name, language, then intent) are MANDATORY for new sessions.
    Do NOT skip to STEP 2 until you have the citizen's name and language preference.
    Do NOT ask all three questions in one message — one question per message.

    STEP 2 — CLASSIFY INTENT:
    Classify the citizen's message into one of these intents:
    - greeting: Simple greeting or pleasantry (no action needed)
    - off_topic: Unrelated to municipal services (handle directly, politely redirect)
    - municipal_report: Wants to report a service delivery issue (water, roads, electricity, waste, sanitation)
    - gbv_report: Reporting gender-based violence or abuse (crisis context)
    - ticket_status: Wants to check status of an existing report

    STEP 3 — AUTH CHECK:
    - greeting and off_topic: NO authentication required. Handle directly.
    - municipal_report, gbv_report, ticket_status: REQUIRES active session.
      If session_status is NOT "active", delegate to "Citizen Authentication Specialist" FIRST.

    STEP 4 — DELEGATE to the appropriate specialist:
    - Authentication needed: delegate to "Citizen Authentication Specialist"
      Pass: full message context, phone, language, user_exists, session_status.
    - Municipal report (authenticated): delegate to "Municipal Services Intake Specialist"
      Pass: the citizen's message, user_id, tenant_id, language.
    - GBV report (authenticated): delegate to "Crisis Support Specialist"
      Pass: the citizen's message, user_id, language.
    - Ticket status (authenticated): delegate to "Ticket Status Specialist"
      Pass: user_id, language, tracking_number (if mentioned), conversation_history.

    IMPORTANT: When delegating, pass the FULL context including conversation history
    and the original citizen message. The specialist needs this to respond correctly.

    If pending_intent is set (citizen returning from auth), route directly to the
    appropriate specialist without re-classifying — the intent was already determined.
  expected_output: >
    The specialist's response to the citizen, or Gugu's own greeting/redirect response.

ticket_status_task:
  description: >
    Help this citizen check the status of their existing reports.

    User ID: {user_id}
    Language: {language}
    Tracking number (if provided): {tracking_number}
    Conversation history: {conversation_history}

    INSTRUCTIONS:
    1. Use the lookup_ticket tool with user_id (MANDATORY) to retrieve tickets.
       If a tracking_number is provided, pass it to filter results.
       If no tracking_number, retrieve all recent tickets (tool returns up to 10).

    2. Present results clearly:
       - Show the most recent ticket FIRST.
       - For each ticket, show: tracking number, category, status, address (if available),
         date reported, and whether it has been responded to or escalated.
       - If multiple tickets: show the first, then say
         "You have X more open reports. Would you like to see them all?"
       - GBV / sensitive tickets: show ONLY status and emergency numbers
         (SAPS 10111 | GBV Helpline 0800 150 150). No other details.

    3. If no tickets found:
       - Guide citizen to double-check their tracking number.
       - Suggest they use the format TKT-YYYYMMDD-XXXXXX.

    4. Offer next steps: report a new issue, or ask about a specific ticket.
  expected_output: >
    Ticket status information presented clearly to the citizen with next steps.
