---
phase: 06.9.2-system-wide-integration-validation
plan: 05
subsystem: testing
tags: [pytest, crewai, ticket-tool, public-metrics, crew-server, sec-05, multi-tenant, gbv-firewall, sanitize-reply, slowapi]

# Dependency graph
requires:
  - phase: 06.9.2-01
    provides: crew server rate limiting, CORS, input validation on ChatRequest
  - phase: 06.9.2-02
    provides: dashboard error handling foundation
  - phase: 06.9
    provides: ManagerCrew hierarchical routing, crew_server.py architecture
  - phase: 06.9.1
    provides: output formatting, sanitize_reply, GBV debug redaction
  - phase: 04
    provides: ticket model, Supabase ticket creation via ticket_tool.py
  - phase: 06
    provides: PublicMetricsService with is_sensitive=False filters
provides:
  - "End-to-end 3-way communication flow tests (tests/test_3way_communication.py)"
  - "Crew server endpoint behavioral tests (tests/test_crew_server_integration.py)"
  - "SEC-05 GBV firewall verified at public stats layer (Layer 5)"
  - "Multi-tenant isolation verified in ticket visibility"
  - "sanitize_reply behavior validated (LLM artifacts, delegation, fallback)"
  - "InMemoryConversationManager behavior validated"
  - "GBV debug redaction verified (metadata-only in debug dict)"
affects: [06.9.2-verifier, future-ci-runs, regression-testing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "patch src.core.supabase.get_supabase_admin (not src.agents.tools.ticket_tool.get_supabase_admin) — imported locally inside _create_ticket_impl"
    - "slowapi @limiter.limit decorator wraps function at import time — cannot call rate-limited endpoint functions directly in tests; test internal logic instead"
    - "Starlette Request scope construction for unit tests: type/method/path/headers/client/query_string minimum fields"
    - "pytest.mark.asyncio module-level pytestmark applies to sync tests as harmless warning (not error)"

key-files:
  created:
    - tests/test_3way_communication.py
    - tests/test_crew_server_integration.py
  modified: []

key-decisions:
  - "patch src.core.supabase.get_supabase_admin (not tool module) — ticket_tool imports get_supabase_admin locally inside _create_ticket_impl"
  - "slowapi wraps rate-limited endpoints at decoration time — direct function calls fail with 'parameter request must be starlette Request'; test internal logic directly"
  - "GBV debug redaction tested via logic simulation (not HTTP) — validates crew_server.py Step 5 branch directly"
  - "Session reset tested via InMemoryConversationManager.clear_session directly (same code path as reset_session endpoint)"

patterns-established:
  - "3-way flow tests: mock Supabase at src.core.supabase level (not tool level)"
  - "Rate-limited endpoint testing: test internal logic functions, not HTTP endpoints"
  - "PublicMetricsService unit tests: AsyncMock side_effect lists for sequential DB queries"

requirements-completed: [AI-01, AI-02, AI-03, TKT-01, TKT-02, SEC-05, PLAT-01, PLAT-02, PLAT-03, PLAT-04, SEC-01]

# Metrics
duration: 37min
completed: 2026-02-21
---

# Phase 06.9.2 Plan 05: 3-Way Communication Flow and Crew Server Integration Tests

**39 integration tests validating agent ticket creation -> municipal dashboard -> public stats data flow, GBV SEC-05 firewall at Layer 5, and crew server endpoint behavior (sanitize_reply, API key auth, rate limits, GBV redaction)**

## Performance

- **Duration:** 37 min
- **Started:** 2026-02-21T00:19:39Z
- **Completed:** 2026-02-21T00:57:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Agent ticket creation via ticket_tool tested end-to-end: Supabase insert verified with correct fields (tracking_number, category, status='open', tenant_id, is_sensitive)
- GBV SEC-05 Layer 5 verified: sensitive tickets excluded from public stats, response times, and public total_tickets count
- Multi-tenant isolation validated: ticket from Municipality A not visible to manager of Municipality B
- Full 3-way simulation: agent creates ticket, ticket visible in dashboard query, public stats count non-sensitive tickets, GBV absent from public total
- Crew server behavioral tests: health (200/ok), API key auth (401 without key), input validation (422 for >2000 chars, <7 or >20 char phone), sanitize_reply strips all LLM artifacts
- GBV debug redaction verified: only agent_name/turn_count/session_status in debug dict (no phone, agent_result, raw_reply, detection)
- Language preference detection: English/isiZulu/Afrikaans keyword patterns all tested
- InMemoryConversationManager: create/retrieve/clear sessions, GBV namespace separation

## Task Commits

1. **Task 1: 3-way communication flow integration tests** - `9889a34` (feat)
2. **Task 2: Crew server endpoint behavioral tests** - `d4d5ab3` (feat)

## Files Created/Modified
- `tests/test_3way_communication.py` - 11 tests: agent->DB, dashboard visibility, public stats, GBV exclusion (SEC-05 Layer 5), cross-municipality isolation, WhatsApp notification dispatch, full 3-way simulation, GBV is_sensitive flag, invalid input error dicts
- `tests/test_crew_server_integration.py` - 28 tests: health, API key auth, chat routing, session reset, input validation, sanitize_reply, GBV debug redaction, language detection, rate limit constants, CORS middleware, InMemoryConversationManager lifecycle

## Decisions Made
- Patch `src.core.supabase.get_supabase_admin` (not `src.agents.tools.ticket_tool.get_supabase_admin`) because ticket_tool imports get_supabase_admin with a local import inside `_create_ticket_impl`
- Rate-limited endpoints (chat, session/reset) cannot be called directly in tests because slowapi's `@limiter.limit` decorator wraps the function at import time and inspects for a kwarg named exactly `request` that is a Starlette Request — our endpoints rename it to `http_request` to avoid collision with the Pydantic body param
- GBV debug redaction test uses logic simulation (tests the Step 5 branch code directly) rather than HTTP transport since the endpoint is rate-limited

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed mock patch target for get_supabase_admin**
- **Found during:** Task 1 (3-way communication tests)
- **Issue:** Initial patch targeted `src.agents.tools.ticket_tool.get_supabase_admin` but that attribute doesn't exist at module level — it's imported locally inside `_create_ticket_impl`
- **Fix:** Changed patch target to `src.core.supabase.get_supabase_admin` (the actual module where it lives)
- **Files modified:** tests/test_3way_communication.py
- **Verification:** All 11 tests pass after fix
- **Committed in:** 9889a34 (Task 1 commit)

**2. [Rule 1 - Bug] Fixed notification task path**
- **Found during:** Task 1 (WhatsApp notification test)
- **Issue:** Used incorrect module path `src.tasks.notification_tasks.send_ticket_update_notification`; actual module is `src.tasks.status_notify.send_status_notification`
- **Fix:** Updated to correct path with correct parameter names
- **Files modified:** tests/test_3way_communication.py
- **Verification:** Test passes after fix
- **Committed in:** 9889a34 (Task 1 commit)

**3. [Rule 1 - Bug] Fixed rate-limited endpoint call pattern**
- **Found during:** Task 2 (crew server endpoint tests)
- **Issue:** slowapi `@limiter.limit` decorator wraps functions at import time; calling decorated functions directly fails with "parameter `request` must be an instance of starlette.requests.Request" because slowapi inspects for kwarg named `request` (finds ChatRequest, not Starlette Request)
- **Fix:** Restructured 3 tests to test internal logic directly: (a) test `_validate_api_key` for auth, (b) simulate chat() logic step by step, (c) test InMemoryConversationManager.clear_session for session reset, (d) test GBV debug branch as logic simulation
- **Files modified:** tests/test_crew_server_integration.py
- **Verification:** All 28 tests pass
- **Committed in:** d4d5ab3 (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (Rule 1 bugs found during test execution)
**Impact on plan:** All auto-fixes were test patching/targeting issues, not production code bugs. No scope creep. Both test files exceed minimum line requirements (572 and 667 lines vs 80 and 60 required).

## Issues Encountered
- slowapi rate-limit decorator conflict with direct function calls — resolved by testing internal logic rather than the decorated endpoint wrappers
- ManagerCrew imported locally inside `chat()` function — patched at `src.agents.crews.manager_crew.ManagerCrew` level (correct import location)

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 06.9.2 complete: all 5 plans delivered (API rate limiting, dashboard error handling, CI/CD, code quality, 3-way communication validation)
- Integration test suite now validates full data path from agent ticket creation through to public transparency stats
- GBV firewall tested at all layers including the public stats aggregation layer
- Crew server behavioral tests cover all key security and functional requirements

---
*Phase: 06.9.2-system-wide-integration-validation*
*Completed: 2026-02-21*
