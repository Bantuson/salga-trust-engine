---
phase: 06.9.2-system-wide-integration-validation
plan: 02
subsystem: ui
tags: [axios, supabase, react, error-handling, typescript]

# Dependency graph
requires:
  - phase: 06.1.1-teams-analytics-and-settings-pages-ui
    provides: useTeams, useSettings, useAnalytics hooks and api.ts service

provides:
  - Axios 401 retry interceptor with token refresh queue in frontend-dashboard/src/services/api.ts
  - useAnalytics hook now exposes error state (previously silent)
  - Supabase connectivity diagnostic check in usePublicStats.ts module load
  - Both dashboards TypeScript-clean (0 errors on build:check)

affects:
  - 06.9.2-03 (frontend builds must stay green for CI/CD pipeline)
  - Any future frontend plan that adds hooks or pages

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "401 retry pattern: isRefreshing flag + failedQueue array prevents concurrent refresh races"
    - "Supabase module-level connectivity check: fire-and-forget .then() diagnostic, no render blocking"

key-files:
  created: []
  modified:
    - frontend-dashboard/src/services/api.ts
    - frontend-dashboard/src/hooks/useAnalytics.ts
    - frontend-dashboard/src/components/settings/NotificationsSection.tsx
    - frontend-dashboard/src/components/teams/PermissionMatrix.tsx
    - frontend-dashboard/src/components/teams/TeamDetailModal.tsx
    - frontend-public/src/hooks/usePublicStats.ts
    - frontend-public/src/components/citizen/GBVConsentDialog.tsx
    - frontend-public/src/components/citizen/PersonalStats.tsx
    - frontend-public/src/components/citizen/ReportReceipt.tsx
    - frontend-public/src/contexts/AuthContext.tsx
    - frontend-public/src/pages/CitizenRegisterPage.tsx
    - frontend-public/src/pages/ProfilePage.tsx
    - frontend-public/src/pages/ReportIssuePage.tsx

key-decisions:
  - "401 retry uses isRefreshing flag + failedQueue array: prevents N concurrent refresh calls from race-conditioning a token rotation loop"
  - "Session expired after refresh failure redirects to /login (fail-safe): user is not left in silent broken state"
  - "useAnalytics error state now exposed (was null/swallowed): caller can display user-readable message"
  - "Supabase connectivity check is module-level fire-and-forget (not per-hook): logs once per page load, no performance impact"
  - "animejs v4 signature fix: animate(targets, options) not animate({ targets, ...options }) — v4 breaking change"
  - "signUp metadata type extended with municipality field: Supabase user_metadata passes it through, no schema change needed"

requirements-completed:
  - OPS-01
  - OPS-02
  - TRNS-01
  - TRNS-02
  - TRNS-03

# Metrics
duration: 26min
completed: 2026-02-20
---

# Phase 06.9.2 Plan 02: Dashboard Error Handling Summary

**Axios 401 retry interceptor with token refresh queue added to municipal dashboard; public dashboard TypeScript-clean with Supabase connectivity diagnostics**

## Performance

- **Duration:** 26 min (1564s)
- **Started:** 2026-02-20T09:03:53Z
- **Completed:** 2026-02-20T09:30:37Z
- **Tasks:** 2
- **Files modified:** 13

## Accomplishments

- Municipal dashboard API calls now retry on 401 with automatic token refresh before redirecting to login
- Public dashboard `usePublicStats.ts` module-level Supabase connectivity check logs warnings without blocking renders
- Both dashboards compile and build with zero TypeScript errors (was previously broken with 11 pre-existing errors)

## Task Commits

1. **Task 1: Municipal dashboard 401 retry interceptor** - `d7a4891` (feat)
2. **Task 2: Public dashboard Supabase resilience + TS fixes** - `b81c34f` (feat)

## Files Created/Modified

- `frontend-dashboard/src/services/api.ts` - Added response interceptor with 401 retry, token refresh, and request queue
- `frontend-dashboard/src/hooks/useAnalytics.ts` - Added `error` state field (was swallowed silently)
- `frontend-dashboard/src/components/settings/NotificationsSection.tsx` - Removed unused `useEffect` import
- `frontend-dashboard/src/components/teams/PermissionMatrix.tsx` - Removed unused `columnCount` variable
- `frontend-dashboard/src/components/teams/TeamDetailModal.tsx` - Removed unused `handleMembersRefresh` and `setMembersRefreshKey`
- `frontend-public/src/hooks/usePublicStats.ts` - Added module-level Supabase connectivity diagnostic
- `frontend-public/src/components/citizen/GBVConsentDialog.tsx` - Removed unused `React` import
- `frontend-public/src/components/citizen/PersonalStats.tsx` - Fixed animejs v4 API: `animate(targets, opts)` signature
- `frontend-public/src/components/citizen/ReportReceipt.tsx` - Removed unused `React` import
- `frontend-public/src/contexts/AuthContext.tsx` - Added `municipality` to `signUp` metadata type
- `frontend-public/src/pages/CitizenRegisterPage.tsx` - Removed unused `navigate`, fixed `formFieldsRef` type
- `frontend-public/src/pages/ProfilePage.tsx` - Removed unused `uploadData` variable
- `frontend-public/src/pages/ReportIssuePage.tsx` - Removed unused `useCallback`, `useEffect` imports

## Decisions Made

- **401 retry with queue pattern**: When a 401 arrives mid-flight while a refresh is already in progress, the request joins a queue and resolves with the new token instead of triggering a second refresh. This prevents token rotation loops in concurrent-request scenarios.
- **Redirect only on true expiry**: `window.location.href = '/login'` fires only when `refreshSession()` returns an error or null session — a working session refresh retries transparently.
- **useAnalytics error surface**: Previously set `setData(null)` and `console.error` on failure. Now sets `error` state to a user-readable message (string) so callers can display "Failed to load analytics data".
- **animejs v4 breaking change handled**: v4 changed from `anime({ targets, ...opts })` to `animate(targets, opts)`. Also renamed `update` callback to `onUpdate`.
- **Municipality in signUp metadata**: Supabase `auth.signUp()` passes arbitrary JSON through `options.data` to `user_metadata`. Adding `municipality` to the TypeScript type is a type-only change — no schema or backend impact.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed 3 pre-existing TypeScript errors in frontend-dashboard blocking build:check**
- **Found during:** Task 1 verification
- **Issue:** `NotificationsSection.tsx` had unused `useEffect`; `PermissionMatrix.tsx` had unused `columnCount`; `TeamDetailModal.tsx` had unused `handleMembersRefresh` function
- **Fix:** Removed unused import, variable, and function. `membersRefreshKey` state simplified to `const [membersRefreshKey] = useState(0)` since the setter was only used in the removed function
- **Files modified:** NotificationsSection.tsx, PermissionMatrix.tsx, TeamDetailModal.tsx
- **Verification:** `npm run build:check` passes with 0 errors
- **Committed in:** d7a4891 (Task 1 commit)

**2. [Rule 3 - Blocking] Fixed 8 pre-existing TypeScript errors in frontend-public blocking build:check**
- **Found during:** Task 2 verification
- **Issue:** Multiple files had TS6133 (unused imports), TS2554 (wrong animejs call signature), TS2322 (ref type mismatch), TS2353 (unknown metadata field), TS6133 (unused navigate/uploadData)
- **Fix:** Removed unused React/hook imports; fixed animejs v4 `animate(targets, opts)` signature; changed `formFieldsRef` from `HTMLDivElement` to `HTMLFormElement`; added `municipality` to signUp metadata type; removed unused `navigate` call and `uploadData` destructuring
- **Files modified:** 8 files across frontend-public/src/
- **Verification:** `npm run build:check` passes with 0 errors; `npm run build` succeeds
- **Committed in:** b81c34f (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (both Rule 3 — blocking pre-existing errors)
**Impact on plan:** All auto-fixes were pre-existing errors that blocked the plan's verification step (`npm run build:check`). No scope creep — strictly necessary fixes.

## Issues Encountered

- `git stash pop` conflicted with an unrelated `src/middleware/rate_limit.py` modification from a prior session. Resolved by resetting the conflicting file before popping the stash. No code was lost.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Both dashboards have clean TypeScript builds (required for CI/CD pipeline in 06.9.2-03/04/05)
- Municipal dashboard API layer now handles token expiry gracefully (no more silent 401 failures)
- Public dashboard degrades to mock data on Supabase errors with connection diagnostics

---
*Phase: 06.9.2-system-wide-integration-validation*
*Completed: 2026-02-20*

## Self-Check: PASSED

- FOUND: frontend-dashboard/src/services/api.ts
- FOUND: frontend-public/src/hooks/usePublicStats.ts
- FOUND commit: d7a4891 (Task 1)
- FOUND commit: b81c34f (Task 2)
- frontend-dashboard npm run build:check: PASS
- frontend-public npm run build:check: PASS
