---
phase: 06.9.2-system-wide-integration-validation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .github/workflows/ci.yml
  - render.yaml
  - .ruff.toml
autonomous: true
requirements:
  - PLAT-05

must_haves:
  truths:
    - "CI pipeline runs lint, type-safe checks, unit tests, coverage, and frontend builds on every push"
    - "Ruff linter is configured and can be run locally"
    - "render.yaml describes all 3 backend services (web, worker, crew server) + Redis"
    - "CI pipeline definition exists and is syntactically valid"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      contains: "pytest"
    - path: "render.yaml"
      provides: "Render Blueprint for staging deployment"
      contains: "salga-trust-engine"
    - path: ".ruff.toml"
      provides: "Python linter configuration"
      contains: "line-length"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pyproject.toml"
      via: "pip install and pytest"
      pattern: "pip install"
    - from: "render.yaml"
      to: "src/main.py"
      via: "uvicorn start command"
      pattern: "uvicorn src.main:app"
---

<objective>
Set up code quality tooling (ruff linter), CI/CD pipeline (GitHub Actions), and staging deployment config (Render).

Purpose: No CI/CD exists. No Python linter is configured. This plan creates the infrastructure for automated quality gates and deployment.

Output: .ruff.toml, .github/workflows/ci.yml, render.yaml — all ready to use.

NOTE — Manual post-execution steps (not automated here): Actual Render deployment requires a human to visit render.com, create a Blueprint instance pointing at this repo, and set the `sync: false` env vars (Supabase keys, Twilio credentials, DeepSeek API key) in the Render dashboard. Live Twilio staging integration testing is also a manual step performed after the Render services are running.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@pyproject.toml
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure ruff linter and GitHub Actions CI pipeline</name>
  <files>pyproject.toml, .ruff.toml, .github/workflows/ci.yml</files>
  <action>
1. Create .ruff.toml with sensible defaults for this project:
   ```toml
   # Ruff linter configuration for SALGA Trust Engine
   line-length = 120
   target-version = "py312"

   [lint]
   select = [
     "E",      # pycodestyle errors
     "W",      # pycodestyle warnings
     "F",      # pyflakes
     "I",      # isort
     "N",      # pep8-naming
     "UP",     # pyupgrade
     "B",      # flake8-bugbear
     "SIM",    # flake8-simplify
     "S",      # flake8-bandit (security)
   ]
   ignore = [
     "E501",   # line too long (handled by line-length)
     "S101",   # assert usage (OK in tests)
     "S104",   # binding to 0.0.0.0 (required for deployment)
     "S105",   # hardcoded password (false positives on test fixtures)
     "S106",   # hardcoded password (false positives on test fixtures)
     "B008",   # function call in default arg (FastAPI Depends pattern)
   ]

   [lint.per-file-ignores]
   "tests/**" = ["S101", "S105", "S106"]
   "alembic/**" = ["E", "W", "I"]
   ```

2. Add ruff to dev dependencies in pyproject.toml:
   Under [project.optional-dependencies] dev, add:
   ```
   "ruff>=0.8.0",
   ```

3. Create .github/workflows/ci.yml:
   ```yaml
   name: CI

   on:
     push:
       branches: [main]
     pull_request:
       branches: [main]

   env:
     PYTHON_VERSION: "3.12"
     NODE_VERSION: "20"
     # Test environment variables
     ENVIRONMENT: testing
     DEBUG: "true"
     DATABASE_URL: "sqlite+aiosqlite:///./test.db"
     REDIS_URL: ""
     SECRET_KEY: "test-secret-key-for-ci"
     SUPABASE_URL: "https://test.supabase.co"
     SUPABASE_ANON_KEY: "test-anon-key"
     SUPABASE_SERVICE_ROLE_KEY: "test-service-role-key"
     ALLOWED_ORIGINS: '["http://localhost:5173","http://localhost:5174"]'
     USES_SQLITE_TESTS: "1"

   jobs:
     lint:
       name: Lint & Format
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-python@v5
           with:
             python-version: ${{ env.PYTHON_VERSION }}
         - run: pip install ruff
         - run: ruff check src/ tests/
         - run: ruff format --check src/ tests/

     test:
       name: Unit Tests
       runs-on: ubuntu-latest
       needs: lint
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-python@v5
           with:
             python-version: ${{ env.PYTHON_VERSION }}
             cache: pip
         - run: pip install -e ".[dev]"
         - run: pytest tests/ -v --tb=short --timeout=120 -x
         - run: pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing
         - uses: actions/upload-artifact@v4
           if: always()
           with:
             name: coverage-report
             path: coverage.xml

     frontend-dashboard:
       name: Dashboard Build
       runs-on: ubuntu-latest
       defaults:
         run:
           working-directory: frontend-dashboard
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-node@v4
           with:
             node-version: ${{ env.NODE_VERSION }}
             cache: npm
             cache-dependency-path: frontend-dashboard/package-lock.json
         - run: npm ci
         - run: npm run lint
         - run: npm run build

     frontend-public:
       name: Public Dashboard Build
       runs-on: ubuntu-latest
       defaults:
         run:
           working-directory: frontend-public
       steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-node@v4
           with:
             node-version: ${{ env.NODE_VERSION }}
             cache: npm
             cache-dependency-path: frontend-public/package-lock.json
         - run: npm ci
         - run: npm run lint
         - run: npm run build
   ```

4. Ensure the .github/workflows/ directory is created:
   - mkdir -p .github/workflows/ (use Bash)
  </action>
  <verify>
    - `python -m ruff check src/ --select E,F --statistics 2>&1 | head -20` — ruff runs (may show warnings, that's expected for existing code)
    - `.github/workflows/ci.yml` exists and is valid YAML: `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" 2>&1` — if pyyaml not installed, just verify file exists
  </verify>
  <done>Ruff linter configured with security rules, GitHub Actions CI pipeline runs lint + tests + coverage + both frontend builds</done>
</task>

<task type="auto">
  <name>Task 2: Create Render Blueprint for staging deployment</name>
  <files>render.yaml</files>
  <action>
Create render.yaml at repo root with Render Blueprint specification for all backend services:

```yaml
# Render Blueprint — SALGA Trust Engine Staging
# Deploy: render.com → New Blueprint Instance → link this repo

services:
  # Main FastAPI API server
  - type: web
    name: salga-api
    runtime: python
    plan: starter  # $7/month — sufficient for staging
    buildCommand: pip install -e "."
    startCommand: uvicorn src.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: DEBUG
        value: "false"
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SECRET_KEY
        generateValue: true
      - key: SUPABASE_URL
        sync: false  # Set manually in Render dashboard
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: ALLOWED_ORIGINS
        value: '["https://salga-public.vercel.app","https://salga-dashboard.vercel.app"]'
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_WHATSAPP_FROM
        sync: false
      - key: DEEPSEEK_API_KEY
        sync: false
      - key: CREW_SERVER_API_KEY
        generateValue: true

  # CrewAI server (separate process)
  - type: web
    name: salga-crew-server
    runtime: python
    plan: starter
    buildCommand: pip install -e "."
    startCommand: uvicorn src.api.v1.crew_server:crew_app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/v1/health
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DEEPSEEK_API_KEY
        sync: false
      - key: CREW_SERVER_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        value: "dummy-key-for-crewai-validation"

  # Celery worker (background tasks: SLA checks, notifications)
  - type: worker
    name: salga-celery
    runtime: python
    plan: starter  # Workers need paid plan on Render
    buildCommand: pip install -e "."
    startCommand: celery -A src.celery_app worker --loglevel=info --concurrency=2
    envVars:
      - key: ENVIRONMENT
        value: staging
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: DATABASE_URL
        fromDatabase:
          name: salga-db
          property: connectionURI
      - key: REDIS_URL
        fromService:
          name: salga-redis
          type: redis
          property: connectionURI
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_WHATSAPP_FROM
        sync: false

  # Redis for Celery broker + rate limiting + conversation state
  - type: redis
    name: salga-redis
    plan: starter  # $7/month
    maxmemoryPolicy: allkeys-lru

databases:
  # PostgreSQL with PostGIS
  - name: salga-db
    plan: starter  # $7/month
    postgresMajorVersion: "15"
```

NOTE: render.yaml uses `sync: false` for secrets that must be set manually in the Render dashboard (Supabase keys, Twilio credentials, DeepSeek API key). These should NEVER be hardcoded.
  </action>
  <verify>
    - `python -c "import yaml; d=yaml.safe_load(open('render.yaml')); print(len(d.get('services',[])), 'services,', len(d.get('databases',[])), 'databases')"` shows "4 services, 1 databases" (or verify file exists and is valid YAML)
    - If pyyaml is not installed: just verify the file exists and is non-empty
  </verify>
  <done>render.yaml defines 4 services (API, crew server, Celery worker, Redis) and 1 database (PostgreSQL), with all secrets marked sync:false for manual configuration</done>
</task>

</tasks>

<verification>
- .ruff.toml exists and ruff can parse it
- .github/workflows/ci.yml exists with lint, test, and frontend build jobs
- render.yaml exists with all required services
- pyproject.toml has ruff in dev dependencies
</verification>

<success_criteria>
- `ruff check src/ --select E,F` runs without crashing (warnings are OK)
- CI pipeline YAML is valid
- render.yaml describes complete staging infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/06.9.2-system-wide-integration-validation-full-security-audit-api-completeness-3-way-communication-code-quality-ci-cd-render-staging/06.9.2-03-SUMMARY.md`
</output>
