# Phase 6.1: Postgres Refactor to Supabase and Dashboard Separation - Context

**Gathered:** 2026-02-10
**Status:** Ready for planning

<domain>
## Phase Boundary

Migrate the backend from plain PostgreSQL to Supabase Cloud (database, auth, storage, realtime) and split the single frontend into two independently deployable React apps — a public transparency dashboard and an authenticated municipal operations dashboard. Celery + Redis background tasks remain unchanged. FastAPI remains the backend API for the municipal dashboard.

</domain>

<decisions>
## Implementation Decisions

### Supabase Auth Strategy
- Migrate fully to Supabase Auth — replace custom JWT + Argon2 system with Supabase's built-in auth
- Implement full OWASP-compliant authentication and authorization via Supabase Auth
- Citizen web portal supports BOTH phone OTP and email + password registration
- WhatsApp users identified by phone number automatically (existing Twilio integration links to Supabase Auth user)
- RBAC roles (CITIZEN, MANAGER, ADMIN, SAPS_LIAISON, WARD_COUNCILLOR, FIELD_WORKER) — Claude decides best pattern based on Supabase RBAC research (custom claims vs roles table)
- Municipal staff auth goes through same Supabase Auth system as citizens (unified auth, role-differentiated access)

### Supabase Feature Adoption
- **Database:** Supabase Cloud hosted PostgreSQL (includes PostGIS extension support)
- **Auth:** Full migration to Supabase Auth (replacing custom JWT + Argon2)
- **Storage:** Migrate from AWS S3 to Supabase Storage (media uploads, evidence photos, documents). Must maintain GBV encryption requirements.
- **Realtime:** Migrate from Redis Pub/Sub + SSE to Supabase Realtime for dashboard live updates (WebSocket-based)
- **Background Jobs:** Keep Celery + Redis for SLA monitoring, escalation, and WhatsApp notifications (NOT moving to Edge Functions)
- **Hosting:** Supabase Cloud (hosted) — not self-hosted

### Dashboard Deployment Model
- **Two separate Vite apps** — `frontend-public/` and `frontend-dashboard/` as independent projects with separate package.json
- **Municipal dashboard** deployed on Vercel (calls FastAPI backend for all data)
- **Public dashboard** deployed on Supabase hosting (uses Supabase JS client directly with anon key — no FastAPI dependency)
- **Municipal dashboard data flow:** React → FastAPI → Supabase PostgreSQL (backend controls all business logic)
- **Public dashboard data flow:** React → Supabase JS client → PostgreSQL via RLS (serverless, no backend needed)

### Claude's Discretion
- RBAC implementation pattern (Supabase custom claims vs separate roles table) — pick what's best for the 6-role model
- RLS policy migration approach (current SET LOCAL app.current_tenant → Supabase auth.uid() or auth.jwt() patterns)
- GBV firewall adaptation for Supabase Storage (bucket-level RLS for sensitive media)
- How to handle the public dashboard's GBV data exclusion via RLS policies alone (without FastAPI intermediary)
- Alembic migration strategy for Supabase-hosted PostgreSQL
- Supabase Realtime channel design for ticket status updates

</decisions>

<specifics>
## Specific Ideas

- User wants "better auth with full authentication, authorization, OWASP security" — Supabase Auth should be configured with security best practices (rate limiting, email verification, strong password policies)
- Public dashboard should be fully serverless (Supabase JS client + Supabase hosting) — zero backend dependency
- Municipal dashboard keeps FastAPI as the data layer — Supabase is infrastructure, not a replacement for business logic
- Celery stays because SLA monitoring and escalation have complex time-based logic that doesn't fit serverless patterns

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 06.1-postgres-refactor-to-supabase-and-dashboard-separation*
*Context gathered: 2026-02-10*
