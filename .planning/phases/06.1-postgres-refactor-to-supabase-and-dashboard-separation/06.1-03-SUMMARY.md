---
phase: 06.1-postgres-refactor-to-supabase-and-dashboard-separation
plan: 03
subsystem: storage-and-events
tags: [supabase-storage, realtime, pg-notify, rls, storage-migration]
dependency_graph:
  requires:
    - supabase-sdk-installed
    - supabase-client-module
  provides:
    - supabase-storage-buckets
    - gbv-evidence-rls
    - ticket-update-trigger
    - pg-notify-realtime
  affects:
    - src/services/storage_service.py
    - src/services/event_broadcaster.py
    - src/api/v1/uploads.py
    - src/api/v1/events.py
tech_stack:
  removed:
    - boto3 (AWS S3 SDK)
    - redis.asyncio (for Pub/Sub)
  patterns:
    - Supabase Storage with RLS-based access control
    - PostgreSQL pg_notify for realtime events
    - Database triggers for automatic event broadcasting
    - Bucket-per-purpose pattern (evidence, documents, gbv-evidence)
key_files:
  created:
    - alembic/versions/2026_02_11_0856-8b4d45d48911_add_supabase_storage_buckets_and_rls.py
    - alembic/versions/2026_02_11_0901-c7f87ba5892a_add_ticket_update_trigger_for_realtime.py
  modified:
    - src/services/storage_service.py
    - src/services/event_broadcaster.py
    - src/api/v1/uploads.py
    - src/api/v1/events.py
    - src/schemas/media.py
decisions:
  - what: Supabase Storage buckets with RLS instead of S3 presigned URLs
    why: Consolidates infrastructure on Supabase, integrates with auth JWT claims for tenant isolation
    impact: Frontend must migrate to Supabase JS SDK for uploads (no more presigned POST URLs)
  - what: PostgreSQL pg_notify instead of Redis Pub/Sub for realtime events
    why: Supabase Realtime automatically forwards pg_notify to WebSocket subscribers
    impact: Database triggers handle most events automatically, reduced infrastructure complexity
  - what: GBV evidence bucket with SAPS-only RLS (saps_liaison + admin)
    why: SEC-05 firewall enforcement at storage layer (defense in depth)
    impact: Even if application code fails, RLS prevents unauthorized GBV file access
  - what: SSE endpoint deprecated but kept for backward compatibility
    why: Frontend should migrate to Supabase Realtime WebSocket directly
    impact: SSE endpoint only sends heartbeat, real events via Supabase Realtime
metrics:
  duration_seconds: 588
  duration_minutes: 9.8
  completed_date: 2026-02-11
---

# Phase 06.1 Plan 03: Storage and Events Migration Summary

**One-liner:** Migrated file storage from AWS S3 to Supabase Storage with RLS-enforced GBV isolation, and replaced Redis Pub/Sub with PostgreSQL pg_notify triggers for Supabase Realtime integration.

## Completed Tasks

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Migrate StorageService from AWS S3 to Supabase Storage | db0dd16 | alembic/versions/2026_02_11_0856-8b4d45d48911_add_supabase_storage_buckets_and_rls.py, src/services/storage_service.py, src/api/v1/uploads.py, src/schemas/media.py |
| 2 | Migrate EventBroadcaster from Redis Pub/Sub to Supabase Realtime | 828cfe1 | alembic/versions/2026_02_11_0901-c7f87ba5892a_add_ticket_update_trigger_for_realtime.py, src/services/event_broadcaster.py, src/api/v1/events.py |

## What Was Built

### 1. Supabase Storage Buckets and RLS (Task 1)

Created Alembic migration that sets up three private storage buckets with Row Level Security policies:

**Buckets:**
- `evidence`: General ticket evidence (photos, videos) - tenant-isolated
- `documents`: Proof of residence documents - tenant-isolated
- `gbv-evidence`: GBV ticket evidence - **SAPS-only access** (SEC-05)

**RLS Policies:**

**Evidence bucket:**
- INSERT: Authenticated users can upload to their tenant's folder
- SELECT: Authenticated users can read from their tenant's folder
- Path pattern: `{tenant_id}/{file_id}/{filename}`

**Documents bucket:**
- Same pattern as evidence bucket
- Used for proof of residence and other citizen documents

**GBV evidence bucket (SEC-05 enforcement):**
- INSERT: Only `manager`, `saps_liaison`, `admin` roles can upload
- SELECT: **Only `saps_liaison` and `admin` roles can read** (strict firewall)
- Tenant isolation: Path must match user's `tenant_id` from JWT claims

**Migration graceful degradation:**
- Checks for `storage` schema existence before creating buckets
- Skips in local development environments without Supabase
- Uses `ON CONFLICT DO NOTHING` for idempotent bucket creation

### 2. StorageService Rewrite (Task 1)

Completely replaced boto3-based S3 implementation with Supabase Storage:

**Removed:**
- `boto3` import and S3 client initialization
- AWS credential checks (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
- S3 presigned POST URL generation
- S3-specific error handling (`ClientError`)

**Added:**
- `get_supabase_admin()` import from `src.core.supabase`
- Lazy initialization with graceful degradation (returns `None` if no config)

**Methods updated:**

1. **`generate_upload_url(purpose, tenant_id, file_id, filename, content_type)`**
   - Returns: `{bucket, path, file_id}` (not presigned POST URL)
   - Frontend uses this with Supabase JS SDK: `supabase.storage.from(bucket).upload(path, file)`
   - Determines bucket from purpose: evidence / documents / gbv-evidence

2. **`upload_file(bucket, path, content, content_type)`**
   - Server-side upload using admin client (for WhatsApp media)
   - Uses `supabase_admin.storage.from_(bucket).upload()` with `upsert=false`
   - Bypasses RLS (admin client) for backend-initiated uploads

3. **`get_signed_url(bucket, path, expiry=3600)`**
   - Creates signed URLs for secure file access
   - Uses `supabase_admin.storage.from_(bucket).create_signed_url()`
   - Default 1-hour expiry

4. **`download_and_upload_media(media_url, ..., is_sensitive=False)`**
   - Downloads from Twilio (unchanged)
   - **NEW:** `is_sensitive` parameter determines bucket
   - GBV tickets (`is_sensitive=True`) → `gbv-evidence` bucket
   - Regular tickets → `evidence` bucket
   - Ensures SEC-05 isolation at storage layer

### 3. Upload API Updates (Task 1)

**`src/schemas/media.py`:**
- Changed `PresignedUploadResponse` from `{url, fields, file_id}` to `{bucket, path, file_id}`
- Updated docstring to explain Supabase JS SDK usage

**`src/api/v1/uploads.py`:**
- Updated `/presigned` endpoint to return Supabase upload info (not S3 presigned POST)
- Updated `/confirm` endpoint to use Supabase bucket names
- Reused existing `s3_bucket` and `s3_key` columns for Supabase bucket/path (no schema migration needed)

### 4. PostgreSQL Ticket Update Trigger (Task 2)

Created migration `2026_02_11_0901-c7f87ba5892a_add_ticket_update_trigger_for_realtime.py`:

**Trigger function:** `notify_ticket_update()`
- Executes AFTER INSERT OR UPDATE on `tickets` table
- Builds JSON payload with ticket data:
  - `type`: 'INSERT' or 'UPDATE'
  - `ticket_id`, `tracking_number`, `status`, `category`
  - `municipality_id` (tenant_id), `ward_id`, `is_sensitive`
  - `updated_at` (Unix timestamp)
- Broadcasts via `pg_notify('ticket_updates:{municipality_id}', payload)`

**Why pg_notify:**
- Supabase Realtime automatically listens to `pg_notify` events
- Forwards to WebSocket subscribers on matching channels
- No Redis infrastructure needed
- Database-driven events (automatic, consistent)

### 5. EventBroadcaster Rewrite (Task 2)

Replaced Redis Pub/Sub implementation with PostgreSQL pg_notify:

**Removed:**
- `redis.asyncio` import
- Redis client initialization and connection management
- `subscribe()` method (no longer needed - frontend uses Supabase Realtime directly)

**Updated:**

1. **`publish(municipality_id, event)`**
   - Uses SQLAlchemy to execute `SELECT pg_notify(:channel, :payload)`
   - Channel pattern: `ticket_updates:{municipality_id}`
   - Commits transaction after notify
   - Error handling with rollback

2. **`close()`**
   - Now a no-op (database connections managed by SQLAlchemy pool)

**Why this works:**
- Database triggers handle INSERT/UPDATE events automatically
- Programmatic `publish()` used for events not triggered by DB changes (SLA breaches, manual notifications)
- Supabase Realtime picks up all `pg_notify` events and broadcasts to WebSocket clients

### 6. SSE Endpoint Deprecation (Task 2)

**`src/api/v1/events.py`:**

**Module-level deprecation notice:**
- Added comprehensive migration guide in docstring
- Explains old architecture (Redis Pub/Sub → SSE) vs new (pg_notify → Supabase Realtime)
- Provides JavaScript code example for Supabase Realtime subscription

**Endpoint changes:**
- Added `deprecated=True` parameter to `@router.get("/events")`
- Updated docstring with deprecation warning
- Simplified implementation to only send deprecation notice and heartbeat
- Removed Redis subscription loop
- Keeps connection alive for backward compatibility (30s heartbeats)

**Frontend migration path:**
```javascript
const channel = supabase
  .channel(`ticket_updates:${municipalityId}`)
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'tickets',
    filter: `tenant_id=eq.${municipalityId}`
  }, (payload) => {
    // Handle ticket update
  })
  .subscribe();
```

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

All verification commands passed:

**Task 1:**
1. `from src.services.storage_service import StorageService` → OK
2. `StorageService()` initialization → OK
3. `grep -c "boto3" src/services/storage_service.py` → 0 (removed)
4. `alembic heads` → `8b4d45d48911` (storage bucket migration present)

**Task 2:**
1. `from src.services.event_broadcaster import EventBroadcaster` → OK
2. `grep -c "redis" src/services/event_broadcaster.py` → 0 (removed)
3. `alembic heads` → `c7f87ba5892a` (trigger migration present)
4. `from src.api.v1.events import router` → OK

**Overall success criteria:**
- StorageService uses Supabase Storage (not S3/boto3) ✓
- Three private buckets: evidence, documents, gbv-evidence ✓
- GBV bucket RLS restricts to saps_liaison + admin ✓
- EventBroadcaster uses pg_notify (not Redis) ✓
- Ticket update trigger migration created ✓
- SSE endpoint deprecated ✓
- Each task committed individually ✓

## Impact on System

### Removed Dependencies
- `boto3` - AWS S3 SDK no longer needed
- `redis.asyncio` - Redis Pub/Sub no longer needed for events

### Infrastructure Consolidation
- **Before:** AWS S3 (storage) + Redis (events) + PostgreSQL (data) + Supabase (auth)
- **After:** Supabase Storage + Supabase Realtime + PostgreSQL (data + events) + Supabase Auth
- Cost reduction: No AWS S3 costs, no Redis hosting costs
- Complexity reduction: Single Supabase Cloud platform

### Security Improvements (SEC-05)
- GBV evidence isolated at storage layer via RLS
- Even if application code has bugs, RLS prevents unauthorized access
- JWT claims integration ensures role-based file access
- Defense in depth: Application firewall + Database RLS + Storage RLS

### Performance Improvements
- Database triggers broadcast events automatically (no manual publish calls)
- WebSocket connections more efficient than SSE polling
- Supabase Realtime handles WebSocket scaling natively

### Frontend Migration Required
**Breaking changes:**
1. Upload flow: Must migrate from S3 presigned POST to Supabase Storage upload
2. Realtime events: Must migrate from SSE to Supabase Realtime WebSocket

**Backward compatibility:**
- SSE endpoint remains available (deprecated, heartbeat only)
- Database schema unchanged (`s3_bucket`/`s3_key` columns reused for Supabase)

## Next Steps for Phase 06.1

- **Plan 04**: Enable Row Level Security on application tables (tickets, users, teams)
- **Plan 05**: Migrate Supabase Auth (replace custom JWT with Supabase Auth SDK)
- **Plan 06**: Update frontend to use Supabase Storage and Realtime
- **Plan 07**: Dashboard separation and optimization
- **Plan 08-09**: Premium UI design layer

## Self-Check: PASSED

**Created files exist:**
```
✓ FOUND: alembic/versions/2026_02_11_0856-8b4d45d48911_add_supabase_storage_buckets_and_rls.py
✓ FOUND: alembic/versions/2026_02_11_0901-c7f87ba5892a_add_ticket_update_trigger_for_realtime.py
```

**Modified files exist:**
```
✓ FOUND: src/services/storage_service.py
✓ FOUND: src/services/event_broadcaster.py
✓ FOUND: src/api/v1/uploads.py
✓ FOUND: src/api/v1/events.py
✓ FOUND: src/schemas/media.py
```

**Commits exist:**
```
✓ FOUND: db0dd16 (feat(06.1-03): migrate storage from S3 to Supabase Storage)
✓ FOUND: 828cfe1 (feat(06.1-03): migrate events from Redis Pub/Sub to Supabase Realtime)
```

**Dependencies removed:**
```
✓ VERIFIED: boto3 not in storage_service.py (0 matches)
✓ VERIFIED: redis not in event_broadcaster.py (0 matches)
```

**Buckets and RLS verified:**
```
✓ VERIFIED: gbv-evidence bucket created (5 references in migration)
✓ VERIFIED: saps_liaison + admin RLS policies (lines 87, 93, 103 in migration)
```

All claims verified. Summary accurately reflects completed work.
