---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 04
subsystem: testing
tags: [crewai, auth, unit-tests, mocking, pytest, sanitize-reply, crew-server, pydantic]

# Dependency graph
requires:
  - phase: 10.3-03
    provides: AuthCrew, auth_tool.py (4 tools), AUTH_PROMPTS, AuthResult, crew_server.py health endpoint

provides:
  - tests/agents/test_auth_crew.py — 46 unit tests for AuthCrew structure, prompts, Pydantic, tools
  - tests/agents/test_crew_server.py — 28 unit tests for crew_server health, chat, sanitize_reply, session reset
  - FAKE_LLM pattern for CrewAI Agent() validation in tests (crewai.LLM with fake credentials)
  - ManagerCrew patching pattern: src.agents.crews.manager_crew.ManagerCrew (local import in chat() body)

affects: [10.3-05, 10.3-06, 10.3-07]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - FAKE_LLM = crewai.LLM(model="openai/test-model", api_key="fake") for create_crew() tests — MagicMock fails CrewAI Agent model string validation
    - ManagerCrew patched at src.agents.crews.manager_crew.ManagerCrew not src.api.v1.crew_server.ManagerCrew — it's a local import inside the function body
    - _make_conv_state() + _make_mock_manager() helpers in crew_server tests for shared ConversationManager mock setup
    - sanitize_reply() tested as pure function (direct import, no TestClient needed)

key-files:
  created:
    - tests/agents/test_auth_crew.py
    - tests/agents/test_crew_server.py
  modified: []

key-decisions:
  - "FAKE_LLM pattern: tests that call create_crew() use crewai.LLM(model='openai/test-model', api_key='fake') because MagicMock fails CrewAI's 'Model must be a non-empty string' validation. Tests that only check crew attributes (language, tools, memory_enabled) use plain MagicMock."
  - "ManagerCrew patch target is src.agents.crews.manager_crew.ManagerCrew, not src.api.v1.crew_server.ManagerCrew — it's imported locally inside chat() function body, not at module level"
  - "sanitize_reply clean text must be >= 10 chars to avoid fallback — Action/Observation test strings must include enough citizen-facing text after artifact stripping"

patterns-established:
  - "Two-tier mock LLM: MagicMock for attribute-only tests, FAKE_LLM for create_crew() tests"
  - "Local-import patch pattern: always patch at the SOURCE module, not the calling module, when the import happens inside a function body"
  - "_make_conv_state() + _make_mock_manager() factory helpers enable DRY HTTP test setup with ConversationManager"

requirements-completed: [AI-05, AI-07]

# Metrics
duration: 28.5min (1709s)
completed: 2026-02-25
---

# Phase 10.3 Plan 04: Auth Crew and Crew Server Unit Tests Summary

**74 unit tests across AuthCrew and crew_server.py: structure (FAKE_LLM pattern for create_crew validation), prompts (Gugu identity, CRITICAL IDENTITY first), AuthResult (Final Answer stripping), 11 sanitize_reply cases, and HTTP endpoint shapes**

## Performance

- **Duration:** 28.5 min (1709 seconds)
- **Started:** 2026-02-25T14:37:31Z
- **Completed:** 2026-02-25T15:06:00Z
- **Tasks:** 2
- **Files modified:** 2 (2 created)

## Accomplishments

- Built `tests/agents/test_auth_crew.py` with 46 unit tests covering AuthCrew instantiation (en/zu/af/invalid lang), 4 tools verified, memory_enabled=False, create_crew() with FAKE_LLM pattern, AUTH_PROMPTS content (Gugu, CRITICAL IDENTITY first in all 3 languages, tool usage sections), build_auth_task_description() for new vs returning users, AuthResult.strip_final_answer() field_validator, and all 4 tools as BaseTool instances
- Built `tests/agents/test_crew_server.py` with 28 unit tests covering health endpoint (200, status ok, agents list, auth included, version), chat endpoint shape (422 on missing phone/message, valid ChatResponse shape), routing (session_override=new maps to none, ManagerCrew patch at source module), 11 sanitize_reply cases (Final Answer, Thought, Action, delegation, clean text, GBV emergency numbers added/not duplicated, empty fallback, Observation, I-need-to, Let-me), session reset (200 + success:true), and debug output (GBV metadata-only, non-GBV has diagnostics)
- Established FAKE_LLM pattern for future agent test files — crewai.LLM with fake credentials is required for any test that calls create_crew() because MagicMock fails CrewAI's Agent model string validation

## Task Commits

Each task was committed atomically:

1. **Task 1: Auth agent unit tests** - `2547eed` (feat)
2. **Task 2: Crew server unit tests** - `95cc654` (feat)

## Files Created/Modified

- `tests/agents/test_auth_crew.py` — 46 unit tests across 4 sections: agent structure (14), prompts (11), Pydantic model (8), tools (7 + BaseTool isinstance check)
- `tests/agents/test_crew_server.py` — 28 unit tests across 6 sections: health (5), chat shape (5), routing (2), sanitize_reply (11), session reset (3), debug output (2)

## Decisions Made

- FAKE_LLM pattern: `crewai.LLM(model="openai/test-model", api_key="fake-key-for-tests")` is required for any test calling `create_crew()` — MagicMock fails CrewAI's `Agent()` validation which requires a non-empty model string. Tests that only access crew attributes (language, tools, memory_enabled) can use plain MagicMock.
- ManagerCrew patch target is `src.agents.crews.manager_crew.ManagerCrew` — the `from src.agents.crews.manager_crew import ManagerCrew` statement is inside the `chat()` function body, not at module level. Patching `src.api.v1.crew_server.ManagerCrew` raises AttributeError.
- sanitize_reply test strings must leave >= 10 chars of citizen-facing text after stripping — the function returns a Gugu fallback if the cleaned text is < 10 chars. Action test updated to use a longer clean message after the artifact lines.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Mock LLM pattern for create_crew() tests**
- **Found during:** Task 1 (test_auth_crew_create_crew_returns_crew and related tests)
- **Issue:** Tests using MagicMock() as llm= and then calling create_crew() failed with `pydantic_core ValidationError: Model must be a non-empty string`. CrewAI's Agent() validates that the llm parameter has a non-empty model string — MagicMock() returns a MagicMock for all attribute access, which CrewAI rejects.
- **Fix:** Used `FAKE_LLM = crewai.LLM(model="openai/test-model", api_key="fake-key-for-tests")` for all tests that call `create_crew()`. Tests that only check crew attributes continue to use MagicMock (cheaper).
- **Files modified:** tests/agents/test_auth_crew.py
- **Verification:** create_crew() tests pass with FAKE_LLM; structure tests pass with MagicMock
- **Committed in:** 2547eed (Task 1 commit)

**2. [Rule 1 - Bug] ManagerCrew patch target is source module, not calling module**
- **Found during:** Task 2 (TestChatEndpointShape, TestChatRouting, TestDebugOutput tests)
- **Issue:** Tests patching `src.api.v1.crew_server.ManagerCrew` raised AttributeError — that module does not have a module-level ManagerCrew attribute. It imports ManagerCrew locally inside the `chat()` function body.
- **Fix:** Patched at `src.agents.crews.manager_crew.ManagerCrew` instead. When Python executes the local import, it reads from the sys.modules entry which already has our mock.
- **Files modified:** tests/agents/test_crew_server.py
- **Verification:** All 6 affected tests now pass with correct patch target
- **Committed in:** 95cc654 (Task 2 commit)

**3. [Rule 1 - Bug] sanitize_reply fallback triggered by short clean text in Action test**
- **Found during:** Task 2 (test_sanitize_strips_action)
- **Issue:** Test used `"Hello!"` (6 chars) as citizen-facing text after stripping Action/Action Input lines. sanitize_reply() returns a Gugu fallback when cleaned text < 10 chars, so "Hello!" triggered the fallback.
- **Fix:** Updated test to use longer citizen-facing text: `"Hello! I am Gugu from SALGA Trust Engine, I'm here to help you."` — > 10 chars after stripping.
- **Files modified:** tests/agents/test_crew_server.py
- **Verification:** Test now passes, asserts "Gugu" in result
- **Committed in:** 95cc654 (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (3 Rule 1 bugs — all testing pattern bugs, not production code bugs)
**Impact on plan:** All auto-fixes were corrections to test implementation patterns, not changes to the code under test. No scope creep.

## Issues Encountered

None beyond the auto-fixed deviations above.

## Next Phase Readiness

- AuthCrew unit test suite is complete (46 tests) — all agent structure, prompt, Pydantic, and tool tests passing
- crew_server unit test suite is complete (28 tests) — health, chat, sanitize_reply, session reset all covered
- FAKE_LLM pattern established for Plans 05-07 (municipal, gbv, ticket_status crews)
- ManagerCrew local import patch pattern documented for any future crew_server tests
- Plan 05 (Municipal Intake Agent rebuild) can proceed with established testing patterns

## Self-Check: PASSED

- FOUND: tests/agents/test_auth_crew.py
- FOUND: tests/agents/test_crew_server.py
- FOUND commit: 2547eed (Task 1 — auth crew tests)
- FOUND commit: 95cc654 (Task 2 — crew server tests)
- FOUND: 46 tests in test_auth_crew.py (verified by pytest)
- FOUND: 28 tests in test_crew_server.py (verified by pytest)
- FOUND: 74 total tests passing in 54.47s

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-25*
