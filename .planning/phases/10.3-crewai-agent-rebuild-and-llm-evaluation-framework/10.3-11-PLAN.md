---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/v1/reports.py
  - tests/test_reports_api.py
autonomous: true
gap_closure: true
requirements: [AI-01, AI-02, AI-03, AI-04, AI-05, AI-06, AI-07]

must_haves:
  truths:
    - "Web portal report submissions without explicit category receive AI-classified category (not always 'other')"
    - "reports.py no longer imports ManagerCrew stub"
    - "GBV reports submitted via web portal without explicit is_gbv flag but with GBV description are classified as 'gbv' by AI"
    - "Web portal reports with explicit category still skip AI classification (no regression)"
    - "All existing test_reports_api.py tests pass with updated mocks"
  artifacts:
    - path: "src/api/v1/reports.py"
      provides: "Web portal report submission with IntakeFlow-based AI classification"
      contains: "IntakeFlow"
    - path: "tests/test_reports_api.py"
      provides: "Unit tests covering AI classification via IntakeFlow"
      contains: "IntakeFlow"
  key_links:
    - from: "src/api/v1/reports.py"
      to: "src/agents/flows/intake_flow.py"
      via: "IntakeFlow for single-shot intent classification"
      pattern: "from src\\.agents\\.flows\\.intake_flow import IntakeFlow"
    - from: "src/api/v1/reports.py"
      to: "src/agents/flows/state.py"
      via: "IntakeState for passing message to flow"
      pattern: "IntakeState"
---

<objective>
Fix web portal AI auto-classification: replace non-functional ManagerCrew stub with IntakeFlow single-shot classification in reports.py.

Purpose: Close VERIFICATION Gap 1 (BLOCKER). Web portal report submissions without an explicit category currently default to "other" because reports.py imports the non-functional ManagerCrew stub. The WhatsApp path (messages.py, crew_server.py) correctly uses IntakeFlow. This plan aligns the web portal path with the same rebuilt routing.

Output: reports.py uses IntakeFlow for AI classification, ManagerCrew stub import removed, tests updated.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-VERIFICATION.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly -- no codebase exploration needed. -->

From src/agents/flows/intake_flow.py:
```python
class IntakeFlow(Flow[IntakeState]):
    """Deterministic intake router -- classifies intent, dispatches to specialist."""

    @start()
    def classify_intent(self) -> str:
        """Detect language and classify routing intent.
        Returns: Intent string: "auth" | "municipal" | "ticket_status" | "gbv"
        """
        ...

    def _classify_raw_intent(self) -> str:
        """Direct LLM call for intent classification. NOT a full Crew.
        Uses get_routing_llm() (gpt-4o-mini) for reliable single-shot classification.
        Returns: Intent string: "auth" | "municipal" | "ticket_status" | "gbv"
        """
        ...
```

From src/agents/flows/state.py:
```python
class IntakeState(BaseModel):
    message: str = ""
    phone: str = ""
    language: str = "en"
    intent: str = "unknown"
    routing_phase: str = "manager"
    session_status: str = "none"
    user_id: str | None = None
    conversation_history: str = "(none)"
    result: dict = {}
    pending_intent: str = ""
```

From src/agents/crews/manager_crew.py (STUB -- to be removed):
```python
class ManagerCrew:
    """Placeholder ManagerCrew -- non-functional stub."""
    async def kickoff(self, context: dict) -> dict:
        return {"message": "...", "action_taken": "error", "error": "..."}
```

From src/schemas/report.py:
```python
class ReportSubmitRequest(BaseModel):
    description: str
    category: str | None = None  # If None, AI classifies
    location: LocationData | None = None
    manual_address: str | None = None
    media_file_ids: list[str] = []
    language: str = "en"
    is_gbv: bool = False

class ReportSubmitResponse(BaseModel):
    ticket_id: str
    tracking_number: str
    category: str
    status: str
    message: str
    media_count: int
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ManagerCrew with IntakeFlow classification in reports.py</name>
  <files>src/api/v1/reports.py</files>
  <action>
Replace the ManagerCrew import and usage in `src/api/v1/reports.py` with a lightweight IntakeFlow-based classifier. The goal is single-shot intent classification (NOT a full multi-turn conversation).

**Step 1: Remove the ManagerCrew import (line 18):**
Delete:
```python
from src.agents.crews.manager_crew import ManagerCrew
```

**Step 2: Add IntakeFlow and IntakeState imports:**
```python
from src.agents.flows.intake_flow import IntakeFlow
from src.agents.flows.state import IntakeState
```

**Step 3: Replace the AI classification block (lines 86-115).**

The current code (inside `if category is None:`) instantiates ManagerCrew and calls kickoff(). Replace this entire block with:

```python
if category is None:
    # Use IntakeFlow for single-shot AI intent classification.
    # IntakeFlow uses gpt-4o-mini via _classify_raw_intent() for reliable
    # classification. We only need the intent -- not a full crew conversation.
    try:
        flow = IntakeFlow()
        flow.state = IntakeState(
            message=sanitized_description,
            language=report.language or "en",
            session_status="active",  # Web portal users are authenticated
            user_id=str(current_user.id),
            routing_phase="manager",  # Trigger fresh classification
        )
        # Call _classify_raw_intent directly for lightweight single-shot classification.
        # This makes one gpt-4o-mini LLM call -- no full crew invocation.
        intent = flow._classify_raw_intent()

        # Map intent to ticket category
        _INTENT_TO_CATEGORY = {
            "municipal": "other",  # Municipal services -- specific sub-category determined by description
            "gbv": "gbv",
            "auth": "other",
            "ticket_status": "other",
        }
        category = _INTENT_TO_CATEGORY.get(intent, "other")

    except Exception as e:
        logger.error(f"AI classification failed: {e}", exc_info=True)
        category = "other"
```

**Key design decisions:**
- Uses `flow._classify_raw_intent()` directly instead of `flow.kickoff()` because we only need classification, not a full specialist dispatch. This avoids spawning auth/municipal/gbv crews.
- Sets `session_status="active"` because web portal users are already authenticated (the endpoint requires `get_current_user`). This prevents the auth gate from triggering in `classify_intent()`.
- Sets `routing_phase="manager"` to ensure fresh classification (not short-circuiting to an existing specialist session).
- The `_INTENT_TO_CATEGORY` mapping keeps the same semantics as the old `_PHASE_TO_CATEGORY` dict. Rename for clarity since the IntakeFlow calls them "intents", not "phases".
- Error handling preserved: if the LLM call fails, category defaults to "other" (same as before).
- The `_is_saps_context()` SEC-05 heuristic in `_classify_raw_intent()` is automatically included -- adversarial SAPS-phrased GBV messages will be classified as "gbv".

**Step 4: Update the module docstring (line 1-6):**
Change "Uses ManagerCrew.kickoff() for AI classification" to "Uses IntakeFlow for AI intent classification when category not specified."

**Step 5: Verify no other ManagerCrew references remain in the file.**
The only ManagerCrew reference should be removed by Step 1. Confirm with a search.

**What NOT to change:**
- The `if report.is_gbv: category = "gbv"` override (line 127) -- keep this as-is.
- The GBV encryption logic (lines 146-152) -- keep as-is.
- The SAPS notification logic (lines 207-221) -- keep as-is.
- The media linking logic -- keep as-is.
- The GET endpoints (`/my` and `/{tracking_number}`) -- no changes needed.
  </action>
  <verify>
    <automated>python -c "from src.api.v1.reports import router; print('reports.py imports OK')" && python -c "import ast; tree = ast.parse(open('src/api/v1/reports.py').read()); imports = [n for n in ast.walk(tree) if isinstance(n, ast.ImportFrom) and n.module and 'manager_crew' in n.module]; assert len(imports) == 0, f'ManagerCrew still imported: {imports}'; print('No ManagerCrew import found -- PASS')"</automated>
  </verify>
  <done>
    - reports.py imports IntakeFlow and IntakeState instead of ManagerCrew
    - AI classification uses flow._classify_raw_intent() for single-shot gpt-4o-mini classification
    - SEC-05 _is_saps_context heuristic is automatically included via IntakeFlow
    - Error fallback still defaults to "other" on LLM failure
    - No ManagerCrew reference remains in reports.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test mocks from ManagerCrew to IntakeFlow and add classification tests</name>
  <files>tests/test_reports_api.py</files>
  <action>
Update the existing test mocks in `tests/test_reports_api.py` to reflect the switch from ManagerCrew to IntakeFlow, and add new test cases that verify AI classification works correctly.

**Step 1: Update `test_submit_report_with_category` (line 112-143):**
The test currently patches `src.api.v1.reports.ManagerCrew` and asserts `mock_crew_class.assert_not_called()`. Change the patch target to IntakeFlow:

```python
async def test_submit_report_with_category(self, client, citizen_token):
    """Test pre-selected category skips AI classification."""
    request_data = {
        "description": "Garbage not collected",
        "category": "waste",
        "manual_address": "123 Main St",
        "language": "en"
    }

    with patch('src.api.v1.reports.guardrails_engine') as mock_guardrails, \
         patch('src.api.v1.reports.IntakeFlow') as mock_flow_class:

        mock_guardrails.process_input = AsyncMock(return_value=MagicMock(
            is_safe=True,
            sanitized_message="Garbage not collected"
        ))

        response = await client.post(
            "/api/v1/reports/submit",
            json=request_data,
            headers={"Authorization": f"Bearer {citizen_token}"}
        )

    assert response.status_code == 200
    data = response.json()
    assert data["category"] == "waste"

    # Verify IntakeFlow was NOT instantiated (category provided)
    mock_flow_class.assert_not_called()
```

**Step 2: Update `test_submit_report_without_category` (line 145-179):**
Replace ManagerCrew mock with IntakeFlow mock. The test now mocks `_classify_raw_intent` to return a known intent:

```python
async def test_submit_report_without_category(self, client, citizen_token):
    """Test AI classification via IntakeFlow when category is None."""
    request_data = {
        "description": "The water is not working in my house",
        "category": None,
        "manual_address": "123 Main St",
        "language": "en"
    }

    with patch('src.api.v1.reports.guardrails_engine') as mock_guardrails, \
         patch('src.api.v1.reports.IntakeFlow') as mock_flow_class:

        mock_guardrails.process_input = AsyncMock(return_value=MagicMock(
            is_safe=True,
            sanitized_message="The water is not working in my house"
        ))

        # Mock IntakeFlow instance and _classify_raw_intent
        mock_flow = MagicMock()
        mock_flow._classify_raw_intent = MagicMock(return_value="municipal")
        mock_flow_class.return_value = mock_flow

        response = await client.post(
            "/api/v1/reports/submit",
            json=request_data,
            headers={"Authorization": f"Bearer {citizen_token}"}
        )

    assert response.status_code == 200
    data = response.json()
    # "municipal" intent maps to "other" category
    assert data["category"] == "other"
```

**Step 3: Add new test `test_submit_report_ai_classifies_gbv`:**
Tests that AI classification returns "gbv" for GBV-related descriptions without the explicit is_gbv flag:

```python
async def test_submit_report_ai_classifies_gbv(self, client, citizen_token):
    """Test AI classification detects GBV from description content."""
    request_data = {
        "description": "My husband is beating me and I need help urgently",
        "category": None,  # No explicit category -- AI must detect GBV
        "manual_address": "Location withheld",
        "language": "en"
    }

    with patch('src.api.v1.reports.guardrails_engine') as mock_guardrails, \
         patch('src.api.v1.reports.IntakeFlow') as mock_flow_class, \
         patch('src.agents.tools.saps_tool.notify_saps') as mock_saps:

        mock_guardrails.process_input = AsyncMock(return_value=MagicMock(
            is_safe=True,
            sanitized_message="My husband is beating me and I need help urgently"
        ))

        mock_flow = MagicMock()
        mock_flow._classify_raw_intent = MagicMock(return_value="gbv")
        mock_flow_class.return_value = mock_flow

        response = await client.post(
            "/api/v1/reports/submit",
            json=request_data,
            headers={"Authorization": f"Bearer {citizen_token}"}
        )

    assert response.status_code == 200
    data = response.json()
    assert data["category"] == "gbv"
```

**Step 4: Add new test `test_submit_report_ai_classification_fallback`:**
Tests that AI classification failures gracefully default to "other":

```python
async def test_submit_report_ai_classification_fallback(self, client, citizen_token):
    """Test AI classification failure defaults to 'other' category."""
    request_data = {
        "description": "Something is wrong in my neighborhood",
        "category": None,
        "manual_address": "456 Oak Avenue",
        "language": "en"
    }

    with patch('src.api.v1.reports.guardrails_engine') as mock_guardrails, \
         patch('src.api.v1.reports.IntakeFlow') as mock_flow_class:

        mock_guardrails.process_input = AsyncMock(return_value=MagicMock(
            is_safe=True,
            sanitized_message="Something is wrong in my neighborhood"
        ))

        # Simulate IntakeFlow raising an exception
        mock_flow = MagicMock()
        mock_flow._classify_raw_intent = MagicMock(side_effect=Exception("LLM API timeout"))
        mock_flow_class.return_value = mock_flow

        response = await client.post(
            "/api/v1/reports/submit",
            json=request_data,
            headers={"Authorization": f"Bearer {citizen_token}"}
        )

    assert response.status_code == 200
    data = response.json()
    assert data["category"] == "other"
```

**What NOT to change:**
- test_submit_report_with_gps -- no ManagerCrew reference, no changes needed.
- test_submit_report_with_address -- no ManagerCrew reference, no changes needed.
- test_submit_report_no_location -- no ManagerCrew reference, no changes needed.
- test_submit_report_with_media -- no ManagerCrew reference, no changes needed.
- test_submit_report_gbv_encrypted -- no ManagerCrew reference, no changes needed.
- test_submit_report_returns_tracking -- no ManagerCrew reference, no changes needed.
- test_get_report_by_tracking -- no changes needed.
- test_get_report_wrong_user -- no changes needed.
- test_my_reports_paginated -- no changes needed.
- test_my_reports_gbv_redacted -- no changes needed.
  </action>
  <verify>
    <automated>python -c "import ast; tree = ast.parse(open('tests/test_reports_api.py').read()); imports_and_strings = ast.dump(tree); assert 'ManagerCrew' not in imports_and_strings or 'manager_crew' not in imports_and_strings, 'ManagerCrew still referenced in tests'; print('No ManagerCrew references in tests -- PASS')" && python -c "import ast; tree = ast.parse(open('tests/test_reports_api.py').read()); names = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]; assert 'test_submit_report_ai_classifies_gbv' in names, 'Missing GBV classification test'; assert 'test_submit_report_ai_classification_fallback' in names, 'Missing fallback test'; print('New test functions present -- PASS')"</automated>
  </verify>
  <done>
    - test_submit_report_with_category mocks IntakeFlow (not ManagerCrew) and asserts it was not called
    - test_submit_report_without_category mocks IntakeFlow._classify_raw_intent returning "municipal"
    - New test_submit_report_ai_classifies_gbv verifies GBV detection via AI
    - New test_submit_report_ai_classification_fallback verifies graceful "other" fallback on LLM error
    - No ManagerCrew references remain in tests
    - All existing tests unmodified (no regressions)
  </done>
</task>

</tasks>

<verification>
1. **No ManagerCrew import in production code:**
   ```bash
   grep -rn "from src.agents.crews.manager_crew import" src/api/ src/services/ src/middleware/
   ```
   Expected: zero matches (only `src/agents_old/` should reference it, which is archived)

2. **IntakeFlow correctly wired in reports.py:**
   ```bash
   grep -n "IntakeFlow\|_classify_raw_intent\|IntakeState" src/api/v1/reports.py
   ```
   Expected: IntakeFlow import, IntakeState import, flow._classify_raw_intent() call

3. **All existing tests still pass:**
   ```bash
   pytest tests/test_reports_api.py -x --no-header -q
   ```
   Expected: all tests pass (including 2 new ones)

4. **No regressions in agent tests:**
   ```bash
   pytest tests/agents/ -x --no-header -q
   ```
   Expected: 277 tests pass

5. **reports.py module importable:**
   ```bash
   python -c "from src.api.v1.reports import router; print('OK')"
   ```
   Expected: "OK"
</verification>

<success_criteria>
- reports.py uses IntakeFlow._classify_raw_intent() for AI category classification (not ManagerCrew stub)
- Web portal submissions without explicit category get AI-classified intent (municipal, gbv, etc.) instead of always defaulting to "other"
- SEC-05 _is_saps_context heuristic is automatically included (inherited from IntakeFlow)
- GBV reports detected by AI trigger SAPS notification and encryption (existing logic preserved)
- All test_reports_api.py tests pass with updated IntakeFlow mocks + 2 new tests
- No ManagerCrew references remain in src/api/v1/reports.py or tests/test_reports_api.py
- Zero regressions in existing agent test suite (277 tests)
</success_criteria>

<output>
After completion, create `.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-11-SUMMARY.md`
</output>
