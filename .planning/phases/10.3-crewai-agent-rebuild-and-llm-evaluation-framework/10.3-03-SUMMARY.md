---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 03
subsystem: agents
tags: [crewai, auth, gpt-4o-mini, otp, supabase, tools, pydantic, crew-server]

# Dependency graph
requires:
  - phase: 10.3-01
    provides: BaseCrew, IntakeState, LLM factories, test fixtures

provides:
  - AuthCrew with 4 tools (lookup_user, send_otp, verify_otp, create_supabase_user)
  - AUTH_PROMPTS trilingual Gugu persona (EN/ZU/AF) in src/agents/prompts/auth.py
  - AuthResult Pydantic model with Final Answer field_validator
  - build_auth_task_description() helper for per-request, per-user-state task descriptions
  - crew_server.py health endpoint returning {"status": "ok", "agents": ["auth"]}
  - ChatResponse.language field for downstream language tracking
  - Full HTTP -> crew_server -> AuthCrew path structurally wired

affects: [10.3-04, 10.3-07]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - AUTH_PROMPTS dict pattern — trilingual Gugu persona in Python (not YAML) for string management
    - AuthResult.field_validator strips Final Answer prefix (CrewAI artifact cleanup)
    - BaseCrew.create_crew() override for custom backstory injection from AUTH_PROMPTS
    - _log_tool_failure() 5-min sliding window POPIA-safe logging (8-char truncated user IDs)
    - Health endpoint agents[] list grows as agents are rebuilt in Plans 04-07

key-files:
  created:
    - src/agents/tools/auth_tool.py
    - src/agents/prompts/auth.py
    - src/agents/crews/auth_crew.py
  modified:
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml
    - src/api/v1/crew_server.py

key-decisions:
  - "AUTH_PROMPTS dict in auth.py holds full trilingual Gugu persona backstory (not agents.yaml) — 200+ lines of rich prompts benefit from Python string management over YAML embedding"
  - "AuthCrew.create_crew() overrides BaseCrew to inject AUTH_PROMPTS[language] as backstory — role/goal still from agents.yaml; only backstory from Python dict"
  - "AuthResult has message/requires_otp/session_status/language fields — simpler than agents_old model (removed authenticated, user_id, municipality_id, error); matches crew_server usage pattern"
  - "HealthResponse.agents field added; crew_server health returns agents=['auth'] — list grows in Plans 04-07"
  - "ChatResponse.language field added — downstream consumers (Streamlit) can display language without parsing debug dict"

patterns-established:
  - "4-tool auth pattern: lookup_user -> send_otp -> verify_otp -> create_supabase_user (sequential, stateless)"
  - "_log_tool_failure() with 5-min sliding window; CRITICAL log at 3+ failures; 8-char POPIA truncation"
  - "BaseTool subclass per tool (not @tool decorator) — enables isolated testing via .name and .run attributes"
  - "get_routing_llm() (gpt-4o-mini) for multi-tool-call agents per locked decision"

requirements-completed: [AI-01, AI-05, AI-06]

# Metrics
duration: 22.3min (1339s)
completed: 2026-02-25
---

# Phase 10.3 Plan 03: Auth Agent Rebuild Summary

**AuthCrew rebuilt with 4 Supabase/Twilio auth tools, full trilingual Gugu persona in AUTH_PROMPTS, AuthResult Pydantic output, and crew_server.py updated to serve /health with agents=["auth"]**

## Performance

- **Duration:** 22.3 min (1339 seconds)
- **Started:** 2026-02-25T14:08:21Z
- **Completed:** 2026-02-25T14:30:40Z
- **Tasks:** 2
- **Files modified:** 6 (3 created, 3 modified)

## Accomplishments

- Built `src/agents/tools/auth_tool.py` with 4 tools (lookup_user_tool, send_otp_tool, verify_otp_tool, create_supabase_user_tool) using BaseTool class pattern with POPIA-safe failure logging
- Built `src/agents/prompts/auth.py` with full trilingual AUTH_PROMPTS Gugu persona, AuthResult Pydantic model (field_validator strips Final Answer prefix), and build_auth_task_description() helper
- Built `src/agents/crews/auth_crew.py` extending BaseCrew, using get_routing_llm() (gpt-4o-mini), memory=False, max_iter=15, output_pydantic=AuthResult
- Updated `agents.yaml` and `tasks.yaml` with auth_agent/auth_task entries (YAML holds role/goal; backstory injected from AUTH_PROMPTS at runtime)
- Updated `crew_server.py`: HealthResponse adds agents list, health endpoint returns `{"status": "ok", "agents": ["auth"]}`, ChatResponse adds language field

## Task Commits

Each task was committed atomically:

1. **Task 1: Rebuild Auth Agent tools, prompts, crew, YAML** - `e1c8b68` (feat)
2. **Task 2: Update crew_server.py for Auth agent rebuild** - `4ba5eb1` (feat)

## Files Created/Modified

- `src/agents/tools/auth_tool.py` - 4 auth tools: lookup_user_tool, send_otp_tool, verify_otp_tool, create_supabase_user_tool; _log_tool_failure() sliding window; Twilio SMS + Supabase email OTP paths
- `src/agents/prompts/auth.py` - AUTH_PROMPTS dict with Gugu persona EN/ZU/AF; AuthResult Pydantic model; build_auth_task_description() returning new vs returning user instructions
- `src/agents/crews/auth_crew.py` - AuthCrew extends BaseCrew; get_routing_llm() for gpt-4o-mini; create_crew() injects AUTH_PROMPTS[language] backstory; parse_result() with Pydantic + repair fallback
- `src/agents/config/agents.yaml` - auth_agent entry (role, goal, allow_delegation, max_iter, verbose)
- `src/agents/config/tasks.yaml` - auth_task entry (description placeholder note, expected_output)
- `src/api/v1/crew_server.py` - HealthResponse.agents field; health endpoint returns agents=["auth"]; ChatResponse.language field; both ChatResponse return paths include language

## Decisions Made

- AUTH_PROMPTS holds backstory in Python dict rather than agents.yaml — rich multilingual prompts (200+ lines each) are easier to maintain with Python string concatenation and named constants for guardrail blocks
- AuthResult simplified vs agents_old model: `message, requires_otp, session_status, language` — the crew_server only uses message and session_status; removing `authenticated, user_id, municipality_id, error` reduces Pydantic validation surface area
- YAML auth_agent entry kept for role/goal — BaseCrew loads these; only backstory overridden from AUTH_PROMPTS. This keeps the YAML as the authoritative source for static metadata (role, max_iter, verbose)
- HealthResponse backward-compatible: added `agents` list as primary field; kept `deepseek_configured` and `version` as optional fields with defaults so existing Streamlit dashboard code continues to work

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] AuthResult model fields differ from plan spec**
- **Found during:** Task 1 implementation
- **Issue:** Plan spec showed `AuthResult` with `requires_otp: bool` and `session_status: str = "none"` but also mentioned keeping the "old" `authenticated`, `user_id`, `municipality_id`, `error` fields. These conflicting specs were reconciled by examining what crew_server.py actually reads from the result dict.
- **Fix:** Used the simpler model (`message, requires_otp, session_status, language`) matching the Plan's code block spec. The crew_server reads `message` and `session_status` from agent_result; extra fields are ignored.
- **Files modified:** src/agents/prompts/auth.py
- **Verification:** AuthResult validates with all 4 fields, field_validator strips Final Answer prefix
- **Committed in:** e1c8b68 (Task 1 commit)

**2. [Rule 2 - Missing Critical] HealthResponse backward compatibility**
- **Found during:** Task 2 implementation
- **Issue:** Plan spec wanted `HealthResponse` with only `status` and `agents`. Existing Streamlit dashboard code may read `deepseek_configured` and `version`. Removing them would break Streamlit.
- **Fix:** Added `agents: list[str]` as required field (per plan) and made `deepseek_configured` and `version` optional with defaults. Both old and new callers work.
- **Files modified:** src/api/v1/crew_server.py
- **Verification:** Health endpoint returns 200 with `{"status": "ok", "agents": ["auth"], "deepseek_configured": true, "version": "1.0.0"}`
- **Committed in:** 4ba5eb1 (Task 2 commit)

## Issues Encountered

- `tests/test_gbv_crew.py` imports `src.agents.crews.gbv_crew` which does not exist yet (GBVCrew rebuilt in a future plan). This is a pre-existing out-of-scope test error. Logged to deferred-items for awareness — not caused by this plan's changes.

## Next Phase Readiness

- AuthCrew is complete and all imports verified against BaseCrew, AUTH_PROMPTS, AuthResult, and 4 tools
- crew_server.py specialist map already references `src.agents.crews.auth_crew.AuthCrew` — routing short-circuit will work once sessions are established
- Plan 04 (Auth agent unit tests) can now write tests against AuthCrew, auth_tool.py, and auth prompts
- AUTH_PROMPTS pattern established for Plans 04-06 (municipal, gbv, ticket_status prompts)

## Self-Check: PASSED

- FOUND: src/agents/tools/auth_tool.py
- FOUND: src/agents/prompts/auth.py
- FOUND: src/agents/crews/auth_crew.py
- FOUND: .planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-03-SUMMARY.md
- FOUND commit: e1c8b68 (Task 1)
- FOUND commit: 4ba5eb1 (Task 2)

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-25*
