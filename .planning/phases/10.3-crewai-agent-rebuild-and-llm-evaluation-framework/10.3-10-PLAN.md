---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/flows/intake_flow.py
  - tests/agents/test_intake_flow_gbv_routing.py
autonomous: true
gap_closure: true
requirements: [AI-03, AI-04]

must_haves:
  truths:
    - "SAPS-officer + personal-case phrasing routes to GBV, not ticket_status"
    - "Standard ticket_status messages (no SAPS-case context) continue routing correctly"
  artifacts:
    - path: "src/agents/flows/intake_flow.py"
      provides: "SAPS-context pre-classification heuristic"
      contains: "_is_saps_context"
    - path: "tests/agents/test_intake_flow_gbv_routing.py"
      provides: "Regression tests for SAPS-context routing"
  key_links:
    - from: "src/agents/flows/intake_flow.py"
      to: "_is_saps_context()"
      via: "called at top of _classify_raw_intent before LLM"
      pattern: "_is_saps_context"
---

<objective>
Close UAT gap GBV-4: adversarial message "I want to know about the SAPS officers assigned to my case" was misrouted to ticket_status instead of GBV, bypassing the safety net and omitting emergency numbers.

Purpose: Citizens describing a GBV case in police/SAPS terminology must reach the GBV agent. The LLM prompt GBV keywords (abuse, violence, assault) do not match this phrasing. A deterministic pre-classification heuristic must intercept before the LLM runs — SEC-05 safety gap.

Output: _is_saps_context() helper in intake_flow.py short-circuits LLM classification when SAPS-officer language combines with personal-case language. Unit tests confirm fix and guard standard ticket_status routing.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/agents/flows/intake_flow.py

<interfaces>
From src/agents/flows/intake_flow.py — do not alter signatures:

  class IntakeFlow(Flow[IntakeState]):
      def _classify_raw_intent(self) -> str  # INSERT heuristic at top of this method body
      @listen("gbv") async def handle_gbv
      @listen("ticket_status") async def handle_ticket_status

Fix goes inside _classify_raw_intent() before the LLM import. Applies to both
unauthenticated (Step 3 raw_intent) and authenticated (Step 4) paths.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add _is_saps_context heuristic to intake_flow.py</name>
  <files>src/agents/flows/intake_flow.py</files>
  <action>
Add private helper _is_saps_context(self, message: str) -> bool to IntakeFlow.
Call it at the very top of _classify_raw_intent() before the LLM import/call.
If it returns True, return "gbv" immediately — no LLM call made.

The helper returns True when the message contains BOTH:
1. A SAPS/officer term (any of): "saps officer", "police officer", "investigating officer",
   "detective", "constable", "sergeant", "lieutenant", "captain"
2. A personal-case term (any of): "my case", "assigned to", "my report", "my complaint",
   "my matter", "handling my", "working on my", "officer on my"

Both conditions required (case-insensitive AND). Prevents false positives — generic
"report this to SAPS" has no personal-case term, so returns False.

Insert at the TOP of _classify_raw_intent() body (before the LLM import line):

    # SEC-05: Intercept adversarial GBV phrasing before LLM classification.
    # Citizens describing a GBV case using police/SAPS language lack the abuse keywords
    # the LLM checks for, causing misrouting to ticket_status.
    if self._is_saps_context(self.state.message):
        return "gbv"

Add this helper anywhere in the class after _classify_raw_intent:

    def _is_saps_context(self, message: str) -> bool:
        """Return True if message refs SAPS/police officers in citizen's own case.

        Requires BOTH a SAPS/officer term AND a personal-case ownership term.
        Generic SAPS mentions without case context return False.

        SEC-05: Ensures GBV safety net not bypassed by adversarial phrasing.
        """
        msg_lower = message.lower()
        saps_terms = [
            "saps officer", "police officer", "investigating officer",
            "detective", "constable", "sergeant", "lieutenant", "captain",
        ]
        case_terms = [
            "my case", "assigned to", "my report", "my complaint",
            "my matter", "handling my", "working on my", "officer on my",
        ]
        has_saps = any(term in msg_lower for term in saps_terms)
        has_case = any(term in msg_lower for term in case_terms)
        return has_saps and has_case

Do not modify any other method. Do not alter the LLM prompt text or 4-category list.
  </action>
  <verify>python -c "import sys; sys.path.insert(0,'.'); from src.agents.flows.intake_flow import IntakeFlow; from src.agents.flows.state import IntakeState; f=IntakeFlow(); f.state=IntakeState(); assert f._is_saps_context('SAPS officers assigned to my case') is True; assert f._is_saps_context('report to SAPS') is False; assert f._is_saps_context('status of TKT-123') is False; assert f._is_saps_context('detective assigned to my report') is True; print('PASS')"
  </verify>
  <done>_is_saps_context() exists on IntakeFlow. Returns True for SAPS+case messages, False for generic SAPS and ticket_status queries. _classify_raw_intent() short-circuits to gbv before any LLM call when heuristic fires.</done>
</task>

<task type="auto">
  <name>Task 2: Write regression tests for SAPS-context routing</name>
  <files>tests/agents/test_intake_flow_gbv_routing.py</files>
  <action>
Create tests/agents/test_intake_flow_gbv_routing.py with pytest unit tests.
Import IntakeFlow and IntakeState from src.agents.flows. Mock get_routing_llm.

test_saps_context_routes_to_gbv:
  Assert _is_saps_context() is True for: "SAPS officers assigned to my case",
  "detective assigned to my report", "investigating officer handling my matter".
  Patch src.agents.flows.intake_flow.get_routing_llm and confirm it is NOT called.
  Assert _classify_raw_intent() returns "gbv" for each message.

test_standard_ticket_status_unaffected:
  Assert _is_saps_context() is False for: "status of TKT-20240315-A1B2",
  "where is my complaint TKT-123".
  Mock get_routing_llm().call to return "ticket_status".
  Assert _classify_raw_intent() returns "ticket_status".

test_generic_saps_mention_not_gbv:
  Assert _is_saps_context() is False for: "report pothole to SAPS",
  "sergeant at local station", "police are already aware".

Each test creates a fresh IntakeFlow() and sets f.state = IntakeState() then f.state.message.
Use pytest functions (not unittest classes).
  </action>
  <verify>pytest tests/agents/test_intake_flow_gbv_routing.py -v 2>&1 | tail -15</verify>
  <done>All 3 test functions collected and pass. pytest exits 0.</done>
</task>

</tasks>

<verification>
1. grep -n _is_saps_context src/agents/flows/intake_flow.py -- must appear at least 3 times (definition body, SEC-05 call site, method name)
2. grep -n SEC-05 src/agents/flows/intake_flow.py -- present in heuristic comment block
3. pytest tests/agents/test_intake_flow_gbv_routing.py -v -- all 3 tests pass
4. pytest tests/agents/ -k "not integration" 2>&1 | tail -5 -- no regressions
</verification>

<success_criteria>
_is_saps_context() returns True for SAPS officers + personal-case messages.
_is_saps_context() returns False for generic SAPS mentions and ticket_status queries.
_classify_raw_intent() returns gbv without calling LLM when heuristic fires.
All 3 new tests pass, no existing agent tests regressed.
SEC-05 comment present in the heuristic block in intake_flow.py.
</success_criteria>

<output>
After completion, create .planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-10-SUMMARY.md
</output>
