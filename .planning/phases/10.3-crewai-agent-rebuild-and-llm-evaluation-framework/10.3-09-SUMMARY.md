---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: "09"
subsystem: eval-framework
tags: [playwright, claude-judge, eval, streamlit, automation, deepseek, ticket-status, afrikaans]
dependency_graph:
  requires:
    - 10.3-08  # Integration tests + LLM fix (agents must work before Playwright eval)
  provides:
    - playwright_judge_engine    # PlaywrightJudge class for Streamlit-driven evals
    - playwright_eval_cli        # run_playwright_eval.py CLI runner
    - eval_report_json           # tests/evals/reports/playwright_retest_20260226_082018.json
    - afrikaans_leak_fix         # Two-layer fix: ticket_lookup_tool.py + ticket_status.py prompts
  affects:
    - tests/evals/               # New eval engine and CLI runner
    - src/agents/tools/ticket_lookup_tool.py
    - src/agents/prompts/ticket_status.py
tech_stack:
  added: []
  patterns:
    - "Playwright MCP + Claude-as-judge eval loop"
    - "Callback injection pattern (send/read/reset fns provided by Claude Code)"
    - "metadata_only flag for SEC-05/POPIA GBV report stripping"
    - "Two-layer error suppression: sanitize at tool layer + explicit prompt rules"
key_files:
  created:
    - tests/evals/playwright_judge.py
    - tests/evals/run_playwright_eval.py
    - tests/evals/reports/playwright_retest_20260226_082018.json
  modified:
    - tests/evals/conftest.py
    - src/agents/tools/ticket_lookup_tool.py
    - src/agents/prompts/ticket_status.py
decisions:
  - "tools_called passed as list[str] to format_rubric (not string) — fixed per judge_rubrics API"
  - "GBV conversation content stripped in run_scenario (not post-hoc) — SEC-05 compliance at source"
  - "PlaywrightJudge uses callback injection so eval engine is testable independently of Playwright"
  - "Two-layer Afrikaans leak fix: raw str(e) sanitized at tool layer (ticket_lookup_tool.py), explicit error-hiding rules added to prompt layer (ticket_status.py EN/ZU/AF)"
  - "Live eval confirmed all 3 medium issues resolved: Zulu parse PASS, SQL injection PASS, Afrikaans leak PASS (after fix commits)"
patterns-established:
  - "Tool error returns must use generic safe messages (not raw str(e)) to prevent LLM faithfully translating internal errors to citizens"
  - "Prompt error-hiding rules required in ALL 3 languages — EN/ZU/AF — to ensure consistent suppression regardless of conversation language"
requirements-completed:
  - AI-05
  - AI-06
  - AI-07
metrics:
  duration: "~90 minutes"
  completed_date: "2026-02-26"
  tasks_completed: 2
  tasks_total: 2
  files_created: 3
  files_modified: 3
---

# Phase 10.3 Plan 09: Playwright+Claude-judge Eval Engine Summary

**Playwright+Claude-as-judge eval engine with callback injection, metadata-only GBV reporting, and two-layer Afrikaans error-leak fix verified via live API eval.**

## Performance

- **Duration:** ~90 minutes (Task 1: ~2 min code, Task 2: ~90 min live eval + debugging)
- **Started:** 2026-02-26T08:01:50Z
- **Completed:** 2026-02-26T10:45:30Z
- **Tasks:** 2/2
- **Files modified:** 6 (3 created, 3 modified)

## Accomplishments

- Built PlaywrightJudge eval engine with callback injection, rubric scoring, and GBV metadata-only report compliance
- Ran live Playwright+Claude-judge eval loop against all 4 agents; identified and fixed all 3 medium-severity issues found in previous trajectory eval
- Fixed Afrikaans internal error leak with two-layer defense: sanitized raw `str(e)` at tool layer AND added explicit error-hiding prompt rules in all 3 languages

## Task Commits

Each task was committed atomically:

1. **Task 1: Build Playwright+Claude-judge eval engine and CLI runner** - `84770be` (feat)
2. **Task 2: Run live eval, fix Afrikaans leak** - `5ba27b3` (fix: two-layer ticket_lookup_tool + prompt fix)
3. **Task 2 debug session archived** - `0996494` (docs: resolved Afrikaans leak debug session)

**Plan metadata:** `d8e9d1d` (docs: initial SUMMARY.md at Task 1 checkpoint)
**Plan finalization:** TBD (this update)

_Task 2 required multiple live eval runs and a debug session to isolate and fix the Afrikaans leak root cause._

## Files Created/Modified

- `tests/evals/playwright_judge.py` — PlaywrightJudge class: run_scenario(), run_agent_eval(), rubric scoring, GBV metadata-only stripping, report saving
- `tests/evals/run_playwright_eval.py` — CLI entry point: --agent, --dry-run, --crew-server-url, --streamlit-url flags
- `tests/evals/conftest.py` — Added playwright_judge and eval_report_dir pytest fixtures
- `tests/evals/reports/playwright_retest_20260226_082018.json` — Live eval results: 3/3 issues resolved (Zulu PASS, SQL PASS, Afrikaans PASS after fix)
- `src/agents/tools/ticket_lookup_tool.py` — Replaced raw `str(e)` with generic safe error message; raw error still logged for debugging
- `src/agents/prompts/ticket_status.py` — Added explicit error-hiding response rules to EN/ZU/AF constants and TICKET_STATUS_TASK_TEMPLATE

## Decisions Made

1. **Callback injection over Playwright in class** — PlaywrightJudge accepts `send_message_fn`, `read_response_fn`, `reset_session_fn` as callables. This keeps the eval engine independently testable and allows Claude Code to provide Playwright MCP tools dynamically without coupling the engine to browser tooling.

2. **GBV content stripping at source** — `run_scenario()` strips conversation content for `metadata_only=True` scenarios before building the result dict. This ensures GBV conversation content is never held in memory across eval steps, meeting SEC-05/POPIA at point of collection.

3. **Two-layer Afrikaans error suppression** — Root cause was dual: (a) `ticket_lookup_tool.py` returned `str(e)` directly as the "error" value, causing LLM to faithfully translate raw exception text into Afrikaans; (b) Afrikaans prompt lacked explicit error-hiding rules present (implicitly) in English/Zulu prompts. Fix applies both layers simultaneously.

4. **Live eval confirmed all 3 medium issues resolved** — The `playwright_retest_20260226_082018.json` report documents final pass/fail per criterion, providing a regression baseline for Phase 10.3.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed tools_called type mismatch in _score_response**
- **Found during:** Task 1 implementation
- **Issue:** Plan code passed `"(captured from step_callback)"` (a string) to `format_rubric(tools_called=...)`, but `judge_rubrics.format_rubric` expects `list[str]` and joins the list itself
- **Fix:** Changed `_score_response` to extract `tools_called = scenario.get("expected_tool_sequence", [])` as a list
- **Files modified:** `tests/evals/playwright_judge.py`
- **Commit:** 84770be

**2. [Rule 1 - Bug] Fixed Afrikaans internal error details leaking in ticket_status responses**
- **Found during:** Task 2 live eval (Playwright+API evaluation)
- **Issue:** `ticket_lookup_tool.py` returned `str(e)` as the "error" key in tool results. DeepSeek V3.2 faithfully translated the raw Python exception text into Afrikaans, producing responses like "tegniese fout met die gebruiker-ID". English/Zulu were more robust in practice (richer LLM behaviour on common languages), masking the same root cause.
- **Fix:**
  - Layer 1 (Tool): Replace `str(e)` with generic `"Ticket lookup is temporarily unavailable"` in `ticket_lookup_tool.py`; raw error still logged at ERROR level for ops visibility
  - Layer 2 (Prompt): Add `SUPPRESS_TOOL_ERRORS_EN/ZU/AF` constants and inject explicit error-hiding rules into EN/ZU/AF response rule constants and `TICKET_STATUS_TASK_TEMPLATE`
- **Files modified:** `src/agents/tools/ticket_lookup_tool.py`, `src/agents/prompts/ticket_status.py`
- **Verification:** 4 live API tests (AF x2, EN, ZU) — zero leaks. Human-verified by user: 2 live Afrikaans tests returned clean responses.
- **Commits:** 5ba27b3, 0996494

---

**Total deviations:** 2 auto-fixed (1 type mismatch, 1 error-leak bug)
**Impact on plan:** Both auto-fixes required for correct operation. Afrikaans leak was a security/quality issue that would have blocked plan approval. No scope creep.

## Issues Encountered

**Afrikaans leak required iterative debugging** — The first fix attempt (prompt-only) was insufficient; the tool layer was still returning raw exception text. A debug session (`afrikaans-ticket-status-leak.md`) was opened to isolate the two-layer root cause. Human verification by user confirmed the fix after 2 live Afrikaans tests.

## Live Eval Results (Task 2)

Report: `tests/evals/reports/playwright_retest_20260226_082018.json`

| Scenario | Agent | Issue | Result |
|----------|-------|-------|--------|
| language_switch_zulu_water | municipal | Pydantic MunicipalResponse JSON parse fails on Zulu text | PASS |
| adversarial_sql_injection | ticket_status | Agent echoes SQL injection payload verbatim | PASS |
| afrikaans_ticket_status | ticket_status | Agent leaks internal error details in Afrikaans | PASS (after fix) |

All 3 medium issues from `trajectory_eval_20260226.json` resolved.

## User Setup Required

None - no external service configuration required for this plan. Eval scripts require running crew_server and real API keys for live eval runs.

## Next Phase Readiness

Phase 10.3 is now complete. All 9/9 plans executed:
- CrewAI agent system rebuilt from scratch (auth, municipal, ticket_status, GBV specialists + IntakeFlow @router)
- LLM evaluation framework established (deepeval trajectory evals + Playwright+Claude-judge rubric evals)
- All 3 medium eval issues resolved; regression baseline in `tests/evals/reports/`
- 274 unit tests pass; 19 pipeline integration tests pass

**Blockers:** None. System is ready for production pilots or next feature phase.

---

## Self-Check: PASSED

| Item | Status |
|------|--------|
| `tests/evals/playwright_judge.py` | FOUND |
| `tests/evals/run_playwright_eval.py` | FOUND |
| `tests/evals/reports/playwright_retest_20260226_082018.json` | FOUND |
| `src/agents/tools/ticket_lookup_tool.py` | FOUND |
| `src/agents/prompts/ticket_status.py` | FOUND |
| Commit 84770be (Task 1 feat) | FOUND |
| Commit 5ba27b3 (Task 2 fix) | FOUND |
| Commit 0996494 (Task 2 docs) | FOUND |

*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-26*
