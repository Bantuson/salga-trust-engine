---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 05
subsystem: agents
tags: [crewai, municipal-intake, ticket-status, sequential-crew, gpt-4o-mini, pydantic, gugu-persona, trilingual]

# Dependency graph
requires:
  - phase: 10.3-03
    provides: "AuthCrew pattern, BaseCrew base class, agents.yaml/tasks.yaml structure, CrewAI scaffolding"
  - phase: 10.3-01
    provides: "agents_old/tools/ticket_tool.py and ticket_lookup_tool.py as source references"
provides:
  - "MunicipalIntakeCrew — sequential crew, gpt-4o-mini, create_municipal_ticket tool, MUNICIPAL_PROMPTS trilingual, MunicipalResponse Pydantic output"
  - "TicketStatusCrew — sequential crew, gpt-4o-mini, lookup_ticket_tool, TICKET_STATUS_PROMPTS trilingual, TicketStatusResponse Pydantic output"
  - "create_municipal_ticket BaseTool — PostGIS-aware ticket creation via Supabase, USE_POSTGIS guard"
  - "lookup_ticket_tool BaseTool — user_id security assertion, SEC-05 GBV minimal info pattern"
  - "47 unit tests for MunicipalIntakeCrew, 41 unit tests for TicketStatusCrew"
affects:
  - "10.3-06: GBV crew rebuild shares same BaseCrew pattern"
  - "10.3-07: Manager crew dispatch map adds municipal + ticket_status entries"
  - "10.3-08: Eval runner adds municipal and ticket_status agent eval scenarios"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Tool pattern: BaseTool subclass with _impl function separate from decorator — same as auth_tool.py"
    - "Crew pattern: extends BaseCrew, overrides create_crew() to inject PROMPTS[language] as backstory"
    - "FAKE_LLM = crewai.LLM(model=...) for create_crew() tests — MagicMock() fails model string validation"
    - "USE_POSTGIS guard at module level to prevent geoalchemy2 import errors in SQLite test environments"

key-files:
  created:
    - src/agents/tools/ticket_tool.py
    - src/agents/tools/ticket_lookup_tool.py
    - src/agents/prompts/municipal.py
    - src/agents/prompts/ticket_status.py
    - src/agents/crews/municipal_crew.py
    - src/agents/crews/ticket_status_crew.py
    - tests/agents/test_municipal_crew.py
    - tests/agents/test_ticket_status_crew.py
  modified:
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml

key-decisions:
  - "MunicipalIntakeCrew uses get_routing_llm() (gpt-4o-mini) — municipal intake ends with create_municipal_ticket tool call; tool reliability is critical (Phase 10.3 research decision)"
  - "TicketStatusCrew uses get_routing_llm() (gpt-4o-mini) — lookup_ticket_tool requires reliable structured tool use"
  - "Both crews: memory=False — conversation history injected as string context, no cross-session leakage"
  - "MunicipalIntakeCrew max_iter=10 — 3-5 turns to collect description/location/category + tool call"
  - "TicketStatusCrew max_iter=8 — simpler flow: ask for tracking number + look up + report"
  - "USE_POSTGIS guard — try/except import of geoalchemy2/shapely prevents import errors in SQLite test env"
  - "lookup_ticket_tool asserts user_id truthy — defense-in-depth, admin client bypasses Supabase RLS (Phase 06.9 locked)"
  - "Both crews: Backstory from PROMPTS[language] dict (not agents.yaml) — rich trilingual prompt benefits from Python string management"
  - "FAKE_LLM pattern: tests calling create_crew() use crewai.LLM(model=...) not MagicMock — CrewAI validates model as non-empty string"

patterns-established:
  - "BaseTool pattern: _impl function + BaseTool subclass, tool instance at module level"
  - "Trilingual Gugu: CRITICAL IDENTITY at TOP, response guardrail constants appended at bottom"
  - "create_crew() override: PROMPTS[language] as backstory, output_pydantic for structured output"

requirements-completed: [AI-02, AI-03, AI-05]

# Metrics
duration: 26min
completed: 2026-02-25
---

# Phase 10.3 Plan 05: Municipal Intake and Ticket Status Agents Summary

**MunicipalIntakeCrew (create_municipal_ticket) and TicketStatusCrew (lookup_ticket) rebuilt with trilingual Gugu personas, gpt-4o-mini for tool reliability, and 88 unit tests passing**

## Performance

- **Duration:** 26 min
- **Started:** 2026-02-25T14:58:34Z
- **Completed:** 2026-02-25T15:24:31Z
- **Tasks:** 2
- **Files modified:** 10

## Accomplishments

- Rebuilt `create_municipal_ticket` and `lookup_ticket_tool` as BaseTool subclasses, copied from agents_old with PostGIS guard and SEC-05 compliance
- Built `MunicipalIntakeCrew` extending BaseCrew: collects description/location/category from citizen then creates ticket; sequential, memory=False, gpt-4o-mini, max_iter=10
- Built `TicketStatusCrew` extending BaseCrew: looks up ticket by tracking number; sequential, memory=False, gpt-4o-mini, max_iter=8
- Trilingual Gugu personas for both agents (EN/ZU/AF) with CRITICAL IDENTITY anchors and response guardrail rules
- 88 unit tests across both crews passing (220 total in agents/ suite)

## Task Commits

Each task was committed atomically:

1. **Task 1: Rebuild Municipal Intake and Ticket Status agents** - `9791884` (feat)
2. **Task 2: Unit tests for Municipal and Ticket Status agents** - `95cc654` (test)

**Plan metadata:** (this SUMMARY.md commit)

## Files Created/Modified

- `src/agents/tools/ticket_tool.py` - create_municipal_ticket BaseTool with PostGIS USE_POSTGIS guard, returns dict with tracking_number on success / error key on failure
- `src/agents/tools/ticket_lookup_tool.py` - lookup_ticket_tool BaseTool with user_id security assertion (SEC-05), GBV minimal info pattern
- `src/agents/prompts/municipal.py` - MUNICIPAL_PROMPTS (EN/ZU/AF), MunicipalResponse Pydantic model (action_taken, tracking_number), build_municipal_task_description()
- `src/agents/prompts/ticket_status.py` - TICKET_STATUS_PROMPTS (EN/ZU/AF), TicketStatusResponse Pydantic model (tickets_found), build_ticket_status_task_description()
- `src/agents/crews/municipal_crew.py` - MunicipalIntakeCrew: agent_key=municipal_intake_agent, tools=[create_municipal_ticket], max_iter=10
- `src/agents/crews/ticket_status_crew.py` - TicketStatusCrew: agent_key=ticket_status_agent, tools=[lookup_ticket_tool], max_iter=8
- `src/agents/config/agents.yaml` - Added municipal_intake_agent and ticket_status_agent entries
- `src/agents/config/tasks.yaml` - Added municipal_intake_task and ticket_status_task entries
- `tests/agents/test_municipal_crew.py` - 47 tests: structure (13), prompts (11), MunicipalResponse (9), task builder (7), tool importability (5)
- `tests/agents/test_ticket_status_crew.py` - 41 tests: structure (13), prompts (8), TicketStatusResponse (8), task builder (6), tool importability (5)

## Decisions Made

- gpt-4o-mini (get_routing_llm) for both crews — both end with a single tool call that must succeed reliably; DeepSeek used for conversation-heavy agents, gpt-4o-mini for tool-heavy ones (Phase 10.3 research decision)
- USE_POSTGIS guard wraps geoalchemy2/shapely imports in ticket_tool.py — prevents import errors in SQLite unit test environments (same pattern as rest of codebase)
- lookup_ticket_tool asserts user_id is truthy before any query — admin client bypasses Supabase RLS, so code-level enforcement is the security boundary (Phase 06.9 locked decision)
- FAKE_LLM = LLM(model="openai/test-model") for create_crew() tests — CrewAI Agent() validates the llm model as a non-empty string, MagicMock() fails this check (Phase 06.9.1-04 locked pattern)

## Deviations from Plan

None - plan executed exactly as written. Both crews, tools, prompts, YAML configs, and unit tests delivered as specified.

## Issues Encountered

One test pattern issue: initial tests used `MagicMock()` as llm in `create_crew()` tests, which fails CrewAI's model string validation ("Model must be a non-empty string"). Fixed by applying the `FAKE_LLM = LLM(model="openai/test-model")` pattern established in test_auth_crew.py.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- MunicipalIntakeCrew and TicketStatusCrew ready for integration in manager crew dispatch map (Plan 07)
- Both crews pass 88 unit tests (structural correctness, tool attachment, Gugu persona, Pydantic models)
- Trajectory evals (live LLM tool-call-sequence verification) run manually via `python -m tests.evals.run_evals --agent municipal` after Plan 08

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-25*
