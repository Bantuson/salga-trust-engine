---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 07
subsystem: agents
tags: [crewai, flow, router, intake, dispatch, whatsapp, messages, routing]

# Dependency graph
requires:
  - phase: 10.3-04
    provides: AuthCrew (rebuilt with get_routing_llm, AUTH_PROMPTS, AuthResult Pydantic)
  - phase: 10.3-05
    provides: MunicipalIntakeCrew and TicketStatusCrew (rebuilt with correct LLMs)
  - phase: 10.3-06
    provides: GBVCrew (trauma-informed, SEC-05 boundary, saps_tool, GBV_PROMPTS)
provides:
  - IntakeFlow with @router dispatch to all 4 specialist crews
  - crew_server.py routing via IntakeFlow (replaces ManagerCrew)
  - messages.py using IntakeFlow for web portal routing
  - whatsapp_service.py using IntakeFlow for WhatsApp routing
  - 35 unit tests covering IntakeFlow routing logic
affects:
  - 10.3-08 (LLM evaluation framework — tests routing pipeline end-to-end)
  - 10.3-09 (integration testing phase)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Flow-as-router: @start classify_intent -> @router route_by_intent -> @listen handler
    - Auth gate before intent classification (unauthenticated always -> auth)
    - routing_phase short-circuit: active specialist session skips LLM classification
    - GBV confirmation gate in crew_server.py (pre-IntakeFlow interception)
    - Lazy crew imports inside @listen handlers (avoids circular imports)
    - pending_intent preservation: original intent saved during auth handoff

key-files:
  created:
    - src/agents/flows/intake_flow.py
    - tests/agents/test_intake_flow.py
  modified:
    - src/api/v1/crew_server.py
    - src/api/v1/messages.py
    - src/services/whatsapp_service.py

key-decisions:
  - "IntakeFlow uses @router for deterministic Python dispatch — no LLM delegation in routing step"
  - "Intent classification is a direct get_routing_llm().call() (gpt-4o-mini), NOT a full Crew"
  - "GBV confirmation gate lives in crew_server.py pre-IntakeFlow (two-turn safety gate)"
  - "routing_phase short-circuit: active specialist keeps control without re-classification"
  - "pending_intent stores classified intent (not raw message) during auth handoff"
  - "Lazy crew imports inside @listen handlers prevent circular imports at module level"
  - "category='gbv' forced in handle_gbv() result even if GBVCrew omits it (SEC-05 defense)"
  - "MunicipalCrew bug in _SPECIALIST_MAP fixed: correct class is MunicipalIntakeCrew"

patterns-established:
  - "IntakeFlow pattern: @start(classify) -> @router(classify) -> @listen(intent) = 3-step dispatch"
  - "Flow state population: caller sets state fields directly before kickoff_async()"
  - "Crew result includes agent_name field for crew_server identification"
  - "Auth gate saves pending_intent as classified intent string (not raw message)"

requirements-completed:
  - AI-01
  - AI-02
  - AI-03
  - AI-04

# Metrics
duration: 17.9min
completed: 2026-02-25
---

# Phase 10.3 Plan 07: IntakeFlow Capstone Integration Summary

**CrewAI @router Flow replacing ManagerCrew for deterministic dispatch to all 4 specialist crews via direct LLM intent classification, with auth gate, routing_phase short-circuit, GBV confirmation gate, and 35 routing unit tests**

## Performance

- **Duration:** 17.9 min (1075 seconds)
- **Started:** 2026-02-25T15:14:45Z
- **Completed:** 2026-02-25T15:32:40Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Built `IntakeFlow` with `@start classify_intent -> @router route_by_intent -> @listen handler` pattern that replaces `ManagerCrew` with deterministic Python routing
- Updated `crew_server.py`, `messages.py`, and `whatsapp_service.py` to route through `IntakeFlow` instead of `ManagerCrew`; GBV confirmation gate preserved in crew_server
- Created 35 unit tests covering intent classification, auth gate, routing_phase short-circuit, pending_intent preservation, language detection, and specialist dispatch

## Task Commits

Each task was committed atomically:

1. **Task 1: Build IntakeFlow with @router dispatch and update endpoints** - `a999bec` (feat)
2. **Task 2: IntakeFlow and routing unit tests** - `f9bda07` (test)

**Plan metadata:** _(see final commit after summary)_

## Files Created/Modified

- `src/agents/flows/intake_flow.py` — IntakeFlow with @start/@router/@listen pattern dispatching to all 4 specialist crews
- `src/api/v1/crew_server.py` — Updated to route through IntakeFlow, health endpoint lists all 4 agents, GBV confirmation gate preserved pre-Flow
- `src/api/v1/messages.py` — Web portal send_message uses IntakeFlow instead of ManagerCrew
- `src/services/whatsapp_service.py` — WhatsApp process_incoming_message uses IntakeFlow instead of ManagerCrew
- `tests/agents/test_intake_flow.py` — 35 unit tests for IntakeFlow routing logic

## Decisions Made

- **Intent classification as direct LLM call**: `_classify_raw_intent()` calls `get_routing_llm().call()` directly (gpt-4o-mini) rather than creating a full Crew — single-shot classification doesn't need Agent/Task overhead
- **GBV confirmation gate stays in crew_server.py**: The two-turn safety gate (gbv_pending_confirm state) is checked before IntakeFlow is invoked. IntakeFlow just classifies and dispatches — the interception is the caller's responsibility
- **pending_intent stores classified intent string**: When auth gate intercepts, the LLM first classifies the intent and saves that string (e.g. "municipal") as pending_intent, not the raw message — this is more reliable for post-auth replay
- **Lazy imports inside @listen handlers**: Each handler imports its specialist crew inside the function body to avoid circular imports at module level
- **Fixed MunicipalCrew class name bug**: The old `crew_server.py _SPECIALIST_MAP` referenced `"MunicipalCrew"` but the actual class is `MunicipalIntakeCrew` — fixed in the IntakeFlow handler

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed MunicipalCrew class name in old _SPECIALIST_MAP**
- **Found during:** Task 1 (crew_server.py update)
- **Issue:** The old `_SPECIALIST_MAP` in crew_server.py referenced `"MunicipalCrew"` but the actual class name is `MunicipalIntakeCrew` (from Plan 05 rebuild). This would have caused `AttributeError` on municipal routing.
- **Fix:** The IntakeFlow `handle_municipal()` handler imports `MunicipalIntakeCrew` directly (correct name). The old `_SPECIALIST_MAP` was replaced entirely by the IntakeFlow pattern.
- **Files modified:** `src/agents/flows/intake_flow.py`
- **Verification:** `pytest tests/agents/test_intake_flow.py` passes (35 tests)
- **Committed in:** a999bec (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 bug)
**Impact on plan:** Auto-fix necessary for correctness — old class name would have caused AttributeError on municipal routing. No scope creep.

## Issues Encountered

- `kickoff_async()` exists in CrewAI 1.8.1 (confirmed via quick test) — the plan's note about potential fallback to synchronous kickoff was not needed
- Flow `@router` decorator pattern confirmed working: `@router(classify_intent)` triggers based on return value of `route_by_intent()` which reads `state.intent`

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Complete routing pipeline established: HTTP -> crew_server -> IntakeFlow -> specialist Crew -> response
- All 4 specialist crews (Auth, Municipal, GBV, Ticket Status) wired to IntakeFlow
- 255 total tests passing in `tests/agents/` test suite (35 new IntakeFlow tests + 220 pre-existing)
- Phase 10.3 Plan 08 (LLM evaluation framework) can evaluate the full routing pipeline end-to-end

## Self-Check: PASSED

- src/agents/flows/intake_flow.py: FOUND
- tests/agents/test_intake_flow.py: FOUND
- .planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-07-SUMMARY.md: FOUND
- Commit a999bec: FOUND
- Commit f9bda07: FOUND

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-25*
