---
phase: 06.6-playwright-e2e
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/design-tokens.css
  - frontend-dashboard/src/pages/TicketListPage.tsx
  - frontend-dashboard/src/pages/DashboardPage.tsx
  - frontend-dashboard/src/components/dashboard/MetricsCards.tsx
  - frontend-dashboard/src/App.css
  - frontend-public/src/pages/ReportIssuePage.tsx
  - frontend-public/src/pages/TransparencyDashboardPage.tsx
  - frontend-public/src/contexts/AuthContext.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Glass cards provide sufficient text contrast over photo backgrounds"
    - "Dashboard stat cards are visually distinct from pink background"
    - "Ticket page handles network errors with retry limit, not infinite loop"
    - "After max retries, ticket page shows error UI with manual Retry button"
    - "Submit Report button is visually prominent with coral background"
    - "Report form heading, placeholders, and character counter are readable"
    - "Transparency dashboard heading and empty-state text have sufficient contrast"
    - "Stale auth refresh tokens are cleared gracefully without console errors"
  artifacts:
    - path: "shared/design-tokens.css"
      provides: "Increased glass opacity and blur values for readability"
      contains: "rgba(255, 255, 255, 0.35)"
    - path: "frontend-dashboard/src/pages/TicketListPage.tsx"
      provides: "Fetch with retry logic, max 3 retries, exponential backoff"
      contains: "retryCount"
    - path: "frontend-dashboard/src/components/dashboard/MetricsCards.tsx"
      provides: "Dashboard metric cards with visible borders"
      contains: "border"
    - path: "frontend-dashboard/src/App.css"
      provides: "Dashboard card border and contrast styles"
      contains: "animated-card"
    - path: "frontend-public/src/pages/ReportIssuePage.tsx"
      provides: "Readable report form with styled heading and higher-contrast placeholders"
      contains: "text-shadow"
    - path: "frontend-public/src/contexts/AuthContext.tsx"
      provides: "Graceful stale token handling"
      contains: "signOut"
  key_links:
    - from: "TicketListPage.tsx"
      to: "fetchTickets"
      via: "retry count state with exponential backoff"
      pattern: "retryCount|setTimeout|backoff"
    - from: "MetricsCards.tsx"
      to: "design-tokens.css"
      via: "CSS variable consumption for card styling"
      pattern: "var\\(--glass"
---

<objective>
Fix design token readability, dashboard card contrast, ticket page infinite retry loop, report form styling, transparency dashboard contrast, and stale auth token handling.

Purpose: Covers UAT Tests 8, 9, 11, 14, 15, 18, 19. Glassmorphism values are too transparent for text-heavy content over the skyline photo (Tests 11, 19). Municipal dashboard cards blend into the pink background (Test 14). Ticket page enters infinite retry loop when backend is unreachable (Test 15 — BLOCKER). Submit Report button looks like plain text (Test 8). Report form heading/placeholders/counter have poor contrast (Test 9). Transparency dashboard heading and empty-state text are unreadable (Test 11). Stale auth refresh tokens cause console errors on every page load (Test 18).

Output: Higher glass opacity/blur for readable text, visually distinct dashboard cards, resilient ticket fetching with error handling, prominent Submit Report button, readable report form elements, legible transparency dashboard text, and graceful stale token cleanup.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.6-playwright-e2e/06.6-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increase glass readability tokens and dashboard card contrast</name>
  <files>
    shared/design-tokens.css
    frontend-dashboard/src/components/dashboard/MetricsCards.tsx
    frontend-dashboard/src/App.css
    frontend-dashboard/src/pages/DashboardPage.tsx
  </files>
  <action>
**Gap 6 — shared/design-tokens.css** (lines 83-88):
Update the glassmorphism design tokens for better text readability over the Johannesburg skyline photo background:
```css
/* Glassmorphism */
--glass-white-frost: rgba(255, 255, 255, 0.35);        /* was 0.25 */
--glass-pink-frost: rgba(205, 94, 129, 0.35);          /* was 0.25 */
--glass-border: rgba(255, 255, 255, 0.25);              /* was 0.2 */
--glass-blur-subtle: 16px;                               /* was 10px */
--glass-blur-medium: 28px;                               /* was 20px */
```
These values increase the frosted glass effect, making text over the skyline photo significantly more readable while preserving the glassmorphism aesthetic.

**Gap 8 — frontend-dashboard/src/App.css:**
Add styles for the `animated-card` class (used by AnimatedCard component wrapping MetricsCards) to ensure dashboard stat cards stand out against the pink surface:
```css
/* Dashboard stat card contrast enhancement */
.animated-card {
  background: rgba(255, 255, 255, 0.30);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: var(--space-lg);
}
```
This gives the metric cards visible borders and a slightly stronger white frost background than the base pink surface.

**Gap 8 — frontend-dashboard/src/components/dashboard/MetricsCards.tsx:**
1. Update the `cardTitle` style to use a brighter text color for better contrast:
   ```tsx
   cardTitle: {
     fontSize: '0.875rem',
     fontWeight: '500',
     color: 'var(--text-primary)',          // was var(--text-secondary) — too faint on pink
     marginBottom: 'var(--space-md)',
     textTransform: 'uppercase' as const,
     letterSpacing: '0.05em',
     textShadow: '0 1px 2px rgba(0, 0, 0, 0.15)',
   }
   ```

2. In the "No data" fallback (the `if (!metrics)` block around line 95-97), replace `return null;` with a visible empty state:
   ```tsx
   if (!metrics) {
     return (
       <div style={styles.container}>
         {['Open Tickets', 'Resolved', 'SLA Compliance', 'SLA Breaches'].map((title) => (
           <GlassCard key={title} variant="default" style={{ border: '1px solid rgba(255, 255, 255, 0.25)' }}>
             <div style={styles.cardTitle}>{title}</div>
             <div style={{ ...styles.cardValue, color: 'var(--text-muted)' }}>--</div>
           </GlassCard>
         ))}
       </div>
     );
   }
   ```

**Gap 8 — frontend-dashboard/src/pages/DashboardPage.tsx:**
Add `text-shadow` to the dashboard title style for legibility:
```tsx
title: {
  fontSize: '1.875rem',
  fontWeight: '700',
  color: 'var(--text-primary)',
  textShadow: '0 1px 3px rgba(0, 0, 0, 0.2)',
}
```

**Do NOT:** Change the color scheme or brand identity. Only increase opacity/blur/contrast within the existing pink/rose glassmorphism system.
  </action>
  <verify>
Run `cd frontend-dashboard && npx vite build` and `cd frontend-public && npx vite build` to confirm both apps build (shared tokens affect both). Grep for `0.35` in design-tokens.css (glass-white-frost and glass-pink-frost). Grep for `animated-card` in frontend-dashboard App.css. Grep for `text-primary` in MetricsCards.tsx cardTitle. Grep for `textShadow` in DashboardPage.tsx.
  </verify>
  <done>
Glass tokens increased (white-frost 0.35, pink-frost 0.35, blur-subtle 16px, blur-medium 28px). Dashboard stat cards have visible borders and stronger background. Metric card titles use primary text color with text-shadow. No-data state shows placeholder cards instead of nothing. Dashboard title has text-shadow for readability over pink surface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry logic with exponential backoff to TicketListPage</name>
  <files>
    frontend-dashboard/src/pages/TicketListPage.tsx
  </files>
  <action>
Fix Gap 4 (BLOCKER): The `useEffect` on line 72-91 fetches tickets when `filters` change. When the backend is unreachable, it sets error state but doesn't prevent continued re-fetching, causing rapid error cycling.

**TicketListPage.tsx** — Replace the fetch useEffect (lines 72-91) with retry-aware logic:

1. Add a `retryCount` state and a `MAX_RETRIES` constant at the top of the component:
   ```tsx
   const MAX_RETRIES = 3;
   const [retryCount, setRetryCount] = useState(0);
   const retryTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
   ```

2. Add a `filtersKey` ref to track when filters genuinely change (vs re-renders):
   ```tsx
   const prevFiltersRef = useRef<string>('');
   ```

3. Replace the existing `useEffect` with:
   ```tsx
   // Reset retry count when filters genuinely change
   useEffect(() => {
     const filtersKey = JSON.stringify(filters);
     if (filtersKey !== prevFiltersRef.current) {
       prevFiltersRef.current = filtersKey;
       setRetryCount(0);
       setError(null);
       // Clear any pending retry timeout
       if (retryTimeoutRef.current) {
         clearTimeout(retryTimeoutRef.current);
         retryTimeoutRef.current = null;
       }
     }
   }, [filters]);

   // Fetch tickets with retry logic
   useEffect(() => {
     if (retryCount > MAX_RETRIES) return; // Stop after max retries

     async function loadTickets() {
       try {
         setIsLoading(true);
         setError(null);
         const response = await fetchTickets(filters);
         setTickets(response.tickets);
         setPageCount(response.page_count);
         setRetryCount(0); // Reset on success
       } catch (err) {
         console.error(`[TicketListPage] Fetch failed (attempt ${retryCount + 1}/${MAX_RETRIES}):`, err);
         setTickets([]);
         setPageCount(0);

         if (retryCount < MAX_RETRIES) {
           const backoffMs = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
           setError(`Connection failed. Retrying in ${backoffMs / 1000}s...`);
           retryTimeoutRef.current = setTimeout(() => {
             setRetryCount((prev) => prev + 1);
           }, backoffMs);
         } else {
           setError(err instanceof Error ? err.message : 'Failed to load tickets. Please try again.');
         }
       } finally {
         setIsLoading(false);
       }
     }

     loadTickets();
   }, [filters, retryCount]);

   // Cleanup timeout on unmount
   useEffect(() => {
     return () => {
       if (retryTimeoutRef.current) {
         clearTimeout(retryTimeoutRef.current);
       }
     };
   }, []);
   ```

4. Add a manual retry button in the error UI. Find the error display section in the JSX (search for `{error &&`) and replace or enhance it:
   ```tsx
   {error && retryCount > MAX_RETRIES && (
     <div style={{
       padding: '2rem',
       textAlign: 'center',
       color: 'var(--color-coral)',
       background: 'rgba(239, 68, 68, 0.1)',
       border: '1px solid var(--color-coral)',
       borderRadius: 'var(--radius-md)',
       marginBottom: '1rem',
     }}>
       <p style={{ marginBottom: '1rem', fontSize: '1rem' }}>{error}</p>
       <button
         onClick={() => {
           setRetryCount(0);
           setError(null);
         }}
         style={{
           padding: '0.5rem 1.5rem',
           backgroundColor: 'var(--color-coral)',
           color: 'white',
           border: 'none',
           borderRadius: 'var(--radius-sm)',
           fontSize: '0.875rem',
           fontWeight: '600',
           cursor: 'pointer',
         }}
       >
         Retry
       </button>
     </div>
   )}
   {error && retryCount <= MAX_RETRIES && (
     <div style={{
       padding: '0.75rem 1rem',
       color: 'var(--color-accent-gold)',
       background: 'rgba(255, 213, 79, 0.1)',
       border: '1px solid rgba(255, 213, 79, 0.3)',
       borderRadius: 'var(--radius-sm)',
       marginBottom: '1rem',
       fontSize: '0.875rem',
     }}>
       {error}
     </div>
   )}
   ```

5. Add `useRef` to the imports at the top of the file if not already present.

**Do NOT:** Change the filter logic or the fetchTickets service call itself. Only add retry/backoff wrapper around the existing fetch.
  </action>
  <verify>
Run `cd frontend-dashboard && npx vite build` to confirm the build succeeds. Grep for `MAX_RETRIES` in TicketListPage.tsx. Grep for `retryCount` in TicketListPage.tsx. Grep for `backoffMs` in TicketListPage.tsx to confirm exponential backoff is implemented.
  </verify>
  <done>
TicketListPage has MAX_RETRIES=3 with exponential backoff (1s, 2s, 4s). After max retries, shows error UI with manual "Retry" button. During retries, shows yellow "Retrying..." message. Retry count resets when filters genuinely change. No infinite loop possible — `retryCount > MAX_RETRIES` guard prevents further fetches.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Report page Submit button visibility and form readability</name>
  <files>
    frontend-public/src/pages/ReportIssuePage.tsx
  </files>
  <action>
Fix Tests 8 and 9: Submit Report button looks like plain text (no background/border). Report form heading uses gradient text that's unreadable on glass card. Character counter and placeholders have low contrast.

**Test 8 — Submit Report button (line 738-746):**
The `<Button variant="primary">` component should already render with coral background from `shared/components/ui/Button.tsx`. However, the button may have issues in context. Add explicit inline style reinforcement to ensure visibility:
```tsx
<Button
  type="submit"
  variant="primary"
  disabled={isSubmitting || !isResidenceVerified}
  style={{
    width: '100%',
    backgroundColor: 'var(--color-coral)',
    color: '#fff',
    fontWeight: '600',
    fontSize: '1.1rem',
    padding: '14px 24px',
    border: 'none',
    borderRadius: 'var(--radius-md)',
    cursor: isSubmitting || !isResidenceVerified ? 'not-allowed' : 'pointer',
    opacity: isSubmitting || !isResidenceVerified ? 0.6 : 1,
    textShadow: '0 1px 2px rgba(0, 0, 0, 0.2)',
  }}
  title={!isResidenceVerified ? 'Verify residence first' : ''}
>
  {isSubmitting ? 'Submitting...' : 'Submit Report'}
</Button>
```

**Test 9 — Report form heading (lines 353-365):**
Replace the gradient text heading with a solid, high-contrast color plus text-shadow:
```tsx
<h1
  style={{
    margin: '0 0 8px 0',
    fontSize: '2rem',
    fontWeight: 600,
    color: 'var(--text-primary)',
    textShadow: '0 1px 3px rgba(0, 0, 0, 0.3)',
  }}
>
  Report an Issue
</h1>
```
This replaces the gradient text (`WebkitTextFillColor: 'transparent'`) with solid white text that has adequate contrast on the elevated glass card.

**Test 9 — Description placeholder contrast (lines 496-507):**
Add a `::placeholder` style. Since this is inline JSX, add a `className` to the textarea and a CSS rule in `frontend-public/src/App.css`. However, the simpler approach is to keep it inline — React doesn't support `::placeholder` inline, so instead add `id="report-description"` (it already has it) and add this rule to `frontend-public/src/App.css` at the end of the file:
```css
/* Report form placeholder contrast */
#description::placeholder {
  color: rgba(255, 255, 255, 0.5);
}
```

**Test 9 — Character counter contrast (line 508-510):**
Change the character counter color from `rgba(255, 255, 255, 0.6)` to `var(--text-secondary)` for better readability:
```tsx
<small style={{ color: 'var(--text-secondary)', textShadow: '0 1px 2px rgba(0, 0, 0, 0.15)' }}>
  {description.length} / 2000 characters (minimum 20)
</small>
```

**Do NOT:** Change the form layout, validation logic, or category dropdown styling. Only fix the heading, button, placeholder, and counter contrast.
  </action>
  <verify>
Run `cd frontend-public && npx vite build` to confirm the build succeeds. Grep for `textShadow` in ReportIssuePage.tsx to confirm heading text-shadow. Grep for `color-coral` in ReportIssuePage.tsx to confirm button explicit styling. Grep for `text-secondary` in ReportIssuePage.tsx to confirm character counter upgraded color.
  </verify>
  <done>
Submit Report button has explicit coral background with white text and text-shadow. Report heading uses solid var(--text-primary) with text-shadow instead of unreadable gradient. Character counter uses var(--text-secondary) instead of rgba(255,255,255,0.6). Placeholder contrast improved via CSS rule.
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix Transparency Dashboard contrast and stale auth token handling</name>
  <files>
    frontend-public/src/pages/TransparencyDashboardPage.tsx
    frontend-public/src/App.css
    frontend-public/src/contexts/AuthContext.tsx
  </files>
  <action>
Fix Tests 11 and 18: Transparency dashboard heading and empty-state text have poor contrast. Stale auth refresh tokens cause AuthApiError on every page load.

**Test 11 — Transparency dashboard heading (TransparencyDashboardPage.tsx line 29-31):**
The heading uses `<span className="text-coral">` which applies gradient text (`background: linear-gradient(...)`, `WebkitTextFillColor: transparent`). This is unreadable over the skyline background. Replace with solid text:
```tsx
<h1 className="dashboard-title">
  <span style={{ color: 'var(--text-primary)', textShadow: '0 2px 4px rgba(0, 0, 0, 0.3)' }}>Municipal Transparency Dashboard</span>
</h1>
```
Remove the `text-coral` className and use inline style with solid color and text-shadow.

**Test 11 — Subtitle contrast (line 32-34):**
The subtitle uses `.dashboard-subtitle` class which has `color: var(--text-secondary)`. Add text-shadow for readability over background:
```tsx
<p className="dashboard-subtitle" style={{ textShadow: '0 1px 2px rgba(0, 0, 0, 0.2)' }}>
  Public performance metrics for South African municipalities
</p>
```

**Test 11 — Metric label and empty-state text contrast (App.css):**
Update `.metric-label` from `color: var(--text-muted)` to `color: var(--text-secondary)` and add text-shadow. Also update `.metric-note`:
```css
.metric-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: var(--space-sm);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
}

.metric-note {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
}
```
These changes upgrade the labels from `--text-muted` (#c7b3ba) to `--text-secondary` (#e0d4d8), a significant contrast improvement.

**Test 18 — Stale auth refresh token handling (AuthContext.tsx):**
The `getSession()` call on line 40-44 doesn't handle stale refresh tokens. When a refresh token in localStorage is expired/invalid, Supabase throws `AuthApiError: Invalid Refresh Token` on every page load.

Wrap the `getSession()` call with error handling that gracefully clears stale sessions:
```tsx
useEffect(() => {
  // Get initial session — handle stale refresh tokens gracefully
  supabase.auth.getSession().then(({ data: { session }, error }) => {
    if (error) {
      console.warn('[AuthContext] Session recovery failed, clearing stale tokens:', error.message);
      // Clear invalid session without throwing
      supabase.auth.signOut().catch(() => {});
      setSession(null);
      setUser(null);
    } else {
      setSession(session);
      setUser(session?.user ?? null);
    }
    setLoading(false);
  });

  // Subscribe to auth state changes
  const {
    data: { subscription },
  } = supabase.auth.onAuthStateChange((_event, session) => {
    setSession(session);
    setUser(session?.user ?? null);
    setLoading(false);
  });

  // Cleanup subscription on unmount
  return () => subscription.unsubscribe();
}, []);
```
Key changes:
1. Destructure `error` from `getSession()` response
2. If error (stale token), log a warning (not error) and call `signOut()` to clear localStorage
3. Set session/user to null so the app continues as logged-out
4. The `signOut().catch(() => {})` prevents double-error if signOut also fails

**Do NOT:** Change auth flow logic, add new auth methods, or modify the signInWithEmail/signInWithPhone/signUp functions. Only fix the initial session recovery and transparency dashboard text contrast.
  </action>
  <verify>
Run `cd frontend-public && npx vite build` to confirm the build succeeds. Grep for `text-shadow` in TransparencyDashboardPage.tsx (heading/subtitle). Grep for `text-secondary` in App.css metric-label. Grep for `Session recovery failed` in AuthContext.tsx to confirm stale token handling. Grep for `signOut` in the getSession error handler in AuthContext.tsx.
  </verify>
  <done>
Transparency dashboard heading uses solid white text with text-shadow instead of gradient. Subtitle has text-shadow for readability. Metric labels and notes upgraded from --text-muted to --text-secondary with text-shadow. Stale auth tokens are caught in getSession() error handler, logged as warning, and cleared via signOut() — no more AuthApiError console errors on page load.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend-dashboard && npx vite build` completes with zero errors
2. `cd frontend-public && npx vite build` completes with zero errors
3. `grep -c "0.35" shared/design-tokens.css` returns >= 2 (white-frost and pink-frost)
4. `grep -c "MAX_RETRIES" frontend-dashboard/src/pages/TicketListPage.tsx` returns >= 1
5. `grep -c "animated-card" frontend-dashboard/src/App.css` returns >= 1
6. `grep -c "textShadow" frontend-dashboard/src/pages/DashboardPage.tsx` returns >= 1
7. `grep -c "color-coral" frontend-public/src/pages/ReportIssuePage.tsx` returns >= 1 (Submit button)
8. `grep -c "textShadow" frontend-public/src/pages/ReportIssuePage.tsx` returns >= 1 (heading)
9. `grep -c "text-secondary" frontend-public/src/pages/ReportIssuePage.tsx` returns >= 1 (counter)
10. `grep -c "text-shadow" frontend-public/src/App.css` returns >= 2 (metric-label, metric-note)
11. `grep -c "Session recovery failed" frontend-public/src/contexts/AuthContext.tsx` returns >= 1
12. `grep -c "textShadow" frontend-public/src/pages/TransparencyDashboardPage.tsx` returns >= 1
</verification>

<success_criteria>
- Glass design tokens increased: white-frost 0.35, pink-frost 0.35, blur-subtle 16px, blur-medium 28px
- Dashboard stat cards have visible white border and enhanced background opacity
- Metric card titles use primary text color with text-shadow
- No-data state shows "--" placeholders instead of empty space
- TicketListPage has max 3 retries with 1s/2s/4s exponential backoff
- After max retries, error UI shows with clickable Retry button
- No infinite retry loop possible under any network condition
- Submit Report button has explicit coral background, white text, and text-shadow (Test 8)
- Report heading uses solid text-primary color with text-shadow, not gradient (Test 9)
- Character counter uses text-secondary with text-shadow for readability (Test 9)
- Transparency dashboard heading uses solid white text with text-shadow (Test 11)
- Metric labels and notes upgraded from text-muted to text-secondary with text-shadow (Test 11)
- Stale auth refresh tokens caught and cleared gracefully, no AuthApiError console spam (Test 18)
- Both frontend apps build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-e2e/06.6-08-SUMMARY.md`
</output>
