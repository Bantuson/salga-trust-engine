---
phase: 06.6-playwright-e2e
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/design-tokens.css
  - frontend-dashboard/src/pages/TicketListPage.tsx
  - frontend-dashboard/src/pages/DashboardPage.tsx
  - frontend-dashboard/src/components/dashboard/MetricsCards.tsx
  - frontend-dashboard/src/App.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Glass cards provide sufficient text contrast over photo backgrounds"
    - "Dashboard stat cards are visually distinct from pink background"
    - "Ticket page handles network errors with retry limit, not infinite loop"
    - "After max retries, ticket page shows error UI with manual Retry button"
  artifacts:
    - path: "shared/design-tokens.css"
      provides: "Increased glass opacity and blur values for readability"
      contains: "rgba(255, 255, 255, 0.35)"
    - path: "frontend-dashboard/src/pages/TicketListPage.tsx"
      provides: "Fetch with retry logic, max 3 retries, exponential backoff"
      contains: "retryCount"
    - path: "frontend-dashboard/src/components/dashboard/MetricsCards.tsx"
      provides: "Dashboard metric cards with visible borders"
      contains: "border"
    - path: "frontend-dashboard/src/App.css"
      provides: "Dashboard card border and contrast styles"
      contains: "animated-card"
  key_links:
    - from: "TicketListPage.tsx"
      to: "fetchTickets"
      via: "retry count state with exponential backoff"
      pattern: "retryCount|setTimeout|backoff"
    - from: "MetricsCards.tsx"
      to: "design-tokens.css"
      via: "CSS variable consumption for card styling"
      pattern: "var\\(--glass"
---

<objective>
Fix design token readability, dashboard card contrast, and ticket page infinite retry loop.

Purpose: Glassmorphism values are too transparent for text-heavy content over the skyline photo (Gap 6). Municipal dashboard cards blend into the pink background (Gap 8). Ticket page enters infinite retry loop when backend is unreachable (Gap 4 — BLOCKER).

Output: Higher glass opacity/blur for readable text, visually distinct dashboard cards, and resilient ticket fetching with graceful error handling.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.6-playwright-e2e/06.6-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increase glass readability tokens and dashboard card contrast</name>
  <files>
    shared/design-tokens.css
    frontend-dashboard/src/components/dashboard/MetricsCards.tsx
    frontend-dashboard/src/App.css
    frontend-dashboard/src/pages/DashboardPage.tsx
  </files>
  <action>
**Gap 6 — shared/design-tokens.css** (lines 83-88):
Update the glassmorphism design tokens for better text readability over the Johannesburg skyline photo background:
```css
/* Glassmorphism */
--glass-white-frost: rgba(255, 255, 255, 0.35);        /* was 0.25 */
--glass-pink-frost: rgba(205, 94, 129, 0.35);          /* was 0.25 */
--glass-border: rgba(255, 255, 255, 0.25);              /* was 0.2 */
--glass-blur-subtle: 16px;                               /* was 10px */
--glass-blur-medium: 28px;                               /* was 20px */
```
These values increase the frosted glass effect, making text over the skyline photo significantly more readable while preserving the glassmorphism aesthetic.

**Gap 8 — frontend-dashboard/src/App.css:**
Add styles for the `animated-card` class (used by AnimatedCard component wrapping MetricsCards) to ensure dashboard stat cards stand out against the pink surface:
```css
/* Dashboard stat card contrast enhancement */
.animated-card {
  background: rgba(255, 255, 255, 0.30);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: var(--space-lg);
}
```
This gives the metric cards visible borders and a slightly stronger white frost background than the base pink surface.

**Gap 8 — frontend-dashboard/src/components/dashboard/MetricsCards.tsx:**
1. Update the `cardTitle` style to use a brighter text color for better contrast:
   ```tsx
   cardTitle: {
     fontSize: '0.875rem',
     fontWeight: '500',
     color: 'var(--text-primary)',          // was var(--text-secondary) — too faint on pink
     marginBottom: 'var(--space-md)',
     textTransform: 'uppercase' as const,
     letterSpacing: '0.05em',
     textShadow: '0 1px 2px rgba(0, 0, 0, 0.15)',
   }
   ```

2. In the "No data" fallback (the `if (!metrics)` block around line 95-97), replace `return null;` with a visible empty state:
   ```tsx
   if (!metrics) {
     return (
       <div style={styles.container}>
         {['Open Tickets', 'Resolved', 'SLA Compliance', 'SLA Breaches'].map((title) => (
           <GlassCard key={title} variant="default" style={{ border: '1px solid rgba(255, 255, 255, 0.25)' }}>
             <div style={styles.cardTitle}>{title}</div>
             <div style={{ ...styles.cardValue, color: 'var(--text-muted)' }}>--</div>
           </GlassCard>
         ))}
       </div>
     );
   }
   ```

**Gap 8 — frontend-dashboard/src/pages/DashboardPage.tsx:**
Add `text-shadow` to the dashboard title style for legibility:
```tsx
title: {
  fontSize: '1.875rem',
  fontWeight: '700',
  color: 'var(--text-primary)',
  textShadow: '0 1px 3px rgba(0, 0, 0, 0.2)',
}
```

**Do NOT:** Change the color scheme or brand identity. Only increase opacity/blur/contrast within the existing pink/rose glassmorphism system.
  </action>
  <verify>
Run `cd frontend-dashboard && npx vite build` and `cd frontend-public && npx vite build` to confirm both apps build (shared tokens affect both). Grep for `0.35` in design-tokens.css (glass-white-frost and glass-pink-frost). Grep for `animated-card` in frontend-dashboard App.css. Grep for `text-primary` in MetricsCards.tsx cardTitle. Grep for `textShadow` in DashboardPage.tsx.
  </verify>
  <done>
Glass tokens increased (white-frost 0.35, pink-frost 0.35, blur-subtle 16px, blur-medium 28px). Dashboard stat cards have visible borders and stronger background. Metric card titles use primary text color with text-shadow. No-data state shows placeholder cards instead of nothing. Dashboard title has text-shadow for readability over pink surface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry logic with exponential backoff to TicketListPage</name>
  <files>
    frontend-dashboard/src/pages/TicketListPage.tsx
  </files>
  <action>
Fix Gap 4 (BLOCKER): The `useEffect` on line 72-91 fetches tickets when `filters` change. When the backend is unreachable, it sets error state but doesn't prevent continued re-fetching, causing rapid error cycling.

**TicketListPage.tsx** — Replace the fetch useEffect (lines 72-91) with retry-aware logic:

1. Add a `retryCount` state and a `MAX_RETRIES` constant at the top of the component:
   ```tsx
   const MAX_RETRIES = 3;
   const [retryCount, setRetryCount] = useState(0);
   const retryTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
   ```

2. Add a `filtersKey` ref to track when filters genuinely change (vs re-renders):
   ```tsx
   const prevFiltersRef = useRef<string>('');
   ```

3. Replace the existing `useEffect` with:
   ```tsx
   // Reset retry count when filters genuinely change
   useEffect(() => {
     const filtersKey = JSON.stringify(filters);
     if (filtersKey !== prevFiltersRef.current) {
       prevFiltersRef.current = filtersKey;
       setRetryCount(0);
       setError(null);
       // Clear any pending retry timeout
       if (retryTimeoutRef.current) {
         clearTimeout(retryTimeoutRef.current);
         retryTimeoutRef.current = null;
       }
     }
   }, [filters]);

   // Fetch tickets with retry logic
   useEffect(() => {
     if (retryCount > MAX_RETRIES) return; // Stop after max retries

     async function loadTickets() {
       try {
         setIsLoading(true);
         setError(null);
         const response = await fetchTickets(filters);
         setTickets(response.tickets);
         setPageCount(response.page_count);
         setRetryCount(0); // Reset on success
       } catch (err) {
         console.error(`[TicketListPage] Fetch failed (attempt ${retryCount + 1}/${MAX_RETRIES}):`, err);
         setTickets([]);
         setPageCount(0);

         if (retryCount < MAX_RETRIES) {
           const backoffMs = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
           setError(`Connection failed. Retrying in ${backoffMs / 1000}s...`);
           retryTimeoutRef.current = setTimeout(() => {
             setRetryCount((prev) => prev + 1);
           }, backoffMs);
         } else {
           setError(err instanceof Error ? err.message : 'Failed to load tickets. Please try again.');
         }
       } finally {
         setIsLoading(false);
       }
     }

     loadTickets();
   }, [filters, retryCount]);

   // Cleanup timeout on unmount
   useEffect(() => {
     return () => {
       if (retryTimeoutRef.current) {
         clearTimeout(retryTimeoutRef.current);
       }
     };
   }, []);
   ```

4. Add a manual retry button in the error UI. Find the error display section in the JSX (search for `{error &&`) and replace or enhance it:
   ```tsx
   {error && retryCount > MAX_RETRIES && (
     <div style={{
       padding: '2rem',
       textAlign: 'center',
       color: 'var(--color-coral)',
       background: 'rgba(239, 68, 68, 0.1)',
       border: '1px solid var(--color-coral)',
       borderRadius: 'var(--radius-md)',
       marginBottom: '1rem',
     }}>
       <p style={{ marginBottom: '1rem', fontSize: '1rem' }}>{error}</p>
       <button
         onClick={() => {
           setRetryCount(0);
           setError(null);
         }}
         style={{
           padding: '0.5rem 1.5rem',
           backgroundColor: 'var(--color-coral)',
           color: 'white',
           border: 'none',
           borderRadius: 'var(--radius-sm)',
           fontSize: '0.875rem',
           fontWeight: '600',
           cursor: 'pointer',
         }}
       >
         Retry
       </button>
     </div>
   )}
   {error && retryCount <= MAX_RETRIES && (
     <div style={{
       padding: '0.75rem 1rem',
       color: 'var(--color-accent-gold)',
       background: 'rgba(255, 213, 79, 0.1)',
       border: '1px solid rgba(255, 213, 79, 0.3)',
       borderRadius: 'var(--radius-sm)',
       marginBottom: '1rem',
       fontSize: '0.875rem',
     }}>
       {error}
     </div>
   )}
   ```

5. Add `useRef` to the imports at the top of the file if not already present.

**Do NOT:** Change the filter logic or the fetchTickets service call itself. Only add retry/backoff wrapper around the existing fetch.
  </action>
  <verify>
Run `cd frontend-dashboard && npx vite build` to confirm the build succeeds. Grep for `MAX_RETRIES` in TicketListPage.tsx. Grep for `retryCount` in TicketListPage.tsx. Grep for `backoffMs` in TicketListPage.tsx to confirm exponential backoff is implemented.
  </verify>
  <done>
TicketListPage has MAX_RETRIES=3 with exponential backoff (1s, 2s, 4s). After max retries, shows error UI with manual "Retry" button. During retries, shows yellow "Retrying..." message. Retry count resets when filters genuinely change. No infinite loop possible — `retryCount > MAX_RETRIES` guard prevents further fetches.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend-dashboard && npx vite build` completes with zero errors
2. `cd frontend-public && npx vite build` completes with zero errors
3. `grep -c "0.35" shared/design-tokens.css` returns >= 2 (white-frost and pink-frost)
4. `grep -c "MAX_RETRIES" frontend-dashboard/src/pages/TicketListPage.tsx` returns >= 1
5. `grep -c "animated-card" frontend-dashboard/src/App.css` returns >= 1
6. `grep -c "textShadow" frontend-dashboard/src/pages/DashboardPage.tsx` returns >= 1
</verification>

<success_criteria>
- Glass design tokens increased: white-frost 0.35, pink-frost 0.35, blur-subtle 16px, blur-medium 28px
- Dashboard stat cards have visible white border and enhanced background opacity
- Metric card titles use primary text color with text-shadow
- No-data state shows "--" placeholders instead of empty space
- TicketListPage has max 3 retries with 1s/2s/4s exponential backoff
- After max retries, error UI shows with clickable Retry button
- No infinite retry loop possible under any network condition
- Both frontend apps build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-e2e/06.6-08-SUMMARY.md`
</output>
