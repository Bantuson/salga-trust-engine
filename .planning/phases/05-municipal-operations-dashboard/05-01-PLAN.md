---
phase: 05-municipal-operations-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/user.py
  - src/api/v1/tickets.py
  - src/schemas/ticket.py
  - src/services/dashboard_service.py
  - src/api/v1/dashboard.py
  - src/main.py
autonomous: true

must_haves:
  truths:
    - "Manager can list tickets with server-side filtering by status, category, ward, team, and free-text search"
    - "List endpoint returns total count for pagination (not just results)"
    - "Ward councillor role exists and can only see tickets in their ward"
    - "Dashboard metrics endpoint returns ticket volumes, SLA compliance %, and team workload"
    - "GBV tickets are excluded from dashboard metrics (SEC-05)"
  artifacts:
    - path: "src/models/user.py"
      provides: "WARD_COUNCILLOR role in UserRole enum"
      contains: "WARD_COUNCILLOR"
    - path: "src/api/v1/tickets.py"
      provides: "Enhanced list_tickets with search, ward_id, sorting, total count"
      contains: "ward_id"
    - path: "src/schemas/ticket.py"
      provides: "PaginatedTicketResponse with total, page, page_size"
      contains: "PaginatedTicketResponse"
    - path: "src/services/dashboard_service.py"
      provides: "DashboardService with get_metrics, get_volume_by_category, get_sla_compliance, get_team_workload"
      contains: "class DashboardService"
    - path: "src/api/v1/dashboard.py"
      provides: "Dashboard metrics API endpoints"
      contains: "router"
  key_links:
    - from: "src/api/v1/dashboard.py"
      to: "src/services/dashboard_service.py"
      via: "DashboardService dependency"
      pattern: "DashboardService"
    - from: "src/api/v1/tickets.py"
      to: "src/models/user.py"
      via: "WARD_COUNCILLOR role check"
      pattern: "WARD_COUNCILLOR"
    - from: "src/api/v1/dashboard.py"
      to: "src/main.py"
      via: "Router registration"
      pattern: "dashboard.router"
---

<objective>
Create backend API infrastructure for the municipal operations dashboard: add WARD_COUNCILLOR role, enhance the tickets list endpoint with server-side filtering/search/pagination, and create dashboard metrics endpoints.

Purpose: OPS-01 (ticket management), OPS-03 (ward councillor filtering), OPS-04 (metrics) require backend API support before frontend can be built.
Output: Enhanced tickets API + new dashboard metrics API + WARD_COUNCILLOR role
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-municipal-operations-dashboard/05-RESEARCH.md
@src/models/user.py
@src/api/v1/tickets.py
@src/schemas/ticket.py
@src/api/deps.py
@src/main.py
@src/models/ticket.py
@src/models/team.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WARD_COUNCILLOR role and enhance tickets list endpoint</name>
  <files>src/models/user.py, src/api/v1/tickets.py, src/schemas/ticket.py</files>
  <action>
    1. In `src/models/user.py`, add `WARD_COUNCILLOR = "ward_councillor"` to the UserRole enum (after MANAGER, before ADMIN).

    2. In `src/schemas/ticket.py`, add a new `PaginatedTicketResponse` schema:
       ```python
       class PaginatedTicketResponse(BaseModel):
           tickets: list[TicketResponse]
           total: int
           page: int
           page_size: int
           page_count: int
       ```

    3. Rewrite `list_tickets` in `src/api/v1/tickets.py` to support:
       - **Response model**: Change to `PaginatedTicketResponse` (was `list[TicketResponse]`)
       - **Parameters**: Add `search: str | None = None` (free-text search on tracking_number and description), `ward_id: str | None = None`, `sort_by: str = "created_at"`, `sort_order: str = "desc"`, `page: int = 0`, `page_size: int = 50`
       - **RBAC**: Allow `UserRole.WARD_COUNCILLOR` to access (read-only). When user role is WARD_COUNCILLOR, force `ward_id` filter to the user's ward (note: User model doesn't have ward_id yet, so accept it from a query param for now but log a warning that WARD_COUNCILLOR should have ward_id enforced; a future migration will add ward_id to User model)
       - **RBAC note**: Ward councillor can view but NOT assign tickets (assignment endpoint already restricts to MANAGER/ADMIN, no change needed there)
       - **Search**: Use `ilike` for partial matching on `Ticket.tracking_number` and `Ticket.description`
       - **Ward filtering**: Use `Ticket.address.ilike(f"%{ward_id}%")` as interim ward matching (no ward_id column on Ticket yet; proper ward-based filtering will use a ward lookup table in future)
       - **Sorting**: Support `sort_by` values: "created_at", "status", "severity", "category". Validate sort_by against allowed list, default to created_at if invalid
       - **Total count**: Execute a separate COUNT query (same filters, no LIMIT/OFFSET) to get total. Compute page_count = ceil(total / page_size)
       - **Return**: `PaginatedTicketResponse(tickets=[...], total=total, page=page, page_size=page_size, page_count=page_count)`
       - **SEC-05**: Keep existing GBV filtering (SAPS_LIAISON sees only sensitive, others see only non-sensitive)
       - Import `func` from sqlalchemy for COUNT, `math.ceil` for page count, `or_` from sqlalchemy for search OR conditions

    4. Do NOT modify the other endpoints (get_ticket_detail, update_ticket_status, assign_ticket, get_ticket_history) -- they already work correctly.
  </action>
  <verify>
    - `python -c "from src.models.user import UserRole; assert 'ward_councillor' == UserRole.WARD_COUNCILLOR.value"` succeeds
    - `python -c "from src.schemas.ticket import PaginatedTicketResponse; print(PaginatedTicketResponse.model_fields.keys())"` shows tickets, total, page, page_size, page_count
    - `python -c "from src.api.v1.tickets import router; print([r.path for r in router.routes])"` shows the routes still work
  </verify>
  <done>
    - WARD_COUNCILLOR role exists in UserRole enum
    - list_tickets returns PaginatedTicketResponse with total count
    - search, ward_id, sort_by, sort_order parameters accepted
    - WARD_COUNCILLOR can access list_tickets endpoint (read-only)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard metrics service and API endpoints</name>
  <files>src/services/dashboard_service.py, src/api/v1/dashboard.py, src/main.py</files>
  <action>
    1. Create `src/services/dashboard_service.py` with `DashboardService` class:

       ```python
       class DashboardService:
           """Dashboard metrics calculation service.

           All queries exclude GBV/sensitive tickets (SEC-05 compliance).
           Ward councillors receive ward-filtered metrics only.
           """

           async def get_metrics(self, municipality_id: UUID, db: AsyncSession, ward_id: str | None = None) -> dict:
               """Get aggregated dashboard metrics.

               Returns dict with keys:
               - total_open: int (tickets with status open/in_progress/escalated)
               - total_resolved: int (resolved + closed)
               - sla_compliance_percent: float (% tickets within SLA deadline)
               - avg_response_hours: float (average first_responded_at - created_at)
               - sla_breaches: int (tickets past sla_resolution_deadline)
               """
               # Base query: non-sensitive tickets only (SEC-05)
               # Filter by tenant_id = municipality_id
               # If ward_id provided, filter by address ILIKE %ward_id%
               # Calculate each metric using SQLAlchemy func.count, func.avg, etc.

           async def get_volume_by_category(self, municipality_id: UUID, db: AsyncSession, ward_id: str | None = None) -> list[dict]:
               """Get ticket counts grouped by category.

               Returns list of: {"category": str, "open": int, "resolved": int}
               Excludes GBV category (SEC-05).
               """
               # Use func.count with CASE WHEN for open/resolved split
               # Group by category
               # Exclude category='gbv'

           async def get_sla_compliance(self, municipality_id: UUID, db: AsyncSession, ward_id: str | None = None) -> dict:
               """Get SLA compliance breakdown.

               Returns: {
                   "response_compliance_percent": float,
                   "resolution_compliance_percent": float,
                   "total_with_sla": int,
                   "response_breaches": int,
                   "resolution_breaches": int
               }
               """
               # Count tickets with sla deadlines set
               # Count tickets where now > deadline AND status not resolved/closed
               # Calculate percentages

           async def get_team_workload(self, municipality_id: UUID, db: AsyncSession, ward_id: str | None = None) -> list[dict]:
               """Get ticket counts per team.

               Returns list of: {"team_id": str, "team_name": str, "open_count": int, "total_count": int}
               Excludes SAPS teams (SEC-05).
               """
               # Join Ticket with Team
               # Group by team
               # Filter out is_saps=True teams
               # Count open vs total
       ```

       Use SQLAlchemy `select`, `func`, `case`, `join` for all queries. Import from `sqlalchemy import func, case, and_, or_`. All queries must filter `Ticket.is_sensitive == False` (SEC-05). All queries filter by tenant_id.

    2. Create `src/api/v1/dashboard.py` with router (prefix="/dashboard", tags=["dashboard"]):

       Endpoints:
       - `GET /dashboard/metrics` — Returns overall metrics (calls `get_metrics`)
       - `GET /dashboard/volume` — Returns volume by category (calls `get_volume_by_category`)
       - `GET /dashboard/sla` — Returns SLA compliance (calls `get_sla_compliance`)
       - `GET /dashboard/workload` — Returns team workload (calls `get_team_workload`)

       All endpoints:
       - Require authentication via `Depends(get_current_user)`
       - RBAC: Allow MANAGER, ADMIN, WARD_COUNCILLOR only. Use `require_role()` or inline check
       - For WARD_COUNCILLOR: Extract ward_id from query param (same interim approach as tickets)
       - Use `current_user.tenant_id` as municipality_id (TenantAwareModel stores tenant_id)
       - Import from src.api.deps: get_current_user, get_db

    3. In `src/main.py`:
       - Add `from src.api.v1 import dashboard` to imports (add after `tickets` import)
       - Add `app.include_router(dashboard.router, prefix="/api/v1")` after tickets router line

    Note: Use the existing `require_role` dependency from `src/api/deps` for RBAC. The pattern is: `current_user: User = Depends(require_role(UserRole.MANAGER, UserRole.ADMIN, UserRole.WARD_COUNCILLOR))`.
  </action>
  <verify>
    - `python -c "from src.services.dashboard_service import DashboardService; print('OK')"` succeeds
    - `python -c "from src.api.v1.dashboard import router; print([r.path for r in router.routes])"` shows /dashboard/metrics, /dashboard/volume, /dashboard/sla, /dashboard/workload
    - `python -c "from src.main import app; routes = [r.path for r in app.routes]; assert '/api/v1/dashboard/metrics' in routes, f'Missing dashboard route in {routes}'"` confirms router registered
  </verify>
  <done>
    - DashboardService calculates metrics, volume, SLA compliance, team workload
    - All queries exclude GBV/sensitive tickets (SEC-05)
    - Dashboard API endpoints registered and accessible with RBAC
    - WARD_COUNCILLOR can access dashboard endpoints (read-only, ward-filtered)
  </done>
</task>

</tasks>

<verification>
- All existing tests pass: `python -m pytest tests/ -x --timeout=30 -q` (265+ tests, 0 failures)
- New endpoints importable: `python -c "from src.api.v1.dashboard import router; from src.services.dashboard_service import DashboardService"`
- WARD_COUNCILLOR role exists: `python -c "from src.models.user import UserRole; print(UserRole.WARD_COUNCILLOR)"`
- PaginatedTicketResponse schema works: `python -c "from src.schemas.ticket import PaginatedTicketResponse"`
</verification>

<success_criteria>
- Enhanced tickets list endpoint supports search, ward_id, sorting, pagination with total count
- Dashboard metrics endpoints return volume, SLA compliance, team workload data
- WARD_COUNCILLOR role added to UserRole enum
- SEC-05: All dashboard queries exclude GBV/sensitive tickets
- All prior tests still pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-municipal-operations-dashboard/05-01-SUMMARY.md`
</output>
