---
phase: 05-municipal-operations-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03", "05-04"]
files_modified:
  - tests/test_dashboard_service.py
  - tests/test_dashboard_api.py
  - tests/test_event_broadcaster.py
  - tests/test_export_api.py
  - tests/test_tickets_api.py
autonomous: true

must_haves:
  truths:
    - "Dashboard service metrics calculation has unit tests with >80% coverage"
    - "Dashboard API endpoints have security tests (RBAC, SEC-05 GBV exclusion)"
    - "Event broadcaster has unit tests for publish/subscribe"
    - "Export endpoints have tests verifying CSV/Excel output and SEC-05 compliance"
    - "Enhanced tickets list endpoint has tests for search, pagination, ward filtering"
    - "All Phase 1-4 tests still pass (zero regressions)"
  artifacts:
    - path: "tests/test_dashboard_service.py"
      provides: "Unit tests for DashboardService"
      contains: "test_get_metrics"
    - path: "tests/test_dashboard_api.py"
      provides: "API tests for dashboard endpoints"
      contains: "test_dashboard_metrics"
    - path: "tests/test_event_broadcaster.py"
      provides: "Unit tests for EventBroadcaster"
      contains: "test_publish"
    - path: "tests/test_export_api.py"
      provides: "API tests for export endpoints"
      contains: "test_export_csv"
  key_links:
    - from: "tests/test_dashboard_service.py"
      to: "src/services/dashboard_service.py"
      via: "DashboardService unit tests"
      pattern: "DashboardService"
    - from: "tests/test_dashboard_api.py"
      to: "src/api/v1/dashboard.py"
      via: "API endpoint tests"
      pattern: "/dashboard/metrics"
    - from: "tests/test_export_api.py"
      to: "src/api/v1/export.py"
      via: "Export endpoint tests"
      pattern: "/export/tickets"
---

<objective>
Create comprehensive test suite for all Phase 5 code: dashboard service, dashboard API, event broadcaster, export endpoints, and enhanced tickets endpoint. Verify SEC-05 GBV exclusion and RBAC enforcement. Ensure zero regressions on Phase 1-4 tests.

Purpose: Phase verification policy requires >= 80% coverage on phase code, all tests passing, security tests for RBAC and GBV firewall.
Output: Test files + verification report
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-municipal-operations-dashboard/05-01-SUMMARY.md
@.planning/phases/05-municipal-operations-dashboard/05-02-SUMMARY.md
@tests/conftest.py
@tests/test_tickets_api.py
@tests/test_gbv_firewall.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for dashboard service and event broadcaster</name>
  <files>tests/test_dashboard_service.py, tests/test_event_broadcaster.py</files>
  <action>
    1. Create `tests/test_dashboard_service.py` with unit tests for DashboardService:
       - Use `AsyncMock` for database session (same pattern as Phase 4 tests)
       - Test `get_metrics`:
         - Returns correct total_open, total_resolved, sla_compliance_percent
         - Excludes GBV/sensitive tickets (mock query results should verify WHERE is_sensitive==False)
         - With ward_id filter applied
         - With no tickets (returns zeros)
       - Test `get_volume_by_category`:
         - Returns correct open/resolved counts per category
         - Excludes GBV category
         - Empty result returns empty list
       - Test `get_sla_compliance`:
         - Correct compliance percentages calculated
         - Counts breached tickets correctly
         - No SLA data returns zeros
       - Test `get_team_workload`:
         - Returns correct open_count/total_count per team
         - Excludes SAPS teams (is_saps=True)
         - Empty teams returns empty list
       - Test SEC-05 compliance:
         - Verify every query method builds query with `is_sensitive == False` condition
       - Use mock factory pattern from Phase 4: `make_mock_ticket()`, `make_mock_team()` helpers

    2. Create `tests/test_event_broadcaster.py` with unit tests for EventBroadcaster:
       - Mock `redis.asyncio` to avoid real Redis connection
       - Test `publish`:
         - Publishes JSON-serialized event to correct channel
         - Channel format: "dashboard:{municipality_id}"
         - Returns subscriber count
       - Test `subscribe`:
         - Yields parsed JSON events from Redis Pub/Sub
         - Skips non-message types
         - Handles invalid JSON gracefully (logs warning, doesn't crash)
       - Test `close`:
         - Closes Redis connection
         - Handles double-close gracefully
       - Use `unittest.mock.patch` to mock `redis.asyncio.from_url`
       - Use `AsyncMock` for the redis client and pubsub objects
  </action>
  <verify>
    - `python -m pytest tests/test_dashboard_service.py -v --timeout=30` all pass
    - `python -m pytest tests/test_event_broadcaster.py -v --timeout=30` all pass
    - `python -m pytest tests/test_dashboard_service.py tests/test_event_broadcaster.py --cov=src/services/dashboard_service --cov=src/services/event_broadcaster --cov-report=term-missing` shows >= 80% coverage
  </verify>
  <done>
    - DashboardService has comprehensive unit tests covering all 4 metric methods
    - EventBroadcaster has unit tests for publish, subscribe, close
    - SEC-05 verified: all dashboard queries exclude sensitive tickets
    - All tests pass without real database or Redis
  </done>
</task>

<task type="auto">
  <name>Task 2: API tests, security tests, export tests, and regression verification</name>
  <files>tests/test_dashboard_api.py, tests/test_export_api.py, tests/test_tickets_api.py</files>
  <action>
    1. Create `tests/test_dashboard_api.py` with API endpoint tests:
       - Test RBAC enforcement:
         - MANAGER can access /dashboard/metrics -> 200
         - ADMIN can access /dashboard/metrics -> 200
         - WARD_COUNCILLOR can access /dashboard/metrics -> 200
         - CITIZEN cannot access /dashboard/metrics -> 403
         - FIELD_WORKER cannot access /dashboard/metrics -> 403
       - Test all 4 endpoints return expected response structure:
         - GET /dashboard/metrics -> dict with total_open, total_resolved, etc.
         - GET /dashboard/volume -> list of dicts with category, open, resolved
         - GET /dashboard/sla -> dict with compliance percentages
         - GET /dashboard/workload -> list of dicts with team_id, team_name, counts
       - Test ward_id parameter filtering (WARD_COUNCILLOR with ward_id query param)
       - Use existing test patterns from test_tickets_api.py (mock get_current_user, mock db session)
       - Mark as unit tests (mock the database, don't require real PostgreSQL)

    2. Create `tests/test_export_api.py` with export endpoint tests:
       - Test RBAC:
         - MANAGER can export -> 200
         - CITIZEN cannot export -> 403
       - Test CSV export:
         - Returns Content-Type: text/csv
         - Returns Content-Disposition with filename
         - CSV contains expected headers (Tracking Number, Category, Status, etc.)
         - CSV data matches mock ticket data
       - Test Excel export:
         - Returns correct Content-Type for xlsx
         - Returns Content-Disposition with .xlsx filename
         - If openpyxl not available, returns 501
       - Test SEC-05:
         - Export query excludes sensitive tickets
         - GBV tickets never appear in export output
       - Test filters:
         - status filter narrows results
         - category filter narrows results
         - search filter works on tracking_number and description
       - Mock database with known ticket data

    3. Update `tests/test_tickets_api.py`:
       - Add tests for enhanced list_tickets endpoint:
         - Test PaginatedTicketResponse structure (tickets, total, page, page_size, page_count)
         - Test search parameter filters by tracking_number and description
         - Test ward_id parameter filtering
         - Test sort_by and sort_order parameters
         - Test page/page_size pagination
         - Test WARD_COUNCILLOR can access list endpoint (read-only)
         - Test WARD_COUNCILLOR cannot assign tickets (403)
       - Keep all existing tests intact (don't break anything)

    4. Run full regression suite:
       ```bash
       python -m pytest tests/ -x --timeout=30 -q
       ```
       Verify all Phase 1-4 tests still pass (265+ tests, 0 failures).

    5. Run coverage for Phase 5 code:
       ```bash
       python -m pytest tests/test_dashboard_service.py tests/test_event_broadcaster.py tests/test_dashboard_api.py tests/test_export_api.py tests/test_tickets_api.py --cov=src/services/dashboard_service --cov=src/services/event_broadcaster --cov=src/api/v1/dashboard --cov=src/api/v1/events --cov=src/api/v1/export --cov-report=term-missing
       ```
       Target: >= 80% coverage on Phase 5 backend code.

    6. Verify frontend builds:
       ```bash
       cd frontend && npm run build
       ```
  </action>
  <verify>
    - `python -m pytest tests/ -x --timeout=30 -q` shows ALL tests passing (Phase 1-5)
    - Phase 5 coverage >= 80% on dashboard_service, event_broadcaster, dashboard API, export API
    - `cd frontend && npm run build` succeeds
    - SEC-05: GBV exclusion tested in dashboard, export, and ticket list
    - RBAC: All endpoints enforce role-based access
  </verify>
  <done>
    - Dashboard API tests cover RBAC and response structure
    - Export tests verify CSV/Excel output and SEC-05
    - Enhanced tickets list tests cover search, pagination, ward filtering
    - WARD_COUNCILLOR role tested across all endpoints
    - Full regression suite passes (all Phase 1-4 tests green)
    - Phase 5 backend coverage >= 80%
    - Frontend builds successfully
  </done>
</task>

</tasks>

<verification>
- Total test count increased (265+ base + ~40-50 new Phase 5 tests)
- All tests pass: `python -m pytest tests/ -x --timeout=30 -q`
- Phase 5 coverage >= 80%: `python -m pytest ... --cov=... --cov-report=term-missing`
- Frontend builds: `cd frontend && npm run build`
- SEC-05 verified: GBV tickets excluded from all dashboard queries, exports, and metrics
- RBAC verified: WARD_COUNCILLOR, MANAGER, ADMIN properly tested
</verification>

<success_criteria>
- All Phase 5 backend code has >= 80% test coverage
- All Phase 1-4 tests still pass (zero regressions)
- SEC-05 GBV exclusion tested at dashboard, export, and ticket list layers
- RBAC tested for MANAGER, ADMIN, WARD_COUNCILLOR, and unauthorized roles
- Frontend builds without errors
- Phase 5 complete and ready for Phase 6
</success_criteria>

<output>
After completion, create `.planning/phases/05-municipal-operations-dashboard/05-05-SUMMARY.md`
</output>
