---
phase: 06-public-transparency-rollout
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/public_metrics_service.py
  - src/api/v1/public.py
  - src/main.py
  - tests/test_public_metrics_service.py
  - tests/test_public_api.py
autonomous: true

must_haves:
  truths:
    - "Public API returns average response times per municipality without authentication"
    - "Public API returns resolution rates per municipality without authentication"
    - "Public API returns geographic heatmap data (grid-aggregated) without authentication"
    - "GBV/sensitive tickets are NEVER included in any public metrics (SQL-level filter)"
    - "Sensitive ticket counts are returned as system-wide total only, never per-municipality"
    - "Heatmap grid cells with fewer than 3 tickets are suppressed (k-anonymity)"
  artifacts:
    - path: "src/services/public_metrics_service.py"
      provides: "Cross-tenant public metrics aggregation with GBV firewall"
      contains: "is_sensitive == False"
    - path: "src/api/v1/public.py"
      provides: "Public API endpoints (no auth dependency)"
      exports: ["router"]
    - path: "tests/test_public_metrics_service.py"
      provides: "Unit tests for public metrics service"
    - path: "tests/test_public_api.py"
      provides: "API endpoint tests for public routes"
  key_links:
    - from: "src/api/v1/public.py"
      to: "src/services/public_metrics_service.py"
      via: "PublicMetricsService instantiation"
      pattern: "PublicMetricsService"
    - from: "src/main.py"
      to: "src/api/v1/public.py"
      via: "include_router registration"
      pattern: "public\\.router"
    - from: "src/services/public_metrics_service.py"
      to: "src/models/ticket.py"
      via: "SQLAlchemy queries with is_sensitive filter"
      pattern: "Ticket\\.is_sensitive == False"
---

<objective>
Create the public metrics backend: a cross-tenant aggregation service and unauthenticated API endpoints for the public transparency dashboard.

Purpose: Enable TRNS-01 (response times), TRNS-02 (resolution rates), TRNS-03 (heatmap data), TRNS-04 (no login required), and TRNS-05 (GBV exclusion) at the API layer. This is the data foundation that the frontend will consume.

Output: PublicMetricsService with cross-tenant queries, public API router at /api/v1/public/*, unit tests, API tests.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-public-transparency-rollout/06-RESEARCH.md

# Key source files to understand existing patterns
@src/services/dashboard_service.py
@src/api/v1/dashboard.py
@src/api/deps.py
@src/models/ticket.py
@src/models/municipality.py
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PublicMetricsService with cross-tenant aggregation and GBV firewall</name>
  <files>src/services/public_metrics_service.py, tests/test_public_metrics_service.py</files>
  <action>
Create `src/services/public_metrics_service.py` following the pattern from `src/services/dashboard_service.py` but with these critical differences:

1. **No tenant_id filter** — queries aggregate across ALL active municipalities (cross-tenant).
2. **Mandatory is_sensitive == False** — EVERY query must include `Ticket.is_sensitive == False` in the WHERE clause. This is the GBV firewall for public data (TRNS-05).
3. **Join Municipality** — JOIN Ticket with Municipality on `Ticket.tenant_id == Municipality.id` and filter `Municipality.is_active == True`.

Implement these methods:

**`get_active_municipalities(db)`**
- Return list of active municipalities: `{"id": str, "name": str, "code": str, "province": str}`
- NO contact_email (privacy). NO internal IDs beyond municipality id.

**`get_response_times(db, municipality_id=None)`** (TRNS-01)
- Return average response time (hours) per municipality.
- Calculate: `AVG(EXTRACT(EPOCH FROM first_responded_at - created_at) / 3600)` for tickets where `first_responded_at IS NOT NULL`.
- If `municipality_id` provided, filter to that municipality only.
- Return: list of `{"municipality_id": str, "municipality_name": str, "avg_response_hours": float, "ticket_count": int}`
- Filter: `is_sensitive == False`, `Municipality.is_active == True`.

**`get_resolution_rates(db, municipality_id=None, months=6)`** (TRNS-02)
- Return resolution rate per municipality with monthly trend data.
- Resolution rate = resolved+closed / total * 100 (excluding sensitive).
- Monthly trends: group by `DATE_TRUNC('month', Ticket.created_at)` for last N months.
- Return: `{"municipality_id": str, "municipality_name": str, "resolution_rate": float, "total_tickets": int, "resolved_tickets": int, "trend": [{"month": str, "rate": float}]}`
- Filter: `is_sensitive == False`, `Municipality.is_active == True`.

**`get_heatmap_data(db, municipality_id=None)`** (TRNS-03)
- Use PostGIS `ST_SnapToGrid(Ticket.location, 0.01, 0.01)` for ~1km grid cells.
- Extract grid center with `ST_X()` and `ST_Y()`.
- HAVING `COUNT(*) >= 3` (k-anonymity: suppress cells with <3 tickets).
- Limit to 1000 grid cells, ordered by intensity DESC.
- Filter: `is_sensitive == False`, `Ticket.location IS NOT NULL`, `Municipality.is_active == True`.
- Return: list of `{"lat": float, "lng": float, "intensity": int}`
- **Important:** For SQLite test compatibility, detect USE_POSTGIS and return empty list when PostGIS unavailable (like existing Ticket model pattern). Add a clear comment explaining this.

**`get_system_summary(db)`**
- Return system-wide summary with GBV count at system level ONLY (never per-municipality per pitfall 1 in research).
- Return: `{"total_municipalities": int, "total_tickets": int, "total_sensitive_tickets": int}`
- The sensitive count is a separate query counting `is_sensitive == True` across all municipalities (system-wide aggregate only).

Write TDD-style tests in `tests/test_public_metrics_service.py`:
- RED: Write tests first using AsyncMock for db session (follow `tests/test_dashboard_service.py` pattern).
- Test `get_response_times` returns correct avg hours from mock query results.
- Test `get_resolution_rates` returns correct percentages from mock results.
- Test `get_heatmap_data` returns empty list when USE_POSTGIS is False.
- Test `get_system_summary` returns system-wide counts.
- Test that ALL methods include `is_sensitive == False` in conditions (inspect query construction or mock verification).
- Test `get_active_municipalities` returns only name/code/province (no contact_email).
- GREEN: Implement service to make tests pass.
  </action>
  <verify>
Run: `python -m pytest tests/test_public_metrics_service.py -v`
All tests pass. Verify `is_sensitive == False` appears in every query method via code inspection.
  </verify>
  <done>
PublicMetricsService has 5 methods (get_active_municipalities, get_response_times, get_resolution_rates, get_heatmap_data, get_system_summary). All methods filter is_sensitive == False at SQL level. Heatmap uses ST_SnapToGrid with k-anonymity threshold of 3. Sensitive ticket counts are system-wide only. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create public API endpoints and register router</name>
  <files>src/api/v1/public.py, src/main.py, tests/test_public_api.py</files>
  <action>
Create `src/api/v1/public.py` with a public APIRouter:

```python
router = APIRouter(prefix="/public", tags=["public"])
```

**Critical: NO `Depends(get_current_user)` on ANY endpoint.** These are unauthenticated public routes (TRNS-04). Only use `Depends(get_db)` for database access.

Implement these endpoints:

**GET /api/v1/public/municipalities**
- Call `PublicMetricsService().get_active_municipalities(db)`
- Return list of active municipalities with basic info only.

**GET /api/v1/public/response-times**
- Query param: `municipality_id: str | None = None`
- Call `PublicMetricsService().get_response_times(db, municipality_id)`
- Return average response times per municipality (TRNS-01).

**GET /api/v1/public/resolution-rates**
- Query params: `municipality_id: str | None = None`, `months: int = 6`
- Call `PublicMetricsService().get_resolution_rates(db, municipality_id, months)`
- Return resolution rates with trend data (TRNS-02).

**GET /api/v1/public/heatmap**
- Query param: `municipality_id: str | None = None`
- Call `PublicMetricsService().get_heatmap_data(db, municipality_id)`
- Return grid-aggregated heatmap points (TRNS-03).

**GET /api/v1/public/summary**
- Call `PublicMetricsService().get_system_summary(db)`
- Return system-wide summary including sensitive ticket count at system level only.

**Register the router in `src/main.py`:**
- Add `from src.api.v1 import public` to imports (alongside existing dashboard, events, export).
- Add `app.include_router(public.router, prefix="/api/v1")` after the export router line.

Write tests in `tests/test_public_api.py`:
- Use `httpx.AsyncClient` with `ASGITransport(app=app)` pattern (follow existing API test patterns).
- Test that all public endpoints return 200 WITHOUT any Authorization header.
- Test that response shapes match expected contracts.
- Test that municipality_id query param filters correctly.
- Mock `PublicMetricsService` methods to avoid database dependency.
- Test GBV exclusion: verify service is called with correct parameters (no sensitive data in responses).
  </action>
  <verify>
Run: `python -m pytest tests/test_public_api.py -v`
All tests pass. Verify all endpoints accessible without auth token (no 401/403 responses).
Run: `python -m pytest tests/ -v --tb=short` to verify no regressions.
  </verify>
  <done>
Five public API endpoints at /api/v1/public/* (municipalities, response-times, resolution-rates, heatmap, summary). All accessible without authentication. Router registered in main.py. API tests pass. No regressions in existing test suite.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_public_metrics_service.py tests/test_public_api.py -v` -- all pass
2. `python -m pytest tests/ -v --tb=short` -- full suite passes, no regressions
3. Code inspection: every query in public_metrics_service.py includes `is_sensitive == False`
4. Code inspection: no `get_current_user` dependency in public.py endpoints
5. Sensitive ticket count returned at system level only (never per-municipality)
</verification>

<success_criteria>
- PublicMetricsService has 5 methods, all with is_sensitive == False SQL filter
- Public API has 5 endpoints, all accessible without authentication
- Heatmap data uses grid aggregation with k-anonymity threshold
- No GBV/sensitive data leaks in any public response
- All new tests pass, no regressions in existing 310 tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-public-transparency-rollout/06-01-SUMMARY.md`
</output>
