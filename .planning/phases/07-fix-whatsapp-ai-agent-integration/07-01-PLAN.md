---
phase: 07-fix-whatsapp-ai-agent-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/v1/messages.py
  - src/api/v1/reports.py
  - src/services/whatsapp_service.py
  - src/api/v1/whatsapp.py
autonomous: true
requirements:
  - RPT-01

must_haves:
  truths:
    - "messages.py calls ManagerCrew.kickoff() directly (not IntakeFlow with wrong kwarg)"
    - "reports.py calls ManagerCrew.kickoff() for AI classification (not removed receive_message/classify_message)"
    - "whatsapp_service.py calls ManagerCrew.kickoff() directly (not IntakeFlow with wrong kwarg)"
    - "WhatsApp session_id is stable per phone number (not per MessageSid)"
    - "All three endpoints extract response from ManagerCrew result dict correctly"
    - "sanitize_reply() is used on agent output before returning to citizen"
  artifacts:
    - path: "src/api/v1/messages.py"
      provides: "Fixed message endpoint using ManagerCrew directly"
      contains: "ManagerCrew"
    - path: "src/api/v1/reports.py"
      provides: "Fixed report endpoint using ManagerCrew for classification"
      contains: "ManagerCrew"
    - path: "src/services/whatsapp_service.py"
      provides: "Fixed WhatsApp service using ManagerCrew directly"
      contains: "ManagerCrew"
    - path: "src/api/v1/whatsapp.py"
      provides: "Fixed stable session_id per phone number"
      contains: "wa-"
  key_links:
    - from: "src/api/v1/messages.py"
      to: "src/agents/crews/manager_crew.py"
      via: "await manager_crew.kickoff(context)"
      pattern: "await manager_crew\\.kickoff"
    - from: "src/api/v1/reports.py"
      to: "src/agents/crews/manager_crew.py"
      via: "await manager_crew.kickoff(context) for classification"
      pattern: "await manager_crew\\.kickoff"
    - from: "src/services/whatsapp_service.py"
      to: "src/agents/crews/manager_crew.py"
      via: "await manager_crew.kickoff(context)"
      pattern: "await manager_crew\\.kickoff"
    - from: "src/api/v1/whatsapp.py"
      to: "src/services/whatsapp_service.py"
      via: "stable phone-based session_id"
      pattern: 'session_id = f"wa-'
---

<objective>
Fix three broken API call sites that reference removed IntakeFlow methods and wrong constructor kwargs. Replace IntakeFlow usage with direct ManagerCrew.kickoff() calls (matching the working crew_server.py reference pattern). Fix WhatsApp session_id to be stable per phone number instead of per-message.

Purpose: Citizen messages sent via WhatsApp webhook (messages.py), web portal (reports.py), and Twilio webhook (whatsapp_service.py/whatsapp.py) currently crash at runtime due to Phase 6.9 refactor that changed IntakeFlow's API. These are the core intake paths — without this fix, no citizen can report issues.

Output: All three intake paths route through ManagerCrew correctly, extracting responses from the result dict and sanitizing output before returning to citizens.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-fix-whatsapp-ai-agent-integration/07-CONTEXT.md
@.planning/phases/07-fix-whatsapp-ai-agent-integration/07-RESEARCH.md

Key reference files:
@src/api/v1/crew_server.py (REFERENCE IMPLEMENTATION — correct ManagerCrew usage pattern)
@src/agents/crews/manager_crew.py (ManagerCrew.kickoff() is async, returns dict with "message", "routing_phase", "tracking_number", "agent", "raw_output")
@src/agents/flows/intake_flow.py (IntakeFlow — being REPLACED, not fixed)
@src/agents/flows/state.py (IntakeState — still used for state fields reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix messages.py — replace IntakeFlow with direct ManagerCrew.kickoff()</name>
  <files>src/api/v1/messages.py</files>
  <action>
Replace the IntakeFlow usage in `send_message()` with direct ManagerCrew.kickoff() call, matching the crew_server.py reference pattern. This is the recommended approach from RESEARCH.md (Option A) — bypasses IntakeFlow entirely, eliminating the async/sync boundary issue.

Specific changes:

1. **Remove import** of `IntakeFlow` and `IntakeState` (lines 18-19). Add imports:
   ```python
   from src.agents.crews.manager_crew import ManagerCrew
   from src.api.v1.crew_server import sanitize_reply, _format_history
   ```

2. **Replace lines 168-214** (Step 3 and Step 4 — IntakeFlow creation and kickoff) with:
   - Build a conversation_history string from `conversation_state.turns` using `_format_history()`
   - Create `ManagerCrew(language=conversation_state.language)`
   - Call `agent_result = await manager_crew.kickoff({...})` with the same context dict that crew_server.py uses:
     - `message`: `input_result.sanitized_message`
     - `user_id`: `str(current_user.id)`
     - `tenant_id`: `str(tenant_id)`
     - `language`: `conversation_state.language`
     - `phone`: `getattr(current_user, "phone", "")`
     - `session_status`: `"active"` (user is already authenticated to reach this endpoint)
     - `user_exists`: `"True"`
     - `conversation_history`: formatted history string
     - `pending_intent`: `"none"`
   - Extract results from ManagerCrew result dict:
     - `agent_response = agent_result.get("message", "Your report is being processed.")`
     - `tracking_number = agent_result.get("tracking_number")`
     - `detected_language = conversation_state.language`
     - `category = agent_result.get("routing_phase", "other")`
     - `is_complete = True`
     - `ticket_id = None` (ManagerCrew handles ticket creation internally via tools)
   - Apply sanitize_reply() to agent_response before output guardrails:
     `agent_response = sanitize_reply(agent_response, agent_name=agent_result.get("agent", "manager"), language=detected_language)`

3. **Update the error handler** (try/except around the crew call) to use the same English-only error fallback per user decision:
   ```python
   except Exception as e:
       logger.error(f"ManagerCrew execution failed: {e}", exc_info=True)
       agent_response = "I'm sorry, something went wrong processing your message. Please try again in a few minutes."
       detected_language = conversation_state.language
       category = None
       is_complete = False
       ticket_id = None
       tracking_number = None
   ```

4. **Update line 243** (tracking_number in response) to use the extracted tracking_number variable instead of hardcoded `None`.

Keep the existing guardrails (Step 1), session management (Step 2), output sanitization (Step 5), conversation state saving (Step 6), and response building (Step 7) unchanged. Only the IntakeFlow call in Steps 3-4 changes.
  </action>
  <verify>
Run: `python -c "from src.api.v1.messages import router; print('messages.py imports OK')"` — no ImportError.
Run: `grep -c "ManagerCrew" src/api/v1/messages.py` — returns >= 1.
Run: `grep -c "IntakeFlow" src/api/v1/messages.py` — returns 0.
Run: `grep -c "llm_model" src/api/v1/messages.py` — returns 0.
  </verify>
  <done>messages.py imports ManagerCrew (not IntakeFlow), calls await manager_crew.kickoff() with correct context dict, extracts response from result dict, applies sanitize_reply(), no references to llm_model or IntakeFlow remain.</done>
</task>

<task type="auto">
  <name>Task 2: Fix reports.py and whatsapp_service.py + whatsapp.py session_id</name>
  <files>src/api/v1/reports.py, src/services/whatsapp_service.py, src/api/v1/whatsapp.py</files>
  <action>
Fix the remaining two broken call sites and the session_id stability bug.

**A. Fix `src/api/v1/reports.py` — replace removed IntakeFlow methods with ManagerCrew.kickoff():**

1. **Remove import** of `IntakeFlow` and `IntakeState` (lines 18-19). Add import:
   ```python
   from src.agents.crews.manager_crew import ManagerCrew
   ```

2. **Replace lines 80-100** (the `if category is None:` AI classification block). The new block should:
   - Create `ManagerCrew(language=report.language or "en")`
   - Call `agent_result = await manager_crew.kickoff({...})` with context:
     - `message`: `sanitized_description`
     - `user_id`: `str(current_user.id)`
     - `tenant_id`: `str(current_user.tenant_id)`
     - `language`: `report.language or "en"`
     - `phone`: `""`
     - `session_status`: `"active"`
     - `user_exists`: `"True"`
     - `conversation_history`: `"(none)"` (single-shot classification, no history)
     - `pending_intent`: `"none"`
   - Map the routing_phase to a category:
     ```python
     routing_phase = agent_result.get("routing_phase", "other")
     _PHASE_TO_CATEGORY = {"municipal": "other", "gbv": "gbv", "auth": "other", "manager": "other", "ticket_status": "other"}
     category = _PHASE_TO_CATEGORY.get(routing_phase, "other")
     ```
   - Keep the existing except clause that falls back to `category = "other"` on failure

**B. Fix `src/services/whatsapp_service.py` — replace IntakeFlow with direct ManagerCrew.kickoff():**

1. **Remove import** of `IntakeFlow` and `IntakeState` (lines 18-19). Add imports:
   ```python
   from src.agents.crews.manager_crew import ManagerCrew
   from src.api.v1.crew_server import sanitize_reply, _format_history
   ```

2. **Replace lines 268-308** (Step 5 IntakeFlow creation through Step 6 kickoff and response extraction) with:
   - Build conversation_history from `conversation_state.turns` using `_format_history()`
   - Create `ManagerCrew(language=conversation_state.language)`
   - Call `agent_result = await manager_crew.kickoff({...})` with context:
     - `message`: `input_result.sanitized_message`
     - `user_id`: `user_id`
     - `tenant_id`: `tenant_id`
     - `language`: `conversation_state.language`
     - `phone`: `user.phone or ""`
     - `session_status`: `"active"`
     - `user_exists`: `"True"`
     - `conversation_history`: formatted history
     - `pending_intent`: `"none"`
   - Extract results from ManagerCrew dict:
     ```python
     tracking_number = agent_result.get("tracking_number")
     agent_response = agent_result.get("message", "Your report is being processed.")
     agent_response = sanitize_reply(agent_response, agent_name=agent_result.get("agent", "manager"), language=conversation_state.language)
     detected_language = conversation_state.language
     category = agent_result.get("routing_phase", "other")
     is_complete = True
     ticket_id = None  # Ticket created internally by ManagerCrew tools
     ```
   - Keep the media linking block (Step 7) but note ticket_id will be None — media linking via this path requires the tracking_number approach. For now, skip media linking if ticket_id is None (the ManagerCrew's create_municipal_ticket tool creates the ticket and media can be linked later). Add a TODO comment for Phase 8.
   - Keep existing error handler with the English-only apology per user decision

3. **Remove the `IntakeState` usage** (lines 269-277) — no longer needed since we pass context dict directly.

**C. Fix `src/api/v1/whatsapp.py` — stable session_id per phone number:**

1. **Replace line 188** (`session_id = f"wa-{payload.MessageSid}"`) with:
   ```python
   # Stable session per phone number (not per message) — supports multi-turn state
   normalized_phone = sender_phone.replace("whatsapp:", "").strip()
   session_id = f"wa-{normalized_phone}"
   ```
   This ensures GBV confirmation state and multi-turn conversations persist across message turns.

For all three files, ensure no references to `IntakeFlow`, `IntakeState`, `llm_model`, `receive_message()`, or `classify_message()` remain.
  </action>
  <verify>
Run: `python -c "from src.api.v1.reports import router; print('reports.py imports OK')"` — no ImportError.
Run: `python -c "from src.services.whatsapp_service import WhatsAppService; print('whatsapp_service.py imports OK')"` — no ImportError.
Run: `grep -c "IntakeFlow" src/api/v1/reports.py src/services/whatsapp_service.py` — returns 0 for both.
Run: `grep -c "llm_model" src/api/v1/reports.py src/services/whatsapp_service.py` — returns 0 for both.
Run: `grep -c "receive_message\|classify_message" src/api/v1/reports.py` — returns 0.
Run: `grep "session_id.*wa-" src/api/v1/whatsapp.py` — shows phone-based session_id pattern.
Run: `pytest tests/test_messages_api.py tests/test_reports_api.py -x --no-header -q 2>&1 | tail -5` — check for obvious import errors (tests may need mocking updates in Plan 02).
  </verify>
  <done>reports.py uses ManagerCrew.kickoff() for AI classification (no receive_message/classify_message). whatsapp_service.py uses ManagerCrew.kickoff() directly (no IntakeFlow). whatsapp.py uses stable phone-based session_id. No references to IntakeFlow, llm_model, or removed methods in any file.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rn "llm_model" src/api/ src/services/` — should return 0 matches in the fixed files
2. `grep -rn "receive_message\|classify_message" src/api/ src/services/` — should return 0 matches
3. `grep -rn "IntakeFlow" src/api/v1/messages.py src/api/v1/reports.py src/services/whatsapp_service.py` — should return 0
4. `python -c "from src.api.v1.messages import router; from src.api.v1.reports import router; from src.services.whatsapp_service import WhatsAppService; print('All imports OK')"` — no errors
5. All three endpoints use `await manager_crew.kickoff()` matching crew_server.py pattern
</verification>

<success_criteria>
- All three broken call sites (messages.py, reports.py, whatsapp_service.py) call ManagerCrew.kickoff() directly
- No references to IntakeFlow, llm_model, receive_message(), or classify_message() in any fixed file
- WhatsApp session_id uses phone-based stability (wa-{phone}) not per-message (wa-{MessageSid})
- Response extraction reads from ManagerCrew result dict ("message", "tracking_number", "routing_phase")
- sanitize_reply() applied to agent output in messages.py and whatsapp_service.py
- Error handling returns English-only apology per user MVP decision
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-whatsapp-ai-agent-integration/07-01-SUMMARY.md`
</output>
