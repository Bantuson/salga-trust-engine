---
phase: 06.8-gugu-persona-email-otp-fix
plan: "02"
subsystem: api
tags: [language-detection, lingua-py, crew-server, supabase, email-otp, auth]

# Dependency graph
requires:
  - phase: 06.8-01
    provides: Gugu persona backstories in auth, municipal, and GBV crews
  - phase: 06.7-04
    provides: crew_server.py FastAPI app with /chat endpoint and AuthCrew integration
provides:
  - Language auto-detection on every /chat request using lingua-py singleton
  - detected_language passed to IntakeState, AuthCrew, auth_context, and sanitize_reply
  - Supabase email OTP template change instructions (human action required)
  - SMS OTP evaluation instructions (human action required)
affects: [06.8-03, crew_server, streamlit_dashboard]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "language_detector singleton imported from src.core.language (no per-request instantiation)"
    - "Detected language overrides dashboard language hint; request.language kept as fallback only"
    - "Short text (<20 chars) or low confidence (<0.7) falls back to request.language"

key-files:
  created: []
  modified:
    - src/api/v1/crew_server.py

key-decisions:
  - "Use language_detector singleton (not new LanguageDetector() per request) — prevents model rebuild overhead"
  - "detected_language replaces request.language in all downstream crew constructors and contexts"
  - "request.language kept as fallback parameter to detect() — dashboard hint used when detection is unreliable"
  - "Non-GBV debug output includes both language (hint) and detected_language for Streamlit observability"
  - "Supabase email OTP template change requires manual Dashboard action — cannot be automated via CLI"

patterns-established:
  - "Step 1.5 pattern: language detection inserted between session detection (Step 1) and conversation history (Step 2)"
  - "detected_language flows through entire request lifecycle: session, state, crew, context, sanitization"

requirements-completed:
  - AI-06
  - AI-07

# Metrics
duration: partial (Task 1 complete; Task 2 pending human action)
completed: 2026-02-17
---

# Phase 6.8 Plan 02: Language Auto-Detection & Email OTP Fix Summary

**Language auto-detection added to /chat endpoint using lingua-py singleton — citizen messages now drive crew language instead of static dashboard hint; Supabase email OTP template change pending manual Dashboard configuration.**

## Performance

- **Duration:** ~8 min (Task 1 only; Task 2 is human-action checkpoint)
- **Started:** 2026-02-17T15:06:07Z
- **Completed:** 2026-02-17 (Task 1 committed; Task 2 awaiting user)
- **Tasks:** 1/2 complete (Task 2 is a human-action checkpoint — requires Supabase Dashboard)
- **Files modified:** 1

## Accomplishments

- Added `language_detector.detect(request.message, fallback=request.language)` as Step 1.5 in the `/chat` endpoint, before agent routing
- Replaced all downstream `request.language` usages with `detected_language` in `IntakeState`, `AuthCrew`, `auth_context`, `create_session`, and `sanitize_reply`
- Added `detected_language` to non-GBV debug output alongside original `language` hint for Streamlit observability
- Confirmed import works cleanly: `python -c "from src.api.v1.crew_server import crew_app; print('Import OK')"` passes

## Task Commits

Each task was committed atomically:

1. **Task 1: Add language auto-detection to crew_server.py /chat endpoint** - `8f4e875` (feat)
2. **Task 2: Configure Supabase Dashboard — email OTP template fix and SMS OTP evaluation** - `PENDING` (human-action checkpoint)

**Plan metadata:** `TBD` (docs: complete plan — created after Task 2 completion)

## Files Created/Modified

- `src/api/v1/crew_server.py` - Added Step 1.5 language detection; replaced request.language with detected_language in all downstream usages; added detected_language to debug output

## Decisions Made

- Use `language_detector` singleton import from `src.core.language` (not `LanguageDetector` class) — avoids per-request ML model instantiation (heavy operation per research anti-pattern)
- `request.language` retained as the `fallback=` parameter in `detect()` call — static dashboard hint used when text is too short or confidence is low
- Debug dict retains both `"language": request.language` (original hint) and `"detected_language": detected_language` (actual detection result) for Streamlit debugging
- Email OTP template fix requires Supabase Dashboard manual change — `{{ .ConfirmationURL }}` replaced with `{{ .Token }}` display

## Deviations from Plan

None — Task 1 executed exactly as specified. Task 2 is a human-action checkpoint by design.

## User Setup Required

**Task 2 requires manual Supabase Dashboard configuration:**

### PART A: Email OTP Template Fix (REQUIRED)

1. Open the Supabase Dashboard for the project
2. Navigate to: **Authentication -> Email Templates -> Magic Link**
3. Replace the email template body with:

```html
<h2>Your SALGA Verification Code</h2>
<p>Your verification code is:</p>
<h1 style="letter-spacing: 0.3em; font-size: 32px;">{{ .Token }}</h1>
<p>Enter this 6-digit code in the app to verify your identity.</p>
<p>This code expires in 60 minutes. If you did not request this code, please ignore this email.</p>
```

4. Save the template
5. Verify by triggering a test OTP send — email should contain a 6-digit code, NOT a clickable magic link

### PART B: SMS OTP Evaluation (EVALUATE ONLY)

1. Navigate to: **Authentication -> Providers -> Phone**
2. If a Twilio account is available with a plain SMS-capable number (NOT the WhatsApp sandbox):
   - Enable Phone provider, set SMS Provider to "Twilio"
   - Enter Account SID, Auth Token, and SMS phone number
   - Save and test with a phone OTP send
3. If no dedicated SMS number is available: defer — document as "SMS OTP deferred — no dedicated Twilio SMS number"

### Resume Signal

After completing the above, provide:
- `"Email OTP fixed"` or describe issue encountered
- `"SMS OTP enabled"` or `"SMS OTP deferred — [reason]"`

## Next Phase Readiness

- Language auto-detection is live on every `/chat` request — citizens typing in isiZulu or Afrikaans will now receive responses in their language
- Supabase email OTP template change is required before email auth flows work correctly (magic link sends 6-digit code after fix)
- Once Task 2 is confirmed, Plan 02 is complete and Plan 03 (response sanitization) can proceed

---

## Self-Check

**Task 1 verification:**
- [x] `from src.core.language import language_detector` — line 54 in crew_server.py
- [x] `language_detector.detect(request.message, fallback=request.language)` — line 580
- [x] `detected_language` in `create_session` (line 603), `IntakeState` (line 644), `AuthCrew` (line 686), `auth_context` (line 689), `sanitize_reply` (line 729)
- [x] Debug dict includes `"detected_language": detected_language` (line 777)
- [x] Import check: `python -c "from src.api.v1.crew_server import crew_app; print('Import OK')"` — passed
- [x] Commit exists: `8f4e875` confirmed in git log

## Self-Check: PASSED

---
*Phase: 06.8-gugu-persona-email-otp-fix*
*Completed: 2026-02-17*
