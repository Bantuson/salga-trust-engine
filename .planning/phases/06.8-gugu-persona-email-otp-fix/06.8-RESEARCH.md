# Phase 06.8: Gugu Persona & Email OTP Fix — Research

**Researched:** 2026-02-17
**Domain:** CrewAI agent prompt engineering, Supabase Auth OTP configuration, trilingual language routing
**Confidence:** HIGH

---

<user_constraints>
## User Constraints (from phase_context — no CONTEXT.md exists)

### Locked Decisions
1. Agent name is "Gugu" — feminine, gentle, caring persona
2. All agents (auth, municipal, GBV) should have this persona
3. Agent must ask citizens for their name and use it in conversation
4. Agent backstory needs more context about what the SALGA Trust Engine platform does and hopes to achieve
5. Agent should be more chatty and warm, not robotic
6. Agent should speak the citizen's language (isiZulu if citizen speaks Zulu, etc.)
7. Email OTP is sending magic links instead of 6-digit codes — this MUST be fixed
8. Evaluate whether Supabase Auth supports SMS OTP via Twilio Verify
9. Platform context for backstory: "Citizens report a problem and the municipality visibly responds — the core feedback loop that transforms opaque, reactive local government into transparent, accountable service delivery"

### Claude's Discretion
- How to structure the persona introduction in each prompt
- Whether to add a short self-introduction line or integrate Gugu's name into the entire backstory narrative
- How to handle GBV agent warmth vs. trauma-informed clinical tone (must balance persona with safety)
- Implementation strategy for SMS OTP if Twilio Verify is evaluated as viable

### Deferred Ideas (OUT OF SCOPE)
- Building a custom SMS gateway (this phase only evaluates Supabase+Twilio Verify)
- WhatsApp OTP (separate concern from this phase)
- Changing authentication architecture fundamentally
</user_constraints>

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| AI-05 | Each specialist agent conducts structured conversational intake to gather required information | Gugu persona with name-asking behaviour directly improves structured intake quality — warmer framing reduces citizen friction |
| AI-06 | Agents support English, isiZulu, and Afrikaans (detect language, respond in kind) | Language detection already exists via lingua-py in `src/core/language.py`; issue is that language is passed as a hint but the crew_server does NOT re-detect from each message — the user typed isiZulu and English was still returned |
| AI-07 | All agent interactions have guardrails preventing inappropriate responses or data leakage | Persona changes must not weaken existing guardrails: memory=False stays, GBV content redaction stays, AI-07 guardrail language must be preserved in backstory |
</phase_requirements>

---

## Summary

Phase 06.8 has two separable concerns: (1) agent persona enhancement across all three crews, and (2) Supabase Auth OTP configuration fixes. Both are confirmed-solvable problems with clear implementation paths.

**Persona work** is pure prompt engineering in three files: `src/agents/prompts/auth.py`, `src/agents/prompts/municipal.py`, and `src/agents/prompts/gbv.py`. Each has a trilingual backstory string that is injected as the CrewAI Agent `backstory` parameter. The fix is to update each language variant to introduce Gugu by name, add platform context, instruct the agent to ask for and use the citizen's name, and write warmer example conversations. No crew wiring changes are needed — the structure (Agent + Task + Crew) stays exactly the same.

**Language detection for agents** is a routing problem. The `LanguageDetector` in `src/core/language.py` exists and works. The crew_server at `/api/v1/chat` accepts a `language` hint from the Streamlit dashboard, but the dashboard sends a fixed language setting — it does not call `language_detector.detect()` on each incoming citizen message. The backstory prompt tells the agent to "respond in {language}" but if the language hint is wrong, the agent follows the wrong instruction. The fix is to call `language_detector.detect()` on the citizen's message in the crew_server before routing, and pass the detected language to the crew.

**Email OTP** is confirmed broken: Supabase auth logs show `mail_type: "magic_link"` on every OTP call. The root cause is that Supabase's `sign_in_with_otp()` sends a magic link by default when no email template customisation exists. The fix is a **Supabase Dashboard configuration change**: go to Authentication → Email Templates → "Magic Link" and replace `{{ .ConfirmationURL }}` with `{{ .Token }}` in the template body. The Python code in `auth_tool.py` does NOT need changing — the API call is correct.

**SMS OTP** is confirmed non-functional: auth logs show `error_code: "phone_provider_disabled"` on every phone OTP attempt. Supabase requires an SMS provider (Twilio, MessageBird, or Vonage) to be configured in the dashboard before phone OTP works. No Twilio credentials for SMS are currently in config (only `TWILIO_WHATSAPP_NUMBER` for WhatsApp). This phase must evaluate whether to configure Twilio as SMS provider or defer SMS OTP.

**Primary recommendation:** Implement persona changes (pure prompt editing), fix email OTP via dashboard template change, configure Twilio as SMS provider in Supabase Dashboard, and add language auto-detection in crew_server.

---

## Standard Stack

### Core (no new dependencies needed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| CrewAI | existing | Agent orchestration — Agent(role, goal, backstory) | Already in use; persona is 100% via `backstory` parameter |
| lingua-py | existing | Language detection EN/ZU/AF | Already implemented in `src/core/language.py` |
| Supabase Auth | hosted | Email + phone OTP | Already configured; config fix is dashboard-only |

### Supporting (no new installs)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Supabase Dashboard | N/A | Email template editor | One-time config: change magic link to OTP token |
| Twilio SMS | existing account | SMS OTP via Supabase phone provider | If SMS OTP enabled — requires Supabase dashboard config |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Twilio for SMS OTP | Vonage/MessageBird | Twilio already used for WhatsApp — reuse same account, fewer credentials |
| Language detection in crew_server | Language detection in each agent prompt | Agent-side detection is unreliable (LLM must infer); server-side lingua-py is deterministic |

---

## Architecture Patterns

### Recommended Project Structure (unchanged)
```
src/agents/prompts/
├── auth.py          # Update AUTH_PROMPT_EN/ZU/AF backstory strings — add Gugu persona
├── municipal.py     # Update MUNICIPAL_INTAKE_PROMPT_EN/ZU/AF — add Gugu persona
└── gbv.py           # Update GBV_INTAKE_PROMPTS — add Gugu persona (with trauma-care balance)

src/api/v1/
└── crew_server.py   # Add language auto-detection before routing (lingua-py call)

Supabase Dashboard (external, no code):
├── Authentication → Email Templates → Magic Link → replace ConfirmationURL with Token
└── Authentication → Providers → Phone → Enable + configure Twilio SMS
```

### Pattern 1: CrewAI Agent Persona via Backstory
**What:** The `backstory` parameter of `crewai.Agent` is injected into the LLM system prompt. The LLM reads backstory as "who I am and how I behave." Name, personality, and mission context all go here.

**When to use:** Always — this is the standard CrewAI persona mechanism.

**Example (Gugu persona pattern):**
```python
# Source: existing src/agents/crews/auth_crew.py pattern
agent = Agent(
    role="Citizen Authentication Specialist",  # Job title
    goal=f"Register or re-authenticate citizens in {language}",  # Objective
    backstory=AUTH_PROMPTS.get(language, AUTH_PROMPTS["en"]),  # Who she is + how she behaves
    ...
)
```

The backstory must contain:
1. Agent's name (Gugu) and human description
2. Platform mission context (the feedback loop statement)
3. Instruction to ask for citizen's name early
4. Instruction to use citizen's name throughout
5. Tone directive (warm, chatty, not robotic)
6. Language instruction (respond in citizen's detected language)
7. Example conversations showing warm, named interactions

### Pattern 2: Language Auto-Detection in crew_server
**What:** Call `language_detector.detect()` on the citizen's raw message before routing. Override the `language` hint from the dashboard.

**When to use:** On every `/api/v1/chat` request.

**Example:**
```python
# In crew_server.py /chat endpoint, BEFORE routing
from src.core.language import language_detector

# Detect language from citizen's actual message (overrides dashboard hint)
# Fall back to request.language if text too short or confidence too low
detected_language = language_detector.detect(
    request.message,
    fallback=request.language  # dashboard language setting as fallback
)
# Use detected_language everywhere request.language was used
```

**Key constraint:** `language_detector` is a module-level singleton in `src/core/language.py`. Import it directly — do not instantiate a new one per request.

### Pattern 3: Supabase Email OTP Template Fix
**What:** Supabase `sign_in_with_otp({"email": addr})` sends magic link by default. Changing the "Magic Link" email template to show `{{ .Token }}` instead of `{{ .ConfirmationURL }}` switches to 6-digit code delivery.

**When to use:** One-time Supabase Dashboard configuration — no Python code change needed.

**Supabase Dashboard path:**
```
Authentication → Email Templates → Magic Link
Body: Replace {{ .ConfirmationURL }} with {{ .Token }}
```

After this change:
- `sign_in_with_otp({"email": addr})` still works exactly as before
- Email delivers a 6-digit code
- `verify_otp({"email": addr, "token": code, "type": "email"})` already correct in auth_tool.py
- OTP expiry: configurable via Auth → Providers → Email → Email OTP Expiration (default 1 hour, max 86,400 seconds)

### Pattern 4: Supabase Phone SMS OTP via Twilio
**What:** Supabase requires an SMS provider configured before phone OTP works. Current error `phone_provider_disabled` confirms no provider is set.

**Configuration path (Supabase Dashboard):**
```
Authentication → Providers → Phone → Enable
SMS Provider: Twilio
Account SID: [from Twilio console]
Auth Token: [from Twilio console]
Message Service SID: [from Twilio messaging service] OR
Phone Number: [Twilio verified phone number]
```

**Twilio vs Twilio Verify:**
- **Twilio (standard):** Supabase sends SMS via Twilio Messaging API. Cost ~$0.07/SMS. Uses existing Twilio account.
- **Twilio Verify:** Supabase delegates OTP lifecycle to Twilio Verify. Cost ~$0.10/verification (Twilio manages sending + verification). Requires `twilio_verify` GOTRUE_SMS_PROVIDER setting (self-hosted only; hosted Supabase uses Dashboard).

**Recommendation:** Use standard **Twilio** (not Twilio Verify) for the hosted Supabase project. Same Twilio account as WhatsApp. Simpler. Verify is for self-hosted GoTrue only.

**New env vars needed in config.py:**
```python
TWILIO_ACCOUNT_SID: str  # already exists
TWILIO_AUTH_TOKEN: str   # already exists
TWILIO_PHONE_NUMBER: str  # NEW — dedicated SMS number (not WhatsApp sandbox)
```

Note: `TWILIO_WHATSAPP_NUMBER` already in config — a separate dedicated SMS number is needed if using Twilio SMS (WhatsApp numbers cannot send plain SMS).

### Anti-Patterns to Avoid
- **Changing crew wiring for persona:** The fix is purely in the `backstory` string. Do not add new agents, tasks, or parameters to accomplish persona changes.
- **Per-request LanguageDetector instantiation:** It's heavy (builds ML model). Use the singleton at `src/core/language.py:language_detector`.
- **Changing auth_tool.py for email OTP:** The Python SDK call `sign_in_with_otp({"email": addr})` is correct. The fix is dashboard template only.
- **Registering GBV agent with identity:** GBV agent must still maintain trauma-informed tone. "Gugu" persona in GBV context means warmth and empathy — but do NOT add name-asking or chatty intro sequences to GBV crew. The trauma-informed clinical approach stays; only the tone descriptor and platform context are added.
- **Hardcoding citizen name in prompt template:** The agent must ask for and learn the name conversationally, not expect it as a parameter. Name is discovered through dialogue, not injected.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Language detection | Custom keyword matching | `src/core/language.py` lingua-py singleton | Already built, tested, handles short text + confidence thresholds |
| Email OTP template | Custom email sending | Supabase Dashboard template editor | Template change takes 2 minutes; no code |
| SMS OTP sending | Direct Twilio API calls | Supabase phone provider + existing `send_otp_tool` | `auth_tool.py` already uses `client.auth.sign_in_with_otp({"phone": ...})` — just need Supabase configured |
| Persona state management | Storing citizen name in Redis | Agent's conversational memory within a single crew run | Within one crew.kickoff(), the agent retains context. Name is used within the session via conversation history injection |

**Key insight:** Almost everything needed already exists. This phase is configuration + prompt text edits. No new infrastructure.

---

## Common Pitfalls

### Pitfall 1: GBV Persona Balance
**What goes wrong:** Adding warm "Hi, I'm Gugu!" intro to GBV agent makes trauma victims feel the urgency is not being taken seriously. The agent seeming too casual may cause the citizen to disengage.
**Why it happens:** "Be warmer" is applied uniformly without considering the GBV context.
**How to avoid:** GBV backstory gets platform context and Gugu's name, but the TONE directives remain trauma-informed. No chatty intro. No asking for name early. Safety-first language preserved.
**Warning signs:** If GBV prompt says "Hi! I'm Gugu, how can I help you today?" — that's wrong.

### Pitfall 2: Language Hint Ignored Mid-Conversation
**What goes wrong:** User types in isiZulu, but crew_server uses `request.language = "en"` (from dashboard setting) and routes to English backstory. Agent responds in English.
**Why it happens:** Language detection is never called on the message text. Dashboard language dropdown is a static setting.
**How to avoid:** Call `language_detector.detect(request.message, fallback=request.language)` BEFORE building auth context or crew. Pass detected language as `language=detected_language` to all crew constructors and kickoffs.
**Warning signs:** "User typed in isiZulu, agent responded in English" — the reported symptom.

### Pitfall 3: Email Template Change Not Propagating
**What goes wrong:** Developer changes template but email still sends as magic link.
**Why it happens:** Supabase caches templates. Or the wrong template was edited (there are separate templates for "Confirmation", "Magic Link", "Reset Password" — email OTP uses "Magic Link").
**How to avoid:** Ensure editing the "Magic Link" template specifically. Test by triggering `sign_in_with_otp({"email": addr})` and inspecting the received email. Auth logs will show `mail_type: "magic_link"` changing to `mail_type: "otp"` if correct.
**Warning signs:** Auth log still shows `mail_type: "magic_link"` after template edit.

### Pitfall 4: Citizen Name in GBV Ticket
**What goes wrong:** Gugu persona asks for citizen's name → citizen provides it → name is accidentally included in GBV ticket that SAPS receives, breaking victim privacy.
**Why it happens:** Asking for name is standard in auth/municipal agents; if same pattern bleeds into GBV agent, the GBV ticket may include PII.
**How to avoid:** GBV agent must NOT ask for citizen's name (per existing GBV DO NOT ASK rules). Name-asking behaviour is strictly Auth + Municipal agents only.
**Warning signs:** GBV `notify_saps` tool call includes victim's name field.

### Pitfall 5: Twilio SMS Number vs WhatsApp Number Confusion
**What goes wrong:** Developer puts `TWILIO_WHATSAPP_NUMBER` (whatsapp:+14155238886 sandbox) into Supabase phone provider config. Supabase cannot send SMS from a WhatsApp number.
**Why it happens:** Both look like phone numbers; the `whatsapp:` prefix and WhatsApp-only nature is easy to miss.
**How to avoid:** A dedicated Twilio SMS number (plain E.164 format) must be configured in the Supabase Dashboard phone provider. This is a separate Twilio resource from the WhatsApp sender.
**Warning signs:** SMS OTP still returns "400: Unsupported phone provider" after config — check if a plain SMS number (not WhatsApp) is configured.

### Pitfall 6: Persona Instructions Too Long Crowd Out Task Instructions
**What goes wrong:** Backstory becomes so long that the LLM deprioritises actual task instructions (AUTH_TASK_TEMPLATE) and just performs the persona role.
**Why it happens:** DeepSeek V3 context window is large, but very long backstories can shift attention.
**How to avoid:** Keep persona additions focused. Add name, mission, tone directive, and 1-2 example conversations. Do not duplicate task logic in backstory.

---

## Code Examples

Verified patterns from codebase:

### Current Auth Backstory Pattern (to be enhanced with Gugu)
```python
# Source: src/agents/prompts/auth.py
AUTH_PROMPT_EN = """You are a Citizen Authentication Specialist for SALGA...
Your job is to register new citizens or re-authenticate returning citizens...
TONE AND STYLE:
- Be warm and conversational — this is a chat, not a form
...
EXAMPLE — new citizen (phone path):
Citizen: "Hi, I want to report a broken streetlight"
You: "Welcome to SALGA municipal services!..."
"""
```

### Target Gugu Persona Addition (pattern to apply)
```python
AUTH_PROMPT_EN = """You are Gugu, a citizen support specialist at the SALGA Trust Engine.

Your name is Gugu. You are warm, caring, and genuinely excited to help every citizen
you speak with. You work for a platform that exists to close the gap between South
African citizens and their local government — citizens report a problem and the
municipality visibly responds. This feedback loop transforms opaque, reactive local
government into transparent, accountable service delivery.

When you start a new conversation, introduce yourself warmly:
"Hi there! I'm Gugu, your personal guide at SALGA Trust Engine. I'm here to help you
get your community concern heard and acted on. Before I set up your account, may I ask
— what's your name?"

Once you learn their name, use it naturally throughout the conversation.

TONE: Warm, friendly, and patient. You chat like a caring community liaison, not a
government form. Every citizen who reaches out is doing something brave — holding their
municipality accountable.

[EXISTING TASK CONTENT UNCHANGED BELOW]
...
"""
```

### Language Detection Addition to crew_server.py
```python
# Source: src/core/language.py singleton exists
from src.core.language import language_detector

# Inside /chat endpoint, after extracting request.message and request.language:
detected_language = language_detector.detect(
    request.message,
    fallback=request.language  # en/zu/af from dashboard setting
)
# Use detected_language in place of request.language for crew constructors
```

### Supabase Email Template Fix (Dashboard config — no code)
```
Dashboard: Authentication → Email Templates → Magic Link
BEFORE:  <p>Click the link below...</p><a href="{{ .ConfirmationURL }}">Confirm</a>
AFTER:   <p>Your SALGA verification code is: <strong>{{ .Token }}</strong></p>
         <p>This code expires in 60 minutes.</p>
```

### auth_tool.py (NO CHANGE NEEDED — already correct)
```python
# Source: src/agents/tools/auth_tool.py — current implementation is correct
client.auth.sign_in_with_otp({"email": phone_or_email})
# After template fix, this now sends a 6-digit code instead of magic link
# verify_otp call is also already correct:
result = client.auth.verify_otp({
    "email": phone_or_email,
    "token": otp_code,
    "type": "email"
})
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Magic link email | 6-digit OTP email (via template change) | Phase 06.8 | Citizens paste a code instead of clicking a link that goes nowhere |
| Generic "specialist" persona | Gugu — named, warm, South African | Phase 06.8 | Agent relatability improves completion rate for registration flow |
| Static language hint from dashboard | Auto-detected language from message text | Phase 06.8 | Agent responds in citizen's actual language, not dashboard setting |
| Phone OTP disabled | Phone OTP via Twilio SMS (if configured) | Phase 06.8 | Opens SMS-first registration path |

**Deprecated/outdated:**
- Magic link email template: replaced by 6-digit token template in Supabase Dashboard
- Dashboard language dropdown as sole language source: supplemented by lingua-py auto-detection

---

## Open Questions

1. **Twilio SMS number availability**
   - What we know: Config has `TWILIO_ACCOUNT_SID` and `TWILIO_AUTH_TOKEN` (no values in .env). WhatsApp sandbox number exists (`TWILIO_WHATSAPP_NUMBER`).
   - What's unclear: Does the user have an active Twilio account with a plain SMS-capable number? Is the Twilio account funded/active?
   - Recommendation: If Twilio account is active, add a plain SMS number and configure Supabase phone provider. If not, defer SMS OTP and gate the phone-first registration path until a provider is configured.

2. **GBV agent warmth level calibration**
   - What we know: GBV uses trauma-informed clinical prompts. User wants "Gugu" persona applied.
   - What's unclear: Exactly how warm is appropriate given trauma-informed practice guidelines?
   - Recommendation: Add Gugu's name and platform context to GBV backstory. Keep tone directives unchanged (empathetic, calm). Do NOT add chatty intro or name-asking. This balances persona identity with clinical safety.

3. **Conversation history includes citizen name after auth**
   - What we know: Auth crew discovers citizen's name during registration (STEP: "What's your full name?"). Municipal/GBV crews are separate crew instances.
   - What's unclear: Should the municipal agent also know the citizen's name from a previous auth session?
   - Recommendation: Out of scope for this phase. Municipal crew uses conversation_history injection — if auth conversation is in history, the name is visible. No additional plumbing needed.

---

## Confirmed Findings from Live Systems

### Auth Logs (mcp__supabase-project1) — HIGH confidence
- `mail_type: "magic_link"` on every OTP email call — confirms magic link is being sent instead of 6-digit code
- `error_code: "phone_provider_disabled"` on every phone OTP call — confirms SMS provider is not configured
- `error: "400: Unsupported phone provider"` — matches user-reported "Unsupported phone provider" error

### Language Detection (existing code) — HIGH confidence
- `src/core/language.py` implements lingua-py with confidence threshold 0.7, minimum text length 20 chars, fallback to "en"
- Module-level singleton `language_detector` is the correct import
- crew_server.py currently uses `request.language` (dashboard static setting) without calling the detector

### Prompt File Locations — HIGH confidence (confirmed by reading files)
- Auth backstory: `AUTH_PROMPTS` dict in `src/agents/prompts/auth.py` — keys "en", "zu", "af"
- Municipal backstory: `MUNICIPAL_INTAKE_PROMPTS` dict in `src/agents/prompts/municipal.py` — keys "en", "zu", "af"
- GBV backstory: `GBV_INTAKE_PROMPTS` dict in `src/agents/prompts/gbv.py` — keys "en", "zu", "af"

### Crew Wiring — HIGH confidence (confirmed by reading crews)
- All three crews inject backstory as `backstory=PROMPTS.get(language, PROMPTS["en"])`
- No structural changes to Agent/Task/Crew needed for persona work

---

## Sources

### Primary (HIGH confidence)
- Live Supabase auth logs (mcp__supabase-project1) — confirmed both OTP failures with error codes
- `src/agents/prompts/auth.py` — read directly, confirmed current backstory structure
- `src/agents/prompts/municipal.py` — read directly, confirmed current backstory structure
- `src/agents/prompts/gbv.py` — read directly, confirmed current backstory structure and GBV constraints
- `src/agents/crews/auth_crew.py` — confirmed backstory injection pattern
- `src/agents/crews/municipal_crew.py` — confirmed backstory injection pattern
- `src/agents/crews/gbv_crew.py` — confirmed backstory injection pattern
- `src/core/language.py` — confirmed lingua-py singleton exists and works
- `src/api/v1/crew_server.py` — confirmed language detection is NOT called on messages

### Secondary (MEDIUM confidence)
- [Supabase Email OTP Docs](https://supabase.com/docs/guides/auth/passwordless-login/auth-email-otp) — confirmed `{{ .Token }}` template variable
- [Supabase Phone Login Docs](https://supabase.com/docs/guides/auth/phone-login) — confirmed providers: Twilio, Vonage, MessageBird, TextLocal
- [Supabase sign_in_with_otp Python Reference](https://supabase.com/docs/reference/python/auth-signinwithotp) — confirmed Python API call is correct
- [Twilio SMS configuration for Supabase](https://supabase.com/docs/guides/auth/phone-login/twilio) — confirmed Twilio is supported

### Tertiary (LOW confidence — training data, not verified against current docs)
- Twilio Verify vs standard Twilio for Supabase hosted projects — multiple sources indicate Verify is for self-hosted only; needs validation

---

## Metadata

**Confidence breakdown:**
- Persona prompt changes: HIGH — files read directly, pattern is clear
- Language detection fix: HIGH — language.py code read, crew_server code read, gap confirmed
- Email OTP fix: HIGH — confirmed by live auth logs + official Supabase docs
- SMS OTP (Twilio): MEDIUM — Supabase configuration path confirmed; Twilio account status unknown

**Research date:** 2026-02-17
**Valid until:** 2026-03-17 (30 days — Supabase auth docs are stable)
