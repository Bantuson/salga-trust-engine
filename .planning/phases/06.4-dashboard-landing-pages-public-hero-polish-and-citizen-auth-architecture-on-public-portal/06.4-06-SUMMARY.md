---
phase: 06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal
plan: 06
subsystem: frontend-public
tags: [citizen-reporting, gbv-safety, proof-of-residence, receipt-card, glassmorphism]

dependency_graph:
  requires:
    - 06.4-04 (citizen auth pages for user session)
    - 06.4-05 (auth-gated routing and useAuth hook)
  provides:
    - citizen_report_form
    - gbv_consent_dialog
    - report_receipt_card
    - proof_of_residence_gate
    - category_based_routing
  affects:
    - future backend API endpoint (POST /api/v1/reports/submit)
    - future profile page (proof of residence upload)
    - future my-reports page (view reports CTA)

tech_stack:
  added:
    - "Simple file upload without react-dropzone (lightweight approach)"
    - "Supabase Storage direct uploads (evidence and gbv-evidence buckets)"
    - "Geolocation API with 10s timeout"
  patterns:
    - "Dual page state pattern (form → receipt)"
    - "Category-triggered modal consent dialog (GBV)"
    - "Inline blocker pattern (proof of residence gate)"
    - "Mock tracking number generation (TKT-YYYYMMDD-XXXXXX format)"
    - "Category-based expected response time mapping"

key_files:
  created:
    - frontend-public/src/components/citizen/GBVConsentDialog.tsx
    - frontend-public/src/components/citizen/ReportReceipt.tsx
  modified:
    - frontend-public/src/pages/ReportIssuePage.tsx

decisions:
  - decision: "No react-dropzone dependency - use simple file input"
    rationale: "react-dropzone is not installed in frontend-public. Simple file input with styled drop zone area is sufficient for MVP and reduces bundle size."
    alternatives: ["Install react-dropzone", "Copy FileUpload component from dashboard"]
    chosen: "Simple file input with manual validation and Supabase Storage upload"

  - decision: "Mock API call for now (TODO comment for backend integration)"
    rationale: "Backend POST /api/v1/reports/submit endpoint doesn't exist yet. Mock submission allows full UI testing while backend is built."
    alternatives: ["Block until backend ready", "Create stub endpoint"]
    chosen: "Mock with TODO comment - unblocks UI development"

  - decision: "Proof of residence gate as inline warning (not hard block)"
    rationale: "Form fields remain visible but submit button is disabled. User can see what they'll need to fill out, making it less frustrating."
    alternatives: ["Completely hide form", "Redirect to profile immediately"]
    chosen: "Show form with inline warning and disabled submit button"

  - decision: "WhatsApp opt-in checkbox on receipt (not during form)"
    rationale: "Per WhatsApp Business Policy, opt-in must be separate checkbox. Receipt is perfect place - user just submitted report, contextually makes sense to opt in to updates."
    alternatives: ["Add checkbox to form", "Auto-enable with opt-out checkbox"]
    chosen: "Separate checkbox on receipt card (clear, compliant, contextual)"

metrics:
  duration_seconds: 634
  duration_minutes: 10.6
  tasks_completed: 2
  files_created: 2
  files_modified: 1
  commits: 2
  completed_at: "2026-02-13T13:13:16Z"
---

# Phase 06.4 Plan 06: Citizen Report Form with GBV Safety and Receipt Card Summary

**One-liner:** Complete citizen report submission flow with category dropdown, GBV consent dialog, proof of residence gate, photo upload, GPS/address capture, and glassmorphic receipt card with tracking number

## Overview

Built the full citizen reporting experience from form to receipt. Citizens can submit municipal service issues via a single scrollable form with all expected features: category selection (including GBV/Abuse with consent dialog), description, photo evidence, location (GPS or manual address), and proof of residence verification gate.

Post-submission shows a premium glassmorphic receipt card with tracking number, summary, expected response time, WhatsApp notification opt-in, and two CTAs (Submit Another Report, View My Reports).

The page uses the same premium skyline background + glassmorphic styling as the auth pages, creating a consistent citizen portal experience.

## Tasks Completed

### Task 1: Create GBVConsentDialog and ReportReceipt components

**Status:** ✅ Complete
**Commit:** `fbcb484` - feat(06.4-06): create GBVConsentDialog and ReportReceipt components

**What was done:**

**GBVConsentDialog component:**
- Modal overlay with glassmorphic card (GlassCard variant="elevated")
- Fixed positioning with dark semi-transparent backdrop
- Title in coral color (#ff6b9d): "GBV Report — Important Information"
- Consent information:
  - Bullet list explaining encryption, SAPS notification, confidentiality, POPIA
  - Emergency contacts box (coral-bordered):
    - Police Emergency: 10111 (clickable tel: link)
    - GBV Command Centre: 0800 150 150 (clickable tel: link)
- Two buttons:
  - "Cancel" (secondary) - auto-focused for accessibility
  - "I Understand, Continue" (primary, coral background)
- Prevents background scrolling when open
- Max-width 500px, centered in viewport

**ReportReceipt component:**
- GlassCard variant="elevated", max-width 600px, centered
- Success checkmark icon (large, teal circle)
- Title: "Report Submitted Successfully"
- Subtitle: "Your issue has been logged and assigned to the relevant municipality"
- Info rows (label: value pairs) in glassmorphic info box:
  - Tracking Number (monospace font, teal color)
  - Category
  - Description (truncated to 100 chars with "...")
  - Expected Response (gold color for emphasis)
- WhatsApp notification opt-in section:
  - Teal-bordered box
  - Checkbox with WhatsApp emoji + label
  - Separate checkbox per WhatsApp Business Policy (not combined with other options)
- Two CTAs in flex row:
  - "Submit Another Report" (Button variant="secondary")
  - "View My Reports" (Button variant="primary")

**Verification:**
- ✅ TypeScript compiles with zero errors
- ✅ GBVConsentDialog contains emergency numbers (10111: 3 matches, 0800 150 150: 2 matches)
- ✅ ReportReceipt contains WhatsApp opt-in (3 matches)

**Files:**
- `frontend-public/src/components/citizen/GBVConsentDialog.tsx` (created, 182 lines)
- `frontend-public/src/components/citizen/ReportReceipt.tsx` (created, 251 lines)

---

### Task 2: Create ReportIssuePage with full report form, proof of residence gate, and receipt state

**Status:** ✅ Complete
**Commit:** `eaa77d6` - feat(06.4-06): create full ReportIssuePage with form, gates, and receipt

**What was done:**

**Page structure:**
- Dual page state: `form` (default) → `receipt` (after submission)
- Premium skyline background (`.auth-skyline-bg` + `.auth-skyline-overlay`)
- GlassCard variant="elevated", max-width 700px, centered
- Gradient title: "Report an Issue" (coral → teal)

**Proof of residence gate:**
- Checks `user?.user_metadata?.residence_verified === true`
- If NOT verified, shows gold-bordered warning box:
  - "Proof of Residence Required" heading
  - Explanation text
  - Link to `/profile` to upload
- Form fields remain visible but submit button disabled with tooltip
- Inline blocker pattern (not hard redirect)

**Report form fields (single scrollable form):**

1. **Category dropdown** (required):
   - 8 options: Water & Sanitation, Electricity, Roads & Potholes, Waste Management, Public Safety, Housing, GBV/Abuse, Other
   - When "GBV/Abuse" selected → triggers GBVConsentDialog
   - onChange handler waits for consent before setting category

2. **Description textarea** (required):
   - Min 20 chars, max 2000 chars
   - Character counter below field
   - Placeholder: "Describe the issue in detail..."

3. **Photo upload** (optional):
   - Simple file input (no react-dropzone dependency)
   - Styled drop zone area: "Click to select photos or drag and drop"
   - Accept: image/jpg, image/jpeg, image/png, image/heic
   - Max 5 files, 10MB each
   - Client-side validation:
     - File type check (must start with "image/")
     - File size check (max 10MB per file)
     - Total file count check (max 5 total)
   - Direct upload to Supabase Storage:
     - Bucket: `isGbv ? 'gbv-evidence' : 'evidence'`
     - Path: `${tenantId}/${fileId}/${filename}`
   - Thumbnail previews (100x100px) with remove button (× in circle)
   - Upload error display (coral-bordered box)

4. **Location section** (required - at least one of GPS or manual address):
   - "Use My Location" button:
     - Calls `navigator.geolocation.getCurrentPosition()`
     - 10 second timeout
     - `enableHighAccuracy: true`
     - On success: displays lat/lng in teal-bordered box
     - On error/timeout: shows warning with error message
   - Manual address input:
     - Text input: "Or enter address manually:"
     - Placeholder: "Street address, suburb, city"
     - Always visible (not conditional toggle)
   - Validation: requires at least one (location OR manualAddress)

5. **WhatsApp channel info box:**
   - Teal-bordered info box
   - Text: "You can also report via WhatsApp: Click here"
   - Deep link: `https://wa.me/27XXXXXXXXX` (placeholder number)
   - Opens in new tab

**GBV category handling:**
- When user selects "GBV/Abuse" from dropdown:
  1. Don't set category yet (wait for consent)
  2. Show GBVConsentDialog
- If user clicks "I Understand, Continue":
  - Set `category = 'GBV/Abuse'`
  - Set `isGbv = true` (affects photo upload bucket selection)
  - Close dialog
- If user clicks "Cancel":
  - Reset `category = ''`
  - Set `isGbv = false`
  - Close dialog

**Form submission:**
- Validation:
  - Category required
  - Description min 20 chars
  - At least one of location OR manualAddress
  - Proof of residence verified (blocks submission if false)
- Mock API call (TODO comment for backend integration):
  - 1.5 second delay simulation
  - Generates mock tracking number: `TKT-YYYYMMDD-XXXXXX` (random hex)
- On success:
  - Generate category-based expected response time:
    - GBV/Abuse: "Immediate — SAPS will be notified"
    - Water & Sanitation, Electricity, Public Safety: "Within 24 hours"
    - Roads & Potholes, Waste Management, Housing: "Within 48 hours"
    - Other: "Within 72 hours"
  - Store receipt data (tracking number, category, description, expected time)
  - Switch page state to 'receipt'
  - Reset form fields
- On error: display coral-bordered error box

**Receipt state:**
- Renders ReportReceipt component with:
  - trackingNumber
  - category
  - description
  - expectedResponseTime
  - onSubmitAnother: reset receipt data, switch back to 'form' state
  - onViewReports: navigate to '/my-reports'
- Same skyline background for visual consistency

**Error handling:**
- Form validation error: coral-bordered box at top of form
- Upload error: shown below upload area
- Location error: gold-bordered box (warning tone)
- All errors have clear, user-friendly messages

**Loading states:**
- Submit button: "Submitting..." with disabled state
- Location button: "Getting location..." with disabled state
- Upload: handled per-file (success/error states in future iteration)

**Verification:**
- ✅ TypeScript compiles with zero errors
- ✅ ReportIssuePage has category dropdown with GBV/Abuse option (5 matches)
- ✅ GBV category triggers GBVConsentDialog (2 matches)
- ✅ Proof of residence gate exists (1 match: residence_verified check)
- ✅ Receipt state shows ReportReceipt component (2 matches)

**Files:**
- `frontend-public/src/pages/ReportIssuePage.tsx` (modified, 748 lines)

---

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking Issue] No react-dropzone dependency**
- **Found during:** Task 2, file upload implementation
- **Issue:** Plan referenced react-dropzone pattern from dashboard, but `grep -c "react-dropzone" package.json` returned 0. Package not installed in frontend-public.
- **Fix:** Implemented simple file input with manual validation. Styled drop zone area with click handler. Direct Supabase Storage uploads with same bucket logic (gbv-evidence vs evidence). Thumbnail previews with remove button.
- **Files modified:** frontend-public/src/pages/ReportIssuePage.tsx
- **Commit:** eaa77d6 (Task 2)
- **Rationale:** Installing react-dropzone would add ~100KB to bundle. Simple file input is sufficient for MVP and reduces dependency footprint.

---

## Verification Results

**Overall verification (Plan success criteria):**

1. ✅ TypeScript compiles with zero errors (`npx tsc --noEmit` in frontend-public)
2. ✅ GBV category shows consent dialog with emergency numbers (10111, 0800 150 150)
3. ✅ Receipt card shows tracking number, category, description, expected response time
4. ✅ WhatsApp opt-in has separate checkbox (per WhatsApp Business Policy)
5. ✅ Report form is single scrollable form (not wizard)
6. ✅ Proof of residence gate blocks submission if not verified
7. ✅ Page uses premium skyline + glassmorphic style

**Success criteria (from plan):**
- ✅ Citizens can fill out and submit report form with all fields
- ✅ GBV selection shows consent dialog with 10111 and 0800 150 150 before proceeding
- ✅ Successful submission shows receipt with tracking number and CTAs
- ✅ Proof of residence verification blocks first-time submissions
- ✅ Form is a single scrollable page, not a multi-step wizard

---

## Self-Check: PASSED

**Created files exist:**
```bash
✓ FOUND: frontend-public/src/components/citizen/GBVConsentDialog.tsx (182 lines)
✓ FOUND: frontend-public/src/components/citizen/ReportReceipt.tsx (251 lines)
```

**Modified files exist:**
```bash
✓ FOUND: frontend-public/src/pages/ReportIssuePage.tsx (748 lines)
```

**Commits exist:**
```bash
✓ FOUND: fbcb484 (Task 1: GBVConsentDialog and ReportReceipt components)
✓ FOUND: eaa77d6 (Task 2: ReportIssuePage with form, gates, and receipt)
```

**Key features verified:**
```bash
✓ GBVConsentDialog has emergency numbers (10111, 0800 150 150)
✓ ReportReceipt has separate WhatsApp opt-in checkbox
✓ ReportIssuePage has category dropdown with GBV/Abuse option
✓ GBV category triggers GBVConsentDialog
✓ Proof of residence gate blocks submission
✓ Receipt state renders ReportReceipt component
✓ Photo upload uses simple file input (no react-dropzone)
✓ GPS location capture with 10s timeout
✓ Manual address fallback
✓ Single scrollable form (not wizard)
✓ Premium skyline + glassmorphic styling
✓ TypeScript compiles with zero errors
```

---

## Next Steps

This plan completes the citizen report submission flow. Subsequent work will:

1. **Backend integration** - Replace mock API call with real POST /api/v1/reports/submit endpoint
2. **Profile page (Plan 07)** - Build proof of residence upload feature
3. **My Reports page** - Build report listing and tracking page (View My Reports CTA destination)
4. **WhatsApp opt-in backend** - Wire up WhatsApp notification checkbox to backend subscription system

**User flow after completion:**
1. Citizen navigates to /report (protected route - requires login)
2. If not verified, sees proof of residence warning (submit button disabled)
3. Citizen uploads proof of residence in /profile
4. Returns to /report, fills out form
5. Selects GBV/Abuse category → consent dialog appears
6. Accepts consent, continues filling form
7. Captures GPS location or enters manual address
8. Uploads photo evidence (optional)
9. Submits report → receipt card appears with tracking number
10. Opts in to WhatsApp notifications (optional)
11. Clicks "View My Reports" → navigates to /my-reports

**Architectural note:** The dual page state pattern (form → receipt) keeps the user on the same route while showing different content. This is cleaner than navigating to `/report/success` (extra route, back button issues) or showing a modal (blocks access to tracking number if accidentally closed).

---

## Technical Notes

### Pattern: Dual Page State

```typescript
type PageState = 'form' | 'receipt';
const [pageState, setPageState] = useState<PageState>('form');

// Conditional rendering based on state
if (pageState === 'receipt' && receiptData) {
  return <ReceiptView />;
}
return <FormView />;
```

Benefits:
- Single route (/report) handles entire flow
- No navigation needed (avoids back button confusion)
- State lives in component (no global state needed)
- Easy to add more states (e.g., 'uploading', 'error')

### Pattern: Category-Triggered Modal

GBV category selection triggers modal consent dialog:
```typescript
const handleCategoryChange = (e) => {
  const newCategory = e.target.value;

  if (newCategory === 'GBV/Abuse') {
    setShowGbvConsent(true); // Show dialog
    // Don't set category yet - wait for consent
  } else {
    setCategory(newCategory);
    setIsGbv(false);
  }
};
```

Consent dialog callbacks:
```typescript
const handleGbvAccept = () => {
  setCategory('GBV/Abuse');  // Now set category
  setIsGbv(true);             // Flag for bucket selection
  setShowGbvConsent(false);
};

const handleGbvDecline = () => {
  setCategory('');            // Reset to empty
  setIsGbv(false);
  setShowGbvConsent(false);
};
```

This ensures category is ONLY set to GBV/Abuse after user explicitly consents.

### Pattern: Inline Blocker (Proof of Residence Gate)

Instead of hard redirect or completely hiding form:
```typescript
const isResidenceVerified = user?.user_metadata?.residence_verified === true;

// Show warning box if not verified
{!isResidenceVerified && <WarningBox />}

// Disable submit button with tooltip
<Button
  disabled={isSubmitting || !isResidenceVerified}
  title={!isResidenceVerified ? 'Verify residence first' : ''}
>
  Submit Report
</Button>

// Also check in validation
if (!isResidenceVerified) {
  setError('You must verify your proof of residence before submitting a report');
  return;
}
```

Benefits:
- User can see what they'll need to fill out (less frustrating than "Access Denied")
- Clear path forward (link to /profile)
- Submit button disabled prevents accidental submission attempts
- Tooltip on hover explains why button is disabled

### Pattern: Simple File Upload (No Dependencies)

Without react-dropzone:
```typescript
// Hidden file input
<input
  id="photo-input"
  type="file"
  multiple
  accept="image/jpg,image/jpeg,image/png,image/heic"
  onChange={handlePhotoUpload}
  style={{ display: 'none' }}
/>

// Styled drop zone that triggers file input
<div onClick={() => document.getElementById('photo-input')?.click()}>
  Click to select photos or drag and drop
</div>

// Manual validation in onChange handler
const handlePhotoUpload = async (e) => {
  const files = e.target.files;

  // Validate file count
  if (uploadedFiles.length + files.length > 5) {
    setUploadError('Maximum 5 files allowed');
    return;
  }

  // Validate each file
  for (const file of files) {
    if (!file.type.startsWith('image/')) {
      setUploadError(`${file.name} is not an image file`);
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      setUploadError(`${file.name} exceeds 10MB limit`);
      return;
    }
  }

  // Upload to Supabase Storage...
};
```

This approach:
- Zero dependencies (reduces bundle size by ~100KB)
- Same validation logic as react-dropzone would provide
- Direct Supabase Storage uploads (no backend proxy needed)
- Thumbnail previews for UX

### Category-Based Expected Response Time

Mapping:
```typescript
const getExpectedResponseTime = (category: string): string => {
  const categoryMap: Record<string, string> = {
    'GBV/Abuse': 'Immediate — SAPS will be notified',
    'Water & Sanitation': 'Within 24 hours',
    'Electricity': 'Within 24 hours',
    'Public Safety': 'Within 24 hours',
    'Roads & Potholes': 'Within 48 hours',
    'Waste Management': 'Within 48 hours',
    'Housing': 'Within 48 hours',
    'Other': 'Within 72 hours',
  };
  return categoryMap[category] || 'Within 72 hours';
};
```

Sets user expectations accurately. GBV gets immediate attention, high-priority services (water, electricity, safety) get 24h, standard services get 48h, everything else 72h.

### WhatsApp Opt-In Placement

Per WhatsApp Business Policy, notification opt-ins MUST be:
- Separate checkbox (not combined with other options)
- Clear about what user is opting into
- User-initiated (no pre-checked boxes)

Receipt card is the perfect place:
- User just submitted a report (contextually relevant)
- Specific to THIS report ("status updates on this report")
- Clear checkbox with WhatsApp emoji for recognition
- Optional (not blocking any action)

If we put it in the form, it would be:
- Less contextual (user hasn't submitted yet, doesn't know tracking number)
- Might feel like spam (opt-in before even knowing if submission succeeds)
- Distracting from core form fields

---

**Completed:** 2026-02-13T13:13:16Z
**Duration:** 10.6 minutes (634 seconds)
**Tasks:** 2/2 (100%)
**Commits:** 2 (fbcb484, eaa77d6)
