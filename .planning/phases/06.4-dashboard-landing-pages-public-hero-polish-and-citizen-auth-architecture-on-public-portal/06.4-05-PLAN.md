---
phase: 06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal
plan: 05
type: execute
wave: 2
depends_on: ["06.4-01"]
files_modified:
  - frontend-public/src/App.tsx
  - frontend-public/src/components/layout/PublicHeader.tsx
  - frontend-public/src/App.css
autonomous: true

must_haves:
  truths:
    - "App.tsx wraps all routes in AuthProvider"
    - "Routes /login and /register are publicly accessible"
    - "Routes /my-reports, /report, /profile are wrapped in ProtectedRoute"
    - "Public pages /, /dashboard, /about remain accessible without login"
    - "Authenticated header shows user menu dropdown with My Reports, Profile, Report Issue, Sign Out"
    - "Unauthenticated header stays unchanged (existing nav links)"
  artifacts:
    - path: "frontend-public/src/App.tsx"
      provides: "Updated routing with AuthProvider and ProtectedRoute wrappers"
      contains: "AuthProvider"
    - path: "frontend-public/src/components/layout/PublicHeader.tsx"
      provides: "Header with authenticated and unauthenticated states"
      contains: "user-menu"
  key_links:
    - from: "frontend-public/src/App.tsx"
      to: "frontend-public/src/contexts/AuthContext.tsx"
      via: "AuthProvider wrapping BrowserRouter children"
      pattern: "AuthProvider"
    - from: "frontend-public/src/App.tsx"
      to: "frontend-public/src/components/auth/ProtectedRoute.tsx"
      via: "ProtectedRoute wrapping auth-gated page elements"
      pattern: "ProtectedRoute"
    - from: "frontend-public/src/components/layout/PublicHeader.tsx"
      to: "frontend-public/src/hooks/useAuth.ts"
      via: "useAuth for checking session state"
      pattern: "useAuth"
---

<objective>
Update App.tsx routing with AuthProvider, ProtectedRoute wrappers, and add authenticated header state.

Purpose: This connects the auth infrastructure (Plan 01) and auth pages (Plan 04) into the application. Routes are split into public (always accessible) and protected (require citizen login). The header adapts to show a user menu when authenticated.

Output: Updated App.tsx with full auth-gated routing, and PublicHeader with authenticated/unauthenticated states.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal/06.4-01-SUMMARY.md
@frontend-public/src/App.tsx
@frontend-public/src/components/layout/PublicHeader.tsx
@frontend-public/src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update App.tsx with AuthProvider and protected routes</name>
  <files>
    frontend-public/src/App.tsx
  </files>
  <action>
    Update `frontend-public/src/App.tsx` to integrate authentication.

    **Changes:**

    1. **Add imports:**
       - `AuthProvider` from `./contexts/AuthContext`
       - `ProtectedRoute` from `./components/auth/ProtectedRoute`
       - `CitizenLoginPage` from `./pages/CitizenLoginPage`
       - `CitizenRegisterPage` from `./pages/CitizenRegisterPage`
       - `ReportIssuePage` from `./pages/ReportIssuePage` (will be created in Plan 06 — for now, create a placeholder)
       - `ProfilePage` from `./pages/ProfilePage` (will be created in Plan 07 — for now, create a placeholder)

    2. **Wrap in AuthProvider:**
       Place `<AuthProvider>` inside `<BrowserRouter>` but outside `<LenisProvider>`:
       ```
       <BrowserRouter>
         <AuthProvider>
           <LenisProvider>
             ...
           </LenisProvider>
         </AuthProvider>
       </BrowserRouter>
       ```

    3. **Update Routes:**
       ```tsx
       <Routes>
         {/* Public pages — always accessible */}
         <Route path="/" element={<LandingPage />} />
         <Route path="/dashboard" element={<TransparencyDashboardPage />} />
         <Route path="/about" element={<AboutPage />} />

         {/* Auth pages — accessible without login */}
         <Route path="/login" element={<CitizenLoginPage />} />
         <Route path="/register" element={<CitizenRegisterPage />} />

         {/* Protected pages — require citizen login */}
         <Route path="/my-reports" element={
           <ProtectedRoute><CitizenPortalPage /></ProtectedRoute>
         } />
         <Route path="/report" element={
           <ProtectedRoute><ReportIssuePage /></ProtectedRoute>
         } />
         <Route path="/profile" element={
           <ProtectedRoute><ProfilePage /></ProtectedRoute>
         } />

         {/* Catch-all */}
         <Route path="*" element={<Navigate to="/" replace />} />
       </Routes>
       ```

    4. **Create placeholder pages** (temporary until Plans 06 and 07):
       - Create `frontend-public/src/pages/ReportIssuePage.tsx`:
         ```tsx
         import { GlassCard } from '@shared/components/ui/GlassCard';
         export function ReportIssuePage() {
           return (
             <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem' }}>
               <GlassCard>
                 <h1>Report an Issue</h1>
                 <p>Report form coming soon...</p>
               </GlassCard>
             </div>
           );
         }
         ```
       - Create `frontend-public/src/pages/ProfilePage.tsx`:
         ```tsx
         import { GlassCard } from '@shared/components/ui/GlassCard';
         export function ProfilePage() {
           return (
             <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem' }}>
               <GlassCard>
                 <h1>My Profile</h1>
                 <p>Profile page coming soon...</p>
               </GlassCard>
             </div>
           );
         }
         ```

    5. **Remove old ReportRedirectPage** — the /report route now goes to auth-gated ReportIssuePage instead of the redirect page. Delete the import for ReportRedirectPage. The file itself can stay on disk (don't delete files unnecessarily).

    6. **Update JSDoc comment** at the top to reflect the new auth architecture.

    **CRITICAL:** Header and Footer stay outside Routes — they render on ALL pages including auth pages. The login/register pages will have their own full-viewport layout that visually covers the header anyway (same as municipal dashboard pattern).
  </action>
  <verify>
    Run `cd frontend-public && npx tsc --noEmit` to verify TypeScript compiles.
    Verify App.tsx imports AuthProvider and wraps routes.
    Verify /my-reports, /report, /profile use ProtectedRoute wrapper.
    Verify /login and /register routes exist.
  </verify>
  <done>
    App.tsx wraps all routes in AuthProvider. Public pages (/, /dashboard, /about) remain accessible. Auth pages (/login, /register) are publicly accessible. Protected pages (/my-reports, /report, /profile) require citizen login via ProtectedRoute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add authenticated header state with user menu dropdown</name>
  <files>
    frontend-public/src/components/layout/PublicHeader.tsx
    frontend-public/src/App.css
  </files>
  <action>
    Update `frontend-public/src/components/layout/PublicHeader.tsx` to show different UI based on auth state.

    **Per user decision:**
    - Unauthenticated: existing nav (Home, Dashboard, About, My Reports, Report Issue CTA) — NO changes needed
    - Authenticated: add user menu dropdown (avatar/name) with: My Reports, Profile, Report Issue, Sign Out
    - Existing "My Reports" nav link stays — it's the auth gateway

    **Changes:**

    1. **Import useAuth:**
       ```typescript
       import { useAuth } from '../../hooks/useAuth';
       ```

    2. **Add state for user menu:**
       ```typescript
       const { user, signOut } = useAuth();
       const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);
       ```

    3. **Desktop header right side (replace the desktop-cta div when authenticated):**
       When `user` exists, instead of the "Report Issue" Button, show:
       ```tsx
       {user ? (
         <div className="header-user-menu-wrapper">
           <button
             className="header-user-button"
             onClick={() => setIsUserMenuOpen(!isUserMenuOpen)}
           >
             <div className="user-avatar">
               {(user.user_metadata?.full_name || user.email || 'U').charAt(0).toUpperCase()}
             </div>
             <span className="user-name">
               {user.user_metadata?.full_name || user.email?.split('@')[0] || 'Citizen'}
             </span>
             <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
               <polyline points="6 9 12 15 18 9" />
             </svg>
           </button>

           {isUserMenuOpen && (
             <div className="header-user-dropdown">
               <Link to="/my-reports" className="dropdown-item" onClick={() => setIsUserMenuOpen(false)}>
                 My Reports
               </Link>
               <Link to="/profile" className="dropdown-item" onClick={() => setIsUserMenuOpen(false)}>
                 Profile
               </Link>
               <Link to="/report" className="dropdown-item" onClick={() => setIsUserMenuOpen(false)}>
                 Report Issue
               </Link>
               <hr className="dropdown-divider" />
               <button
                 className="dropdown-item dropdown-signout"
                 onClick={() => { signOut(); setIsUserMenuOpen(false); }}
               >
                 Sign Out
               </button>
             </div>
           )}
         </div>
       ) : (
         <div className="header-cta desktop-cta">
           <Link to="/report">
             <Button variant="primary" size="md">
               Report Issue
             </Button>
           </Link>
         </div>
       )}
       ```

    4. **Mobile menu (authenticated state):**
       When user exists, add to the mobile nav: Profile link and Sign Out button at the bottom.
       Keep existing nav links. Add:
       ```tsx
       {user && (
         <>
           <NavLink to="/profile" className={...} onClick={...}>Profile</NavLink>
           <button className="mobile-nav-link mobile-signout" onClick={() => { signOut(); setIsMobileMenuOpen(false); }}>
             Sign Out
           </button>
         </>
       )}
       ```

    5. **Click-outside handler for dropdown:**
       Add useEffect that listens for clicks outside the user menu to close it:
       ```typescript
       useEffect(() => {
         const handleClickOutside = (e: MouseEvent) => {
           if (isUserMenuOpen && !(e.target as Element)?.closest('.header-user-menu-wrapper')) {
             setIsUserMenuOpen(false);
           }
         };
         document.addEventListener('click', handleClickOutside);
         return () => document.removeEventListener('click', handleClickOutside);
       }, [isUserMenuOpen]);
       ```

    **Add CSS to `frontend-public/src/App.css`:**
    ```css
    .header-user-menu-wrapper {
      position: relative;
    }

    .header-user-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(205, 94, 129, 0.15);
      border: 1px solid rgba(205, 94, 129, 0.3);
      border-radius: var(--radius-full);
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .header-user-button:hover {
      background: rgba(205, 94, 129, 0.25);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-coral), var(--color-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .user-name {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .header-user-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-md);
      padding: 0.5rem 0;
      z-index: 100;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .dropdown-item {
      display: block;
      width: 100%;
      padding: 0.625rem 1rem;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 0.875rem;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
    }

    .dropdown-item:hover {
      background: rgba(205, 94, 129, 0.15);
    }

    .dropdown-divider {
      margin: 0.25rem 0;
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dropdown-signout {
      color: var(--color-coral);
    }

    .mobile-signout {
      color: var(--color-coral) !important;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }
    ```
  </action>
  <verify>
    Run `cd frontend-public && npx tsc --noEmit` to verify TypeScript compiles.
    Verify PublicHeader.tsx imports useAuth and shows different UI based on user state.
    Verify dropdown contains My Reports, Profile, Report Issue, Sign Out items.
    Verify App.css has .header-user-dropdown styles.
  </verify>
  <done>
    PublicHeader shows user menu dropdown when authenticated (avatar, name, dropdown with My Reports, Profile, Report Issue, Sign Out). Unauthenticated state unchanged. Click-outside closes dropdown. Mobile menu includes Profile and Sign Out when authenticated.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend-public && npx tsc --noEmit` — TypeScript compiles with zero errors
2. App.tsx has AuthProvider wrapping routes
3. /my-reports, /report, /profile wrapped in ProtectedRoute
4. /login and /register routes exist
5. PublicHeader shows user dropdown when authenticated
6. Clicking "My Reports" when not logged in redirects to /login
</verification>

<success_criteria>
- AuthProvider wraps entire app providing session state
- Public pages always accessible, protected pages redirect to login
- Header adapts to show user menu when logged in
- Navigation between public and protected pages works seamlessly
</success_criteria>

<output>
After completion, create `.planning/phases/06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal/06.4-05-SUMMARY.md`
</output>
