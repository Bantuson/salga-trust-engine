---
phase: 06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal
plan: 06
type: execute
wave: 3
depends_on: ["06.4-04", "06.4-05"]
files_modified:
  - frontend-public/src/pages/ReportIssuePage.tsx
  - frontend-public/src/components/citizen/GBVConsentDialog.tsx
  - frontend-public/src/components/citizen/ReportReceipt.tsx
autonomous: true

must_haves:
  truths:
    - "Citizens can submit reports via web form with category, description, photos, GPS, address fallback"
    - "GBV category selection shows consent dialog with emergency numbers (10111, 0800 150 150)"
    - "Post-submit shows glassmorphic receipt card with tracking number, category, description summary, expected response time"
    - "Receipt card has WhatsApp notification opt-in with separate checkbox"
    - "Receipt card has two CTAs: Submit Another Report and View My Reports"
    - "Report form is single scrollable form (not multi-step wizard)"
    - "Report form page uses premium full-page style (skyline background, glassmorphic card)"
    - "Proof of residence inline blocker prevents first report submission if not verified"
  artifacts:
    - path: "frontend-public/src/pages/ReportIssuePage.tsx"
      provides: "Full report form page with proof of residence gate and receipt state"
      contains: "ReportIssuePage"
    - path: "frontend-public/src/components/citizen/GBVConsentDialog.tsx"
      provides: "Modal consent dialog for GBV reports with emergency contacts"
      contains: "GBVConsentDialog"
    - path: "frontend-public/src/components/citizen/ReportReceipt.tsx"
      provides: "Glassmorphic receipt card with tracking number and CTAs"
      contains: "ReportReceipt"
  key_links:
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "frontend-public/src/components/citizen/GBVConsentDialog.tsx"
      via: "Conditional render when GBV category selected"
      pattern: "GBVConsentDialog"
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "frontend-public/src/components/citizen/ReportReceipt.tsx"
      via: "Shown after successful submission"
      pattern: "ReportReceipt"
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "frontend-public/src/hooks/useAuth.ts"
      via: "Get user session for API calls"
      pattern: "useAuth"
---

<objective>
Build the citizen report form page with GBV consent dialog, proof of residence gate, and glassmorphic receipt card.

Purpose: This is the core citizen reporting experience. Citizens submit municipal issues via a web form with all the features from the dashboard ReportForm (category, description, photos, GPS, address fallback) plus citizen-specific features: GBV consent dialog, proof of residence verification gate, and post-submit receipt card with tracking number and WhatsApp opt-in.

Output: Complete report submission flow from form to receipt, with GBV safety and proof of residence compliance.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal/06.4-01-SUMMARY.md
@.planning/phases/06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal/06.4-05-SUMMARY.md
@frontend-dashboard/src/components/ReportForm.tsx
@frontend-dashboard/src/components/FileUpload.tsx
@frontend-dashboard/src/components/GeolocationCapture.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GBVConsentDialog and ReportReceipt components</name>
  <files>
    frontend-public/src/components/citizen/GBVConsentDialog.tsx
    frontend-public/src/components/citizen/ReportReceipt.tsx
  </files>
  <action>
    **1. Create `frontend-public/src/components/citizen/GBVConsentDialog.tsx`:**

    Follow the research document Pattern 5 closely. Modal overlay with consent information.

    Props interface:
    ```typescript
    interface GBVConsentDialogProps {
      onAccept: () => void;
      onDecline: () => void;
    }
    ```

    Content:
    - Title: "GBV Report — Important Information" in coral color
    - Explanation paragraph: "By submitting a gender-based violence report:"
    - Bullet list:
      - "Your report will be securely encrypted and handled with strict confidentiality"
      - "SAPS (South African Police Service) will be notified"
      - "Only authorized SAPS liaison officers can access your details"
      - "Your information is protected under POPIA"
    - Emergency contacts box (coral-bordered):
      - "If you are in immediate danger, call these numbers NOW:"
      - Police Emergency: 10111 (clickable tel: link)
      - GBV Command Centre: 0800 150 150 (clickable tel: link)
    - Two buttons: "Cancel" (secondary) and "I Understand, Continue" (primary, coral bg)
    - Fixed overlay: `position: fixed`, `inset: 0`, dark semi-transparent background
    - Dialog: GlassCard centered in viewport, max-width 500px
    - Trap focus within dialog (add tabIndex={-1} to overlay, autoFocus on Cancel button for accessibility)

    **2. Create `frontend-public/src/components/citizen/ReportReceipt.tsx`:**

    Follow the research document Pattern 4 closely. Glassmorphic receipt card.

    Props interface:
    ```typescript
    interface ReportReceiptProps {
      trackingNumber: string;
      category: string;
      description: string;
      expectedResponseTime: string;
      onSubmitAnother: () => void;
      onViewReports: () => void;
    }
    ```

    Content:
    - Success checkmark icon (large, teal color)
    - Title: "Report Submitted Successfully"
    - Subtitle: "Your issue has been logged and assigned to the relevant municipality"
    - Info rows (label: value pairs):
      - Tracking Number (displayed in monospace/code font)
      - Category
      - Description (truncated to 100 chars with "...")
      - Expected Response (e.g., "Within 24 hours")
    - WhatsApp notification opt-in section:
      - Separate checkbox with WhatsApp icon placeholder: "Receive WhatsApp notifications for status updates on this report"
      - Per WhatsApp Business Policy: this MUST be a separate checkbox, NOT combined with other notification options
    - Two CTAs in a row:
      - "Submit Another Report" (secondary button) — calls onSubmitAnother
      - "View My Reports" (primary button) — calls onViewReports
    - Wrapped in GlassCard variant="elevated"
    - Max-width 600px, centered with auto margins
  </action>
  <verify>
    Run `cd frontend-public && npx tsc --noEmit` to verify TypeScript compiles.
    Verify GBVConsentDialog.tsx contains emergency numbers 10111 and 0800 150 150.
    Verify ReportReceipt.tsx contains separate WhatsApp opt-in checkbox.
  </verify>
  <done>
    GBVConsentDialog shows consent info and emergency contacts (10111, 0800 150 150) before allowing GBV report. ReportReceipt shows glassmorphic receipt with tracking number, summary, WhatsApp opt-in, and two CTAs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReportIssuePage with full report form, proof of residence gate, and receipt state</name>
  <files>
    frontend-public/src/pages/ReportIssuePage.tsx
  </files>
  <action>
    Replace the placeholder `frontend-public/src/pages/ReportIssuePage.tsx` with the full report form page.

    **Page states (managed by useState):**
    1. `form` — Show the report form (default)
    2. `receipt` — Show the receipt card after successful submission

    **Layout:**
    - Premium full-page style: skyline background (.auth-skyline-bg + .auth-skyline-overlay)
    - Content wrapped in GlassCard, max-width 700px, centered
    - Padding-top to account for fixed header

    **Proof of residence gate (per user decision):**
    Before the form, check if user has verified proof of residence. For now, since there's no backend endpoint for this yet, use a flag from user metadata or a simulated check:
    ```typescript
    const { user } = useAuth();
    const isResidenceVerified = user?.user_metadata?.residence_verified === true;
    ```
    If NOT verified, show an inline blocker:
    - Warning box (gold-bordered) at top of form area:
      - "Proof of Residence Required"
      - "You must upload proof of residence before submitting your first report."
      - Link to /profile: "Upload in your Profile"
    - Form fields still visible but submit button disabled with tooltip "Verify residence first"

    **Report form fields (single scrollable form, NOT wizard per user decision):**
    1. **Category dropdown** (required):
       Options: Water & Sanitation, Electricity, Roads & Potholes, Waste Management, Public Safety, Housing, GBV/Abuse, Other
       When "GBV/Abuse" selected → trigger GBVConsentDialog
    2. **Description textarea** (required, min 20 chars):
       Placeholder: "Describe the issue in detail..."
    3. **Photo upload** (optional):
       Use react-dropzone for drag-and-drop. Accept images (jpg, png, heic). Max 5 files, max 10MB each.
       Show thumbnails of uploaded files with remove button.
    4. **Location section:**
       - "Use My Location" button that triggers navigator.geolocation.getCurrentPosition with 10s timeout
       - Shows lat/lng when captured
       - "Enter Address Manually" toggle that shows address text input
       - At least one (GPS or manual address) should be provided (validation)
    5. **Channel choice section:**
       Both web form AND WhatsApp per user decision. Show info text:
       "You can also report via WhatsApp: [WhatsApp link]"
       Use deep link format: `https://wa.me/27XXXXXXXXX` (use placeholder number — actual number from env var)

    **GBV category handling:**
    When user selects GBV/Abuse category:
    1. Show GBVConsentDialog
    2. If user clicks "I Understand, Continue" → set `isGbv = true`, keep category as GBV/Abuse
    3. If user clicks "Cancel" → reset category to empty string

    **Form submission:**
    On submit:
    1. Validate all required fields
    2. Get auth token from useAuth
    3. Upload photos to Supabase Storage (evidence bucket) using supabase.storage.from('evidence').upload()
    4. Submit report to backend: POST /api/v1/reports/submit with body: { category, description, is_gbv, location: { latitude, longitude } OR manual_address, media_file_ids, language: 'en' }
    5. On success response (contains tracking_number):
       - Set page state to 'receipt'
       - Pass tracking number, category, description, expected response time to ReportReceipt

    **Expected response time logic:**
    Map category to expected time:
    - GBV/Abuse: "Immediate — SAPS will be notified"
    - Water & Sanitation, Electricity: "Within 24 hours"
    - Roads & Potholes, Waste Management: "Within 48 hours"
    - Other: "Within 72 hours"

    **Receipt state:**
    When state is 'receipt', show ReportReceipt with:
    - onSubmitAnother: reset form state, switch back to 'form' state
    - onViewReports: navigate to /my-reports

    **Imports:**
    - useState, useCallback from react
    - useNavigate from react-router-dom
    - useAuth from ../hooks/useAuth
    - GlassCard from @shared/components/ui/GlassCard
    - Button from @shared/components/ui/Button
    - GBVConsentDialog from ../components/citizen/GBVConsentDialog
    - ReportReceipt from ../components/citizen/ReportReceipt
    - supabase from ../lib/supabase
    - useDropzone from react-dropzone (check if installed — if not, the page can use a simple file input as fallback)

    **NOTE on react-dropzone:** Check if `react-dropzone` is in `frontend-public/package.json`. If not, use a simpler approach with `<input type="file" multiple accept="image/*" />` styled as a drop zone area. The dashboard has react-dropzone but the public portal may not.
  </action>
  <verify>
    Run `cd frontend-public && npx tsc --noEmit` to verify TypeScript compiles.
    Verify ReportIssuePage.tsx has category dropdown with GBV/Abuse option.
    Verify GBV category triggers GBVConsentDialog.
    Verify proof of residence gate exists.
    Verify receipt state shows ReportReceipt component.
  </verify>
  <done>
    Full report form page with category, description, photos, GPS/address, GBV consent dialog, proof of residence gate, and post-submit receipt card. Single scrollable form. Premium full-page style with skyline background.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend-public && npx tsc --noEmit` — TypeScript compiles with zero errors
2. GBV category shows consent dialog with emergency numbers
3. Receipt card shows tracking number, category, description, expected response time
4. WhatsApp opt-in has separate checkbox (per WhatsApp Business Policy)
5. Report form is single scrollable form (not wizard)
6. Proof of residence gate blocks submission if not verified
7. Page uses premium skyline + glassmorphic style
</verification>

<success_criteria>
- Citizens can fill out and submit report form with all fields
- GBV selection shows consent dialog with 10111 and 0800 150 150 before proceeding
- Successful submission shows receipt with tracking number and CTAs
- Proof of residence verification blocks first-time submissions
- Form is a single scrollable page, not a multi-step wizard
</success_criteria>

<output>
After completion, create `.planning/phases/06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal/06.4-06-SUMMARY.md`
</output>
