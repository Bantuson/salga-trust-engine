---
phase: 03-citizen-reporting-channels
plan: 07
type: execute
wave: 2
depends_on: ["03-06"]
files_modified:
  - tests/test_image_utils.py
  - tests/test_whatsapp_service.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Phase 3 service layer coverage is >= 80% (up from 78%)"
    - "image_utils coverage is >= 80% (up from 67%)"
    - "whatsapp_service coverage is >= 80% (up from 76%)"
    - "All existing 195 tests still pass (zero regressions)"
  artifacts:
    - path: "tests/test_image_utils.py"
      provides: "Additional tests for uncovered image_utils paths"
      contains: "def test_"
    - path: "tests/test_whatsapp_service.py"
      provides: "Additional tests for uncovered whatsapp_service paths"
      contains: "def test_"
  key_links:
    - from: "tests/test_image_utils.py"
      to: "src/services/image_utils.py"
      via: "import and test calls"
      pattern: "from src.services.image_utils import"
    - from: "tests/test_whatsapp_service.py"
      to: "src/services/whatsapp_service.py"
      via: "import and test calls"
      pattern: "from src.services.whatsapp_service import"
---

<objective>
Add unit tests to push Phase 3 service coverage from 78% to >= 80% (gap closure)

Purpose: Close verification gap #1 - "All unit, integration, and security tests pass with >=80% coverage on phase code". image_utils at 67% and whatsapp_service at 76% need more coverage. Adding 5-8 targeted tests for uncovered code paths.

Output: Updated test files with additional tests covering previously untested code paths
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-citizen-reporting-channels/03-05-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-06-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-VERIFICATION.md

Key references:
- tests/test_image_utils.py — Existing 11 tests, needs tests for: extract_gps_from_exif with actual GPS data, _convert_dms_to_decimal, strip_exif with PNG format, validate_image_quality with large-enough-but-too-small-filesize image
- tests/test_whatsapp_service.py — Existing 5 tests, needs tests for: empty message+media rejection, blocked input by guardrails, flow exception handling, send_whatsapp_message with whatsapp: prefix already present, Twilio exception handling, MediaAttachment creation (after 03-06 fix), tracking number extraction (after 03-06 fix)
- src/services/image_utils.py — Coverage gaps: extract_gps_from_exif success path (lines 89-106), _convert_dms_to_decimal (lines 118-121), strip_exif_metadata PNG branch (line 57 format fallback), validate_image_quality file-size-too-small path (lines 153-159)
- src/services/whatsapp_service.py — Coverage gaps: empty input return (lines 91-96), guardrails blocked (lines 151-157), flow exception (lines 228-237), MediaAttachment creation (new code from 03-06), tracking number extraction (new code from 03-06)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image_utils tests for uncovered code paths</name>
  <files>tests/test_image_utils.py</files>
  <action>
Add the following tests to the existing TestImageUtils class in tests/test_image_utils.py to push image_utils coverage from 67% to >= 80%:

**Test 1: test_extract_gps_with_data** — Test GPS extraction success path (lines 89-106 in image_utils.py)
- Use unittest.mock.patch to mock exifread.process_file to return fake GPS tags
- Create mock tag values that simulate DMS format: {'GPS GPSLatitude': mock_lat, 'GPS GPSLongitude': mock_lon, 'GPS GPSLatitudeRef': mock_lat_ref, 'GPS GPSLongitudeRef': mock_lon_ref}
- Mock lat values as [MockRatio(33, 1), MockRatio(55, 1), MockRatio(30, 1)] for ~-33.925 (South Africa)
- Mock lon values as [MockRatio(18, 1), MockRatio(25, 1), MockRatio(0, 1)] for ~18.4167
- lat_ref should have .values = 'S', lon_ref should have .values = 'E'
- Create a helper MockRatio class: `class MockRatio: def __init__(self, num, den): self.num = num; self.den = den`
- Assert result is a tuple of two floats, latitude is negative (South), longitude is positive (East)
- Assert approximate values: latitude ~= -33.925, longitude ~= 18.4167

**Test 2: test_extract_gps_exception_handling** — Test GPS extraction with invalid/malformed EXIF (line 105 exception handler)
- Mock exifread.process_file to return GPS tags with malformed values that trigger ValueError
- Assert result is None (graceful degradation)

**Test 3: test_strip_exif_png_format** — Test EXIF stripping with PNG format (line 57 format branch)
- Create a PNG image (not JPEG) using Image.new('RGB', (100, 100))
- Save as PNG format
- Call strip_exif_metadata
- Verify output is valid PNG (can be opened, has same dimensions)

**Test 4: test_validate_image_quality_large_dims_small_filesize** — Test the file-size-too-small validation path (lines 153-159)
- Create image with dimensions >= 800x600 (passes dimension check) but compress to very small file size < 50KB
- Create 800x600 solid white JPEG with very low quality (quality=1) to make it under 50KB
- Assert result["valid"] is False
- Assert "File size too small" in result["reason"]

These 4 tests specifically cover the uncovered branches identified in the verification. With 11 existing + 4 new = 15 tests, and the key uncovered branches (GPS success path ~17 lines, DMS conversion ~4 lines, PNG format ~1 line, filesize check ~6 lines) now covered, image_utils should reach >= 80%.
  </action>
  <verify>
Run: `python -m pytest tests/test_image_utils.py -v` — all tests pass (15 tests)
Run: `python -m pytest tests/test_image_utils.py --cov=src/services/image_utils --cov-report=term-missing` — coverage >= 80%
  </verify>
  <done>
- 4 new tests added to tests/test_image_utils.py covering GPS extraction success path, GPS exception handling, PNG format stripping, and filesize-too-small validation
- All 15 image_utils tests pass
- image_utils coverage >= 80% (up from 67%)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add whatsapp_service tests for uncovered code paths and new 03-06 code</name>
  <files>tests/test_whatsapp_service.py</files>
  <action>
Add the following tests to the existing TestWhatsAppService class in tests/test_whatsapp_service.py to push whatsapp_service coverage from 76% to >= 80%:

**Test 1: test_process_empty_message_and_no_media** — Test the early return for empty input (lines 91-96)
- Call process_incoming_message with message_body=None, media_items=[]
- Assert result["response"] == "Please send a message with text or photos."
- Assert result["is_complete"] is False
- Assert result["tracking_number"] is None
- This does NOT need guardrails/flow mocks since it returns early

**Test 2: test_process_message_blocked_by_guardrails** — Test input blocked by guardrails (lines 151-157)
- Mock guardrails_engine.process_input to return is_safe=False, blocked_reason="Inappropriate content"
- Call process_incoming_message with text message
- Assert result["response"] contains "Inappropriate content" or the blocked reason
- Assert result["tracking_number"] is None

**Test 3: test_process_message_flow_exception** — Test flow.kickoff() raising an exception (lines 228-237)
- Mock IntakeFlow.kickoff to raise RuntimeError("LLM API unavailable")
- Assert result["response"] contains "error" or "apologize"
- Assert result["is_complete"] is False

**Test 4: test_send_whatsapp_with_existing_prefix** — Test send when number already has whatsapp: prefix (line 286)
- Call send_whatsapp_message with to_number="whatsapp:+27123456789" (already has prefix)
- Assert Twilio create was called with to="whatsapp:+27123456789" (not double-prefixed)

**Test 5: test_send_whatsapp_twilio_exception** — Test Twilio REST exception handling (lines 306-315)
- Mock twilio_client.messages.create to raise TwilioRestException(status=400, uri="/test", msg="Bad request", code=21211)
- Assert result is None (graceful degradation)

**Test 6: test_process_message_with_ticket_and_tracking_number** — Test the new tracking number extraction (from 03-06 fix)
- Mock IntakeFlow state after kickoff to have ticket_data={"tracking_number": "TKT-20260210-ABC123", "category": "roads"}
- Mock flow.state.ticket_id to be a valid UUID string
- Assert result["tracking_number"] == "TKT-20260210-ABC123"
- Assert "TKT-20260210-ABC123" appears in result["response"]

These 6 tests cover the specific uncovered branches: empty input early return, guardrails blocking, flow exception, send prefix handling, Twilio exception, and the new tracking number extraction from 03-06. With 5 existing + 6 new = 11 tests, whatsapp_service should reach >= 80%.

**Important:** Also remove the TestPhoneLookupHelpers class at the bottom of the file (lines 234-252) — it contains only `pass` statements and is a placeholder for tests that belong in test_whatsapp_webhook.py. Cleaning this up avoids test collection confusion.

**Important for TwilioRestException mock:** Import TwilioRestException from twilio.base.exceptions and construct it correctly. The constructor requires (status, uri) positional args and optional msg, code kwargs.
  </action>
  <verify>
Run: `python -m pytest tests/test_whatsapp_service.py -v` — all tests pass (11 tests)
Run: `python -m pytest tests/test_whatsapp_service.py --cov=src/services/whatsapp_service --cov-report=term-missing` — coverage >= 80%
Run: `python -m pytest tests/ -v --tb=short` — all 195+ tests pass (zero regressions)
  </verify>
  <done>
- 6 new tests added to tests/test_whatsapp_service.py covering empty input, guardrails block, flow exception, send prefix, Twilio exception, and tracking number extraction
- TestPhoneLookupHelpers placeholder class removed
- All 11 whatsapp_service tests pass
- whatsapp_service coverage >= 80% (up from 76%)
- All existing tests still pass (zero regressions)
- Phase 3 service layer coverage >= 80% overall
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_image_utils.py -v` — 15 tests pass
2. `python -m pytest tests/test_whatsapp_service.py -v` — 11 tests pass
3. `python -m pytest tests/ -v --tb=short` — all tests pass, zero regressions
4. `python -m pytest tests/test_image_utils.py tests/test_whatsapp_service.py --cov=src/services/image_utils --cov=src/services/whatsapp_service --cov-report=term-missing` — both >= 80%
</verification>

<success_criteria>
- image_utils coverage >= 80% (up from 67%)
- whatsapp_service coverage >= 80% (up from 76%)
- Phase 3 service layer coverage >= 80% overall (up from 78%)
- All 195+ tests pass with zero regressions
- No placeholder/empty test classes remain
</success_criteria>

<output>
After completion, create `.planning/phases/03-citizen-reporting-channels/03-07-SUMMARY.md`
</output>
