---
phase: 06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency
plan: 06
type: execute
wave: 3
depends_on: ["06.2-01", "06.2-02", "06.2-08"]
files_modified:
  - frontend-public/src/pages/CitizenPortalPage.tsx
  - frontend-public/src/hooks/useCitizenReports.ts
  - frontend-public/src/components/citizen/MyReportsList.tsx
  - frontend-public/src/components/citizen/PersonalStats.tsx
  - frontend-public/src/components/citizen/GBVCaseCard.tsx
  - frontend-public/src/components/citizen/TicketCard.tsx
  - frontend-public/src/components/HeatmapViewer.tsx
  - frontend-public/src/App.tsx
  - frontend-public/src/App.css
autonomous: true

must_haves:
  truths:
    - "Citizen 'My Reports' page fetches ticket data from GET /api/v1/citizen/my-reports backend endpoint"
    - "Personal analytics (total, resolved, avg time) are fetched from GET /api/v1/citizen/stats backend endpoint"
    - "GBV cases show limited info with lock icon: status, assigned SAPS officer, station phone, emergency numbers"
    - "Regular tickets show full details: title, description, assigned worker, photos count"
    - "Emergency contacts (10111, 0800 150 150) are prominently displayed on GBV case cards"
    - "Enhanced heatmap has time filter slider, category toggle, and click-to-drill interaction"
    - "Page requires authentication; unauthenticated users are redirected to login"
  artifacts:
    - path: "frontend-public/src/pages/CitizenPortalPage.tsx"
      provides: "Authenticated citizen My Reports dashboard with backend data"
      contains: "CitizenPortalPage"
    - path: "frontend-public/src/hooks/useCitizenReports.ts"
      provides: "Hook for fetching citizen reports and stats from API"
      contains: "useCitizenReports"
    - path: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      provides: "Privacy-preserving GBV case display card"
      contains: "GBVCaseCard"
    - path: "frontend-public/src/components/citizen/PersonalStats.tsx"
      provides: "Personal analytics cards from backend stats endpoint"
      contains: "PersonalStats"
    - path: "frontend-public/src/components/HeatmapViewer.tsx"
      provides: "Enhanced interactive heatmap with filters"
      contains: "HeatmapViewer"
  key_links:
    - from: "frontend-public/src/hooks/useCitizenReports.ts"
      to: "GET /api/v1/citizen/my-reports"
      via: "fetch/Supabase client API call"
      pattern: "citizen/my-reports"
    - from: "frontend-public/src/hooks/useCitizenReports.ts"
      to: "GET /api/v1/citizen/stats"
      via: "fetch/Supabase client API call"
      pattern: "citizen/stats"
    - from: "frontend-public/src/components/citizen/MyReportsList.tsx"
      to: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      via: "conditional rendering based on is_sensitive flag"
      pattern: "is_sensitive"
    - from: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      to: "Emergency contacts"
      via: "prominently displayed phone numbers"
      pattern: "10111.*0800 150 150"
---

<objective>
Build the citizen "My Reports" authenticated portal with personal analytics and GBV privacy UI, and enhance the heatmap with interactive filters (time range, category toggle, click-to-drill).

Purpose: Citizens need to track their reported issues and view personal analytics. GBV victims need to see case status + assigned SAPS officer contact without exposing sensitive details (locked decision). The heatmap needs full interactivity for meaningful transparency data exploration.

Output: Citizen portal page with reports list, personal stats, GBV privacy cards, and enhanced interactive heatmap.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-CONTEXT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-RESEARCH.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-01-SUMMARY.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-02-SUMMARY.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-08-SUMMARY.md
@frontend-public/src/components/HeatmapViewer.tsx
@frontend-public/src/pages/PublicDashboardPage.tsx
@src/api/v1/citizen.py
@src/schemas/citizen.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create citizen "My Reports" portal with personal analytics and GBV privacy UI</name>
  <files>
    frontend-public/src/pages/CitizenPortalPage.tsx
    frontend-public/src/hooks/useCitizenReports.ts
    frontend-public/src/components/citizen/MyReportsList.tsx
    frontend-public/src/components/citizen/PersonalStats.tsx
    frontend-public/src/components/citizen/GBVCaseCard.tsx
    frontend-public/src/components/citizen/TicketCard.tsx
    frontend-public/src/App.tsx
    frontend-public/src/App.css
  </files>
  <action>
    **NOTE: This page requires Supabase authentication. The public site must have Supabase Auth configured so citizens can log in. The page checks auth state — if not authenticated, redirect to login. If authenticated, fetch real data from backend.**

    **0. Create frontend-public/src/hooks/useCitizenReports.ts:**
    A custom hook encapsulating all citizen portal API interactions:
    ```typescript
    export function useCitizenReports() {
      // GET /api/v1/citizen/my-reports — fetch citizen's tickets from backend
      // Returns CitizenMyReportsResponse with GBV privacy applied server-side
      const { data: reports, isLoading: reportsLoading, error: reportsError } = useQuery(...)

      // GET /api/v1/citizen/stats — fetch personal analytics from backend
      // Returns CitizenStatsResponse with total_reports, resolved_count, avg_resolution_days, municipality_avg
      const { data: stats, isLoading: statsLoading, error: statsError } = useQuery(...)

      return { reports, stats, isLoading: reportsLoading || statsLoading, error: reportsError || statsError }
    }
    ```
    Use the Supabase client or fetch with the auth token from the existing auth context.
    The backend endpoint (Plan 08) already handles GBV privacy filtering server-side.
    Include a fallback: if API fails (e.g., during development), show a "Could not load reports" error state with retry button. Do NOT fall back to mock data in production.
    For DEVELOPMENT/DEMO purposes only: if no auth session exists, show mock data with a visible banner "Demo Mode - Sign in to see your real reports". This ensures the UI is testable without authentication.

    **1. Create CitizenPortalPage.tsx:**
    - Page title: "My Reports"
    - **Auth check**: On mount, check Supabase auth session. If no session, redirect to login page or show "Please sign in to view your reports" with a sign-in button.
    - Use `useCitizenReports()` hook to fetch real data from backend
    - Layout:
      ```
      ┌─────────────────────────────────────────────────┐
      │  My Reports                  [Report New Issue]  │
      ├─────────────────────────────────────────────────┤
      │  Personal Stats (3 glassmorphism cards)          │
      │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │
      │  │ 12       │ │ 9        │ │ 2.3 days │        │
      │  │ Total    │ │ Resolved │ │ Avg Time │        │
      │  └──────────┘ └──────────┘ └──────────┘        │
      ├─────────────────────────────────────────────────┤
      │  Comparison banner                               │
      │  "Your avg resolution: 2.3 days | Municipal     │
      │   avg: 3.1 days — 25% faster"                   │
      ├─────────────────────────────────────────────────┤
      │  Ticket List                                     │
      │  ┌─────────────────────────────────────────┐    │
      │  │ Regular Ticket Card (full details)       │    │
      │  └─────────────────────────────────────────┘    │
      │  ┌─────────────────────────────────────────┐    │
      │  │ GBV Case Card (limited info + lock)      │    │
      │  └─────────────────────────────────────────┘    │
      └─────────────────────────────────────────────────┘
      ```
    - Show skeleton loaders while data is loading from API
    - Show error state with retry button if API call fails
    - "Report New Issue" button: links to /report page

    **2. Create PersonalStats.tsx:**
    - Receives `stats: CitizenStatsResponse` as prop from CitizenPortalPage (fetched via useCitizenReports hook)
    - Three GlassCard components in a row (responsive grid: 1 col mobile, 3 col desktop)
    - Stats from backend API response:
      - Total Reports: `stats.total_reports` (large number, teal color)
      - Resolved: `stats.resolved_count` (large number, teal color)
      - Avg Resolution: `stats.avg_resolution_days` days (large number, with unit; show "N/A" if null)
    - Each card uses `GlassCard variant="interactive"` with glow
    - Show skeleton loaders while stats are loading (loading prop)
    - Optional anime.js counter animation on mount when data arrives (check useReducedMotion)
    - Below stats: comparison banner in subtle card (only show if municipality_avg is available):
      "Your avg resolution time: {avg_resolution_days} days | Municipality avg: {municipality_avg_resolution_days} days — You're {percentage}% faster/slower than average"
      (Use teal color for "faster", coral for "slower")

    **3. Create TicketCard.tsx (for regular municipal tickets):**
    - GlassCard with full ticket details:
      - Tracking number (e.g., TKT-20260211-A3F9B2) in monospace font
      - Status badge (using shared Badge component)
      - Title and description (truncated to 2 lines)
      - Reported date (relative: "2 days ago") and ward
      - Assigned to: worker name and role
      - Photos count (e.g., "3 attachments" with paperclip icon)
      - "View Details" button (ghost variant)
    - Hover: subtle lift effect

    **4. Create GBVCaseCard.tsx (for sensitive/GBV cases):**
    - GlassCard with STRICT limited information (locked decision):
      - Top row: Shield/alert icon (red) + "GBV Case (Private)" + Lock icon (right-aligned)
      - Status: status text only (Open, Under Investigation, Resolved)
      - Assigned SAPS Officer: officer name and rank
      - Police Station: station name
      - Contact: station phone number (clickable tel: link)
    - Emergency contacts section at bottom (prominent, red-tinted background):
      ```
      Emergency Contacts
      Police: 10111 (clickable tel: link)
      GBV Helpline: 0800 150 150 (clickable tel: link)
      ```
    - "Details Hidden for Privacy" — disabled button explaining why
    - Visual distinction: slight red-tinted border or left accent to differentiate from regular tickets
    - NO: address, photos, description, detailed notes, evidence — NEVER show these

    **5. Create MyReportsList.tsx:**
    - Receives `reports: CitizenMyReportsResponse` as prop from CitizenPortalPage (fetched via useCitizenReports hook)
    - Renders list of tickets (both types) from the API response
    - For each ticket, check `is_sensitive`:
      - `true` → render `<GBVCaseCard />` (backend already filtered to limited fields)
      - `false` → render `<TicketCard />`
    - Filter tabs at top: "All Reports", "Open", "Resolved" (can use client-side filter on fetched data, or pass status param to API for server-side filter)
    - Sort: newest first by default (server returns this order)
    - Show skeleton loaders during data fetch (loading prop)
    - Empty state: "No reports yet. Report your first issue to get started."
    - Error state: "Could not load reports. [Retry]" button

    **6. Add route in App.tsx:**
    - Add route: `/my-reports` → CitizenPortalPage
    - Add link in PublicHeader navigation: "My Reports" (shown after other links)
    - **Auth guard**: Wrap the `/my-reports` route with an auth check. If user is not authenticated (no Supabase session), redirect to login or show "Please sign in" page. Use the same Supabase auth pattern as the municipal dashboard.

    **7. Add styles to App.css:**
    - GBV case card emergency section styling (red-tinted background)
    - Comparison banner styling
    - Stats grid responsive layout
    - Filter tabs styling
  </action>
  <verify>
    - `ls frontend-public/src/pages/CitizenPortalPage.tsx` — page exists
    - `ls frontend-public/src/hooks/useCitizenReports.ts` — API hook exists
    - `ls frontend-public/src/components/citizen/GBVCaseCard.tsx frontend-public/src/components/citizen/TicketCard.tsx frontend-public/src/components/citizen/PersonalStats.tsx frontend-public/src/components/citizen/MyReportsList.tsx` — all components exist
    - `grep "citizen/my-reports\|citizen/stats" frontend-public/src/hooks/useCitizenReports.ts` — fetches from backend API
    - `grep "useCitizenReports" frontend-public/src/pages/CitizenPortalPage.tsx` — page uses API hook
    - `grep "is_sensitive" frontend-public/src/components/citizen/MyReportsList.tsx` — conditional rendering
    - `grep "10111" frontend-public/src/components/citizen/GBVCaseCard.tsx` — emergency police number
    - `grep "0800 150 150\|0800150150" frontend-public/src/components/citizen/GBVCaseCard.tsx` — GBV helpline
    - `grep "Lock\|lock\|Private" frontend-public/src/components/citizen/GBVCaseCard.tsx` — lock icon / privacy indication
    - `grep "my-reports" frontend-public/src/App.tsx` — route configured
    - `cd frontend-public && npx tsc --noEmit` — TypeScript compiles
  </verify>
  <done>
    Citizen "My Reports" portal fetches real data from GET /api/v1/citizen/my-reports and GET /api/v1/citizen/stats backend endpoints. Personal analytics (total, resolved, avg time, municipality comparison) displayed from backend aggregations. GBV privacy enforced server-side (limited fields only). Regular tickets show full details. Auth guard redirects unauthenticated users. Skeleton loaders during data fetch. Error state with retry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance heatmap with time filter, category toggle, and click-to-drill</name>
  <files>
    frontend-public/src/components/HeatmapViewer.tsx
    frontend-public/src/App.css
  </files>
  <action>
    **Enhance the existing HeatmapViewer.tsx with interactive controls.**

    Read the current HeatmapViewer.tsx first to understand the existing implementation.

    **1. Add time filter slider:**
    - Range slider above the map: "Time Range: [7] — [365] days"
    - Default: 30 days
    - Shows selected value prominently: "Showing last 30 days"
    - Style: custom range input with teal track color
    - Filter: only show heatmap points from tickets created within the time range
    - NOTE: Since the heatmap data comes from Supabase RLS views, filtering may need to be client-side on the fetched data, or the slider can be for UI demonstration purposes with mock data

    **2. Add category toggle filters:**
    - Row of pill-shaped toggles below time slider:
      - "All" (default, selected)
      - "Potholes"
      - "Water"
      - "Electricity"
      - "Sewage"
      - "Other"
    - Active: coral pill
    - Inactive: transparent with border
    - Multiple selection allowed (checkboxes under the hood)
    - Filter heatmap points by selected categories
    - NOTE: Category data may not be available in current heatmap view. If the existing data doesn't have category info, make the toggles render but show a "Category data coming soon" tooltip

    **3. Add click-to-drill interaction:**
    - When user clicks on a hot area of the heatmap:
      - Show a popup (Leaflet Popup) with:
        - Area/ward name (or "Ward X" placeholder)
        - Total tickets in area
        - Category breakdown (if available): e.g., "Potholes: 15, Water: 8, Electricity: 3"
        - "View Municipality Dashboard →" link to /dashboard
    - Use Leaflet's built-in Popup component
    - If heatmap data doesn't support click-to-drill natively, add a `CircleMarker` layer under the heatmap for clickable areas

    **4. Style the controls:**
    - Controls container: glassmorphism background above the map
    - Pill toggles: use shared Badge component styling pattern
    - Slider: custom CSS for range input (teal accent on WebKit and Firefox)
    - Mobile: stack controls vertically, make pills scrollable horizontally

    **5. Responsive layout:**
    - Desktop: controls in a row above map
    - Mobile: controls stack vertically, pills scroll horizontally

    **Build verification:**
    Run `cd frontend-public && npm run build` to verify everything compiles.
  </action>
  <verify>
    - `grep "timeFilter\|time.*filter\|time.*range" frontend-public/src/components/HeatmapViewer.tsx` — time filter exists
    - `grep "category\|issueType\|toggle" frontend-public/src/components/HeatmapViewer.tsx` — category filters exist
    - `grep "Popup\|popup" frontend-public/src/components/HeatmapViewer.tsx` — click-to-drill popup
    - `cd frontend-public && npm run build` — builds successfully
  </verify>
  <done>
    Heatmap enhanced with time range slider (7-365 days), category toggle pills, and click-to-drill popups showing area breakdown. Controls styled with glassmorphism above the map. Responsive layout for mobile.
  </done>
</task>

</tasks>

<verification>
1. Citizen portal fetches data from GET /api/v1/citizen/my-reports (not mock/hardcoded)
2. Personal stats fetched from GET /api/v1/citizen/stats (not mock/hardcoded)
3. GBV case cards show ONLY: status, SAPS officer, station phone, emergency numbers (server-side filtering)
4. Regular ticket cards show full details including tracking number, status, assigned worker
5. Emergency numbers (10111, 0800 150 150) are clickable tel: links
6. Auth guard redirects unauthenticated users to login
7. Skeleton loaders shown during API data fetch
8. Heatmap has time filter slider
9. Heatmap has category toggle pills
10. Heatmap has click-to-drill popup
11. `npm run build` succeeds for public app
</verification>

<success_criteria>
- Citizens can view their personal report history and analytics from real backend data
- Personal analytics are computed server-side (including municipality comparison)
- GBV victims see limited but useful info: case status and how to reach their assigned officer (privacy enforced server-side)
- Emergency numbers are always prominent and clickable
- Page requires authentication; unauthenticated users are redirected
- Heatmap provides meaningful data exploration with filters
- All components use shared design system
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-06-SUMMARY.md`
</output>
