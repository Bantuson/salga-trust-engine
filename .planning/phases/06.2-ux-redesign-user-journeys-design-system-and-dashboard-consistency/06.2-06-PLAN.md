---
phase: 06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency
plan: 06
type: execute
wave: 3
depends_on: ["06.2-01", "06.2-02"]
files_modified:
  - frontend-public/src/pages/CitizenPortalPage.tsx
  - frontend-public/src/components/citizen/MyReportsList.tsx
  - frontend-public/src/components/citizen/PersonalStats.tsx
  - frontend-public/src/components/citizen/GBVCaseCard.tsx
  - frontend-public/src/components/citizen/TicketCard.tsx
  - frontend-public/src/components/HeatmapViewer.tsx
  - frontend-public/src/App.tsx
  - frontend-public/src/App.css
autonomous: true

must_haves:
  truths:
    - "Citizen 'My Reports' page shows personal analytics (total, resolved, avg time)"
    - "GBV cases show limited info with lock icon: status, assigned SAPS officer, station phone, emergency numbers"
    - "Regular tickets show full details: title, description, assigned worker, photos count"
    - "Emergency contacts (10111, 0800 150 150) are prominently displayed on GBV case cards"
    - "Enhanced heatmap has time filter slider, category toggle, and click-to-drill interaction"
  artifacts:
    - path: "frontend-public/src/pages/CitizenPortalPage.tsx"
      provides: "Authenticated citizen My Reports dashboard"
      contains: "CitizenPortalPage"
    - path: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      provides: "Privacy-preserving GBV case display card"
      contains: "GBVCaseCard"
    - path: "frontend-public/src/components/citizen/PersonalStats.tsx"
      provides: "Personal analytics cards (total, resolved, avg time)"
      contains: "PersonalStats"
    - path: "frontend-public/src/components/HeatmapViewer.tsx"
      provides: "Enhanced interactive heatmap with filters"
      contains: "HeatmapViewer"
  key_links:
    - from: "frontend-public/src/components/citizen/MyReportsList.tsx"
      to: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      via: "conditional rendering based on is_sensitive flag"
      pattern: "is_sensitive"
    - from: "frontend-public/src/components/citizen/GBVCaseCard.tsx"
      to: "Emergency contacts"
      via: "prominently displayed phone numbers"
      pattern: "10111.*0800 150 150"
---

<objective>
Build the citizen "My Reports" authenticated portal with personal analytics and GBV privacy UI, and enhance the heatmap with interactive filters (time range, category toggle, click-to-drill).

Purpose: Citizens need to track their reported issues and view personal analytics. GBV victims need to see case status + assigned SAPS officer contact without exposing sensitive details (locked decision). The heatmap needs full interactivity for meaningful transparency data exploration.

Output: Citizen portal page with reports list, personal stats, GBV privacy cards, and enhanced interactive heatmap.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-CONTEXT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-RESEARCH.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-01-SUMMARY.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-02-SUMMARY.md
@frontend-public/src/components/HeatmapViewer.tsx
@frontend-public/src/pages/PublicDashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create citizen "My Reports" portal with personal analytics and GBV privacy UI</name>
  <files>
    frontend-public/src/pages/CitizenPortalPage.tsx
    frontend-public/src/components/citizen/MyReportsList.tsx
    frontend-public/src/components/citizen/PersonalStats.tsx
    frontend-public/src/components/citizen/GBVCaseCard.tsx
    frontend-public/src/components/citizen/TicketCard.tsx
    frontend-public/src/App.tsx
    frontend-public/src/App.css
  </files>
  <action>
    **NOTE: This page exists in the PUBLIC site conceptually but requires authentication. In practice, citizens would authenticate through the municipal dashboard. For Phase 6.2, we build the UI components and page as a reference implementation. The actual authentication flow integration is deferred.**

    **1. Create CitizenPortalPage.tsx:**
    - Page title: "My Reports"
    - Layout:
      ```
      ┌─────────────────────────────────────────────────┐
      │  My Reports                  [Report New Issue]  │
      ├─────────────────────────────────────────────────┤
      │  Personal Stats (3 glassmorphism cards)          │
      │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │
      │  │ 12       │ │ 9        │ │ 2.3 days │        │
      │  │ Total    │ │ Resolved │ │ Avg Time │        │
      │  └──────────┘ └──────────┘ └──────────┘        │
      ├─────────────────────────────────────────────────┤
      │  Comparison banner (optional)                    │
      │  "Your avg resolution: 2.3 days | Municipal     │
      │   avg: 3.1 days — 25% faster"                   │
      ├─────────────────────────────────────────────────┤
      │  Ticket List                                     │
      │  ┌─────────────────────────────────────────┐    │
      │  │ Regular Ticket Card (full details)       │    │
      │  └─────────────────────────────────────────┘    │
      │  ┌─────────────────────────────────────────┐    │
      │  │ GBV Case Card (limited info + lock)      │    │
      │  └─────────────────────────────────────────┘    │
      └─────────────────────────────────────────────────┘
      ```
    - Uses MOCK data (hardcoded array of tickets) since we can't authenticate in the public app
    - Include mix of regular tickets and one GBV case for demonstration
    - "Report New Issue" button: links to /report page

    **2. Create PersonalStats.tsx:**
    - Three GlassCard components in a row (responsive grid: 1 col mobile, 3 col desktop)
    - Stats (mock data):
      - Total Reports: 12 (large number, teal color)
      - Resolved: 9 (large number, teal color)
      - Avg Resolution: 2.3 days (large number, with unit)
    - Each card uses `GlassCard variant="interactive"` with glow
    - Optional anime.js counter animation on mount (check useReducedMotion)
    - Below stats: comparison banner in subtle card:
      "Your avg resolution time: 2.3 days | Municipality avg: 3.1 days — You're 25% faster than average"
      (Use teal color for "25% faster" to indicate positive)

    **3. Create TicketCard.tsx (for regular municipal tickets):**
    - GlassCard with full ticket details:
      - Tracking number (e.g., TKT-20260211-A3F9B2) in monospace font
      - Status badge (using shared Badge component)
      - Title and description (truncated to 2 lines)
      - Reported date (relative: "2 days ago") and ward
      - Assigned to: worker name and role
      - Photos count (e.g., "3 attachments" with paperclip icon)
      - "View Details" button (ghost variant)
    - Hover: subtle lift effect

    **4. Create GBVCaseCard.tsx (for sensitive/GBV cases):**
    - GlassCard with STRICT limited information (locked decision):
      - Top row: Shield/alert icon (red) + "GBV Case (Private)" + Lock icon (right-aligned)
      - Status: status text only (Open, Under Investigation, Resolved)
      - Assigned SAPS Officer: officer name and rank
      - Police Station: station name
      - Contact: station phone number (clickable tel: link)
    - Emergency contacts section at bottom (prominent, red-tinted background):
      ```
      Emergency Contacts
      Police: 10111 (clickable tel: link)
      GBV Helpline: 0800 150 150 (clickable tel: link)
      ```
    - "Details Hidden for Privacy" — disabled button explaining why
    - Visual distinction: slight red-tinted border or left accent to differentiate from regular tickets
    - NO: address, photos, description, detailed notes, evidence — NEVER show these

    **5. Create MyReportsList.tsx:**
    - Renders list of tickets (both types)
    - For each ticket, check `is_sensitive`:
      - `true` → render `<GBVCaseCard />`
      - `false` → render `<TicketCard />`
    - Filter tabs at top: "All Reports", "Open", "Resolved" (simple client-side filter)
    - Sort: newest first by default
    - Empty state: "No reports yet. Report your first issue to get started."

    **6. Add route in App.tsx:**
    - Add route: `/my-reports` → CitizenPortalPage
    - Add link in PublicHeader navigation: "My Reports" (shown after other links)
    - Note: In production this would require auth. For now, it's publicly accessible with mock data.

    **7. Add styles to App.css:**
    - GBV case card emergency section styling (red-tinted background)
    - Comparison banner styling
    - Stats grid responsive layout
    - Filter tabs styling
  </action>
  <verify>
    - `ls frontend-public/src/pages/CitizenPortalPage.tsx` — page exists
    - `ls frontend-public/src/components/citizen/GBVCaseCard.tsx frontend-public/src/components/citizen/TicketCard.tsx frontend-public/src/components/citizen/PersonalStats.tsx frontend-public/src/components/citizen/MyReportsList.tsx` — all components exist
    - `grep "is_sensitive" frontend-public/src/components/citizen/MyReportsList.tsx` — conditional rendering
    - `grep "10111" frontend-public/src/components/citizen/GBVCaseCard.tsx` — emergency police number
    - `grep "0800 150 150\|0800150150" frontend-public/src/components/citizen/GBVCaseCard.tsx` — GBV helpline
    - `grep "Lock\|lock\|Private" frontend-public/src/components/citizen/GBVCaseCard.tsx` — lock icon / privacy indication
    - `grep "my-reports" frontend-public/src/App.tsx` — route configured
    - `cd frontend-public && npx tsc --noEmit` — TypeScript compiles
  </verify>
  <done>
    Citizen "My Reports" portal with personal analytics (total, resolved, avg time), comparison banner, regular ticket cards with full details, and GBV privacy cards showing only status + SAPS officer + station phone + emergency numbers. Filter tabs and responsive layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance heatmap with time filter, category toggle, and click-to-drill</name>
  <files>
    frontend-public/src/components/HeatmapViewer.tsx
    frontend-public/src/App.css
  </files>
  <action>
    **Enhance the existing HeatmapViewer.tsx with interactive controls.**

    Read the current HeatmapViewer.tsx first to understand the existing implementation.

    **1. Add time filter slider:**
    - Range slider above the map: "Time Range: [7] — [365] days"
    - Default: 30 days
    - Shows selected value prominently: "Showing last 30 days"
    - Style: custom range input with teal track color
    - Filter: only show heatmap points from tickets created within the time range
    - NOTE: Since the heatmap data comes from Supabase RLS views, filtering may need to be client-side on the fetched data, or the slider can be for UI demonstration purposes with mock data

    **2. Add category toggle filters:**
    - Row of pill-shaped toggles below time slider:
      - "All" (default, selected)
      - "Potholes"
      - "Water"
      - "Electricity"
      - "Sewage"
      - "Other"
    - Active: coral pill
    - Inactive: transparent with border
    - Multiple selection allowed (checkboxes under the hood)
    - Filter heatmap points by selected categories
    - NOTE: Category data may not be available in current heatmap view. If the existing data doesn't have category info, make the toggles render but show a "Category data coming soon" tooltip

    **3. Add click-to-drill interaction:**
    - When user clicks on a hot area of the heatmap:
      - Show a popup (Leaflet Popup) with:
        - Area/ward name (or "Ward X" placeholder)
        - Total tickets in area
        - Category breakdown (if available): e.g., "Potholes: 15, Water: 8, Electricity: 3"
        - "View Municipality Dashboard →" link to /dashboard
    - Use Leaflet's built-in Popup component
    - If heatmap data doesn't support click-to-drill natively, add a `CircleMarker` layer under the heatmap for clickable areas

    **4. Style the controls:**
    - Controls container: glassmorphism background above the map
    - Pill toggles: use shared Badge component styling pattern
    - Slider: custom CSS for range input (teal accent on WebKit and Firefox)
    - Mobile: stack controls vertically, make pills scrollable horizontally

    **5. Responsive layout:**
    - Desktop: controls in a row above map
    - Mobile: controls stack vertically, pills scroll horizontally

    **Build verification:**
    Run `cd frontend-public && npm run build` to verify everything compiles.
  </action>
  <verify>
    - `grep "timeFilter\|time.*filter\|time.*range" frontend-public/src/components/HeatmapViewer.tsx` — time filter exists
    - `grep "category\|issueType\|toggle" frontend-public/src/components/HeatmapViewer.tsx` — category filters exist
    - `grep "Popup\|popup" frontend-public/src/components/HeatmapViewer.tsx` — click-to-drill popup
    - `cd frontend-public && npm run build` — builds successfully
  </verify>
  <done>
    Heatmap enhanced with time range slider (7-365 days), category toggle pills, and click-to-drill popups showing area breakdown. Controls styled with glassmorphism above the map. Responsive layout for mobile.
  </done>
</task>

</tasks>

<verification>
1. Citizen portal shows personal stats with 3 metrics cards
2. GBV case cards show ONLY: status, SAPS officer, station phone, emergency numbers
3. Regular ticket cards show full details including tracking number, status, assigned worker
4. Emergency numbers (10111, 0800 150 150) are clickable tel: links
5. Heatmap has time filter slider
6. Heatmap has category toggle pills
7. Heatmap has click-to-drill popup
8. `npm run build` succeeds for public app
</verification>

<success_criteria>
- Citizens can view their personal report history and analytics
- GBV victims see limited but useful info: case status and how to reach their assigned officer
- Emergency numbers are always prominent and clickable
- Heatmap provides meaningful data exploration with filters
- All components use shared design system
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-06-SUMMARY.md`
</output>
