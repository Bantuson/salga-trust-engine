---
phase: 02-agentic-ai-system
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/agents/crews/gbv_crew.py
  - src/agents/prompts/gbv.py
  - src/agents/tools/saps_tool.py
  - src/agents/flows/intake_flow.py
  - tests/test_gbv_crew.py
autonomous: true

must_haves:
  truths:
    - "GBV specialist crew captures sensitive reports with empathetic, trauma-informed prompts"
    - "GBV crew has memory disabled to prevent data leakage across sessions"
    - "GBV conversations use separate Redis namespace from municipal conversations"
    - "GBV tickets are flagged as is_sensitive=True in the database"
    - "SAPS notification is generated when GBV ticket is created"
    - "GBV session is automatically cleared from Redis after ticket creation"
    - "Agent responds in citizen's language (EN/ZU/AF) throughout GBV intake"
  artifacts:
    - path: "src/agents/crews/gbv_crew.py"
      provides: "GBV specialist crew with enhanced privacy controls"
      contains: "class GBVCrew"
    - path: "src/agents/prompts/gbv.py"
      provides: "Trilingual trauma-informed GBV intake prompts"
      contains: "GBV_INTAKE_PROMPTS"
    - path: "src/agents/tools/saps_tool.py"
      provides: "SAPS station notification tool"
      contains: "notify_saps"
  key_links:
    - from: "src/agents/crews/gbv_crew.py"
      to: "src/agents/tools/ticket_tool.py"
      via: "create_municipal_ticket with is_sensitive=True"
      pattern: "is_sensitive"
    - from: "src/agents/crews/gbv_crew.py"
      to: "src/agents/tools/saps_tool.py"
      via: "SAPS notification after ticket creation"
      pattern: "notify_saps"
    - from: "src/agents/flows/intake_flow.py"
      to: "src/agents/crews/gbv_crew.py"
      via: "GBV routing from Flow"
      pattern: "GBVCrew"
---

<objective>
Build the GBV specialist crew with enhanced privacy controls, trauma-informed prompts, and SAPS notification capability, then wire it into the existing IntakeFlow.

Purpose: GBV/domestic violence reports require fundamentally different handling from municipal services (AI-04). This crew must be empathetic, collect minimal required information, ensure data isolation, disable agent memory, route to SAPS, and clear session data after ticket creation.

Output: GBVCrew, SAPS notification tool, trilingual GBV prompts, updated IntakeFlow with GBV routing, comprehensive unit tests.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agentic-ai-system/02-RESEARCH.md
@.planning/phases/02-agentic-ai-system/02-01-SUMMARY.md
@.planning/phases/02-agentic-ai-system/02-02-SUMMARY.md

# Artifacts from prior plans
@src/agents/flows/intake_flow.py
@src/agents/flows/state.py
@src/agents/crews/municipal_crew.py
@src/agents/tools/ticket_tool.py
@src/core/conversation.py
@src/models/ticket.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: GBV prompts, SAPS notification tool, and GBV crew</name>
  <files>
    src/agents/prompts/gbv.py
    src/agents/tools/saps_tool.py
    src/agents/crews/gbv_crew.py
  </files>
  <action>
1. Create `src/agents/prompts/gbv.py`:
   - Define GBV_INTAKE_PROMPTS dict keyed by language ("en", "zu", "af"):

   English prompt:
   - Role: You are a trained crisis support agent. Your primary concern is the safety of the person reporting.
   - Tone: Empathetic, non-judgmental, calm. Never blame the victim.
   - Information to collect (MINIMUM needed, do NOT over-question):
     - Type of incident (verbal abuse, physical abuse, sexual abuse, other)
     - When it happened (approximate - today, yesterday, ongoing)
     - Location where they need help or feel safe
     - Whether they are currently in immediate danger
     - Whether children are involved
   - NEVER ask for perpetrator identification details in this system (SAPS handles investigation)
   - ALWAYS provide emergency number: 10111 (SAPS) or 0800 150 150 (GBV Command Centre)
   - End with reassurance that help is being arranged

   isiZulu prompt:
   - Same structure in isiZulu, including:
     - "Uxolo ngalokhu okudlule kukho" (Sorry for what you're going through)
     - Emergency numbers: 10111 (SAPS) noma 0800 150 150
     - Few-shot conversation example in isiZulu

   Afrikaans prompt:
   - Same structure in Afrikaans, including:
     - "Ek is jammer vir wat jy deurgaan" (Sorry for what you're going through)
     - Emergency numbers: 10111 (SAPS) of 0800 150 150
     - Few-shot conversation example in Afrikaans

   - Define GBV_CLASSIFICATION_KEYWORDS: list of keywords in all 3 languages that indicate GBV:
     EN: ["domestic violence", "abuse", "hitting me", "beats me", "rape", "sexual assault", "threatened"]
     ZU: ["uyangihlukumeza", "uyangishaya", "ukudlwengula", "udlame lwasekhaya"]
     AF: ["huishoudelike geweld", "mishandeling", "slaan my", "verkragting"]

2. Create `src/agents/tools/saps_tool.py`:
   - Import `from crewai.tools import tool`

   - Define `@tool` decorated function `notify_saps`:
     - Args: ticket_id (str), tracking_number (str), incident_type (str), location (str), is_immediate_danger (bool), tenant_id (str)
     - For v1: This tool does NOT integrate with SAPS API (none exists).
     - Instead, it creates a SAPS notification record:
       - Log the notification with structured data (ticket_id, timestamp, incident_type, location, danger_level)
       - In production, this would send encrypted email to configured SAPS liaison per municipality
       - For now, return {"notified": True, "method": "internal_log", "ticket_id": ticket_id, "message": "SAPS notification queued for configured liaison"}
     - Use Python logging with a dedicated "saps_notifications" logger at WARNING level
       so these are always captured regardless of log level config
     - NEVER log victim identifying information (no names, phone numbers, etc.)

3. Create `src/agents/crews/gbv_crew.py`:
   - Import Agent, Crew, Task, Process from crewai
   - Import GBV_INTAKE_PROMPTS from src.agents.prompts.gbv
   - Import create_municipal_ticket from src.agents.tools.ticket_tool
   - Import notify_saps from src.agents.tools.saps_tool
   - Import TicketData from src.schemas.ticket

   - Class `GBVCrew`:
     - `__init__(self, language: str = "en", llm_model: str = "gpt-4o")`:
       - Store language, llm_model

     - Method `create_crew(self, message: str, user_id: str, tenant_id: str) -> Crew`:
       - Create Agent:
         - role: "Crisis Support Specialist"
         - goal: f"Safely capture GBV report details in {language} and arrange help"
         - backstory: GBV_INTAKE_PROMPTS[self.language]
         - tools: [create_municipal_ticket, notify_saps]
         - llm: self.llm_model
         - allow_delegation: False
         - max_iter: 8 (shorter than municipal - don't over-question victims)
         - verbose: False
       - Create Task:
         - description: Intake for GBV report, collect minimum required info, create ticket with is_sensitive=True, notify SAPS
         - expected_output: "Ticket created with SAPS notification. Provide tracking number and emergency contact info."
         - agent: gbv_agent
         - output_pydantic: TicketData (category forced to "gbv")
       - Return Crew:
         - agents=[gbv_agent], tasks=[gbv_task]
         - process=Process.sequential
         - memory=False  # CRITICAL: Disable memory per research Pitfall 3
         - verbose=False

     - Method `async kickoff(self, message: str, user_id: str, tenant_id: str) -> dict`:
       - Create crew via create_crew()
       - Run crew.kickoff()
       - After successful kickoff, always ensure:
         - Ticket has is_sensitive=True
         - SAPS notification was triggered
       - Return result dict
       - Handle errors gracefully: return {"error": str(e)}

   - Update `src/agents/crews/__init__.py` to export GBVCrew
  </action>
  <verify>
    `python -c "from src.agents.crews.gbv_crew import GBVCrew; print('OK')"` imports without error.
    `python -c "from src.agents.tools.saps_tool import notify_saps; print(notify_saps.name)"` shows tool name.
    `python -c "from src.agents.prompts.gbv import GBV_INTAKE_PROMPTS; print(list(GBV_INTAKE_PROMPTS.keys()))"` shows ["en", "zu", "af"].
  </verify>
  <done>
    GBV crew configured with trauma-informed prompts in 3 languages, memory disabled, SAPS notification tool ready, emergency numbers always provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire GBV crew into IntakeFlow and create comprehensive tests</name>
  <files>
    src/agents/flows/intake_flow.py
    tests/test_gbv_crew.py
  </files>
  <action>
1. Update `src/agents/flows/intake_flow.py`:
   - Import GBVCrew from src.agents.crews.gbv_crew
   - Import ConversationManager from src.core.conversation

   - Update the `handle_gbv` method (currently a placeholder):
     - Create GBVCrew with detected language
     - Run crew kickoff with message, user_id, tenant_id
     - Store result in self.state.ticket_data
     - After successful ticket creation, clear GBV session:
       Call conversation_manager.clear_session(user_id, session_id, is_gbv=True)
     - Set self.state.is_complete = True
     - Return result

   - Add a post-routing safety check method:
     - If category is "gbv" but routing_confidence < 0.8, add a confirmation step
       in the state: "It sounds like you may be reporting a safety concern. Can you confirm?"
     - This prevents false GBV routing on ambiguous messages

2. Create `tests/test_gbv_crew.py` (unit tests):
   - Mock ALL LLM calls and database operations
   - Test GBVCrew instantiation:
     - Verify memory=False on created Crew
     - Verify agent has correct tools (create_municipal_ticket, notify_saps)
     - Verify max_iter=8 (not higher)
   - Test GBV prompt content:
     - English prompt contains emergency numbers (10111, 0800 150 150)
     - isiZulu prompt contains emergency numbers
     - Afrikaans prompt contains emergency numbers
     - No prompt asks for perpetrator identification
   - Test SAPS notification tool:
     - Returns structured notification dict
     - Does NOT log victim identifying information (mock logging, check no PII in log calls)
   - Test GBV routing in IntakeFlow:
     - Mock classify_message to return category="gbv"
     - Verify route_to_crew returns "gbv_intake"
     - Verify handle_gbv is called (not handle_municipal)
   - Test session clearing:
     - Mock ConversationManager.clear_session
     - Verify it's called with is_gbv=True after GBV ticket creation
   - Test GBV keyword detection:
     - "My husband hits me" -> routes to GBV
     - "Udlame lwasekhaya" -> routes to GBV
     - "Huishoudelike geweld" -> routes to GBV
   - Test is_sensitive flag:
     - When GBV ticket created, is_sensitive must be True

Run `pytest tests/test_gbv_crew.py -v` to verify.
  </action>
  <verify>
    `pytest tests/test_gbv_crew.py -v` passes all tests.
    `pytest tests/test_intake_flow.py tests/test_gbv_crew.py -v` -- both test files pass (no regressions in flow tests).
  </verify>
  <done>
    GBV crew fully wired into IntakeFlow. GBV messages route correctly with enhanced privacy: memory disabled, separate Redis namespace, session clearing after ticket creation, SAPS notification, emergency numbers always provided. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_gbv_crew.py -v` -- all GBV tests pass
2. `pytest tests/test_intake_flow.py -v` -- flow tests still pass (no regressions)
3. GBV crew has memory=False verified in tests
4. SAPS notification tool returns structured output
5. Emergency numbers present in all 3 language prompts
6. All Phase 1 tests still pass
</verification>

<success_criteria>
- GBV crew captures sensitive reports with trauma-informed, empathetic prompts in EN/ZU/AF
- Agent memory disabled for GBV crew (prevents cross-session data leakage)
- GBV conversations use separate Redis namespace
- GBV tickets marked is_sensitive=True
- SAPS notification generated on ticket creation
- Session cleared from Redis after GBV ticket creation
- Emergency numbers (10111, 0800 150 150) provided in all responses
- All tests pass with mocked LLM and database
</success_criteria>

<output>
After completion, create `.planning/phases/02-agentic-ai-system/02-03-SUMMARY.md`
</output>
