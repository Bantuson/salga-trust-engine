---
phase: 10-render-staging-deployment-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - render.yaml
  - tests/test_render_config.py
autonomous: true
requirements:
  - TKT-01
  - SEC-01
  - SEC-04
  - RPT-01

must_haves:
  truths:
    - "Celery worker starts correctly on Render with src.tasks.celery_app module path"
    - "SUPABASE_JWT_SECRET is declared in salga-api envVars so JWT verification works in staging"
    - "TWILIO_WHATSAPP_NUMBER is the env var name in both salga-api and salga-celery (not TWILIO_WHATSAPP_FROM)"
    - "SUPABASE_JWT_SECRET is also declared in salga-celery envVars for defensive consistency"
    - "CI catches future render.yaml configuration drift via automated test"
  artifacts:
    - path: "render.yaml"
      provides: "Corrected Render Blueprint with all 3 bugs fixed"
      contains: "src.tasks.celery_app"
    - path: "tests/test_render_config.py"
      provides: "Automated validation of render.yaml against code expectations"
      min_lines: 40
  key_links:
    - from: "render.yaml (salga-celery startCommand)"
      to: "src/tasks/celery_app.py"
      via: "celery -A module path"
      pattern: "src\\.tasks\\.celery_app"
    - from: "render.yaml (salga-api envVars)"
      to: "src/core/security.py"
      via: "SUPABASE_JWT_SECRET env var"
      pattern: "SUPABASE_JWT_SECRET"
    - from: "render.yaml (salga-api + salga-celery envVars)"
      to: "src/core/config.py"
      via: "TWILIO_WHATSAPP_NUMBER env var name"
      pattern: "TWILIO_WHATSAPP_NUMBER"
---

<objective>
Fix three deployment configuration bugs in render.yaml that collectively break Celery background tasks, JWT authentication, and Twilio WhatsApp notifications in staging. Add a unit test to prevent future configuration drift.

Purpose: Unblock staging deployment — without these fixes, the Celery worker fails to start (breaking SLA checks and status notifications), all authenticated API endpoints return 401 (breaking the municipal dashboard), and WhatsApp notifications silently fail (breaking citizen status updates).

Output: Corrected render.yaml with all three bugs fixed, plus tests/test_render_config.py that validates the configuration matches code expectations.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-render-staging-deployment-fixes/10-RESEARCH.md
@render.yaml
@src/tasks/celery_app.py
@src/core/config.py
@src/core/security.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix three render.yaml deployment bugs</name>
  <files>render.yaml</files>
  <action>
Fix three specific bugs in render.yaml. All three are one-line changes:

**Bug 1 — Celery startCommand (line 91):**
Change `celery -A src.celery_app worker --loglevel=info --concurrency=2`
to `celery -A src.tasks.celery_app worker --loglevel=info --concurrency=2`.
The Celery app is defined in `src/tasks/celery_app.py`, not `src/celery_app.py`. Both `src/tasks/sla_monitor.py` and `src/tasks/status_notify.py` import from `src.tasks.celery_app`.

**Bug 2 — Missing SUPABASE_JWT_SECRET:**
Add `SUPABASE_JWT_SECRET` with `sync: false` to the `salga-api` envVars block (after the SUPABASE_SERVICE_ROLE_KEY entry, around line 36). This env var is required by `src/core/security.py:verify_supabase_token()` — without it, `settings.SUPABASE_JWT_SECRET` is empty string and the function returns `None` for every token, breaking all authenticated endpoints.

Also add `SUPABASE_JWT_SECRET` with `sync: false` to the `salga-celery` envVars block (after the SUPABASE_SERVICE_ROLE_KEY entry) for defensive consistency, in case future Celery tasks need JWT verification.

**Bug 3 — TWILIO_WHATSAPP_FROM -> TWILIO_WHATSAPP_NUMBER (two locations):**
In `salga-api` envVars (line 43): change `TWILIO_WHATSAPP_FROM` to `TWILIO_WHATSAPP_NUMBER`.
In `salga-celery` envVars (line 114): change `TWILIO_WHATSAPP_FROM` to `TWILIO_WHATSAPP_NUMBER`.
The canonical field name in `src/core/config.py` is `TWILIO_WHATSAPP_NUMBER`. Pydantic Settings with `extra="ignore"` silently drops the wrong-named env var, causing `settings.TWILIO_WHATSAPP_NUMBER` to always be empty string.

Do NOT change any other content in render.yaml. These are targeted fixes only.
  </action>
  <verify>
Verify the three fixes:
1. `grep "src.tasks.celery_app" render.yaml` returns the corrected startCommand line
2. `grep "SUPABASE_JWT_SECRET" render.yaml` returns entries in both salga-api and salga-celery
3. `grep "TWILIO_WHATSAPP_NUMBER" render.yaml` returns two entries (salga-api and salga-celery)
4. `grep "TWILIO_WHATSAPP_FROM" render.yaml` returns zero results (old name fully removed)
5. `grep "src.celery_app" render.yaml` returns only the corrected `src.tasks.celery_app` line (no bare `src.celery_app`)
  </verify>
  <done>
render.yaml contains: (1) `celery -A src.tasks.celery_app` in salga-celery startCommand, (2) `SUPABASE_JWT_SECRET` in both salga-api and salga-celery envVars, (3) `TWILIO_WHATSAPP_NUMBER` (not TWILIO_WHATSAPP_FROM) in both salga-api and salga-celery envVars. Zero occurrences of the old wrong values remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add render.yaml configuration validation test</name>
  <files>tests/test_render_config.py</files>
  <action>
Create `tests/test_render_config.py` that parses render.yaml using PyYAML (already available as transitive dependency) and asserts the three configuration requirements are met. This prevents future configuration drift by catching it in CI.

The test file should contain:

1. Helper functions:
   - `_load_render_yaml()` — reads and parses `render.yaml` from repo root using `Path(__file__).parent.parent / "render.yaml"`
   - `_get_service(config, name)` — finds a service by name in `config["services"]`
   - `_get_env_keys(service)` — returns set of env var key names from a service's `envVars` list

2. Test functions:
   - `test_celery_startcommand_uses_tasks_module()` — asserts `"src.tasks.celery_app"` appears in salga-celery's `startCommand`. Fails if the old `src.celery_app` path is used.
   - `test_supabase_jwt_secret_in_api()` — asserts `"SUPABASE_JWT_SECRET"` is in salga-api's envVars keys. Error message explains that `verify_supabase_token()` will always return None without it.
   - `test_supabase_jwt_secret_in_celery()` — asserts `"SUPABASE_JWT_SECRET"` is in salga-celery's envVars keys. Defensive consistency check.
   - `test_twilio_whatsapp_number_in_api()` — asserts `"TWILIO_WHATSAPP_NUMBER"` is present AND `"TWILIO_WHATSAPP_FROM"` is NOT present in salga-api envVars. Error message explains Pydantic `extra="ignore"` silently drops wrong-named vars.
   - `test_twilio_whatsapp_number_in_celery()` — same assertion for salga-celery service.

Each test should have a docstring explaining WHY the assertion matters (what breaks in staging without it). Use clear assertion messages that reference the relevant source file (e.g., "config.py field is TWILIO_WHATSAPP_NUMBER").

No new dependencies required — PyYAML is already available.
  </action>
  <verify>
Run the test file:
```bash
pytest tests/test_render_config.py -v
```
All 5 tests must pass. Verify with:
```bash
pytest tests/test_render_config.py -v --tb=short
```
  </verify>
  <done>
`tests/test_render_config.py` exists with 5 passing tests that validate: (1) Celery module path is `src.tasks.celery_app`, (2) SUPABASE_JWT_SECRET in salga-api, (3) SUPABASE_JWT_SECRET in salga-celery, (4) TWILIO_WHATSAPP_NUMBER (not TWILIO_WHATSAPP_FROM) in salga-api, (5) TWILIO_WHATSAPP_NUMBER (not TWILIO_WHATSAPP_FROM) in salga-celery. All pass with `pytest tests/test_render_config.py -v`.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_render_config.py -v` — all 5 tests pass
2. `grep -c "src.tasks.celery_app" render.yaml` returns at least 1
3. `grep -c "TWILIO_WHATSAPP_FROM" render.yaml` returns 0
4. `grep -c "SUPABASE_JWT_SECRET" render.yaml` returns at least 2
5. `pytest tests/ -v --tb=short -x` — full test suite still passes (no regressions)
</verification>

<success_criteria>
- render.yaml has all three bugs fixed (Celery path, JWT secret, Twilio env var name)
- tests/test_render_config.py has 5 passing tests that guard against configuration drift
- Full test suite passes with no regressions
- No application code changes required (this is purely configuration + test)
</success_criteria>

<output>
After completion, create `.planning/phases/10-render-staging-deployment-fixes/10-01-SUMMARY.md`
</output>
