---
phase: "10.1"
plan: "01"
subsystem: "auth"
tags: ["auth", "otp", "email-verification", "registration", "supabase", "frontend"]
dependency_graph:
  requires: []
  provides: ["email-otp-registration-flow", "signInWithEmailOtp", "verifyEmailOtp"]
  affects: ["frontend-public/auth", "frontend-dashboard/auth", "citizen-registration", "municipal-registration"]
tech_stack:
  added: []
  patterns: ["RegisterMode state machine", "supabase.auth.verifyOtp(type: 'email')", "supabase.auth.resend(type: 'signup')"]
key_files:
  created: []
  modified:
    - "frontend-public/src/contexts/AuthContext.tsx"
    - "frontend-public/src/pages/CitizenRegisterPage.tsx"
    - "frontend-dashboard/src/hooks/useAuth.ts"
    - "frontend-dashboard/src/pages/RegisterPage.tsx"
decisions:
  - "verifyOtp must use type: 'email' (not 'signup' or 'sms') to confirm email AND create session simultaneously"
  - "signInWithEmailOtp uses shouldCreateUser: false — OTP login must never create new accounts"
  - "Registration OTP uses direct supabase.auth.verifyOtp call in component (not via AuthContext) because it is a signup flow, not a login flow"
  - "supabase.auth.resend(type: 'signup') is the clean API for resending signup OTP (not calling signUp again)"
  - "After successful verifyOtp, Supabase creates an active session — no need to call signInWithPassword separately"
  - "OTP input auto-strips non-digits and caps at 6 chars via onChange handler for UX safety"
  - "Dead-end success screen ('check your email to verify') fully removed from both registration pages"
metrics:
  duration: "6.4 minutes (381 seconds)"
  completed: "2026-02-24"
  tasks: 2
  files: 4
---

# Phase 10.1 Plan 01: Email OTP Registration Fix Summary

**One-liner:** Replaced dead-end post-signup screens with inline 6-digit email OTP verification that creates an active Supabase session on both citizen and municipal registration pages.

## What Was Built

### Task 1: Email OTP methods added to both auth layers

**`frontend-public/src/contexts/AuthContext.tsx`**
- Added `signInWithEmailOtp(email)` to `AuthContextType` interface and `AuthProvider`
  - Uses `supabase.auth.signInWithOtp({ email, options: { shouldCreateUser: false } })`
  - Returns `Promise<void>` — login only, never creates accounts
- Added `verifyEmailOtp(email, token)` to `AuthContextType` interface and `AuthProvider`
  - Uses `supabase.auth.verifyOtp({ email, token, type: 'email' })`
  - Critical: `type: 'email'` (not 'sms') for email OTP
- Both methods added to the `value` object passed to `AuthContext.Provider`

**`frontend-dashboard/src/hooks/useAuth.ts`**
- Added same two methods (`signInWithEmailOtp`, `verifyEmailOtp`) following the same pattern
- Both return `data` (hook pattern) vs void (context pattern)
- Both added to the `useAuth()` return object

### Task 2: Inline OTP verification step on registration pages

**`frontend-public/src/pages/CitizenRegisterPage.tsx`**
- Replaced `success: boolean` with `RegisterMode = 'form' | 'verify-otp' | 'success'` state
- Added `registeredEmail`, `otpCode`, `resendMessage` state variables
- Added `useNavigate` import from react-router-dom; `supabase` import from `../lib/supabase`
- `handleRegister`: after `signUp()` succeeds — sets `registeredEmail(email)`, transitions to `mode('verify-otp')`
- `handleVerifyRegistrationOtp`: calls `supabase.auth.verifyOtp({ email: registeredEmail, token: otpCode, type: 'email' })`, then `navigate('/profile', { replace: true })`
- `handleResendCode`: calls `supabase.auth.resend({ type: 'signup', email: registeredEmail })`
- `verify-otp` render block: teal info box with email, 6-digit OTP input, "Verify Email" button, "Resend Code" link
- OTP input: `inputMode="numeric"`, `maxLength={6}`, `pattern="[0-9]{6}"`, `autoComplete="one-time-code"`, `textAlign: 'center'`, `letterSpacing: '0.5em'`, `fontSize: '1.5rem'`
- Dead-end "Account Created!" success screen removed entirely

**`frontend-dashboard/src/pages/RegisterPage.tsx`**
- Same pattern: `RegisterMode = 'form' | 'verify-otp'`
- Added `useNavigate` import; `supabase` already imported
- `handleRegister` updated: transitions to `verify-otp` mode instead of `setSuccess(true)`
- `handleVerifyRegistrationOtp`: same as citizen page but `navigate('/', { replace: true })`
- `handleResendCode`: same resend pattern
- `verify-otp` render block: same glassmorphic card, SALGA branding maintained
- Dead-end "Please check your email" success screen removed entirely

## Verification Results

1. `frontend-public && npx tsc --noEmit` — zero TypeScript errors
2. `frontend-dashboard && npx tsc --noEmit` — zero TypeScript errors
3. Both registration pages have `verify-otp` mode with 6-digit input
4. `AuthContext.tsx` exports `signInWithEmailOtp` and `verifyEmailOtp` (6 references)
5. `useAuth.ts` (dashboard) returns `signInWithEmailOtp` and `verifyEmailOtp` (4 references)
6. No references to `type: 'sms'` in email OTP code paths
7. `type: 'signup'` only appears in `supabase.auth.resend()` calls — not in `verifyOtp()` calls

## Deviations from Plan

None — plan executed exactly as written.

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | 4fcb535 | feat(10.1-01): add signInWithEmailOtp and verifyEmailOtp to both auth layers |
| Task 2 | cc513f5 | feat(10.1-01): add inline OTP verification step to both registration pages |

## Self-Check: PASSED
