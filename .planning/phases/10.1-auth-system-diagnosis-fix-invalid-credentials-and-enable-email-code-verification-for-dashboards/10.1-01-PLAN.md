---
phase: 10.1-auth-system-diagnosis-fix-invalid-credentials-and-enable-email-code-verification-for-dashboards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend-public/src/contexts/AuthContext.tsx
  - frontend-public/src/pages/CitizenRegisterPage.tsx
  - frontend-dashboard/src/hooks/useAuth.ts
  - frontend-dashboard/src/pages/RegisterPage.tsx
autonomous: true
requirements:
  - SEC-01
  - SEC-02

must_haves:
  truths:
    - "After registering on the citizen portal, user sees an inline 6-digit OTP input (not a dead-end 'check email' screen)"
    - "After entering the correct 6-digit code, user is automatically logged in with an active session"
    - "After registering on the municipal dashboard, user sees an inline 6-digit OTP input (not a dead-end 'check email' screen)"
    - "Both auth layers expose signInWithEmailOtp() and verifyEmailOtp() methods for email OTP flows"
  artifacts:
    - path: "frontend-public/src/contexts/AuthContext.tsx"
      provides: "signInWithEmailOtp and verifyEmailOtp methods"
      contains: "signInWithEmailOtp"
    - path: "frontend-public/src/pages/CitizenRegisterPage.tsx"
      provides: "OTP verification step after signup"
      contains: "verify-otp"
    - path: "frontend-dashboard/src/hooks/useAuth.ts"
      provides: "signInWithEmailOtp and verifyEmailOtp methods"
      contains: "signInWithEmailOtp"
    - path: "frontend-dashboard/src/pages/RegisterPage.tsx"
      provides: "OTP verification step after signup"
      contains: "verify-otp"
  key_links:
    - from: "frontend-public/src/pages/CitizenRegisterPage.tsx"
      to: "frontend-public/src/contexts/AuthContext.tsx"
      via: "useAuth().verifyEmailOtp"
      pattern: "verifyEmailOtp\\("
    - from: "frontend-dashboard/src/pages/RegisterPage.tsx"
      to: "frontend-dashboard/src/hooks/useAuth.ts"
      via: "direct supabase.auth.verifyOtp import"
      pattern: "verifyOtp.*type.*email"
---

<objective>
Fix the "invalid credentials" registration bug by adding inline email OTP verification to both registration pages, and extend both auth layers with email OTP methods.

Purpose: Users who register via the frontend get unconfirmed accounts (email_confirmed_at = NULL) because signUp() does not confirm the email. When they try to sign in, Supabase returns "Invalid login credentials". This plan adds a 6-digit OTP verification step immediately after signup so users complete email confirmation without leaving the page.

Output: Both registration pages transition to an OTP input step after signUp(). Both auth layers expose signInWithEmailOtp() and verifyEmailOtp() for use by login pages in Plan 02.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-auth-system-diagnosis-fix-invalid-credentials-and-enable-email-code-verification-for-dashboards/10.1-RESEARCH.md

@frontend-public/src/contexts/AuthContext.tsx
@frontend-public/src/pages/CitizenRegisterPage.tsx
@frontend-dashboard/src/hooks/useAuth.ts
@frontend-dashboard/src/pages/RegisterPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email OTP methods to both auth layers</name>
  <files>
    frontend-public/src/contexts/AuthContext.tsx
    frontend-dashboard/src/hooks/useAuth.ts
  </files>
  <action>
**frontend-public/src/contexts/AuthContext.tsx:**

1. Add two new methods to the `AuthContextType` interface:
   - `signInWithEmailOtp: (email: string) => Promise<void>` — sends 6-digit OTP to email
   - `verifyEmailOtp: (email: string, token: string) => Promise<void>` — verifies the code and creates session

2. Implement `signInWithEmailOtp` in the `AuthProvider`:
```typescript
const signInWithEmailOtp = async (email: string) => {
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      shouldCreateUser: false,  // CRITICAL: login only, don't create new accounts
    },
  });
  if (error) throw error;
};
```

3. Implement `verifyEmailOtp` in the `AuthProvider`:
```typescript
const verifyEmailOtp = async (email: string, token: string) => {
  const { error } = await supabase.auth.verifyOtp({
    email,
    token,
    type: 'email',  // CRITICAL: must be 'email' not 'sms' or 'signup'
  });
  if (error) throw error;
};
```

4. Add both methods to the `value` object and `AuthContext.Provider`.

**frontend-dashboard/src/hooks/useAuth.ts:**

1. Add the same two methods (`signInWithEmailOtp`, `verifyEmailOtp`) following the same pattern.

2. `signInWithEmailOtp`:
```typescript
const signInWithEmailOtp = async (email: string) => {
  const { data, error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      shouldCreateUser: false,
    },
  });
  if (error) throw error;
  return data;
};
```

3. `verifyEmailOtp`:
```typescript
const verifyEmailOtp = async (email: string, token: string) => {
  const { data, error } = await supabase.auth.verifyOtp({
    email,
    token,
    type: 'email',
  });
  if (error) throw error;
  return data;
};
```

4. Add both to the return object of `useAuth()`.

**Key constraints from research:**
- `type: 'email'` is REQUIRED (not 'sms' or 'signup') — see Pitfall 1 and 6 in research
- `shouldCreateUser: false` on signInWithEmailOtp — see Pitfall 3 in research
- These methods are for EXISTING users only (login flow). Registration uses signUp() + verifyOtp() directly.
  </action>
  <verify>
    <automated>cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine/frontend-public && npx tsc --noEmit 2>&1 | head -20 && cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine/frontend-dashboard && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that AuthContext.tsx exports signInWithEmailOtp and verifyEmailOtp. Check that useAuth.ts returns signInWithEmailOtp and verifyEmailOtp.</manual>
  </verify>
  <done>Both auth layers expose signInWithEmailOtp() and verifyEmailOtp() methods. TypeScript compiles without errors related to these methods. Methods use type: 'email' (not 'sms') and shouldCreateUser: false.</done>
</task>

<task type="auto">
  <name>Task 2: Add inline OTP verification step to both registration pages</name>
  <files>
    frontend-public/src/pages/CitizenRegisterPage.tsx
    frontend-dashboard/src/pages/RegisterPage.tsx
  </files>
  <action>
**frontend-public/src/pages/CitizenRegisterPage.tsx:**

1. Replace the `success` boolean state with a `RegisterMode` state machine:
```typescript
type RegisterMode = 'form' | 'verify-otp' | 'success';
const [mode, setMode] = useState<RegisterMode>('form');
const [registeredEmail, setRegisteredEmail] = useState('');
const [otpCode, setOtpCode] = useState('');
```

2. In `handleRegister`, after `signUp()` succeeds:
   - Store the email: `setRegisteredEmail(email);`
   - Transition to OTP step: `setMode('verify-otp');`
   - Do NOT set `setSuccess(true)` anymore

3. Add a new `handleVerifyRegistrationOtp` handler:
```typescript
const handleVerifyRegistrationOtp = async (e: React.FormEvent) => {
  e.preventDefault();
  setError(null);
  setLoading(true);
  try {
    // verifyOtp with type 'email' confirms the email AND creates session
    await supabase.auth.verifyOtp({
      email: registeredEmail,
      token: otpCode,
      type: 'email',  // CRITICAL: must be 'email' not 'signup'
    });
    // User is now fully authenticated — navigate to profile
    navigate('/profile', { replace: true });
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Invalid verification code');
  } finally {
    setLoading(false);
  }
};
```

   Note: Import `supabase` from `'../lib/supabase'` and `useNavigate` from `'react-router-dom'` (useNavigate is already imported via useLocation's import line — add `useNavigate` to the import destructure). Call `supabase.auth.verifyOtp` directly rather than going through `useAuth()` because the registration page uses `signUp()` which is a different flow than `signInWithOtp`. The `verifyOtp` call with `type: 'email'` works for both flows.

4. Update the render logic. Replace the `if (success)` block with `if (mode === 'verify-otp')` block:
   - Show the registered email in an info box: "Verification code sent to {registeredEmail}"
   - 6-digit OTP input field (maxLength={6}, pattern="[0-9]{6}", autoComplete="one-time-code", inputMode="numeric")
   - "Verify Email" submit button
   - "Resend Code" link button that calls `signUp(registeredEmail, password, metadata)` again or `supabase.auth.resend({ type: 'signup', email: registeredEmail })`
   - Use the same glassmorphic card styling, info box styling (green teal), and form styling as the rest of the page

5. The main form renders when `mode === 'form'` (previously the default state).

6. Remove the old "Account Created!" success screen entirely — after OTP verification, user navigates directly to /profile.

**frontend-dashboard/src/pages/RegisterPage.tsx:**

Apply the same pattern:

1. Add state: `mode` (RegisterMode), `registeredEmail`, `otpCode`. Import `useNavigate` from react-router-dom and `supabase` from `'../lib/supabase'`.

2. In `handleRegister`, after signUp succeeds: `setRegisteredEmail(email); setMode('verify-otp');`

3. Add `handleVerifyRegistrationOtp` handler (same as citizen portal, but navigate to `/` which is the dashboard root).

4. Replace the `if (success)` block with a `verify-otp` mode block showing:
   - Info box with registered email
   - 6-digit OTP input
   - "Verify Email" button
   - "Resend Code" link
   - Keep the same glassmorphic card layout and SALGA branding

5. Main form renders when `mode === 'form'`.

**OTP input styling for both pages:**
- Use the same `styles.input` as other form fields
- Add `inputMode: 'numeric'` attribute for mobile keyboard
- Add `style={{ textAlign: 'center', letterSpacing: '0.5em', fontSize: '1.5rem' }}` on the OTP input for a centered code-entry feel
- `maxLength={6}`, `pattern="[0-9]{6}"`, `autoComplete="one-time-code"`

**Resend logic:**
Use `supabase.auth.resend({ type: 'signup', email: registeredEmail })` to resend the confirmation email. This is cleaner than calling signUp again. Wrap in try/catch and show a temporary "Code resent!" info message.

**Key constraints from research:**
- `type: 'email'` in verifyOtp (Pitfall 1)
- After successful verifyOtp, user has an active session — no need to call signInWithPassword (Don't Hand-Roll section)
- Do NOT use signInWithOtp for registration flow — use signUp + verifyOtp (Anti-pattern warning in research)
  </action>
  <verify>
    <automated>cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine/frontend-public && npx tsc --noEmit 2>&1 | head -20 && cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine/frontend-dashboard && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Visit /register on both dashboards. Fill in form, submit. Verify OTP input step appears (not dead-end success screen). Enter 6-digit code from email. Verify redirect to /profile (public) or / (municipal).</manual>
  </verify>
  <done>Both registration pages show inline OTP verification step after signUp(). OTP input accepts 6 digits, verifies with type 'email', and creates active session on success. Dead-end "check email" success screen is removed. Both frontends compile without TypeScript errors.</done>
</task>

</tasks>

<verification>
1. `cd frontend-public && npx tsc --noEmit` — zero TypeScript errors
2. `cd frontend-dashboard && npx tsc --noEmit` — zero TypeScript errors
3. Both registration pages have `verify-otp` mode with 6-digit input
4. AuthContext.tsx exports `signInWithEmailOtp` and `verifyEmailOtp`
5. useAuth.ts returns `signInWithEmailOtp` and `verifyEmailOtp`
6. No references to `type: 'sms'` in email OTP code paths
7. No references to `type: 'signup'` in verifyOtp calls
</verification>

<success_criteria>
- Registration on citizen portal transitions to OTP step (not dead-end)
- Registration on municipal dashboard transitions to OTP step (not dead-end)
- After entering correct 6-digit code, user has active session
- Both auth layers expose email OTP methods for Plan 02 login integration
- Both frontends build without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-auth-system-diagnosis-fix-invalid-credentials-and-enable-email-code-verification-for-dashboards/10.1-01-SUMMARY.md`
</output>
