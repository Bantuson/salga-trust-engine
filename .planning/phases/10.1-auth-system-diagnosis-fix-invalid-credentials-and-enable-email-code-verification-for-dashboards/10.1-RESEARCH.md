# Phase 10.1: Auth System Diagnosis — Fix Invalid Credentials and Enable Email Code Verification - Research

**Researched:** 2026-02-24
**Domain:** Supabase Auth — email confirmation flow, email OTP passwordless sign-in, frontend auth wiring
**Confidence:** HIGH

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| SEC-01 | All data encrypted at rest and in transit (TLS 1.3, AES-256) | Auth tokens transmitted via Supabase TLS; OTP codes are one-time use |
| SEC-02 | POPIA consent captured at registration with clear data processing purpose | Registration flow already captures consent; email OTP adds an additional verification step |
</phase_requirements>

---

## Summary

The root cause of "invalid credentials" after account creation is **confirmed via live Supabase auth logs and database inspection**: the Supabase project has email confirmation enabled by default for hosted projects, but the frontend registration flow (`supabase.auth.signUp()`) does not send the OTP confirmation code via the branded email template — it either sends a magic link (old template behavior) or sends a confirmation URL. When users try to sign in with `signInWithPassword()` before confirming their email, Supabase returns `400: Invalid login credentials`. Two real non-test accounts in the database have `email_confirmed_at = NULL`, confirming this is an active production blocker.

The e2e test profiles work because `global-setup.ts` uses `supabase.auth.admin.createUser({ email_confirm: true })` — the admin API bypasses email confirmation entirely. The backend `src/api/v1/auth.py` register endpoint also uses `email_confirm: True` for the same reason. Only the **frontend `supabase.auth.signUp()` call** creates unconfirmed accounts.

The fix has two parts: (1) wire email OTP confirmation into the signup completion flow using `signInWithOtp({ email })` + `verifyOtp({ email, token, type: 'email' })` instead of or after `signUp()`, and (2) ensure the branded OTP template from Phase 06.8-05 (`templates/email/otp-supabase-paste.html`, already deployed to Supabase Dashboard) is active on the correct template slot (currently confirmed as the "Magic Link" slot). The email OTP flow must be enabled in the Supabase Dashboard under Authentication → Providers → Email.

**Primary recommendation:** Replace the post-signup "check your email" dead-end with an inline 6-digit code entry step. After `signUp()` succeeds, immediately prompt for the 6-digit OTP code and call `verifyOtp({ email, token, type: 'email' })` to confirm and create the session. Apply this to both `frontend-public/src/contexts/AuthContext.tsx` (citizen portal) and `frontend-dashboard/src/pages/RegisterPage.tsx` (municipal dashboard).

---

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `@supabase/supabase-js` | v2.x (already installed) | Email OTP send + verify | Supabase native client; already used in both frontends |
| Supabase Auth Dashboard | N/A | Enable email OTP, configure templates | Configuration-only; no code dependency |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| `supabase.auth.signInWithOtp({ email })` | built-in | Send 6-digit OTP to email | Replaces magic link; uses same branded template |
| `supabase.auth.verifyOtp({ email, token, type: 'email' })` | built-in | Verify 6-digit code and create session | Called after user enters code from email |
| `supabase.auth.admin.updateUserById({ email_confirm: true })` | built-in (service role) | Fix existing unconfirmed accounts | One-time remediation for 2 stuck accounts |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Email OTP via `signInWithOtp` | Disable email confirmation in Supabase Dashboard | Disabling confirmation removes security; email OTP keeps it while adding UX clarity |
| Inline OTP after signUp | Magic link (ConfirmationURL) | Magic links broken on this project per Phase 06.8 decisions; OTP is the correct path |
| Frontend OTP flow | Backend `/auth/register` endpoint with `email_confirm: True` | Backend register uses admin API (correct), but frontend signUp bypasses it |

**No new npm packages needed.** The Supabase JS client already supports `signInWithOtp` and `verifyOtp`.

---

## Architecture Patterns

### Recommended Project Structure

No new files required. Changes are surgical updates to existing auth files:

```
frontend-public/src/
├── contexts/AuthContext.tsx      # Add signUpWithEmailOtp() — replaces bare signUp()
├── pages/CitizenRegisterPage.tsx # Add OTP step after successful signup
└── hooks/useAuth.ts              # Re-exports AuthContext (no change needed)

frontend-dashboard/src/
├── hooks/useAuth.ts              # Add email OTP verification methods
└── pages/RegisterPage.tsx        # Add OTP step after successful signup
                                  # (municipal dashboard also has signUp)
```

### Pattern 1: Email OTP Registration Flow (Two-Step)

**What:** After `signUp()` succeeds, the UI transitions to an OTP input step. The user checks email for the 6-digit code, enters it, and `verifyOtp` both confirms the email AND creates an active session.

**When to use:** All new citizen and municipal staff registrations via the web portal.

**Example:**
```typescript
// Source: Supabase official docs (auth-email-passwordless.mdx)
// Step 1: signUp registers the user (sends confirmation email with 6-digit code)
const { error } = await supabase.auth.signUp({
  email,
  password,
  options: { data: metadata }
})

// Step 2 (new): Instead of dead-end "check email", show OTP input
// User enters the 6-digit code from their email
const { data, error } = await supabase.auth.verifyOtp({
  email,
  token: otpCode,   // the 6-digit code user types
  type: 'email',    // CRITICAL: must be 'email' not 'signup'
})
// data.session is now set — user is fully logged in
```

### Pattern 2: Standalone Email OTP Sign-In (Passwordless)

**What:** For sign-in, `signInWithOtp({ email })` sends a fresh 6-digit code. The user enters it to authenticate without password.

**When to use:** Login pages — both dashboards already have the `phone` OTP flow. Email OTP is the parallel flow for email.

**Example:**
```typescript
// Source: Supabase official docs (auth-email-passwordless.mdx)
// Step 1: Send OTP to email
const { error } = await supabase.auth.signInWithOtp({
  email: 'user@example.com',
  options: {
    shouldCreateUser: false,  // only sign in existing users, don't create new accounts
  }
})

// Step 2: Verify the 6-digit code
const { data: { session }, error } = await supabase.auth.verifyOtp({
  email: 'user@example.com',
  token: '123456',
  type: 'email',
})
```

### Pattern 3: Fix Existing Stuck Accounts (One-Time Remediation)

**What:** Two real accounts have `email_confirmed_at = NULL`. They cannot sign in. Fix via Supabase admin API.

**When to use:** Applied once during Phase 10.1 implementation, via a migration or manual Supabase Dashboard action.

**Example:**
```typescript
// Source: Supabase Admin API docs
await supabase.auth.admin.updateUserById(userId, {
  email_confirm: true,
})
// OR via SQL (simpler, no user IDs needed):
// UPDATE auth.users SET email_confirmed_at = NOW() WHERE email_confirmed_at IS NULL
//   AND email NOT LIKE '%test%';
```

### Pattern 4: Auth Mode State Machine

**What:** Both login pages already use `type AuthMode = 'email' | 'phone' | 'verify-otp'`. The registration pages need a similar pattern: `type RegisterMode = 'form' | 'verify-otp' | 'success'`.

**Current state:** `CitizenRegisterPage.tsx` has `success` boolean. `RegisterPage.tsx` (dashboard) has `success` boolean. Both show a dead-end success screen directing user to login. Neither collects or verifies the OTP code.

**Required change:** Add `'verify-otp'` mode between form submission and success. Capture the submitted `email` in local state and pass it to the OTP verification step.

### Anti-Patterns to Avoid

- **Sending OTP with `signInWithOtp` and `shouldCreateUser: true` at signup**: This bypasses `signUp()` entirely and creates a Supabase user without POPIA metadata. The current two-step approach (`signUp()` + `verifyOtp()`) is correct.
- **Setting `type: 'signup'` in verifyOtp**: The correct type for email confirmation codes after `signUp()` is `'email'`, not `'signup'`. Using wrong type returns "OTP expired or invalid".
- **Disabling email confirmation globally**: The Supabase Dashboard setting "Confirm email" should remain enabled. Disabling it removes all email verification security for all users.
- **OTP in anchor tag**: Phase 06.8 established: `{{ .Token }}` must appear as plain text, never inside `<a href="{{ .ConfirmationURL }}">`. The existing `templates/email/otp-supabase-paste.html` already follows this correctly.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| OTP generation | Custom 6-digit code generator | `supabase.auth.signInWithOtp({ email })` | Supabase handles OTP generation, TTL (60 min), storage, and delivery |
| Email delivery | Custom email send | Supabase + SendGrid (already configured) | Already integrated; template already in Supabase Dashboard |
| OTP verification | Custom token comparison | `supabase.auth.verifyOtp({ email, token, type: 'email' })` | Supabase handles timing attacks, replay prevention, expiry |
| Session creation | Custom JWT issuance | Supabase verifyOtp returns `data.session` | verifyOtp both confirms email AND creates an active session in one call |

**Key insight:** `verifyOtp` does double duty — it both confirms the email address AND creates the authenticated session. The planner does not need to call `signInWithPassword` after email confirmation.

---

## Common Pitfalls

### Pitfall 1: Wrong OTP Type String
**What goes wrong:** `verifyOtp({ email, token, type: 'signup' })` fails with "Token has expired or is invalid" even with correct code.
**Why it happens:** Supabase uses different token buckets for `'email'`, `'signup'`, `'recovery'`, and `'invite'`. After `signUp()`, the confirmation code type is `'email'`.
**How to avoid:** Always use `type: 'email'` for email OTP verification flows.
**Warning signs:** User reports correct code rejected; Supabase logs show `otp_invalid` even moments after send.

### Pitfall 2: Template on Wrong Slot
**What goes wrong:** Email sends a magic link instead of the 6-digit code; user receives a clickable URL instead of a number.
**Why it happens:** Phase 06.8-05 deployed the template to the "Magic Link" slot. `signInWithOtp({ email })` also uses the "Magic Link" slot. If the template reverted or was deployed to wrong slot (e.g., "Confirm signup"), the behavior differs.
**How to avoid:** Verify in Supabase Dashboard → Authentication → Email Templates → "Magic Link" that `{{ .Token }}` is present as plain text (not in an anchor tag). After `signUp()`, the correct slot is "Confirm signup" — this may require deploying the OTP template to **both** the "Magic Link" AND "Confirm signup" slots.
**Warning signs:** Email arrives with a clickable link instead of digits; user cannot find a 6-digit code to enter.

### Pitfall 3: shouldCreateUser Default Creates Duplicate Accounts
**What goes wrong:** Using `signInWithOtp({ email })` on the login page without `shouldCreateUser: false` silently creates a new Supabase auth user if the email doesn't exist yet.
**Why it happens:** `shouldCreateUser` defaults to `true` in the Supabase JS client.
**How to avoid:** Always set `options: { shouldCreateUser: false }` on login-page OTP flows. On registration-page flows, rely on `signUp()` for account creation, not `signInWithOtp`.
**Warning signs:** Supabase shows duplicate emails; login creates a new account instead of failing.

### Pitfall 4: The Branded Email Template Slot Mismatch
**What goes wrong:** The branded `otp-supabase-paste.html` template shows the code for `signInWithOtp` (passwordless login) but NOT for `signUp` confirmation.
**Why it happens:** Supabase has separate template slots: "Confirm signup", "Magic Link", "Change Email Address", "Reset Password". Phase 06.8-05 pasted the template into "Magic Link". The post-`signUp()` confirmation email uses the "Confirm signup" slot.
**How to avoid:** The OTP template must be pasted into the "Confirm signup" slot as well. The same HTML (`otp-supabase-paste.html`) works for both.
**Warning signs:** OTP code appears on login but not on registration confirmation email.

### Pitfall 5: Unconfirmed Account Sign-In Shows Generic Error
**What goes wrong:** User with unconfirmed email tries `signInWithPassword` — gets "Invalid login credentials" (not "Please confirm your email"). This is the exact symptom the user reported.
**Why it happens:** Supabase returns the same generic `invalid_credentials` error for both wrong password AND unconfirmed email, to prevent user enumeration. The Supabase auth log shows `error_code: "invalid_credentials"` for both cases.
**How to avoid:** When password sign-in fails, the UI should offer "Send verification code" as a recovery path, not just show a generic error. Alternatively (simpler): fix the registration flow so all new accounts are confirmed before reaching the login page.
**Warning signs:** Auth log shows `invalid_credentials` but user is certain of their password.

### Pitfall 6: Phone OTP Type is 'sms', Email OTP Type is 'email'
**What goes wrong:** The existing phone OTP flow uses `type: 'sms'` in `verifyOtp`. If someone copies the phone flow for email OTP and forgets to change the type, all email OTP verifications fail.
**Why it happens:** Both dashboards have phone OTP verification wired with `type: 'sms'`. Email OTP requires `type: 'email'`.
**How to avoid:** Email OTP verification must use `type: 'email'` explicitly in both `AuthContext.tsx` (public) and `useAuth.ts` (dashboard).

---

## Code Examples

Verified patterns from official Supabase sources:

### Email OTP Send (signInWithOtp)
```typescript
// Source: https://supabase.com/docs/guides/auth/auth-email-passwordless
const { error } = await supabase.auth.signInWithOtp({
  email: 'user@example.com',
  options: {
    shouldCreateUser: false,  // login only; don't create new account
  },
})
```

### Email OTP Verify (verifyOtp)
```typescript
// Source: https://supabase.com/docs/guides/auth/auth-email-passwordless
const {
  data: { session },
  error,
} = await supabase.auth.verifyOtp({
  email: 'email@example.com',
  token: '123456',
  type: 'email',   // MUST be 'email', NOT 'sms'
})
```

### Registration OTP Confirm (post-signUp)
```typescript
// Source: https://supabase.com/docs/guides/auth/auth-email-templates
const { data, error } = await supabase.auth.verifyOtp({
  email,
  token,
  type: 'email'  // same type for both signUp confirmation and signInWithOtp verification
})
```

### Fix Stuck Accounts (SQL remediation)
```sql
-- Fix unconfirmed accounts from manual frontend registration
-- Safe: only touches non-test accounts with NULL email_confirmed_at
UPDATE auth.users
SET email_confirmed_at = NOW(), updated_at = NOW()
WHERE email_confirmed_at IS NULL
  AND email NOT LIKE '%test%';
```

### Auth Mode State Machine (Registration Page Pattern)
```typescript
// Pattern for both CitizenRegisterPage.tsx and RegisterPage.tsx
type RegisterMode = 'form' | 'verify-otp' | 'success';

const [mode, setMode] = useState<RegisterMode>('form');
const [registeredEmail, setRegisteredEmail] = useState('');

// After signUp() succeeds:
setRegisteredEmail(email);
setMode('verify-otp');

// After verifyOtp() succeeds:
setMode('success');
// OR: navigate directly to /profile (user is now logged in)
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Magic links (ConfirmationURL) | 6-digit OTP codes | Phase 06.8 | Simpler UX; works in all email clients without redirect |
| `email_confirm: True` in admin API only | `signUp()` + `verifyOtp()` in frontend | Phase 10.1 | Closes the gap where frontend accounts were unconfirmed |
| Generic "check email" screen | Inline OTP entry step | Phase 10.1 | User completes verification without leaving the app |
| Phone-only OTP in auth UI | Both phone + email OTP | Phase 10.1 | Email OTP needed because Twilio SMS not always available |

**Deprecated/outdated:**
- Magic link emails: Replaced by 6-digit OTP per Phase 06.8 decision. Template in Supabase Dashboard must NOT contain `{{ .ConfirmationURL }}`.
- `signUp()` with no follow-up confirmation step: The current dead-end success screen is the root cause of the bug. Being removed in Phase 10.1.

---

## Open Questions

1. **Which Supabase template slot does `signUp()` use?**
   - What we know: Phase 06.8-05 deployed `otp-supabase-paste.html` to the "Magic Link" slot. `signInWithOtp({ email })` also uses "Magic Link".
   - What's unclear: Post-`signUp()` email confirmation uses either "Magic Link" or "Confirm signup" slot depending on Supabase version and project config.
   - Recommendation: Paste the same HTML template into BOTH "Magic Link" AND "Confirm signup" slots in Supabase Dashboard. This ensures OTP codes regardless of which flow triggered the email.

2. **Should email OTP replace password sign-in entirely, or supplement it?**
   - What we know: Both login pages have email+password mode and phone OTP mode. The user request is to "enable email code verification" — this implies OTP as an option, not a replacement.
   - What's unclear: Does the user want (a) post-registration OTP confirmation, (b) email OTP as a login method alongside password, or (c) both?
   - Recommendation: Implement both: (a) inline OTP confirmation after registration, and (b) add email OTP sign-in mode to both login pages (parallel to existing phone OTP). This gives citizens who can't remember their password an alternative path.

3. **Do the two stuck accounts need immediate manual remediation?**
   - What we know: `bantuson.enquiries@gmail.com` and `sipho.ndlovu@gmail.com` have `email_confirmed_at = NULL`. They cannot sign in. The SQL fix is one line.
   - What's unclear: Are these real users who should be enabled, or test data?
   - Recommendation: Include a SQL migration that sets `email_confirmed_at = NOW()` for unconfirmed non-test accounts. Run this as Wave 0 of the plan so affected users are unblocked immediately.

---

## Validation Architecture

> Skipping — `workflow.nyquist_validation` is not set in `.planning/config.json`.

---

## Sources

### Primary (HIGH confidence)
- `/supabase/supabase` Context7 library — `verifyOtp` email type, `signInWithOtp` patterns, email template `{{ .Token }}` usage
- `/supabase/supabase-js` Context7 library — `signUp`, `signInWithPassword`, `signInWithOtp`, `verifyOtp` API signatures
- Live Supabase auth logs (MCP `get_logs`) — confirmed `invalid_credentials` errors from `localhost:3000` at timestamps matching user-reported failures
- Live Supabase database (MCP `execute_sql`) — confirmed 2 non-test accounts with `email_confirmed_at = NULL`
- `e2e-tests/global-setup.ts` — confirmed `email_confirm: true` in test setup explains why test profiles work
- `src/api/v1/auth.py:109` — backend register uses `email_confirm: True` in admin API (correct); frontend does not

### Secondary (MEDIUM confidence)
- Supabase official docs (via Context7): "Email authentication is enabled by default. You can configure whether users need to verify their email to sign in. On hosted Supabase projects, this is true by default." — confirms email confirmation is ON in this project.
- Phase 06.8-05 SUMMARY.md — confirmed branded OTP template deployed to Supabase Dashboard "Magic Link" slot; template file is `templates/email/otp-supabase-paste.html`

### Tertiary (LOW confidence)
- Assumption that "Confirm signup" slot needs the same template as "Magic Link" — should be verified in Supabase Dashboard during implementation.

---

## Metadata

**Confidence breakdown:**
- Root cause diagnosis: HIGH — confirmed by live auth logs (error_code: invalid_credentials) and database query (email_confirmed_at = NULL)
- Fix approach (signUp + verifyOtp): HIGH — verified against Supabase JS official docs
- Template slot mapping: MEDIUM — Phase 06.8 deployed to Magic Link; Confirm signup slot deployment is an open question
- Email OTP sign-in (login page addition): HIGH — same `signInWithOtp`/`verifyOtp` pattern, well-documented

**Research date:** 2026-02-24
**Valid until:** 2026-03-24 (Supabase Auth API is stable; email template config is project-specific)
