---
phase: 09-ocr-supabase-bridge-ward-filtering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/user.py
  - alembic/versions/2026_02_22_add_ward_id_to_users.py
  - src/api/v1/tickets.py
  - src/api/v1/dashboard.py
  - tests/test_tickets_api.py
  - tests/test_dashboard_api.py
autonomous: true
requirements:
  - OPS-03

must_haves:
  truths:
    - "User model has a nullable ward_id column of type String(100)"
    - "Ward councillor accessing tickets is automatically filtered to their stored ward_id (not a client-supplied query param)"
    - "Ward councillor with no ward_id set sees empty results (fail-safe, not fail-open)"
    - "Ward councillor accessing dashboard metrics is auto-filtered to their stored ward_id"
    - "Non-ward-councillor roles (manager, admin) are unaffected by ward enforcement"
    - "Alembic migration adds ward_id column with index to users table"
  artifacts:
    - path: "src/models/user.py"
      provides: "User.ward_id nullable String(100) column"
      contains: "ward_id"
    - path: "alembic/versions/2026_02_22_add_ward_id_to_users.py"
      provides: "Migration adding ward_id column with index"
      contains: "add_column.*ward_id"
    - path: "src/api/v1/tickets.py"
      provides: "Ward councillor auto-enforcement from stored ward_id"
      contains: "current_user.ward_id"
    - path: "src/api/v1/dashboard.py"
      provides: "Dashboard ward councillor auto-enforcement"
      contains: "current_user.ward_id"
    - path: "tests/test_tickets_api.py"
      provides: "Tests for ward councillor ticket filtering"
      contains: "test_list_tickets_ward_councillor"
    - path: "tests/test_dashboard_api.py"
      provides: "Tests for ward councillor dashboard enforcement"
      contains: "test_dashboard_ward_councillor"
  key_links:
    - from: "src/api/v1/tickets.py"
      to: "src/models/user.py"
      via: "current_user.ward_id read in list_tickets()"
      pattern: "current_user\\.ward_id"
    - from: "src/api/v1/dashboard.py"
      to: "src/models/user.py"
      via: "current_user.ward_id read in dashboard endpoints"
      pattern: "current_user\\.ward_id"
    - from: "alembic/versions/2026_02_22_add_ward_id_to_users.py"
      to: "src/models/user.py"
      via: "Migration matches model column definition"
      pattern: "op\\.add_column.*ward_id"
---

<objective>
Add User.ward_id field and enforce ward-scoped filtering for ward councillors across tickets and dashboard endpoints.

Purpose: The WARD_COUNCILLOR role exists but ward filtering is currently a warning-log placeholder. Ward councillors can see all municipality tickets, which violates OPS-03 (ward councillor sees only their ward's tickets). This plan adds the ward_id field, creates the migration, and wires real enforcement in tickets and dashboard APIs.

Output: User model has ward_id, Alembic migration exists, tickets and dashboard endpoints enforce ward_id from the user's stored profile (not client-supplied query param), tests cover all scenarios.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ocr-supabase-bridge-ward-filtering/09-RESEARCH.md
@src/models/user.py
@src/api/v1/tickets.py
@src/api/v1/dashboard.py
@src/services/dashboard_service.py
@tests/test_tickets_api.py
@tests/test_dashboard_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add User.ward_id field and Alembic migration</name>
  <files>src/models/user.py, alembic/versions/2026_02_22_add_ward_id_to_users.py</files>
  <action>
1. In `src/models/user.py`, add a `ward_id` field to the `User` class, placed after the `municipality_id` field (line 51):
   ```python
   ward_id: Mapped[str | None] = mapped_column(
       String(100),
       nullable=True,
       index=True,
   )
   ```
   - String(100) — SA ward identifiers are human-readable strings like "Ward 1", "Ward 23"
   - Nullable — only ward_councillor role users need this populated
   - Index — ward filtering queries will be frequent for ward councillors

2. Create Alembic migration file. Run:
   ```bash
   alembic revision --autogenerate -m "add ward_id to users"
   ```
   If autogenerate does not work (no DB connection), manually create the migration file at `alembic/versions/2026_02_22_add_ward_id_to_users.py` following the project timestamp naming convention observed in existing files:
   ```python
   """add ward_id to users

   Revision ID: {auto or manual}
   Revises: feb9e9b8f0ff
   Create Date: 2026-02-22
   """
   from alembic import op
   import sqlalchemy as sa

   # revision identifiers
   revision = '{generate}'
   down_revision = 'feb9e9b8f0ff'
   branch_labels = None
   depends_on = None

   def upgrade() -> None:
       op.add_column("users", sa.Column("ward_id", sa.String(100), nullable=True))
       op.create_index("ix_users_ward_id", "users", ["ward_id"])

   def downgrade() -> None:
       op.drop_index("ix_users_ward_id", table_name="users")
       op.drop_column("users", "ward_id")
   ```

   IMPORTANT: Check the latest revision ID by reading the most recent file in `alembic/versions/` and use it as `down_revision`. The last file is `2026_02_11_1702-feb9e9b8f0ff_add_access_requests_onboarding_.py` so `down_revision = 'feb9e9b8f0ff'`.

3. Verify the model change does not break SQLite tests (unit tests use `Base.metadata.create_all()` which picks up the new column automatically).
  </action>
  <verify>Run `pytest tests/test_auth.py -v --timeout=30` to confirm User model changes don't break existing auth tests. Verify the migration file exists and has both upgrade() and downgrade() functions.</verify>
  <done>User model has ward_id as Mapped[str | None] with String(100), nullable, indexed. Alembic migration file exists with correct up/down operations.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ward enforcement in tickets and dashboard endpoints with tests</name>
  <files>src/api/v1/tickets.py, src/api/v1/dashboard.py, tests/test_tickets_api.py, tests/test_dashboard_api.py</files>
  <action>
**Part A: Enforce ward filtering in tickets.py**

In `src/api/v1/tickets.py`, function `list_tickets()`, replace the ward councillor interim warning block (lines 133-144) with real enforcement:

```python
# Ward councillor ward enforcement — use stored ward_id, not client-supplied
if current_user.role == UserRole.WARD_COUNCILLOR:
    # Auto-apply ward filter from user's stored ward_id
    # This prevents ward councillors from spoofing a different ward_id via query param
    effective_ward_id = current_user.ward_id
    if effective_ward_id is None:
        # No ward assigned yet — return empty results (fail-safe, not fail-open)
        logger.warning(
            f"WARD_COUNCILLOR {current_user.id} has no ward_id assigned. Returning empty results."
        )
        return PaginatedTicketResponse(
            tickets=[],
            total=0,
            page=page,
            page_size=page_size,
            page_count=0,
        )
    # Override client-supplied ward_id with stored value
    ward_id = effective_ward_id
```

Keep the existing `ward_id` filter block (lines 176-178) that applies `Ticket.address.ilike(f"%{ward_id}%")` — this now receives the stored ward_id for ward councillors.

Also add `WARD_COUNCILLOR` to the RBAC check in `get_ticket_detail()` if not already there — ward councillors should be able to view detail of tickets in their ward. Add a ward check: if the ticket's address does not match the ward councillor's ward_id, return 403.

**Part B: Enforce ward filtering in dashboard.py**

In `src/api/v1/dashboard.py`, add ward enforcement in all 4 endpoints (`get_dashboard_metrics`, `get_volume_by_category`, `get_sla_compliance`, `get_team_workload`).

For each endpoint, replace the interim ward_id pass-through with stored-value enforcement. Add this block right after the RBAC check:

```python
# Ward councillor enforcement — use stored ward_id, ignore client-supplied
if current_user.role == UserRole.WARD_COUNCILLOR:
    ward_id = current_user.ward_id
    if ward_id is None:
        # No ward assigned — return zeroed-out metrics (fail-safe)
        return {  # or [] for list endpoints
            "total_open": 0,
            "total_resolved": 0,
            "sla_compliance_percent": 0.0,
            "avg_response_hours": 0.0,
            "sla_breaches": 0,
        }
```

For `get_volume_by_category` and `get_team_workload` (which return lists), use `return []` for the no-ward fail-safe.

For `get_sla_compliance`, use:
```python
return {
    "response_compliance_percent": 0.0,
    "resolution_compliance_percent": 0.0,
    "total_with_sla": 0,
    "response_breaches": 0,
    "resolution_breaches": 0,
}
```

Remove the old `logger.info` interim log for ward councillor in `get_dashboard_metrics`.

**Part C: Tests for ward enforcement**

In `tests/test_tickets_api.py`, add these tests (follow existing patterns with AsyncMock db, mock users):

1. `test_list_tickets_ward_councillor_with_ward_id` — Create a mock ward councillor user with `ward_id="Ward 5"`. Call `list_tickets()`. Assert the query includes an `address.ilike("%Ward 5%")` filter. The ward_id query parameter should be ignored even if provided.

2. `test_list_tickets_ward_councillor_no_ward_id_returns_empty` — Create a mock ward councillor user with `ward_id=None`. Call `list_tickets()`. Assert it returns `PaginatedTicketResponse` with `total=0, tickets=[]`.

3. `test_list_tickets_manager_unaffected_by_ward_enforcement` — Create a mock manager user (no ward_id). Call `list_tickets()`. Assert normal query without ward filtering (manager sees all non-sensitive tickets).

In `tests/test_dashboard_api.py`, add these tests:

4. `test_dashboard_metrics_ward_councillor_auto_filters` — Create a mock ward councillor user with `ward_id="Ward 3"`. Call `get_dashboard_metrics()`. Assert the `DashboardService.get_metrics()` is called with `ward_id="Ward 3"` regardless of what the client passed.

5. `test_dashboard_metrics_ward_councillor_no_ward_returns_zero` — Create a mock ward councillor user with `ward_id=None`. Call `get_dashboard_metrics()`. Assert it returns the zeroed-out dict immediately without calling DashboardService.

Follow existing test file patterns — use `app.dependency_overrides[get_current_user]` to inject mock users, use `AsyncMock` for db sessions. The mock user objects need a `ward_id` attribute (add it to the existing mock user factory or create inline).
  </action>
  <verify>Run `pytest tests/test_tickets_api.py tests/test_dashboard_api.py -v` — all existing tests pass, 5 new tests pass. Run `pytest` for full suite regression check.</verify>
  <done>Ward councillors are auto-filtered to their stored ward_id in tickets and all 4 dashboard endpoints. Missing ward_id returns empty/zeroed results (fail-safe). 5 new tests cover ward enforcement, fail-safe, and non-interference with other roles.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_tickets_api.py tests/test_dashboard_api.py -v` — all tests pass including new ward enforcement tests
2. `pytest` — full regression suite passes
3. `grep -n "current_user.ward_id" src/api/v1/tickets.py` — returns match confirming enforcement
4. `grep -n "current_user.ward_id" src/api/v1/dashboard.py` — returns matches in all 4 endpoints
5. `grep -n "ward_id" src/models/user.py` — returns the new column definition
6. Alembic migration file exists with upgrade() and downgrade() functions
</verification>

<success_criteria>
- User.ward_id is a nullable String(100) column on the User model
- Alembic migration adds the column with an index (ix_users_ward_id)
- Ward councillor ticket list uses stored ward_id, not client-supplied query param
- Ward councillor with no ward_id returns empty ticket list (not all tickets)
- All 4 dashboard endpoints enforce ward_id from stored profile for ward councillors
- Dashboard endpoints return zeroed metrics for ward councillors without ward_id
- Manager/admin roles are completely unaffected by ward enforcement
- All existing tests pass, 5+ new tests added and passing
</success_criteria>

<output>
After completion, create `.planning/phases/09-ocr-supabase-bridge-ward-filtering/09-02-SUMMARY.md`
</output>
