---
phase: 06.7-municipal-intake-agent-testing
plan: 05
type: execute
wave: 3
depends_on: ["06.7-04"]
files_modified:
  - streamlit_dashboard/app.py
  - streamlit_dashboard/components/chat.py
  - streamlit_dashboard/components/sidebar.py
  - streamlit_dashboard/components/debug_panel.py
  - streamlit_dashboard/api_client.py
autonomous: false

must_haves:
  truths:
    - "Streamlit app connects to live crew server via HTTP"
    - "Chat displays WhatsApp-style bubbles (user right, agent left) with no agent labels in main view"
    - "Sidebar has phone input, Reset button, Language selector, Municipality picker, Session override, Scenario presets, Agent state"
    - "Debug panel shows current agent, conversation state, session info, last API response metadata"
    - "GBV scenario debug panel redacts conversation content (metadata only)"
    - "Streamlit is a TESTING tool ‚Äî developer-focused, not citizen-facing"
  artifacts:
    - path: "streamlit_dashboard/app.py"
      provides: "Main Streamlit entry point"
      contains: "st.chat_input"
    - path: "streamlit_dashboard/components/chat.py"
      provides: "WhatsApp-style chat rendering"
      contains: "st.chat_message"
    - path: "streamlit_dashboard/components/sidebar.py"
      provides: "Test controls sidebar"
      contains: "st.sidebar"
    - path: "streamlit_dashboard/components/debug_panel.py"
      provides: "Agent debug panel"
      contains: "debug"
    - path: "streamlit_dashboard/api_client.py"
      provides: "HTTP client for crew server"
      contains: "httpx"
  key_links:
    - from: "streamlit_dashboard/api_client.py"
      to: "src/api/v1/crew_server.py"
      via: "HTTP POST to /api/v1/chat"
      pattern: "/api/v1/chat"
    - from: "streamlit_dashboard/app.py"
      to: "streamlit_dashboard/components/chat.py"
      via: "function import"
      pattern: "render_chat"
    - from: "streamlit_dashboard/app.py"
      to: "streamlit_dashboard/components/sidebar.py"
      via: "function import"
      pattern: "render_sidebar"
---

<objective>
Build the Streamlit developer testing dashboard with WhatsApp-style chat UI, test controls sidebar, and agent debug panel. Connects to the crew server via HTTP.

Purpose: This is the TESTING tool for developers to manually test the intake agent system. It simulates WhatsApp-like conversations, allows scenario switching (municipal/GBV), session overrides, and shows agent state in a debug panel.

Output: Complete Streamlit dashboard in `streamlit_dashboard/` directory, runnable with `streamlit run streamlit_dashboard/app.py`.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/api/v1/crew_server.py (created in Plan 04)
@src/core/config.py

# Plan 04 SUMMARY for crew server API contract
@.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client and Streamlit app structure</name>
  <files>streamlit_dashboard/api_client.py, streamlit_dashboard/app.py, streamlit_dashboard/components/__init__.py</files>
  <action>
**API Client** (`streamlit_dashboard/api_client.py`):

Create an httpx-based client that communicates with the crew server:

```python
import httpx
from dataclasses import dataclass

@dataclass
class CrewServerClient:
    base_url: str = "http://localhost:8001"
    api_key: str = ""
    timeout: float = 120.0  # LLM calls can be slow

    def _headers(self) -> dict:
        headers = {"Content-Type": "application/json"}
        if self.api_key:
            headers["X-API-Key"] = self.api_key
        return headers

    def chat(self, phone: str, message: str, language: str = "en",
             municipality_id: str | None = None,
             session_override: str | None = None) -> dict:
        """Send chat message to crew server. Returns ChatResponse dict."""
        ...

    def reset_session(self, phone: str) -> dict:
        """Reset conversation session for phone number."""
        ...

    def health(self) -> dict:
        """Check crew server health."""
        ...
```

Use synchronous httpx (not async) ‚Äî Streamlit's execution model is synchronous. Set a generous timeout (120s) because LLM calls via CrewAI can take 30-60 seconds.

Handle errors gracefully:
- `httpx.ConnectError` -> return `{"reply": "Crew server not running. Start with: python -m src.api.v1.crew_server", "agent_name": "error", "session_status": "error", "debug": {}}`
- `httpx.TimeoutException` -> return `{"reply": "Request timed out. The LLM may be slow ‚Äî try again.", ...}`
- `httpx.HTTPStatusError` -> return `{"reply": f"Server error: {status_code}", ...}`

**Main App** (`streamlit_dashboard/app.py`):

Create the main Streamlit entry point. Structure:

```python
import streamlit as st
from streamlit_dashboard.components.chat import render_chat
from streamlit_dashboard.components.sidebar import render_sidebar
from streamlit_dashboard.components.debug_panel import render_debug_panel
from streamlit_dashboard.api_client import CrewServerClient

st.set_page_config(
    page_title="SALGA Intake Agent Tester",
    page_icon="üèõÔ∏è",
    layout="wide"
)

st.title("SALGA Municipal Intake Agent - Test Dashboard")
st.caption("Developer testing tool ‚Äî connects to live crew server")

# Initialize session state
if "messages" not in st.session_state:
    st.session_state.messages = []
if "debug_info" not in st.session_state:
    st.session_state.debug_info = {}
if "phone" not in st.session_state:
    st.session_state.phone = ""
if "language" not in st.session_state:
    st.session_state.language = "en"

# Create API client (reads from env or defaults)
client = CrewServerClient(
    base_url=os.environ.get("CREW_SERVER_URL", "http://localhost:8001"),
    api_key=os.environ.get("CREW_SERVER_API_KEY", "")
)

# Layout: sidebar | chat | debug
render_sidebar()

col1, col2 = st.columns([3, 1])
with col1:
    render_chat(client)
with col2:
    render_debug_panel()
```

Create `streamlit_dashboard/__init__.py` and `streamlit_dashboard/components/__init__.py` as empty files.
  </action>
  <verify>
Run `python -c "from streamlit_dashboard.api_client import CrewServerClient; c = CrewServerClient(); print(c.base_url)"` to confirm import.
Verify directory structure: `ls streamlit_dashboard/` and `ls streamlit_dashboard/components/`.
  </verify>
  <done>API client wraps crew server HTTP calls with error handling. Main app.py structures the Streamlit page with sidebar, chat, and debug panel columns.</done>
</task>

<task type="auto">
  <name>Task 2: Build chat, sidebar, and debug panel components</name>
  <files>streamlit_dashboard/components/chat.py, streamlit_dashboard/components/sidebar.py, streamlit_dashboard/components/debug_panel.py</files>
  <action>
**Chat Component** (`streamlit_dashboard/components/chat.py`):

Implement WhatsApp-style chat using `st.chat_message`:

```python
def render_chat(client):
    """Render WhatsApp-style chat with message history."""
    # Display all previous messages
    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):  # "user" = right, "assistant" = left
            st.markdown(msg["content"])

    # Chat input at bottom
    if prompt := st.chat_input("Type your message...", disabled=not st.session_state.phone):
        # Add user message to history
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # Call crew server
        with st.spinner("Agent is thinking..."):
            response = client.chat(
                phone=st.session_state.phone,
                message=prompt,
                language=st.session_state.language,
                municipality_id=st.session_state.get("municipality_id"),
                session_override=st.session_state.get("session_override"),
            )

        # Add agent response (NO agent label in main view per locked decision)
        reply = response.get("reply", "No response received")
        st.session_state.messages.append({"role": "assistant", "content": reply})
        st.session_state.debug_info = response.get("debug", {})
        st.session_state.debug_info["agent_name"] = response.get("agent_name", "unknown")
        st.session_state.debug_info["session_status"] = response.get("session_status", "unknown")

        st.rerun()

    # Show hint if no phone number set
    if not st.session_state.phone:
        st.info("Enter a phone number in the sidebar to start chatting.")
```

Key: Agent labels hidden from main view. Agent name only visible in debug panel (per locked decision).

**Sidebar Component** (`streamlit_dashboard/components/sidebar.py`):

Build the test controls sidebar:

```python
def render_sidebar():
    """Render sidebar with test controls."""
    with st.sidebar:
        st.header("Test Controls")

        # Phone number input
        phone = st.text_input("Phone Number", value=st.session_state.phone,
                             placeholder="+27821234567",
                             help="SA phone number in E.164 format")
        if phone != st.session_state.phone:
            st.session_state.phone = phone

        st.divider()

        # Language selector
        language = st.selectbox("Language", ["en", "zu", "af"],
                               format_func=lambda x: {"en": "English", "zu": "isiZulu", "af": "Afrikaans"}[x],
                               index=["en", "zu", "af"].index(st.session_state.language))
        st.session_state.language = language

        # Municipality picker (free text for now ‚Äî could be dropdown from DB)
        municipality_id = st.text_input("Municipality ID (UUID)",
                                        value=st.session_state.get("municipality_id", ""),
                                        help="UUID of target municipality")
        st.session_state.municipality_id = municipality_id or None

        st.divider()

        # Session override (for testing)
        session_override = st.selectbox("Session Override",
                                       [None, "expired", "new"],
                                       format_func=lambda x: x or "Auto-detect",
                                       help="Override phone detection for testing")
        st.session_state.session_override = session_override

        # Scenario presets
        st.subheader("Scenario Presets")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("Municipal", use_container_width=True):
                st.session_state.messages = []
                st.session_state.messages.append({
                    "role": "user",
                    "content": "There is a water pipe burst on Main Street, Braamfontein"
                })
                st.rerun()
        with col2:
            if st.button("GBV", use_container_width=True, type="secondary"):
                st.session_state.messages = []
                st.session_state.messages.append({
                    "role": "user",
                    "content": "I need help, my partner is threatening me"
                })
                st.rerun()

        st.divider()

        # Reset button
        if st.button("Reset Conversation", type="primary", use_container_width=True):
            st.session_state.messages = []
            st.session_state.debug_info = {}
            # Also reset on server if phone is set
            if st.session_state.phone:
                from streamlit_dashboard.api_client import CrewServerClient
                client = CrewServerClient()
                client.reset_session(st.session_state.phone)
            st.rerun()

        st.divider()

        # Agent state viewer
        st.subheader("Agent State")
        if st.session_state.debug_info:
            st.json(st.session_state.debug_info)
        else:
            st.caption("No agent activity yet.")
```

**Debug Panel** (`streamlit_dashboard/components/debug_panel.py`):

```python
def render_debug_panel():
    """Render debug panel showing agent internals."""
    st.subheader("Debug Panel")

    debug = st.session_state.get("debug_info", {})

    if not debug:
        st.caption("Send a message to see debug info.")
        return

    # Current agent
    agent_name = debug.get("agent_name", "unknown")
    st.metric("Current Agent", agent_name)

    # Session status
    session_status = debug.get("session_status", "unknown")
    status_color = {"active": "üü¢", "expired": "üü°", "none": "üî¥", "created": "üü¢"}.get(session_status, "‚ö™")
    st.metric("Session Status", f"{status_color} {session_status}")

    # Conversation turns
    turn_count = len(st.session_state.messages)
    st.metric("Conversation Turns", turn_count)

    st.divider()

    # Full debug info (REDACTED for GBV per Pitfall 6)
    with st.expander("Raw Debug Data", expanded=False):
        # Check if this is a GBV scenario ‚Äî redact content
        is_gbv = debug.get("is_gbv", False) or agent_name == "gbv_intake"
        if is_gbv:
            st.warning("GBV content redacted for privacy")
            safe_debug = {k: v for k, v in debug.items()
                         if k in ["agent_name", "session_status", "turn_count", "is_gbv"]}
            st.json(safe_debug)
        else:
            st.json(debug)
```

Key: GBV debug content is REDACTED. Only metadata shown for GBV scenarios per research Pitfall 6 and locked GBV firewall requirement.
  </action>
  <verify>
Run `python -c "from streamlit_dashboard.components.chat import render_chat; print('OK')"` to confirm import.
Run `python -c "from streamlit_dashboard.components.sidebar import render_sidebar; print('OK')"` to confirm import.
Run `python -c "from streamlit_dashboard.components.debug_panel import render_debug_panel; print('OK')"` to confirm import.
Verify the full app imports: `python -c "import streamlit_dashboard.app; print('OK')"`.
  </verify>
  <done>Chat component renders WhatsApp-style bubbles without agent labels. Sidebar has all test controls (phone, language, municipality, session override, scenario presets, reset, agent state). Debug panel shows agent info with GBV content redaction.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full end-to-end flow in Streamlit dashboard</name>
  <files>streamlit_dashboard/app.py</files>
  <action>
Human verification of the complete end-to-end flow. No code changes ‚Äî verify that all components work together.
  </action>
  <verify>
1. Start the crew server: `python -m src.api.v1.crew_server` (should bind to localhost:8001)
2. In another terminal, start Streamlit: `streamlit run streamlit_dashboard/app.py`
3. In the browser:
   a. Enter a phone number in the sidebar (e.g., +27821234567)
   b. Type a message and verify it appears as a right-aligned bubble
   c. Verify the agent response appears as a left-aligned bubble (no agent label)
   d. Check the debug panel shows current agent name and session status
   e. Try the "Municipal" scenario preset ‚Äî verify it auto-populates a water pipe message
   f. Try "Session Override: new" and verify routing to auth agent
   g. Click "Reset Conversation" and verify chat clears
   h. Check that the sidebar "Agent State" section shows debug JSON
4. Verify crew server health: visit http://localhost:8001/api/v1/health in browser
  </verify>
  <done>Full round-trip works: Streamlit -> crew server -> DeepSeek -> response displayed. All sidebar controls function. Debug panel shows agent state. GBV content redacted.</done>
</task>

</tasks>

<verification>
1. Streamlit dashboard starts with `streamlit run streamlit_dashboard/app.py`
2. API client connects to crew server at localhost:8001
3. Chat messages display in WhatsApp-style (user right, agent left)
4. No agent labels visible in main chat view
5. Sidebar controls all function (phone input, language, reset, presets)
6. Debug panel shows agent state without GBV content
7. Full round-trip works: type message -> crew server -> DeepSeek -> response displayed
</verification>

<success_criteria>
- Developer can test municipal intake flow end-to-end via Streamlit
- Developer can test auth flow by setting session override to "new"
- Developer can test GBV scenario with content redacted in debug
- Developer can switch languages and see agent respond in selected language
- Crew server health endpoint confirms DeepSeek configuration
- All test controls functional in sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-05-SUMMARY.md`
</output>
