---
phase: 06.7-municipal-intake-agent-testing
plan: 04
type: execute
wave: 2
depends_on: ["06.7-01", "06.7-02"]
files_modified:
  - src/api/v1/crew_server.py
autonomous: true

must_haves:
  truths:
    - "Crew server runs as standalone FastAPI process on localhost:8001 (separate from main.py)"
    - "POST /api/v1/chat accepts phone, message, language, municipality_id, session_override and returns reply, agent_name, session_status, debug"
    - "POST /api/v1/session/reset clears conversation state for a phone number"
    - "GET /api/v1/health returns server status"
    - "X-API-Key header validation protects all endpoints"
    - "Phone detection routes to auth agent (new/expired) or intake agent (active session)"
    - "Crew server startable independently of FastAPI main.py"
  artifacts:
    - path: "src/api/v1/crew_server.py"
      provides: "Standalone FastAPI crew server with /chat, /session/reset, /health endpoints"
      contains: "crew_app"
  key_links:
    - from: "src/api/v1/crew_server.py"
      to: "src/services/phone_detection.py"
      via: "phone session lookup"
      pattern: "detect_phone_session"
    - from: "src/api/v1/crew_server.py"
      to: "src/agents/crews/auth_crew.py"
      via: "auth agent routing"
      pattern: "AuthCrew"
    - from: "src/api/v1/crew_server.py"
      to: "src/agents/flows/intake_flow.py"
      via: "intake agent routing"
      pattern: "IntakeFlow"
    - from: "src/api/v1/crew_server.py"
      to: "src/core/conversation.py"
      via: "conversation state management"
      pattern: "ConversationManager"
---

<objective>
Build the crew server as a standalone FastAPI application that exposes HTTP endpoints for the Streamlit dashboard. The crew server handles phone detection, routes to auth or intake agents, and manages conversation state.

Purpose: API-first approach per locked decision. All features accessible via documented REST API before Streamlit is built. The crew server runs as a separate process from main.py, keeping CrewAI lifecycle isolated from the production API.

Output: A single crew_server.py file that can be started with `uvicorn src.api.v1.crew_server:crew_app --port 8001`.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/core/config.py
@src/core/conversation.py
@src/services/phone_detection.py (created in Plan 01)
@src/agents/crews/auth_crew.py (created in Plan 02)
@src/agents/crews/municipal_crew.py
@src/agents/crews/gbv_crew.py
@src/agents/flows/intake_flow.py
@src/agents/llm.py (created in Plan 01)

# Plan 01 SUMMARY for auth_tool details
@.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-01-SUMMARY.md
# Plan 02 SUMMARY for AuthCrew interface
@.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create crew server with /chat, /session/reset, /health endpoints</name>
  <files>src/api/v1/crew_server.py</files>
  <action>
Create `src/api/v1/crew_server.py` as a standalone FastAPI app. This is NOT added to the main FastAPI app router — it runs as its own process.

**Pydantic Request/Response models** (defined at top of file):

```python
class ChatRequest(BaseModel):
    phone: str
    message: str
    language: str = "en"
    municipality_id: str | None = None
    session_override: str | None = None  # "expired" | "new" | None (for testing)

class ChatResponse(BaseModel):
    reply: str
    agent_name: str  # "auth_agent" | "municipal_intake" | "gbv_intake"
    session_status: str  # "active" | "expired" | "none" | "created"
    debug: dict  # agent state, conversation turns, last API response metadata

class SessionResetRequest(BaseModel):
    phone: str

class HealthResponse(BaseModel):
    status: str
    deepseek_configured: bool
    version: str
```

**Endpoints:**

1. **GET /api/v1/health** — Returns health status. Checks if DEEPSEEK_API_KEY is configured (non-empty). Does NOT call the API.

2. **POST /api/v1/session/reset** — Clears conversation state for a phone number from Redis via ConversationManager. Returns success/error.

3. **POST /api/v1/chat** — The main endpoint. Flow:
   a. Validate X-API-Key header against settings.CREW_SERVER_API_KEY (if configured). If key is empty string, skip validation (dev mode).
   b. If `session_override` is provided ("expired" or "new"), use that instead of real detection (test mode).
   c. Otherwise, call `detect_phone_session(phone, db_session)` for real phone detection.
   d. Based on detection result:
      - `session_status == "active"`: Route to IntakeFlow (existing intake pipeline)
      - `session_status == "expired"`: Route to AuthCrew (OTP re-authentication)
      - `session_status == "none"`: Route to AuthCrew (full registration)
   e. Store conversation history in Redis via ConversationManager. Include full history in each crew call (per research Pitfall 3 — multi-turn state injection).
   f. Use `asyncio.get_event_loop().run_in_executor(None, crew.kickoff, inputs)` for synchronous crew.kickoff() calls.
   g. Return ChatResponse with reply, agent_name, session_status, and debug info.
   h. On any exception from DeepSeek API: return ChatResponse with reply="DeepSeek API unavailable, please retry" (per locked decision — no fallback, no retry, fail fast).

**Security:**
- X-API-Key header validation (simple header check, not OAuth). Key from settings.CREW_SERVER_API_KEY.
- If CREW_SERVER_API_KEY is empty, skip validation (allows easy local dev).
- Bind to localhost only when started directly (not 0.0.0.0).

**Database Session:**
- Use the synchronous engine pattern from ticket_tool.py (_get_sync_engine) for phone detection queries.
- The crew server needs its own SQLAlchemy sync engine (it's a separate process from main.py).

**Conversation State:**
- Initialize ConversationManager with settings.REDIS_URL.
- Store each message/response turn.
- Include full conversation_history as a formatted string in crew task descriptions (for multi-turn continuity).

**GBV Security in Debug:**
- When the active agent is GBV (category == "gbv"), the debug dict MUST NOT include conversation content. Only metadata: agent_name, turn_count, session_status. Per research Pitfall 6, redact content for GBV scenarios.

**Startup:**
Add `if __name__ == "__main__":` block:
```python
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(crew_app, host="127.0.0.1", port=8001)
```

Also set OPENAI_API_KEY="dummy" in environment at module level if not already set (per research Pitfall 1 — CrewAI/LiteLLM validation):
```python
import os
os.environ.setdefault("OPENAI_API_KEY", "dummy-key-for-crewai-validation")
```
  </action>
  <verify>
Run `python -c "from src.api.v1.crew_server import crew_app; print(type(crew_app))"` to confirm import.
Run `python -c "from src.api.v1.crew_server import ChatRequest, ChatResponse; print('OK')"` to confirm models.
Check that the crew server can start: `timeout 5 python -m src.api.v1.crew_server 2>&1 || true` (should show uvicorn startup, then timeout).
  </verify>
  <done>Crew server runs as standalone FastAPI on localhost:8001 with /chat, /session/reset, /health endpoints. Phone detection routes to auth or intake agents. X-API-Key security. GBV content redacted in debug. Conversation history injected for multi-turn state.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.api.v1.crew_server import crew_app"` imports without error
2. Crew server has 3 endpoints: GET /api/v1/health, POST /api/v1/chat, POST /api/v1/session/reset
3. ChatRequest and ChatResponse models have all required fields
4. Phone detection result routes to correct agent (auth for new/expired, intake for active)
5. OPENAI_API_KEY dummy set to prevent CrewAI validation errors
6. GBV debug content is redacted
7. All existing tests still pass: `pytest tests/ -x --ignore=tests/integration -q`
</verification>

<success_criteria>
- Crew server is a standalone FastAPI app (crew_app), not part of main.py
- /chat endpoint handles phone detection -> auth/intake routing
- /session/reset clears conversation state
- /health reports server status
- X-API-Key header validation for dev security
- Conversation history injected into crew tasks for multi-turn continuity
- GBV content never exposed in debug output
- Server startable with `python -m src.api.v1.crew_server` or `uvicorn src.api.v1.crew_server:crew_app --port 8001`
</success_criteria>

<output>
After completion, create `.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-04-SUMMARY.md`
</output>
