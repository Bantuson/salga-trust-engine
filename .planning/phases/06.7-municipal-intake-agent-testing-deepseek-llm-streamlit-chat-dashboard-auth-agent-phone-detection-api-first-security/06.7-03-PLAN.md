---
phase: 06.7-municipal-intake-agent-testing
plan: 03
type: execute
wave: 2
depends_on: ["06.7-01", "06.7-02"]
files_modified:
  - src/agents/crews/municipal_crew.py
  - src/agents/crews/gbv_crew.py
  - src/agents/flows/intake_flow.py
autonomous: true

must_haves:
  truths:
    - "MunicipalCrew accepts an LLM object instead of string llm_model parameter"
    - "GBVCrew accepts an LLM object instead of string llm_model parameter"
    - "IntakeFlow uses get_deepseek_llm() as default LLM"
    - "All existing crew functionality preserved (no behavioral changes)"
  artifacts:
    - path: "src/agents/crews/municipal_crew.py"
      provides: "MunicipalCrew with LLM object support"
      contains: "get_deepseek_llm"
    - path: "src/agents/crews/gbv_crew.py"
      provides: "GBVCrew with LLM object support"
      contains: "get_deepseek_llm"
    - path: "src/agents/flows/intake_flow.py"
      provides: "IntakeFlow with DeepSeek LLM default"
      contains: "get_deepseek_llm"
  key_links:
    - from: "src/agents/crews/municipal_crew.py"
      to: "src/agents/llm.py"
      via: "LLM factory import"
      pattern: "from src.agents.llm import get_deepseek_llm"
    - from: "src/agents/crews/gbv_crew.py"
      to: "src/agents/llm.py"
      via: "LLM factory import"
      pattern: "from src.agents.llm import get_deepseek_llm"
---

<objective>
Update existing MunicipalCrew, GBVCrew, and IntakeFlow to use the crewai.LLM object (from get_deepseek_llm()) instead of passing a string model name. This wires all crews to DeepSeek V3.2.

Purpose: The existing crews use `llm=self.llm_model` where llm_model is a string like "gpt-4o". This doesn't work with custom base_url providers like DeepSeek. Switching to an LLM object enables DeepSeek V3.2 as the backing model.

Output: Updated crew files that accept LLM objects, defaulting to DeepSeek.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/agents/crews/municipal_crew.py
@src/agents/crews/gbv_crew.py
@src/agents/flows/intake_flow.py
@src/agents/llm.py (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MunicipalCrew and GBVCrew to accept LLM objects</name>
  <files>src/agents/crews/municipal_crew.py, src/agents/crews/gbv_crew.py</files>
  <action>
**MunicipalCrew** (`src/agents/crews/municipal_crew.py`):

Change the constructor signature from `llm_model: str = "gpt-4o"` to `llm=None`. When llm is None, call `get_deepseek_llm()` to get the default.

Specific changes:
1. Add import: `from src.agents.llm import get_deepseek_llm`
2. Change `__init__` parameter from `llm_model: str = "gpt-4o"` to `llm=None`
3. In `__init__`, set `self.llm = llm or get_deepseek_llm()` (replace `self.llm_model = llm_model`)
4. In `create_crew()`, change `llm=self.llm_model` to `llm=self.llm` in Agent constructor
5. Preserve ALL other existing behavior (YAML config loading, language prompts, tool assignment, crew creation)

**GBVCrew** (`src/agents/crews/gbv_crew.py`):

Same pattern as MunicipalCrew:
1. Add import: `from src.agents.llm import get_deepseek_llm`
2. Change `__init__` parameter from `llm_model: str = "gpt-4o"` to `llm=None`
3. Set `self.llm = llm or get_deepseek_llm()`
4. Change `llm=self.llm_model` to `llm=self.llm` in Agent constructor
5. Preserve ALL existing GBV-specific behavior: memory=False, max_iter=8, is_sensitive checks, session clearing

CRITICAL: This is a minimal change. Do NOT rewrite the crews. Only change the LLM parameter handling. All existing prompts, tools, task descriptions, and security measures stay exactly as they are.

BACKWARD COMPATIBILITY: The IntakeFlow currently passes `llm_model=self._llm_model` (a string) to MunicipalCrew and GBVCrew. After this change, it should pass `llm=...` instead. Update IntakeFlow in Task 2.
  </action>
  <verify>
Run `python -c "from src.agents.crews.municipal_crew import MunicipalCrew; print('OK')"` to confirm import.
Run `python -c "from src.agents.crews.gbv_crew import GBVCrew; print('OK')"` to confirm import.
Run existing tests: `pytest tests/test_municipal_crew.py tests/test_gbv_crew.py -x -q` (should still pass with mocked LLM).
  </verify>
  <done>Both crews accept LLM object parameter, defaulting to DeepSeek V3.2 via get_deepseek_llm(). All existing behavior preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Update IntakeFlow to use DeepSeek LLM</name>
  <files>src/agents/flows/intake_flow.py</files>
  <action>
Update IntakeFlow to pass LLM objects to crews instead of string model names:

1. Add import: `from src.agents.llm import get_deepseek_llm`
2. Change `__init__` parameter from `llm_model: str = "gpt-4o"` to `llm=None`
3. Set `self._llm = llm or get_deepseek_llm()` (replace `self._llm_model = llm_model`)
4. In `handle_municipal()`, change `MunicipalCrew(language=self.state.language, llm_model=self._llm_model)` to `MunicipalCrew(language=self.state.language, llm=self._llm)`
5. In `handle_gbv()`, change `GBVCrew(language=self.state.language, llm_model=self._llm_model)` to `GBVCrew(language=self.state.language, llm=self._llm)`

Preserve ALL existing flow logic: language detection, keyword classification, GBV priority routing, conversation manager, session clearing after GBV.

This is a minimal parameter rename â€” the flow orchestration logic stays identical.
  </action>
  <verify>
Run `python -c "from src.agents.flows.intake_flow import IntakeFlow; print('OK')"` to confirm import.
Run existing tests: `pytest tests/test_intake_flow.py -x -q` (should still pass).
Run full test suite: `pytest tests/ -x --ignore=tests/integration -q` to check no regressions.
  </verify>
  <done>IntakeFlow passes LLM objects to crews. All existing flow logic preserved. No regressions in test suite.</done>
</task>

</tasks>

<verification>
1. MunicipalCrew imports and constructs with no arguments: `MunicipalCrew()`
2. GBVCrew imports and constructs with no arguments: `GBVCrew()`
3. IntakeFlow imports and constructs with redis_url only: `IntakeFlow(redis_url="redis://localhost:6379/0")`
4. All crew tests pass with mocked LLM
5. Full unit test suite passes: `pytest tests/ -x --ignore=tests/integration -q`
</verification>

<success_criteria>
- MunicipalCrew, GBVCrew, and IntakeFlow all use crewai.LLM objects instead of string model names
- Default LLM is DeepSeek V3.2 via get_deepseek_llm() factory
- All existing behavior preserved (prompts, tools, security measures)
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06.7-municipal-intake-agent-testing-deepseek-llm-streamlit-chat-dashboard-auth-agent-phone-detection-api-first-security/06.7-03-SUMMARY.md`
</output>
