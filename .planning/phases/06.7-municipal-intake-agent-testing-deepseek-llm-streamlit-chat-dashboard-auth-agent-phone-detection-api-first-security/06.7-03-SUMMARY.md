---
phase: 06.7-municipal-intake-agent-testing
plan: 03
subsystem: agents
tags: [crewai, deepseek, llm, municipal-crew, gbv-crew, intake-flow]

requires:
  - phase: 06.7-01
    provides: get_deepseek_llm() factory in src/agents/llm.py

provides:
  - MunicipalCrew wired to DeepSeek V3.2 via LLM object (not string model name)
  - GBVCrew wired to DeepSeek V3.2 via LLM object with all privacy controls preserved
  - IntakeFlow passes LLM objects to both crews instead of string model names

affects:
  - 06.7-04 (Streamlit dashboard that invokes IntakeFlow)
  - 06.7-05 (crew server that instantiates crews)
  - Any code that constructs MunicipalCrew, GBVCrew, or IntakeFlow

tech-stack:
  added: []
  patterns:
    - "LLM object injection: crews accept llm=None and default to get_deepseek_llm()"
    - "Lazy LLM init: LLM object created at crew construction time, not module import"

key-files:
  created: []
  modified:
    - src/agents/crews/municipal_crew.py
    - src/agents/crews/gbv_crew.py
    - src/agents/flows/intake_flow.py
    - tests/test_municipal_crew.py
    - tests/test_gbv_crew.py

key-decisions:
  - "Crews accept llm=None parameter (not llm_model: str) — LLM object enables custom base_url for DeepSeek"
  - "Default to get_deepseek_llm() when llm=None — all crews default to DeepSeek V3.2 without explicit config"
  - "IntakeFlow._llm (not ._llm_model) — consistent naming with LLM object type"

patterns-established:
  - "LLM injection pattern: __init__(self, ..., llm=None) with self.llm = llm or get_deepseek_llm()"

requirements-completed: []

duration: 12.7min
completed: 2026-02-17
---

# Phase 06.7 Plan 03: Crew LLM Wiring Summary

**MunicipalCrew, GBVCrew, and IntakeFlow switched from string model names to crewai.LLM objects, enabling DeepSeek V3.2 as the default provider via get_deepseek_llm()**

## Performance

- **Duration:** 12.7 min (761s)
- **Started:** 2026-02-17T08:26:05Z
- **Completed:** 2026-02-17T08:38:46Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Both crews now accept `llm=None` and default to `get_deepseek_llm()` — DeepSeek V3.2 as the backing LLM
- IntakeFlow propagates the LLM object through to both crew types via `llm=self._llm`
- All existing behavior preserved: GBV privacy controls (memory=False, max_iter=8), municipal YAML configs, trilingual prompts, session clearing
- All 54 crew/flow unit tests pass (16 municipal + 21 GBV + 17 intake flow)

## Task Commits

1. **Task 1: Update MunicipalCrew and GBVCrew to accept LLM objects** - `a03c7c2` (feat)
2. **Task 2: Update IntakeFlow to use DeepSeek LLM** - `aeadf94` (feat)

**Plan metadata:** see final commit below

## Files Created/Modified
- `src/agents/crews/municipal_crew.py` - Added `get_deepseek_llm` import, changed `llm_model: str` param to `llm=None`, updated Agent constructor
- `src/agents/crews/gbv_crew.py` - Same pattern, all GBV-specific privacy controls preserved unchanged
- `src/agents/flows/intake_flow.py` - Changed to `llm=None`/`self._llm`, passes LLM object to both crew types
- `tests/test_municipal_crew.py` - Updated to test `crew.llm` (LLM object) instead of `crew.llm_model` (string)
- `tests/test_gbv_crew.py` - Updated `llm_model="gpt-4o"` references to `llm=None`

## Decisions Made
- Crews accept `llm=None` (not `llm_model: str`) because `crewai.LLM` objects support `base_url` for non-OpenAI providers like DeepSeek; string model names do not
- Default to `get_deepseek_llm()` at construction time (not import time) — avoids side effects at module import

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Updated test assertions to match new LLM interface**
- **Found during:** Task 1 (MunicipalCrew/GBVCrew update)
- **Issue:** Tests asserted `crew.llm_model == "gpt-4o"` and passed `llm_model="gpt-4o"` — both incompatible with the new `llm=None` interface
- **Fix:** Updated `test_municipal_crew_initialization_english` to check `crew.llm is not None`, renamed `test_municipal_crew_custom_llm_model` to test with a mock LLM object, replaced all `llm_model="gpt-4o"` in test_gbv_crew.py with `llm=None`
- **Files modified:** tests/test_municipal_crew.py, tests/test_gbv_crew.py
- **Verification:** 54 crew/flow tests pass
- **Committed in:** a03c7c2 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 2 - missing critical update to keep tests aligned)
**Impact on plan:** Required update — tests must reflect the new interface. No scope creep.

## Issues Encountered
- Pre-existing failures in unrelated tests (test_event_broadcaster, test_storage_service, test_whatsapp_session, test_supabase_auth, test_rls_policies) are out of scope and were not introduced by this plan. Logged to deferred-items context.

## Next Phase Readiness
- MunicipalCrew, GBVCrew, and IntakeFlow all default to DeepSeek V3.2 — ready for live LLM calls in Phase 06.7-04 (Streamlit dashboard) and 06.7-05 (crew server)
- No blockers

---
*Phase: 06.7-municipal-intake-agent-testing*
*Completed: 2026-02-17*
