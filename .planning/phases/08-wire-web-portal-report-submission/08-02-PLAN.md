---
phase: 08-wire-web-portal-report-submission
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - frontend-public/src/pages/ReportIssuePage.tsx
autonomous: true
requirements:
  - RPT-02
  - RPT-03
  - RPT-05
  - RPT-06

must_haves:
  truths:
    - "Citizen submitting a report via web portal calls POST /api/v1/reports/submit with real Supabase auth token"
    - "Receipt card displays real tracking number from backend response (TKT-YYYYMMDD-xxxxxx format)"
    - "Frontend maps display category strings to backend enum values before submitting"
    - "GPS accuracy is captured and sent in the location payload"
    - "GBV reports send is_gbv: true in request body"
    - "Upload confirm endpoint is called after each file upload to create MediaAttachment DB records"
  artifacts:
    - path: "frontend-public/src/pages/ReportIssuePage.tsx"
      provides: "Real API integration for report submission with auth, GPS, category mapping, media linking, GBV support"
      contains: "api/v1/reports/submit"
  key_links:
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "POST /api/v1/reports/submit"
      via: "fetch with Bearer token from supabase.auth.getSession()"
      pattern: "api/v1/reports/submit"
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "POST /api/v1/uploads/confirm"
      via: "fetch after Supabase Storage upload to create MediaAttachment record"
      pattern: "api/v1/uploads/confirm"
    - from: "frontend-public/src/pages/ReportIssuePage.tsx"
      to: "ReportReceipt component"
      via: "setReceiptData with data.tracking_number from API response"
      pattern: "data.tracking_number"
---

<objective>
Wire ReportIssuePage.tsx to call the real backend API, replacing the mock submission with a live POST /api/v1/reports/submit call.

Purpose: This is the most critical gap in the v1.0 milestone — the web portal report submission has never been connected end-to-end. The frontend generates a fake tracking number client-side and never calls the backend. With the backend bugs fixed in Plan 01, this plan wires the frontend to the real API, enabling all downstream requirements: photo linking (RPT-03), GPS persistence (RPT-04), tracking numbers (RPT-05), GBV reports (RPT-06).

Output: A working end-to-end report submission flow — citizen fills form, clicks submit, backend creates ticket with PostGIS location, returns real tracking number, receipt displays it.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-wire-web-portal-report-submission/08-RESEARCH.md
@.planning/phases/08-wire-web-portal-report-submission/08-01-SUMMARY.md
@frontend-public/src/pages/ReportIssuePage.tsx
@frontend-public/src/hooks/useCitizenReports.ts
@frontend-public/src/contexts/AuthContext.tsx
@src/schemas/report.py
@src/api/v1/uploads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire handleSubmit and photo upload to real backend API</name>
  <files>frontend-public/src/pages/ReportIssuePage.tsx</files>
  <action>
Make the following changes to `frontend-public/src/pages/ReportIssuePage.tsx`:

**1. Update LocationData interface to include accuracy:**
```typescript
interface LocationData {
  latitude: number;
  longitude: number;
  accuracy: number;
}
```

**2. Update captureLocation to store accuracy:**
In the `getCurrentPosition` success callback, add `accuracy`:
```typescript
setLocation({
  latitude: position.coords.latitude,
  longitude: position.coords.longitude,
  accuracy: position.coords.accuracy,
});
```

**3. Add CATEGORY_MAP constant (before the component function or at top of component):**
```typescript
const CATEGORY_MAP: Record<string, string> = {
  'Water & Sanitation': 'water',
  'Electricity': 'electricity',
  'Roads & Potholes': 'roads',
  'Waste Management': 'waste',
  'Public Safety': 'other',
  'Housing': 'other',
  'GBV/Abuse': 'gbv',
  'Other': 'other',
};
```

**4. Update handlePhotoUpload to call upload confirm endpoint:**
After each successful Supabase Storage upload (after `if (uploadError) throw uploadError;`), call the backend to create a MediaAttachment DB record:

```typescript
// After successful Supabase Storage upload, create MediaAttachment record
const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:8000';
const { data: { session: uploadSession } } = await supabase.auth.getSession();
if (uploadSession) {
  try {
    const confirmResponse = await fetch(
      `${apiUrl}/api/v1/uploads/confirm?file_id=${fileId}&purpose=${isGbv ? 'evidence' : 'evidence'}`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${uploadSession.access_token}`,
        },
      }
    );
    if (!confirmResponse.ok) {
      console.warn('[ReportIssuePage] Upload confirm failed, media may not link:', await confirmResponse.text());
    }
  } catch (confirmErr) {
    console.warn('[ReportIssuePage] Upload confirm error:', confirmErr);
    // Non-fatal — photo is in storage, just won't be linked to ticket
  }
}
```

**5. Replace the entire handleSubmit function body (the mock):**
Replace the mock `setTimeout` and fake tracking number generation with a real API call. The full replacement:

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setError(null);

  // Validation
  if (!category) {
    setError('Please select a category');
    return;
  }

  if (description.length < 20) {
    setError('Description must be at least 20 characters');
    return;
  }

  if (!location && !manualAddress) {
    setError('Please capture your location or enter an address manually');
    return;
  }

  if (!isResidenceVerified) {
    setError('You must verify your proof of residence before submitting a report');
    return;
  }

  setIsSubmitting(true);

  try {
    const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:8000';

    // Map display category to backend enum value
    const backendCategory = isGbv ? 'gbv' : (CATEGORY_MAP[category] ?? 'other');

    const payload = {
      description,
      category: backendCategory,
      location: location ? {
        latitude: location.latitude,
        longitude: location.longitude,
        accuracy: location.accuracy,
        source: 'gps',
      } : null,
      manual_address: manualAddress || null,
      media_file_ids: uploadedFiles.map(f => f.id),
      language: 'en',
      is_gbv: isGbv,
    };

    // Get fresh auth session
    const { data: { session: submitSession } } = await supabase.auth.getSession();
    if (!submitSession) {
      throw new Error('Your session has expired. Please log in again.');
    }

    const response = await fetch(`${apiUrl}/api/v1/reports/submit`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${submitSession.access_token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ detail: response.statusText }));
      throw new Error(errorData.detail || `Submit failed: ${response.statusText}`);
    }

    const data = await response.json();

    // Set receipt data with REAL tracking number from backend
    setReceiptData({
      trackingNumber: data.tracking_number,
      category,
      description,
      expectedResponseTime: getExpectedResponseTime(category),
    });

    // Switch to receipt state
    setPageState('receipt');

    // Reset form
    setCategory('');
    setDescription('');
    setLocation(null);
    setManualAddress('');
    setUploadedFiles([]);
    setIsGbv(false);
  } catch (error) {
    console.error('[ReportIssuePage] Submit failed:', error);
    setError(error instanceof Error ? error.message : 'Failed to submit report. Please try again.');
  } finally {
    setIsSubmitting(false);
  }
};
```

**Key requirements satisfied by this change:**
- RPT-02: Real API call to `POST /api/v1/reports/submit`
- RPT-03: `media_file_ids` sent from uploaded files (with confirm endpoint creating DB records)
- RPT-05: `data.tracking_number` from backend response displayed on receipt
- RPT-06: `is_gbv: true` sent in payload when GBV category selected

**Important: Do NOT change any UI/JSX.** Only modify the TypeScript logic (interfaces, handlers, constants).
  </action>
  <verify>
Run `cd frontend-public && npm run build:check 2>&1 | tail -10` to verify TypeScript compilation.
Run `cd frontend-public && npm run build 2>&1 | tail -10` to verify production build succeeds.
Verify the mock is completely removed: `grep -c "setTimeout.*1500\|Mock tracking\|TKT-.*Math.random" frontend-public/src/pages/ReportIssuePage.tsx` should return 0.
Verify real API call exists: `grep -c "api/v1/reports/submit" frontend-public/src/pages/ReportIssuePage.tsx` should return at least 1.
Verify upload confirm call exists: `grep -c "api/v1/uploads/confirm" frontend-public/src/pages/ReportIssuePage.tsx` should return at least 1.
Verify accuracy is captured: `grep -c "position.coords.accuracy\|accuracy:" frontend-public/src/pages/ReportIssuePage.tsx` should return at least 2.
  </verify>
  <done>
handleSubmit calls POST /api/v1/reports/submit with Supabase auth token. Receipt displays real tracking_number from backend. Category mapping converts display strings to backend enum. GPS accuracy captured and sent. is_gbv flag sent for GBV reports. Upload confirm endpoint called after each photo upload to create MediaAttachment records. Frontend builds with zero TypeScript errors. No mock submit code remains.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend-public && npm run build` — builds successfully with zero errors
2. `grep -c "setTimeout.*1500" frontend-public/src/pages/ReportIssuePage.tsx` — returns 0 (mock removed)
3. `grep "api/v1/reports/submit" frontend-public/src/pages/ReportIssuePage.tsx` — API endpoint referenced
4. `grep "api/v1/uploads/confirm" frontend-public/src/pages/ReportIssuePage.tsx` — Upload confirm referenced
5. `grep "CATEGORY_MAP" frontend-public/src/pages/ReportIssuePage.tsx` — Category mapping present
6. `grep "accuracy" frontend-public/src/pages/ReportIssuePage.tsx` — GPS accuracy field present
7. `grep "is_gbv" frontend-public/src/pages/ReportIssuePage.tsx` — GBV flag sent in payload
8. `grep "data.tracking_number" frontend-public/src/pages/ReportIssuePage.tsx` — Real tracking number used
</verification>

<success_criteria>
- ReportIssuePage calls real POST /api/v1/reports/submit (not a mock setTimeout)
- Auth token obtained from supabase.auth.getSession() and sent as Bearer header
- Category mapping converts "Water & Sanitation" -> "water", "Roads & Potholes" -> "roads", etc.
- GPS accuracy captured from position.coords.accuracy and included in LocationData payload
- media_file_ids array sent with uploaded file IDs (upload confirm creates DB records)
- is_gbv: true sent when GBV category is selected
- Receipt card displays data.tracking_number from backend response
- Frontend builds with zero TypeScript errors
- Error handling shows user-readable messages from backend response
</success_criteria>

<output>
After completion, create `.planning/phases/08-wire-web-portal-report-submission/08-02-SUMMARY.md`
</output>
