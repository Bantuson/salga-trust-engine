---
phase: "06.9"
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/conversation.py
  - src/agents/tools/ticket_lookup_tool.py
  - src/agents/crews/ticket_status_crew.py
  - src/agents/config/agents.yaml
  - src/agents/config/tasks.yaml
  - src/agents/crews/__init__.py
autonomous: true
requirements:
  - AI-05

must_haves:
  truths:
    - "ConversationState has pending_intent, pre_auth_message, and routing_phase fields for cross-turn state"
    - "lookup_ticket_tool queries tickets scoped to user_id only (never cross-user)"
    - "GBV tickets return minimal info (status + emergency numbers only) in lookup results"
    - "TicketStatusCrew follows BaseCrew pattern with agent_key, task_key, tools, memory_enabled"
    - "YAML config has manager_agent, ticket_status_agent, manager_task, ticket_status_task entries"
  artifacts:
    - path: "src/core/conversation.py"
      provides: "Extended ConversationState with routing fields"
      contains: "pending_intent"
    - path: "src/agents/tools/ticket_lookup_tool.py"
      provides: "User-scoped ticket lookup tool"
      contains: "lookup_ticket"
    - path: "src/agents/crews/ticket_status_crew.py"
      provides: "TicketStatusCrew specialist"
      contains: "class TicketStatusCrew"
    - path: "src/agents/config/agents.yaml"
      provides: "Manager and ticket status agent YAML config"
      contains: "manager_agent"
    - path: "src/agents/config/tasks.yaml"
      provides: "Manager and ticket status task YAML config"
      contains: "manager_task"
  key_links:
    - from: "src/agents/crews/ticket_status_crew.py"
      to: "src/agents/tools/ticket_lookup_tool.py"
      via: "tools list import"
      pattern: "from src.agents.tools.ticket_lookup_tool import"
    - from: "src/agents/crews/ticket_status_crew.py"
      to: "src/agents/crews/base_crew.py"
      via: "BaseCrew inheritance"
      pattern: "class TicketStatusCrew\\(BaseCrew\\)"
---

<objective>
Create foundational components for Phase 6.9: extend ConversationState for cross-turn routing context, build the new TicketStatusCrew specialist with its scoped lookup tool, and add all YAML agent/task configuration entries needed by the manager architecture.

Purpose: These are the building blocks that the ManagerCrew (Plan 02) and integration layer (Plan 03) depend on. ConversationState extensions enable pending intent persistence across auth handoffs. TicketStatusCrew adds the new ticket lookup capability. YAML config entries define all agent roles/goals for the hierarchical process.

Output: Extended ConversationState model, ticket_lookup_tool, TicketStatusCrew, updated agents.yaml and tasks.yaml with manager and ticket_status entries.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/conversation.py
@src/agents/crews/base_crew.py
@src/agents/tools/ticket_tool.py
@src/agents/config/agents.yaml
@src/agents/config/tasks.yaml
@src/agents/crews/__init__.py
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ConversationState and create ticket_lookup_tool</name>
  <files>
    src/core/conversation.py
    src/agents/tools/ticket_lookup_tool.py
  </files>
  <action>
    **ConversationState extension (src/core/conversation.py):**
    Add three new optional fields to the ConversationState model:
    - `pending_intent: str | None = None` — stores classified intent ("municipal_report", "gbv_report", "ticket_status") before auth handoff. Cleared after routing.
    - `pre_auth_message: str | None = None` — the original citizen message that triggered auth. Restored after auth for direct specialist routing without citizen repeating.
    - `routing_phase: str = "manager"` — tracks which handler owns the session: "manager" | "auth" | "municipal" | "gbv" | "ticket_status". Used by crew_server.py to short-circuit manager re-entry for active specialist sessions.

    These fields follow the existing Pydantic BaseModel pattern. No changes to ConversationManager methods — they already serialize/deserialize the full model via model_dump_json/model_validate_json.

    **ticket_lookup_tool (src/agents/tools/ticket_lookup_tool.py):**
    Create a new CrewAI tool following the exact pattern in ticket_tool.py.

    Implementation function `_lookup_ticket_impl(user_id: str, tracking_number: str = "")`:
    - SECURITY: Assert `user_id` is truthy — never look up tickets without it. This is defense-in-depth since admin client bypasses RLS.
    - Import `get_supabase_admin` from `src.core.supabase` (same pattern as ticket_tool.py).
    - Query `tickets` table with: `.select("tracking_number, category, status, severity, address, created_at, updated_at, resolved_at, is_sensitive, first_responded_at, escalated_at").eq("user_id", user_id).order("created_at", desc=True).limit(10)`
    - If `tracking_number` is provided and non-empty, add `.eq("tracking_number", tracking_number.strip().upper())`
    - Process results: for each ticket, if `is_sensitive` is True, return minimal info only: `{"tracking_number": t["tracking_number"], "category": "sensitive report", "status": t["status"], "note": "For support: SAPS 10111 | GBV Helpline 0800 150 150"}` (SEC-05 consistent with citizen portal GBV card pattern)
    - For non-sensitive tickets, return: tracking_number, category, status, severity, address, created_at, updated_at, resolved_at, first_responded_at, escalated_at
    - Return dict: `{"tickets": formatted_list, "count": len(formatted_list), "total": len(result.data)}`
    - Wrap with `@tool("lookup_ticket")` decorator

    Error handling: wrap Supabase call in try/except, return `{"error": str(e), "tickets": [], "count": 0}` on failure.
  </action>
  <verify>
    Run: `python -c "from src.core.conversation import ConversationState; s = ConversationState(user_id='x', session_id='y', tenant_id='z', created_at=0); assert hasattr(s, 'pending_intent'); assert hasattr(s, 'pre_auth_message'); assert hasattr(s, 'routing_phase'); assert s.routing_phase == 'manager'; print('OK')"` — should print OK.
    Run: `python -c "from src.agents.tools.ticket_lookup_tool import lookup_ticket; print(type(lookup_ticket))"` — should print a crewai tool type.
  </verify>
  <done>
    ConversationState has pending_intent, pre_auth_message, and routing_phase fields with correct defaults. ticket_lookup_tool exists with user_id-scoped queries and GBV minimal info pattern. Both import without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TicketStatusCrew and update YAML config and exports</name>
  <files>
    src/agents/crews/ticket_status_crew.py
    src/agents/config/agents.yaml
    src/agents/config/tasks.yaml
    src/agents/crews/__init__.py
  </files>
  <action>
    **TicketStatusCrew (src/agents/crews/ticket_status_crew.py):**
    Create a new specialist crew following the BaseCrew pattern exactly (see auth_crew.py, municipal_crew.py as templates).

    ```python
    class TicketStatusCrew(BaseCrew):
        agent_key = "ticket_status_agent"
        task_key = "ticket_status_task"
        tools = [lookup_ticket]  # from src.agents.tools.ticket_lookup_tool
        memory_enabled = False  # No PII in memory
    ```

    - Import `lookup_ticket` from `src.agents.tools.ticket_lookup_tool`
    - Override `get_language_prompt(language)` with trilingual ticket status prompts:
      - EN: Instructions to use plain language, show most recent ticket first, offer to show more, present GBV tickets with minimal info only
      - ZU: Same instructions in isiZulu register
      - AF: Same instructions in Afrikaans register
    - Override `parse_result(result)` to extract ticket lookup data from crew output. Use super().parse_result() for base extraction, then add `"agent": "ticket_status"` to the result dict.
    - Override `get_error_response(error)` with warm Gugu error: "I'm Gugu from SALGA Trust Engine. I couldn't find that report right now. Please check your tracking number or try again."
    - Override `build_kickoff_inputs(context)` to pass: user_id, language, tracking_number (if present in context), conversation_history

    **agents.yaml additions:**
    Add two new entries at the END of agents.yaml (after gbv_agent):

    `manager_agent`:
    - role: "Municipal Services Manager"
    - goal: "Greet citizens warmly, understand their intent, and route them to the right specialist in {language}"
    - backstory: Full Gugu persona (see research code example). Include IDENTITY RULES section. Key points: first-contact manager, greets, understands intent, connects with specialists. Warm, confident, community-focused tone. Does NOT solve problems directly — connects people with those who do.
    - allow_delegation: true (CRITICAL for hierarchical process)
    - max_iter: 5
    - verbose: false

    `ticket_status_agent`:
    - role: "Ticket Status Specialist"
    - goal: "Help citizens check the status of their existing reports in {language}"
    - backstory: Gugu identity, focused on helping citizens track their reports. Show current status and timeline. Most recent ticket first, offer to show more. GBV tickets get minimal display (SEC-05). Be empathetic about unresolved issues. Include IDENTITY RULES.
    - allow_delegation: false
    - max_iter: 5
    - verbose: false

    **tasks.yaml additions:**
    Add two new entries at the END of tasks.yaml:

    `manager_task`:
    - description: Template with placeholders {message}, {phone}, {language}, {session_status}, {user_exists}, {user_id}, {conversation_history}, {pending_intent}. Contains the full routing logic:
      STEP 1: GREET (if new session)
      STEP 2: CLASSIFY INTENT into greeting/auth/municipal_report/gbv_report/ticket_status/off_topic
      STEP 3: AUTH CHECK (greeting and off_topic = no auth; municipal_report, gbv_report, ticket_status = requires active session)
      STEP 4: DELEGATE with exact coworker role strings: "Citizen Authentication Specialist", "Municipal Services Intake Specialist", "Crisis Support Specialist", "Ticket Status Specialist"
      Include: IMPORTANT note about passing full context when delegating.
    - expected_output: "The specialist's response to the citizen, or Gugu's own greeting/redirect response."

    `ticket_status_task`:
    - description: Template with placeholders {user_id}, {language}, {conversation_history}, {tracking_number}. Instructions to use the lookup_ticket tool with user_id (mandatory), optionally with tracking_number. Show most recent first. For multiple tickets: show first, then "You have X more open reports." GBV tickets: minimal info only (status + SAPS/GBV helpline numbers).
    - expected_output: "Ticket status information presented clearly to the citizen with next steps."

    **__init__.py update:**
    Add TicketStatusCrew to imports and __all__ list.
  </action>
  <verify>
    Run: `python -c "from src.agents.crews import TicketStatusCrew; print('TicketStatusCrew imported')"` — should print message.
    Run: `python -c "import yaml; d = yaml.safe_load(open('src/agents/config/agents.yaml')); assert 'manager_agent' in d; assert 'ticket_status_agent' in d; print('agents.yaml OK')"` — should print OK.
    Run: `python -c "import yaml; d = yaml.safe_load(open('src/agents/config/tasks.yaml')); assert 'manager_task' in d; assert 'ticket_status_task' in d; print('tasks.yaml OK')"` — should print OK.
  </verify>
  <done>
    TicketStatusCrew follows BaseCrew pattern with lookup_ticket tool. YAML config has all 5 agent entries (auth_agent, municipal_intake_agent, gbv_agent, manager_agent, ticket_status_agent) and all 4 task entries (municipal_intake_task, auth_task, manager_task, ticket_status_task). __init__.py exports TicketStatusCrew.
  </done>
</task>

</tasks>

<verification>
1. All new files import without errors: `python -c "from src.core.conversation import ConversationState; from src.agents.tools.ticket_lookup_tool import lookup_ticket; from src.agents.crews.ticket_status_crew import TicketStatusCrew; print('All imports OK')"`
2. ConversationState serialization round-trips with new fields: create state with pending_intent="municipal_report", dump to JSON, validate back.
3. YAML configs parse cleanly and contain all required entries.
4. Existing tests still pass: `python -m pytest tests/test_municipal_crew.py tests/test_gbv_crew.py -x`
</verification>

<success_criteria>
- ConversationState extended with 3 new fields (pending_intent, pre_auth_message, routing_phase)
- ticket_lookup_tool scoped to user_id with GBV minimal info pattern
- TicketStatusCrew follows BaseCrew pattern
- YAML configs have all 5 agents and 4 tasks
- All imports work, no regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-01-SUMMARY.md`
</output>
