---
phase: "06.9"
plan: 2
subsystem: "agentic-ai"
tags: ["crewai", "multi-agent", "manager-architecture", "hierarchical-process", "routing"]
dependency_graph:
  requires:
    - "06.9-01 (ConversationState routing fields, YAML config, TicketStatusCrew)"
  provides:
    - "ManagerCrew class with Process.hierarchical"
    - "LLM-based intent routing (5 categories)"
    - "All 5 crews exportable from src.agents.crews"
  affects:
    - "src/agents/crews/__init__.py (ManagerCrew added to exports)"
    - "src/agents/flows/intake_flow.py (will be updated in Plan 03 to use ManagerCrew)"
tech_stack:
  added: []
  patterns:
    - "Process.hierarchical with custom manager_agent (not BaseCrew subclass)"
    - "Manager agent has no tools — CrewAI hierarchical adds delegate_work automatically"
    - "manager_agent AND manager_llm both set to prevent OpenAI fallback"
    - "Lazy LLM initialization via @property to avoid circular imports"
    - "Thread pool executor for async crew kickoff"
key_files:
  created:
    - path: "src/agents/crews/manager_crew.py"
      purpose: "ManagerCrew orchestrator with Process.hierarchical, Gugu persona manager agent, 4 specialist agents as coworkers"
  modified:
    - path: "src/agents/crews/__init__.py"
      change: "Added ManagerCrew to imports and __all__ exports"
decisions:
  - "ManagerCrew does NOT inherit BaseCrew — hierarchical mode is architecturally different from sequential specialist crews"
  - "manager_agent tools=[] (CRITICAL) — CrewAI raises exceptions if manager has tools in hierarchical mode per research Pitfall"
  - "Both manager_agent=manager_agent and manager_llm=self.llm set on Crew — prevents LiteLLM from falling back to OpenAI when manager delegates"
  - "Task context uses empty string defaults for optional fields (pending_intent, user_id) to prevent KeyError in format()"
metrics:
  duration_seconds: 1193
  duration_human: "19.9 minutes"
  tasks_completed: 2
  files_created: 1
  files_modified: 1
  completed_date: "2026-02-18"
---

# Phase 06.9 Plan 02: ManagerCrew with Process.hierarchical Summary

**One-liner:** Built ManagerCrew — the core LLM-based routing engine using CrewAI Process.hierarchical with Gugu persona manager agent (no tools, allow_delegation=True) and 4 specialist agent coworkers, replacing keyword-based IntakeFlow classification.

## What Was Built

### ManagerCrew (src/agents/crews/manager_crew.py)

The central architectural change of Phase 6.9: a first-contact routing engine that uses CrewAI's native hierarchical process instead of custom keyword classification code.

**Architecture decisions:**

- **Process.hierarchical** (not Process.sequential): The manager agent is a true orchestrator — it receives the citizen message, classifies intent via LLM, and delegates to the correct specialist via CrewAI's automatic `delegate_work` tool.
- **Does NOT inherit BaseCrew**: BaseCrew is designed for specialist crews (single agent + single task + Process.sequential). ManagerCrew builds its Crew from scratch with `manager_agent` and `manager_llm` parameters.
- **manager_agent.tools = []** (CRITICAL): CrewAI raises exceptions if the manager agent has tools in hierarchical mode. The manager delegates to specialists who have tools.
- **Both manager_agent AND manager_llm set to DeepSeek**: Prevents LiteLLM from falling back to OpenAI when the manager delegates — a known pitfall documented in the 06.9 research phase.

**Routing categories (5):**
- `greeting` — Handled directly by Gugu (no delegation needed)
- `off_topic` — Warm redirect from Gugu (no delegation)
- `municipal_report` — Delegates to "Municipal Services Intake Specialist"
- `gbv_report` — Delegates to "Crisis Support Specialist"
- `ticket_status` — Delegates to "Ticket Status Specialist"
- Auth gate: if `session_status` is not "active" for any action intent → delegates to "Citizen Authentication Specialist" first

**Specialist agents as coworkers:**

| Agent | Role String | Tools | allow_delegation |
|-------|-------------|-------|-----------------|
| Auth | "Citizen Authentication Specialist" | send_otp, verify_otp, create_supabase_user, lookup_user | False |
| Municipal | "Municipal Services Intake Specialist" | create_municipal_ticket | False |
| GBV | "Crisis Support Specialist" | create_municipal_ticket, notify_saps | False |
| Ticket Status | "Ticket Status Specialist" | lookup_ticket | False |

All specialists have language-specific prompts injected as backstory extensions using the existing `AUTH_PROMPTS`, `MUNICIPAL_INTAKE_PROMPTS`, and `GBV_INTAKE_PROMPTS` dicts.

**Methods:**
- `__init__(language, llm=None)` — YAML config loaded once, lazy LLM via `@property`
- `create_crew(context) -> Crew` — Builds all 5 agents + manager task + Crew
- `async kickoff(context) -> dict` — Thread pool executor, calls `parse_result`
- `parse_result(result) -> dict` — Strips "Final Answer:" prefix, extracts tracking number if present
- `get_error_response(error) -> dict` — Warm Gugu fallback message

### __init__.py Update (src/agents/crews/__init__.py)

Added `ManagerCrew` to both imports and `__all__`. All 5 crews now importable from `src.agents.crews`:
- `AuthCrew`, `GBVCrew`, `ManagerCrew`, `MunicipalCrew`, `TicketStatusCrew`

## Deviations from Plan

None — plan executed exactly as written.

The one pre-existing test failure (`test_ticket_tool_validates_category`) was already documented in 06.9-01-SUMMARY.md as out-of-scope — it was failing before this plan began (confirmed by git stash + re-run). Not caused by Plan 02 changes.

## Self-Check: PASSED

### Files Exist Check
- `src/agents/crews/manager_crew.py` — FOUND (276 lines, min requirement 80)
- `src/agents/crews/__init__.py` — FOUND, exports ManagerCrew

### Commits Exist Check
- `892e6b6` — Task 1: ManagerCrew with Process.hierarchical
- `d8e83c4` — Task 2: Add ManagerCrew to __init__.py exports

### Verification Results
1. `python -c "from src.agents.crews.manager_crew import ManagerCrew; print('OK')"` — PASSED
2. `python -c "from src.agents.crews.manager_crew import ManagerCrew; mc = ManagerCrew('en'); print(type(mc))"` — `<class 'src.agents.crews.manager_crew.ManagerCrew'>`
3. `python -c "from src.agents.crews import ManagerCrew, TicketStatusCrew, AuthCrew, GBVCrew, MunicipalCrew; print('All imports OK')"` — PASSED
4. GBV crew tests: 21/21 passed
5. `manager_agent allow_delegation: True` — VERIFIED
6. All 5 routing categories in manager_task description — VERIFIED
7. All role strings match YAML config exactly — VERIFIED
8. `manager_crew.py` line count: 276 (min 80) — VERIFIED
