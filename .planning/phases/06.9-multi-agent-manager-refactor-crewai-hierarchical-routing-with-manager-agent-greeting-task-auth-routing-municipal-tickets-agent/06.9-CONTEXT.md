# Phase 6.9: Multi-Agent Manager Refactor - Context

**Gathered:** 2026-02-18
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace the current keyword-based `IntakeFlow` router and imperative `crew_server.py` routing logic with a CrewAI hierarchical manager agent. The manager handles first contact, classifies intent via LLM, and delegates to specialist agents (auth, municipal intake, GBV, ticket status). Adds a new ticket status agent for citizens to check on existing reports.

</domain>

<decisions>
## Implementation Decisions

### Manager Routing Logic
- Full LLM-based classification (no keyword lists) — manager uses the LLM to understand citizen intent and route to the correct specialist
- CrewAI `Process.hierarchical` with a `manager_agent` — native delegation, not custom routing code
- 5 routing categories: greeting, municipal report, GBV report, ticket status, auth
- Off-topic messages handled with warm redirect — Gugu explains she handles municipal services and GBV reporting, asks how she can help with those

### Greeting & Handoff Flow
- Manager greets first, then routes — Gugu welcome message comes from the manager, not specialists
- For generic messages ("Hi"), manager greets warmly and asks citizen's intent to determine routing
- Specialist keeps control until task completes OR citizen interrupts with out-of-scope intent
- Intent interruption: if citizen shifts intent mid-conversation (e.g., mentions GBV while checking ticket status), specialist confirms whether to switch, then manager re-routes if citizen agrees
- Post-task: specialist sends closing summary (tracking number, next steps), then manager follows up with "Is there anything else I can help you with?"
- Manager receives full context pass-through from specialist outcomes (ticket created, auth complete, etc.) for informed follow-up

### Ticket Status Agent (NEW)
- Dual lookup: tracking number search AND smart lookup by authenticated user's phone — always scoped to the authenticated user only (no cross-user data access)
- Ticket details shown: current status plus timeline of changes (created -> assigned -> in progress -> resolved)
- Multiple tickets: show most recent ticket's detail first, then offer "You have X more open reports — want to see them?"
- GBV tickets: visible but minimal info only (status, SAPS officer, station phone, emergency numbers) — consistent with existing citizen portal GBV card pattern (SEC-05)

### Auth Integration
- Existing phone detection logic (`crew_server.py` session_status, user_exists, user_id) passes to manager agent as context — no new detection code needed
- Auth is demand-driven, NOT auto-triggered — manager only routes to auth when citizen's intent requires it (submitting a report or checking ticket status)
- Auth-free intents: general info questions ("what is this platform?", "what do you do?", "how does this work?") do not require authentication
- Auth-gated intents: submitting a new report and checking ticket status require authentication
- Post-auth routing covers both cases:
  - Generic initial message ("Hi") → after auth, manager asks intent
  - Intent-bearing initial message ("I want to report a water leak") → manager remembers original intent, routes to correct specialist without citizen repeating
- Returning authenticated users: if recent in-progress conversation exists, offer to resume where they left off; otherwise clean slate with "Welcome back! What can I help you with?"

### Claude's Discretion
- Exact CrewAI hierarchical process configuration (manager_llm, manager_agent setup)
- How intent memory is stored between auth and post-auth routing (conversation state vs flow state)
- Specialist interrupt detection implementation (prompt-based vs tool-based)
- Conversation history injection pattern for manager context awareness
- How to refactor crew_server.py to use the new manager-based routing

</decisions>

<specifics>
## Specific Ideas

- Manager agent inherits Gugu persona (same warmth, trilingual, SALGA Trust Engine identity)
- The existing `IntakeFlow` keyword classification is replaced entirely — no hybrid fallback
- The `crew_server.py` imperative routing (if session_status == "active" -> IntakeFlow, else -> AuthCrew) is replaced by manager agent delegation
- Specialist agents (AuthCrew, MunicipalCrew, GBVCrew) remain as separate crews but are now delegated to by the manager
- New TicketStatusCrew follows the same BaseCrew pattern as existing crews

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent*
*Context gathered: 2026-02-18*
