---
phase: "06.9"
plan: 4
type: execute
wave: 4
depends_on: ["06.9-03"]
files_modified:
  - tests/test_manager_crew.py
  - tests/test_ticket_status_crew.py
  - tests/test_intake_flow.py
  - tests/test_municipal_crew.py
  - tests/test_gbv_crew.py
  - streamlit_dashboard/components/sidebar.py
autonomous: true
requirements:
  - AI-05
  - AI-06
  - AI-07

must_haves:
  truths:
    - "ManagerCrew unit tests verify Process.hierarchical configuration and all 5 routing categories"
    - "TicketStatusCrew unit tests verify user_id scoping and GBV minimal info pattern"
    - "IntakeFlow tests updated — no longer test keyword classification, test ManagerCrew delegation instead"
    - "Existing municipal and GBV crew tests still pass (no regressions)"
    - "Streamlit sidebar has ticket_status scenario preset for testing new flow"
    - "All tests pass with pytest -x"
  artifacts:
    - path: "tests/test_manager_crew.py"
      provides: "ManagerCrew unit tests"
      contains: "test_manager_crew"
      min_lines: 80
    - path: "tests/test_ticket_status_crew.py"
      provides: "TicketStatusCrew unit tests"
      contains: "test_ticket_status"
      min_lines: 40
  key_links:
    - from: "tests/test_manager_crew.py"
      to: "src/agents/crews/manager_crew.py"
      via: "import and test"
      pattern: "from src.agents.crews.manager_crew import ManagerCrew"
    - from: "tests/test_ticket_status_crew.py"
      to: "src/agents/crews/ticket_status_crew.py"
      via: "import and test"
      pattern: "from src.agents.crews.ticket_status_crew import TicketStatusCrew"
---

<objective>
Write comprehensive unit tests for the new ManagerCrew and TicketStatusCrew, update existing IntakeFlow tests for the new architecture, verify no regressions in existing crew tests, and update the Streamlit dashboard sidebar with new test scenario presets.

Purpose: Ensures the new manager routing architecture is verified, existing functionality is preserved, and the testing dashboard supports the new agent flow.

Output: New test files, updated existing tests, updated Streamlit sidebar.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-01-SUMMARY.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-02-SUMMARY.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-03-SUMMARY.md
@tests/test_municipal_crew.py
@tests/test_gbv_crew.py
@tests/test_intake_flow.py
@streamlit_dashboard/components/sidebar.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManagerCrew and TicketStatusCrew unit tests</name>
  <files>
    tests/test_manager_crew.py
    tests/test_ticket_status_crew.py
  </files>
  <action>
    **test_manager_crew.py:**
    Follow the existing test pattern from test_municipal_crew.py and test_gbv_crew.py. Use `os.environ.setdefault("OPENAI_API_KEY", "fake-key")` at module top for CrewAI initialization compatibility.

    Tests (all use mocked LLM — no real API calls):

    1. `test_manager_crew_instantiation()` — Verify ManagerCrew can be created with language="en" and a mock LLM. Assert it has agents_config and tasks_config loaded.

    2. `test_manager_crew_creates_hierarchical_crew()` — Create ManagerCrew, call create_crew() with a full context dict (message, phone, language, session_status, user_exists, user_id, conversation_history, pending_intent). Verify:
       - crew.process == Process.hierarchical
       - crew.manager_agent is not None
       - crew.manager_agent.allow_delegation is True
       - crew.manager_agent.tools is empty (no tools on manager)
       - len(crew.agents) == 4 (4 specialist agents)
       - All specialist agents have allow_delegation=False
       - All specialist agents have non-empty tools list
       - crew.manager_llm is not None

    3. `test_manager_crew_specialist_roles_match_yaml()` — Verify that the specialist agents in the crew have roles matching the YAML config exactly. This is critical because the manager delegates by role string.

    4. `test_manager_crew_task_has_routing_instructions()` — Verify the single manager task description contains:
       - All 5 routing category keywords: "greeting", "municipal_report", "gbv_report", "ticket_status", "auth"
       - All 4 specialist role strings for delegation
       - The citizen's message from context

    5. `test_manager_crew_kickoff_returns_dict()` — Mock crew.kickoff() to return a mock result. Call manager_crew.kickoff(context). Verify it returns a dict with "message" key.

    6. `test_manager_crew_error_response()` — Verify get_error_response returns a dict with "error" and "message" keys, and message mentions Gugu.

    Use `unittest.mock.patch` and `MagicMock` for mocking crew.kickoff(). Use `unittest.mock.patch.object` to mock create_crew if needed.

    **test_ticket_status_crew.py:**

    1. `test_ticket_status_crew_instantiation()` — Verify TicketStatusCrew instantiation, agent_key, task_key, memory_enabled=False.

    2. `test_ticket_status_crew_has_lookup_tool()` — Verify tools list contains the lookup_ticket tool.

    3. `test_lookup_ticket_impl_requires_user_id()` — Import _lookup_ticket_impl (or the underlying function) and verify it raises AssertionError when user_id is empty/None.

    4. `test_lookup_ticket_impl_scopes_by_user_id()` — Mock get_supabase_admin to return a mock client with chained .table().select().eq().order().limit().execute() pattern. Call with a user_id. Verify .eq("user_id", ...) was called.

    5. `test_lookup_ticket_impl_gbv_minimal_info()` — Mock Supabase to return a ticket with is_sensitive=True. Verify the formatted result contains "sensitive report" category and SAPS helpline numbers, NOT the actual GBV description/address.

    6. `test_lookup_ticket_impl_tracking_number_filter()` — Mock Supabase. Call with both user_id and tracking_number. Verify .eq("tracking_number", ...) was also called.

    7. `test_ticket_status_crew_error_response()` — Verify get_error_response mentions Gugu and tracking number.
  </action>
  <verify>
    Run: `python -m pytest tests/test_manager_crew.py tests/test_ticket_status_crew.py -v -x` — all tests should pass.
  </verify>
  <done>
    ManagerCrew tests verify Process.hierarchical config, specialist roles, routing categories, delegation pattern, error handling. TicketStatusCrew tests verify user_id scoping, GBV minimal info, tracking number filter, error response. All tests pass without real API calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update existing tests and Streamlit sidebar</name>
  <files>
    tests/test_intake_flow.py
    tests/test_municipal_crew.py
    tests/test_gbv_crew.py
    streamlit_dashboard/components/sidebar.py
  </files>
  <action>
    **test_intake_flow.py update:**
    The IntakeFlow tests need to be updated since keyword classification was removed. If test_intake_flow.py exists and tests keyword classification:
    - Remove tests for classify_message() keyword matching
    - Remove tests for route_to_crew() @router routing
    - Add/update tests for the new receive_and_route() method that delegates to ManagerCrew
    - Mock ManagerCrew.kickoff() to avoid real API calls
    - Test that IntakeFlow passes correct context dict to ManagerCrew
    - Test that language detection still occurs before manager call
    - Test that state.ticket_data is populated from manager result

    If test_intake_flow.py does not exist, create it with the above tests.

    **test_municipal_crew.py and test_gbv_crew.py:**
    Run existing tests to verify no regressions. If any tests fail due to the refactoring (import changes, etc.), fix them. The crews themselves were NOT modified — only the routing layer changed — so these should pass unchanged. But verify and fix if needed.

    **Streamlit sidebar update (streamlit_dashboard/components/sidebar.py):**
    Add new scenario presets for the manager flow. The sidebar currently has presets for different test scenarios. Add:

    1. "Ticket Status Check" preset:
       - session_override: "active" (authenticated user)
       - message: "I want to check on my water leak report"
       - Description: "Tests ticket status lookup via manager routing"

    2. "Manager Greeting" preset:
       - session_override: "new" (new user)
       - message: "Hi"
       - Description: "Tests manager greeting for generic hello"

    3. "Off-topic Redirect" preset:
       - session_override: "active"
       - message: "What is the weather today?"
       - Description: "Tests manager off-topic warm redirect"

    4. "Intent Before Auth" preset:
       - session_override: "new"
       - message: "I need to report a water leak on Main Street"
       - Description: "Tests pending_intent preservation through auth"

    Add these to the existing preset list/dict in the sidebar component, following the same pattern as existing presets.
  </action>
  <verify>
    Run: `python -m pytest tests/ -x --ignore=tests/playwright -k "not integration"` — all unit tests should pass.
    Run: `python -c "from streamlit_dashboard.components.sidebar import *; print('Sidebar imports OK')"` — should succeed (or at least not crash on import).
  </verify>
  <done>
    IntakeFlow tests updated for ManagerCrew delegation (no keyword tests). Existing municipal and GBV crew tests pass unchanged. Streamlit sidebar has 4 new scenario presets (ticket status, manager greeting, off-topic, intent before auth). Full test suite green.
  </done>
</task>

</tasks>

<verification>
1. All new tests pass: `python -m pytest tests/test_manager_crew.py tests/test_ticket_status_crew.py -v`
2. Updated intake flow tests pass: `python -m pytest tests/test_intake_flow.py -v` (if exists)
3. Existing crew tests pass (regression check): `python -m pytest tests/test_municipal_crew.py tests/test_gbv_crew.py -v`
4. Full unit test suite passes: `python -m pytest tests/ -x --ignore=tests/playwright -k "not integration"`
5. Streamlit sidebar imports without errors
</verification>

<success_criteria>
- ManagerCrew tests cover: hierarchical config, specialist roles, routing categories, delegation, error handling
- TicketStatusCrew tests cover: user_id scoping, GBV minimal info, tracking number filter
- IntakeFlow tests updated for new ManagerCrew architecture
- No regressions in existing crew tests
- Streamlit sidebar has 4 new test scenario presets
- Full unit test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-04-SUMMARY.md`
</output>
