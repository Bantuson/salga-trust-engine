---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 04
type: execute
wave: 3
depends_on: ["06.6-02", "06.6-03"]
files_modified:
  - e2e-tests/tests/security/authentication.spec.ts
  - e2e-tests/tests/security/authorization.spec.ts
  - e2e-tests/tests/security/tenant-isolation.spec.ts
  - e2e-tests/tests/security/input-validation.spec.ts
  - e2e-tests/tests/public/gbv-privacy.spec.ts
autonomous: true
must_haves:
  truths:
    - "SQL injection payloads in login form return auth error, not server error"
    - "XSS payloads in report description are escaped, not executed"
    - "Manager from Jozi cannot see Pretoria municipality tickets"
    - "GBV reports invisible to manager, field worker, ward councillor in both UI and API"
    - "GBV reports visible ONLY to SAPS liaison and admin"
    - "Rate limiting activates after excessive failed login attempts"
    - "Direct URL manipulation cannot bypass RBAC restrictions"
    - "Cross-tenant API requests return 403"
  artifacts:
    - path: "e2e-tests/tests/security/authentication.spec.ts"
      provides: "OWASP authentication security tests (injection, brute force, session)"
      min_lines: 60
    - path: "e2e-tests/tests/security/authorization.spec.ts"
      provides: "RBAC enforcement tests via API and URL manipulation"
      min_lines: 80
    - path: "e2e-tests/tests/security/tenant-isolation.spec.ts"
      provides: "Multi-tenant isolation tests between Jozi and Pretoria"
      min_lines: 60
    - path: "e2e-tests/tests/security/input-validation.spec.ts"
      provides: "XSS, CSRF, and input sanitization tests"
      min_lines: 50
    - path: "e2e-tests/tests/public/gbv-privacy.spec.ts"
      provides: "GBV privacy firewall tests across all layers"
      min_lines: 80
  key_links:
    - from: "e2e-tests/tests/security/tenant-isolation.spec.ts"
      to: "e2e-tests/profiles/municipal/manager.profile.ts"
      via: "uses both Jozi and Pretoria manager contexts"
      pattern: "test-jozi-001.*test-pretoria-001"
    - from: "e2e-tests/tests/public/gbv-privacy.spec.ts"
      to: "e2e-tests/fixtures/auth.ts"
      via: "tests all roles against GBV data"
      pattern: "managerPage|sapsLiaisonPage|adminPage|fieldWorkerPage|wardCouncillorPage"
    - from: "e2e-tests/tests/security/authorization.spec.ts"
      to: "e2e-tests/fixtures/auth.ts"
      via: "uses multiple role pages for cross-role access tests"
      pattern: "authenticatedPage|managerPage|fieldWorkerPage"
---

<objective>
Write security and isolation E2E tests covering OWASP Top 10 vulnerabilities, multi-tenant isolation between test municipalities, GBV privacy firewall at all layers, and RBAC enforcement via direct URL/API manipulation.

Purpose: Verifies success criteria 5 (edge cases) and 6 (OWASP-level security, authorization, rate limiting). This is the security-critical plan that validates the platform's core safety guarantees: tenant isolation, GBV privacy, and resistance to common web attacks.

Output: 5 test spec files with 30+ security-focused test cases.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-RESEARCH.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-01-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-02-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-03-SUMMARY.md
@src/api/v1/auth.py
@src/api/v1/tickets.py
@src/api/v1/citizen.py
@frontend-public/src/pages/CitizenLoginPage.tsx
@frontend-dashboard/src/pages/LoginPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: OWASP authentication and input validation security tests</name>
  <files>
    e2e-tests/tests/security/authentication.spec.ts
    e2e-tests/tests/security/input-validation.spec.ts
  </files>
  <action>
    Create tests/security/authentication.spec.ts covering OWASP authentication attacks:

    1. SQL injection on login forms (both dashboards):
       - "Public login rejects SQL injection payloads" -- for each payload ("' OR '1'='1", "admin'--", "' OR 1=1--", "'; DROP TABLE users--"), fill email field, submit login, verify: error message is generic auth error (not SQL error), page does not crash, no 500 status
       - "Dashboard login rejects SQL injection payloads" -- same payloads against dashboard /login page

    2. Brute force protection:
       - "Rate limiting activates after excessive failed logins on public portal" -- attempt 15+ failed logins rapidly, verify rate limit error message appears (text matching /too many|rate limit|slow down|try again/i)
       - "Rate limiting activates on dashboard login" -- same for municipal dashboard

    3. Session security:
       - "Expired session redirects to login" -- log in, manually clear localStorage auth tokens, refresh page, verify redirect to login
       - "Logout clears session completely" -- log in, click logout, verify redirect to login, try accessing protected route, verify still logged out

    4. Password security:
       - "Registration rejects weak passwords" -- try '123', 'password', 'abc', verify rejection
       - "Login does not reveal whether email exists" -- compare error messages for valid-email-wrong-password vs nonexistent-email -- both should show same generic error

    Create tests/security/input-validation.spec.ts covering XSS and input sanitization:

    1. XSS on report form:
       - "Report description escapes HTML tags" -- use citizenReturningPage, navigate to /report, fill description with '<script>alert("XSS")</script>', fill other required fields, submit. On receipt, verify the text appears as literal escaped text, NOT executed as script. Verify no alert dialog appears.
       - "Report description escapes event handlers" -- fill with '<img src=x onerror="alert(1)">', submit, verify no alert

    2. XSS on access request form:
       - "Access request fields escape HTML" -- fill municipality name with '<script>alert(1)</script>', submit, verify escaped in confirmation

    3. Input length limits:
       - "Report description has reasonable length limit" -- submit extremely long description (10000+ chars), verify either truncation or validation error (not server crash)
       - "Login email has length limit" -- submit very long email (500+ chars), verify validation error

    4. CSRF-like protections:
       - "Direct API POST without auth returns 401" -- use page.request.post to hit backend API (/api/v1/tickets) without auth headers, verify 401 or 403 response
       - "Direct API POST with invalid token returns 401" -- page.request with Bearer fake-token, verify rejection
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx playwright test tests/security/authentication.spec.ts --list` lists 8+ test cases
    - `npx playwright test tests/security/input-validation.spec.ts --list` lists 7+ test cases
    - No test uses waitForTimeout
  </verify>
  <done>
    Authentication security spec has 8+ tests covering SQL injection, brute force, session security, password security. Input validation spec has 7+ tests covering XSS, input length limits, and CSRF. All tests assert on generic error messages (not leaking internals). TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-tenant isolation, RBAC enforcement, and GBV privacy firewall tests</name>
  <files>
    e2e-tests/tests/security/authorization.spec.ts
    e2e-tests/tests/security/tenant-isolation.spec.ts
    e2e-tests/tests/public/gbv-privacy.spec.ts
  </files>
  <action>
    Create tests/security/tenant-isolation.spec.ts:

    For multi-tenant isolation, create a second set of test credentials for Pretoria municipality (test-pretoria-001). The global-setup should have created a Pretoria manager (manager@test-pretoria-001.test).

    1. UI isolation:
       - "Jozi manager cannot see Pretoria tickets in ticket list" -- authenticate as Jozi manager, navigate to /tickets, verify no Pretoria-tagged tickets visible (search for 'Pretoria' or check tenant column)
       - "Pretoria manager cannot see Jozi tickets in ticket list" -- authenticate as Pretoria manager, same verification

    2. API isolation:
       - "Jozi manager API call returns only Jozi data" -- use Jozi manager context, page.request.get /api/v1/tickets with proper auth, verify all returned tickets have Jozi tenant_id
       - "Cross-tenant ticket access via API returns 403" -- Jozi manager tries GET /api/v1/tickets/{pretoria_ticket_id}, verify 403

    3. URL manipulation:
       - "URL manipulation cannot access other tenant's dashboard" -- Jozi manager manually navigates to dashboard with Pretoria ticket ID in URL, verify rejection
       - "Metrics endpoint returns only tenant-scoped data" -- verify /api/v1/dashboard/metrics returns only Jozi data for Jozi manager

    Create tests/security/authorization.spec.ts:

    1. Vertical privilege escalation:
       - "Field worker cannot access admin endpoints" -- use fieldWorkerPage, API call to admin-only endpoints (municipalities, system settings), verify 403
       - "Citizen cannot access municipal dashboard API" -- use citizen auth, call /api/v1/dashboard/metrics, verify 403
       - "Ward councillor cannot modify tickets outside ward" -- API attempt, verify 403

    2. Horizontal privilege escalation:
       - "Manager cannot access another manager's settings" -- verify no cross-user data access

    3. URL manipulation attacks:
       - "Field worker navigating to /municipalities shows access denied or redirect" -- use fieldWorkerPage, navigate to /municipalities, verify access denied or redirect
       - "Field worker navigating to /analytics shows access denied or redirect" -- same
       - "Field worker navigating to /settings shows access denied or redirect" -- same
       - "Citizen navigating to dashboard URL gets login page" -- fresh context, go to localhost:5174, verify login page

    4. Token manipulation:
       - "Modified JWT role claim rejected" -- (if feasible) create request with tampered role in token, verify rejection

    Create tests/public/gbv-privacy.spec.ts (THE critical security test):

    IMPORTANT: This test file verifies SEC-05 -- the GBV data firewall. Tests must verify at THREE layers: UI, API, and URL manipulation.

    Test setup (beforeAll): Use citizenGbvPage to submit a GBV report via the public portal. Capture the tracking number. This is the GBV report that other roles will attempt to access.

    1. Negative tests (CANNOT see GBV):
       - "Manager CANNOT see GBV report in ticket list UI" -- use managerPage, navigate to /tickets, search for GBV tracking number, verify NOT visible
       - "Manager CANNOT access GBV report via direct API" -- managerPage.request.get /api/v1/tickets?category=GBV, verify 403 or empty results
       - "Manager CANNOT access GBV report via URL" -- navigate to /tickets/{gbv_ticket_id}, verify access denied
       - "Field worker CANNOT see GBV report in ticket list" -- same 3 checks with fieldWorkerPage
       - "Ward councillor CANNOT see GBV report in ticket list" -- same 3 checks with wardCouncillorPage
       - "GBV data NOT visible on public dashboard" -- navigate to public transparency dashboard, verify no GBV category data, no GBV-related text

    2. Positive tests (CAN see GBV):
       - "SAPS liaison CAN see GBV report in ticket list" -- use sapsLiaisonPage, navigate to /tickets, verify GBV report visible (search by tracking number or filter)
       - "Admin CAN see GBV report" -- use adminPage, navigate to /tickets, verify GBV report visible

    3. GBV citizen privacy:
       - "Citizen who submitted GBV sees limited info on profile" -- use citizenGbvPage, navigate to /profile, verify GBV report shows limited fields (tracking number, status only -- no full details per Phase 06.2-08 decision)

    4. Public dashboard GBV exclusion:
       - "Public statistics do NOT include GBV in category breakdown" -- navigate to /dashboard (public), verify no 'GBV/Abuse' category in charts or stats
       - "Public heatmap does NOT show GBV report locations" -- if heatmap data available, verify GBV report location excluded
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx playwright test tests/security/ --list` lists 20+ security test cases
    - `npx playwright test tests/public/gbv-privacy.spec.ts --list` lists 10+ GBV test cases
    - GBV tests cover ALL unauthorized roles (manager, field_worker, ward_councillor)
    - GBV tests cover ALL layers (UI, API, URL)
    - Tenant isolation tests use TWO different municipality contexts
  </verify>
  <done>
    Tenant isolation spec has 6+ tests verifying data boundaries between Jozi and Pretoria. Authorization spec has 8+ tests covering vertical/horizontal privilege escalation and URL manipulation. GBV privacy spec has 10+ tests verifying the SEC-05 firewall at UI, API, and URL layers for all unauthorized roles, plus positive tests for SAPS and admin. All critical security boundaries tested. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- All 5 security test spec files exist
- `npx tsc --noEmit` passes for all
- `npx playwright test tests/security/ tests/public/gbv-privacy.spec.ts --list` shows 30+ test cases
- Every unauthorized role (manager, field_worker, ward_councillor, citizen) is tested against GBV data
- Multi-tenant isolation verified at UI and API layers
- OWASP patterns covered: injection, brute force, XSS, session security, authorization
</verification>

<success_criteria>
- 30+ security test cases across 5 spec files
- GBV privacy firewall tested at 3 layers (UI, API, URL) for all unauthorized roles
- Multi-tenant isolation tested between two municipalities
- OWASP Top 10 critical items covered: injection, XSS, broken auth, broken access control
- Rate limiting verified
- No test leaks sensitive data
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-04-SUMMARY.md`
</output>
