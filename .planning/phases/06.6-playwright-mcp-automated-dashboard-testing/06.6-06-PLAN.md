---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 06
type: execute
wave: 5
depends_on: ["06.6-01", "06.6-02", "06.6-03", "06.6-04", "06.6-05"]
files_modified:
  - e2e-tests/fixtures/auth.ts
  - e2e-tests/fixtures/page-objects/public/LoginPage.ts
  - e2e-tests/fixtures/page-objects/public/RegisterPage.ts
  - e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
  - e2e-tests/fixtures/page-objects/public/ProfilePage.ts
  - e2e-tests/fixtures/page-objects/public/LandingPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
  - e2e-tests/global-setup.ts
  - e2e-tests/global-teardown.ts
  - e2e-tests/playwright.config.ts
  - e2e-tests/tests/public/auth.spec.ts
  - e2e-tests/tests/public/report-submission.spec.ts
  - e2e-tests/tests/public/profile-management.spec.ts
  - e2e-tests/tests/public/landing.spec.ts
  - e2e-tests/tests/public/gbv-privacy.spec.ts
  - e2e-tests/tests/municipal/access-request.spec.ts
  - e2e-tests/tests/municipal/onboarding.spec.ts
  - e2e-tests/tests/municipal/dashboard-rbac.spec.ts
  - e2e-tests/tests/municipal/ticket-management.spec.ts
  - e2e-tests/tests/security/authentication.spec.ts
  - e2e-tests/tests/security/authorization.spec.ts
  - e2e-tests/tests/security/tenant-isolation.spec.ts
  - e2e-tests/tests/security/input-validation.spec.ts
  - e2e-tests/tests/integration/report-to-resolution.spec.ts
  - e2e-tests/tests/integration/data-persistence.spec.ts
  - frontend-public/src/pages/CitizenLoginPage.tsx
  - frontend-public/src/pages/CitizenRegisterPage.tsx
  - frontend-public/src/pages/ReportIssuePage.tsx
  - frontend-public/src/pages/ProfilePage.tsx
  - frontend-public/src/pages/LandingPage.tsx
  - frontend-dashboard/src/pages/LoginPage.tsx
  - frontend-dashboard/src/pages/RequestAccessPage.tsx
  - frontend-dashboard/src/pages/OnboardingWizardPage.tsx
  - frontend-dashboard/src/pages/DashboardPage.tsx
  - frontend-dashboard/src/pages/TicketListPage.tsx
autonomous: false
must_haves:
  truths:
    - "All public dashboard test specs pass (npx playwright test tests/public/ exits 0)"
    - "All municipal dashboard test specs pass (npx playwright test tests/municipal/ exits 0)"
    - "All security test specs pass (npx playwright test tests/security/ exits 0)"
    - "All integration test specs pass (npx playwright test tests/integration/ exits 0)"
    - "Full suite runs green: npx playwright test exits 0 with 80+ tests passing"
    - "Playwright HTML report shows zero failures across all projects"
    - "No tests are skipped or marked .skip — all tests execute"
  artifacts:
    - path: "e2e-tests/playwright-report/index.html"
      provides: "Full test run HTML report with zero failures"
    - path: "e2e-tests/test-results/"
      provides: "Trace files and screenshots for any retried tests"
  key_links:
    - from: "e2e-tests/fixtures/page-objects/"
      to: "frontend-public/src/pages/"
      via: "page object selectors must match actual DOM elements"
      pattern: "locator|getByRole|getByLabel|getByText"
    - from: "e2e-tests/fixtures/page-objects/"
      to: "frontend-dashboard/src/pages/"
      via: "page object selectors must match actual DOM elements"
      pattern: "locator|getByRole|getByLabel|getByText"
    - from: "e2e-tests/global-setup.ts"
      to: "Supabase project"
      via: "seed data must create valid test tenants and users"
      pattern: "supabaseAdmin"
---

<objective>
Run the full Playwright E2E test suite against live services, diagnose all failures, fix selectors/timing/application code, and iterate until 100% of tests pass green.

Purpose: Waves 1-4 authored the test suite. This wave validates it actually works against the real application. E2E tests almost never pass on first run — selectors mismatch DOM, auth flows redirect differently than assumed, animations delay elements, seed data is incomplete. This plan systematically runs, diagnoses, and fixes until the full suite passes.

Output: All 80+ tests passing green with Playwright HTML report as proof. Both test code and application code may be modified to achieve this.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-RESEARCH.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-01-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-02-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-03-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-04-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-05-SUMMARY.md
@e2e-tests/playwright.config.ts
@e2e-tests/fixtures/auth.ts
@e2e-tests/global-setup.ts
@e2e-tests/global-teardown.ts
</context>

<tasks>

<task type="human">
  <name>Task 1: Start services and run initial test suite — diagnose all failures</name>
  <files>
    e2e-tests/playwright.config.ts
    e2e-tests/global-setup.ts
    e2e-tests/global-teardown.ts
  </files>
  <action>
    PREREQUISITE: Both frontend dev servers and backend must be running before tests execute.
    Verify services are available:
    - Frontend-public: http://localhost:5173 (cd frontend-public && npm run dev)
    - Frontend-dashboard: http://localhost:5174 (cd frontend-dashboard && npm run dev)
    - Backend API: http://localhost:8000 (cd backend && uvicorn src.main:app --reload)
    - Supabase project accessible (SUPABASE_URL and keys configured in e2e-tests/.env.test)

    If webServer config in playwright.config.ts auto-starts dev servers, verify it works. Otherwise, start services manually in separate terminals.

    STEP 1 — Run global setup in isolation first:
    ```bash
    cd e2e-tests && npx playwright test --global-setup=./global-setup.ts --no-run
    ```
    If global-setup fails: fix Supabase admin client, user creation, municipality seeding.
    Common failures: wrong SUPABASE_SERVICE_ROLE_KEY, user already exists (need upsert), missing municipality table rows.

    STEP 2 — Run tests by category, starting with simplest (landing page smoke tests):
    ```bash
    # Round 1: Smoke tests (no auth required)
    npx playwright test tests/public/landing.spec.ts --reporter=list --trace on

    # Round 2: Auth tests (simplest auth flow)
    npx playwright test tests/public/auth.spec.ts --reporter=list --trace on

    # Round 3: Report + profile (requires auth)
    npx playwright test tests/public/report-submission.spec.ts tests/public/profile-management.spec.ts --reporter=list --trace on

    # Round 4: Municipal dashboard
    npx playwright test tests/municipal/ --reporter=list --trace on

    # Round 5: Security tests
    npx playwright test tests/security/ tests/public/gbv-privacy.spec.ts --reporter=list --trace on

    # Round 6: Integration tests
    npx playwright test tests/integration/ --reporter=list --trace on
    ```

    STEP 3 — For EACH failure, diagnose using this checklist:

    A. **Selector mismatch** (most common):
       - Open trace viewer: `npx playwright show-trace test-results/{test-name}/trace.zip`
       - Compare expected selector vs actual DOM in trace snapshot
       - Fix page object selector to match real DOM (read the actual React component)
       - Prefer accessible selectors: getByRole('button', {name: 'Submit'}), getByLabel('Email'), getByText('Success')

    B. **Auth/redirect failure**:
       - Check if Supabase redirects to a different URL than expected
       - Check if storageState path exists after login attempt
       - Check if Supabase session tokens are stored in localStorage vs cookies
       - Fix auth fixture login flow to match actual Supabase Auth behavior

    C. **Timing/animation flakiness**:
       - Check if GSAP animations delay element visibility
       - Add explicit wait for specific state: `await expect(locator).toBeVisible({ timeout: 10000 })`
       - If consistently flaky, add `data-testid` attributes to the React component
       - As last resort, add animation-disable CSS in test context: `page.addStyleTag({ content: '* { animation-duration: 0s !important; transition-duration: 0s !important; }' })`

    D. **Missing seed data**:
       - Test expects data that global-setup didn't create
       - Fix global-setup.ts to seed required data (test tickets, team assignments, etc.)
       - Or fix test to create its own data in beforeAll/beforeEach

    E. **Backend API error** (500 status):
       - Check backend logs for stack trace
       - Fix the actual application bug (this is a real finding!)
       - Tests revealing backend bugs are the whole point of E2E testing

    F. **CORS/Network error**:
       - Check playwright.config.ts baseURL matches running server
       - Check backend CORS config includes localhost:5173 and localhost:5174
       - Fix CORS origins in backend if needed

    STEP 4 — After fixing a batch of failures, re-run that category:
    ```bash
    npx playwright test tests/public/ --reporter=list
    ```
    Iterate until the category passes, then move to next category.
  </action>
  <verify>
    - Global setup runs without errors
    - At least one test category (landing.spec.ts) passes fully
    - Failure diagnosis log created (which tests failed, root cause, fix applied)
    - All selector mismatches identified and queued for fixing
  </verify>
  <done>
    All test failures diagnosed with root causes identified. Fixes applied for global-setup, auth flow, and initial selector mismatches. At minimum, public dashboard smoke tests (landing.spec.ts) and auth tests (auth.spec.ts) pass green.
  </done>
</task>

<task type="human">
  <name>Task 2: Fix all remaining failures and achieve 100% green suite</name>
  <files>
    e2e-tests/fixtures/page-objects/public/LoginPage.ts
    e2e-tests/fixtures/page-objects/public/RegisterPage.ts
    e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
    e2e-tests/fixtures/page-objects/public/ProfilePage.ts
    e2e-tests/fixtures/page-objects/public/LandingPage.ts
    e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
    e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
    e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
    e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
    e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
    e2e-tests/fixtures/auth.ts
    e2e-tests/tests/public/auth.spec.ts
    e2e-tests/tests/public/report-submission.spec.ts
    e2e-tests/tests/public/profile-management.spec.ts
    e2e-tests/tests/public/landing.spec.ts
    e2e-tests/tests/public/gbv-privacy.spec.ts
    e2e-tests/tests/municipal/access-request.spec.ts
    e2e-tests/tests/municipal/onboarding.spec.ts
    e2e-tests/tests/municipal/dashboard-rbac.spec.ts
    e2e-tests/tests/municipal/ticket-management.spec.ts
    e2e-tests/tests/security/authentication.spec.ts
    e2e-tests/tests/security/authorization.spec.ts
    e2e-tests/tests/security/tenant-isolation.spec.ts
    e2e-tests/tests/security/input-validation.spec.ts
    e2e-tests/tests/integration/report-to-resolution.spec.ts
    e2e-tests/tests/integration/data-persistence.spec.ts
    frontend-public/src/pages/CitizenLoginPage.tsx
    frontend-public/src/pages/CitizenRegisterPage.tsx
    frontend-public/src/pages/ReportIssuePage.tsx
    frontend-public/src/pages/ProfilePage.tsx
    frontend-dashboard/src/pages/LoginPage.tsx
    frontend-dashboard/src/pages/RequestAccessPage.tsx
    frontend-dashboard/src/pages/OnboardingWizardPage.tsx
    frontend-dashboard/src/pages/DashboardPage.tsx
    frontend-dashboard/src/pages/TicketListPage.tsx
  </files>
  <action>
    Continue from Task 1 diagnosis. Apply systematic fixes in priority order:

    PRIORITY 1 — Page object selector fixes (test code changes):
    For each page object with mismatched selectors:
    1. Read the actual React component source (e.g., frontend-public/src/pages/CitizenLoginPage.tsx)
    2. Find the real input IDs, button texts, CSS classes, aria labels
    3. Update the page object to use correct selectors
    4. Re-run the failing spec to verify fix

    PRIORITY 2 — Auth fixture fixes (test infrastructure):
    If auth flow doesn't match expectations:
    1. Manually test login in browser to observe actual Supabase flow
    2. Check where session tokens are stored (localStorage key names)
    3. Update auth.ts to match actual redirect URLs, token storage, and session format
    4. Regenerate .auth/ storageState files by deleting cached ones

    PRIORITY 3 — Test logic fixes (test expectations):
    If tests assert wrong behavior:
    1. Verify what the actual application behavior IS (not what the test assumes)
    2. Update test expectations to match real behavior
    3. If the test was testing an edge case that the app doesn't handle, either:
       a. Fix the app to handle it (if it should per requirements), OR
       b. Update the test to match current behavior and add a TODO comment

    PRIORITY 4 — Application code fixes (real bugs found):
    If tests reveal genuine bugs in the application:
    1. Fix the application code (frontend component or backend API)
    2. Verify the fix doesn't break other tests
    3. Document the bug fix in the summary (these are HIGH-VALUE findings)

    PRIORITY 5 — Add data-testid attributes to React components:
    Where selectors are fragile (text-based selectors that break on copy changes):
    1. Add data-testid="tracking-number" to key elements in React components
    2. Update page objects to use data-testid selectors
    3. This is a SMALL app code change that dramatically improves test stability

    ITERATION LOOP:
    After each batch of fixes, run the full suite:
    ```bash
    cd e2e-tests && npx playwright test --reporter=list
    ```

    Track progress:
    - Round 1: X/80 passing
    - Round 2: Y/80 passing
    - Round N: 80/80 passing

    If a test is GENUINELY untestable (e.g., phone OTP requires real SMS, ZAP proxy not available):
    - Mark it with test.skip('Requires real SMS provider') with clear reason
    - Do NOT silently skip — document why
    - Skipped tests count toward the suite but must have justification

    FINAL VERIFICATION:
    ```bash
    # Full suite run with HTML report
    npx playwright test --reporter=html

    # Open report
    npx playwright show-report
    ```

    Verify:
    - All tests green (or explicitly skipped with documented reason)
    - No flaky tests (run twice to confirm stability)
    - HTML report saved as proof artifact
    - Both frontend apps still build: cd frontend-public && npm run build && cd ../frontend-dashboard && npm run build
  </action>
  <verify>
    Run from e2e-tests/:
    - `npx playwright test` exits with code 0
    - `npx playwright test --reporter=json 2>&1 | jq '.stats'` shows passed >= 80, failed == 0
    - Run suite TWICE to verify no flaky tests
    - `cd ../frontend-public && npm run build` succeeds (if data-testid attrs added)
    - `cd ../frontend-dashboard && npm run build` succeeds
  </verify>
  <done>
    Full E2E test suite passes green: 80+ tests, 0 failures, across all 15 spec files. Playwright HTML report generated as proof. All selector mismatches fixed, auth flow validated, any real application bugs discovered and fixed. Both frontend apps still build. Suite is stable (passes on re-run). Phase 6.6 success criteria fully verified by passing tests.
  </done>
</task>

</tasks>

<verification>
- `cd e2e-tests && npx playwright test` exits code 0
- All 15 spec files execute (none skipped entirely)
- 80+ tests pass green
- Playwright HTML report shows 0 failures
- Suite passes on consecutive runs (no flaky tests)
- Both frontend apps build successfully
- Any application bugs found are fixed (not just test workarounds)
</verification>

<success_criteria>
- 100% test pass rate across all categories (public, municipal, security, integration)
- All 6 phase success criteria verified by passing tests:
  1. Account creation: auth.spec.ts passes
  2. Database persistence: data-persistence.spec.ts passes
  3. Report routing: report-to-resolution.spec.ts passes
  4. Access request + onboarding: access-request.spec.ts + onboarding.spec.ts pass
  5. Edge cases: all specs with edge case tests pass
  6. Security: authentication, authorization, tenant-isolation, input-validation, gbv-privacy all pass
- Playwright HTML report generated as proof artifact
- No flaky tests (stable on re-run)
- Any real application bugs discovered during testing are fixed
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-06-SUMMARY.md`
</output>
