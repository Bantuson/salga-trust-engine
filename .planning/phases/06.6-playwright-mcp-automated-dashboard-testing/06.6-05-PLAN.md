---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 05
type: execute
wave: 4
depends_on: ["06.6-02", "06.6-03", "06.6-04"]
files_modified:
  - e2e-tests/tests/integration/report-to-resolution.spec.ts
  - e2e-tests/tests/integration/data-persistence.spec.ts
autonomous: true
must_haves:
  truths:
    - "Report submitted by citizen appears in municipal manager's ticket list"
    - "Status update by municipal user is visible on citizen's profile"
    - "User data persists in database across sessions"
    - "Full user journey from registration to report resolution completes end-to-end"
    - "All E2E test suites compile and can be listed by Playwright"
  artifacts:
    - path: "e2e-tests/tests/integration/report-to-resolution.spec.ts"
      provides: "Cross-dashboard integration test: citizen report to municipal resolution"
      min_lines: 80
    - path: "e2e-tests/tests/integration/data-persistence.spec.ts"
      provides: "Database persistence verification across sessions"
      min_lines: 40
  key_links:
    - from: "e2e-tests/tests/integration/report-to-resolution.spec.ts"
      to: "e2e-tests/fixtures/auth.ts"
      via: "uses both citizenReturningPage and managerPage in same test"
      pattern: "citizenReturningPage.*managerPage|managerPage.*citizenReturningPage"
    - from: "e2e-tests/tests/integration/report-to-resolution.spec.ts"
      to: "e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts"
      via: "citizen submits report via public portal"
      pattern: "new ReportIssuePage"
    - from: "e2e-tests/tests/integration/report-to-resolution.spec.ts"
      to: "e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts"
      via: "manager views report in municipal dashboard"
      pattern: "new TicketListPage"
---

<objective>
Write cross-dashboard integration tests that verify the complete user journey from citizen report submission through municipal resolution, plus data persistence verification. These tests span both dashboards and multiple roles.

Purpose: Verifies success criteria 2 (database persistence end-to-end) and 3 (reports routed and received by appropriate role users, status updates visible). This is the capstone plan proving the full system works as an integrated whole, not just individual pages.

Output: 2 integration test spec files with 10+ test cases proving the complete feedback loop works.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-RESEARCH.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-01-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-02-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-03-SUMMARY.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-dashboard integration tests (report-to-resolution)</name>
  <files>e2e-tests/tests/integration/report-to-resolution.spec.ts</files>
  <action>
    Create tests/integration/report-to-resolution.spec.ts. This is the most important test file in the suite -- it proves the platform's core value proposition: "Citizens report a problem and the municipality visibly responds."

    These tests use MULTIPLE authenticated contexts (citizen + manager) within the same test, operating across BOTH dashboards (public portal at :5173 and municipal dashboard at :5174).

    1. "Full journey: citizen submits report, manager sees it in ticket list":
       - Step A: Create new browser context for citizen (citizenReturningPage or authenticatedPage('citizen'))
       - Step B: Citizen navigates to public portal /report, fills category (Pothole), description (unique via faker), manual address, submits
       - Step C: Capture tracking number from receipt card
       - Step D: Create separate browser context for manager (managerPage or authenticatedPage('manager'))
       - Step E: Manager navigates to municipal dashboard /tickets
       - Step F: Manager searches for the tracking number captured in Step C
       - Step G: Assert tracking number appears in ticket list results
       - Cleanup: Close both contexts

    2. "Multiple reports from same citizen all appear in municipal ticket list":
       - Citizen submits 2 different reports (different categories)
       - Manager searches for both tracking numbers
       - Both should be visible in ticket list

    3. "Report with different categories routes correctly":
       - Citizen submits Water Leak category
       - Manager filters by Water Leak category
       - Report appears in filtered results

    4. "Citizen can see submitted report on profile page":
       - After submitting report, citizen navigates to /profile
       - Verify report appears in report history on profile page (tracking number or category visible)

    5. "Status update is visible on public transparency dashboard":
       - If ticket status changes are reflected on public dashboard, verify:
         - Navigate to public /dashboard (transparency page)
         - Check that municipality stats reflect the report (total tickets count may have increased)
       - Note: This may be hard to assert precisely; verify at least that the transparency dashboard loads with data

    6. "GBV report does NOT appear in manager's ticket list" (cross-dashboard GBV check):
       - Citizen submits GBV report on public portal (with consent flow)
       - Manager searches for GBV tracking number on municipal dashboard
       - Assert NOT found (reinforces SEC-05 across the full integration path)

    Implementation notes:
    - Use `browser` fixture to create multiple independent contexts
    - Each context gets its own storageState (different roles, different dashboards)
    - Use faker for all report descriptions and addresses
    - Use explicit waits via toBeVisible() and toHaveURL() -- never waitForTimeout
    - Close all contexts in finally/afterEach blocks
    - Test.describe.serial() for tests that depend on prior test state (e.g., tracking number)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx playwright test tests/integration/report-to-resolution.spec.ts --list` lists 6 test cases
    - Tests reference both baseURLs (localhost:5173 and localhost:5174)
    - Tests use multiple authenticated browser contexts
  </verify>
  <done>
    Report-to-resolution spec has 6 test cases verifying the complete citizen-to-municipal feedback loop. Tests span both dashboards, use multiple authenticated contexts, and prove the core value proposition works end-to-end. GBV cross-dashboard isolation verified. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Data persistence tests and full suite verification</name>
  <files>e2e-tests/tests/integration/data-persistence.spec.ts</files>
  <action>
    Create tests/integration/data-persistence.spec.ts:

    1. "User registration persists across sessions":
       - Register a new user via public portal (unique faker email)
       - Close browser context entirely
       - Create new context, log in with same credentials
       - Verify login succeeds and profile page shows correct email

    2. "Report persists across page refreshes":
       - Citizen submits report, captures tracking number
       - Refresh page
       - Navigate to profile, verify report still visible in history

    3. "Report persists across new browser sessions":
       - Citizen submits report, captures tracking number
       - Close context, create new one, log in again
       - Navigate to profile, verify report still in history

    4. "Access request data persists for admin review":
       - Submit access request form on municipal dashboard
       - Verify success message (data sent to backend)
       - (Cannot verify admin sees it without admin API, but submission should persist)

    5. "Multiple users maintain separate sessions":
       - Create two citizen contexts simultaneously
       - Both navigate to profile page
       - Verify each sees their own data (different emails, different reports)

    After writing the test file, do a FINAL VERIFICATION of the entire test suite:

    - Run `npx tsc --noEmit` from e2e-tests/ to verify all TypeScript compiles
    - Run `npx playwright test --list` to list ALL test cases across ALL spec files
    - Count total test cases and verify it's 80+ across all specs
    - Verify test files are organized: tests/public/ (5 files), tests/municipal/ (4 files), tests/security/ (4 files), tests/integration/ (2 files)
    - Verify no circular imports between fixtures, page objects, and specs

    Output a summary of the complete test inventory:
    - Total specs: count
    - Total test cases: count
    - By category: public, municipal, security, integration
    - Profiles used: all 10
    - Dashboards covered: both (public + municipal)
  </action>
  <verify>
    - `npx tsc --noEmit` passes for entire e2e-tests/ project
    - `npx playwright test --list` completes without errors
    - Total test cases >= 80
    - All 15 spec files exist and compile
    - No test uses waitForTimeout
  </verify>
  <done>
    Data persistence spec has 5 test cases verifying database durability across sessions and refreshes. Full suite verification confirms 80+ test cases across 15 spec files, all compiling cleanly. Test inventory covers all 10 profiles, both dashboards, and all 6 success criteria. Phase 6.6 test infrastructure is complete and ready for execution against running services.
  </done>
</task>

</tasks>

<verification>
- All integration test files exist under e2e-tests/tests/integration/
- `npx tsc --noEmit` passes for entire test suite
- `npx playwright test --list` shows 80+ total test cases
- Cross-dashboard tests reference both ports (5173, 5174)
- Integration tests use multiple authenticated browser contexts
- Data persistence tests verify across session boundaries
- Complete test inventory documented
</verification>

<success_criteria>
- 10+ integration test cases proving full system works end-to-end
- Report-to-resolution journey verified across both dashboards
- Data persistence verified across sessions and page refreshes
- Full suite compiles and lists 80+ test cases
- All 6 phase success criteria have corresponding test coverage:
  1. Account creation: auth.spec.ts
  2. Database persistence: data-persistence.spec.ts
  3. Report routing: report-to-resolution.spec.ts
  4. Access request + onboarding: access-request.spec.ts, onboarding.spec.ts
  5. Edge cases: all specs include edge cases
  6. Security: authentication.spec.ts, authorization.spec.ts, tenant-isolation.spec.ts, input-validation.spec.ts, gbv-privacy.spec.ts
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-05-SUMMARY.md`
</output>
