---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 03
type: execute
wave: 2
depends_on: ["06.6-01"]
files_modified:
  - e2e-tests/tests/municipal/access-request.spec.ts
  - e2e-tests/tests/municipal/onboarding.spec.ts
  - e2e-tests/tests/municipal/dashboard-rbac.spec.ts
  - e2e-tests/tests/municipal/ticket-management.spec.ts
autonomous: true
must_haves:
  truths:
    - "Municipality can submit access request via public form"
    - "Admin can log in and view dashboard with metrics"
    - "Manager can view ticket list with filters and search"
    - "Field worker sees limited navigation (only My Tickets and Submit Report)"
    - "Ward councillor sees filtered view of their ward"
    - "SAPS liaison can access GBV reports"
    - "Onboarding wizard progresses through steps with state persistence"
    - "Unauthorized roles cannot access admin-only features"
  artifacts:
    - path: "e2e-tests/tests/municipal/access-request.spec.ts"
      provides: "Access request flow E2E tests"
      min_lines: 50
    - path: "e2e-tests/tests/municipal/onboarding.spec.ts"
      provides: "Onboarding wizard E2E tests"
      min_lines: 60
    - path: "e2e-tests/tests/municipal/dashboard-rbac.spec.ts"
      provides: "RBAC-based dashboard access E2E tests for all municipal roles"
      min_lines: 80
    - path: "e2e-tests/tests/municipal/ticket-management.spec.ts"
      provides: "Ticket list, search, filter, and export E2E tests"
      min_lines: 60
  key_links:
    - from: "e2e-tests/tests/municipal/dashboard-rbac.spec.ts"
      to: "e2e-tests/fixtures/auth.ts"
      via: "uses managerPage, adminPage, fieldWorkerPage, sapsLiaisonPage, wardCouncillorPage fixtures"
      pattern: "managerPage|adminPage|fieldWorkerPage|sapsLiaisonPage|wardCouncillorPage"
    - from: "e2e-tests/tests/municipal/access-request.spec.ts"
      to: "e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts"
      via: "uses RequestAccessPage page object"
      pattern: "new RequestAccessPage"
    - from: "e2e-tests/tests/municipal/onboarding.spec.ts"
      to: "e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts"
      via: "uses OnboardingWizardPage page object"
      pattern: "new OnboardingWizardPage"
---

<objective>
Write E2E tests for the municipal dashboard covering all municipal user journeys: access requests, onboarding wizard, RBAC-based dashboard views for all 5 municipal roles, and ticket management operations.

Purpose: Verifies success criteria 3 (reports routed to appropriate role users), 4 (municipality admin access request and onboarding), and 5 (edge cases) from the municipal operations perspective. Tests all 5 municipal role profiles.

Output: 4 test spec files covering all municipal dashboard user journeys with 20-25 test cases.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-RESEARCH.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-01-SUMMARY.md
@frontend-dashboard/src/App.tsx
@frontend-dashboard/src/pages/LoginPage.tsx
@frontend-dashboard/src/pages/RegisterPage.tsx
@frontend-dashboard/src/pages/RequestAccessPage.tsx
@frontend-dashboard/src/pages/OnboardingWizardPage.tsx
@frontend-dashboard/src/pages/DashboardPage.tsx
@frontend-dashboard/src/pages/TicketListPage.tsx
@frontend-dashboard/src/components/layout/DashboardLayout.tsx
@frontend-dashboard/src/components/layout/Sidebar.tsx
@frontend-dashboard/src/components/dashboard/FilterBar.tsx
@frontend-dashboard/src/components/dashboard/TicketTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Access request, onboarding wizard, and RBAC E2E tests</name>
  <files>
    e2e-tests/tests/municipal/access-request.spec.ts
    e2e-tests/tests/municipal/onboarding.spec.ts
    e2e-tests/tests/municipal/dashboard-rbac.spec.ts
  </files>
  <action>
    Read the actual dashboard page components to discover real selectors, form fields, button texts, and navigation structure before writing tests.

    Create tests/municipal/access-request.spec.ts:

    1. "Municipality can submit access request" -- navigate to /request-access (no auth required), fill municipality name, province (select from dropdown), municipality code, contact name/email/phone, optional notes, submit. Verify success confirmation message/state.
    2. "Access request validates required fields" -- submit empty form, verify validation errors for required fields
    3. "Access request accepts document upload" -- fill form, upload a test PDF/image file, verify file attached before submit
    4. "Access request auto-saves draft to localStorage" -- fill partial form, reload page, verify fields retain values
    5. "Access request province dropdown has all 9 SA provinces" -- open province dropdown, verify all 9 provinces listed

    Create tests/municipal/onboarding.spec.ts (use adminPage fixture):

    1. "Admin sees onboarding wizard on first login" -- navigate to /onboarding, verify welcome step visible
    2. "Onboarding wizard progresses through steps" -- advance from Welcome to Profile, fill profile form (municipality name, contact email), click Next, verify Team step visible
    3. "Onboarding steps can be skipped" -- at Team step, click Skip, verify Wards step visible; skip again, verify SLA step visible
    4. "Onboarding persists progress after page refresh" -- complete Profile step, refresh page, verify wizard resumes at Team step (not back to Welcome)
    5. "Onboarding wizard can navigate backwards" -- go to step 3, click Back, verify step 2 visible with data preserved
    6. "Onboarding completion redirects to dashboard" -- skip through all optional steps to Completion, verify redirect to main dashboard

    Create tests/municipal/dashboard-rbac.spec.ts:

    1. Admin role tests:
       - "Admin can access dashboard" -- use adminPage, navigate to /, verify dashboard metrics visible
       - "Admin can access all sidebar navigation items" -- verify sidebar shows all nav items (Dashboard, Tickets, Reports, Municipalities, Teams, Analytics, Settings, System)
       - "Admin can access ticket list" -- navigate to /tickets, verify table visible

    2. Manager role tests:
       - "Manager can access dashboard" -- use managerPage, navigate to /, verify metrics visible
       - "Manager can view and manage tickets" -- navigate to /tickets, verify table with actions
       - "Manager sees management navigation" -- verify sidebar shows Dashboard, Tickets, Reports, Analytics

    3. Field worker role tests:
       - "Field worker has limited navigation" -- use fieldWorkerPage, verify sidebar shows ONLY My Tickets and Submit Report (per Phase 06.2-03 decision)
       - "Field worker can access ticket list" -- navigate to /tickets, verify only their assigned tickets visible
       - "Field worker can submit reports" -- navigate to /report, verify ReportForm loads

    4. SAPS liaison role tests:
       - "SAPS liaison can access dashboard" -- use sapsLiaisonPage, verify dashboard loads
       - "SAPS liaison has GBV-specific view" -- verify GBV reports section or filter is available

    5. Ward councillor role tests:
       - "Ward councillor can access dashboard" -- use wardCouncillorPage, verify dashboard loads
       - "Ward councillor sees ward-filtered data" -- verify metrics/tickets filtered to assigned ward

    6. Negative authorization tests:
       - "Unauthenticated user redirected to login" -- fresh context, navigate to /, verify redirect to /login
       - "Citizen role cannot access municipal dashboard" -- use citizenNewPage from auth fixture (public portal role), navigate to dashboard URL, verify rejection/redirect
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx playwright test tests/municipal/access-request.spec.ts --list` lists 5+ test cases
    - `npx playwright test tests/municipal/onboarding.spec.ts --list` lists 6+ test cases
    - `npx playwright test tests/municipal/dashboard-rbac.spec.ts --list` lists 12+ test cases
  </verify>
  <done>
    Access request spec has 5 test cases covering form submission, validation, document upload, auto-save. Onboarding spec has 6 test cases covering wizard progression, skip, persistence, completion. RBAC spec has 12+ test cases covering all 5 municipal roles with positive and negative authorization. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ticket management E2E tests</name>
  <files>e2e-tests/tests/municipal/ticket-management.spec.ts</files>
  <action>
    Read frontend-dashboard/src/pages/TicketListPage.tsx and frontend-dashboard/src/components/dashboard/ components to discover real table structure, filter controls, search input, pagination, and export button selectors.

    Create tests/municipal/ticket-management.spec.ts:

    1. Ticket list display:
       - "Manager can view ticket list with table" -- use managerPage, navigate to /tickets, verify table headers visible (ID/Tracking, Category, Status, Priority, Assigned, Created)
       - "Ticket list shows pagination" -- verify pagination controls (page numbers, next/prev) visible
       - "Ticket list displays real ticket data" -- verify at least one row exists (from seeded test data) OR verify empty state message

    2. Search and filter:
       - "Manager can search tickets by keyword" -- type in search input, verify table updates (or shows no results message)
       - "Manager can filter by status" -- select status filter (e.g., 'open'), verify filter applied
       - "Manager can filter by category" -- select category filter, verify filter applied
       - "Filters can be cleared" -- apply a filter, then clear it, verify all tickets returned

    3. Export:
       - "Manager can export tickets to CSV" -- click export button, verify download triggered (check response headers or file download)

    4. Real-time indicator:
       - "Dashboard shows realtime indicator" -- verify realtime/live indicator element is visible on dashboard

    5. Edge cases:
       - "Empty search returns full list" -- clear search input, verify original ticket count restored
       - "Pagination changes page content" -- if multiple pages exist, click page 2, verify different ticket IDs shown

    Use TicketListPage and DashboardPage page objects for all interactions.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx playwright test tests/municipal/ticket-management.spec.ts --list` lists 10+ test cases
  </verify>
  <done>
    Ticket management spec has 10+ test cases covering list display, search, filtering, export, pagination, and edge cases. All interactions use page objects. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- All 4 test spec files exist under e2e-tests/tests/municipal/
- `npx tsc --noEmit` passes for all test files
- `npx playwright test tests/municipal/ --list` shows 30+ test cases total
- All 5 municipal roles (admin, manager, field_worker, saps_liaison, ward_councillor) are tested
- RBAC tests include negative tests (unauthorized access attempts)
- Onboarding wizard tests cover state persistence across refresh
</verification>

<success_criteria>
- 30+ test cases across 4 spec files covering all municipal user journeys
- All 5 municipal roles tested for appropriate access levels
- Access request, onboarding, dashboard RBAC, and ticket management all covered
- Tests follow Page Object Model pattern
- Negative authorization tests verify security boundaries
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-03-SUMMARY.md`
</output>
