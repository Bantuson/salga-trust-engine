---
phase: 06.1.1-teams-analytics-settings
plan: 05
type: execute
wave: 2
depends_on: ["06.1.1-01", "06.1.1-02"]
files_modified:
  - frontend-dashboard/src/pages/AnalyticsPage.tsx
  - frontend-dashboard/src/components/analytics/KPICard.tsx
  - frontend-dashboard/src/components/analytics/TeamLeaderboard.tsx
  - frontend-dashboard/src/components/analytics/CategoryComparison.tsx
  - frontend-dashboard/src/components/analytics/TimeRangeControls.tsx
  - frontend-dashboard/src/hooks/useAnalytics.ts
autonomous: true
requirements:
  - OPS-01
  - OPS-03
  - OPS-04

must_haves:
  truths:
    - "Analytics page shows KPI stat cards with inline sparklines (Stripe-style)"
    - "Time range controls allow preset selection (7d/30d/90d/6mo/1yr) and custom date range"
    - "Team leaderboard shows horizontal bar rankings with progress bars and trend arrows"
    - "Category comparison shows performance across service categories"
    - "Ward councillor sees analytics filtered to their ward"
    - "Analytics data refreshes when time range changes"
  artifacts:
    - path: "frontend-dashboard/src/pages/AnalyticsPage.tsx"
      provides: "Analytics page with KPI cards, leaderboards, time range controls"
      contains: "AnalyticsPage"
    - path: "frontend-dashboard/src/components/analytics/KPICard.tsx"
      provides: "Stat card with sparkline"
      contains: "KPICard"
    - path: "frontend-dashboard/src/components/analytics/TeamLeaderboard.tsx"
      provides: "Horizontal bar team rankings"
      contains: "TeamLeaderboard"
    - path: "frontend-dashboard/src/hooks/useAnalytics.ts"
      provides: "Analytics data fetching with time range"
      contains: "useAnalytics"
  key_links:
    - from: "frontend-dashboard/src/pages/AnalyticsPage.tsx"
      to: "frontend-dashboard/src/hooks/useAnalytics.ts"
      via: "useAnalytics() hook"
      pattern: "useAnalytics"
    - from: "frontend-dashboard/src/hooks/useAnalytics.ts"
      to: "frontend-dashboard/src/services/api.ts"
      via: "fetchAnalyticsData call"
      pattern: "fetchAnalyticsData"
---

<objective>
Build the Analytics page with KPI stat cards, time range controls, team leaderboard, and category comparisons.

Purpose: Replace the "Coming Soon" placeholder for /analytics with a full analytics dashboard. Per locked decisions: Stripe-style KPI cards with inline sparklines, horizontal bar rankings (not vertical charts), and minimal Recharts usage.

Output: AnalyticsPage component, 4 sub-components, and useAnalytics hook.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-02-SUMMARY.md
@frontend-dashboard/src/pages/DashboardPage.tsx
@frontend-dashboard/src/components/dashboard/MetricsCards.tsx
@frontend-dashboard/src/components/analytics/SparkLine.tsx
@frontend-dashboard/src/hooks/useAuth.ts
@frontend-dashboard/src/types/analytics.ts
@frontend-dashboard/src/types/dashboard.ts
@frontend-dashboard/src/constants/categories.ts
@shared/components/ui/GlassCard.tsx
@shared/components/ui/Skeleton.tsx
@shared/design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAnalytics hook + TimeRangeControls + KPICard</name>
  <files>
    frontend-dashboard/src/hooks/useAnalytics.ts
    frontend-dashboard/src/components/analytics/TimeRangeControls.tsx
    frontend-dashboard/src/components/analytics/KPICard.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/hooks/useAnalytics.ts`:
   Per research: "Time range state and data fetching pattern"

   State: timeRange (TimeRange, default '30d'), customStart (string), customEnd (string), data (AnalyticsData | null), isLoading (boolean)

   - getDateRange() helper: converts timeRange preset to {start, end} ISO date strings.
     '7d' = 7 days back, '30d' = 30, '90d' = 90, '6mo' = 180, '1yr' = 365.
     'custom' uses customStart/customEnd.
   - useEffect: when timeRange/customStart/customEnd/wardId changes, call fetchAnalyticsData(start, end, wardId) from api.ts
   - Accept optional wardId param for ward councillor filtering
   - Return: { data, isLoading, timeRange, setTimeRange, customStart, setCustomStart, customEnd, setCustomEnd, refreshData }

2. Create `frontend-dashboard/src/components/analytics/TimeRangeControls.tsx`:
   Per locked decision: "Time range controls: preset buttons (7d, 30d, 90d, 6mo, 1yr) PLUS custom date range picker"

   Props: timeRange, setTimeRange, customStart, setCustomStart, customEnd, setCustomEnd

   Structure:
   - Row of preset buttons: 7d | 30d | 90d | 6mo | 1yr — styled as pill buttons
   - Active button: filled with var(--color-teal), white text
   - Inactive buttons: transparent with glass border, text-secondary color
   - "Custom" button at end — when clicked, shows two date inputs below
   - Custom date range: two `<input type="date">` elements styled with design tokens (background glass, border glass-border, text color)
   - Per research discretion: "use two <input type="date"> elements styled with design tokens rather than adding a new date picker library"
   - Responsive: buttons wrap on mobile

3. Create `frontend-dashboard/src/components/analytics/KPICard.tsx`:
   Per locked decision: "Top-level KPIs as large stat cards with inline sparklines (Stripe/Linear dashboard style)"

   Props: label: string, value: number | string, unit?: string, trend?: number[], trendDirection?: 'up' | 'down' | 'neutral', color: string, index: number

   Structure:
   - Wrap in AnimatedCard with delay={index * 0.05}
   - GlassCard variant="default"
   - Top: label text (text-secondary, small font, uppercase tracking)
   - Middle: large value display (fontSize 2rem, fontWeight 700, color: var(--text-primary))
     - If unit provided, show as suffix (smaller font, text-muted)
     - Use anime.js counter animation on mount (matching MetricsCards pattern): animate from 0 to value
   - Bottom: SparkLine component (if trend data exists) positioned right-aligned, with trend direction arrow
     - Trend arrow: small arrow icon with color based on direction (teal for up, coral for down, muted for neutral)
     - Text showing trend percentage change (e.g., "+12%" or "-5%")
   - Per context: "Analytics stat cards should feel like Stripe's dashboard — large numbers, small sparklines, clean typography"
   - Use animate() from animejs for counter animation with cleanup in useEffect (per Pitfall 5: return () => animation.pause())
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/hooks/useAnalytics.ts src/components/analytics/TimeRangeControls.tsx src/components/analytics/KPICard.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>useAnalytics hook fetches data with configurable time ranges. TimeRangeControls provides preset + custom date selection. KPICard renders Stripe-style stat with sparkline and counter animation.</done>
</task>

<task type="auto">
  <name>Task 2: Create TeamLeaderboard + CategoryComparison + AnalyticsPage</name>
  <files>
    frontend-dashboard/src/components/analytics/TeamLeaderboard.tsx
    frontend-dashboard/src/components/analytics/CategoryComparison.tsx
    frontend-dashboard/src/pages/AnalyticsPage.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/components/analytics/TeamLeaderboard.tsx`:
   Per locked decision: "Team/category comparisons as horizontal bar rankings with progress bars and trend arrows (leaderboard style)"
   Per context: "Team leaderboards should use horizontal bars (not vertical) for easy scanning"

   Props: workload: Array<{ team_id, team_name, open_count, total_count }>, title?: string

   Structure:
   - Section header: title (default "Team Performance") with ranking icon
   - List of LeaderboardRow items, sorted by total_count descending
   - Each row:
     - Rank number (#1, #2, etc.) in bold
     - Team name
     - Horizontal progress bar: width proportional to max value in list, background track (glass-border color), fill (teal gradient)
     - Value number (total resolved or total count)
     - Trend arrow (up/down based on open vs resolved ratio) — up (teal) = more resolved, down (coral) = more open
   - Max 10 teams displayed
   - If no teams: "No team data available for this period"
   - CSS: use inline styles. Bar track is a div with fixed height (8px), rounded, background var(--glass-border). Fill div inside with width as percentage of max, background var(--color-teal).

2. Create `frontend-dashboard/src/components/analytics/CategoryComparison.tsx`:
   Props: volume: Array<{ category, open, resolved }>, title?: string

   Structure:
   - Section header: title (default "Category Breakdown")
   - List of category rows, sorted by total (open + resolved) descending
   - Each row:
     - Category badge (icon + colored pill from CATEGORY_CONFIG)
     - Horizontal stacked bar: open portion (coral shade) + resolved portion (teal shade) — total width proportional to max category
     - Numbers: "X open / Y resolved" text
   - Use CATEGORY_CONFIG colors for the category badges
   - If no data: "No category data for this period"

3. Create `frontend-dashboard/src/pages/AnalyticsPage.tsx`:

   Layout matching DashboardPage pattern:
   - Container: maxWidth 1400px, margin 0 auto, padding 2rem
   - Header: h1 "Analytics" (left) + CSV Export button (right)
   - TimeRangeControls below header

   Content sections (ordered top to bottom):

   a) **KPI Cards row** (grid: 4 columns on large, 2 on medium, 1 on mobile):
      - Total Open Tickets (color teal)
      - Total Resolved (color green)
      - SLA Compliance % (color amber or teal depending on value)
      - Avg Response Hours (color coral if high, teal if low)
      Each KPI gets trend data from analytics (use random sparkline data if time-series not available yet — array of 7-30 fake values trending in the right direction)

   b) **Two-column layout** (grid: 2 columns on large, 1 on mobile):
      - Left: TeamLeaderboard (workload data)
      - Right: CategoryComparison (volume data)

   c) **SLA Details section** (full width):
      - GlassCard with SLA breakdown: response compliance %, resolution compliance %, breaches count
      - Display as 3 inline stat blocks (not charts)

   Ward councillor support:
   - Use useAuth().getUserRole() to detect ward_councillor role
   - If ward_councillor, pass wardId to useAnalytics hook (use getTenantId or hardcoded ward for now — ward_id not yet stored in JWT, use a placeholder approach that works when backend adds it)
   - Show "Ward Analytics" header instead of "Analytics" for ward councillors

   CSV Export:
   - Export button calls exportTicketsCSV from api.ts with current time range as filter
   - Downloads file as blob (existing pattern)

   Loading state: SkeletonTheme with skeleton KPI cards + skeleton rows
   Empty state: "No analytics data available. Analytics will populate as tickets are created and resolved."
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/pages/AnalyticsPage.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>AnalyticsPage shows KPI cards with sparklines, team leaderboard with horizontal bars, category comparison, SLA details, and CSV export. Ward councillors see ward-filtered data.</done>
</task>

</tasks>

<verification>
1. AnalyticsPage renders all sections (KPIs, leaderboard, categories, SLA)
2. TimeRangeControls switch between presets and custom dates
3. KPI cards show animated counters and sparklines
4. TeamLeaderboard ranks teams with horizontal progress bars
5. CategoryComparison shows stacked bars with category colors
6. Ward councillor role sees filtered analytics
7. CSV export button triggers file download
8. Loading skeletons display during fetch
</verification>

<success_criteria>
- Analytics page has Stripe-style KPI cards with sparklines
- Time range switching (7d/30d/90d/6mo/1yr + custom) refetches data
- Team leaderboard uses horizontal bars (not vertical charts)
- Category comparison uses colored bars matching CATEGORY_CONFIG
- Ward councillor view works with ward_id filtering
- No complex Recharts usage (pure CSS bars + SVG sparklines)
</success_criteria>

<output>
After completion, create `.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-05-SUMMARY.md`
</output>
