---
phase: 06.1.1-teams-analytics-settings
plan: 06
type: execute
wave: 2
depends_on: ["06.1.1-01", "06.1.1-02"]
files_modified:
  - frontend-dashboard/src/pages/SettingsPage.tsx
  - frontend-dashboard/src/components/settings/SettingsSection.tsx
  - frontend-dashboard/src/components/settings/MunicipalityProfile.tsx
  - frontend-dashboard/src/components/settings/SLATargetsSection.tsx
  - frontend-dashboard/src/components/settings/NotificationsSection.tsx
  - frontend-dashboard/src/components/settings/TeamDefaultsSection.tsx
  - frontend-dashboard/src/components/settings/BrandingSection.tsx
  - frontend-dashboard/src/components/settings/DataExportSection.tsx
  - frontend-dashboard/src/components/settings/AuditLogSection.tsx
  - frontend-dashboard/src/components/settings/WardBoundariesSection.tsx
  - frontend-dashboard/src/hooks/useSettings.ts
autonomous: true
requirements:
  - OPS-02
  - SEC-04

must_haves:
  truths:
    - "Settings page is a single scrollable page with clearly separated sections"
    - "Anchor navigation at top links to each section"
    - "Each section has its own Save button (no auto-save)"
    - "SLA targets section allows editing response/resolution hours per category"
    - "Audit log viewer shows paginated log entries (admin-only)"
    - "Admin-only sections are hidden for manager role"
    - "Data export section provides CSV and Excel download buttons"
  artifacts:
    - path: "frontend-dashboard/src/pages/SettingsPage.tsx"
      provides: "Settings page with anchor nav and role-gated sections"
      contains: "SettingsPage"
    - path: "frontend-dashboard/src/components/settings/SettingsSection.tsx"
      provides: "Reusable section wrapper with Save button"
      contains: "SettingsSection"
    - path: "frontend-dashboard/src/components/settings/SLATargetsSection.tsx"
      provides: "SLA config editor per category"
      contains: "SLATargetsSection"
    - path: "frontend-dashboard/src/components/settings/AuditLogSection.tsx"
      provides: "Paginated audit log viewer"
      contains: "AuditLogSection"
    - path: "frontend-dashboard/src/hooks/useSettings.ts"
      provides: "Settings data fetching and save management"
      contains: "useSettings"
  key_links:
    - from: "frontend-dashboard/src/pages/SettingsPage.tsx"
      to: "frontend-dashboard/src/hooks/useSettings.ts"
      via: "useSettings() hook"
      pattern: "useSettings"
    - from: "frontend-dashboard/src/hooks/useSettings.ts"
      to: "frontend-dashboard/src/services/api.ts"
      via: "fetchSLAConfigs, fetchMunicipalityProfile API calls"
      pattern: "fetch(SLA|Municipality)"
---

<objective>
Build the Settings page with all configuration sections, anchor navigation, role-gated visibility, and per-section save functionality.

Purpose: Replace the "Coming Soon" placeholder for /settings with a full settings management page. Per locked decisions: single scrollable page, anchor nav, explicit save per section, role-based visibility.

Output: SettingsPage component, 8 section sub-components, SettingsSection wrapper, and useSettings hook.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-02-SUMMARY.md
@frontend-dashboard/src/pages/DashboardPage.tsx
@frontend-dashboard/src/components/onboarding/SetSLAStep.tsx
@frontend-dashboard/src/hooks/useAuth.ts
@frontend-dashboard/src/types/settings.ts
@frontend-dashboard/src/services/api.ts
@shared/components/ui/GlassCard.tsx
@shared/components/ui/Button.tsx
@shared/components/ui/Input.tsx
@shared/design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsSection wrapper + useSettings hook + MunicipalityProfile + SLATargets + DataExport sections</name>
  <files>
    frontend-dashboard/src/components/settings/SettingsSection.tsx
    frontend-dashboard/src/hooks/useSettings.ts
    frontend-dashboard/src/components/settings/MunicipalityProfile.tsx
    frontend-dashboard/src/components/settings/SLATargetsSection.tsx
    frontend-dashboard/src/components/settings/DataExportSection.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/components/settings/SettingsSection.tsx`:
   Per research: reusable section wrapper with Save button

   Props: { id: string, title: string, description?: string, children: ReactNode, onSave: () => Promise<void>, isDirty: boolean, isSaving: boolean, adminOnly?: boolean }

   Structure:
   - `<section id={id}>` for anchor navigation targeting
   - Header row: title (h2, font-weight 600) + description (text-muted) on left, "Save Changes" Button on right
   - Button disabled when !isDirty or isSaving, shows loading spinner when isSaving
   - Subtle section divider (border-bottom with glass-border color) after content
   - marginBottom: var(--space-2xl) between sections

2. Create `frontend-dashboard/src/hooks/useSettings.ts`:
   Manages data fetching for settings page.

   State:
   - slaConfigs: SLAConfig[]
   - municipalityProfile: MunicipalityProfile | null
   - isLoading: boolean

   On mount: fetch slaConfigs and municipalityProfile in parallel
   Expose: all state + updateSLA(category, data) + updateProfile(data) + refreshSettings()

3. Create `frontend-dashboard/src/components/settings/MunicipalityProfile.tsx`:
   Per locked decision: "Municipality profile (name, logo, contact info)"

   Props: profile: MunicipalityProfile | null, onSave: (data: Partial<MunicipalityProfile>) => Promise<void>

   - Local form state: { name, code, province, contact_email, contact_phone }
   - Initialize from props when profile loads
   - Track isDirty: compare local form to original profile values
   - Fields: name (Input), code (Input, read-only), province (Input, read-only), contact_email (Input type email), contact_phone (Input type tel)
   - Read-only fields have subtle disabled styling (opacity 0.7, cursor not-allowed)
   - Wrap in SettingsSection with id="municipality-profile"

4. Create `frontend-dashboard/src/components/settings/SLATargetsSection.tsx`:
   Per locked decision: "SLA targets (response/resolution hours per category)"
   Reference: existing SetSLAStep from onboarding for slider pattern

   Props: slaConfigs: SLAConfig[], onSave: (category: string, data: { response_hours, resolution_hours, warning_threshold_pct }) => Promise<void>

   Structure:
   - List each category from CATEGORY_CONFIG
   - For each category: show category badge + two number inputs (response hours, resolution hours) + warning threshold input
   - Category badge uses same colored pill as Teams page
   - Each row has its own "Save" button (individual category saves, not bulk)
   - If SLA config exists for category, pre-fill values; otherwise show defaults (24h response, 168h resolution, 80% warning)
   - Track dirty state per category row
   - Number inputs styled with design tokens
   - Wrap in SettingsSection with id="sla-targets"

5. Create `frontend-dashboard/src/components/settings/DataExportSection.tsx`:
   Per requirement OPS-02: "Municipal manager can export issue data to Excel/CSV"

   Props: none (uses API functions directly)

   Structure:
   - Two large action buttons: "Export to CSV" and "Export to Excel"
   - Each button shows file icon + label
   - On click: call exportTicketsCSV() or exportTicketsExcel() from api.ts, trigger blob download
   - Show loading state during download
   - Brief description: "Export all ticket data for your municipality. GBV/sensitive tickets are excluded per privacy policy."
   - Wrap in SettingsSection with id="data-export" (no Save button needed — uses action buttons instead)
   - Override SettingsSection to hide Save when section provides its own actions (pass isDirty=false)
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/components/settings/SettingsSection.tsx src/components/settings/MunicipalityProfile.tsx src/components/settings/SLATargetsSection.tsx src/components/settings/DataExportSection.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>SettingsSection wrapper provides consistent layout with Save button. Municipality profile, SLA targets, and data export sections are functional with proper dirty tracking and save behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Create remaining settings sections + SettingsPage with anchor nav</name>
  <files>
    frontend-dashboard/src/components/settings/NotificationsSection.tsx
    frontend-dashboard/src/components/settings/TeamDefaultsSection.tsx
    frontend-dashboard/src/components/settings/BrandingSection.tsx
    frontend-dashboard/src/components/settings/WardBoundariesSection.tsx
    frontend-dashboard/src/components/settings/AuditLogSection.tsx
    frontend-dashboard/src/pages/SettingsPage.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/components/settings/NotificationsSection.tsx`:
   Per locked decision: "Notification preferences"

   - Checkbox/toggle list for notification settings:
     - Email on new ticket assignment (default: on)
     - Email on SLA breach warning (default: on)
     - Email on ticket resolution (default: off)
     - Email on team invitation accepted (default: on)
   - Each toggle: label + description text + toggle switch (styled checkbox)
   - Track isDirty, wrap in SettingsSection id="notifications"
   - Note: Backend doesn't have notification preferences table — this section saves to localStorage for now with a comment "// TODO: Wire to backend notification preferences endpoint when available"

2. Create `frontend-dashboard/src/components/settings/TeamDefaultsSection.tsx`:
   Per locked decision: "Team defaults"

   - Configuration for new team creation defaults:
     - Default SLA template dropdown (links to SLA configs)
     - Auto-assign manager toggle
   - Simple form, wrap in SettingsSection id="team-defaults"
   - Saves to localStorage (no backend endpoint for team defaults)

3. Create `frontend-dashboard/src/components/settings/BrandingSection.tsx`:
   Per locked decision: "Branding/logo"
   Admin-only section.

   - Logo upload: drag-and-drop area or file input for municipality logo
   - Preview: show current logo if exists (from municipalityProfile.logo_url)
   - Brand color selector (read-only display of current theme colors)
   - Wrap in SettingsSection id="branding"
   - File upload uses existing requestPresignedUrl pattern from api.ts (purpose: 'proof_of_residence' repurposed or a note that logo upload endpoint needed)

4. Create `frontend-dashboard/src/components/settings/WardBoundariesSection.tsx`:
   Per research open question: "Ward Boundaries settings section should be a read-only display"

   - Read-only display with message: "Ward boundary configuration is managed by SALGA administration. Contact support@salga.org.za to update ward boundaries for your municipality."
   - If any ward IDs are known, display them as a simple list
   - Wrap in SettingsSection id="ward-boundaries" (no Save button — pass isDirty=false)

5. Create `frontend-dashboard/src/components/settings/AuditLogSection.tsx`:
   Per discretion decision: "Inline preview on Settings page — scrollable table of last 50 audit events"
   Admin-only section.

   Props: none (fetches own data)

   - Fetch audit logs using fetchAuditLogs({ page: 1, page_size: 50 }) from api.ts
   - Display as a scrollable table (maxHeight 400px, overflowY auto):
     - Columns: Timestamp, Operation, Table, Record ID, User
     - Timestamp formatted with date-fns format()
     - Operation badges: CREATE (green), UPDATE (amber), DELETE (red), READ (blue)
   - "Load More" button at bottom (increments page, appends to list)
   - Filter controls: table_name dropdown, operation dropdown
   - Wrap in SettingsSection id="audit-log" (no Save button — read-only)
   - Loading: Skeleton table rows

6. Create `frontend-dashboard/src/pages/SettingsPage.tsx`:
   Per locked decision: "Single scrollable page with clearly separated sections + anchor navigation at top"

   Layout matching DashboardPage pattern:
   - Container: maxWidth 1400px, margin 0 auto, padding 2rem
   - Header: h1 "Settings" (left)

   Anchor navigation bar (sticky, below header):
   - Horizontal row of anchor links: Profile | SLA Targets | Notifications | Team Defaults | Ward Boundaries | Branding | Data Export | Audit Log
   - Each link scrolls to its section using smooth scroll: `document.getElementById(id)?.scrollIntoView({ behavior: 'smooth' })`
   - Styled as pill buttons similar to TimeRangeControls (but with text links, not filled buttons)
   - Active anchor highlighted based on scroll position (use IntersectionObserver to detect which section is in view)

   Sections rendered in order:
   1. MunicipalityProfile (managers + admins)
   2. SLATargetsSection (managers + admins)
   3. NotificationsSection (managers + admins)
   4. TeamDefaultsSection (managers + admins)
   5. WardBoundariesSection (managers + admins)
   6. BrandingSection (admin-only)
   7. DataExportSection (managers + admins)
   8. AuditLogSection (admin-only)

   Role gating:
   - Use useAuth().getUserRole() to check role
   - Admin-only sections: BrandingSection, AuditLogSection — rendered only for admin role
   - Manager sections: all non-admin sections — rendered for manager AND admin
   - Anchor nav only shows links for visible sections
   - Per research: `const isAdmin = role === 'admin'; const isManager = role === 'manager' || role === 'admin';`

   Dirty state warning:
   - Track isDirty across all sections (per Pitfall 6)
   - Add beforeunload listener if any section has unsaved changes: `window.addEventListener('beforeunload', handler)`
   - Handler: `e.preventDefault(); e.returnValue = '';`
   - Remove listener on unmount or when all sections are clean

   Loading state: Skeleton for anchor nav + section placeholders
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/pages/SettingsPage.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>SettingsPage renders all 8 sections with anchor navigation, role-gated visibility, and beforeunload dirty warning. Admin-only sections (Branding, Audit Log) hidden from managers. Each section has independent save functionality.</done>
</task>

</tasks>

<verification>
1. SettingsPage renders with all sections in correct order
2. Anchor nav scrolls to target section smoothly
3. Admin-only sections hidden for manager role
4. Each section with editable content has Save button
5. SLA targets allow per-category editing
6. Data export buttons trigger file downloads
7. Audit log shows paginated entries with filters
8. Unsaved changes trigger beforeunload warning
</verification>

<success_criteria>
- Single scrollable settings page with 8 sections
- Anchor navigation at top with active state tracking
- Municipality profile form with dirty tracking and save
- SLA targets editor per category
- Data export with CSV and Excel download
- Audit log inline viewer with pagination and filters (admin-only)
- Role-gated section visibility (admin vs manager)
- beforeunload warning on unsaved changes
</success_criteria>

<output>
After completion, create `.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-06-SUMMARY.md`
</output>
