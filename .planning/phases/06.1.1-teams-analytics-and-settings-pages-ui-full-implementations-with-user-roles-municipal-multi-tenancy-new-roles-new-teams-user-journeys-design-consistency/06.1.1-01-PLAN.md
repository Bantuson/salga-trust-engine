---
phase: 06.1.1-teams-analytics-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/v1/teams.py
  - src/api/v1/settings.py
  - src/api/v1/audit_logs.py
  - src/main.py
  - src/schemas/team.py
  - src/schemas/invitation.py
  - src/models/team_invitation.py
autonomous: true
requirements:
  - OPS-01
  - OPS-04
  - SEC-04

must_haves:
  truths:
    - "GET /api/v1/teams returns teams for authenticated user's municipality"
    - "POST /api/v1/teams creates a team with name, category, manager_id"
    - "GET /api/v1/teams/{id}/members returns accepted invitations as team members"
    - "GET /api/v1/settings/sla returns SLA configs for municipality"
    - "PUT /api/v1/settings/sla/{category} updates SLA hours for a category"
    - "GET /api/v1/audit-logs returns paginated audit logs for admin"
    - "GET /api/v1/dashboard/metrics accepts start_date and end_date params for time-series"
  artifacts:
    - path: "src/api/v1/teams.py"
      provides: "Teams CRUD API with RBAC"
      contains: "router = APIRouter"
    - path: "src/api/v1/settings.py"
      provides: "SLA config and municipality profile CRUD"
      contains: "router = APIRouter"
    - path: "src/api/v1/audit_logs.py"
      provides: "Audit log listing endpoint"
      contains: "router = APIRouter"
  key_links:
    - from: "src/main.py"
      to: "src/api/v1/teams.py"
      via: "app.include_router(teams.router)"
      pattern: "include_router.*teams"
    - from: "src/main.py"
      to: "src/api/v1/settings.py"
      via: "app.include_router(settings.router)"
      pattern: "include_router.*settings"
---

<objective>
Create the missing backend API endpoints required by the Teams, Analytics, and Settings frontend pages.

Purpose: The frontend pages cannot fetch or manipulate data without these endpoints. Research identified 5 backend gaps: Teams CRUD, SLA config CRUD, municipality profile update, analytics time-series, and audit log listing. This plan closes all gaps.

Output: Three new API router files registered in main.py, plus schema/model updates for team_id on invitations.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/api/v1/dashboard.py
@src/api/v1/invitations.py
@src/models/team.py
@src/models/team_invitation.py
@src/models/sla_config.py
@src/models/audit_log.py
@src/models/user.py
@src/schemas/team.py
@src/schemas/invitation.py
@src/api/deps.py
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Teams CRUD API + team-scoped invitations</name>
  <files>
    src/api/v1/teams.py
    src/schemas/team.py
    src/schemas/invitation.py
    src/models/team_invitation.py
  </files>
  <action>
1. Add `team_id` column to TeamInvitation model:
   - `team_id: Mapped[UUID | None] = mapped_column(ForeignKey("teams.id"), nullable=True, index=True)`
   - Keep nullable=True for backward compatibility with existing municipality-level invitations

2. Update `TeamInvitationCreate` schema to include optional `team_id: UUID | None = None`

3. Update `TeamResponse` schema to include additional fields:
   - `member_count: int = 0` (computed, not from DB)
   - `manager_name: str | None = None` (computed, joined)
   - `active_ticket_count: int = 0` (computed)

4. Create `src/api/v1/teams.py` with these endpoints:

   ```python
   router = APIRouter(prefix="/teams", tags=["teams"])
   ```

   - `GET /teams` — List teams for current user's municipality. RBAC: MANAGER, ADMIN, WARD_COUNCILLOR.
     Query teams WHERE tenant_id = current_user.tenant_id AND is_active = True.
     For each team, compute member_count (count of TeamInvitation WHERE team_id=team.id AND status='accepted'),
     manager_name (join users WHERE id = team.manager_id → full_name), and
     active_ticket_count (count of Ticket WHERE assigned_team_id=team.id AND status IN ('open', 'in_progress')).
     Return list[TeamResponse].

   - `POST /teams` — Create new team. RBAC: ADMIN, MANAGER. Accept TeamCreate body.
     Set tenant_id from current_user.tenant_id. Return 201 + TeamResponse.

   - `GET /teams/{team_id}` — Get single team detail. RBAC: MANAGER, ADMIN.
     Return TeamResponse with computed fields.

   - `PATCH /teams/{team_id}` — Update team (name, category, manager_id, is_active). RBAC: ADMIN, MANAGER.
     Partial update via optional fields. Return TeamResponse.

   - `GET /teams/{team_id}/members` — Get team members (accepted invitations). RBAC: MANAGER, ADMIN.
     Query TeamInvitation WHERE team_id = team_id AND status = 'accepted'.
     Join with users table on email to get full_name, role, is_active.
     Return list of member objects: {id, email, full_name, role, joined_at (accepted_at)}.

   - `DELETE /teams/{team_id}/members/{invitation_id}` — Remove member from team. RBAC: ADMIN, MANAGER.
     Set TeamInvitation status to 'removed'. Return 204.

   - `GET /teams/{team_id}/invitations` — Get invitations for specific team. RBAC: MANAGER, ADMIN.
     Query TeamInvitation WHERE team_id = team_id. Return list[TeamInvitationResponse].

   All endpoints must verify the team belongs to current_user's municipality (tenant isolation).
   All endpoints must exclude is_saps teams from general queries (unless specifically requested).

5. Update existing `POST /invitations/` and `POST /invitations/bulk` in invitations.py to accept and store the optional team_id field.
  </action>
  <verify>
    Run `python -c "from src.api.v1.teams import router; print(f'Routes: {len(router.routes)}')"` — should show 7 routes.
    Run `python -c "from src.models.team_invitation import TeamInvitation; print('team_id' in TeamInvitation.__table__.columns)"` — should print True.
  </verify>
  <done>Teams CRUD API has 7 endpoints, all with RBAC guards and tenant isolation. TeamInvitation model has team_id column.</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings API (SLA config + municipality profile + audit logs) + analytics time-series params</name>
  <files>
    src/api/v1/settings.py
    src/api/v1/audit_logs.py
    src/api/v1/dashboard.py
    src/main.py
  </files>
  <action>
1. Create `src/api/v1/settings.py` with these endpoints:

   ```python
   router = APIRouter(prefix="/settings", tags=["settings"])
   ```

   - `GET /settings/sla` — List SLA configs for current user's municipality. RBAC: MANAGER, ADMIN.
     Query SLAConfig WHERE municipality_id = current_user.municipality_id.
     Return list of {category, response_hours, resolution_hours, warning_threshold_pct, is_active}.

   - `PUT /settings/sla/{category}` — Upsert SLA config for category. RBAC: ADMIN only.
     Accept body: {response_hours: int, resolution_hours: int, warning_threshold_pct: int}.
     Use INSERT ... ON CONFLICT or check-then-update pattern.
     Return updated SLAConfig.

   - `GET /settings/municipality` — Get municipality profile for current user. RBAC: MANAGER, ADMIN.
     Query Municipality WHERE id = current_user.municipality_id.
     Return {id, name, code, province, contact_email, contact_phone, logo_url}.
     Note: Municipality model may not have all these fields — return what exists, null for missing.

   - `PUT /settings/municipality` — Update municipality profile. RBAC: ADMIN only.
     Accept partial update body: {name?, contact_email?, contact_phone?, logo_url?}.
     Only admin can update. Return updated municipality.

2. Create `src/api/v1/audit_logs.py` with:

   ```python
   router = APIRouter(prefix="/audit-logs", tags=["audit-logs"])
   ```

   - `GET /audit-logs` — List audit logs. RBAC: ADMIN only.
     Accept query params: page (default 1), page_size (default 50, max 100), table_name (optional filter), operation (optional filter).
     Query AuditLog WHERE tenant_id = str(current_user.tenant_id).
     Order by timestamp DESC. Return paginated: {logs: [...], total: int, page: int, page_size: int}.

3. Add `start_date` and `end_date` optional query params to ALL 4 existing dashboard.py endpoints:
   - `/dashboard/metrics` — filter tickets by created_at >= start_date AND created_at <= end_date
   - `/dashboard/volume` — same date filter
   - `/dashboard/sla` — same date filter
   - `/dashboard/workload` — same date filter
   These params are optional strings in YYYY-MM-DD format. When present, pass to DashboardService methods.
   The DashboardService methods already accept **kwargs or can be extended with these params.

4. Register ALL new routers in `src/main.py`:
   ```python
   from src.api.v1 import teams, settings as settings_api, audit_logs
   # ...
   app.include_router(teams.router, prefix="/api/v1")
   app.include_router(settings_api.router, prefix="/api/v1")
   app.include_router(audit_logs.router, prefix="/api/v1")
   ```
   Use `settings as settings_api` alias to avoid conflict with `src.core.config.settings`.
  </action>
  <verify>
    Run `python -c "from src.api.v1.settings import router; print(f'Settings routes: {len(router.routes)}')"` — should show 4 routes.
    Run `python -c "from src.api.v1.audit_logs import router; print(f'Audit routes: {len(router.routes)}')"` — should show 1 route.
    Run `python -c "from src.main import app; print(f'Total routes: {len(app.routes)}')"` — should be higher than before (3 new routers registered).
  </verify>
  <done>Settings API has 4 endpoints (SLA list, SLA upsert, municipality get, municipality update), audit logs has 1 paginated listing endpoint, dashboard endpoints accept date range params, all 3 new routers registered in main.py.</done>
</task>

</tasks>

<verification>
1. All new API files import successfully without errors
2. main.py includes all 3 new routers
3. Teams endpoints enforce RBAC (MANAGER/ADMIN)
4. Settings SLA update is ADMIN-only
5. Audit logs listing is ADMIN-only
6. Dashboard endpoints accept start_date/end_date params
7. TeamInvitation model has team_id FK column
</verification>

<success_criteria>
- 7 new Teams API endpoints accessible at /api/v1/teams/*
- 4 new Settings API endpoints at /api/v1/settings/*
- 1 new Audit Logs endpoint at /api/v1/audit-logs
- Dashboard endpoints support date range filtering
- All endpoints have proper RBAC guards
- All new routers registered in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-01-SUMMARY.md`
</output>
