# Phase 10.2: Auth System Security Hardening — Research

**Researched:** 2026-02-25
**Domain:** Authentication security — Supabase Auth hardening, FastAPI rate limiting, password policy, session management, CAPTCHA, brute force protection, audit logging
**Confidence:** HIGH (Supabase official docs + verified against current codebase)

---

## Summary

Phase 10.2 follows Phase 10.1 (email OTP fix) and hardens the auth system against real-world attack vectors. The project uses **Supabase Auth** as the auth provider — password hashing, session management, JWT issuance, and OTP delivery are all delegated to Supabase. This means hardening happens across two layers: (1) **Supabase Dashboard configuration** (rate limits, password policy, session settings, CAPTCHA) and (2) **application-layer controls** (FastAPI backend reinforcement, frontend OTP entropy, audit logging for auth events, password policy enforcement in schemas).

The current codebase already has solid foundations: slowapi rate limiting at `5/minute` on auth endpoints, generic error messages preventing user enumeration, Supabase JWT verification with HS256, security headers middleware, and CORS with explicit origin lists. Hardening in Phase 10.2 means closing the remaining gaps without replacing what works.

The most impactful, lowest-risk work is: (1) enabling Supabase Dashboard auth hardening settings (password policy, session timeouts, single-session enforcement), (2) adding explicit auth event audit logging to the FastAPI layer, (3) strengthening password validation in Pydantic schemas, and (4) optionally adding CAPTCHA to registration/login. MFA (TOTP) is available on Supabase free tier but is complex enough to warrant a dedicated sub-phase — scope it as optional or plan it as plan 3.

**Primary recommendation:** Harden via Supabase Dashboard settings first (zero code changes, immediate security gains), then add application-layer auth event logging, then strengthen password schema validation, then add CAPTCHA as the final layer.

---

## Standard Stack

### Core (already installed, no new deps needed for most items)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `supabase` | `>=2.27.3` (installed) | Supabase client — auth operations | Supabase Auth is the auth provider; all session/OTP/user management via this SDK |
| `pyjwt` | `2.10.1` (installed) | Verify Supabase JWT tokens in FastAPI | Chosen over python-jose (deprecated); validates incoming tokens |
| `slowapi` | `0.1.9` (installed) | FastAPI rate limiting | Already decorating auth endpoints; extend for brute force detection |
| `redis` | `5.2.0` (installed) | Distributed rate limit storage | Production limiter storage; already configured for non-debug environments |

### Supporting (new, for CAPTCHA only — optional plan)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| `@hcaptcha/react-hcaptcha` | `^1.x` | hCaptcha React component | If CAPTCHA plan is included; add to both frontends |
| `@marsidev/react-turnstile` | `^3.x` | Cloudflare Turnstile component | Alternative to hCaptcha — better UX (no puzzle), free |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Supabase Dashboard session settings | Custom session tracking in FastAPI | Supabase Dashboard is authoritative; custom code is redundant and error-prone |
| slowapi for auth rate limits | Custom Redis-based counter | slowapi already installed and working; extending is safer than replacing |
| Pydantic password validator | Frontend-only validation | Backend validation is the security boundary; frontend is UX convenience only |

**Installation (if CAPTCHA plan included):**
```bash
cd frontend-public && npm install @marsidev/react-turnstile
cd frontend-dashboard && npm install @marsidev/react-turnstile
```

---

## Architecture Patterns

### Recommended Project Structure

```
src/
├── api/v1/auth.py           # Auth endpoints — add auth event logging here
├── core/security.py         # JWT verification — no changes needed
├── middleware/rate_limit.py # Extend AUTH_RATE_LIMIT window (5/min → stricter per IP)
├── schemas/auth.py          # Add email OTP schema; password validator is in user.py
├── schemas/user.py          # Strengthen password field validator (8 → 12+ chars, complexity)
└── core/audit.py            # Auth events currently not logged; add explicit logging

frontend-public/src/
├── pages/CitizenRegisterPage.tsx   # Add CAPTCHA widget (if plan included)
├── pages/CitizenLoginPage.tsx      # Add CAPTCHA widget (if plan included)
└── contexts/AuthContext.tsx        # Pass captchaToken to auth calls

frontend-dashboard/src/
├── pages/RegisterPage.tsx    # Add CAPTCHA widget (if plan included)
├── pages/LoginPage.tsx       # Add CAPTCHA widget (if plan included)
└── hooks/useAuth.ts          # Pass captchaToken to auth calls
```

### Pattern 1: Auth Event Audit Logging

**What:** Log login success/failure, registration, OTP send/verify, and token refresh to application audit log and structured application log. Supabase captures these internally in `auth.audit_log_entries` but the FastAPI layer has no visibility.
**When to use:** Every auth endpoint outcome.
**Example:**

```python
# Source: Project pattern from src/api/v1/auth.py + src/core/audit.py
# Add to login endpoint — AFTER Supabase auth attempt

@router.post("/login", response_model=TokenResponse)
@limiter.limit(AUTH_RATE_LIMIT)
async def login(request: Request, credentials: LoginRequest, ...):
    client_ip = request.client.host if request.client else "unknown"
    user_agent = request.headers.get("user-agent", "unknown")

    try:
        auth_response = supabase_admin.auth.sign_in_with_password(...)
        # Success: log it
        logger.info(
            "auth.login.success",
            extra={
                "event": "login_success",
                "email_domain": credentials.email.split("@")[-1],  # No PII: domain only
                "ip": client_ip,
                "user_agent": user_agent,
            }
        )
        return TokenResponse(...)

    except Exception as e:
        # Failure: log it (without email — prevents PII in logs)
        logger.warning(
            "auth.login.failure",
            extra={
                "event": "login_failure",
                "ip": client_ip,
                "reason": "invalid_credentials",
            }
        )
        raise HTTPException(status_code=401, detail="Invalid credentials", ...)
```

### Pattern 2: Supabase Dashboard Session Hardening

**What:** Configure via Supabase Dashboard (no code changes) — these are production-grade controls.
**When to use:** Immediately — Dashboard changes take effect in minutes.
**Settings to configure:**

```
Supabase Dashboard > Authentication > Sessions:
- Time-box user sessions: 7 days (municipal staff) / 30 days (citizens)
  → Requires Pro Plan; on Free plan, sessions persist until revoked
- Inactivity timeout: 24 hours
  → Terminates sessions unused for 24h (reduces abandoned session risk)
- Single session per user: OFF for citizens (multi-device), discuss for staff
  → Enabled = last login wins, others terminated

Supabase Dashboard > Authentication > Advanced:
- JWT expiry: 3600 seconds (1 hour) — keep default
- OTP expiry: 600 seconds (10 min) recommended (current may be 3600)
- OTP length: 8 digits (already applied in Phase 10.1)

Supabase Dashboard > Authentication > Passwords:
- Minimum password length: 12 (up from default 8)
- Require lowercase: ON
- Require uppercase: ON
- Require digits: ON
- Require symbols: OFF (usability tradeoff for citizens)
- Prevent reuse of last N passwords: 5 (Pro Plan feature)
- Check against HaveIBeenPwned: ON (Pro Plan feature)
```

### Pattern 3: Application Password Validation Strengthening

**What:** Supabase Dashboard enforces policy server-side, but Pydantic schema should match for early validation and clear error messages.
**When to use:** Registration and password change endpoints.
**Example:**

```python
# Source: src/schemas/user.py — extend existing Field validator
from pydantic import BaseModel, EmailStr, Field, field_validator
import re

class UserCreate(BaseModel):
    email: EmailStr
    # Strengthen: 8 → 12 chars, add complexity validator
    password: str = Field(..., min_length=12, max_length=128, description="Min 12 chars")
    full_name: str = Field(..., min_length=2, max_length=100)
    phone: str | None = None
    preferred_language: str = Field(default="en")
    municipality_code: str

    @field_validator("password")
    @classmethod
    def validate_password_complexity(cls, v: str) -> str:
        """Enforce password complexity: uppercase, lowercase, digit required."""
        if not re.search(r"[A-Z]", v):
            raise ValueError("Password must contain at least one uppercase letter")
        if not re.search(r"[a-z]", v):
            raise ValueError("Password must contain at least one lowercase letter")
        if not re.search(r"\d", v):
            raise ValueError("Password must contain at least one digit")
        return v
```

### Pattern 4: CAPTCHA Integration (Cloudflare Turnstile)

**What:** Add invisible/smart CAPTCHA to login, registration, and OTP send endpoints to block automated attacks.
**When to use:** On registration and login form submit.
**Example (frontend):**

```typescript
// Source: Supabase official CAPTCHA docs + @marsidev/react-turnstile pattern
import { Turnstile } from '@marsidev/react-turnstile';
import { useState, useRef } from 'react';

const [captchaToken, setCaptchaToken] = useState<string>('');
const captchaRef = useRef(null);

// In JSX:
<Turnstile
  ref={captchaRef}
  siteKey={import.meta.env.VITE_TURNSTILE_SITE_KEY}
  onSuccess={(token) => setCaptchaToken(token)}
  options={{ theme: 'auto' }}
/>

// In auth call:
await supabase.auth.signUp({
  email,
  password,
  options: { captchaToken },  // Supabase validates against Turnstile secret
})

// Reset after attempt:
captchaRef.current?.reset();
```

**Example (Supabase Dashboard config):**
```
Dashboard > Authentication > Bot and Abuse Protection:
- Enable CAPTCHA: ON
- Provider: Cloudflare Turnstile
- Secret key: <from Cloudflare dashboard>
```

### Anti-Patterns to Avoid

- **Rolling your own lockout with DB counters:** Supabase has fail2ban built-in on Supabase-hosted projects. Don't duplicate with a `failed_attempts` column on `users` — distributed locking overhead is high and slowapi already limits per IP.
- **Logging email addresses in failure logs:** Violates POPIA (personal data in logs). Log email domain only (`split("@")[-1]`) or a truncated hash.
- **Blocking accounts permanently:** OWASP recommends time-based lockout (20 min), not permanent. Permanent locks create DoS vectors. Supabase's fail2ban uses time-based blocking.
- **CAPTCHA on every request:** Only needed on unauthenticated state-changing endpoints (signup, login, password reset). Authenticated endpoints use JWT.
- **Setting refresh token reuse interval to 0:** Supabase default is 10 seconds, which handles concurrent SSR requests. Setting to 0 causes race conditions in multi-tab apps.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Password breach detection | Custom HaveIBeenPwned API call in registration endpoint | Supabase Dashboard > Password Security > Prevent use of leaked passwords | Supabase integrates HIBP natively on Pro Plan; hand-rolling requires API key management, caching, and rate limiting |
| Account lockout after N failures | `failed_login_attempts` column + lockout middleware | Supabase fail2ban (built-in) + slowapi `5/minute` per IP | Supabase hosted projects have fail2ban at the auth server level; slowapi adds application-layer throttle |
| Session invalidation on suspicious activity | Custom session store + invalidation logic | Supabase `signOut({ scope: 'global' })` + session time-boxing in Dashboard | Supabase manages session state; application-layer revocation via admin API |
| OTP entropy analysis | Custom OTP length validation | Supabase Dashboard OTP length setting (6-8 digits already applied) | Already implemented in Phase 10.1; Supabase handles generation and validation |
| TOTP/MFA enrollment flow | Custom TOTP with speakeasy/otplib | `supabase.auth.mfa.enroll()` + challenge/verify pattern | Supabase MFA is free on all plans, TOTP API handles QR code generation, challenge/verify lifecycle |

**Key insight:** The auth system is Supabase-owned. The fastest and most secure hardening path is Dashboard configuration, not custom code. Custom code fills only the gaps Supabase cannot address (application-layer audit logging, schema validation, CAPTCHA widget on the frontend).

---

## Common Pitfalls

### Pitfall 1: OTP Expiry Too Long
**What goes wrong:** Default Supabase OTP expiry may be 3600 seconds (1 hour). A stolen OTP code is valid for an hour, enabling session hijacking via email/SMS interception.
**Why it happens:** Supabase defaults err toward usability over security.
**How to avoid:** Set OTP expiry to 600 seconds (10 min) in Dashboard > Auth > Advanced.
**Warning signs:** Check current setting at Dashboard > Auth > Providers > Email/Phone.

### Pitfall 2: Password Min Length Mismatch
**What goes wrong:** Supabase Dashboard enforces min 8 chars, Pydantic schema also allows 8. If Dashboard is updated to 12 but schema is not, users get confusing errors from Supabase after passing schema validation.
**Why it happens:** Two separate validation layers with no synchronization.
**How to avoid:** Update both simultaneously. Schema should match or be stricter than Dashboard.
**Warning signs:** HTTP 422 from Pydantic (before Supabase call) vs HTTP 422 from Supabase (after call) — different error messages.

### Pitfall 3: CAPTCHA in Debug Mode
**What goes wrong:** CAPTCHA widgets fail in localhost without domain verification, blocking development flows entirely.
**Why it happens:** Cloudflare Turnstile validates the domain the script runs on. `localhost` is not verified.
**How to avoid:** Turnstile provides a test sitekey (`1x00000000000000000000AA`) and test secret (`1x0000000000000000000000000000000AA`) for localhost. Use `VITE_TURNSTILE_SITE_KEY` env var — different values per environment.
**Warning signs:** CAPTCHA widget throws error immediately on load in development.

### Pitfall 4: Auth Logs Containing PII
**What goes wrong:** Logging `credentials.email` in failure logs creates POPIA-violating audit trail. Log aggregation systems (Sentry, Render logs) may retain these.
**Why it happens:** Natural to log the identifier being attempted.
**How to avoid:** Log email domain only (`credentials.email.split("@")[-1]`) or a truncated SHA-256 hash of the email for correlation without exposure.
**Warning signs:** Any `logger.warning(f"... {credentials.email} ...")` pattern in auth endpoints.

### Pitfall 5: Supabase Admin Client Bypasses Auth Rate Limits
**What goes wrong:** The `supabase_admin` client (service role) used in `auth.py` calls `sign_in_with_password` — this goes through Supabase's admin API, which may not be subject to the same per-IP rate limits as the public `/auth/v1/token` endpoint.
**Why it happens:** Admin client and client-side auth use different paths.
**How to avoid:** The slowapi `@limiter.limit(AUTH_RATE_LIMIT)` decorator is applied at the FastAPI layer BEFORE the Supabase call. This provides the application-level gate. Verify it's effective by checking the `limiter` storage is Redis in production (not in-memory).
**Warning signs:** `settings.DEBUG = True` in production config — forces in-memory limiter which resets on restart.

### Pitfall 6: Session Settings on Free Plan
**What goes wrong:** Time-boxed sessions and single-session-per-user require Supabase Pro Plan ($25/month). On the Free plan, these settings appear in the Dashboard but have no effect.
**Why it happens:** Supabase gates advanced session controls to paid tiers.
**How to avoid:** For Free plan: rely on JWT expiry (1 hour access token) + `autoRefreshToken: true` client setting. Frontend should call `signOut({ scope: 'global' })` on suspicious activity. Session time-boxing is a Pro-only enhancement — document clearly if project is on Free plan.
**Warning signs:** Dashboard shows session settings but they don't take effect.

---

## Code Examples

Verified patterns from official sources:

### Supabase Auth Event Audit Logging (Backend)

```python
# Source: Project pattern — extend src/api/v1/auth.py
# POPIA-safe: log domain only, never full email

import logging
logger = logging.getLogger(__name__)

def _log_auth_event(
    event: str,
    request: Request,
    email_domain: str | None = None,
    user_id: str | None = None,
    reason: str | None = None,
) -> None:
    """Log auth event with POPIA-safe data (no full email addresses)."""
    extra = {
        "event": event,
        "ip": request.client.host if request.client else "unknown",
        "user_agent": request.headers.get("user-agent", "unknown")[:200],  # truncate
    }
    if email_domain:
        extra["email_domain"] = email_domain  # domain only, not full email
    if user_id:
        extra["user_id"] = user_id[:8] + "..."  # truncate UUID for POPIA
    if reason:
        extra["reason"] = reason

    if "failure" in event or "locked" in event:
        logger.warning(f"auth.event: {event}", extra=extra)
    else:
        logger.info(f"auth.event: {event}", extra=extra)
```

### OTP Expiry Configuration (Dashboard — no code)

```
Supabase Dashboard:
Project Settings > Auth > Advanced Settings:
- OTP Expiry: 600 (seconds) — 10 minutes

Dashboard > Auth > Providers > Email:
- Enable email confirmations: ON (verify this is still ON from Phase 10.1)
- OTP length: 8 digits (already set in Phase 10.1)
```

### Password Validator Extension

```python
# Source: src/schemas/user.py — extend existing UserCreate
import re
from pydantic import field_validator

@field_validator("password")
@classmethod
def validate_password_complexity(cls, v: str) -> str:
    """Enforce password complexity per OWASP recommendations."""
    errors = []
    if len(v) < 12:
        errors.append("at least 12 characters")
    if not re.search(r"[A-Z]", v):
        errors.append("at least one uppercase letter")
    if not re.search(r"[a-z]", v):
        errors.append("at least one lowercase letter")
    if not re.search(r"\d", v):
        errors.append("at least one digit")
    if errors:
        raise ValueError(f"Password must contain: {', '.join(errors)}")
    return v
```

### Turnstile CAPTCHA with Supabase (Frontend)

```typescript
// Source: Supabase official CAPTCHA docs (https://supabase.com/docs/guides/auth/auth-captcha)
// Pattern adapted for Cloudflare Turnstile

import { Turnstile } from '@marsidev/react-turnstile';

const siteKey = import.meta.env.VITE_TURNSTILE_SITE_KEY;
// Dev: '1x00000000000000000000AA' (always passes)
// Prod: real sitekey from Cloudflare dashboard

const [captchaToken, setCaptchaToken] = useState('');

// In form:
<Turnstile
  siteKey={siteKey}
  onSuccess={(token) => setCaptchaToken(token)}
  onError={() => setCaptchaToken('')}
  options={{ theme: 'dark', size: 'invisible' }}  // invisible widget
/>

// In signUp/signIn:
await supabase.auth.signUp({
  email, password,
  options: { captchaToken },
})

await supabase.auth.signInWithPassword({
  email, password,
  options: { captchaToken },
})
```

### Supabase MFA TOTP (Optional — Plan 3 if scoped)

```typescript
// Source: Supabase official MFA docs (https://supabase.com/docs/guides/auth/auth-mfa/totp)
// Three-step enrollment: enroll → challenge → verify

// Step 1: Enroll — shows QR code to user
const { data, error } = await supabase.auth.mfa.enroll({ factorType: 'totp' })
// data.totp.qr_code — base64 SVG QR code to display
// data.totp.secret — plain text secret for manual entry

// Step 2: Challenge — prepare to verify
const { data: challenge, error: challengeError } = await supabase.auth.mfa.challenge({
  factorId: data.id,
})

// Step 3: Verify — user enters 6-digit code from authenticator
const { data: verified, error: verifyError } = await supabase.auth.mfa.verify({
  factorId: data.id,
  challengeId: challenge.id,
  code: userEnteredCode,
})
// On success: session promoted to aal2 (highest assurance level)
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Custom argon2/bcrypt local password hashing | Supabase Auth bcrypt (server-side) | Phase 6.1 migration | Password management fully delegated; no local hash needed |
| Custom JWT creation + python-jose | PyJWT + Supabase JWT verification | Phase 1 / Phase 6.1 | No token creation — only verification of Supabase-issued tokens |
| In-memory rate limiter | Redis-backed slowapi in production | Phase 1 | Persistent across restarts; distributed multi-worker |
| SMS OTP only | Email OTP added as primary path | Phase 10.1 | Avoids Twilio SMS costs; leverages Supabase built-in email |
| Supabase built-in email (2/hr limit) | Custom SMTP pending configuration | Phase 10.1 (blocker) | **Still unresolved** — Phase 10.2 hardening depends on SMTP being configured |

**Deprecated/outdated:**
- `argon2-cffi` in pyproject.toml: Listed as a dependency but unused (password hashing is Supabase-owned). Safe to keep (no harm), but it's dead code.
- `SECRET_KEY` / `ALGORITHM` / `ACCESS_TOKEN_EXPIRE_MINUTES` in config: Were for the old custom JWT system. Supabase Auth replaced this. `SECRET_KEY` still validates length. These fields could be removed in cleanup, but are harmless.
- `email_confirm: True` in `auth.py` line 109: Forces auto-confirmation — was set to workaround the email delivery bug. Should be reverted to `False` once custom SMTP is configured.

---

## Open Questions

1. **Is the Supabase project on Free or Pro Plan?**
   - What we know: Free plan is standard for new projects; Pro is $25/month.
   - What's unclear: Time-boxed sessions, single-session enforcement, leaked password check, and password reuse prevention are Pro-only features.
   - Recommendation: Check `supabase.com/dashboard/project/_/settings/billing`. If Free, plan only Dashboard items available on Free. If Pro, all settings are available. The research documents both paths; planner should create conditional tasks or note which require Pro.

2. **Is custom SMTP now configured? (Phase 10.1 blocker)**
   - What we know: Phase 10.1 was paused waiting for SMTP configuration. The current workaround (`signInWithOtp` after `signUp`) remains in both registration pages.
   - What's unclear: Whether the user has configured SMTP since Phase 10.1 paused.
   - Recommendation: Phase 10.2 Plan 01 should start with a checkpoint: if SMTP is configured, revert the Phase 10.1 workaround first. If not configured, hardening proceeds independently.

3. **Should CAPTCHA be in scope for Phase 10.2?**
   - What we know: Supabase Dashboard CAPTCHA requires either hCaptcha or Turnstile account setup (external service). Frontend requires a new npm package and widget in both apps.
   - What's unclear: Whether the dev wants external service dependencies at this stage.
   - Recommendation: Split CAPTCHA into an optional plan (Plan 3). Plans 1-2 are self-contained; Plan 3 adds CAPTCHA and can be skipped.

4. **Should MFA be in scope for Phase 10.2?**
   - What we know: Supabase TOTP MFA is free and available. Enforcement via RLS `aal2` policy is well-documented. However, MFA enrollment UI is a significant UX addition.
   - What's unclear: Whether municipal staff MFA is required for pilot municipalities, or if it's a nice-to-have.
   - Recommendation: Defer full MFA enforcement to a v2 phase. Document it as an architectural note in Phase 10.2 if relevant.

---

## Validation Architecture

### Test Framework

| Property | Value |
|----------|-------|
| Framework | pytest 8.3.0 + pytest-asyncio 0.24.0 |
| Config file | `pyproject.toml` — `[tool.pytest.ini_options]` |
| Quick run command | `pytest tests/test_security_unit.py tests/test_auth.py -q` |
| Full suite command | `pytest tests/ -q` (unit tests; integration tests auto-skip without PostgreSQL) |
| Estimated runtime | ~5-10 seconds (unit tests only) |

### Phase Requirements → Test Map

This phase has no formal requirement IDs (it is an inserted urgent phase). Behaviors map as follows:

| Behavior | Test Type | Automated Command | File Exists? |
|----------|-----------|-------------------|-------------|
| Password min 12 chars rejected below threshold | unit | `pytest tests/test_security_unit.py -k test_password -x` | ❌ Wave 0 gap |
| Password complexity (uppercase/lowercase/digit) required | unit | `pytest tests/test_security_unit.py -k test_password -x` | ❌ Wave 0 gap |
| Auth event logged on login success | unit | `pytest tests/test_security_unit.py -k test_auth_event -x` | ❌ Wave 0 gap |
| Auth event logged on login failure | unit | `pytest tests/test_security_unit.py -k test_auth_event -x` | ❌ Wave 0 gap |
| Auth event logs domain only (POPIA) | unit | `pytest tests/test_security_unit.py -k test_auth_event -x` | ❌ Wave 0 gap |
| Rate limit triggers 429 on auth endpoints | unit (existing) | `pytest tests/test_api_security_audit.py -k test_auth_endpoint_rate_limited -x` | ✅ exists |
| Security headers present on auth responses | unit (existing) | `pytest tests/test_middleware.py -k test_security_headers -x` | ✅ exists |
| JWT verification rejects expired tokens | unit (existing) | `pytest tests/test_security_unit.py -k test_verify_supabase_token_expired -x` | ✅ exists |
| Supabase Dashboard OTP expiry set (manual) | manual | Supabase Dashboard inspection | N/A — human |
| Password policy enforced in Supabase (manual) | manual | Attempt registration with weak password | N/A — human |

### Nyquist Sampling Rate

- **Minimum sample interval:** After every committed task → run: `pytest tests/test_security_unit.py -q`
- **Full suite trigger:** Before merging final task of any plan wave
- **Phase-complete gate:** Full suite green before `/gsd:verify-work` runs
- **Estimated feedback latency per task:** ~5-10 seconds

### Wave 0 Gaps (must be created before implementation)

- [ ] `tests/test_security_unit.py` — add `TestPasswordValidation` class covering min length 12, complexity (uppercase/lowercase/digit), rejection below threshold. This file EXISTS — add new class, don't create file.
- [ ] `tests/test_security_unit.py` — add `TestAuthEventLogging` class covering login success, login failure, OTP send, POPIA-safe domain-only logging. Add to existing file.

*(No new test files needed — all new tests fit in `tests/test_security_unit.py`)*

---

## Sources

### Primary (HIGH confidence)

- `/supabase/supabase` (Context7) — auth rate limiting, CAPTCHA, MFA patterns
- `/supabase/supabase-js` (Context7) — signUp/signIn with captchaToken, MFA enroll/challenge/verify
- [Supabase Auth Rate Limits](https://supabase.com/docs/guides/auth/rate-limits) — rate limit defaults and customization
- [Supabase Password Security](https://supabase.com/docs/guides/auth/password-security) — policy settings, HIBP, bcrypt
- [Supabase Production Checklist](https://supabase.com/docs/guides/deployment/going-into-prod) — auth hardening checklist
- [Supabase Session Docs](https://supabase.com/docs/guides/auth/sessions) — time-box, inactivity, single-session
- [Supabase CAPTCHA Docs](https://supabase.com/docs/guides/auth/auth-captcha) — CAPTCHA provider setup and token usage
- [Supabase Auth Audit Logs](https://supabase.com/docs/guides/auth/audit-logs) — event types and query patterns

### Secondary (MEDIUM confidence)

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html) — brute force, lockout, password policy standards
- [OWASP Top 10:2025 A07 Authentication Failures](https://owasp.org/Top10/2025/A07_2025-Authentication_Failures/) — current threat landscape
- Supabase production checklist — MFA rate limits (15 req/min on `/auth/v1/factors/:id/challenge`)

### Tertiary (LOW confidence)

- None — all critical claims verified against official Supabase docs

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all packages already installed; Supabase is the auth provider
- Architecture: HIGH — Supabase Dashboard settings verified against official docs; code patterns match existing project conventions
- Pitfalls: HIGH — Pitfall 3 (CAPTCHA localhost), 5 (admin client rate limiting), 6 (Free plan limits) verified against official docs; Pitfall 4 (PII in logs) is POPIA requirement from CLAUDE.md

**Research date:** 2026-02-25
**Valid until:** 2026-03-25 (Supabase Dashboard settings are stable; check for Supabase JS client version bumps)

---

## Appendix: Current Codebase Auth Security Audit

*This section summarizes what exists vs. what needs to be built — for use by the planner.*

### What Already Exists (Do Not Break)

| Control | Location | Status |
|---------|----------|--------|
| Rate limiting: 5/min login, 3/hr register | `src/middleware/rate_limit.py`, `src/api/v1/auth.py` | Working |
| JWT verification (HS256 + audience check) | `src/core/security.py` | Working |
| Generic error messages (no user enumeration) | `src/api/v1/auth.py` lines 221-227 | Working |
| Security headers (HSTS, CSP, X-Frame-Options) | `src/middleware/security_headers.py` | Working |
| CORS explicit origin list (no wildcard) | `src/main.py` + `src/core/config.py` | Working |
| Tenant isolation via JWT app_metadata | `src/api/deps.py` | Working |
| POPIA audit logging for DB operations | `src/core/audit.py` | Working |
| SSL mode validation for production DB | `src/core/config.py` model_validator | Working |
| Password min_length=8 Pydantic validation | `src/schemas/user.py` | Needs strengthening |
| Redis rate limit storage in production | `src/middleware/rate_limit.py` | Working (if DEBUG=False) |

### Gaps to Close in Phase 10.2

| Gap | Priority | Location | Approach |
|-----|----------|----------|----------|
| Password: only 8 chars min, no complexity | HIGH | `src/schemas/user.py` | Add validator + raise to 12 chars |
| No auth event logging in FastAPI layer | HIGH | `src/api/v1/auth.py` | Add `_log_auth_event()` helper |
| OTP expiry not verified (may be 3600s) | MEDIUM | Supabase Dashboard | Set to 600s; document check procedure |
| Session time limits not configured | MEDIUM | Supabase Dashboard | Set inactivity timeout + JWT expiry |
| No CAPTCHA on registration/login | LOW | Both frontends | Turnstile widget (optional plan) |
| `email_confirm: True` still set | MEDIUM | `src/api/v1/auth.py` line 109 | Revert after SMTP confirmed (10.1 blocker) |
| Unused `argon2-cffi` dep | VERY LOW | `pyproject.toml` | Note in cleanup, not blocking |
| Auth event types not in `OperationType` enum | MEDIUM | `src/models/audit_log.py` | Add AUTH_LOGIN, AUTH_FAILURE, AUTH_REGISTER |
