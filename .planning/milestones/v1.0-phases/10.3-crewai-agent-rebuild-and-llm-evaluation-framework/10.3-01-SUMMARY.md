---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 01
subsystem: agents
tags: [crewai, deepeval, pydantic, agents, testing, llm, flow-router]

# Dependency graph
requires:
  - phase: 06.7-municipal-intake-agent-testing
    provides: Original agent code (src/agents/) now archived to src/agents_old/

provides:
  - Clean src/agents/ scaffold: llm.py, base_crew.py, flows/state.py, empty config YAMLs
  - IntakeState Pydantic model with 10 fields and correct defaults
  - BaseCrew abstract base with YAML loading, sequential Process, parse_result pattern
  - LLM factories: get_deepseek_llm() for conversation agents, get_routing_llm() for tool-heavy
  - deepeval 3.4.6 installed as eval optional dependency
  - tests/agents/ package with 6 shared fixtures (conftest.py)
  - tests/evals/ package with scenarios/ and reports/ directories

affects: [10.3-02, 10.3-03, 10.3-04, 10.3-05, 10.3-06, 10.3-07]

# Tech tracking
tech-stack:
  added:
    - deepeval>=1.0 (eval optional dependency group in pyproject.toml)
  patterns:
    - Flow-as-router architecture (replaces Process.hierarchical)
    - get_deepseek_llm() for conversation-heavy agents, get_routing_llm() for tool-heavy/routing
    - BaseCrew: single agent + single task + Process.sequential + memory=False
    - IntakeState: all fields with defaults (required by CrewAI Flow initialization)
    - _repair_from_raw as module-level function (prevents circular imports)
    - Lazy LLM instantiation (new LLM per call, not cached across Crew instances)

key-files:
  created:
    - src/agents/__init__.py
    - src/agents/llm.py
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml
    - src/agents/crews/__init__.py
    - src/agents/crews/base_crew.py
    - src/agents/crews/manager_crew.py (stub for import compatibility)
    - src/agents/flows/__init__.py
    - src/agents/flows/state.py
    - src/agents/tools/__init__.py
    - src/agents/prompts/__init__.py
    - tests/agents/__init__.py
    - tests/agents/conftest.py
    - tests/evals/__init__.py
    - tests/evals/scenarios/__init__.py
    - tests/evals/reports/.gitkeep
  modified:
    - pyproject.toml (added eval optional-dependencies group with deepeval)
    - src/core/config.py (added OPENAI_API_KEY to Settings model)

key-decisions:
  - "Use Flow-as-router + sequential specialist Crews (drop Process.hierarchical entirely)"
  - "get_deepseek_llm() for conversation agents; get_routing_llm() for tool-heavy agents"
  - "deepeval added as [eval] optional dependency (not in [dev] — only runs with live LLM)"
  - "OPENAI_API_KEY added to Settings model for explicit configuration (not just env passthrough)"
  - "ManagerCrew stub created for import compatibility — real implementation in Plan 07"
  - "IntakeState has pending_intent field as empty string default (not None) for auth handoff"

patterns-established:
  - "BaseCrew: YAML loading in __init__, lazy LLM in .llm property, sequential Process always"
  - "All Crew classes: memory=False (conversation history via string injection, not CrewAI memory)"
  - "LLM factories: get_deepseek_llm() and get_routing_llm() — new LLM per call (no caching)"
  - "Test fixtures: fake API keys set via os.environ.setdefault before CrewAI imports"

requirements-completed: [AI-01, AI-02]

# Metrics
duration: 31min
completed: 2026-02-25
---

# Phase 10.3 Plan 01: Archive and Scaffold Summary

**Old src/agents/ archived to src/agents_old/ via git mv; new scaffold with IntakeState, BaseCrew, dual LLM factories (DeepSeek + GPT-4o-mini), and deepeval 3.4.6 installed**

## Performance

- **Duration:** 31 min
- **Started:** 2026-02-25T13:30:05Z
- **Completed:** 2026-02-25T14:01:18Z
- **Tasks:** 2
- **Files modified:** 19 (created + modified)

## Accomplishments
- Archived entire old agent codebase to src/agents_old/ with full git history preserved
- Built new src/agents/ scaffold: llm.py, base_crew.py, state.py, empty config YAMLs, 5 __init__.py files
- IntakeState Pydantic model with 10 fields and correct defaults (intent="unknown", session_status="none", pending_intent="")
- Installed deepeval 3.4.6 as eval optional dependency group
- Created test infrastructure: tests/agents/conftest.py with 6 shared fixtures, tests/evals/ package

## Task Commits

Each task was committed atomically:

1. **Task 1: Archive old agents and scaffold new directory structure** - `013a321` (feat)
2. **Task 2: Create agent test infrastructure and shared fixtures** - `dc314b4` (feat)

## Files Created/Modified
- `src/agents_old/` - Archive of complete old agent system (crews, flows, tools, prompts, config)
- `src/agents/__init__.py` - Package init with rebuild context
- `src/agents/llm.py` - Two factory functions: get_deepseek_llm() and get_routing_llm()
- `src/agents/crews/base_crew.py` - Rebuilt BaseCrew with YAML loading, sequential Process, parse_result
- `src/agents/crews/manager_crew.py` - Minimal import-compatibility stub (rebuilt in Plan 07)
- `src/agents/flows/state.py` - IntakeState Pydantic model (10 fields with defaults)
- `src/agents/config/agents.yaml` - Empty YAML scaffold with structure comments
- `src/agents/config/tasks.yaml` - Empty YAML scaffold with structure comments
- `tests/agents/conftest.py` - Shared fixtures: mock_llm, mock_conversation_manager, auth_context, municipal_context, gbv_context, ticket_status_context
- `tests/evals/reports/.gitkeep` - Directory for timestamped eval reports
- `pyproject.toml` - Added eval optional-dependency group with deepeval>=1.0
- `src/core/config.py` - Added OPENAI_API_KEY field to Settings model

## Decisions Made
- Used `get_deepseek_llm()` and `get_routing_llm()` as factory function names (matches plan spec and distinguishes use cases clearly)
- `BaseCrew.create_crew()` is a concrete method (not abstract) — allows BaseCrew to be imported and tested without subclassing
- `_repair_from_raw` kept as module-level function (was already this way in agents_old, prevents circular imports)
- `OPENAI_API_KEY` added to Settings model — plan used `settings.OPENAI_API_KEY` but it didn't exist; adding it enables proper configuration management

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] ManagerCrew stub for import compatibility**
- **Found during:** Task 2 (pytest test infrastructure verification)
- **Issue:** `pytest tests/agents/ --collect-only` failed with `ModuleNotFoundError: No module named 'src.agents.crews.manager_crew'`. The root `tests/conftest.py` imports `src.main` which imports `messages.py` which imports `ManagerCrew` at module level. Plan explicitly said "do NOT fix these imports yet" but they block the test infrastructure task's verification.
- **Fix:** Created `src/agents/crews/manager_crew.py` as a minimal non-functional stub that satisfies the import. The stub logs a warning and returns an error dict from kickoff(). Will be fully replaced in Plan 07.
- **Files modified:** `src/agents/crews/manager_crew.py`
- **Verification:** `pytest tests/agents/ --collect-only` runs without error, 0 tests collected (expected)
- **Committed in:** dc314b4 (Task 2 commit)

**2. [Rule 2 - Missing Critical] Added OPENAI_API_KEY to Settings model**
- **Found during:** Task 1 (writing llm.py)
- **Issue:** Plan specified `api_key=settings.OPENAI_API_KEY` in `get_routing_llm()`, but `OPENAI_API_KEY` was not defined in `src/core/config.py` Settings model. Using it would raise `AttributeError` at runtime.
- **Fix:** Added `OPENAI_API_KEY: str = Field(default="", ...)` to Settings model alongside the existing DEEPSEEK_API_KEY field.
- **Files modified:** `src/core/config.py`
- **Verification:** `from src.agents.llm import get_routing_llm` succeeds without AttributeError
- **Committed in:** 013a321 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 missing critical)
**Impact on plan:** Both auto-fixes necessary for task completion. ManagerCrew stub is a deliberate minimal placeholder; OPENAI_API_KEY is required configuration. No scope creep.

## Issues Encountered
- deepeval install took ~90s (background install) but completed successfully at version 3.4.6
- Windows line ending warnings (LF -> CRLF) are expected on this machine — cosmetic only

## User Setup Required
None — no external service configuration required. deepeval eval runs require live LLM API keys (OPENAI_API_KEY) but those are only needed for eval runs, not unit tests.

## Next Phase Readiness
- src/agents/ scaffold is complete and all imports verified
- BaseCrew, IntakeState, and LLM factories are ready for Plan 02 (Auth Agent rebuild)
- Test conftest.py fixtures are available for all agent test files
- deepeval installed and importable for trajectory eval development
- ManagerCrew stub satisfies import compatibility; Plans 02-07 will progressively replace old behavior

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-25*
