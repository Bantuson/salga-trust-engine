---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
verified: 2026-02-26T13:15:00Z
status: human_needed
score: 15/15 must-haves verified
re_verification:
  previous_status: gaps_found
  previous_score: 13/15
  gaps_closed:
    - "Web portal reports.py now uses IntakeFlow._classify_raw_intent() instead of ManagerCrew stub (Gap 1 BLOCKER — closed by plan 10.3-11, commit 8412b04)"
    - "_is_saps_context occurrence count — confirmed as plan over-specification, not a code defect (Gap 2 INFO — no code change needed)"
  gaps_remaining: []
  regressions: []
human_verification:
  - test: "Auth agent single-question UX"
    expected: "Auth agent asks for only one piece of information per turn (name first, then email, then address separately)"
    why_human: "UAT confirmed SINGLE_QUESTION [RECOMMENDED] fails in 5/7 auth scenarios — agent asks name + email + address in one message. All REQUIRED criteria pass; this is a UX quality decision requiring product owner input."
  - test: "Municipal Afrikaans tool-error phrasing"
    expected: "When create_municipal_ticket fails, Afrikaans response uses citizen-friendly language (not 'tegniese fout met ons stelsel')"
    why_human: "UAT flagged 'tegniese fout' as borderline leakage in Afrikaans sewage scenario. The strict no-leakage rubric passed (no tool names or internal identifiers exposed) but the phrase reveals a system failure. A product/security owner must decide whether to rephrase error fallbacks in Afrikaans."
---

# Phase 10.3: CrewAI Agent Rebuild and LLM Evaluation Framework — Re-Verification Report

**Phase Goal:** Rebuild the entire CrewAI agent system from scratch using Flow @router architecture (replacing broken Process.hierarchical). Archive existing code, rebuild each specialist agent (Auth, Municipal, TicketStatus, GBV) independently with proven end-to-end tests, then wire IntakeFlow routing. Establish LLM evaluation framework with trajectory evals (deepeval ToolCorrectnessMetric) and Claude-as-judge rubrics for regression prevention.

**Verified:** 2026-02-26T13:15:00Z
**Status:** human_needed
**Re-verification:** Yes — after gap closure (plan 10.3-11)
**Plans verified:** 11 of 11 (10.3-01-PLAN through 10.3-11-PLAN)

---

## Re-Verification Focus

This re-verification targets two gaps from the initial VERIFICATION.md (2026-02-26T12:30:00Z):

**Gap 1 (BLOCKER):** `reports.py` imported ManagerCrew stub; web portal AI classification always defaulted to `"other"`.

**Gap 2 (INFO):** `_is_saps_context` occurrence count mismatch in plan verification script (over-specification, not a code defect).

Previously-passing items were given a quick regression check (existence + basic sanity). Full three-level verification was applied to Gap 1 artifacts and key links.

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Old agent code is archived and not imported by active production modules | VERIFIED | `src/agents_old/` exists. Only active import of `manager_crew` is inside `src/agents_old/crews/__init__.py` (archived code referencing archived code). No `from src.agents_old` import in `src/`. Confirmed no regression. |
| 2 | New `src/agents/` has clean Flow-as-router architecture (no Process.hierarchical) | VERIFIED | All 4 specialist crews use `Process.sequential`. No `Process.hierarchical` in `src/agents/`. Confirmed no regression. |
| 3 | IntakeFlow uses `@router` decorator for deterministic Python routing | VERIFIED | `src/agents/flows/intake_flow.py`: `@router(classify_intent)` and `@listen("auth|municipal|ticket_status|gbv")` handlers confirmed. Confirmed no regression. |
| 4 | All 4 specialist crews (Auth, Municipal, TicketStatus, GBV) are rebuilt and functional | VERIFIED | All 4 crew files exist with full implementations. UAT 24/25 scenarios passed. Confirmed no regression. |
| 5 | GBV agent has memory=False, emergency numbers in all prompts, notify_saps tool | VERIFIED | `gbv_crew.py`: `memory_enabled = False`, `tools = [notify_saps]`. GBV prompts contain 10111 and 0800 150 150 in EN/ZU/AF. Confirmed no regression. |
| 6 | deepeval ToolCorrectnessMetric is installed and the trajectory eval harness works | VERIFIED | `from deepeval.metrics import ToolCorrectnessMetric` confirmed. `tests/evals/trajectory_evals.py` implements full harness. Confirmed no regression. |
| 7 | Eval scenarios defined for all agents (5-7 each) with metadata-only for GBV | VERIFIED | auth=7, municipal=7, ticket_status=6, gbv=5 (all GBV metadata_only=True). Confirmed no regression. |
| 8 | Claude-as-judge rubrics defined for all agents | VERIFIED | `tests/evals/judge_rubrics.py` contains `AUTH_JUDGE_RUBRIC` and `RUBRIC_MAP`. Confirmed no regression. |
| 9 | SAPS-context GBV routing heuristic closes UAT gap GBV-4 | VERIFIED | `_is_saps_context()` at line 140 of `intake_flow.py`. SEC-05 pre-classification call at line 114. All 3 regression tests confirmed passing. Confirmed no regression. |
| 10 | WhatsApp/messages endpoint and crew_server use IntakeFlow (not old ManagerCrew) | VERIFIED | `messages.py` and `crew_server.py` both import and invoke `IntakeFlow`. No ManagerCrew functional import in either file. Confirmed no regression. |
| 11 | crew_server.py serves /health, /chat, /session/reset with correct response shape | VERIFIED | `crew_app` FastAPI with 3 endpoints. `TestCrewServer` test class confirmed. Confirmed no regression. |
| 12 | Playwright+Claude-judge eval loop (Plan 09) is implemented and runnable | VERIFIED | `tests/evals/playwright_judge.py` and `tests/evals/run_playwright_eval.py` confirmed. Confirmed no regression. |
| 13 | Test suite: 277 agent tests pass, no regressions | VERIFIED | Plan 11 SUMMARY self-check confirms "Agent tests: 277 passed, 0 failed". Three new tests added in `tests/test_reports_api.py` (no regressions to existing suite). |
| 14 | Web portal reports.py uses rebuilt routing for AI auto-classification | VERIFIED | `src/api/v1/reports.py` line 18: `from src.agents.flows.intake_flow import IntakeFlow`. Line 19: `from src.agents.flows.state import IntakeState`. Line 102: `intent = flow._classify_raw_intent()`. No ManagerCrew import anywhere in the file. Commit 8412b04 confirmed real in git log. |
| 15 | manager_crew.py stub is not in the critical production call path | VERIFIED | Only import of `manager_crew` in active production code (`src/`) is inside `src/agents_old/` (archived). The `src/api/v1/reports.py` (the failing path in the initial verification) now uses IntakeFlow. References in `crew_server.py` and `whatsapp_service.py` are comments/docstrings only — confirmed by searching for `^from.*manager_crew|^import.*manager_crew` pattern. |

**Score:** 15/15 truths verified (100%)

---

## Gap Closure Verification (Plan 10.3-11)

### Gap 1 — reports.py uses IntakeFlow (was: ManagerCrew stub)

**Commits verified as real in git:**
- `8412b04` — `feat(10.3-11): replace ManagerCrew stub with IntakeFlow in reports.py`
- `b36e50a` — `test(10.3-11): update mocks from ManagerCrew to IntakeFlow, add classification tests`
- `e7472d6` — `docs(10.3-11): complete plan 11 — web portal AI classification via IntakeFlow`

**Key link verification (three levels):**

| From | To | Via | Status | Evidence |
|------|----|-----|--------|---------|
| `src/api/v1/reports.py` | `src/agents/flows/intake_flow.py` | `from src.agents.flows.intake_flow import IntakeFlow` | WIRED | Line 18 — confirmed present, no ManagerCrew import in file |
| `src/api/v1/reports.py` | `src/agents/flows/state.py` | `from src.agents.flows.state import IntakeState` | WIRED | Line 19 — confirmed present |
| `reports.py submit_report()` | `IntakeFlow._classify_raw_intent()` | `intent = flow._classify_raw_intent()` | WIRED | Line 102 — confirmed present and the result is used in `_INTENT_TO_CATEGORY.get(intent, "other")` at line 111 |
| `reports.py` | No ManagerCrew import | absence of stub | VERIFIED | Grep for `from.*manager_crew` in `src/api/` returns zero matches in `reports.py` |

**New test functions added to `tests/test_reports_api.py`:**
- `test_submit_report_with_category` — updated to mock `IntakeFlow` (not ManagerCrew), asserts `mock_flow_class.assert_not_called()` when category provided
- `test_submit_report_without_category` — mocks `IntakeFlow._classify_raw_intent` returning `"municipal"`, asserts category becomes `"other"`
- `test_submit_report_ai_classifies_gbv` — mocks `_classify_raw_intent` returning `"gbv"`, asserts category becomes `"gbv"` (SEC-05 path through web portal)
- `test_submit_report_ai_classification_fallback` — mocks `_classify_raw_intent` raising `Exception("LLM API timeout")`, asserts category becomes `"other"`

All four tests confirmed substantive (non-stub): each patches the correct target, sets mock return values, and asserts specific category outcomes.

### Gap 2 — _is_saps_context occurrence count

No code change was required. The initial verification confirmed the implementation is functionally correct: `_is_saps_context()` appears at line 114 (call) and line 140 (definition) in `intake_flow.py` — exactly 2 occurrences. All 3 regression tests pass. The plan verification script's "at least 3 times" condition was an over-specification. Status: closed with no code change needed.

---

## Regression Check (Previously Passing Items)

Quick regression check on the 13 items that passed in the initial verification:

| Item | Regression Check | Result |
|------|-----------------|--------|
| `src/agents_old/` archived | `src/agents_old/crews/__init__.py` imports from `src/agents/crews/manager_crew` (not from `src/agents_old`) — expected legacy reference inside archive | No regression |
| No `Process.hierarchical` in `src/agents/` | Grep confirms only comment references in `crew_server.py`, no functional usage | No regression |
| IntakeFlow `@router` and 4 `@listen` handlers | Confirmed in previous verification, no plan modified `intake_flow.py` in plan 11 | No regression |
| 4 specialist crews intact | Plans 01-10 not touched by plan 11. Only `reports.py` and `tests/test_reports_api.py` were modified | No regression |
| GBV memory=False, emergency numbers | Unmodified by plan 11 | No regression |
| deepeval harness | Unmodified by plan 11 | No regression |
| Eval scenarios (25 total, GBV metadata_only) | Unmodified by plan 11 | No regression |
| Judge rubrics | Unmodified by plan 11 | No regression |
| `_is_saps_context()` heuristic | Unmodified by plan 11. 3/3 regression tests still pass per plan 11 SUMMARY self-check | No regression |
| messages.py and crew_server.py use IntakeFlow | Unmodified by plan 11 | No regression |
| crew_server /health, /chat, /session/reset | Unmodified by plan 11 | No regression |
| Playwright+Claude eval loop | Unmodified by plan 11 | No regression |
| 277 agent tests pass | Plan 11 SUMMARY confirms "277 passed, 0 failed" — new tests added to `test_reports_api.py` (separate file) | No regression |

---

## Requirements Coverage

| Requirement | Description | Source Plans | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| AI-01 | CrewAI-based agentic architecture with manager agent receiving all messages | Plans 01, 10, 11 | SATISFIED | IntakeFlow is the manager (classifier + router). All messages through crew_server/WhatsApp route through IntakeFlow. Web portal reports.py now also uses IntakeFlow for intent classification. |
| AI-02 | Manager agent routes to appropriate specialist agent by category | Plans 01, 10, 11 | SATISFIED | `@router(classify_intent)` in IntakeFlow performs deterministic Python dispatch. `_is_saps_context()` heuristic handles adversarial GBV phrasing pre-LLM. Web portal now uses `_classify_raw_intent()` for single-shot classification, aligning with WhatsApp path. |
| AI-03 | Specialist agent for municipal services with report capture and ticket creation | Plans 05, 10 | SATISFIED | `MunicipalIntakeCrew` + `create_municipal_ticket` tool. UAT 7/7 municipal scenarios pass. |
| AI-04 | Specialist agent for GBV with enhanced privacy | Plans 06, 10, 11 | SATISFIED | `GBVCrew` with `memory=False`, `notify_saps` tool, SEC-05 metadata-only evals, `validate_gbv_output` guardrail. Plan 11 adds: GBV descriptions submitted via web portal without explicit `is_gbv=True` are now correctly classified `"gbv"` via `_classify_raw_intent()`, and the SAPS notification path is triggered. |
| AI-05 | Agents conduct structured conversational intake | Plans 03, 05, 06, 07 | SATISFIED | All 4 specialist crews use multi-turn conversation via history injection. max_iter values set per agent. |
| AI-06 | Agents support English, isiZulu, Afrikaans | Plans 01, 03, 05, 06, 07 | SATISFIED | `language_detector.detect()` in IntakeFlow. All agent prompts in EN/ZU/AF. Language passed to each specialist crew. |
| AI-07 | Agent interactions have guardrails preventing inappropriate responses or data leakage | Plans 01, 03, 05, 06, 07 | SATISFIED | `validate_structured_output` on all crews. `validate_gbv_output` on GBVCrew. `sanitize_reply()` in crew_server. SEC-05 metadata-only GBV eval reports. REQUIREMENTS.md: all 7 AI requirements checked `[x]`. |

**All 7 requirements satisfied. No orphaned requirements.**

---

## Anti-Patterns — Updated Status

| File | Pattern | Severity | Status |
|------|---------|----------|--------|
| `src/agents/crews/manager_crew.py` | Non-functional stub with `kickoff()` returning error dict | RESOLVED | Stub still exists as a file but is no longer imported by any active production module. `src/api/v1/reports.py` now uses IntakeFlow. `src/agents_old/crews/__init__.py` references it but is archived code. |
| `src/api/v1/crew_server.py` line 25 | Docstring says "All messages route through ManagerCrew" — stale comment | INFO | Unchanged — comment-only, no functional impact. Acceptable documentation debt. |
| `src/services/whatsapp_service.py` lines 157, 269, 277, 401, 406, 411 | Comments referencing "ManagerCrew" | INFO | All are comments/log strings only. No functional ManagerCrew import in this file. Acceptable documentation debt. |
| `tests/evals/run_evals.py` | `NotImplementedError` on live eval runs without --dry-run | INFO | Intentional design. Documented. Dry-run works. |

No active BLOCKER anti-patterns remain.

---

## Human Verification Required

### 1. Auth Agent Single-Question UX

**Test:** Register a new citizen via WhatsApp (send "Hi, I want to report a pothole" as a new user). Observe how many pieces of information Gugu requests in the first message.

**Expected:** Gugu asks for only one piece of information (e.g., "What's your full name?" — not "What's your name, email, and address?")

**Why human:** UAT confirmed SINGLE_QUESTION [RECOMMENDED] fails in 5/7 auth scenarios. The agent asks for name + email + address in one turn. All REQUIRED criteria pass; this is a UX quality decision requiring product owner input on whether to split registration into more turns. Not a blocker for phase completion.

### 2. Municipal Afrikaans Tool-Error Phrasing

**Test:** Submit an Afrikaans municipal report where the ticket creation tool fails (e.g., use an invalid user_id). Observe the error fallback message.

**Expected:** Error message is citizen-friendly in Afrikaans (e.g., "Ons het 'n probleem gehad" — not containing "tegniese", "stelsel", or other internal terminology).

**Why human:** UAT flagged "tegniese fout met ons stelsel" in one Afrikaans scenario as borderline leakage. The strict no-leakage rubric (checking for tool names/internal identifiers) passed, but the phrase reveals a system failure mode. A product/security owner should decide whether this constitutes acceptable citizen-facing language. Not a blocker for phase completion.

---

## UAT Results Summary (unchanged from initial verification)

The phase went through a full Playwright+Claude-judge UAT covering 25 scenarios across all 4 agents:

| Agent | Scenarios | Passed | Pass Rate | REQUIRED Criteria |
|-------|-----------|--------|-----------|------------------|
| Auth | 7 | 7 | 100% | 100% (28/28) |
| Municipal | 7 | 7 | 100% | 100% (35/35) |
| Ticket Status | 6 | 6 | 100% | 100% (30/30) |
| GBV (SEC-05) | 5 | 4 | 80% | 97% (34/35) |
| **TOTAL** | **25** | **24** | **96%** | **99.2%** (127/128) |

The 1 failing GBV scenario (adversarial SAPS-phrased message misrouting to ticket_status) was resolved by Plan 10 (`_is_saps_context()` heuristic). GBV-4 closure confirmed by 3/3 regression tests passing.

---

## Summary

**All 15 must-haves now verified (15/15). Gap 1 (BLOCKER) is closed.**

Plan 10.3-11 correctly replaced the ManagerCrew stub with IntakeFlow single-shot classification in `src/api/v1/reports.py`. The fix is substantive (real import, real state wiring, real `_classify_raw_intent()` call, intent-to-category mapping, error fallback). Four new tests in `tests/test_reports_api.py` cover the classification paths including GBV detection and LLM failure fallback. Three git commits confirmed real. No regressions detected against the 277-test agent suite.

Gap 2 (INFO) required no code change and remains a documentation note: the implementation is correct and all regression tests pass.

Two items flagged for human verification (Auth UX quality and Afrikaans error phrasing) are RECOMMENDED criteria that do not block phase completion. All REQUIRED criteria passed in UAT.

**Phase 10.3 goal is achieved.**

---

_Verified: 2026-02-26T13:15:00Z_
_Verifier: Claude (gsd-verifier)_
_Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework_
_Re-verification: Yes — after gap closure (plan 10.3-11)_
