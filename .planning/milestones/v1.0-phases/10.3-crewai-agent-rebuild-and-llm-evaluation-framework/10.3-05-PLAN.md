---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 05
type: execute
wave: 3
depends_on: ["10.3-03"]
files_modified:
  - src/agents/tools/ticket_tool.py
  - src/agents/tools/ticket_lookup_tool.py
  - src/agents/prompts/municipal.py
  - src/agents/prompts/ticket_status.py
  - src/agents/crews/municipal_crew.py
  - src/agents/crews/ticket_status_crew.py
  - src/agents/config/agents.yaml
  - src/agents/config/tasks.yaml
  - tests/agents/test_municipal_crew.py
  - tests/agents/test_ticket_status_crew.py
autonomous: true
requirements:
  - AI-02
  - AI-03
  - AI-05

must_haves:
  truths:
    - "Municipal intake agent collects issue description, location, and category before creating a ticket"
    - "Ticket status agent looks up tickets by tracking number and reports status"
    - "Both agents respond as Gugu in the detected language"
    - "Municipal crew uses create_municipal_ticket tool"
    - "Ticket status crew uses lookup_ticket tool"
    - "Both agents use sequential Process with memory=False"
    - "Unit tests verify structure, prompts, and Pydantic models for both agents"
  artifacts:
    - path: "src/agents/crews/municipal_crew.py"
      provides: "MunicipalIntakeCrew — sequential crew for municipal service reports"
      contains: "class MunicipalIntakeCrew"
    - path: "src/agents/crews/ticket_status_crew.py"
      provides: "TicketStatusCrew — sequential crew for ticket status lookups"
      contains: "class TicketStatusCrew"
    - path: "src/agents/tools/ticket_tool.py"
      provides: "create_municipal_ticket tool"
      exports: ["create_municipal_ticket"]
    - path: "src/agents/tools/ticket_lookup_tool.py"
      provides: "lookup_ticket tool"
      exports: ["lookup_ticket_tool"]
    - path: "tests/agents/test_municipal_crew.py"
      provides: "Unit tests for MunicipalIntakeCrew"
    - path: "tests/agents/test_ticket_status_crew.py"
      provides: "Unit tests for TicketStatusCrew"
  key_links:
    - from: "src/agents/crews/municipal_crew.py"
      to: "src/agents/tools/ticket_tool.py"
      via: "tools parameter on Agent"
      pattern: "tools=\\[create_municipal_ticket"
    - from: "src/agents/crews/ticket_status_crew.py"
      to: "src/agents/tools/ticket_lookup_tool.py"
      via: "tools parameter on Agent"
      pattern: "tools=\\[lookup_ticket_tool"
---

<objective>
Rebuild Municipal Intake and Ticket Status agents with their tools, prompts, and unit tests.

Purpose: These two agents are rebuilt together because they share similar patterns (single tool at the end of conversation) and can be developed in parallel. Municipal collects issue details then creates a ticket. Ticket Status looks up a tracking number and reports back. Both are independent sequential crews — no delegation, no hierarchical process. Per research: these can use gpt-4o-mini (preferred) for tool reliability, or DeepSeek for conversation-heavy municipal intake.

Output: Two fully tested specialist crews, both passing unit tests

Eval gate note: The per-agent "completion gate" for this plan is unit tests verifying structural correctness (agent instantiation, tool attachment, prompt content, Pydantic models). Trajectory evals (tool-call-sequence verification against live LLM) are run manually via `python -m tests.evals.run_evals --agent municipal` / `--agent ticket_status` after Plan 08 integrates the eval runner. The Playwright+Claude-judge eval loop is implemented in Plan 09.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-RESEARCH.md
@.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild Municipal Intake and Ticket Status agents</name>
  <files>
    src/agents/tools/ticket_tool.py
    src/agents/tools/ticket_lookup_tool.py
    src/agents/prompts/municipal.py
    src/agents/prompts/ticket_status.py
    src/agents/crews/municipal_crew.py
    src/agents/crews/ticket_status_crew.py
    src/agents/config/agents.yaml
    src/agents/config/tasks.yaml
  </files>
  <action>
    **Municipal Intake Agent:**

    1. `src/agents/tools/ticket_tool.py` — Copy from agents_old/tools/ticket_tool.py:
       - create_municipal_ticket tool that creates a Ticket via Supabase
       - Keep the _create_ticket_impl function separate from @tool decorator
       - Returns dict with tracking_number on success, error message on failure
       - Uses PostGIS location via from_shape(Point(lng, lat), srid=4326) with USE_POSTGIS guard

    2. `src/agents/prompts/municipal.py` — Rebuild municipal prompts:
       - MUNICIPAL_PROMPTS dict: {"en": ..., "zu": ..., "af": ...} with Gugu persona
       - Gugu identity at top (same CRITICAL IDENTITY pattern as auth)
       - Instructions: collect issue description, location (address or area), category
       - Categories: water, roads, electricity, waste, sanitation, other
       - Once all info collected, use create_municipal_ticket tool
       - MunicipalResponse Pydantic model:
         ```python
         class MunicipalResponse(BaseModel):
             message: str
             action_taken: str = "none"  # "ticket_created" | "collecting_info" | "none"
             tracking_number: str = ""
             language: str = "en"
         ```
       - build_municipal_task_description(context) helper

    3. `src/agents/crews/municipal_crew.py`:
       - Extends BaseCrew
       - `__init__(self, language="en", llm=None)`: uses `llm or get_routing_llm()` (gpt-4o-mini preferred per research for tool reliability)
       - tools=[create_municipal_ticket]
       - Process.sequential, memory=False, allow_delegation=False
       - max_iter=10
       - output_pydantic=MunicipalResponse

    **Ticket Status Agent:**

    4. `src/agents/tools/ticket_lookup_tool.py` — Copy from agents_old/tools/ticket_lookup_tool.py:
       - lookup_ticket_tool that queries Supabase for ticket by tracking_number
       - Asserts user_id is truthy (defense-in-depth since admin client bypasses RLS)
       - Returns formatted ticket status string

    5. `src/agents/prompts/ticket_status.py` — New prompts:
       - TICKET_STATUS_PROMPTS dict: {"en": ..., "zu": ..., "af": ...} with Gugu persona
       - Instructions: ask for tracking number if not provided, look up ticket, report status clearly
       - TicketStatusResponse Pydantic model:
         ```python
         class TicketStatusResponse(BaseModel):
             message: str
             tickets_found: int = 0
             language: str = "en"
         ```
       - build_ticket_status_task_description(context) helper

    6. `src/agents/crews/ticket_status_crew.py`:
       - Extends BaseCrew
       - Uses `get_routing_llm()` (gpt-4o-mini for lookup_ticket tool use)
       - tools=[lookup_ticket_tool]
       - Process.sequential, memory=False, allow_delegation=False
       - max_iter=8
       - output_pydantic=TicketStatusResponse

    7. Update `src/agents/config/agents.yaml` — Add municipal and ticket_status entries
    8. Update `src/agents/config/tasks.yaml` — Add municipal and ticket_status entries
  </action>
  <verify>
    <automated>python -c "from src.agents.crews.municipal_crew import MunicipalIntakeCrew; from src.agents.crews.ticket_status_crew import TicketStatusCrew; from src.agents.tools.ticket_tool import create_municipal_ticket; from src.agents.tools.ticket_lookup_tool import lookup_ticket_tool; print('Municipal + TicketStatus imports OK')"</automated>
  </verify>
  <done>MunicipalIntakeCrew and TicketStatusCrew rebuilt with tools, trilingual Gugu prompts, Pydantic output models. Both use sequential process, memory=False, gpt-4o-mini. All imports succeed.</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for Municipal and Ticket Status agents</name>
  <files>
    tests/agents/test_municipal_crew.py
    tests/agents/test_ticket_status_crew.py
  </files>
  <action>
    **Municipal tests (tests/agents/test_municipal_crew.py):**
    - `test_municipal_crew_instantiates` — MunicipalIntakeCrew() creates without error
    - `test_municipal_crew_has_ticket_tool` — Agent has create_municipal_ticket in tools
    - `test_municipal_crew_sequential_process` — Process.sequential
    - `test_municipal_crew_memory_disabled` — memory=False
    - `test_municipal_crew_no_delegation` — allow_delegation=False
    - `test_municipal_prompts_all_languages` — MUNICIPAL_PROMPTS has "en", "zu", "af"
    - `test_municipal_prompts_contain_gugu` — Each prompt contains "Gugu"
    - `test_municipal_prompts_list_categories` — Prompts mention water, roads, electricity, waste, sanitation
    - `test_municipal_response_model` — MunicipalResponse validates with defaults
    - `test_municipal_response_custom` — MunicipalResponse(action_taken="ticket_created", tracking_number="TKT-xxx")
    - `test_build_municipal_task_description` — Returns string containing context values

    **Ticket Status tests (tests/agents/test_ticket_status_crew.py):**
    - `test_ticket_status_crew_instantiates`
    - `test_ticket_status_crew_has_lookup_tool` — Agent has lookup_ticket_tool
    - `test_ticket_status_crew_sequential_process`
    - `test_ticket_status_crew_memory_disabled`
    - `test_ticket_status_crew_no_delegation`
    - `test_ticket_status_prompts_all_languages`
    - `test_ticket_status_prompts_contain_gugu`
    - `test_ticket_status_response_model`
    - `test_lookup_ticket_tool_importable` — Has .name and .run attributes

    **Mock pattern:** Same as auth tests — patch get_routing_llm, use conftest fixtures. No real LLM or Supabase calls.
  </action>
  <verify>
    <automated>pytest tests/agents/test_municipal_crew.py tests/agents/test_ticket_status_crew.py -x --no-header -q</automated>
  </verify>
  <done>20+ unit tests across both agents covering structure, prompts, Pydantic models, and tool importability. All tests pass.</done>
</task>

</tasks>

<verification>
- `pytest tests/agents/test_municipal_crew.py -x -q` — all pass
- `pytest tests/agents/test_ticket_status_crew.py -x -q` — all pass
- `pytest tests/agents/ -x -q` — full agent test suite still green (includes auth tests from Plan 04)
</verification>

<success_criteria>
- MunicipalIntakeCrew and TicketStatusCrew both instantiate and create valid Crews
- Both use sequential process, memory=False, gpt-4o-mini
- Municipal agent has create_municipal_ticket tool; Ticket Status has lookup_ticket_tool
- Trilingual Gugu prompts for both agents
- Pydantic output models (MunicipalResponse, TicketStatusResponse) validate correctly
- 20+ unit tests passing
- Full tests/agents/ suite still green
</success_criteria>

<output>
After completion, create `.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-05-SUMMARY.md`
</output>
