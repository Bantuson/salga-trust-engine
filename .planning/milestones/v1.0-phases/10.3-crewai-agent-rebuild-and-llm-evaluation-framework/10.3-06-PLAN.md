---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 06
type: execute
wave: 3
depends_on: ["10.3-03"]
files_modified:
  - src/agents/tools/saps_tool.py
  - src/agents/prompts/gbv.py
  - src/agents/crews/gbv_crew.py
  - src/agents/config/agents.yaml
  - src/agents/config/tasks.yaml
  - tests/agents/test_gbv_crew.py
autonomous: true
requirements:
  - AI-04
  - AI-05
  - AI-07

must_haves:
  truths:
    - "GBV agent uses trauma-informed conversational approach"
    - "GBV agent includes emergency numbers (10111, 0800 150 150) in every response"
    - "GBV agent has memory=False (PII protection — no cross-session data leakage)"
    - "GBV agent uses DeepSeek (conversation-heavy, minimal tool use per research)"
    - "GBV agent uses notify_saps tool at end of intake"
    - "GBV eval reports contain metadata only — never conversation content"
    - "Unit tests verify SEC-05 boundaries: no PII in logs, emergency numbers in prompts"
  artifacts:
    - path: "src/agents/crews/gbv_crew.py"
      provides: "GBVCrew — sequential crew for GBV/abuse reporting"
      contains: "class GBVCrew"
    - path: "src/agents/tools/saps_tool.py"
      provides: "notify_saps tool for SAPS notification"
      exports: ["notify_saps"]
    - path: "src/agents/prompts/gbv.py"
      provides: "GBV prompts with trauma-informed Gugu persona and emergency numbers"
      contains: "GBV_PROMPTS"
    - path: "tests/agents/test_gbv_crew.py"
      provides: "Unit tests for GBVCrew including SEC-05 boundary checks"
      contains: "class TestGBVCrew"
  key_links:
    - from: "src/agents/crews/gbv_crew.py"
      to: "src/agents/tools/saps_tool.py"
      via: "tools parameter on Agent"
      pattern: "tools=\\[notify_saps"
    - from: "src/agents/prompts/gbv.py"
      to: "emergency numbers"
      via: "prompt content"
      pattern: "10111|0800 150 150"
---

<objective>
Rebuild the GBV Agent with trauma-informed prompts, SAPS notification tool, and comprehensive SEC-05 boundary tests.

Purpose: GBV is the most sensitive agent — it handles domestic violence, abuse, and assault reports. It must maintain strict privacy (memory=False, no PII in logs, metadata-only eval reports), include emergency numbers in every response, and notify SAPS (South African Police Service) at the end of intake. This agent uses DeepSeek because it is conversation-heavy with minimal tool use (single notify_saps at end) per research recommendation.

Output: GBVCrew with trauma-informed prompts, SAPS tool, and SEC-05 boundary tests

Eval gate note: The per-agent "completion gate" for this plan is unit tests verifying structural correctness, SEC-05 boundaries, and trauma-informed prompts. Trajectory evals (tool-call-sequence verification against live LLM) are run manually via `python -m tests.evals.run_evals --agent gbv` after Plan 08 integrates the eval runner. The Playwright+Claude-judge eval loop is implemented in Plan 09.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-RESEARCH.md
@.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild GBV Agent — tool, prompts, crew</name>
  <files>
    src/agents/tools/saps_tool.py
    src/agents/prompts/gbv.py
    src/agents/crews/gbv_crew.py
    src/agents/config/agents.yaml
    src/agents/config/tasks.yaml
  </files>
  <action>
    1. `src/agents/tools/saps_tool.py` — Copy from agents_old/tools/saps_tool.py:
       - notify_saps tool that logs SAPS notification (internal log in v1, no real SAPS API)
       - NO PII in SAPS logs: only ticket_id, incident_type, general_location, danger_level
       - Tool wrapper pattern: _notify_saps_impl separate from @tool decorator
       - Returns confirmation string for LLM consumption

    2. `src/agents/prompts/gbv.py` — Rebuild GBV prompts from agents_old reference:
       - GBV_PROMPTS dict: {"en": ..., "zu": ..., "af": ...}
       - Gugu IDENTITY section at top (shorter for GBV — no chatty intro per locked decision Phase 06.8-01)
       - GBV agent gets Gugu identity (name + SALGA Trust Engine) ONLY — no name-asking, preserves trauma-informed protocol
       - EMERGENCY NUMBERS MUST appear in every prompt: 10111 (SAPS), 0800 150 150 (GBV Helpline)
       - Trauma-informed approach: patient, no judgment, let victim speak, do not rush
       - max_iter=8 (lower than auth to avoid over-questioning trauma victims)
       - Collect: incident type, general location (not exact address for safety), danger level, any immediate needs
       - At end: use notify_saps tool
       - GBVResponse Pydantic model:
         ```python
         class GBVResponse(BaseModel):
             message: str
             requires_followup: bool = True  # GBV always requires follow-up by design
             emergency_numbers_present: bool = True
             language: str = "en"
         ```
       - build_gbv_task_description(context) helper
       - Append response guardrail constants (_GBV_RESPONSE_RULES_EN/ZU/AF) per existing pattern

    3. `src/agents/crews/gbv_crew.py`:
       - Extends BaseCrew
       - `__init__(self, language="en", llm=None)`: uses `llm or get_deepseek_llm()` (DeepSeek for GBV — conversation-heavy, minimal tool use per research)
       - tools=[notify_saps]
       - Process.sequential, memory=False (CRITICAL — PII protection), allow_delegation=False
       - max_iter=8 (per locked decision)
       - verbose=False
       - output_pydantic=GBVResponse

    4. Update agents.yaml and tasks.yaml with gbv_agent and gbv_task entries
  </action>
  <verify>
    <automated>python -c "from src.agents.crews.gbv_crew import GBVCrew; from src.agents.tools.saps_tool import notify_saps; from src.agents.prompts.gbv import GBV_PROMPTS, GBVResponse; assert 'en' in GBV_PROMPTS and 'zu' in GBV_PROMPTS and 'af' in GBV_PROMPTS; assert '10111' in GBV_PROMPTS['en'] and '0800 150 150' in GBV_PROMPTS['en']; print('GBV agent imports and emergency numbers OK')"</automated>
  </verify>
  <done>GBVCrew rebuilt with DeepSeek LLM, notify_saps tool, trauma-informed trilingual prompts, emergency numbers in all prompts. memory=False for PII protection. GBVResponse with requires_followup=True default.</done>
</task>

<task type="auto">
  <name>Task 2: GBV agent unit tests with SEC-05 boundary checks</name>
  <files>
    tests/agents/test_gbv_crew.py
  </files>
  <action>
    Create comprehensive unit tests for GBVCrew with special emphasis on SEC-05 security boundaries.

    **Section 1: Agent Structure Tests**
    - `test_gbv_crew_instantiates`
    - `test_gbv_crew_uses_deepseek_llm` — Verify GBVCrew uses get_deepseek_llm (not routing/gpt-4o-mini)
    - `test_gbv_crew_has_saps_tool` — Agent has notify_saps in tools
    - `test_gbv_crew_sequential_process`
    - `test_gbv_crew_memory_disabled` — CRITICAL: memory=False
    - `test_gbv_crew_no_delegation`
    - `test_gbv_crew_max_iter_8` — max_iter=8 (not 10 or 15)

    **Section 2: Prompt Tests (SEC-05 Focus)**
    - `test_gbv_prompts_all_languages`
    - `test_gbv_prompts_contain_gugu_identity` — Each prompt has Gugu identity (but NOT chatty intro)
    - `test_gbv_prompts_no_name_asking` — GBV prompts do NOT ask for citizen name (trauma protocol)
    - `test_gbv_prompts_emergency_numbers_en` — EN prompt contains "10111" and "0800 150 150"
    - `test_gbv_prompts_emergency_numbers_zu` — ZU prompt contains emergency numbers
    - `test_gbv_prompts_emergency_numbers_af` — AF prompt contains emergency numbers
    - `test_gbv_prompts_trauma_informed` — Prompts contain patient/non-judgmental language
    - `test_gbv_prompts_no_pii_instruction` — Prompts instruct NOT to log PII

    **Section 3: Pydantic Model Tests**
    - `test_gbv_response_defaults` — requires_followup=True, emergency_numbers_present=True
    - `test_gbv_response_strips_final_answer`

    **Section 4: SEC-05 Boundary Tests**
    - `test_gbv_debug_metadata_only` — Verify debug dict for GBV never contains conversation content (only agent_name, turn_count, session_status, is_gbv)
    - `test_gbv_saps_tool_no_pii` — Verify notify_saps tool description says no PII (test the tool's docstring/description)

    **Mock pattern:** Patch get_deepseek_llm to return mock_llm.
  </action>
  <verify>
    <automated>pytest tests/agents/test_gbv_crew.py -x --no-header -q</automated>
  </verify>
  <done>15+ unit tests for GBVCrew covering structure, trauma-informed prompts, emergency numbers in all 3 languages, SEC-05 boundaries (memory=False, no PII, metadata-only debug), and Pydantic model. All tests pass.</done>
</task>

</tasks>

<verification>
- `pytest tests/agents/test_gbv_crew.py -x -q` — all pass
- `pytest tests/agents/ -x -q` — full suite (auth + crew_server + municipal + ticket_status + gbv) green
- Emergency numbers verified in all 3 language prompts
- memory=False verified programmatically
</verification>

<success_criteria>
- GBVCrew uses DeepSeek (not gpt-4o-mini) per research recommendation
- memory=False enforced (PII protection)
- max_iter=8 (lower than other agents for trauma sensitivity)
- Emergency numbers (10111, 0800 150 150) present in all 3 language prompts
- Trauma-informed approach verified in prompt content
- GBV debug output contains metadata only
- 15+ tests passing including SEC-05 boundary checks
</success_criteria>

<output>
After completion, create `.planning/phases/10.3-crewai-agent-rebuild-and-llm-evaluation-framework/10.3-06-SUMMARY.md`
</output>
