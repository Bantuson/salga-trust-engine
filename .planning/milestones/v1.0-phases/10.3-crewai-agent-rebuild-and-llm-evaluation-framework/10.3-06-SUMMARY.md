---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: "06"
subsystem: agents
tags: [crewai, gbv, trauma-informed, sec-05, saps-tool, popia, unit-tests, deepseek]
dependency_graph:
  requires: ["10.3-03"]
  provides: ["GBVCrew", "notify_saps", "GBV_PROMPTS", "GBVResponse", "test_gbv_crew"]
  affects: ["src/agents/crews/gbv_crew.py", "src/agents/tools/saps_tool.py", "src/agents/prompts/gbv.py"]
tech_stack:
  added: []
  patterns:
    - "GBVCrew extends BaseCrew with DeepSeek LLM (conversation-heavy, minimal tool use)"
    - "memory=False enforced at class level AND Crew() constructor (SEC-05 defense-in-depth)"
    - "notify_saps BaseTool with Pydantic input schema — no PII fields in schema"
    - "GBV_PROMPTS dict pattern (same as AUTH_PROMPTS) with trauma-informed Gugu identity"
    - "validate_gbv_output guardrail enforces emergency numbers in every agent response"
    - "GBVResponse.requires_followup=True default (GBV always requires follow-up by design)"
    - "SEC-05 boundary tests verify static (class) AND dynamic (Crew instance) memory=False"
key_files:
  created:
    - src/agents/tools/saps_tool.py
    - src/agents/prompts/gbv.py
    - src/agents/crews/gbv_crew.py
    - tests/agents/test_gbv_crew.py
  modified:
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml
decisions:
  - "GBV agent uses get_deepseek_llm() — conversation-heavy with single notify_saps at end (per research)"
  - "memory=False enforced both at GBVCrew.memory_enabled class attribute AND crew constructor"
  - "max_iter=8 (Phase 02-03 locked) — lower than auth (15) to avoid over-questioning victims"
  - "GBV_PROMPTS backstory injected from Python module (not YAML) — same pattern as AUTH_PROMPTS"
  - "GBVResponse.requires_followup=True is a locked default (GBV always requires follow-up)"
  - "notify_saps tool description explicitly prohibits PII per SEC-05"
  - "Test file in tests/agents/ (new Phase 10.3 location) separate from legacy tests/test_gbv_crew.py"
metrics:
  duration: "19 minutes"
  completed: "2026-02-25"
  tasks: 2
  files: 6
---

# Phase 10.3 Plan 06: GBV Agent Rebuild Summary

GBV agent rebuilt with trauma-informed Gugu identity, SAPS notification tool (no PII in logs), and 58 SEC-05 boundary tests verifying memory=False, emergency numbers in all 3 languages, and no PII collection.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Rebuild GBV Agent — tool, prompts, crew | 7a21f90 | saps_tool.py, gbv.py, gbv_crew.py, agents.yaml, tasks.yaml |
| 2 | GBV agent unit tests with SEC-05 boundary checks | 596cb7b | tests/agents/test_gbv_crew.py |

## What Was Built

### Task 1: GBV Agent Files

**`src/agents/tools/saps_tool.py`**
- `_notify_saps_impl()`: Implementation function (testable separately from tool decorator)
- `NotifySapsInput`: Pydantic schema with NO PII fields — only ticket_id, incident_type, general location, danger_level, tenant_id
- `NotifySapsTool`: BaseTool wrapper with description explicitly prohibiting victim PII
- `notify_saps`: Shared singleton tool instance
- Dedicated `saps_logger` at WARNING level — always captured in production
- No PII in logs: victim_name, phone, full_address are NOT logged (SEC-05, POPIA)

**`src/agents/prompts/gbv.py`**
- `GBV_PROMPTS`: Trauma-informed Gugu identity in EN/ZU/AF — shorter than auth prompts by design
  - Gugu identity only (no chatty intro, no name-asking) per Phase 06.8-01 locked decision
  - Emergency numbers 10111 and 0800 150 150 in ALL language variants
  - Collects ONLY: incident type, general location area, danger level, immediate needs
  - Explicitly instructs NOT to ask for: victim name, exact address, perpetrator identity
- `_GBV_RESPONSE_RULES_EN/ZU/AF`: Guardrail constants prohibiting step narration and PII requests
- `GBVResponse`: Pydantic model with `requires_followup=True` and `emergency_numbers_present=True` defaults
- `build_gbv_task_description()`: Per-request task description builder
- `GBV_TASK_TEMPLATE` + `_GBV_INTAKE_INSTRUCTION`: Task template with emergency numbers in expected output

**`src/agents/crews/gbv_crew.py`**
- `GBVCrew(BaseCrew)`:
  - `__init__`: Uses `get_deepseek_llm()` (conversation-heavy, minimal tool use per research)
  - `tools = [notify_saps]` — exactly 1 tool
  - `memory_enabled = False` at class level (SEC-05)
  - `create_crew()`: max_iter=8, memory=False, Process.sequential, validate_gbv_output guardrail
  - `parse_result()`: Forces `category='gbv'` on all outputs (safety guarantee)
  - `get_error_response()`: Always includes 10111 and 0800 150 150 in error messages

**YAML Updates**
- `agents.yaml`: `gbv_agent` entry (role, goal, max_iter=8, allow_delegation=false)
- `tasks.yaml`: `gbv_intake_task` entry with expected_output referencing emergency numbers

### Task 2: Unit Tests (58 tests)

**`tests/agents/test_gbv_crew.py`** — 5 test sections:

**Section 1: Agent Structure (12 tests)**
- Instantiation with all languages + invalid language fallback
- DeepSeek LLM usage (not routing LLM)
- exactly 1 tool (notify_saps)
- memory_enabled=False at class level
- agent_key, task_key attributes
- Sequential process, memory=False in Crew, no delegation
- max_iter=8 (not 10 or 15)
- Single agent + single task (Phase 10.3 pattern)

**Section 2: Prompt Tests with SEC-05 Focus (14 tests)**
- All 3 languages present
- Gugu identity in all prompts
- NO name-asking (trauma protocol — locked decision)
- Emergency numbers 10111 in EN, ZU, AF
- Emergency numbers 0800 150 150 in EN, ZU, AF
- Trauma-informed language (patient, calm, empathetic, etc.)
- No exact address collection instruction
- PII restriction language present
- Response rules in all 3 languages
- notify_saps instruction in English prompt
- Prompts have substantial content (>200 chars each)
- build_gbv_task_description() tests (language, history, invalid language fallback)

**Section 3: Pydantic Model Tests (8 tests)**
- `requires_followup=True` default (LOCKED)
- `emergency_numbers_present=True` default
- `action_taken='safety_check'` default
- `language='en'` default
- Final Answer stripping (two variants)
- Custom fields accepted
- model_dump() completeness

**Section 4: SEC-05 Boundary Tests (10 tests)**
- memory_enabled=False at CLASS LEVEL (static check)
- Debug output is metadata-only (category, raw_output separated from message)
- notify_saps description prohibits PII
- notify_saps input schema has no PII fields
- `_notify_saps_impl` parameter list has no PII params
- Error response ALWAYS includes 10111 and 0800 150 150
- Error response has requires_followup=True
- Error response forces category='gbv'
- parse_result() forces category='gbv'
- parse_result() fallback sets requires_followup=True

**Section 5: SAPS Tool Functional Tests (9 tests)**
- IMMEDIATE vs STANDARD danger levels
- Timestamp included in result
- No victim PII in logger.warning() calls (mock test)
- BaseTool instance check
- .name attribute
- .description attribute
- .args_schema attribute

## Deviations from Plan

None — plan executed exactly as written.

## Verification Results

```
pytest tests/agents/test_gbv_crew.py -x -q
58 passed in 74.05s

pytest tests/agents/ -x -q
220 passed in 82.62s (auth + gbv + municipal + ticket_status + crew_server)
```

All success criteria met:
- GBVCrew uses DeepSeek (not gpt-4o-mini)
- memory=False enforced at class AND instance level
- max_iter=8 (trauma-sensitive limit)
- Emergency numbers (10111, 0800 150 150) in all 3 language prompts
- Trauma-informed approach verified in prompt content
- GBV error response always includes emergency numbers (safety guarantee)
- 58 tests passing including SEC-05 boundary checks

## Self-Check

All files verified:
- `src/agents/tools/saps_tool.py` — exists, imports OK
- `src/agents/prompts/gbv.py` — exists, emergency numbers verified in all 3 languages
- `src/agents/crews/gbv_crew.py` — exists, memory=False verified programmatically
- `tests/agents/test_gbv_crew.py` — exists, 58 tests pass

Commits verified:
- 7a21f90: feat(10.3-06): rebuild GBV agent
- 596cb7b: test(10.3-06): add GBV crew unit tests
