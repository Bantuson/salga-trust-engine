---
phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
plan: 10
subsystem: agents
tags: [crewai, gbv, routing, sec-05, intake-flow, heuristic, regression-tests]

# Dependency graph
requires:
  - phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework
    provides: IntakeFlow._classify_raw_intent() with LLM-based routing
provides:
  - _is_saps_context() deterministic heuristic short-circuiting LLM classification for SAPS-context GBV messages
  - Regression test suite guarding SAPS-context GBV routing (3 tests)
affects: [crew_server, gbv_crew, ticket_status_crew, intake_flow]

# Tech tracking
tech-stack:
  added: []
  patterns: [Deterministic pre-classification heuristic before LLM call, SEC-05 defense-in-depth pattern]

key-files:
  created:
    - tests/agents/test_intake_flow_gbv_routing.py
  modified:
    - src/agents/flows/intake_flow.py

key-decisions:
  - "Heuristic requires BOTH SAPS/officer term AND personal-case ownership term to prevent false positives on generic SAPS mentions"
  - "Heuristic short-circuits before LLM import (not just before LLM call) — confirmed by mock_get_llm.assert_not_called() in tests"
  - "Patch target for no-LLM-call test is src.agents.llm.get_routing_llm (source module), not src.agents.flows.intake_flow.get_routing_llm (lazy import, doesn't exist at module level)"

patterns-established:
  - "SEC-05 defense layer: deterministic heuristics run before LLM for safety-critical routing decisions"
  - "Pre-classification heuristic pattern: _is_saps_context() called at very top of _classify_raw_intent() before any import"

requirements-completed: [AI-03, AI-04]

# Metrics
duration: 16min
completed: 2026-02-26
---

# Phase 10.3 Plan 10: SAPS-Context GBV Routing Heuristic Summary

**Deterministic _is_saps_context() heuristic in IntakeFlow prevents GBV misrouting when citizens use police/SAPS terminology to describe their personal abuse case (closes UAT gap GBV-4)**

## Performance

- **Duration:** 16 min
- **Started:** 2026-02-26T09:53:20Z
- **Completed:** 2026-02-26T10:09:51Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added `_is_saps_context()` private helper to `IntakeFlow` that detects when a citizen describes a GBV case using police/SAPS officer terminology (e.g., "SAPS officers assigned to my case")
- Inserted SEC-05 pre-classification call at the top of `_classify_raw_intent()` so adversarial SAPS-phrased GBV messages route to `gbv` without any LLM call
- Created 3 regression tests: SAPS-context → gbv (LLM not called), standard ticket_status unaffected, generic SAPS mentions return False
- 277 total agent tests pass after the fix — no regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: Add _is_saps_context heuristic to intake_flow.py** - `ee32ebb` (fix)
2. **Task 2: Write regression tests for SAPS-context routing** - `35b6013` (test)

**Plan metadata:** (docs commit below)

## Files Created/Modified

- `src/agents/flows/intake_flow.py` - Added `_is_saps_context()` helper + SEC-05 pre-classification call at top of `_classify_raw_intent()`
- `tests/agents/test_intake_flow_gbv_routing.py` - 3 regression tests for GBV routing via SAPS-context heuristic

## Decisions Made

- Heuristic requires BOTH a SAPS/officer term (from a list of 8 terms) AND a personal-case ownership term (from a list of 8 terms) — AND logic prevents false positives on messages like "report this to SAPS" or "sergeant at local station"
- The heuristic short-circuits before the `from src.agents.llm import get_routing_llm` import line — this means patching `src.agents.flows.intake_flow.get_routing_llm` would fail (lazy import not yet bound to module), so tests correctly patch `src.agents.llm.get_routing_llm` at source

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed incorrect mock patch target in test_saps_context_routes_to_gbv**

- **Found during:** Task 2 (regression test verification)
- **Issue:** Plan specified patching `src.agents.flows.intake_flow.get_routing_llm` to confirm no LLM call, but `get_routing_llm` is lazily imported inside `_classify_raw_intent()` body. When the heuristic short-circuits, that import never executes, so the attribute never exists on the module — `AttributeError` raised
- **Fix:** Changed patch target to `src.agents.llm.get_routing_llm` (the source module where the function is defined). The mock registers at the source, so if `_classify_raw_intent()` ever ran through to the import it would intercept; since it short-circuits first, `mock_get_llm.assert_not_called()` correctly passes
- **Files modified:** tests/agents/test_intake_flow_gbv_routing.py
- **Verification:** All 3 tests pass, 277 total agent tests pass
- **Committed in:** 35b6013 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - bug in test mock patch target)
**Impact on plan:** Fix was necessary for test correctness. No scope creep. Implementation of `_is_saps_context()` itself matched the plan exactly.

## Issues Encountered

The `Flow.state` property on CrewAI's `Flow` class doesn't have a setter, so the plan's verification command (`f.state = IntakeState()`) would fail. The helper method `_is_saps_context(message)` takes `message` as a direct argument, so verification was done by calling the method directly without replacing `state`.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- UAT gap GBV-4 closed: adversarial SAPS-phrased messages now correctly route to GBV agent
- SEC-05 defense layer strengthened with deterministic pre-classification
- Regression tests guard against future regressions in this routing path
- Phase 10.3 is now complete — all 10 plans done, system ready for production pilots

## Self-Check: PASSED

Files created/modified:
- `src/agents/flows/intake_flow.py` exists and contains `_is_saps_context` at lines 114, 140
- `tests/agents/test_intake_flow_gbv_routing.py` created with 3 regression tests

Commits:
- `ee32ebb` — fix(10.3-10): add _is_saps_context heuristic
- `35b6013` — test(10.3-10): add regression tests

---
*Phase: 10.3-crewai-agent-rebuild-and-llm-evaluation-framework*
*Completed: 2026-02-26*
