---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e-tests/package.json
  - e2e-tests/playwright.config.ts
  - e2e-tests/tsconfig.json
  - e2e-tests/.env.test.example
  - e2e-tests/fixtures/auth.ts
  - e2e-tests/fixtures/test-data.ts
  - e2e-tests/fixtures/supabase-test-client.ts
  - e2e-tests/fixtures/page-objects/public/LoginPage.ts
  - e2e-tests/fixtures/page-objects/public/RegisterPage.ts
  - e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
  - e2e-tests/fixtures/page-objects/public/ProfilePage.ts
  - e2e-tests/fixtures/page-objects/public/LandingPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
  - e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
  - e2e-tests/profiles/public/citizen-new.profile.ts
  - e2e-tests/profiles/public/citizen-returning.profile.ts
  - e2e-tests/profiles/public/citizen-gbv.profile.ts
  - e2e-tests/profiles/public/citizen-multireport.profile.ts
  - e2e-tests/profiles/public/citizen-tracking.profile.ts
  - e2e-tests/profiles/municipal/admin.profile.ts
  - e2e-tests/profiles/municipal/manager.profile.ts
  - e2e-tests/profiles/municipal/field-worker.profile.ts
  - e2e-tests/profiles/municipal/saps-liaison.profile.ts
  - e2e-tests/profiles/municipal/ward-councillor.profile.ts
  - e2e-tests/global-setup.ts
  - e2e-tests/global-teardown.ts
autonomous: true
must_haves:
  truths:
    - "Playwright test runner can be invoked via npx playwright test from e2e-tests/"
    - "Two separate Playwright projects target public (port 5173) and dashboard (port 5174) apps"
    - "10 test profiles exist (5 public citizen, 5 municipal roles) with credentials and metadata"
    - "Page objects encapsulate all page interactions for both dashboards"
    - "Auth fixtures provide authenticated browser contexts for each role via Supabase storageState"
    - "Test data generators produce unique, faker-powered test data per run"
    - "Global setup seeds two test municipalities (Jozi + Pretoria) and global teardown cleans up"
  artifacts:
    - path: "e2e-tests/package.json"
      provides: "Playwright + faker + dotenv dependencies"
      contains: "@playwright/test"
    - path: "e2e-tests/playwright.config.ts"
      provides: "Multi-project config (public-chromium, dashboard-chromium, mobile-chrome)"
      exports: ["default"]
    - path: "e2e-tests/fixtures/auth.ts"
      provides: "Role-based auth fixtures extending base Playwright test"
      exports: ["test", "expect"]
    - path: "e2e-tests/fixtures/test-data.ts"
      provides: "Faker-powered generators for citizens, reports, municipalities"
      exports: ["generateCitizenData", "generateReportData", "generateMunicipalityData"]
    - path: "e2e-tests/profiles/public/citizen-new.profile.ts"
      provides: "New citizen profile with credentials and metadata"
    - path: "e2e-tests/profiles/municipal/admin.profile.ts"
      provides: "Admin profile with credentials and metadata"
    - path: "e2e-tests/global-setup.ts"
      provides: "Database seeding for test tenants"
    - path: "e2e-tests/global-teardown.ts"
      provides: "Test data cleanup"
  key_links:
    - from: "e2e-tests/fixtures/auth.ts"
      to: "e2e-tests/profiles/"
      via: "imports profile credentials for storageState login"
      pattern: "import.*profile"
    - from: "e2e-tests/playwright.config.ts"
      to: "e2e-tests/global-setup.ts"
      via: "globalSetup config property"
      pattern: "globalSetup.*global-setup"
    - from: "e2e-tests/fixtures/auth.ts"
      to: "e2e-tests/fixtures/supabase-test-client.ts"
      via: "Supabase admin client for user creation"
      pattern: "supabase.*admin"
---

<objective>
Set up the complete Playwright E2E test infrastructure with project configuration, authentication fixtures, page objects, test profiles, and test data generators.

Purpose: This is the foundation plan that all other testing plans depend on. Without proper infrastructure (config, fixtures, page objects, profiles), individual test specs cannot be written. Establishes the patterns that all tests follow.

Output: A fully configured e2e-tests/ directory with Playwright ready to run, 10 test profiles defined, page objects for all pages in both dashboards, and global setup/teardown for test municipality seeding.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-RESEARCH.md
@frontend-public/src/App.tsx
@frontend-dashboard/src/App.tsx
@frontend-public/src/lib/supabase.ts
@frontend-dashboard/src/lib/supabase.ts
@frontend-public/src/pages/CitizenLoginPage.tsx
@frontend-public/src/pages/CitizenRegisterPage.tsx
@frontend-public/src/pages/ReportIssuePage.tsx
@frontend-public/src/pages/ProfilePage.tsx
@frontend-public/src/pages/LandingPage.tsx
@frontend-dashboard/src/pages/LoginPage.tsx
@frontend-dashboard/src/pages/RequestAccessPage.tsx
@frontend-dashboard/src/pages/OnboardingWizardPage.tsx
@frontend-dashboard/src/pages/DashboardPage.tsx
@frontend-dashboard/src/pages/TicketListPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playwright project setup, config, profiles, and test data generators</name>
  <files>
    e2e-tests/package.json
    e2e-tests/tsconfig.json
    e2e-tests/playwright.config.ts
    e2e-tests/.env.test.example
    e2e-tests/.gitignore
    e2e-tests/fixtures/test-data.ts
    e2e-tests/fixtures/supabase-test-client.ts
    e2e-tests/profiles/public/citizen-new.profile.ts
    e2e-tests/profiles/public/citizen-returning.profile.ts
    e2e-tests/profiles/public/citizen-gbv.profile.ts
    e2e-tests/profiles/public/citizen-multireport.profile.ts
    e2e-tests/profiles/public/citizen-tracking.profile.ts
    e2e-tests/profiles/municipal/admin.profile.ts
    e2e-tests/profiles/municipal/manager.profile.ts
    e2e-tests/profiles/municipal/field-worker.profile.ts
    e2e-tests/profiles/municipal/saps-liaison.profile.ts
    e2e-tests/profiles/municipal/ward-councillor.profile.ts
    e2e-tests/global-setup.ts
    e2e-tests/global-teardown.ts
  </files>
  <action>
    1. Create e2e-tests/ directory at project root. Initialize package.json with:
       - devDependencies: @playwright/test (latest), @faker-js/faker (^9.x), dotenv (^16.x), @supabase/supabase-js (latest)
       - scripts: "test" = "playwright test", "test:public" = "playwright test --project=public-chromium", "test:dashboard" = "playwright test --project=dashboard-chromium", "test:security" = "playwright test tests/security/", "report" = "playwright show-report"
       - Run `npm install` then `npx playwright install chromium firefox`

    2. Create tsconfig.json with target ES2022, module ESNext, moduleResolution bundler, strict true, paths for @fixtures, @profiles, @utils aliases.

    3. Create playwright.config.ts with:
       - testDir: './tests'
       - fullyParallel: true
       - workers: process.env.CI ? 2 : 4
       - retries: process.env.CI ? 2 : 0
       - reporter: [['html'], ['list']]
       - globalSetup: './global-setup.ts'
       - globalTeardown: './global-teardown.ts'
       - use: { trace: 'on-first-retry', screenshot: 'only-on-failure', video: 'retain-on-failure' }
       - Projects:
         a. 'setup' - testMatch: /.*\.setup\.ts/, no baseURL
         b. 'public-chromium' - Desktop Chrome, baseURL http://localhost:5173, depends on setup
         c. 'public-firefox' - Desktop Firefox, baseURL http://localhost:5173, depends on setup
         d. 'dashboard-chromium' - Desktop Chrome, baseURL http://localhost:5174, depends on setup
         e. 'mobile-chrome' - Pixel 5 device, baseURL http://localhost:5173, depends on setup
       - webServer: two entries for frontend-public (port 5173) and frontend-dashboard (port 5174), using `npm run dev` commands, reuseExistingServer: !process.env.CI

    4. Create .env.test.example documenting all required env vars:
       - SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY (for admin operations)
       - TEST_MUNICIPALITY_1_ID=test-jozi-001, TEST_MUNICIPALITY_2_ID=test-pretoria-001
       - TEST_PASSWORD=Test123!@# (shared test password for all profiles)
       - TEST_OTP_CODE=123456 (Supabase test OTP)
       - BACKEND_URL=http://localhost:8000

    5. Create .gitignore excluding: node_modules/, test-results/, playwright-report/, .auth/, .env.test, blob-report/

    6. Create fixtures/supabase-test-client.ts:
       - Export two clients: `supabase` (anon key, for regular operations) and `supabaseAdmin` (service role key, for user creation/deletion in setup)
       - Load from dotenv (.env.test)

    7. Create fixtures/test-data.ts with faker-powered generators:
       - generateCitizenData(tenantId?: string): returns { email, password, phone (+27...), firstName, lastName, address }
       - generateReportData(category?: string): returns { category, description, address, latitude (-26.1 to -26.3), longitude (27.9 to 28.1) }
       - generateMunicipalityData(): returns { name, province (random SA province), code (MUN####), contactName, contactEmail, contactPhone }
       - TEST_MUNICIPALITIES constant: array of two test municipality objects with fixed IDs (test-jozi-001, test-pretoria-001)

    8. Create all 10 profile files. Each profile exports:
       - `profile` object with: name, role, tenantId, email, password, phone, metadata (role-specific)
       - Public profiles (all tenantId: 'test-jozi-001'):
         a. citizen-new: first-time citizen, no prior reports, email citizen-new@test-jozi-001.test
         b. citizen-returning: existing citizen with reports, email citizen-return@test-jozi-001.test
         c. citizen-gbv: citizen for GBV privacy testing, email citizen-gbv@test-jozi-001.test
         d. citizen-multireport: citizen for multi-report scenarios, email citizen-multi@test-jozi-001.test
         e. citizen-tracking: citizen for status tracking, email citizen-track@test-jozi-001.test
       - Municipal profiles (tenantId: 'test-jozi-001' except where noted):
         a. admin: role admin, email admin@test-jozi-001.test, app_metadata: { role: 'admin', tenant_id: 'test-jozi-001' }
         b. manager: role manager, email manager@test-jozi-001.test
         c. field-worker: role field_worker, email fieldworker@test-jozi-001.test
         d. saps-liaison: role saps_liaison, email saps@test-jozi-001.test
         e. ward-councillor: role ward_councillor, email councillor@test-jozi-001.test, metadata includes ward_id

    9. Create global-setup.ts:
       - Load dotenv
       - Use supabaseAdmin to create test municipalities if not exist (upsert pattern)
       - Create all 10 test users via supabaseAdmin.auth.admin.createUser() with email_confirm: true, app_metadata containing role + tenant_id
       - Log setup actions for debugging
       - Export setup function as default

    10. Create global-teardown.ts:
        - Use supabaseAdmin to delete test data: tickets with test tenant IDs, then test users, then test municipalities
        - Handle errors gracefully (log and continue, don't fail teardown)
        - Export teardown function as default
  </action>
  <verify>
    Run from e2e-tests/:
    - `npm install` completes without errors
    - `npx playwright --version` prints version
    - `npx tsc --noEmit` passes TypeScript compilation
    - All profile files import correctly (no circular deps)
  </verify>
  <done>
    e2e-tests/ directory fully initialized with Playwright config targeting both dashboards, 10 profiles defined with role-specific credentials, faker-powered test data generators working, Supabase test client configured, global setup/teardown scripts ready for database seeding
  </done>
</task>

<task type="auto">
  <name>Task 2: Page Object Model for both dashboards + auth fixtures</name>
  <files>
    e2e-tests/fixtures/auth.ts
    e2e-tests/fixtures/page-objects/public/LoginPage.ts
    e2e-tests/fixtures/page-objects/public/RegisterPage.ts
    e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
    e2e-tests/fixtures/page-objects/public/ProfilePage.ts
    e2e-tests/fixtures/page-objects/public/LandingPage.ts
    e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
    e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
    e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
    e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
    e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
  </files>
  <action>
    IMPORTANT: Read each actual page component in frontend-public/src/pages/ and frontend-dashboard/src/pages/ to discover real form field names, button texts, CSS classes, and page structure. Do NOT assume selectors -- derive them from the actual JSX. Where no data-testid exists (none do currently), use accessible selectors: role-based (getByRole), label-based (getByLabel), text-based (getByText), or CSS selectors matching actual attributes (input[id="email"], select, textarea, etc.).

    1. Create fixtures/auth.ts extending Playwright base test:
       - Import all 10 profiles from profiles/ directory
       - Define AuthFixtures interface with: citizenNewPage, citizenReturningPage, citizenGbvPage, managerPage, adminPage, sapsLiaisonPage, fieldWorkerPage, wardCouncillorPage
       - Each fixture:
         a. Checks for cached storageState at `.auth/{role}-{tenantId}.json`
         b. If cached, creates context with storageState
         c. If not cached, creates new context, navigates to login page (public login for citizens, dashboard login for municipal roles), fills email+password from profile, clicks submit, waits for redirect, saves storageState
         d. Returns new page from context
         e. Closes context in teardown
       - Export extended `test` and re-export `expect`
       - Helper: getLoginUrl(role) returns public login URL for citizen roles, dashboard login URL for municipal roles

    2. Create page objects for public dashboard (read actual components first):
       a. LoginPage.ts: locators for email input, password input, submit button, error message, phone tab, phone input, OTP input. Methods: goto(), loginWithEmail(email, pw), loginWithPhone(phone, otp), getErrorMessage()
       b. RegisterPage.ts: locators for email, password, confirm password, first name, last name, phone, submit. Methods: goto(), register(data), getErrorMessage()
       c. ReportIssuePage.ts: locators for category select, description textarea, manual address input, GPS capture button, file upload area, submit button, GBV consent dialog (including consent button + emergency numbers display), receipt card (tracking number). Methods: goto(), selectCategory(cat), fillDescription(desc), fillAddress(addr), captureGPS(), uploadFile(path), submit(), acceptGbvConsent(), getTrackingNumber()
       d. ProfilePage.ts: locators for user info display, reports list, residence upload area. Methods: goto(), getUserEmail(), getReportCount(), isResidenceVerified()
       e. LandingPage.ts: locators for hero section, feature cards, CTA buttons, header, footer. Methods: goto(), clickGetStarted(), clickViewDashboard(), isHeaderVisible()

    3. Create page objects for municipal dashboard (read actual components first):
       a. LoginPage.ts: locators for email, password, submit, error, product info section. Methods: goto(), login(email, pw), getErrorMessage()
       b. RequestAccessPage.ts: locators for municipality name, province select, municipality code, contact name/email/phone, notes textarea, file upload, submit button, success state. Methods: goto(), fillForm(data), uploadDocument(path), submit(), isSuccessShown()
       c. OnboardingWizardPage.ts: locators for each step (welcome, profile, team, wards, SLA, completion), next/back/skip buttons, form fields per step. Methods: goto(), getCurrentStep(), goToNextStep(), goBack(), skipStep(), fillProfileStep(data), fillTeamStep(data), isComplete()
       d. DashboardPage.ts: locators for metrics cards (total tickets, response time, resolution rate, SLA compliance), charts (volume, SLA, team workload), filter bar. Methods: goto(), getMetric(name), isChartVisible(chartName)
       e. TicketListPage.ts: locators for table rows, search input, status filter, category filter, pagination, export button. Methods: goto(), searchTickets(query), filterByStatus(status), getTicketCount(), getFirstTicketId(), clickExport()

    Each page object must:
    - Accept Page in constructor
    - Use Locator type for all element references
    - Use auto-wait (no manual timeouts)
    - Have JSDoc comments on all public methods
  </action>
  <verify>
    - `npx tsc --noEmit` passes with all page objects and auth fixtures
    - Each page object class has at least 3 methods
    - Auth fixture exports extended `test` with all 8 role-specific page fixtures
    - No hardcoded waitForTimeout calls in page objects
  </verify>
  <done>
    Auth fixtures provide ready-to-use authenticated pages for all 8 active roles (5 citizen variants + 3 municipal roles tested most often). Page objects encapsulate all UI interactions for both dashboards with accessible selectors derived from actual component source code. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- `cd e2e-tests && npx tsc --noEmit` passes
- `npx playwright test --list` shows configured projects (public-chromium, public-firefox, dashboard-chromium, mobile-chrome)
- All 10 profile files exist and export valid profile objects
- Page objects cover all pages: 5 public + 5 dashboard = 10 page objects
- fixtures/auth.ts exports extended test with role-specific fixtures
</verification>

<success_criteria>
- Playwright infrastructure fully bootstrapped in e2e-tests/ directory
- Config targets both frontend apps with separate projects
- 10 role-specific profiles defined with credentials
- Page Object Model covers all pages in both dashboards
- Auth fixtures provide storageState-cached authenticated contexts
- TypeScript compilation passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-playwright-mcp-automated-dashboard-testing/06.6-01-SUMMARY.md`
</output>
