---
phase: 06.6-playwright-mcp-automated-dashboard-testing
plan: 01
subsystem: testing
tags:
  - playwright
  - e2e
  - testing
  - infrastructure
  - page-objects
  - auth-fixtures
dependency_graph:
  requires: []
  provides:
    - e2e-tests/playwright.config.ts
    - e2e-tests/fixtures/auth.ts
    - e2e-tests/profiles/*
    - e2e-tests/fixtures/page-objects/*
  affects:
    - all future E2E test specs
tech_stack:
  added:
    - Playwright 1.58.2
    - @faker-js/faker 9.2.0
    - TypeScript 5.9.3
  patterns:
    - Page Object Model for UI encapsulation
    - Fixture-based authentication with storageState caching
    - Global setup/teardown for test data lifecycle
key_files:
  created:
    - e2e-tests/playwright.config.ts
    - e2e-tests/package.json
    - e2e-tests/tsconfig.json
    - e2e-tests/.env.test.example
    - e2e-tests/fixtures/auth.ts
    - e2e-tests/fixtures/test-data.ts
    - e2e-tests/fixtures/supabase-test-client.ts
    - e2e-tests/global-setup.ts
    - e2e-tests/global-teardown.ts
    - e2e-tests/profiles/public/citizen-new.profile.ts
    - e2e-tests/profiles/public/citizen-returning.profile.ts
    - e2e-tests/profiles/public/citizen-gbv.profile.ts
    - e2e-tests/profiles/public/citizen-multireport.profile.ts
    - e2e-tests/profiles/public/citizen-tracking.profile.ts
    - e2e-tests/profiles/municipal/admin.profile.ts
    - e2e-tests/profiles/municipal/manager.profile.ts
    - e2e-tests/profiles/municipal/field-worker.profile.ts
    - e2e-tests/profiles/municipal/saps-liaison.profile.ts
    - e2e-tests/profiles/municipal/ward-councillor.profile.ts
    - e2e-tests/fixtures/page-objects/public/LoginPage.ts
    - e2e-tests/fixtures/page-objects/public/RegisterPage.ts
    - e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
    - e2e-tests/fixtures/page-objects/public/ProfilePage.ts
    - e2e-tests/fixtures/page-objects/public/LandingPage.ts
    - e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
    - e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
    - e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
    - e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
    - e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
  modified: []
decisions:
  - decision: "Playwright over Cypress for better multi-browser support and native TypeScript"
    rationale: "Playwright provides better cross-browser testing, faster execution, and built-in TypeScript support"
  - decision: "StorageState caching for authentication fixtures to speed up test execution"
    rationale: "Avoids repeated login flows across tests, improves performance"
  - decision: "Page Object Model pattern for all UI interactions"
    rationale: "Encapsulates selectors and interactions, makes tests maintainable and DRY"
  - decision: "Faker for test data generation instead of hardcoded fixtures"
    rationale: "Produces unique data per test run, prevents test pollution and flakiness"
  - decision: "Global setup/teardown for test municipality and user seeding"
    rationale: "Ensures clean test environment, avoids dependency on production data"
  - decision: "Two test municipalities (Jozi and Pretoria) for multi-tenant testing"
    rationale: "Validates tenant isolation at database and UI layers"
metrics:
  duration_seconds: 1006
  completed_at: "2026-02-14T16:59:18Z"
---

# Phase 06.6 Plan 01: Playwright E2E Test Infrastructure Summary

**One-liner:** Complete Playwright test infrastructure with multi-project config, 10 role-based auth fixtures with storageState caching, Page Object Model for all dashboard pages, and global setup/teardown for test data lifecycle.

## What Was Built

### Test Infrastructure
1. **Playwright Configuration**
   - Multi-project setup: `public-chromium`, `public-firefox`, `dashboard-chromium`, `mobile-chrome`
   - Separate base URLs for public (5173) and dashboard (5174) apps
   - Global setup/teardown hooks for test data lifecycle
   - Video/screenshot/trace capture on failure for debugging
   - Dev server auto-start configuration for both frontends

2. **Test Data Generators**
   - Faker-powered citizen data generator (email, phone, name, address)
   - Report data generator with SA-specific location data (Johannesburg coordinates)
   - Municipality data generator with SA provinces
   - Fixed test municipalities: `test-jozi-001`, `test-pretoria-001`

3. **Supabase Test Client**
   - Dual-client setup: anon key for regular ops, service role key for admin operations
   - Used by global setup (user creation) and teardown (cleanup)
   - Environment variable loading from `.env.test`

### Authentication Fixtures
4. **Role-Based Auth Fixtures** (10 total)
   - 5 citizen profiles: `citizenNewPage`, `citizenReturningPage`, `citizenGbvPage`, `citizenMultiPage`, `citizenTrackingPage`
   - 5 municipal profiles: `adminPage`, `managerPage`, `fieldWorkerPage`, `sapsLiaisonPage`, `wardCouncillorPage`
   - Each fixture provides ready-to-use authenticated page
   - StorageState caching (1-hour TTL) for fast authentication reuse
   - Automatic login flow with Supabase email+password

5. **Test Profiles**
   - Each profile includes: name, role, tenantId, email, password, phone, metadata
   - Citizen profiles use `@test-jozi-001.test` email domain
   - Municipal profiles include app_metadata with role and tenant_id for Supabase RLS
   - Metadata tailored to role (e.g., ward_councillor has ward_id)

### Page Object Model
6. **Public Dashboard Page Objects** (5 pages)
   - `LoginPage.ts`: Email+password and phone OTP authentication
   - `RegisterPage.ts`: Citizen registration with validation
   - `ReportIssuePage.ts`: Full report submission flow with GBV consent
   - `ProfilePage.ts`: User info display, edit mode, residence verification
   - `LandingPage.ts`: Hero, features, CTAs

7. **Municipal Dashboard Page Objects** (5 pages)
   - `LoginPage.ts`: Municipal login with product info section
   - `RequestAccessPage.ts`: Municipality access request form
   - `OnboardingWizardPage.ts`: 6-step wizard navigation
   - `DashboardPage.ts`: Metrics cards, charts, filters
   - `TicketListPage.ts`: Table, search, filters, pagination, export

### Global Setup/Teardown
8. **Global Setup** (`global-setup.ts`)
   - Creates test municipalities via Supabase admin
   - Creates all 10 test users with proper roles and app_metadata
   - Uses `email_confirm: true` to skip email verification
   - Idempotent (checks for existing users before creating)

9. **Global Teardown** (`global-teardown.ts`)
   - Deletes test tickets by tenant_id
   - Deletes test users by email pattern (`@test-*.test`)
   - Deletes test municipalities
   - Graceful error handling (logs warnings, doesn't fail teardown)

## Deviations from Plan

None - plan executed exactly as written. All 10 profiles created, all page objects implemented, TypeScript compilation passes with zero errors.

## Verification Results

```bash
# TypeScript compilation
$ npx tsc --noEmit
✓ No errors

# Playwright version
$ npx playwright --version
Version 1.58.2

# Playwright projects
$ npx playwright test --list
Total: 0 tests in 0 files (expected - no test specs yet)
```

All verification criteria met:
- ✅ TypeScript compiles cleanly
- ✅ Playwright projects configured (4 projects + setup)
- ✅ 10 profile files exist and export valid profile objects
- ✅ Page objects cover all pages (5 public + 5 dashboard = 10 page objects)
- ✅ Auth fixtures export extended test with 10 role-specific fixtures

## Key Technical Decisions

1. **Page Object Selector Strategy**
   - Read actual component source code to derive selectors
   - No data-testid attributes in current codebase → used accessible selectors
   - Priority: `id` attributes > `type` + text content > CSS classes
   - Example: `input[id="email"]` instead of `[data-testid="email-input"]`

2. **Auth Fixture Pattern**
   - Extends Playwright `test` object with custom fixtures
   - Each fixture creates isolated browser context with storageState
   - 1-hour cache TTL balances performance and auth freshness
   - Context cleanup in fixture teardown prevents memory leaks

3. **Test Profile Structure**
   - Citizen profiles: minimal metadata (full_name, reports_count)
   - Municipal profiles: include app_metadata for RLS (role, tenant_id)
   - Shared password (`TEST_PASSWORD`) for all profiles simplifies credential management
   - Phone numbers use SA format (+27XXXXXXXXX)

4. **Global Setup Timing**
   - Runs before all test projects (including setup project)
   - Creates test data synchronously (not parallel) for predictable state
   - Logs all actions for debugging CI failures

## Files Created

**Total:** 31 files

**Configuration:**
- `e2e-tests/package.json` (dependencies and scripts)
- `e2e-tests/tsconfig.json` (TypeScript config with path aliases)
- `e2e-tests/playwright.config.ts` (4 browser projects + webServer config)
- `e2e-tests/.env.test.example` (environment variable template)
- `e2e-tests/.gitignore` (excludes node_modules, test-results, .auth)

**Test Infrastructure:**
- `e2e-tests/fixtures/supabase-test-client.ts` (dual Supabase clients)
- `e2e-tests/fixtures/test-data.ts` (faker generators)
- `e2e-tests/fixtures/auth.ts` (role-based auth fixtures)
- `e2e-tests/global-setup.ts` (test data seeding)
- `e2e-tests/global-teardown.ts` (test data cleanup)

**Profiles (10):**
- `e2e-tests/profiles/public/citizen-*.profile.ts` (5 citizen profiles)
- `e2e-tests/profiles/municipal/*.profile.ts` (5 municipal profiles)

**Page Objects (10):**
- `e2e-tests/fixtures/page-objects/public/*.ts` (5 public dashboard pages)
- `e2e-tests/fixtures/page-objects/dashboard/*.ts` (5 municipal dashboard pages)

## Next Steps

Future plans (02-06) will build on this foundation:
- **Plan 02:** Public dashboard E2E tests (login, register, report submission)
- **Plan 03:** Municipal dashboard E2E tests (login, onboarding, ticket management)
- **Plan 04:** Multi-tenant isolation tests (tenant data firewall verification)
- **Plan 05:** OWASP security tests (XSS, CSRF, auth bypass attempts)
- **Plan 06:** CI integration with GitHub Actions (parallel execution, reporting)

## Self-Check: PASSED

All claimed files verified:

**Created files (31):**
```bash
# Configuration
✓ e2e-tests/package.json
✓ e2e-tests/tsconfig.json
✓ e2e-tests/playwright.config.ts
✓ e2e-tests/.env.test.example
✓ e2e-tests/.gitignore

# Infrastructure
✓ e2e-tests/fixtures/supabase-test-client.ts
✓ e2e-tests/fixtures/test-data.ts
✓ e2e-tests/fixtures/auth.ts
✓ e2e-tests/global-setup.ts
✓ e2e-tests/global-teardown.ts

# Profiles (10)
✓ e2e-tests/profiles/public/citizen-new.profile.ts
✓ e2e-tests/profiles/public/citizen-returning.profile.ts
✓ e2e-tests/profiles/public/citizen-gbv.profile.ts
✓ e2e-tests/profiles/public/citizen-multireport.profile.ts
✓ e2e-tests/profiles/public/citizen-tracking.profile.ts
✓ e2e-tests/profiles/municipal/admin.profile.ts
✓ e2e-tests/profiles/municipal/manager.profile.ts
✓ e2e-tests/profiles/municipal/field-worker.profile.ts
✓ e2e-tests/profiles/municipal/saps-liaison.profile.ts
✓ e2e-tests/profiles/municipal/ward-councillor.profile.ts

# Page Objects (10)
✓ e2e-tests/fixtures/page-objects/public/LoginPage.ts
✓ e2e-tests/fixtures/page-objects/public/RegisterPage.ts
✓ e2e-tests/fixtures/page-objects/public/ReportIssuePage.ts
✓ e2e-tests/fixtures/page-objects/public/ProfilePage.ts
✓ e2e-tests/fixtures/page-objects/public/LandingPage.ts
✓ e2e-tests/fixtures/page-objects/dashboard/LoginPage.ts
✓ e2e-tests/fixtures/page-objects/dashboard/RequestAccessPage.ts
✓ e2e-tests/fixtures/page-objects/dashboard/OnboardingWizardPage.ts
✓ e2e-tests/fixtures/page-objects/dashboard/DashboardPage.ts
✓ e2e-tests/fixtures/page-objects/dashboard/TicketListPage.ts
```

**Commits:**
```bash
✓ e6d8254: feat(06.6-01): Playwright test infrastructure with profiles and page objects
```

**TypeScript compilation:**
```bash
$ npx tsc --noEmit
✓ Exit code 0 (no errors)
```

All infrastructure is in place for future test spec implementation.
