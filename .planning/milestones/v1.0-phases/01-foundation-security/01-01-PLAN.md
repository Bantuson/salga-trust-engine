---
phase: 01-foundation-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/__init__.py
  - src/core/__init__.py
  - src/core/config.py
  - src/core/database.py
  - src/core/tenant.py
  - src/models/__init__.py
  - src/models/base.py
  - src/models/municipality.py
  - src/models/user.py
  - src/models/consent.py
  - src/models/audit_log.py
  - src/schemas/__init__.py
  - src/schemas/user.py
  - src/schemas/auth.py
  - src/schemas/consent.py
  - src/api/__init__.py
  - src/api/deps.py
  - src/api/v1/__init__.py
  - src/main.py
  - alembic.ini
  - alembic/env.py
  - alembic/versions/.gitkeep
  - .env.example
  - .gitignore
  - tests/__init__.py
  - tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "Python project installs with all dependencies and uvicorn starts without errors"
    - "Database engine connects to PostgreSQL and creates all tables via Alembic migration"
    - "All data models have tenant_id, created_at, updated_at audit fields"
    - "FastAPI app serves /health endpoint and /docs is accessible"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata and all dependencies"
      contains: "fastapi"
    - path: "src/core/config.py"
      provides: "Pydantic Settings with env var loading"
      contains: "class Settings"
    - path: "src/core/database.py"
      provides: "Async SQLAlchemy engine and session factory"
      contains: "AsyncSession"
    - path: "src/models/base.py"
      provides: "TenantAwareModel base with audit fields"
      contains: "tenant_id"
    - path: "src/models/user.py"
      provides: "User model with UserRole enum (citizen, field_worker, manager, admin, saps_liaison)"
      contains: "class UserRole"
    - path: "src/models/municipality.py"
      provides: "Municipality model for tenant registration"
      contains: "class Municipality"
    - path: "src/main.py"
      provides: "FastAPI application entry point"
      contains: "FastAPI"
    - path: "alembic/env.py"
      provides: "Alembic async migration config"
      contains: "run_async_migrations"
  key_links:
    - from: "src/core/database.py"
      to: "src/core/config.py"
      via: "Settings.DATABASE_URL"
      pattern: "settings\\.DATABASE_URL"
    - from: "src/models/base.py"
      to: "src/core/tenant.py"
      via: "tenant context import"
      pattern: "from src\\.core\\.tenant import"
    - from: "alembic/env.py"
      to: "src/models"
      via: "target_metadata from Base"
      pattern: "target_metadata"
---

<objective>
Set up the complete project foundation: Python project with all dependencies, FastAPI application skeleton, async PostgreSQL database layer with SQLAlchemy 2.0, all core data models (Municipality, User, ConsentRecord, AuditLog), and Alembic migration infrastructure.

Purpose: Every subsequent plan depends on this foundation -- database connectivity, model definitions, and project structure must exist before auth, security middleware, or POPIA features can be built.
Output: Runnable FastAPI application with database schema created via Alembic, ready for feature development.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding and dependency installation</name>
  <files>
    pyproject.toml
    .env.example
    .gitignore
    src/__init__.py
    src/core/__init__.py
    src/models/__init__.py
    src/schemas/__init__.py
    src/api/__init__.py
    src/api/v1/__init__.py
    tests/__init__.py
  </files>
  <action>
    Create pyproject.toml with the following dependencies (versions from research):
    - fastapi[standard]==0.128.0, uvicorn[standard]==0.34.0
    - pyjwt==2.10.1, argon2-cffi==23.1.0
    - python-multipart==0.0.18
    - sqlalchemy==2.0.36, psycopg[binary]==3.2.3, alembic==1.14.0
    - slowapi==0.1.9, redis==5.2.0
    - python-magic==0.4.27, nh3==0.2.21
    - email-validator==2.1.0, python-dotenv==1.0.1, aiofiles==24.1.0
    - pydantic-settings==2.7.0
    - Dev dependencies: pytest==8.3.0, pytest-asyncio==0.24.0, httpx==0.28.0 (for TestClient async)

    Use [project] format with Python >= 3.12 requirement. Include [project.scripts] entry: salga = "src.main:app".

    Create .env.example with ALL required env vars:
    - DATABASE_URL=postgresql+psycopg://user:password@localhost:5432/salga_trust
    - SECRET_KEY=generate-with-openssl-rand-hex-32
    - ALGORITHM=HS256
    - ACCESS_TOKEN_EXPIRE_MINUTES=30
    - REFRESH_TOKEN_EXPIRE_DAYS=7
    - REDIS_URL=redis://localhost:6379/0
    - ALLOWED_ORIGINS=http://localhost:3000
    - DEBUG=true
    - ENVIRONMENT=development

    Create .gitignore for Python (include .env, __pycache__, *.pyc, .venv, alembic/versions/*.py but NOT .gitkeep).

    Create all __init__.py files (empty) to establish package structure:
    src/, src/core/, src/models/, src/schemas/, src/api/, src/api/v1/, tests/

    Run `pip install -e ".[dev]"` to install in editable mode. If pip fails on pyproject.toml format, use `pip install -e .` and install dev deps separately.
  </action>
  <verify>
    Run: python -c "import fastapi; import sqlalchemy; import jwt; import argon2; print('All imports OK')"
    Confirm all packages installed without errors.
  </verify>
  <done>pyproject.toml exists with all dependencies, all packages importable, directory structure created with __init__.py files</done>
</task>

<task type="auto">
  <name>Task 2: Core config, database engine, and all data models</name>
  <files>
    src/core/config.py
    src/core/database.py
    src/core/tenant.py
    src/models/base.py
    src/models/municipality.py
    src/models/user.py
    src/models/consent.py
    src/models/audit_log.py
    src/schemas/user.py
    src/schemas/auth.py
    src/schemas/consent.py
    src/main.py
    src/api/deps.py
    tests/conftest.py
  </files>
  <action>
    **src/core/config.py:** Create Settings class using pydantic-settings BaseSettings:
    - DATABASE_URL: str (required)
    - SECRET_KEY: str (required, validate length >= 32 chars on startup)
    - ALGORITHM: str = "HS256"
    - ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    - REFRESH_TOKEN_EXPIRE_DAYS: int = 7
    - REDIS_URL: str = "redis://localhost:6379/0"
    - ALLOWED_ORIGINS: list[str] = ["http://localhost:3000"]
    - DEBUG: bool = False
    - ENVIRONMENT: str = "development"
    - model_config with env_file=".env"
    Create singleton: settings = Settings()

    **src/core/database.py:** Create async SQLAlchemy engine and session factory:
    - create_async_engine with pool_pre_ping=True, pool_size=10, max_overflow=20
    - AsyncSessionLocal = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
    - async def get_db() -> AsyncGenerator[AsyncSession, None] (dependency for routes)

    **src/core/tenant.py:** Tenant context management using contextvars:
    - current_tenant_id: ContextVar[Optional[str]] with default None
    - set_tenant_context(tenant_id: str), get_tenant_context() -> Optional[str], clear_tenant_context()

    **src/models/base.py:** Base model classes:
    - Base = declarative_base() (or use DeclarativeBase from SQLAlchemy 2.0)
    - class TenantAwareModel(Base): __abstract__ = True, with columns:
      id (UUID, primary_key, default uuid4), tenant_id (String, nullable=False, index=True),
      created_at (DateTime(timezone=True), server_default=func.now()),
      updated_at (DateTime(timezone=True), onupdate=func.now()),
      created_by (String, nullable=True), updated_by (String, nullable=True)
    - class NonTenantModel(Base): __abstract__ = True, with id, created_at, updated_at only
      (for models like Municipality that exist above tenant scope)

    **src/models/municipality.py:** Municipality model (extends NonTenantModel):
    - __tablename__ = "municipalities"
    - id (UUID PK), name (String, unique, not null), code (String, unique, not null -- municipal code like "CPT", "JHB"),
      province (String, not null), population (Integer, nullable),
      is_active (Boolean, default True), contact_email (String, nullable),
      created_at, updated_at (from NonTenantModel)

    **src/models/user.py:** User model (extends TenantAwareModel):
    - class UserRole(str, Enum): CITIZEN = "citizen", FIELD_WORKER = "field_worker", MANAGER = "manager", ADMIN = "admin", SAPS_LIAISON = "saps_liaison"
    - __tablename__ = "users"
    - email (String, unique per tenant -- use UniqueConstraint on (email, tenant_id)),
      hashed_password (String, not null), full_name (String, not null),
      phone (String, nullable), preferred_language (String, default="en", validate in ["en", "zu", "af"]),
      role (Enum(UserRole), default=UserRole.CITIZEN, not null),
      is_active (Boolean, default True), is_deleted (Boolean, default False),
      deleted_at (DateTime, nullable),
      municipality_id (ForeignKey to municipalities.id, nullable=False)

    **src/models/consent.py:** ConsentRecord model (extends TenantAwareModel):
    - __tablename__ = "consent_records"
    - user_id (ForeignKey to users.id, not null), purpose (String, not null),
      purpose_description (Text, not null), language (String, not null, default="en"),
      consented (Boolean, not null), consented_at (DateTime, server_default=func.now()),
      ip_address (String, nullable), withdrawn (Boolean, default=False),
      withdrawn_at (DateTime, nullable)

    **src/models/audit_log.py:** AuditLog model (extends NonTenantModel -- audit logs need cross-tenant admin access):
    - class OperationType(str, Enum): CREATE, READ, UPDATE, DELETE
    - __tablename__ = "audit_logs"
    - tenant_id (String, index=True, not null), user_id (String, index=True, nullable),
      operation (Enum(OperationType), not null), table_name (String, not null),
      record_id (String, not null), changes (Text, nullable -- JSON string),
      ip_address (String, nullable), user_agent (String, nullable),
      timestamp (DateTime(timezone=True), server_default=func.now(), not null)

    **src/schemas/user.py:** Pydantic schemas:
    - UserCreate(BaseModel): email (EmailStr), password (str, min_length=8), full_name (str, min 2 max 100),
      phone (str, optional), preferred_language (str, default="en"), municipality_code (str)
    - UserResponse(BaseModel): id, email, full_name, phone, preferred_language, role, is_active, created_at
      model_config = ConfigDict(from_attributes=True)
    - UserInDB(UserResponse): hashed_password (excluded from response via model serialization)

    **src/schemas/auth.py:** Auth schemas:
    - LoginRequest(BaseModel): email (EmailStr), password (str)
    - TokenResponse(BaseModel): access_token (str), refresh_token (str), token_type (str = "bearer")
    - TokenPayload(BaseModel): sub (str), tenant_id (str), role (str), exp (int)

    **src/schemas/consent.py:** Consent schemas:
    - ConsentCreate(BaseModel): purpose (str), purpose_description (str), language (str = "en"), consented (bool)
    - ConsentResponse(BaseModel): id, purpose, consented, consented_at, withdrawn
      model_config = ConfigDict(from_attributes=True)

    **src/api/deps.py:** Create placeholder dependency stubs (will be completed in Plan 02):
    - async def get_db() -- re-export from database.py
    - Comment: # Auth dependencies added in Plan 02

    **src/main.py:** Create FastAPI application:
    - app = FastAPI(title="SALGA Trust Engine", version="0.1.0", description="AI-powered municipal service management platform")
    - Add /health endpoint returning {"status": "healthy", "version": "0.1.0"}
    - Import and include placeholder router structure (empty v1 router for now)
    - Add lifespan handler that logs startup/shutdown

    **tests/conftest.py:** Create test configuration:
    - Create async test fixtures using pytest-asyncio
    - Override get_db to use test database (append "_test" to DATABASE_URL)
    - Create TestClient fixture using httpx.AsyncClient
    - Set ENVIRONMENT=test in test settings
  </action>
  <verify>
    Run: python -c "from src.core.config import settings; print(f'Config loaded: {settings.ENVIRONMENT}')"
    Run: python -c "from src.models.user import User, UserRole; print(f'Roles: {[r.value for r in UserRole]}')"
    Run: python -c "from src.main import app; print(f'App: {app.title}')"
  </verify>
  <done>
    All models importable with correct fields. Settings loads from .env. FastAPI app instantiates.
    User model has all 5 roles (citizen, field_worker, manager, admin, saps_liaison).
    TenantAwareModel has tenant_id + audit fields. Municipality model exists with code field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Alembic setup and initial database migration</name>
  <files>
    alembic.ini
    alembic/env.py
    alembic/script.py.mako
    alembic/versions/.gitkeep
  </files>
  <action>
    Initialize Alembic with async support:
    - Run: alembic init -t async alembic (creates alembic directory with async template)
    - If the async template is not available, run `alembic init alembic` and modify env.py manually for async

    **alembic.ini:** Update sqlalchemy.url to use environment variable:
    - Set sqlalchemy.url = (leave empty, will be overridden in env.py)
    - Set file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

    **alembic/env.py:** Configure for async SQLAlchemy:
    - Import all models: from src.models.base import Base
    - Import from src.models import user, municipality, consent, audit_log (to register models with metadata)
    - Import settings: from src.core.config import settings
    - Set target_metadata = Base.metadata
    - Override sqlalchemy.url with settings.DATABASE_URL in run_migrations_online()
    - Use async engine: create_async_engine(settings.DATABASE_URL)
    - Implement run_async_migrations() pattern from SQLAlchemy docs

    Generate initial migration:
    - Run: alembic revision --autogenerate -m "initial_schema_municipalities_users_consent_audit"
    - Verify migration file creates all 4 tables: municipalities, users, consent_records, audit_logs

    Apply migration:
    - Run: alembic upgrade head
    - Verify tables exist in database

    Create alembic/versions/.gitkeep to ensure the versions directory is tracked.

    IMPORTANT: If PostgreSQL is not running locally, create the migration file but skip `alembic upgrade head`. Document in output that user needs PostgreSQL running. The migration file itself is the critical artifact.
  </action>
  <verify>
    Run: alembic check (should show "No new upgrade operations detected" if migration was applied)
    OR if DB not available: verify migration file exists in alembic/versions/ and contains create_table operations for all 4 tables.
    Run: python -c "from alembic.config import Config; c = Config('alembic.ini'); print('Alembic config OK')"
  </verify>
  <done>
    Alembic initialized with async config. Initial migration file exists creating municipalities, users, consent_records, and audit_logs tables.
    env.py imports all models and uses settings.DATABASE_URL. Migration can be applied when PostgreSQL is available.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.main import app; print(app.title)"` prints "SALGA Trust Engine"
2. `python -c "from src.models.user import UserRole; print([r.value for r in UserRole])"` prints all 5 roles
3. `python -c "from src.core.config import settings; assert len(settings.SECRET_KEY) >= 32"` passes
4. Alembic migration file exists in alembic/versions/
5. Project structure matches research recommended layout
</verification>

<success_criteria>
- FastAPI app starts with uvicorn and serves /health endpoint
- All 4 data models (Municipality, User, ConsentRecord, AuditLog) are importable with correct fields
- Settings loads from .env with validation
- Alembic migration creates all tables
- Test conftest.py provides async fixtures
- All 5 user roles defined: citizen, field_worker, manager, admin, saps_liaison
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-01-SUMMARY.md`
</output>
