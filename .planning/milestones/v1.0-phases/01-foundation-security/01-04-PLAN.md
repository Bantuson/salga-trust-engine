---
phase: 01-foundation-security
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/core/audit.py
  - src/api/v1/data_rights.py
  - src/api/v1/consent.py
  - src/main.py
  - tests/test_popia.py
  - tests/test_audit.py
autonomous: true

must_haves:
  truths:
    - "Every INSERT, UPDATE, DELETE operation on tenant-aware models is automatically logged to audit_logs table"
    - "User can request export of all their personal data via GET /api/v1/data-rights/my-data"
    - "User can request account deletion via DELETE /api/v1/data-rights/delete-account which anonymizes PII"
    - "User can view their consent records and withdraw consent"
    - "Audit logs capture user_id, tenant_id, operation type, table name, and changes diff"
  artifacts:
    - path: "src/core/audit.py"
      provides: "SQLAlchemy event listeners for automatic audit logging"
      contains: "after_flush"
    - path: "src/api/v1/data_rights.py"
      provides: "POPIA data access and deletion endpoints"
      exports: ["router"]
    - path: "src/api/v1/consent.py"
      provides: "Consent management endpoints"
      exports: ["router"]
    - path: "tests/test_popia.py"
      provides: "POPIA rights endpoint tests"
      contains: "test_data_access"
    - path: "tests/test_audit.py"
      provides: "Audit logging tests"
      contains: "test_audit_log_created"
  key_links:
    - from: "src/core/audit.py"
      to: "src/models/audit_log.py"
      via: "creates AuditLog records on data changes"
      pattern: "AuditLog"
    - from: "src/api/v1/data_rights.py"
      to: "src/api/deps.py"
      via: "requires authenticated user"
      pattern: "get_current_active_user"
    - from: "src/api/v1/data_rights.py"
      to: "src/models/user.py"
      via: "anonymizes user PII on deletion"
      pattern: "is_deleted.*True"
    - from: "src/core/audit.py"
      to: "src/core/tenant.py"
      via: "captures tenant context in audit entries"
      pattern: "get_tenant_context"
---

<objective>
Implement comprehensive audit logging on all data operations and POPIA compliance endpoints for data access rights (right to access personal data, right to deletion/anonymization, consent management and withdrawal).

Purpose: SEC-07 requires audit logging on all operations. SEC-03 and PLAT-07 require functional POPIA data rights. These are legal compliance requirements -- without them the platform cannot legally process South African citizens' personal data.
Output: Automatic audit trail on all data changes, working POPIA data export and deletion endpoints, consent management API.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive audit logging with SQLAlchemy event listeners</name>
  <files>
    src/core/audit.py
    src/main.py
    tests/test_audit.py
  </files>
  <action>
    **src/core/audit.py:** Implement automatic audit logging using SQLAlchemy session events:

    Use the `after_flush` event (NOT after_insert/after_update individually) to capture all changes in a single event handler. This is more reliable and captures the full picture of a transaction.

    Implementation approach:
    1. Listen to Session "after_flush" event
    2. Inspect session.new (inserts), session.dirty (updates), session.deleted (deletes)
    3. For each changed object that inherits from TenantAwareModel or NonTenantModel:
       - Determine OperationType (CREATE/UPDATE/DELETE)
       - For UPDATEs: Use sqlalchemy.inspect(obj).attrs to get history of changed attributes.
         Build changes dict: {"field_name": {"old": old_value, "new": new_value}} for each changed field.
         Skip unchanged fields. Serialize datetime/enum values to strings.
       - Create AuditLog record with:
         tenant_id: from get_tenant_context() or from the object's tenant_id attribute
         user_id: from a request-scoped context variable (create current_user_id ContextVar in audit.py)
         operation: OperationType enum value
         table_name: obj.__tablename__
         record_id: str(obj.id)
         changes: json.dumps(changes_dict) or None for CREATE
         ip_address: from request-scoped context variable
       - IMPORTANT: Add audit log to a SEPARATE session/connection to avoid recursive triggers.
         Use connection.execute(insert(AuditLog).values(...)) directly instead of session.add().

    4. Create helper function to set audit context per request:
       - current_user_id: ContextVar[Optional[str]] (set by auth dependency)
       - current_ip_address: ContextVar[Optional[str]] (set by middleware)
       - def set_audit_context(user_id: str, ip_address: str)
       - def clear_audit_context()

    5. Integrate audit context setting into get_current_user dependency (in deps.py):
       After extracting user from token, call set_audit_context(user.id, request.client.host)
       Update deps.py to accept Request parameter and set audit context.

    6. EXCLUDE audit_logs table itself from audit logging (prevent infinite recursion).
       Check: if obj.__tablename__ == "audit_logs": skip.

    **src/main.py:** Import audit module to register event listeners:
    - Add: import src.core.audit  # noqa: F401 -- registers SQLAlchemy event listeners on import

    **tests/test_audit.py:** Create audit tests:
    - test_audit_log_on_user_create: Create a user, verify AuditLog entry exists with operation=CREATE
    - test_audit_log_on_user_update: Update user.full_name, verify AuditLog with operation=UPDATE and changes showing old/new values
    - test_audit_log_captures_tenant: Verify audit entry has correct tenant_id
    - test_audit_log_no_recursion: Verify creating AuditLog doesn't trigger another AuditLog (no infinite loop)
    - test_audit_context_vars: Set audit context, verify user_id and ip_address are captured
  </action>
  <verify>
    Run: pytest tests/test_audit.py -v
    Run: python -c "
from src.core.audit import set_audit_context, current_user_id, current_ip_address
set_audit_context('test-user', '127.0.0.1')
assert current_user_id.get() == 'test-user'
print('Audit context OK')
"
  </verify>
  <done>
    SQLAlchemy after_flush listener automatically creates AuditLog entries for all INSERT/UPDATE/DELETE operations on all models (except audit_logs table itself). Changes are captured as JSON diffs for UPDATE operations. Audit context (user_id, ip_address) is captured from request-scoped context variables. No infinite recursion. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: POPIA data rights and consent management endpoints</name>
  <files>
    src/api/v1/data_rights.py
    src/api/v1/consent.py
    src/main.py
    tests/test_popia.py
  </files>
  <action>
    **src/api/v1/data_rights.py:** Create data rights router with APIRouter(prefix="/api/v1/data-rights", tags=["POPIA Data Rights"]):

    GET /my-data (POPIA Right to Access - SEC-03):
    - Depends(get_current_active_user)
    - Apply rate limit: @limiter.limit(DATA_EXPORT_RATE_LIMIT) -- 5/hour to prevent abuse
    - Gather ALL personal data held about the user across all tables:
      1. User profile (full_name, email, phone, preferred_language, role, created_at)
      2. Consent records (all purposes, consent status, timestamps)
      3. Audit logs where user_id matches (their activity trail)
    - Return structured JSON with sections: {"profile": {...}, "consent_records": [...], "activity_log": [...]}
    - Log this access request in audit log (operation=READ, table="users", note="POPIA data access request")

    DELETE /delete-account (POPIA Right to Deletion - SEC-03):
    - Depends(get_current_active_user)
    - Apply rate limit: 1/day to prevent accidental deletion
    - Accept optional body: {"confirmation": "DELETE MY ACCOUNT"} -- require explicit confirmation string
    - Soft-delete the user (set is_deleted=True, deleted_at=now())
    - Anonymize PII fields:
      email -> "deleted_{user_id}@anonymized.local"
      full_name -> "Deleted User"
      phone -> None
      hashed_password -> invalidated hash (set to empty string -- prevents login)
    - Mark all consent records as withdrawn (withdrawn=True, withdrawn_at=now())
    - DO NOT delete audit logs (legal requirement to retain for forensics)
    - Log deletion in audit log
    - Return 200 with {"status": "account_deleted", "message": "Your personal data has been anonymized"}

    **src/api/v1/consent.py:** Create consent router with APIRouter(prefix="/api/v1/consent", tags=["Consent Management"]):

    GET / (list user's consent records):
    - Depends(get_current_active_user)
    - Return all ConsentRecord entries for current user
    - Include both active and withdrawn consents

    POST / (record new consent):
    - Depends(get_current_active_user)
    - Accept ConsentCreate schema (purpose, purpose_description, language, consented)
    - Set user_id, tenant_id, ip_address from request context
    - Return 201 with ConsentResponse

    POST /{consent_id}/withdraw (withdraw consent):
    - Depends(get_current_active_user)
    - Look up consent by ID, verify belongs to current user (not just any user in tenant)
    - Set withdrawn=True, withdrawn_at=now()
    - Return 200 with updated ConsentResponse
    - NOTE: Withdrawal does not retroactively delete data processed under prior consent (per POPIA)

    **src/main.py:** Register new routers:
    - app.include_router(data_rights_router)
    - app.include_router(consent_router)

    **tests/test_popia.py:** Create POPIA compliance tests:
    - test_data_access_returns_all_user_data: Register user, verify /my-data returns profile + consents
    - test_data_access_requires_auth: Unauthenticated request to /my-data returns 401
    - test_delete_account_anonymizes_pii: Delete account, verify email/name/phone anonymized in DB
    - test_delete_account_requires_confirmation: Missing confirmation string returns 422
    - test_deleted_user_cannot_login: After deletion, login with old credentials fails
    - test_consent_list: User sees their consent records
    - test_consent_withdraw: User can withdraw consent, verify withdrawn=True
    - test_consent_belongs_to_user: User cannot withdraw another user's consent (returns 404)
    - test_audit_logs_preserved_after_deletion: After account deletion, audit logs still exist
  </action>
  <verify>
    Run: pytest tests/test_popia.py -v
    If database not available, verify endpoints appear in docs:
    - uvicorn src.main:app --reload
    - Check /docs shows data-rights and consent endpoints
  </verify>
  <done>
    GET /api/v1/data-rights/my-data exports all user personal data (POPIA right to access). DELETE /api/v1/data-rights/delete-account anonymizes PII and soft-deletes user (POPIA right to deletion). Consent management allows listing, creating, and withdrawing consent. Audit logs preserved after deletion. All POPIA tests pass. SEC-03 and PLAT-07 satisfied.
  </done>
</task>

</tasks>

<verification>
1. Creating a user generates an AuditLog entry with operation=CREATE
2. Updating a user generates an AuditLog entry with changes JSON showing old/new values
3. GET /api/v1/data-rights/my-data returns user's profile, consents, and activity log
4. DELETE /api/v1/data-rights/delete-account anonymizes email, name, phone and prevents login
5. Consent withdrawal marks consent as withdrawn without deleting prior processing records
6. Audit logs are NOT deleted when user account is deleted
</verification>

<success_criteria>
- Audit logging is automatic on all model changes (no manual log calls needed)
- POPIA data access returns comprehensive personal data export
- POPIA deletion anonymizes PII while preserving audit trail
- Consent management supports list, create, and withdraw operations
- All POPIA and audit tests pass
- Rate limits prevent abuse of data export endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-04-SUMMARY.md`
</output>
