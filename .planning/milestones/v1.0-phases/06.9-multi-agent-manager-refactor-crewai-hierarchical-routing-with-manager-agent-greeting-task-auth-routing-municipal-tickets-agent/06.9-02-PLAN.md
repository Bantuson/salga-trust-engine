---
phase: "06.9"
plan: 2
type: execute
wave: 2
depends_on: ["06.9-01"]
files_modified:
  - src/agents/crews/manager_crew.py
  - src/agents/crews/__init__.py
autonomous: true
requirements:
  - AI-01
  - AI-02
  - AI-06

must_haves:
  truths:
    - "ManagerCrew uses Process.hierarchical with a custom manager_agent (Gugu persona)"
    - "Manager agent receives all incoming messages and classifies intent via LLM (no keyword lists)"
    - "Manager delegates to specialist agents by exact role string via CrewAI delegate_work tool"
    - "Both manager_agent and manager_llm are set to get_deepseek_llm() to prevent OpenAI fallback"
    - "Manager agent has no tools and allow_delegation=True; specialists have allow_delegation=False"
    - "5 routing categories supported: greeting, municipal_report, gbv_report, ticket_status, auth"
    - "Off-topic messages get warm redirect from Gugu explaining the platform scope"
  artifacts:
    - path: "src/agents/crews/manager_crew.py"
      provides: "ManagerCrew orchestrator with Process.hierarchical"
      contains: "class ManagerCrew"
      min_lines: 80
  key_links:
    - from: "src/agents/crews/manager_crew.py"
      to: "src/agents/config/agents.yaml"
      via: "YAML config loading for all 5 agents"
      pattern: "agents_config"
    - from: "src/agents/crews/manager_crew.py"
      to: "src/agents/config/tasks.yaml"
      via: "YAML config loading for manager_task"
      pattern: "tasks_config"
    - from: "src/agents/crews/manager_crew.py"
      to: "src/agents/llm.py"
      via: "DeepSeek LLM factory"
      pattern: "get_deepseek_llm"
---

<objective>
Build the ManagerCrew — the core routing engine that replaces keyword-based IntakeFlow classification with LLM-based intent classification via CrewAI's Process.hierarchical. The manager agent (Gugu persona) receives all citizen messages, classifies intent into 5 categories, and delegates to the correct specialist agent.

Purpose: This is the central architectural change of Phase 6.9 — moving from keyword lists to full LLM-based routing via a native CrewAI manager agent. Per locked decision, uses Process.hierarchical (not custom routing code).

Output: src/agents/crews/manager_crew.py with ManagerCrew class.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-01-SUMMARY.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-RESEARCH.md
@src/agents/crews/base_crew.py
@src/agents/crews/auth_crew.py
@src/agents/crews/municipal_crew.py
@src/agents/crews/gbv_crew.py
@src/agents/config/agents.yaml
@src/agents/config/tasks.yaml
@src/agents/llm.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManagerCrew with Process.hierarchical and all specialist agents</name>
  <files>
    src/agents/crews/manager_crew.py
  </files>
  <action>
    Create `src/agents/crews/manager_crew.py` — the core manager crew that handles all first-contact routing.

    **IMPORTANT: This does NOT inherit from BaseCrew.** BaseCrew is for specialist crews with a single agent + single task + Process.sequential. ManagerCrew uses Process.hierarchical with a manager_agent and multiple specialist agents as coworkers. It builds its own Crew from scratch.

    **Class structure:**

    ```python
    class ManagerCrew:
        """Manager crew that handles all first-contact citizen routing.

        Uses Process.hierarchical with a custom manager_agent (Gugu persona).
        The manager classifies intent via LLM and delegates to specialist agents:
        - Citizen Authentication Specialist (auth)
        - Municipal Services Intake Specialist (municipal reports)
        - Crisis Support Specialist (GBV)
        - Ticket Status Specialist (ticket lookup)
        """

        def __init__(self, language: str = "en", llm=None):
            self.language = language if language in ("en", "zu", "af") else "en"
            self._llm = llm  # Lazy: resolved in create_crew() if None

            # Load YAML configs ONCE
            config_dir = Path(__file__).parent.parent / "config"
            with open(config_dir / "agents.yaml", "r", encoding="utf-8") as f:
                self.agents_config = yaml.safe_load(f)
            with open(config_dir / "tasks.yaml", "r", encoding="utf-8") as f:
                self.tasks_config = yaml.safe_load(f)

        @property
        def llm(self):
            if self._llm is None:
                from src.agents.llm import get_deepseek_llm
                self._llm = get_deepseek_llm()
            return self._llm
    ```

    **create_crew(self, context: dict) -> Crew method:**

    1. Load manager_agent config from self.agents_config["manager_agent"]. Build the manager Agent with:
       - role, goal (format with language), backstory from YAML
       - llm=self.llm
       - allow_delegation=True (CRITICAL)
       - tools=[] (CRITICAL: manager MUST NOT have tools — causes exceptions in hierarchical mode per research Pitfall)
       - max_iter from YAML config
       - verbose=False

    2. Build 4 specialist Agents from YAML config, each with allow_delegation=False:
       - Auth agent: role from agents_config["auth_agent"]["role"], goal, backstory. Tools: [send_otp_tool, verify_otp_tool, create_supabase_user_tool, lookup_user_tool] (from src.agents.tools.auth_tool). Get language prompt from AuthCrew.get_language_prompt pattern — import AUTH_PROMPTS from src.agents.prompts.auth and append to backstory.
       - Municipal agent: role from agents_config["municipal_intake_agent"]["role"], goal, backstory. Tools: [create_municipal_ticket] (from src.agents.tools.ticket_tool). Get language prompt from MUNICIPAL_INTAKE_PROMPTS.
       - GBV agent: role from agents_config["gbv_agent"]["role"], goal, backstory. Tools: [create_municipal_ticket, notify_saps]. Get language prompt from GBV_INTAKE_PROMPTS.
       - Ticket status agent: role from agents_config["ticket_status_agent"]["role"], goal, backstory. Tools: [lookup_ticket] (from src.agents.tools.ticket_lookup_tool).

       All specialists: llm=self.llm, allow_delegation=False, verbose=False, max_iter from their YAML config.

    3. Build the manager Task using self.tasks_config["manager_task"]["description"].format(**context) for the description. Set expected_output from YAML. Assign agent=manager_agent.

    4. Build the Crew:
       ```python
       crew = Crew(
           agents=[auth_agent, municipal_agent, gbv_agent, ticket_status_agent],
           tasks=[manager_task],  # ONE task only
           manager_agent=manager_agent,
           manager_llm=self.llm,  # BOTH manager_agent AND manager_llm — prevent OpenAI fallback
           process=Process.hierarchical,
           memory=False,
           verbose=False,
       )
       ```

    **async kickoff(self, context: dict) -> dict method:**
    - Same async pattern as BaseCrew: `loop.run_in_executor(None, lambda: crew.kickoff(inputs=context))`
    - Parse result: extract Final Answer if present (same regex as BaseCrew.parse_result), return dict with "message", "raw_output", and any routing metadata.
    - On exception: return error dict with warm Gugu fallback message.

    **parse_result(self, result) -> dict method:**
    - Extract raw string from result
    - Search for "Final Answer:" marker, extract content after it
    - Return {"message": clean_text, "raw_output": raw_str}
    - If JSON blob with tracking_number found, include in result dict

    **get_error_response(self, error) -> dict method:**
    - Return {"error": str(error), "message": "I'm Gugu from SALGA Trust Engine. Something went wrong on my side - please try again in a moment."}

    **CRITICAL IMPLEMENTATION NOTES:**
    - The specialist agents in the `agents=[]` list are the manager's "coworkers" — the manager delegates to them via the delegate_work tool (automatically added in hierarchical mode).
    - The manager task description from YAML MUST reference specialist agents by their EXACT role strings: "Citizen Authentication Specialist", "Municipal Services Intake Specialist", "Crisis Support Specialist", "Ticket Status Specialist".
    - The manager_task description is the routing logic — it tells the LLM how to classify intent and when to delegate vs respond directly.
  </action>
  <verify>
    Run: `python -c "from src.agents.crews.manager_crew import ManagerCrew; print('ManagerCrew imported')"` — should succeed.
    Run: `python -c "from src.agents.crews.manager_crew import ManagerCrew; mc = ManagerCrew(language='en'); print(type(mc))"` — should print the class.
  </verify>
  <done>
    ManagerCrew exists with Process.hierarchical, custom manager_agent (Gugu persona, no tools, allow_delegation=True), all 4 specialist agents as coworkers (allow_delegation=False), single manager_task with LLM-based routing logic, both manager_agent and manager_llm set to DeepSeek LLM, async kickoff pattern. All role strings match YAML config exactly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ManagerCrew to crews __init__.py exports</name>
  <files>
    src/agents/crews/__init__.py
  </files>
  <action>
    Update `src/agents/crews/__init__.py` to import and export ManagerCrew:

    Add: `from src.agents.crews.manager_crew import ManagerCrew`
    Update __all__ to include "ManagerCrew".

    The final __init__.py should export: AuthCrew, GBVCrew, MunicipalCrew, TicketStatusCrew, ManagerCrew.

    Note: TicketStatusCrew was already added in Plan 01. This task adds ManagerCrew.
  </action>
  <verify>
    Run: `python -c "from src.agents.crews import ManagerCrew, TicketStatusCrew, AuthCrew, GBVCrew, MunicipalCrew; print('All 5 crews importable')"` — should succeed.
  </verify>
  <done>
    All 5 crews (AuthCrew, GBVCrew, MunicipalCrew, TicketStatusCrew, ManagerCrew) importable from src.agents.crews.
  </done>
</task>

</tasks>

<verification>
1. ManagerCrew imports successfully: `python -c "from src.agents.crews.manager_crew import ManagerCrew; print('OK')"`
2. ManagerCrew can instantiate without calling LLM: `python -c "from src.agents.crews.manager_crew import ManagerCrew; mc = ManagerCrew('en'); print(type(mc))"`
3. All 5 crews importable from __init__: `python -c "from src.agents.crews import ManagerCrew, TicketStatusCrew, AuthCrew, GBVCrew, MunicipalCrew; print('All imports OK')"`
4. Existing tests still pass: `python -m pytest tests/test_municipal_crew.py tests/test_gbv_crew.py -x`
</verification>

<success_criteria>
- ManagerCrew uses Process.hierarchical with manager_agent (not sequential)
- Manager agent has no tools, allow_delegation=True
- All 4 specialist agents have allow_delegation=False with correct tools
- Both manager_agent and manager_llm set to get_deepseek_llm()
- Manager task description references exact specialist role strings
- 5 routing categories: greeting, municipal_report, gbv_report, ticket_status, auth
- Off-topic handled with warm Gugu redirect
- All 5 crews exported from __init__.py
</success_criteria>

<output>
After completion, create `.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-02-SUMMARY.md`
</output>
