---
phase: "06.9"
plan: 1
subsystem: "agentic-ai"
tags: ["crewai", "multi-agent", "manager-architecture", "ticket-status", "conversation-state"]
dependency_graph:
  requires: []
  provides:
    - "ConversationState.pending_intent (cross-turn routing field)"
    - "ConversationState.pre_auth_message (auth handoff field)"
    - "ConversationState.routing_phase (session ownership field)"
    - "lookup_ticket CrewAI tool (user-scoped ticket queries)"
    - "TicketStatusCrew specialist crew"
    - "manager_agent YAML config (allow_delegation=true)"
    - "ticket_status_agent YAML config"
    - "manager_task YAML template (4-step routing logic)"
    - "ticket_status_task YAML template"
  affects:
    - "src/agents/crews/base_crew.py (via YAML config loading)"
    - "src/agents/flows/intake_flow.py (via ConversationState)"
    - "src/agents/crews/gbv_crew.py (gbv_intake_task fix)"
tech_stack:
  added: []
  patterns:
    - "BaseCrew subclass with agent_key/task_key/tools/memory_enabled pattern"
    - "CrewAI @tool decorator wrapping implementation function"
    - "Trilingual language prompt dict (EN/ZU/AF) injected as backstory extension"
    - "YAML-first agent config with allow_delegation for hierarchical process"
key_files:
  created:
    - path: "src/agents/tools/ticket_lookup_tool.py"
      purpose: "User-scoped ticket lookup CrewAI tool with SEC-05 GBV minimal info"
    - path: "src/agents/crews/ticket_status_crew.py"
      purpose: "TicketStatusCrew specialist for citizen ticket status queries"
  modified:
    - path: "src/core/conversation.py"
      change: "Added pending_intent, pre_auth_message, routing_phase fields to ConversationState"
    - path: "src/agents/config/agents.yaml"
      change: "Added manager_agent and ticket_status_agent entries (5 agents total)"
    - path: "src/agents/config/tasks.yaml"
      change: "Added gbv_intake_task (bug fix), manager_task, ticket_status_task (4 tasks total)"
    - path: "src/agents/crews/__init__.py"
      change: "Added TicketStatusCrew to exports"
decisions:
  - "routing_phase defaults to 'manager' — ensures all existing sessions remain manager-owned without migration"
  - "lookup_ticket asserts user_id truthy — defense-in-depth since admin client bypasses Supabase RLS"
  - "GBV/sensitive tickets return minimal info pattern consistent with citizen portal card (Phase 06.2-08)"
  - "TicketStatusCrew memory_enabled=False — lookup results contain user ticket data (PII consideration)"
  - "manager_agent allow_delegation=true — required for CrewAI hierarchical process delegation pattern"
  - "manager_task has pending_intent placeholder — enables direct specialist routing post-auth"
  - "gbv_intake_task added to tasks.yaml — auto-fixed pre-existing bug (GBVCrew was broken on create_crew)"
metrics:
  duration_seconds: 2299
  duration_human: "38.3 minutes"
  tasks_completed: 2
  files_created: 2
  files_modified: 4
  completed_date: "2026-02-18"
---

# Phase 06.9 Plan 01: Foundational Components for Manager Architecture Summary

**One-liner:** Extended ConversationState with 3 routing fields, created user-scoped lookup_ticket tool with SEC-05 GBV minimal info, built TicketStatusCrew specialist, and added full YAML config for manager + ticket_status agents/tasks (5 agents, 4 tasks total).

## What Was Built

This plan creates the foundational building blocks for Phase 6.9's multi-agent manager architecture. The ManagerCrew (Plan 02) and integration layer (Plan 03) depend on these components.

### ConversationState Extensions (src/core/conversation.py)

Three new optional fields added to the Pydantic model:

- **`pending_intent: str | None = None`** — Stores classified citizen intent ("municipal_report" | "gbv_report" | "ticket_status") during auth handoff. After auth completes, the manager can route directly to the correct specialist without the citizen needing to repeat their request.

- **`pre_auth_message: str | None = None`** — The original citizen message that triggered auth. Restored to the specialist after auth completion for proper context.

- **`routing_phase: str = "manager"`** — Tracks session ownership: "manager" | "auth" | "municipal" | "gbv" | "ticket_status". crew_server.py will use this to short-circuit manager re-entry when a specialist session is active.

All fields follow the existing Pydantic BaseModel pattern and serialize/deserialize transparently through the existing `model_dump_json/model_validate_json` round-trip.

### ticket_lookup_tool (src/agents/tools/ticket_lookup_tool.py)

New CrewAI tool following the `ticket_tool.py` pattern exactly:

- **Security boundary**: `assert user_id` at function entry — defense-in-depth since Supabase admin client bypasses RLS
- **User-scoped queries**: Always includes `.eq("user_id", user_id)` — no cross-user access possible
- **GBV minimal info (SEC-05)**: `is_sensitive=True` tickets return only `{tracking_number, category: "sensitive report", status, note: "SAPS 10111 | GBV Helpline 0800 150 150"}` — consistent with citizen portal GBV card pattern
- **Optional tracking number filter**: If `tracking_number` provided, adds `.eq("tracking_number", tracking_number.strip().upper())`
- **Returns up to 10 most recent tickets** ordered by created_at descending
- Wrapped with `@tool("lookup_ticket")` decorator matching the `create_municipal_ticket` pattern

### TicketStatusCrew (src/agents/crews/ticket_status_crew.py)

New specialist crew following the BaseCrew pattern:

```python
class TicketStatusCrew(BaseCrew):
    agent_key = "ticket_status_agent"
    task_key = "ticket_status_task"
    tools = [lookup_ticket]
    memory_enabled = False  # No PII in memory
```

- Trilingual `get_language_prompt()` with EN/ZU/AF prompts covering display rules, GBV minimal info instructions, and warm tone guidance
- `build_kickoff_inputs()` passes: user_id, language, tracking_number, conversation_history
- `parse_result()` calls `super().parse_result()` then adds `"agent": "ticket_status"` to result dict
- `get_error_response()` returns warm Gugu error message consistent with MunicipalCrew pattern

### YAML Configuration (agents.yaml + tasks.yaml)

**agents.yaml** now has 5 entries:
- `auth_agent` (existing)
- `municipal_intake_agent` (existing)
- `gbv_agent` (existing)
- **`manager_agent`** (new) — `allow_delegation: true`, `max_iter: 5`, full Gugu persona with routing focus
- **`ticket_status_agent`** (new) — `allow_delegation: false`, `max_iter: 5`, Gugu persona with ticket lookup focus

**tasks.yaml** now has 4 entries:
- `municipal_intake_task` (existing)
- `auth_task` (existing)
- `gbv_intake_task` (auto-fixed — was missing, causing GBVCrew to break on `create_crew()`)
- **`manager_task`** (new) — 4-step routing: GREET → CLASSIFY INTENT → AUTH CHECK → DELEGATE
- **`ticket_status_task`** (new) — lookup tool instructions with GBV minimal info rules

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed missing gbv_intake_task in tasks.yaml**
- **Found during:** Task 2 verification (running existing test suite)
- **Issue:** `GBVCrew.task_key = "gbv_intake_task"` but this key was never added to tasks.yaml. Any call to `GBVCrew.create_crew()` raised `KeyError: 'gbv_intake_task'`. This was causing 3 existing tests to fail.
- **Fix:** Added `gbv_intake_task` entry to tasks.yaml with trauma-informed protocol (safety first, essentials only, max 3-4 questions, emergency numbers in every response).
- **Files modified:** `src/agents/config/tasks.yaml`
- **Commit:** d30a0aa

### Out-of-Scope Pre-existing Failures (Deferred)

6 municipal crew test failures exist that predate this plan — they patch `ticket_tool._get_sync_engine` which no longer exists (Supabase refactor removed it). Documented in `deferred-items.md`.

## Self-Check: PASSED

### Files Exist Check
- `src/core/conversation.py` — FOUND, has pending_intent/pre_auth_message/routing_phase fields
- `src/agents/tools/ticket_lookup_tool.py` — FOUND, lookup_ticket tool
- `src/agents/crews/ticket_status_crew.py` — FOUND, TicketStatusCrew class
- `src/agents/config/agents.yaml` — FOUND, 5 agents including manager_agent, ticket_status_agent
- `src/agents/config/tasks.yaml` — FOUND, 4 tasks including manager_task, ticket_status_task
- `src/agents/crews/__init__.py` — FOUND, exports TicketStatusCrew

### Commits Exist Check
- `be6bf52` — Task 1: ConversationState + ticket_lookup_tool
- `d30a0aa` — Task 2: TicketStatusCrew + YAML configs + gbv_intake_task fix

### Verification Results
- `python -c "from src.core.conversation import ConversationState; ..."` — PASSED
- `python -c "from src.agents.tools.ticket_lookup_tool import lookup_ticket; print(type(lookup_ticket))"` — `<class 'crewai.tools.base_tool.Tool'>`
- `python -c "from src.agents.crews import TicketStatusCrew; print('TicketStatusCrew imported')"` — PASSED
- agents.yaml keys: `['auth_agent', 'municipal_intake_agent', 'gbv_agent', 'manager_agent', 'ticket_status_agent']` — PASSED
- tasks.yaml keys: `['gbv_intake_task', 'municipal_intake_task', 'auth_task', 'manager_task', 'ticket_status_task']` — PASSED
- GBV crew tests: 21/21 passed
- ConversationState round-trip serialization: PASSED
