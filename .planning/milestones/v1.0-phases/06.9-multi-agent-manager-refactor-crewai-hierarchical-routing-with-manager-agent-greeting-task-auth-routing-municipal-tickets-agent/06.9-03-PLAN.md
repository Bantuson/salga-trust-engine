---
phase: "06.9"
plan: 3
type: execute
wave: 3
depends_on: ["06.9-02"]
files_modified:
  - src/agents/flows/intake_flow.py
  - src/agents/flows/state.py
  - src/api/v1/crew_server.py
autonomous: true
requirements:
  - AI-03
  - AI-04
  - AI-07

must_haves:
  truths:
    - "IntakeFlow keyword classification replaced entirely by ManagerCrew.kickoff() call"
    - "crew_server.py routes ALL messages through ManagerCrew instead of imperative if/else routing"
    - "routing_phase in ConversationState short-circuits manager re-entry for active specialist sessions"
    - "pending_intent survives auth handoff — citizen does not repeat their request after registration"
    - "Auth is demand-driven: greeting and info questions do NOT require authentication"
    - "Returning authenticated users with active specialist session resume where they left off"
    - "GBV session clearing still occurs after GBV ticket creation (data minimization preserved)"
    - "Response sanitization still applied to all agent output (defense-in-depth preserved)"
  artifacts:
    - path: "src/agents/flows/intake_flow.py"
      provides: "Simplified IntakeFlow delegating to ManagerCrew"
      contains: "ManagerCrew"
    - path: "src/api/v1/crew_server.py"
      provides: "Refactored crew server with manager-based routing"
      contains: "ManagerCrew"
    - path: "src/agents/flows/state.py"
      provides: "IntakeState updated for manager routing"
      contains: "pending_intent"
  key_links:
    - from: "src/api/v1/crew_server.py"
      to: "src/agents/crews/manager_crew.py"
      via: "ManagerCrew import and kickoff call"
      pattern: "from src.agents.crews.manager_crew import ManagerCrew"
    - from: "src/api/v1/crew_server.py"
      to: "src/core/conversation.py"
      via: "ConversationState routing_phase and pending_intent fields"
      pattern: "routing_phase"
    - from: "src/agents/flows/intake_flow.py"
      to: "src/agents/crews/manager_crew.py"
      via: "ManagerCrew delegation"
      pattern: "ManagerCrew"
    - from: "src/api/v1/crew_server.py"
      to: "src/core/conversation.py"
      via: "routing_phase persistence after each turn"
      pattern: "conv_state\\.routing_phase = new_routing_phase"
    - from: "src/api/v1/crew_server.py"
      to: "src/core/conversation.py"
      via: "pending_intent read from conv_state and passed in manager_context"
      pattern: "pending_intent.*getattr\\(conv_state"
---

<objective>
Replace the imperative routing logic in IntakeFlow and crew_server.py with ManagerCrew-based routing. This is the integration layer that wires the new manager agent into the existing webhook pipeline.

Purpose: This completes the architectural migration from keyword-based routing to LLM-based manager agent routing. After this plan, all citizen messages flow through the manager agent for classification and delegation, auth is demand-driven, and pending intent survives auth handoffs.

Output: Refactored intake_flow.py, crew_server.py, and state.py.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-01-SUMMARY.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-02-SUMMARY.md
@.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-RESEARCH.md
@src/api/v1/crew_server.py
@src/agents/flows/intake_flow.py
@src/agents/flows/state.py
@src/core/conversation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor IntakeFlow to delegate to ManagerCrew</name>
  <files>
    src/agents/flows/intake_flow.py
    src/agents/flows/state.py
  </files>
  <action>
    **IntakeState update (src/agents/flows/state.py):**
    Add fields to IntakeState for manager routing compatibility:
    - `session_status: str = Field(default="none", description="Auth session status: none/active/expired")`
    - `user_exists: bool = Field(default=False, description="Whether user exists in database")`
    - `pending_intent: str | None = Field(default=None, description="Saved intent before auth handoff")`
    - `conversation_history: str = Field(default="(none)", description="Formatted conversation history")`
    - `phone: str = Field(default="", description="Citizen phone number")`

    These fields allow IntakeFlow to pass full context to ManagerCrew.

    **IntakeFlow refactor (src/agents/flows/intake_flow.py):**
    Replace the entire keyword classification and routing chain with a single ManagerCrew call.

    Remove:
    - `classify_message()` method (the keyword-based classifier)
    - `route_to_crew()` method (the @router decorator chain)
    - `handle_municipal()` method (direct MunicipalCrew call)
    - `handle_gbv()` method (direct GBVCrew call)
    - All keyword lists (gbv_keywords, municipal_keywords)

    Replace with a single `@start()` method `receive_and_route()`:

    ```python
    @start()
    async def receive_and_route(self) -> dict:
        """Single entry point: detect language, run ManagerCrew.

        Replaces the keyword classification chain with LLM-based manager
        routing. The ManagerCrew handles intent classification, auth checks,
        and specialist delegation internally via Process.hierarchical.
        """
        # Detect language using lingua-py (preserved from old flow)
        detected_language = language_detector.detect(
            self.state.message, fallback="en"
        )
        self.state.language = detected_language
        self.state.turn_count += 1

        # Build context for ManagerCrew
        from src.agents.crews.manager_crew import ManagerCrew

        manager_crew = ManagerCrew(language=detected_language, llm=self._llm)
        result = await manager_crew.kickoff({
            "message": self.state.message,
            "user_id": self.state.user_id,
            "tenant_id": self.state.tenant_id,
            "language": detected_language,
            "phone": self.state.phone,
            "session_status": self.state.session_status,
            "user_exists": str(self.state.user_exists),
            "conversation_history": self.state.conversation_history,
            "pending_intent": self.state.pending_intent or "none",
        })

        # Store result in state
        self.state.ticket_data = result
        self.state.is_complete = True

        return result
    ```

    Keep the __init__ signature and ConversationManager initialization unchanged for backward compatibility with whatsapp_service.py. Keep the imports for ConversationManager and language_detector.

    Remove the @listen and @router decorators — no longer needed since there is a single @start method.

    Update imports: remove `listen, router` from crewai.flow.flow import (keep `Flow, start`). Add import for ManagerCrew (inline to avoid circular deps).
  </action>
  <verify>
    Run: `python -c "from src.agents.flows.intake_flow import IntakeFlow; print('IntakeFlow imports OK')"` — should succeed.
    Run: `python -c "from src.agents.flows.state import IntakeState; s = IntakeState(); assert hasattr(s, 'session_status'); assert hasattr(s, 'pending_intent'); print('IntakeState OK')"` — should succeed.
  </verify>
  <done>
    IntakeFlow has single @start() method delegating to ManagerCrew. Keyword classification completely removed. IntakeState has new fields for manager routing context. No @listen or @router decorators remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor crew_server.py to route through ManagerCrew</name>
  <files>
    src/api/v1/crew_server.py
  </files>
  <action>
    **Replace the imperative if/else routing in the /chat endpoint** with ManagerCrew-based routing. The current flow is:
    - session_status == "active" -> IntakeFlow
    - session_status != "active" -> AuthCrew

    The NEW flow is:
    - Check routing_phase in ConversationState
    - If routing_phase is an active specialist (not "manager"), route directly to that specialist (short-circuit)
    - Otherwise, route through ManagerCrew for classification and delegation

    **Changes to the /chat endpoint (Step 3: Route to agent):**

    Replace the entire `if session_status == "active": ... else: ...` block with:

    ```python
    # Step 3: Route through ManagerCrew (with specialist short-circuit)
    agent_name = "manager"

    # Check if there's an active specialist session to resume
    routing_phase = getattr(conv_state, 'routing_phase', 'manager')

    # Build context dict (shared by both short-circuit and manager paths)
    manager_context = {
        "message": request.message,
        "user_id": detection_result.get("user_id") or phone,
        "tenant_id": (
            request.municipality_id
            or detection_result.get("municipality_id")
            or conv_state.tenant_id
        ),
        "language": detected_language,
        "phone": phone,
        "session_status": session_status,
        "user_exists": str(detection_result.get("user_exists", False)),
        "conversation_history": conversation_history,
        "pending_intent": getattr(conv_state, 'pending_intent', None) or "none",
    }

    # --- SHORT-CIRCUIT: active specialist session ---
    # Per locked decision: specialist keeps control until task completes
    # OR citizen interrupts. If routing_phase is not "manager", route
    # directly to the owning specialist crew (skip manager re-entry).
    if routing_phase != "manager":
        # Map routing_phase values to specialist crews
        _SPECIALIST_MAP = {
            "auth": ("src.agents.crews.auth_crew", "AuthCrew"),
            "municipal": ("src.agents.crews.municipal_crew", "MunicipalCrew"),
            "gbv": ("src.agents.crews.gbv_crew", "GBVCrew"),
            "ticket_status": ("src.agents.crews.ticket_status_crew", "TicketStatusCrew"),
        }
        spec = _SPECIALIST_MAP.get(routing_phase)
        if spec:
            import importlib
            mod = importlib.import_module(spec[0])
            CrewClass = getattr(mod, spec[1])
            specialist_crew = CrewClass(language=detected_language)
            agent_result = await specialist_crew.kickoff(manager_context)
            reply = agent_result.get("message", "")
            agent_name = agent_result.get("agent", routing_phase)
        else:
            # Unknown routing_phase — fall through to manager
            routing_phase = "manager"

    # --- MANAGER PATH: no active specialist, classify via LLM ---
    if routing_phase == "manager":
        from src.agents.crews.manager_crew import ManagerCrew
        manager_crew = ManagerCrew(language=detected_language)
        agent_result = await manager_crew.kickoff(manager_context)

        reply = agent_result.get("message", "")
        agent_name = agent_result.get("agent", "manager")

    # Check for GBV routing
    is_gbv = "gbv" in agent_name.lower() or agent_result.get("category") == "gbv"

    # --- PERSIST routing_phase back to ConversationState ---
    # Without this, routing_phase in Redis would always be "manager"
    # and the short-circuit above would never trigger on subsequent turns.
    new_routing_phase = agent_result.get("routing_phase", "manager")
    conv_state.routing_phase = new_routing_phase
    # Save updated state to Redis/in-memory store
    # (ConversationManager serializes the full model on append_turn in
    # Step 4; but if the specialist returned without appending, we must
    # ensure the field is set BEFORE Step 4's append_turn call persists it.)
    ```

    **Important preservations:**
    - Keep ALL existing code for Steps 1 (session detection), 1.5 (language detection), 1.6 (language preference), 2 (conversation history).
    - Keep Step 3.5 (sanitize_reply) — apply it to the manager result reply.
    - Keep Step 4 (save turn to conversation history).
    - Keep Step 5 (build debug dict with GBV redaction).
    - Keep the sanitize_reply function, _FALLBACK_REPLIES, _LLM_ARTIFACT_PATTERNS, etc. — all still needed.
    - Keep _format_history, _detect_language_preference — still needed.
    - Keep InMemoryConversationManager — still needed for dev mode.
    - Keep _validate_api_key, health_check endpoint, session_reset endpoint — unchanged.

    **Update the debug dict (Step 5):**
    Add "routing_phase" to the non-GBV debug output.

    **Update ChatResponse agent_name field:**
    The agent_name may now be "manager", "auth_agent", "municipal_intake", "gbv_intake", or "ticket_status" depending on which agent the manager delegated to. Keep the existing ChatResponse model — agent_name is already a string field.

    **Add "ticket_status" to the fallback replies:**
    Add a ticket_status entry to _FALLBACK_REPLIES:
    ```python
    "ticket_status": {
        "en": "I'm Gugu from SALGA Trust Engine. I couldn't look up your report right now. Please try again in a moment.",
        "zu": "NginguGugu we-SALGA Trust Engine. Angikwazanga ukubheka umbiko wakho manje. Ngicela uzame futhi ngemva kwesikhashana.",
        "af": "Ek is Gugu van SALGA Trust Engine. Ek kon nie jou verslag nou opsoek nie. Probeer asseblief weer oor 'n oomblik.",
    },
    ```

    **Remove IntakeFlow import and usage from the /chat endpoint** — it is no longer called directly from crew_server. The ManagerCrew handles all routing internally.

    **Remove AuthCrew direct import and usage from the /chat endpoint** — the ManagerCrew delegates to the auth agent internally.

    **Keep the IntakeFlow and AuthCrew imports in the codebase** (other files may use them), but remove from crew_server.py specifically.
  </action>
  <verify>
    Run: `python -c "from src.api.v1.crew_server import crew_app; print('crew_server imports OK')"` — should succeed.
    Run: `python -c "from src.api.v1.crew_server import sanitize_reply; r = sanitize_reply('Hello', 'ticket_status', 'en'); print('sanitize OK:', r)"` — should print a fallback or the input.
  </verify>
  <done>
    crew_server.py routes all messages through ManagerCrew (or short-circuits to active specialist). Imperative if/else routing removed. IntakeFlow and AuthCrew no longer imported or called directly from crew_server. routing_phase is persisted back to conv_state after every turn (conv_state.routing_phase = new_routing_phase). Short-circuit if-block routes directly to specialist when routing_phase != "manager". All existing safety features preserved: sanitization, GBV debug redaction, language detection, conversation history. routing_phase in debug output. ticket_status fallback messages added.
  </done>
</task>

</tasks>

<verification>
1. crew_server.py imports successfully: `python -c "from src.api.v1.crew_server import crew_app; print('OK')"`
2. IntakeFlow imports successfully with new structure: `python -c "from src.agents.flows.intake_flow import IntakeFlow; print('OK')"`
3. No keyword classification remains: `grep -r "gbv_keywords\|municipal_keywords" src/agents/flows/intake_flow.py` should return nothing
4. ManagerCrew is the routing entry point: `grep "ManagerCrew" src/api/v1/crew_server.py` should find the import and usage
5. sanitize_reply still works for all agent types including ticket_status
6. pending_intent read and passed through: `grep "pending_intent" src/api/v1/crew_server.py` should show both the getattr read from conv_state AND inclusion in manager_context
7. routing_phase persisted: `grep "conv_state.routing_phase" src/api/v1/crew_server.py` should confirm the write-back
8. Existing tests pass (EXCLUDE test_intake_flow.py — updated in Plan 04): `python -m pytest tests/test_municipal_crew.py tests/test_gbv_crew.py -x --ignore=tests/test_intake_flow.py`
   **NOTE:** test_intake_flow.py tests removed methods (classify_message, route_to_crew, etc.) and WILL FAIL after this plan. Plan 04 updates these tests. Do NOT run test_intake_flow.py in this plan's verification.
</verification>

<success_criteria>
- IntakeFlow keyword classification completely removed (no gbv_keywords/municipal_keywords lists)
- crew_server.py uses ManagerCrew for ALL message routing (or short-circuits to active specialist)
- routing_phase persisted back to conv_state after every turn (conv_state.routing_phase = new_routing_phase)
- Short-circuit if-block routes directly to specialist when routing_phase != "manager"
- pending_intent read from conv_state and passed in manager_context (survives auth handoff)
- routing_phase field used for specialist session tracking
- GBV session clearing, sanitization, and all safety features preserved
- Health, session reset endpoints unchanged
- All imports work without circular dependency issues
</success_criteria>

<output>
After completion, create `.planning/phases/06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent/06.9-03-SUMMARY.md`
</output>
