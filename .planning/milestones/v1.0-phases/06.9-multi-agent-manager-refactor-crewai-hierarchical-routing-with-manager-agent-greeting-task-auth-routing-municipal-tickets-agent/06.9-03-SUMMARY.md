---
phase: "06.9"
plan: 3
subsystem: "agentic-ai"
tags: ["crewai", "multi-agent", "manager-architecture", "routing", "intake-flow", "crew-server"]
dependency_graph:
  requires:
    - "06.9-02 (ManagerCrew with Process.hierarchical, all 5 crews in __init__.py)"
    - "06.9-01 (ConversationState routing_phase and pending_intent fields, TicketStatusCrew)"
  provides:
    - "Simplified IntakeFlow delegating to ManagerCrew (single @start() method)"
    - "Refactored crew_server.py with ManagerCrew routing + specialist short-circuit"
    - "IntakeState with session_status, user_exists, pending_intent, conversation_history, phone fields"
  affects:
    - "src/agents/flows/intake_flow.py (keyword classification replaced by ManagerCrew)"
    - "src/api/v1/crew_server.py (imperative routing replaced by ManagerCrew + short-circuit)"
    - "src/agents/flows/state.py (new manager routing context fields)"
tech_stack:
  added: []
  patterns:
    - "Single @start() IntakeFlow delegates all routing to ManagerCrew.kickoff()"
    - "crew_server.py short-circuit: routing_phase != 'manager' -> direct specialist, skip LLM re-classification"
    - "routing_phase persisted via explicit save_state() before append_turn() in Step 4"
    - "pending_intent passed through manager_context to survive auth handoffs"
key_files:
  created: []
  modified:
    - path: "src/agents/flows/intake_flow.py"
      change: "Replaced keyword classification chain with single ManagerCrew delegation"
    - path: "src/agents/flows/state.py"
      change: "Added session_status, user_exists, pending_intent, conversation_history, phone fields"
    - path: "src/api/v1/crew_server.py"
      change: "Replaced if/else session routing with ManagerCrew routing + specialist short-circuit + routing_phase persistence"
key-decisions:
  - "routing_phase persisted via explicit save_state() before append_turn() because Redis append_turn re-fetches state, losing the local mutation"
  - "Short-circuit avoids ManagerCrew LLM call for active specialist sessions — routing_phase != 'manager' maps directly to specialist crew class"
  - "_SPECIALIST_MAP uses importlib.import_module for lazy loading — avoids circular imports at module level"
  - "ticket_status fallback messages added to _FALLBACK_REPLIES in all 3 languages for robust error handling"
  - "test_gbv_crew.py TestGBVRoutingInFlow/TestSessionClearing/TestGBVKeywordDetection failures are expected — these test removed IntakeFlow methods (classify_message, route_to_crew, handle_gbv), will be updated in Plan 04"
requirements-completed:
  - "AI-03"
  - "AI-04"
  - "AI-07"
metrics:
  duration_seconds: 2038
  duration_human: "34 minutes"
  tasks_completed: 2
  files_created: 0
  files_modified: 3
  completed_date: "2026-02-18"
---

# Phase 06.9 Plan 03: Integration Layer — IntakeFlow and crew_server Summary

**Replaced keyword-based IntakeFlow routing and imperative crew_server session-switch with ManagerCrew delegation and routing_phase short-circuit, completing the integration layer of the multi-agent manager architecture.**

## Performance

- **Duration:** 34 minutes
- **Started:** 2026-02-18T09:47:22Z
- **Completed:** 2026-02-18T10:21:42Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- IntakeFlow reduced from 216 lines (5 methods, keyword lists, @listen/@router chain) to 80 lines (single @start() method delegating to ManagerCrew)
- crew_server.py Step 3 replaced: imperative `if session_status == "active"` routing (225 LOC) with ManagerCrew routing + specialist short-circuit (83 LOC)
- routing_phase correctly persisted to Redis before append_turn() so short-circuit triggers on subsequent turns
- pending_intent read from conv_state and passed through manager_context — survives auth handoffs without citizen repeating request
- ticket_status fallback messages added in EN/ZU/AF for complete error coverage
- All safety features preserved: GBV debug redaction, response sanitization, language detection, conversation history

## Task Commits

1. **Task 1: Refactor IntakeFlow to delegate to ManagerCrew** - `bc65e0b` (feat)
2. **Task 2: Refactor crew_server.py to route through ManagerCrew** - `84983cb` (feat)

## Files Created/Modified

- `src/agents/flows/intake_flow.py` — Replaced 5-method keyword routing chain with single async `receive_and_route()` @start() method; removed gbv_keywords, municipal_keywords, classify_message, route_to_crew, handle_municipal, handle_gbv
- `src/agents/flows/state.py` — Added session_status, user_exists, pending_intent, conversation_history, phone fields for ManagerCrew context passing
- `src/api/v1/crew_server.py` — Step 3 replaced with ManagerCrew routing + specialist short-circuit (_SPECIALIST_MAP); routing_phase persisted via save_state() + conv_state mutation; ticket_status added to _FALLBACK_REPLIES; routing_phase in debug output; pending_intent read from conv_state

## Decisions Made

- **routing_phase persistence via save_state()**: Redis-backed ConversationManager.append_turn() re-fetches state from Redis, discarding any local mutations. We must explicitly call `save_state()` with the updated routing_phase BEFORE Step 4's append_turn to ensure it persists. InMemoryConversationManager holds object references so the local mutation also persists — save_state is a harmless no-op for it.
- **_SPECIALIST_MAP with importlib.import_module**: Using `importlib.import_module()` for lazy loading specialist crew classes avoids circular imports at module level and keeps the import cost deferred to request time.
- **Expected test failures in test_gbv_crew.py**: TestGBVRoutingInFlow, TestSessionClearing, and TestGBVKeywordDetection test the OLD `classify_message`, `route_to_crew`, and `handle_gbv` methods that were intentionally removed. These 7 tests fail as expected and will be updated in Plan 04. All 14 non-IntakeFlow tests in test_gbv_crew.py pass (14/14).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added explicit save_state() call to persist routing_phase before append_turn()**
- **Found during:** Task 2 (crew_server.py refactor)
- **Issue:** The plan specified `conv_state.routing_phase = new_routing_phase` and stated "ConversationManager serializes the full model on append_turn in Step 4". But ConversationManager.append_turn() re-fetches state from Redis — it does NOT use the local conv_state object. Without an explicit save, routing_phase would never persist and the short-circuit would never trigger.
- **Fix:** Added `if hasattr(manager, 'save_state'): await manager.save_state(conv_state, is_gbv=is_gbv)` immediately after setting `conv_state.routing_phase = new_routing_phase`
- **Files modified:** `src/api/v1/crew_server.py`
- **Verification:** Code review confirms Redis ConversationManager.append_turn() calls get_state() + save_state() internally; the explicit save_state() ensures routing_phase is in Redis before the append_turn re-fetch
- **Committed in:** `84983cb` (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 2 — missing critical functionality)
**Impact on plan:** The explicit save_state() call is essential for routing_phase to survive across turns. Without it, the short-circuit would never trigger. No scope creep.

## Issues Encountered

None beyond the auto-fixed deviation above.

## Self-Check

### Files Exist Check

- `src/agents/flows/intake_flow.py` — FOUND (80 lines, ManagerCrew delegation present)
- `src/agents/flows/state.py` — FOUND (new fields: session_status, user_exists, pending_intent, conversation_history, phone)
- `src/api/v1/crew_server.py` — FOUND (ManagerCrew routing, short-circuit, routing_phase persistence)

### Commits Exist Check

- `bc65e0b` — Task 1: Refactor IntakeFlow to delegate to ManagerCrew — FOUND
- `84983cb` — Task 2: Refactor crew_server.py to route through ManagerCrew — FOUND

### Verification Results

1. `python -c "from src.api.v1.crew_server import crew_app; print('OK')"` — PASSED
2. `python -c "from src.agents.flows.intake_flow import IntakeFlow; print('OK')"` — PASSED
3. `grep "gbv_keywords\|municipal_keywords" src/agents/flows/intake_flow.py` — EMPTY (no keyword classification)
4. `grep "ManagerCrew" src/api/v1/crew_server.py` — FOUND (import + kickoff call)
5. `sanitize_reply('Hello', 'ticket_status', 'en')` — returns Gugu fallback (PASSED)
6. `grep "pending_intent" src/api/v1/crew_server.py` — FOUND (getattr read + manager_context inclusion)
7. `grep "conv_state.routing_phase" src/api/v1/crew_server.py` — FOUND (write-back present)
8. GBV crew non-IntakeFlow tests: 14/14 passed

## Self-Check: PASSED

## Next Phase Readiness

Plan 03 completes the integration layer. The manager architecture is now end-to-end:
- ManagerCrew built (Plan 02)
- IntakeFlow delegates to ManagerCrew (Plan 03)
- crew_server.py routes all messages through ManagerCrew (Plan 03)

Plan 04 (final plan): Update test_intake_flow.py to test the new single @start() method and ManagerCrew delegation.

---
*Phase: 06.9*
*Completed: 2026-02-18*
