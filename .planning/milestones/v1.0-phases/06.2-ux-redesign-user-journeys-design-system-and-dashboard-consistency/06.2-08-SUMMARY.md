---
phase: 06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency
plan: 08
subsystem: backend-api
tags: [models, schemas, api, migration, rls, onboarding, access-requests, invitations, citizen-portal]
dependency_graph:
  requires:
    - Phase 06.1 Supabase Auth migration
    - Phase 04 ticket model with is_sensitive field
    - Phase 01 RLS foundation
  provides:
    - Municipality access request submission API (public)
    - Onboarding wizard state persistence API
    - Team invitation management API
    - Citizen portal "My Reports" API with GBV privacy
    - Citizen personal analytics API
  affects:
    - Frontend dashboard (will consume onboarding/invitations APIs)
    - Frontend public (will consume access request API)
tech_stack:
  added:
    - PostgreSQL INSERT ... ON CONFLICT (upsert pattern)
    - Pydantic v2 Literal types
  patterns:
    - Public endpoint without authentication (access requests)
    - Upsert pattern for wizard state persistence
    - GBV privacy filtering at query layer
    - Role-based endpoints via require_role dependency
key_files:
  created:
    - src/models/access_request.py
    - src/models/onboarding_state.py
    - src/models/team_invitation.py
    - src/schemas/access_request.py
    - src/schemas/onboarding.py
    - src/schemas/invitation.py
    - src/schemas/citizen.py
    - src/api/v1/access_requests.py
    - src/api/v1/onboarding.py
    - src/api/v1/invitations.py
    - src/api/v1/citizen.py
    - alembic/versions/2026_02_11_1702-feb9e9b8f0ff_add_access_requests_onboarding_.py
  modified:
    - src/api/v1/__init__.py
    - src/main.py
decisions:
  - key: Municipality access request flow
    choice: Public form submission → admin review → approval/rejection workflow
    rationale: Municipality doesn't exist yet, so can't be tenant-scoped or require auth. Platform admins manually review and approve legitimate requests.
  - key: Onboarding state persistence
    choice: Upsert pattern with PostgreSQL ON CONFLICT on (municipality_id, step_id)
    rationale: Allows wizard to save progress and resume across sessions. Unique constraint prevents duplicate step records.
  - key: Team invitations expiry
    choice: 7-day default expiry with timestamp tracking
    rationale: Prevents stale invitations from accumulating. Standard practice for invitation flows.
  - key: Citizen GBV ticket visibility
    choice: Citizens can see own GBV tickets but only limited fields (tracking number, status, assigned SAPS officer, station phone)
    rationale: Victim needs to track case status and contact officer, but full details (description, address, evidence) remain confidential per SEC-05.
  - key: Citizen analytics municipality comparison
    choice: Exclude GBV tickets from municipality-wide average resolution time
    rationale: GBV cases follow different SLA rules (excluded from monitoring per Phase 04 decision). Including them would skew comparison metrics.
metrics:
  duration: 25.8 minutes (1548 seconds)
  completed_at: 2026-02-11T14:57:00Z
  tasks_completed: 2
  files_created: 12
  files_modified: 2
  commits: 2
---

# Phase 06.2 Plan 08: Backend Infrastructure for Access Requests, Onboarding, Invitations & Citizen Portal - Summary

**One-liner:** Full backend API layer for Phase 6.2 UX features — public municipality access requests, wizard-based onboarding with upsert state persistence, team invitation management, and citizen "My Reports" portal with GBV privacy filtering and personal analytics.

## What Was Built

### Models & Schemas (Task 1)

**3 new SQLAlchemy models:**
1. **AccessRequest (NonTenantModel)** — Municipality application submissions
   - Not tenant-scoped (municipality doesn't exist yet)
   - Status tracking: pending → approved/rejected
   - Reviewed by admin with timestamp and notes
   - Supporting docs stored as JSON array of Supabase Storage paths

2. **OnboardingState (NonTenantModel)** — Wizard progress tracking
   - Municipality-level configuration (not tenant-scoped)
   - Unique constraint on (municipality_id, step_id) for upsert pattern
   - JSON step_data field for form state serialization
   - Completion tracking per step with timestamp

3. **TeamInvitation (TenantAwareModel)** — Pending team member invites
   - Tenant-scoped (invites are for specific municipalities)
   - Role assignment: manager, ward_councillor, field_worker
   - Status lifecycle: pending → accepted/expired
   - 7-day expiry with timestamp

**4 new Pydantic schema modules:**
- `access_request.py` — Create/response DTOs with SA province enum validation
- `onboarding.py` — Step save/response with progress percentage calculation
- `invitation.py` — Single + bulk create DTOs with role enum
- `citizen.py` — Ticket responses (full municipal vs limited GBV), stats response

**Alembic migration with RLS policies:**
- Created 3 tables with proper foreign keys and constraints
- RLS policies follow Supabase auth.jwt() -> app_metadata pattern:
  - `access_requests`: Public INSERT (anyone can submit), admin-only SELECT/UPDATE
  - `onboarding_state`: Municipality admin manages own (municipality_id match)
  - `team_invitations`: Tenant-scoped CRUD via tenant_id

### API Endpoints (Task 2)

**4 new API route modules:**

1. **access_requests.py** — Municipality application workflow
   - `POST /api/v1/access-requests` (public, no auth) — Submit access request
   - `GET /api/v1/access-requests` (admin only) — List all requests with status filtering
   - `PATCH /api/v1/access-requests/{id}/review` (admin only) — Approve/reject request

2. **onboarding.py** — Guided setup wizard persistence
   - `GET /api/v1/onboarding/state` (admin/manager) — Retrieve wizard progress
   - `PUT /api/v1/onboarding/state/{step_id}` (admin/manager) — Upsert step data
   - `POST /api/v1/onboarding/complete` (admin/manager) — Mark setup complete

3. **invitations.py** — Team member invitation management
   - `POST /api/v1/invitations` (admin/manager) — Create single invitation
   - `POST /api/v1/invitations/bulk` (admin/manager) — Batch create invitations
   - `GET /api/v1/invitations` (admin/manager) — List with status filtering
   - `DELETE /api/v1/invitations/{id}` (admin/manager) — Cancel pending invitation

4. **citizen.py** — Citizen portal for personal ticket tracking
   - `GET /api/v1/citizen/my-reports` (citizen only) — List own tickets with GBV privacy
   - `GET /api/v1/citizen/stats` (citizen only) — Personal analytics

**All routers registered in main.py** with `/api/v1` prefix and proper middleware stack.

## Technical Implementation

### Upsert Pattern for Wizard State

Used PostgreSQL's `INSERT ... ON CONFLICT DO UPDATE` for onboarding step persistence:

```python
stmt = insert(OnboardingState).values(
    municipality_id=municipality_id,
    step_id=step_id,
    step_data=step_data_json,
    is_completed=step_data.is_completed,
    completed_at=completed_at,
).on_conflict_do_update(
    constraint='uq_onboarding_municipality_step',
    set_={'step_data': step_data_json, 'is_completed': step_data.is_completed, ...}
)
```

Allows wizard to save progress and resume seamlessly.

### GBV Privacy Filtering

Citizen portal endpoint differentiates between municipal and GBV tickets at query layer:

**Municipal tickets (is_sensitive=False):**
- Full details: tracking number, category, status, address, severity, assigned worker/team, media count

**GBV tickets (is_sensitive=True):**
- Limited fields only: tracking number, status, assigned SAPS officer name, station name, station phone
- No description, address, photos, or other sensitive information
- Enables victim to track case and contact officer without exposing details

### Personal Analytics with Municipality Comparison

Citizen stats endpoint provides:
- Total reports by user
- Resolved count
- Average resolution time for user's tickets
- **Municipality-wide average for comparison** (excludes GBV tickets per Phase 04 decision)

Uses SQL aggregation with `func.avg()` and `EXTRACT(epoch FROM ...)` for day calculations.

### Public Endpoint Pattern

Access request submission endpoint is **public (no authentication required)** — first truly public POST endpoint in the codebase:

```python
@router.post("/", response_model=AccessRequestResponse, status_code=status.HTTP_201_CREATED)
async def submit_access_request(
    request_data: AccessRequestCreate,
    db: AsyncSession = Depends(get_db),  # No get_current_user dependency
) -> AccessRequest:
```

Rate limiting should be applied at infrastructure layer (e.g., Cloudflare) to prevent spam.

## Deviations from Plan

**None** — Plan executed exactly as written. All models, schemas, and endpoints created with specified functionality.

## Commits

1. **36e60eb** — `feat(06.2-08): add models, schemas, and migration for access requests, onboarding, and invitations`
   - 3 SQLAlchemy models (AccessRequest, OnboardingState, TeamInvitation)
   - 4 Pydantic schema modules
   - Alembic migration with RLS policies
   - Files: 8 created

2. **cf6e06c** — `feat(06.2-08): add API endpoints for access requests, onboarding, invitations, and citizen portal`
   - 4 FastAPI router modules
   - Router registration in main.py
   - Pydantic v2 Literal fix (const → Literal[True])
   - Files: 4 created, 3 modified

## Verification

✅ All 3 new tables exist in migration (access_requests, onboarding_state, team_invitations)
✅ RLS policies applied following Supabase auth.jwt() pattern
✅ Access request can be submitted without authentication (public form)
✅ Onboarding state can be saved/loaded per municipality (authenticated)
✅ Team invitations can be created individually and in bulk (authenticated)
✅ Citizen can query own tickets with GBV privacy enforcement
✅ Citizen stats endpoint returns aggregated analytics
✅ All new routers registered and importable
✅ Python imports successful: `from src.api.v1 import access_requests, onboarding, invitations, citizen`

## Next Steps

**Immediate (Phase 6.2 continuation):**
- Plans 05 & 06 will consume these APIs from frontend dashboards
- Build React components for access request form, onboarding wizard, team invitations
- Implement citizen portal UI with "My Reports" and personal stats

**Future enhancements:**
- Email notifications for access request approvals/rejections
- Email invitations with signup tokens for team members
- Municipality creation workflow on access request approval
- Invitation acceptance flow (signup with pre-assigned role)

## Self-Check

**Created files verification:**

```bash
✅ FOUND: src/models/access_request.py
✅ FOUND: src/models/onboarding_state.py
✅ FOUND: src/models/team_invitation.py
✅ FOUND: src/schemas/access_request.py
✅ FOUND: src/schemas/onboarding.py
✅ FOUND: src/schemas/invitation.py
✅ FOUND: src/schemas/citizen.py
✅ FOUND: src/api/v1/access_requests.py
✅ FOUND: src/api/v1/onboarding.py
✅ FOUND: src/api/v1/invitations.py
✅ FOUND: src/api/v1/citizen.py
✅ FOUND: alembic/versions/2026_02_11_1702-feb9e9b8f0ff_add_access_requests_onboarding_.py
```

**Commits verification:**

```bash
✅ FOUND: 36e60eb (Task 1: models, schemas, migration)
✅ FOUND: cf6e06c (Task 2: API endpoints)
```

## Self-Check: PASSED

All files created, commits exist, verification criteria met.
