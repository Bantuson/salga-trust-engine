---
phase: 06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency
plan: 05
type: execute
wave: 3
depends_on: ["06.2-01", "06.2-03", "06.2-08"]
files_modified:
  - frontend-dashboard/src/pages/RequestAccessPage.tsx
  - frontend-dashboard/src/pages/OnboardingWizardPage.tsx
  - frontend-dashboard/src/components/onboarding/WelcomeStep.tsx
  - frontend-dashboard/src/components/onboarding/ProfileStep.tsx
  - frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx
  - frontend-dashboard/src/components/onboarding/ConfigureWardsStep.tsx
  - frontend-dashboard/src/components/onboarding/SetSLAStep.tsx
  - frontend-dashboard/src/components/onboarding/CompletionStep.tsx
  - frontend-dashboard/src/components/onboarding/WizardProgress.tsx
  - frontend-dashboard/src/hooks/useOnboarding.ts
  - frontend-dashboard/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Municipality registration uses hybrid model: request access form (not open signup)"
    - "Access request form submits to POST /api/v1/access-requests backend endpoint"
    - "Onboarding wizard has 5 steps: Profile, Invite Team, Configure Wards, Set SLA, Done"
    - "Wizard progress is persisted to Supabase via PUT /api/v1/onboarding/state/{step_id} and can be resumed"
    - "Team invitations are submitted to POST /api/v1/invitations backend endpoint"
    - "Each wizard step can be skipped (except profile) and revisited later"
    - "Completion step has celebration animation and calls POST /api/v1/onboarding/complete"
  artifacts:
    - path: "frontend-dashboard/src/pages/RequestAccessPage.tsx"
      provides: "Municipality access request form with backend submission"
      contains: "access-requests"
    - path: "frontend-dashboard/src/pages/OnboardingWizardPage.tsx"
      provides: "Multi-step onboarding wizard with backend persistence"
      contains: "OnboardingWizard"
    - path: "frontend-dashboard/src/hooks/useOnboarding.ts"
      provides: "Hook for onboarding state CRUD via API"
      contains: "useOnboarding"
    - path: "frontend-dashboard/src/components/onboarding/WizardProgress.tsx"
      provides: "Visual progress bar for wizard steps"
      contains: "progress"
    - path: "frontend-dashboard/src/components/onboarding/ProfileStep.tsx"
      provides: "Municipality profile setup step"
      contains: "ProfileStep"
  key_links:
    - from: "frontend-dashboard/src/pages/RequestAccessPage.tsx"
      to: "POST /api/v1/access-requests"
      via: "fetch/axios POST to backend API"
      pattern: "access-requests"
    - from: "frontend-dashboard/src/hooks/useOnboarding.ts"
      to: "GET/PUT /api/v1/onboarding/state"
      via: "fetch/axios calls to onboarding API"
      pattern: "onboarding/state"
    - from: "frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx"
      to: "POST /api/v1/invitations"
      via: "fetch/axios POST to invitations API"
      pattern: "invitations"
    - from: "frontend-dashboard/src/pages/OnboardingWizardPage.tsx"
      to: "frontend-dashboard/src/components/onboarding/ProfileStep.tsx"
      via: "step rendering based on currentStep state"
      pattern: "currentStep"
    - from: "frontend-dashboard/src/App.tsx"
      to: "frontend-dashboard/src/pages/OnboardingWizardPage.tsx"
      via: "React Router route /onboarding"
      pattern: "path.*onboarding"
---

<objective>
Build the municipality registration flow (hybrid request access model) and guided onboarding wizard (5 steps: profile, invite team, configure wards, set SLA, done) with progress tracking.

Purpose: New municipalities need a controlled registration process (request access -> admin approval -> invite) and a guided setup wizard so they can configure their account without feeling overwhelmed. This is a locked decision: hybrid registration model + guided wizard.

Output: RequestAccessPage for new municipalities, OnboardingWizardPage with 5 step components and progress bar.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-CONTEXT.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-RESEARCH.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-01-SUMMARY.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-03-SUMMARY.md
@.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-08-SUMMARY.md
@frontend-dashboard/src/App.tsx
@src/api/v1/access_requests.py
@src/api/v1/onboarding.py
@src/api/v1/invitations.py
@src/schemas/access_request.py
@src/schemas/onboarding.py
@src/schemas/invitation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create municipality request access page and route</name>
  <files>
    frontend-dashboard/src/pages/RequestAccessPage.tsx
    frontend-dashboard/src/App.tsx
  </files>
  <action>
    **1. Create RequestAccessPage.tsx:**
    This page is for municipalities that want to join the platform. It's NOT a signup form — it's an access request that goes through admin approval.

    **Layout:**
    - Same visual treatment as Login/Register pages (AnimatedGradientBg + GlassCard)
    - Title: "Request Municipal Access"
    - Subtitle: "Join the SALGA Trust Engine platform. Your request will be reviewed by our team."

    **Form fields:**
    - Municipality Name (required text input)
    - Province (required select dropdown — official SA provinces: Eastern Cape, Free State, Gauteng, KwaZulu-Natal, Limpopo, Mpumalanga, North West, Northern Cape, Western Cape)
    - Municipality Code (text input, auto-uppercase, e.g. "JHB", "CPT")
    - Contact Person Name (required text input)
    - Contact Email (required email input)
    - Contact Phone (phone input)
    - Supporting Documents (file upload area — "Upload documentation proving municipal authority")
    - Additional Notes (optional textarea)

    **Submit behavior:**
    - On submit:
      1. Validate all required fields client-side
      2. POST form data to `POST /api/v1/access-requests` (backend endpoint from Plan 08)
      3. If supporting documents are attached, upload them to Supabase Storage first (bucket: `access-request-docs`), then include the storage paths in the API request body
      4. On success (201): show a success state: GlassCard with check icon, message "Thank you for your request! Our team will review it and contact you within 5 business days. You'll receive an email invitation once approved."
      5. On error: show error message with retry option
    - Use Supabase client for the API call (or fetch with appropriate headers)
    - Draft auto-save: save form state to localStorage as draft while user is filling out (key: `salga_access_request_draft`). Clear on successful submission.

    **Supporting document upload:**
    - Use the existing FileUpload component pattern if available, or create a simple file input with drag-and-drop area
    - Accept: PDF, JPG, PNG (max 10MB each, max 3 files)
    - Show uploaded file names with remove buttons
    - Upload files to Supabase Storage bucket `access-request-docs` on form submit
    - Include returned storage paths in the access request API body as `supporting_docs` JSON array

    **Navigation:**
    - Link at bottom: "Already have an invite? [Sign In]" → /login
    - Link: "Already have an account? [Sign In]" → /login

    **Use shared components:** GlassCard, Button, Input, AnimatedGradientBg

    **2. Add route in App.tsx:**
    - Add route: `/request-access` → RequestAccessPage (unauthenticated only)
    - Add link from LoginPage: "Municipality? [Request Access]" → /request-access

    **3. Update LoginPage.tsx:**
    - Add a small link below the register link: "Are you a municipality? [Request Access →]"
  </action>
  <verify>
    - `ls frontend-dashboard/src/pages/RequestAccessPage.tsx` — page exists
    - `grep "Request.*Access\|request-access" frontend-dashboard/src/App.tsx` — route exists
    - `grep "Province\|province" frontend-dashboard/src/pages/RequestAccessPage.tsx` — province dropdown exists
    - `grep "request-access\|Request Access" frontend-dashboard/src/pages/LoginPage.tsx` — link from login
    - `grep "api/v1/access-requests\|access.requests" frontend-dashboard/src/pages/RequestAccessPage.tsx` — submits to backend API
    - `cd frontend-dashboard && npx tsc --noEmit` — TypeScript compiles
  </verify>
  <done>
    Municipality request access page created with form for name, province, code, contact info, and supporting documents. Form submits to POST /api/v1/access-requests backend endpoint. Documents uploaded to Supabase Storage. Success confirmation shown on 201 response. Login page links to request access. Route configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create guided onboarding wizard with 5 steps and progress tracking</name>
  <files>
    frontend-dashboard/src/pages/OnboardingWizardPage.tsx
    frontend-dashboard/src/hooks/useOnboarding.ts
    frontend-dashboard/src/components/onboarding/WizardProgress.tsx
    frontend-dashboard/src/components/onboarding/WelcomeStep.tsx
    frontend-dashboard/src/components/onboarding/ProfileStep.tsx
    frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx
    frontend-dashboard/src/components/onboarding/ConfigureWardsStep.tsx
    frontend-dashboard/src/components/onboarding/SetSLAStep.tsx
    frontend-dashboard/src/components/onboarding/CompletionStep.tsx
    frontend-dashboard/src/App.tsx
  </files>
  <action>
    **0. Create frontend-dashboard/src/hooks/useOnboarding.ts:**
    A custom hook that encapsulates all onboarding API interactions:
    ```typescript
    export function useOnboarding() {
      // GET /api/v1/onboarding/state — load wizard progress from backend
      async function loadProgress(): OnboardingProgressResponse
      // PUT /api/v1/onboarding/state/{stepId} — save step data to backend
      async function saveStep(stepId: string, data: any, isCompleted: boolean): OnboardingStepResponse
      // POST /api/v1/onboarding/complete — mark onboarding as complete
      async function completeOnboarding(): void
      // Loading and error states
      return { loadProgress, saveStep, completeOnboarding, isLoading, error }
    }
    ```
    Use the Supabase client or fetch with auth headers from the existing auth context.
    Include error handling with retry logic (network failures during wizard are frustrating).

    **1. Create OnboardingWizardPage.tsx:**
    - Full-screen page with AnimatedGradientBg background
    - GlassCard container for wizard content
    - State management: `currentStep` (0-5), `wizardData` (accumulates data from each step)
    - Use `useOnboarding()` hook for all backend interactions
    - Steps array:
      ```
      0: Welcome (not counted in progress)
      1: Profile Setup (25%)
      2: Invite Team (50%)
      3: Configure Wards (75%)
      4: Set SLA Targets (100%)
      5: Done! (completion)
      ```
    - Navigation buttons: "Back" (ghost variant) + "Next" (primary variant)
    - "Skip" button available on steps 2, 3, 4 (optional steps) — advances and marks step as not completed
    - Step 1 (Profile) is NOT skippable
    - **Backend persistence**: On each step completion/skip, call `saveStep(stepId, stepData, isCompleted)` to persist to Supabase via the onboarding API endpoint (Plan 08)
    - **Resume from backend**: On mount, call `loadProgress()` to fetch saved state from backend. If steps exist, resume from the first incomplete step. Fall back to localStorage if API call fails (offline resilience).
    - **localStorage as fallback cache**: Also save to localStorage as a cache for offline/network-failure scenarios. Backend is source of truth; localStorage is fallback. Clear localStorage on successful completion.
    - On completion (step 5), call `completeOnboarding()` then clear localStorage

    **2. Create WizardProgress.tsx:**
    - Visual progress indicator at top of wizard
    - Shows step numbers 1-5 in circles connected by lines
    - Current step: coral circle with pulse animation
    - Completed steps: teal circle with check icon
    - Upcoming steps: muted gray circle
    - Progress percentage text: "Step 2 of 5 — 40%"
    - Below circles: step titles (Profile, Team, Wards, SLA, Done)
    - Responsive: on mobile, hide step titles, show only circles and percentage

    **3. Create WelcomeStep.tsx (Step 0):**
    - Welcome message: "Welcome to SALGA Trust Engine!"
    - Brief intro: "Let's get your municipality set up. This takes about 5 minutes."
    - Three icons showing what they'll configure: Profile, Team, Settings
    - Single CTA: "Start Setup" button
    - Optional: simple GSAP fade-in animation (check useReducedMotion)

    **4. Create ProfileStep.tsx (Step 1 — Required):**
    - Municipality details form:
      - Full Name (pre-filled from request if available, editable)
      - Municipality Code (pre-filled, editable)
      - Province (dropdown, pre-filled)
      - Contact Info: phone, email
      - Logo Upload (optional — simple file input with preview, stored in state only)
      - Primary Contact Person name and title
    - Validation: name and code required
    - All fields use shared Input component

    **5. Create InviteTeamStep.tsx (Step 2 — Skippable):**
    - "Invite your team members"
    - Dynamic form rows: Email + Role (dropdown: Manager, Ward Councillor, Field Worker)
    - "Add another" button to add more rows (start with 1 row)
    - "You can always add more team members later from Settings"
    - Skip button: "Skip — I'll do this later"
    - **Backend integration**: On "Next", submit invitations via `POST /api/v1/invitations/bulk` (Plan 08 endpoint). Show loading spinner while submitting. On success, display "N invitations sent" confirmation before advancing. On error, show error message with option to retry or skip.
    - NOTE: Email notification to invitees is deferred — the API stores the invitation record; actual email dispatch can be added later

    **6. Create ConfigureWardsStep.tsx (Step 3 — Skippable):**
    - "Configure your wards"
    - Simple list-based approach (NOT interactive map — too complex for this plan):
      - Add ward: Name + optional boundary description
      - "Add Ward" button, remove button per row
    - "Wards help route tickets to the right teams"
    - Skip button: "Skip — I'll configure wards later"
    - **Backend integration**: Ward data is saved as part of the onboarding step data via `PUT /api/v1/onboarding/state/wards`. The step_data JSON includes the ward list. Full ward/team creation from this data can be handled in a future phase or via the Settings page.

    **7. Create SetSLAStep.tsx (Step 4 — Skippable):**
    - "Set your service level targets"
    - Two inputs with sliders:
      - Response Time Target: slider from 1h to 72h (default: 24h)
      - Resolution Time Target: slider from 1 day to 30 days (default: 7 days)
    - Visual: show current values prominently with units
    - "You can adjust these anytime in Settings"
    - Skip button: "Use defaults"
    - **Backend integration**: SLA data is saved via `PUT /api/v1/onboarding/state/sla`. The step_data JSON includes response_hours and resolution_hours. On "Next" (not skip), also call the existing SLA config API to create/update the SLAConfig record for this municipality (the SLAConfig model already exists). If "Use defaults" is clicked, skip the SLA API call and just save step state as completed with default values.

    **8. Create CompletionStep.tsx (Step 5):**
    - Celebration screen: "Your Dashboard is Ready!"
    - On mount, call `completeOnboarding()` from `useOnboarding()` hook to mark onboarding as complete in the backend via `POST /api/v1/onboarding/complete`
    - Optional GSAP/CSS confetti or celebration animation (simple — maybe scale-in of a check icon with glow)
    - Summary of what was configured (loaded from backend onboarding state):
      - Municipality name and code
      - N team members invited (or "None yet")
      - N wards configured (or "None yet")
      - SLA targets (or "Using defaults")
    - CTA: "Go to Dashboard" → navigates to /
    - Check useReducedMotion — skip celebration animation if true

    **9. Add route in App.tsx:**
    - Add route: `/onboarding` → OnboardingWizardPage (authenticated only)
    - This route is accessible after first login or from settings

    **Build verification:**
    Run `cd frontend-dashboard && npm run build` to verify everything compiles.
  </action>
  <verify>
    - `ls frontend-dashboard/src/pages/OnboardingWizardPage.tsx` — wizard page exists
    - `ls frontend-dashboard/src/hooks/useOnboarding.ts` — onboarding hook exists
    - `ls frontend-dashboard/src/components/onboarding/WelcomeStep.tsx frontend-dashboard/src/components/onboarding/ProfileStep.tsx frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx frontend-dashboard/src/components/onboarding/ConfigureWardsStep.tsx frontend-dashboard/src/components/onboarding/SetSLAStep.tsx frontend-dashboard/src/components/onboarding/CompletionStep.tsx` — all 6 step components exist
    - `ls frontend-dashboard/src/components/onboarding/WizardProgress.tsx` — progress component exists
    - `grep "currentStep" frontend-dashboard/src/pages/OnboardingWizardPage.tsx` — step state management
    - `grep "useOnboarding\|onboarding/state\|loadProgress\|saveStep" frontend-dashboard/src/pages/OnboardingWizardPage.tsx` — backend API integration
    - `grep "invitations" frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx` — team invitations submitted to backend
    - `grep "completeOnboarding\|onboarding/complete" frontend-dashboard/src/components/onboarding/CompletionStep.tsx` — completion calls backend
    - `grep "onboarding" frontend-dashboard/src/App.tsx` — route configured
    - `cd frontend-dashboard && npm run build` — builds successfully
  </verify>
  <done>
    Onboarding wizard with 6 screens (Welcome + 5 steps): Profile setup, team invites (submitted to POST /api/v1/invitations/bulk), ward configuration, SLA targets, and completion celebration. Progress persisted to Supabase via PUT /api/v1/onboarding/state/{step_id}. Wizard resumes from backend state on return. localStorage used as offline fallback only. Skippable optional steps. All step components use shared design system.
  </done>
</task>

</tasks>

<verification>
1. Request Access page has form with municipality details and province dropdown
2. Request Access form submits to POST /api/v1/access-requests (not just localStorage)
3. Onboarding wizard has 5 steps + welcome + completion
4. Progress bar shows circles, percentage, and step titles
5. Steps 2-4 are skippable
6. Wizard state persists to Supabase via PUT /api/v1/onboarding/state/{step_id}
7. Wizard resumes from backend state on page revisit
8. Team invitations submit to POST /api/v1/invitations/bulk
9. Completion step calls POST /api/v1/onboarding/complete
10. Both pages use shared design system components
11. Routes configured in App.tsx
12. `npm run build` succeeds
</verification>

<success_criteria>
- Municipality access request is stored in Supabase database (not just localStorage)
- First-time admin can complete guided onboarding in ~5 minutes
- Interrupted wizard can be resumed from backend-persisted state
- Team invitations are stored in Supabase (ready for future email notification)
- Progress is visually clear at all times
- Completion celebration creates positive first impression
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-ux-redesign-user-journeys-design-system-and-dashboard-consistency/06.2-05-SUMMARY.md`
</output>
