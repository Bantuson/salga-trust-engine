---
phase: 10.1-auth-system-diagnosis-fix-invalid-credentials-and-enable-email-code-verification-for-dashboards
task: 2
total_tasks: 2
plan: 02
status: in_progress
last_updated: 2026-02-24T17:21:19.654Z
---

<current_state>
Phase 10.1 execution in progress. Wave 1 (Plan 01) fully complete. Wave 2 (Plan 02) Task 1 complete, Task 2 is a human-verify checkpoint — PAUSED awaiting Supabase SMTP configuration before final approval.

The execute-phase orchestrator is at the checkpoint handling step of Wave 2.
</current_state>

<completed_work>

## Plan 10.1-01 (Wave 1) — COMPLETE ✓
- Task 1: Added signInWithEmailOtp and verifyEmailOtp to both auth layers (AuthContext.tsx + useAuth.ts)
- Task 2: Added inline OTP verification step to both registration pages (CitizenRegisterPage.tsx + RegisterPage.tsx)
- SUMMARY.md created, 3 commits (4fcb535, cc513f5, 079a4a9)

## Plan 10.1-02 (Wave 2) — Task 1 COMPLETE, Task 2 IN PROGRESS
- Task 1: Added email OTP sign-in mode to both login pages + SQL remediation script (commit 1ae0fa8)
- SQL remediation executed via MCP: remaining_unconfirmed = 0
- Task 2: Human-verify checkpoint — BLOCKED on SMTP config

## Additional fixes applied during checkpoint (commit 80e1965):
- OTP inputs updated from 6-digit to 8-digit (Supabase sends 8-digit codes)
- Username field added to citizen registration form (maps to display_name in Supabase metadata)
- Municipality dropdown replaced: native <select> → glassmorphic MunicipalityDropdown component
- display_name added to signUp metadata in both registration pages
- signInWithOtp workaround added after signUp() for registration OTP delivery (interim fix)
</completed_work>

<remaining_work>

## Immediate: Configure Supabase Custom SMTP
- Go to Supabase Dashboard > Project Settings (gear icon) > Authentication > SMTP Settings
- OR direct URL: https://supabase.com/dashboard/project/YOUR_REF/settings/auth
- Configure one of: Resend, SendGrid, AWS SES, Postmark, Brevo, ZeptoMail
- Adjust rate limits at Dashboard > Auth > Rate Limits (default 30/hr with custom SMTP)

## After SMTP is configured:
1. Revert signInWithOtp workaround in CitizenRegisterPage.tsx and RegisterPage.tsx — restore native signUp() confirmation flow
2. Test registration: signUp → receive OTP via "Confirm signup" template → verify → session created
3. Test email OTP login: signInWithOtp → receive OTP via "Magic Link" template → verify → session
4. Approve Task 2 checkpoint (or spawn continuation agent)

## After checkpoint approval:
5. Create 10.1-02-SUMMARY.md
6. Run phase verification (gsd-verifier)
7. Update ROADMAP.md, STATE.md
8. Close parent artifacts (10 → 10.1 gap closure)
</remaining_work>

<decisions_made>

- OTP inputs accept 6-8 digits (pattern="[0-9]{6,8}") for forward/backward compatibility
- Username field on citizen registration maps to `display_name` in Supabase user_metadata (what Dashboard shows)
- Full Name remains as `full_name` in metadata, Username is the display name
- signInWithOtp after signUp is an INTERIM workaround — production fix is custom SMTP
- Root cause of missing signup emails: Supabase built-in email = 2/hr rate limit, "demonstration purposes only"
- Municipality dropdown uses inline MunicipalityDropdown component (not imported CustomSelect) to keep registration page self-contained
</decisions_made>

<blockers>
- SMTP not configured: Supabase built-in email service has 2 emails/hour rate limit and may refuse delivery to non-team addresses. Custom SMTP required for production.
- User could not find SMTP settings in Supabase Dashboard Auth section — may be under Project Settings > Auth instead
</blockers>

<context>
This is a gap-closure phase (10.1) fixing auth bugs from phase 10. The "invalid credentials" bug was caused by unconfirmed email addresses after signUp(). The fix adds inline OTP verification to registration pages and email OTP as a third login method. The signInWithOtp workaround bypasses the broken "Confirm signup" email template delivery by using the "Magic Link" template instead. Once custom SMTP is configured, the native signUp confirmation will work and the workaround should be reverted.

Both dev servers are running (dashboard :5173, public :5174). Both frontends compile clean (tsc --noEmit passes).
</context>

<next_action>
1. Configure custom SMTP in Supabase Dashboard (user action)
2. Resume with `/gsd:resume-work`
3. Revert signInWithOtp workaround in both registration pages
4. Test both flows end-to-end
5. Approve checkpoint, complete Plan 02, run phase verification
</next_action>
