---
phase: "10.1"
plan: "02"
subsystem: "auth"
tags: ["auth", "otp", "email-otp", "login", "supabase", "frontend", "sql-remediation"]
dependency_graph:
  requires: ["10.1-01"]
  provides: ["email-otp-login-mode", "stuck-account-remediation-script"]
  affects: ["frontend-public/auth", "frontend-dashboard/auth", "citizen-login", "municipal-login"]
tech_stack:
  added: []
  patterns: ["AuthMode state machine (email-otp | verify-email-otp)", "signInWithEmailOtp(shouldCreateUser: false)", "verifyEmailOtp(type: email)", "SQL UPDATE auth.users SET email_confirmed_at=NOW()"]
key_files:
  created:
    - "scripts/remediate_unconfirmed_accounts.sql"
  modified:
    - "frontend-public/src/pages/CitizenLoginPage.tsx"
    - "frontend-dashboard/src/pages/LoginPage.tsx"
decisions:
  - "Email OTP login uses signInWithEmailOtp(shouldCreateUser: false) — login only, never create accounts"
  - "verifyEmailOtp uses type: email — same as registration OTP (not sms or signup)"
  - "Municipal dashboard after email OTP verify does NOT navigate manually — auth state change triggers redirect via App.tsx (same as existing flows)"
  - "SQL remediation script targets only accounts with full_name in metadata (real users vs test profiles)"
  - "OTP inputs use inputMode=numeric and auto-strip non-digits via onChange for UX safety"
  - "SQL execution deferred to human step — mcp__supabase__execute_sql not available in this Claude Code environment"
metrics:
  duration: "5.6 minutes (335 seconds)"
  completed: "2026-02-24"
  tasks: 1
  files: 3
---

# Phase 10.1 Plan 02: Email OTP Login Mode Summary

**One-liner:** Added email OTP as a third sign-in mode to both login pages alongside existing email+password and phone OTP, with 6-digit code send/verify/resend flow, plus SQL remediation script for stuck unconfirmed accounts.

## What Was Built

### Task 1: Email OTP sign-in mode added to both login pages + SQL remediation script

**`frontend-public/src/pages/CitizenLoginPage.tsx`**
- Expanded `AuthMode` type: `'email' | 'phone' | 'verify-otp' | 'email-otp' | 'verify-email-otp'`
- Destructured `signInWithEmailOtp` and `verifyEmailOtp` from `useAuth()` (methods added in plan 01)
- Added `emailForOtp` state to capture the email when OTP is sent
- Added `handleEmailOtpSend` handler: calls `signInWithEmailOtp(email)`, sets `emailForOtp(email)`, transitions to `verify-email-otp`
- Added `handleVerifyEmailOtp` handler: calls `verifyEmailOtp(emailForOtp, otpToken)`, navigates to return URL or `/profile`
- Added `email-otp` mode UI: email input + "Send Verification Code" button + "Back to email login" link
- Added `verify-email-otp` mode UI: teal info box with email, 6-digit OTP input (centered, letter-spaced, numeric), "Verify Code" button, "Resend Code" button
- Added "Sign in with Email Code" button after "Sign in with Phone OTP" in `email` mode form
- Improved OTP inputs with `inputMode="numeric"` and auto-strip non-digits via `onChange`

**`frontend-dashboard/src/pages/LoginPage.tsx`**
- Identical pattern applied: expanded `AuthMode` type, destructured new methods, added `emailForOtp` state
- Added `handleEmailOtpSend` and `handleVerifyEmailOtp` handlers (no manual navigate — auth state change triggers redirect via App.tsx)
- Added `email-otp` and `verify-email-otp` mode UI blocks (same structure as citizen page)
- Added "Sign in with Email Code" button after "Sign in with Phone OTP" in `email` mode form
- Improved phone OTP input with same `inputMode="numeric"` and auto-strip pattern

**`scripts/remediate_unconfirmed_accounts.sql`**
- Version-controlled SQL remediation script for stuck accounts (email_confirmed_at = NULL + full_name in metadata)
- UPDATE statement sets `email_confirmed_at = NOW(), updated_at = NOW()`
- Verification SELECT confirms `remaining_unconfirmed = 0` after update
- WHERE clause: `email_confirmed_at IS NULL AND raw_user_meta_data->>'full_name' IS NOT NULL` — targets only real user accounts

## Checkpoint Pending

Task 2 (`checkpoint:human-verify`) requires the user to:
1. Execute `scripts/remediate_unconfirmed_accounts.sql` against Supabase (UPDATE + verify SELECT)
2. Verify Supabase Dashboard > Authentication > Email Templates has branded OTP HTML in both "Confirm signup" and "Magic Link" slots
3. Test registration flow: register test account, receive 6-digit code, verify redirect to /profile
4. Test email OTP login: sign out, click "Sign in with Email Code", enter email, receive 6-digit code, enter code, verify logged in

## Verification Results

1. `cd frontend-public && npx tsc --noEmit` — zero TypeScript errors
2. `cd frontend-dashboard && npx tsc --noEmit` — zero TypeScript errors
3. `CitizenLoginPage.tsx` has 9 references to `email-otp` modes (type, UI blocks, button)
4. `LoginPage.tsx` has 9 references to `email-otp` modes (type, UI blocks, button)
5. `signInWithEmailOtp` referenced 3 times in each login page (destructure, handler call, resend call)
6. `scripts/remediate_unconfirmed_accounts.sql` created with `email_confirmed_at` pattern (3 references)

## Deviations from Plan

### Deviation 1 — SQL MCP execution not available (informational)

The plan specified executing the SQL UPDATE via `mcp__supabase__execute_sql`. The Supabase MCP tool is not configured as an MCP server in this Claude Code environment (`~/.claude/settings.json` shows empty `mcpServers`).

**Action taken:** SQL script created and committed to `scripts/remediate_unconfirmed_accounts.sql`. The user must execute it manually via:
- Supabase Dashboard > SQL Editor, or
- `psql` directly against the Supabase project database

This is documented as a checkpoint action item in Task 2.

### Deviation 2 — OTP input improvements (Rule 2 — missing critical functionality)

Both the new email OTP inputs AND the existing phone OTP inputs now use `inputMode="numeric"` and auto-strip non-digits via `onChange` handler (`e.target.value.replace(/\D/g, '').slice(0, 6)`). The plan specified this for new inputs but it was also applied to the existing `verify-otp` phone OTP inputs as a correctness improvement (prevents paste of non-numeric codes).

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | 1ae0fa8 | feat(10.1-02): add email OTP sign-in mode to both login pages and create SQL remediation script |

## Self-Check: PASSED

- FOUND: `frontend-public/src/pages/CitizenLoginPage.tsx`
- FOUND: `frontend-dashboard/src/pages/LoginPage.tsx`
- FOUND: `scripts/remediate_unconfirmed_accounts.sql`
- FOUND: commit 1ae0fa8
- FOUND: `signInWithEmailOtp` pattern in CitizenLoginPage (3 refs)
- FOUND: `email-otp` pattern in CitizenLoginPage (9 refs)
- FOUND: `signInWithEmailOtp` pattern in LoginPage (3 refs)
- FOUND: `email-otp` pattern in LoginPage (9 refs)
- FOUND: `email_confirmed_at` pattern in SQL script (3 refs)
