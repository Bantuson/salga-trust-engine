---
phase: 03-citizen-reporting-channels
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/whatsapp_service.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "WhatsApp service creates MediaAttachment records in the database when a ticket is created with media"
    - "WhatsApp service extracts tracking_number from ticket creation result and returns it in the response dict"
    - "WhatsApp response includes tracking number text when a ticket is successfully created"
  artifacts:
    - path: "src/services/whatsapp_service.py"
      provides: "MediaAttachment creation and tracking number extraction"
      contains: "MediaAttachment("
    - path: "src/services/whatsapp_service.py"
      provides: "Tracking number in response"
      contains: "tracking_number"
  key_links:
    - from: "src/services/whatsapp_service.py"
      to: "src/models/media.py"
      via: "MediaAttachment record creation"
      pattern: "MediaAttachment\\("
    - from: "src/services/whatsapp_service.py"
      to: "src/agents/tools/ticket_tool.py"
      via: "tracking_number extracted from ticket_data or flow state"
      pattern: "tracking_number.*ticket_data\\[.tracking_number.\\]"
---

<objective>
Fix WhatsApp tracking number and MediaAttachment record creation (gap closure)

Purpose: Close verification gap #2 - "System sends WhatsApp reply with tracking number after ticket creation". Currently, whatsapp_service.py has a TODO at line 216 for MediaAttachment record creation and returns tracking_number=None at line 262.

Output: Updated whatsapp_service.py with working MediaAttachment creation and tracking number extraction
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-citizen-reporting-channels/03-02-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-VERIFICATION.md

Key references:
- src/services/whatsapp_service.py — The file to fix (lines 214-226 TODO, line 262 tracking_number=None)
- src/models/media.py — MediaAttachment model (ticket_id, file_id, s3_bucket, s3_key, filename, content_type, file_size, purpose, source, is_processed)
- src/agents/tools/ticket_tool.py — Shows ticket creation returns dict with "tracking_number" key (line 130)
- src/agents/flows/state.py — IntakeState has ticket_data (dict|None) and ticket_id (str|None)
- src/agents/flows/intake_flow.py — Flow sets self.state.ticket_data with category, description, etc. Note: ticket_data from handle_municipal_intake does NOT include tracking_number (it's a placeholder). The ticket_tool create_ticket returns {"id", "tracking_number", "status", "category", "severity"}.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MediaAttachment creation and tracking number extraction in WhatsAppService</name>
  <files>src/services/whatsapp_service.py</files>
  <action>
Fix two issues in src/services/whatsapp_service.py:

**Fix 1: MediaAttachment record creation (lines 214-226)**

Replace the TODO block (lines 214-226) with actual MediaAttachment creation. When ticket_id is available and media_file_ids exist:

1. Import the Ticket model at the top: `from src.models.ticket import Ticket`
2. For each file_id in media_file_ids, create a MediaAttachment record using the db session:
   ```python
   for file_id in media_file_ids:
       media_attachment = MediaAttachment(
           ticket_id=ticket_id,
           file_id=file_id,
           s3_bucket=settings.S3_BUCKET_EVIDENCE,
           s3_key=f"evidence/{tenant_id}/{ticket_id}/{file_id}",
           filename=f"{file_id}.jpg",
           content_type="image/jpeg",
           file_size=0,  # Size was logged during upload but not stored; acceptable for now
           purpose="evidence",
           source="whatsapp",
           is_processed=False,
           tenant_id=tenant_id,
           created_by=user_id,
           updated_by=user_id,
       )
       db.add(media_attachment)
   await db.commit()
   ```
3. Log the successful linking with the count of media attachments created.

Note: The `db` parameter is the AsyncSession already passed to process_incoming_message. The MediaAttachment model is already imported at line 19. The tenant_id and user_id are already available as local variables.

**Fix 2: Tracking number extraction (line 262)**

Replace `"tracking_number": None,  # Would be extracted from ticket_data` with actual extraction.

The tracking_number can come from two places:
- `flow.state.ticket_data` — when ticket_tool creates the ticket, it returns a dict with "tracking_number" key
- The flow.state.ticket_data dict from handle_municipal_intake does NOT include tracking_number (it's a placeholder dict without DB interaction)

So the extraction logic should be:
```python
tracking_number = None
if flow.state.ticket_data and isinstance(flow.state.ticket_data, dict):
    tracking_number = flow.state.ticket_data.get("tracking_number")
```

Place this extraction AFTER flow.kickoff() completes (around line 211, before Step 7).

Then update the agent_response when a ticket is created to include the tracking number:
```python
if flow.state.ticket_data:
    tracking_number_text = f" Your tracking number is {tracking_number}." if tracking_number else ""
    agent_response = (
        f"Your report has been received and logged.{tracking_number_text} "
        f"We will investigate this issue and keep you updated."
    )
```

And in the final return dict (line 260-264), use the extracted tracking_number variable instead of None.

**Important:** Do NOT change the method signature or the return dict structure. Only fix the two specific gaps identified.
  </action>
  <verify>
Run: `python -c "from src.services.whatsapp_service import WhatsAppService; print('Import OK')"` to verify no syntax errors.

Then grep to confirm the fixes:
- `grep -n "MediaAttachment(" src/services/whatsapp_service.py` should show MediaAttachment creation (not just import)
- `grep -n "tracking_number.*None" src/services/whatsapp_service.py` should NOT appear at the response return line (only in error/empty cases)
- `grep -n "TODO" src/services/whatsapp_service.py` should return no results
  </verify>
  <done>
- MediaAttachment records are created in the database when a ticket is created with WhatsApp media (TODO removed)
- tracking_number is extracted from flow.state.ticket_data and returned in the response dict
- Agent response text includes tracking number when ticket is created
- No TODO comments remain in whatsapp_service.py
- Import succeeds without errors
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.services.whatsapp_service import WhatsAppService"` succeeds
2. No TODO comments in src/services/whatsapp_service.py
3. MediaAttachment creation code present (not just a log message)
4. tracking_number extracted from ticket_data and returned in response
</verification>

<success_criteria>
- The two anti-patterns from VERIFICATION.md (line 216 TODO, line 262 tracking_number=None) are resolved
- WhatsAppService.process_incoming_message creates MediaAttachment records when ticket+media exist
- WhatsAppService.process_incoming_message returns tracking_number from ticket_data in response dict
- Response message text includes tracking number for the citizen
</success_criteria>

<output>
After completion, create `.planning/phases/03-citizen-reporting-channels/03-06-SUMMARY.md`
</output>
