---
phase: 03-citizen-reporting-channels
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/api/v1/uploads.py
  - src/api/v1/reports.py
  - src/schemas/report.py
  - src/main.py
autonomous: true

must_haves:
  truths:
    - "Citizen can generate presigned S3 URL for uploading evidence photos"
    - "Citizen can submit report via web portal with description, GPS coordinates, optional photos, and optional manual address"
    - "Web report flows through same AI intake pipeline as WhatsApp (guardrails -> flow -> crew -> ticket)"
    - "GPS coordinates captured from request with accuracy metadata"
    - "Manual address accepted as fallback when GPS unavailable"
    - "Created ticket linked to uploaded media attachments"
    - "Tracking number returned in report submission response"
  artifacts:
    - path: "src/api/v1/uploads.py"
      provides: "Presigned URL generation endpoint for file uploads"
      contains: "generate_presigned_upload"
    - path: "src/api/v1/reports.py"
      provides: "Web portal report submission endpoint"
      contains: "submit_report"
    - path: "src/schemas/report.py"
      provides: "Report submission schemas with GPS and media"
      contains: "ReportSubmitRequest"
  key_links:
    - from: "src/api/v1/reports.py"
      to: "src/agents/flows/intake_flow.py"
      via: "IntakeFlow pipeline for AI processing"
      pattern: "IntakeFlow"
    - from: "src/api/v1/reports.py"
      to: "src/models/media.py"
      via: "Create MediaAttachment records for uploaded files"
      pattern: "MediaAttachment"
    - from: "src/api/v1/uploads.py"
      to: "src/services/storage_service.py"
      via: "StorageService.generate_presigned_post()"
      pattern: "storage_service\\.generate_presigned_post"
---

<objective>
Build the web portal report submission API with presigned file uploads and GPS geolocation capture, giving citizens a web-based alternative to WhatsApp for reporting issues.

Purpose: RPT-02 requires web portal parity with WhatsApp. This plan creates the API endpoints that the React frontend will call for report submission, file uploads, and GPS-based location capture.

Output: Upload presigned URL endpoint, report submission endpoint, GPS/address schemas
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-citizen-reporting-channels/03-RESEARCH.md
@.planning/phases/03-citizen-reporting-channels/03-01-SUMMARY.md
@src/api/v1/messages.py
@src/agents/flows/intake_flow.py
@src/agents/flows/state.py
@src/models/media.py
@src/models/ticket.py
@src/services/storage_service.py
@src/schemas/media.py
@src/schemas/ticket.py
@src/core/config.py
@src/api/deps.py
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Presigned Upload Endpoint and Report Submission API</name>
  <files>
    src/api/v1/uploads.py
    src/api/v1/reports.py
    src/schemas/report.py
    src/main.py
  </files>
  <action>
1. Create `src/schemas/report.py`:

   **LocationData(BaseModel):**
   - latitude: float = Field(ge=-90, le=90)
   - longitude: float = Field(ge=-180, le=180)
   - accuracy: float = Field(gt=0, description="GPS accuracy in meters")
   - source: str = Field(default="gps", description="gps or manual")

   **ReportSubmitRequest(BaseModel):**
   - description: str = Field(..., min_length=10, max_length=5000, description="Issue description")
   - category: str | None = Field(None, description="Optional pre-selected category (water/roads/electricity/waste/sanitation/gbv/other). If None, AI will classify.")
   - location: LocationData | None = Field(None, description="GPS coordinates if available")
   - manual_address: str | None = Field(None, max_length=500, description="Manual address if GPS unavailable")
   - media_file_ids: list[str] = Field(default_factory=list, max_length=5, description="List of file_ids from presigned uploads (max 5)")
   - language: str = Field(default="en", description="User's language preference (en/zu/af)")
   - is_gbv: bool = Field(default=False, description="Whether this is a GBV report (triggers enhanced encryption and SAPS routing)")
   - Validator: Require at least one of location or manual_address:
     ```python
     @model_validator(mode='after')
     def require_location_or_address(self):
         if self.location is None and not self.manual_address:
             raise ValueError("Either GPS location or manual address is required")
         return self
     ```

   **ReportSubmitResponse(BaseModel):**
   - ticket_id: str
   - tracking_number: str
   - category: str
   - status: str
   - message: str (e.g., "Your report has been received. Tracking number: TKT-20260209-A1B2C3")
   - media_count: int

2. Create `src/api/v1/uploads.py`:

   **POST /api/v1/uploads/presigned:**
   - Requires authentication (get_current_user)
   - Request: PresignedUploadRequest (filename, content_type, file_size, purpose)
   - Validate content_type: allowed = ["image/jpeg", "image/png", "image/webp", "application/pdf"]
   - Validate file_size: max 10MB for images, 5MB for PDFs
   - Generate file_id (uuid4)
   - Call StorageService.generate_presigned_post() with user's tenant_id and user_id
   - Return PresignedUploadResponse (url, fields, file_id)

   **POST /api/v1/uploads/confirm:**
   - Requires authentication
   - Request: `{"file_id": str, "purpose": str}` — Confirms that upload to S3 completed
   - Creates MediaAttachment record in database (without ticket_id — will be linked when report submitted)
   - NOTE: MediaAttachment.ticket_id should be nullable for this workflow (upload first, link later)
   - Returns MediaAttachmentResponse

3. Create `src/api/v1/reports.py`:

   **POST /api/v1/reports/submit:**
   - Requires authentication (get_current_user)
   - Request: ReportSubmitRequest
   - Flow:
     1. Validate input through guardrails (process_input on description)
     2. If blocked, return error
     3. Create IntakeState with location data:
        - Set latitude/longitude from location if provided
        - Set address from manual_address or reverse-geocode (skip reverse geocode in v1, just use manual)
     4. If category provided, skip AI classification and create ticket directly
     5. If category NOT provided, run IntakeFlow for AI classification
     6. Create Ticket in database:
        - category, description, latitude, longitude, address, severity, language
        - If is_gbv: set is_sensitive=True, put sensitive description in encrypted_description, set plain description to "GBV incident report"
        - user_id from current_user
        - Generate tracking_number
     7. Link media: For each file_id in media_file_ids, update the existing MediaAttachment record to set ticket_id
     8. If is_gbv: trigger SAPS notification (reuse existing saps_tool logic)
     9. Return ReportSubmitResponse with tracking_number

   **GET /api/v1/reports/{tracking_number}:**
   - Requires authentication
   - Look up ticket by tracking_number
   - Verify ticket belongs to current user (or user is manager/admin)
   - Return TicketResponse with media attachments
   - For GBV tickets: only return encrypted_description if user has SAPS_LIAISON role

   **GET /api/v1/reports/my:**
   - Requires authentication
   - Return list of current user's tickets (paginated, most recent first)
   - Each ticket includes tracking_number, category, status, created_at
   - GBV tickets show "[Sensitive Report]" instead of description for non-SAPS users

4. Register routers in `src/main.py`:
   - Import uploads and reports: `from src.api.v1 import uploads, reports`
   - `app.include_router(uploads.router, prefix="/api/v1")`
   - `app.include_router(reports.router, prefix="/api/v1")`

5. Update `src/models/media.py` if needed: Make ticket_id nullable (nullable=True) to support the "upload first, link to ticket later" workflow. Add index on file_id for fast lookups.
  </action>
  <verify>
    python -c "from src.api.v1.uploads import router as ur; from src.api.v1.reports import router as rr; from src.main import app; routes = [str(r.path) for r in app.routes]; assert '/api/v1/uploads/presigned' in routes; assert '/api/v1/reports/submit' in routes; print('Upload and Report routes registered OK')"
  </verify>
  <done>
    Presigned upload endpoint generates S3 URLs for evidence photos and documents. Report submission endpoint creates tickets with GPS coordinates, links media, handles GBV encryption. My-reports and tracking-number lookup endpoints available. All routes registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: React Frontend Components for Report Submission</name>
  <files>
    frontend/src/components/FileUpload.tsx
    frontend/src/components/GeolocationCapture.tsx
    frontend/src/components/ReportForm.tsx
    frontend/src/hooks/useGeolocation.ts
    frontend/src/services/api.ts
    frontend/package.json
  </files>
  <action>
NOTE: Check if frontend/ directory exists. If not, scaffold a minimal React+Vite app first:
```bash
npm create vite@latest frontend -- --template react-ts
cd frontend && npm install
```

1. Install dependencies:
   ```bash
   cd frontend && npm install react-dropzone@14 axios@1.6
   ```

2. Create `frontend/src/services/api.ts`:
   - API_BASE_URL constant (from env or default http://localhost:8000/api/v1)
   - `getAuthHeaders()`: Return `{ Authorization: "Bearer " + token }` — token from localStorage or context
   - `requestPresignedUrl(filename, contentType, fileSize, purpose)`: POST /uploads/presigned
   - `uploadToS3(presignedUrl, fields, file)`: POST to S3 with FormData
   - `confirmUpload(fileId, purpose)`: POST /uploads/confirm
   - `submitReport(data)`: POST /reports/submit
   - `getMyReports()`: GET /reports/my
   - `getReportByTracking(trackingNumber)`: GET /reports/{trackingNumber}
   - Error handling: throw with meaningful messages

3. Create `frontend/src/hooks/useGeolocation.ts`:
   - Custom hook that wraps HTML5 Geolocation API
   - Returns: `{ coordinates: {latitude, longitude, accuracy} | null, error: string | null, loading: boolean }`
   - Request high accuracy (enableHighAccuracy: true)
   - Timeout: 10 seconds
   - On permission denied: set error = "Location permission denied. Please enter address manually."
   - On unavailable: set error = "Location unavailable. Please enter address manually."
   - On timeout: set error = "Location request timed out. Please enter address manually."

4. Create `frontend/src/components/FileUpload.tsx`:
   - Use react-dropzone for drag-and-drop file selection
   - Props: onFilesSelected, accept (default image/*), maxSize (default 10MB), maxFiles (default 3)
   - Show drag-active state with visual feedback
   - Display file type/size errors from rejected files
   - Accessible: role="button", aria-label for screen readers
   - Show upload progress indicator (simple text: "Uploading 1/3...")
   - On files selected: for each file, call requestPresignedUrl -> uploadToS3 -> confirmUpload
   - Collect file_ids and pass back via callback

5. Create `frontend/src/components/GeolocationCapture.tsx`:
   - Uses useGeolocation hook
   - Shows loading state while GPS resolving
   - If coordinates captured: show "Location captured (accuracy: Xm)" with lat/lng
   - If error: show manual address input field (required)
   - Props: onLocationCaptured(location: LocationData), onAddressEntered(address: string)

6. Create `frontend/src/components/ReportForm.tsx`:
   - Complete report submission form combining all components:
   - Fields:
     - Description textarea (required, min 10 chars)
     - Category dropdown (optional — "Let AI classify" option)
     - GeolocationCapture component
     - FileUpload component (optional evidence photos)
     - GBV toggle (checkbox: "This is a gender-based violence or abuse report")
     - Language selector (en/zu/af)
     - Submit button
   - On submit:
     1. Collect form data
     2. Build ReportSubmitRequest
     3. Call submitReport API
     4. On success: show tracking number, clear form
     5. On error: show error message
   - If GBV selected: show consent dialog and warning about SAPS routing
   - Basic Tailwind CSS styling (or inline styles if Tailwind not set up)
  </action>
  <verify>
    cd frontend && npx tsc --noEmit 2>&1 | head -20 || echo "TypeScript check done (some errors OK for missing types)"
  </verify>
  <done>
    React frontend has FileUpload (drag-drop with presigned S3 upload), GeolocationCapture (HTML5 GPS with manual fallback), ReportForm (complete submission form). API service handles all backend calls. useGeolocation hook encapsulates browser geolocation. All components type-safe in TypeScript.
  </done>
</task>

</tasks>

<verification>
- Presigned upload endpoint returns valid S3 URL and fields
- Report submission creates ticket with correct category, location, and media links
- GBV reports set is_sensitive=True and encrypt description
- GPS coordinates stored in ticket (latitude/longitude)
- Manual address accepted when GPS unavailable
- My-reports endpoint returns paginated user tickets
- Tracking number lookup returns ticket details
- React components render without errors
- TypeScript compilation passes (or minimal errors)
- `pytest tests/ -x` passes (no regressions)
</verification>

<success_criteria>
- Citizens can upload evidence photos via presigned S3 URLs from web browser
- Citizens can submit reports with GPS or manual address
- AI classifies reports when category not specified
- GBV reports encrypted and flagged for SAPS routing
- Tracking number returned for every report
- React frontend provides complete report submission UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-citizen-reporting-channels/03-04-SUMMARY.md`
</output>
