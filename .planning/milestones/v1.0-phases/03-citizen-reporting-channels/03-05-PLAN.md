---
phase: 03-citizen-reporting-channels
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - tests/test_storage_service.py
  - tests/test_encryption.py
  - tests/test_ocr_service.py
  - tests/test_image_utils.py
  - tests/test_whatsapp_webhook.py
  - tests/test_whatsapp_service.py
  - tests/test_verification_api.py
  - tests/test_uploads_api.py
  - tests/test_reports_api.py
autonomous: true

must_haves:
  truths:
    - "All Phase 3 services have unit tests with mocked external dependencies (S3, Twilio, Tesseract)"
    - "StorageService tests verify presigned URL generation and media download/upload"
    - "EncryptedString tests verify encrypt/decrypt cycle and plaintext fallback mode"
    - "OCR tests verify address extraction patterns and confidence scoring"
    - "WhatsApp webhook tests verify signature validation and message processing"
    - "Report submission tests verify ticket creation with GPS, media, and GBV encryption"
    - "All Phase 1-2 tests still pass (regression check)"
    - "Phase 3 code achieves >=80% line coverage"
  artifacts:
    - path: "tests/test_storage_service.py"
      provides: "Unit tests for S3 storage service"
      contains: "test_generate_presigned_post"
    - path: "tests/test_encryption.py"
      provides: "Unit tests for Fernet encryption type"
      contains: "test_encrypt_decrypt_cycle"
    - path: "tests/test_whatsapp_webhook.py"
      provides: "Unit tests for WhatsApp webhook endpoint"
      contains: "test_valid_twilio_signature"
    - path: "tests/test_reports_api.py"
      provides: "Unit tests for report submission API"
      contains: "test_submit_report"
  key_links:
    - from: "tests/test_whatsapp_webhook.py"
      to: "src/api/v1/whatsapp.py"
      via: "TestClient POST to webhook endpoint"
      pattern: "client\\.post.*whatsapp"
    - from: "tests/test_reports_api.py"
      to: "src/api/v1/reports.py"
      via: "TestClient POST to submit endpoint"
      pattern: "client\\.post.*reports"
---

<objective>
Comprehensive test suite for all Phase 3 code — storage, encryption, OCR, WhatsApp, uploads, reports, and verification — with regression check against Phases 1-2.

Purpose: Phase verification policy requires >=80% coverage on phase code, all tests passing, and no regressions. This plan creates focused unit tests with mocked external dependencies so tests run without AWS, Twilio, or Tesseract.

Output: 9 test files covering all Phase 3 modules, regression verification, coverage report
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-citizen-reporting-channels/03-01-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-02-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-03-SUMMARY.md
@.planning/phases/03-citizen-reporting-channels/03-04-SUMMARY.md
@tests/conftest.py
@src/services/storage_service.py
@src/core/encryption.py
@src/services/ocr_service.py
@src/services/whatsapp_service.py
@src/api/v1/whatsapp.py
@src/api/v1/uploads.py
@src/api/v1/reports.py
@src/api/v1/verification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit Tests for Phase 3 Services (Storage, Encryption, OCR, WhatsApp, Image Utils)</name>
  <files>
    tests/test_storage_service.py
    tests/test_encryption.py
    tests/test_ocr_service.py
    tests/test_image_utils.py
    tests/test_whatsapp_service.py
  </files>
  <action>
1. Create `tests/test_storage_service.py` (8-10 tests):
   - Mock boto3 client using unittest.mock.patch
   - `test_generate_presigned_post_evidence`: Verify correct bucket, key pattern, expiry for evidence uploads
   - `test_generate_presigned_post_documents`: Verify correct bucket for proof_of_residence purpose
   - `test_generate_presigned_post_invalid_purpose`: Verify error on invalid purpose
   - `test_download_and_upload_media`: Mock httpx response and S3 put_object, verify media downloaded and uploaded
   - `test_download_and_upload_media_failure`: Mock httpx error, verify graceful handling
   - `test_generate_presigned_get`: Verify presigned GET URL generation
   - `test_storage_service_no_credentials`: Verify StorageServiceError when AWS not configured
   - `test_s3_key_format`: Verify S3 key follows pattern {purpose}/{tenant_id}/{file_id}/{filename}

2. Create `tests/test_encryption.py` (8-10 tests):
   - `test_encrypt_decrypt_cycle`: Encrypt a string, verify decryption returns original
   - `test_encrypt_none_value`: Verify None passthrough
   - `test_decrypt_none_value`: Verify None passthrough
   - `test_plaintext_mode_no_key`: When ENCRYPTION_KEY_CURRENT is empty, value stored as-is
   - `test_key_rotation_decrypt_with_previous`: Encrypt with key A, rotate to key B (A becomes previous), verify decryption still works
   - `test_invalid_key_format`: Verify error on non-base64 key
   - `test_encrypted_string_different_ciphertext`: Same plaintext produces different ciphertext (Fernet uses random IV)
   - `test_encrypted_string_type_decorator`: Test process_bind_param and process_result_value directly
   - Use `from cryptography.fernet import Fernet; Fernet.generate_key()` to create test keys

3. Create `tests/test_ocr_service.py` (8-10 tests):
   - Mock pytesseract calls to avoid requiring Tesseract installation
   - `test_extract_address_street_pattern`: Verify regex matches "123 Main Street, Johannesburg, 2000"
   - `test_extract_address_po_box`: Verify regex matches "P.O. Box 456, Pretoria, 0001"
   - `test_extract_address_no_match`: Verify None when no address pattern found
   - `test_detect_document_type_utility`: Verify "utility_bill" for electricity/Eskom text
   - `test_detect_document_type_bank`: Verify "bank_statement" for FNB/Capitec text
   - `test_detect_document_type_unknown`: Verify None for unrecognized text
   - `test_determine_verification_high_confidence`: confidence >= 0.7 with address+name -> "verified"
   - `test_determine_verification_low_confidence`: confidence < 0.5 -> "rejected"
   - `test_determine_verification_medium_confidence`: 0.5-0.7 -> "pending"
   - `test_tesseract_not_installed`: Mock TesseractNotFoundError, verify graceful degradation

4. Create `tests/test_image_utils.py` (6-8 tests):
   - Create small test images programmatically using PIL.Image
   - `test_strip_exif_metadata`: Create image with fake EXIF, strip it, verify metadata gone
   - `test_strip_exif_preserves_pixels`: Verify image content unchanged after stripping
   - `test_preprocess_for_ocr_grayscale`: Verify output is grayscale
   - `test_preprocess_for_ocr_binary_threshold`: Verify pixels are only 0 or 255
   - `test_validate_image_quality_valid`: 1000x800 image passes
   - `test_validate_image_quality_too_small`: 400x300 image fails
   - `test_extract_gps_no_exif`: Verify None returned for image without GPS

5. Create `tests/test_whatsapp_service.py` (6-8 tests):
   - Mock Twilio client and StorageService
   - `test_lookup_user_by_phone_found`: Mock DB query returning user
   - `test_lookup_user_by_phone_not_found`: Mock DB query returning None
   - `test_lookup_user_normalizes_number`: Verify +27 and 0-prefix normalization
   - `test_process_incoming_message_text`: Process text message, verify pipeline called
   - `test_process_incoming_message_with_media`: Process message with media URLs, verify S3 upload called
   - `test_send_whatsapp_message`: Mock Twilio create, verify message sent
   - `test_send_whatsapp_no_client`: Verify graceful handling when Twilio not configured

   **Mocking strategy for all tests:**
   - Use `unittest.mock.patch` and `unittest.mock.MagicMock`
   - Mock external services (boto3, httpx, pytesseract, twilio) at module boundary
   - Never call real external APIs in tests
   - Use `monkeypatch.setattr` for settings overrides where needed
  </action>
  <verify>
    pytest tests/test_storage_service.py tests/test_encryption.py tests/test_ocr_service.py tests/test_image_utils.py tests/test_whatsapp_service.py -v --tb=short 2>&1 | tail -20
  </verify>
  <done>
    All service-level unit tests pass with mocked external dependencies. Storage, encryption, OCR, image utils, and WhatsApp service tested. No real API calls in tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: API Endpoint Tests, Regression Check, and Coverage Verification</name>
  <files>
    tests/test_whatsapp_webhook.py
    tests/test_verification_api.py
    tests/test_uploads_api.py
    tests/test_reports_api.py
  </files>
  <action>
1. Create `tests/test_whatsapp_webhook.py` (8-10 tests):
   - Use FastAPI TestClient
   - Mock WhatsAppService and Twilio RequestValidator
   - `test_webhook_valid_signature`: Valid signature processes message, returns TwiML
   - `test_webhook_invalid_signature`: Invalid signature returns 403
   - `test_webhook_no_signature`: Missing signature header returns 403 (or processes if no auth token configured)
   - `test_webhook_unregistered_user`: Phone not found, returns registration prompt TwiML
   - `test_webhook_with_media`: Message with NumMedia > 0 triggers media download
   - `test_webhook_empty_body`: No text but has media, still processes
   - `test_webhook_returns_twiml`: Verify response Content-Type is application/xml
   - `test_status_callback`: Status update logged correctly

2. Create `tests/test_verification_api.py` (6-8 tests):
   - Mock OCRService and StorageService
   - Override get_current_user dependency for auth
   - `test_verify_proof_of_residence_success`: OCR returns high confidence, user updated to verified
   - `test_verify_proof_of_residence_low_confidence`: OCR returns low confidence, status set to rejected
   - `test_verify_proof_of_residence_medium`: OCR returns medium confidence, status set to pending
   - `test_verify_already_verified`: Returns error if user already verified
   - `test_upload_url_for_documents`: Presigned URL generated with correct purpose
   - `test_verification_status`: Returns current verification status
   - `test_popia_consent_message`: Upload URL response includes consent text

3. Create `tests/test_uploads_api.py` (6-8 tests):
   - Mock StorageService
   - `test_presigned_upload_image`: Valid image request returns URL and fields
   - `test_presigned_upload_pdf`: Valid PDF request returns URL and fields
   - `test_presigned_upload_invalid_type`: Rejected for unsupported content type
   - `test_presigned_upload_too_large`: Rejected for file exceeding max size
   - `test_confirm_upload`: Creates MediaAttachment record
   - `test_confirm_upload_invalid_file_id`: Returns 404 for unknown file_id
   - `test_presigned_upload_requires_auth`: Returns 401 without JWT

4. Create `tests/test_reports_api.py` (10-12 tests):
   - Mock IntakeFlow, StorageService, and DB
   - Override get_current_user for auth
   - `test_submit_report_with_gps`: Report with GPS coordinates creates ticket with lat/lng
   - `test_submit_report_with_address`: Report with manual address creates ticket
   - `test_submit_report_no_location`: Returns 422 if neither GPS nor address provided
   - `test_submit_report_with_category`: Pre-selected category skips AI classification
   - `test_submit_report_without_category`: AI classifies when category is None
   - `test_submit_report_with_media`: Media file_ids linked to created ticket
   - `test_submit_report_gbv_encrypted`: GBV report encrypts description, sets is_sensitive
   - `test_submit_report_returns_tracking`: Response includes tracking_number
   - `test_get_report_by_tracking`: Lookup by tracking number returns ticket
   - `test_get_report_wrong_user`: Returns 403 if ticket belongs to different user
   - `test_my_reports_paginated`: Returns user's tickets in reverse chronological order
   - `test_my_reports_gbv_redacted`: GBV ticket description redacted for non-SAPS users

5. **Regression check:**
   - Run full test suite: `pytest tests/ -x --tb=short`
   - All Phase 1 tests (99+) must pass
   - All Phase 2 tests (100+) must pass
   - All Phase 3 tests must pass

6. **Coverage verification:**
   - Run: `pytest tests/ --cov=src --cov-report=term-missing --tb=short`
   - Phase 3 modules should achieve >=80% coverage:
     - src/services/storage_service.py
     - src/services/ocr_service.py
     - src/services/image_utils.py
     - src/services/whatsapp_service.py
     - src/core/encryption.py
     - src/api/v1/whatsapp.py
     - src/api/v1/verification.py
     - src/api/v1/uploads.py
     - src/api/v1/reports.py
   - If coverage below 80%, add targeted tests for uncovered lines

7. **Fix any test failures:**
   - If any Phase 1-2 tests break due to model changes (new fields), update those tests
   - Common fix: User model now has verification_status default, Ticket has encrypted_description
   - Add new fields to test fixtures/factories
  </action>
  <verify>
    pytest tests/ -x --tb=short 2>&1 | tail -5 && pytest tests/ --cov=src/services --cov=src/core/encryption --cov=src/api/v1/whatsapp --cov=src/api/v1/verification --cov=src/api/v1/uploads --cov=src/api/v1/reports --cov-report=term-missing --tb=short 2>&1 | tail -20
  </verify>
  <done>
    All Phase 3 API endpoint tests pass. Full regression suite passes (Phase 1 + 2 + 3). Phase 3 code achieves >=80% line coverage. No regressions introduced by model changes. Coverage report generated.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/ -x` — all tests pass (0 failures)
- `pytest tests/ --cov=src --cov-report=term-missing` — >=80% on Phase 3 modules
- Phase 1 regression: 99+ tests pass
- Phase 2 regression: 100+ tests pass
- Phase 3 tests: 60+ new tests
- No external API calls in any test (all mocked)
</verification>

<success_criteria>
- 60+ new tests covering all Phase 3 services and endpoints
- All tests pass including Phase 1-2 regression
- Phase 3 code >=80% line coverage
- No unmocked external service calls (S3, Twilio, Tesseract)
- Coverage report confirms compliance with phase verification policy
</success_criteria>

<output>
After completion, create `.planning/phases/03-citizen-reporting-channels/03-05-SUMMARY.md`
</output>
