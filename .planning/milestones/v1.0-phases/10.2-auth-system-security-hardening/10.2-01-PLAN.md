---
phase: 10.2-auth-system-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/user.py
  - src/api/v1/auth.py
  - src/models/audit_log.py
  - tests/test_security_unit.py
autonomous: true
requirements:
  - SEC-06
  - SEC-07
  - SEC-08

must_haves:
  truths:
    - "Registration rejects passwords shorter than 12 characters with clear error message"
    - "Registration rejects passwords missing uppercase, lowercase, or digit with specific error message"
    - "Login success events are logged with POPIA-safe data (email domain only, no full email)"
    - "Login failure events are logged with IP address and generic reason (no PII)"
    - "OTP send and verify events are logged"
    - "Registration events are logged"
    - "Token refresh events are logged"
    - "OperationType enum includes AUTH_LOGIN_SUCCESS, AUTH_LOGIN_FAILURE, AUTH_REGISTER, AUTH_OTP_SEND, AUTH_OTP_VERIFY, AUTH_TOKEN_REFRESH"
  artifacts:
    - path: "src/schemas/user.py"
      provides: "Password complexity validator on UserCreate"
      contains: "validate_password_complexity"
    - path: "src/api/v1/auth.py"
      provides: "Auth event logging helper and logging calls on all endpoints"
      contains: "_log_auth_event"
    - path: "src/models/audit_log.py"
      provides: "Extended OperationType enum with auth event types"
      contains: "AUTH_LOGIN_SUCCESS"
    - path: "tests/test_security_unit.py"
      provides: "TestPasswordValidation and TestAuthEventLogging test classes"
      contains: "TestPasswordValidation"
  key_links:
    - from: "src/api/v1/auth.py"
      to: "src/models/audit_log.py"
      via: "OperationType enum import for structured logging"
      pattern: "OperationType\\.AUTH_"
    - from: "src/schemas/user.py"
      to: "src/api/v1/auth.py"
      via: "UserCreate used in RegisterRequest (inherited)"
      pattern: "class RegisterRequest\\(UserCreate\\)"
---

<objective>
Harden the authentication backend with strong password validation and POPIA-safe auth event audit logging.

Purpose: Close two HIGH-priority security gaps identified in the Phase 10.2 research: (1) password policy allows only 8 chars with no complexity rules, and (2) no auth event logging exists in the FastAPI layer despite Supabase handling auth server-side.

Output: Strengthened password validator in Pydantic schema (12 chars, uppercase+lowercase+digit), POPIA-compliant auth event logging helper called from all 6 auth endpoints (register, login, refresh, OTP send, OTP verify), extended OperationType enum, and comprehensive unit tests.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.2-auth-system-security-hardening/10.2-RESEARCH.md
@src/schemas/user.py
@src/schemas/auth.py
@src/api/v1/auth.py
@src/models/audit_log.py
@src/middleware/rate_limit.py
@tests/test_security_unit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strengthen password validation and extend OperationType enum</name>
  <files>src/schemas/user.py, src/models/audit_log.py</files>
  <action>
**1. src/schemas/user.py — Add password complexity validator to UserCreate:**

Add `import re` and `field_validator` import. Add a `@field_validator("password")` class method named `validate_password_complexity` to the `UserCreate` class:

- Change `password: str = Field(..., min_length=8)` to `password: str = Field(..., min_length=12, max_length=128)`
- Add the validator that collects all missing requirements and raises a single ValueError with comma-separated list:
  - At least one uppercase letter (`[A-Z]`)
  - At least one lowercase letter (`[a-z]`)
  - At least one digit (`\d`)
- Error format: `"Password must contain: at least one uppercase letter, at least one digit"` (only failed checks listed)
- Do NOT require symbols (usability tradeoff for citizens, per research decision)

**2. src/models/audit_log.py — Extend OperationType enum:**

Add 6 new enum values to OperationType:
- `AUTH_LOGIN_SUCCESS = "AUTH_LOGIN_SUCCESS"`
- `AUTH_LOGIN_FAILURE = "AUTH_LOGIN_FAILURE"`
- `AUTH_REGISTER = "AUTH_REGISTER"`
- `AUTH_OTP_SEND = "AUTH_OTP_SEND"`
- `AUTH_OTP_VERIFY = "AUTH_OTP_VERIFY"`
- `AUTH_TOKEN_REFRESH = "AUTH_TOKEN_REFRESH"`

These extend (not replace) the existing CREATE/READ/UPDATE/DELETE values.
  </action>
  <verify>
    <automated>cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine && python -c "from src.schemas.user import UserCreate; from src.models.audit_log import OperationType; print('OK:', OperationType.AUTH_LOGIN_SUCCESS.value)"</automated>
    <manual>Verify UserCreate password field has min_length=12 and the validator imports compile correctly</manual>
  </verify>
  <done>UserCreate password field requires 12+ chars with uppercase+lowercase+digit complexity. OperationType enum has 10 values (4 original + 6 new auth types). Both import without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add POPIA-safe auth event logging to all auth endpoints</name>
  <files>src/api/v1/auth.py</files>
  <action>
**Add `_log_auth_event()` helper function** at module level in `src/api/v1/auth.py`, after the existing `CONSENT_DESCRIPTIONS` dict:

```python
def _log_auth_event(
    event: str,
    request: Request,
    email_domain: str | None = None,
    user_id: str | None = None,
    reason: str | None = None,
) -> None:
    """Log auth event with POPIA-safe data (no full email addresses).

    POPIA compliance: Only email domain is logged (never full email).
    User IDs are truncated to first 8 chars for correlation without exposure.
    """
    extra = {
        "event": event,
        "ip": request.client.host if request.client else "unknown",
        "user_agent": request.headers.get("user-agent", "unknown")[:200],
    }
    if email_domain:
        extra["email_domain"] = email_domain
    if user_id:
        extra["user_id"] = user_id[:8] + "..."
    if reason:
        extra["reason"] = reason

    if "failure" in event or "error" in event:
        logger.warning(f"auth.event: {event}", extra=extra)
    else:
        logger.info(f"auth.event: {event}", extra=extra)
```

**Then add logging calls to ALL 5 auth endpoints:**

1. **register** endpoint:
   - After successful user creation (line ~120, after `supabase_user_id = auth_response.user.id`): `_log_auth_event("register_success", request, email_domain=registration.email.split("@")[-1], user_id=str(supabase_user_id))`
   - In the except block (line ~122): `_log_auth_event("register_failure", request, email_domain=registration.email.split("@")[-1], reason="supabase_creation_failed")`

2. **login** endpoint:
   - After successful token extraction (before `return TokenResponse`): `_log_auth_event("login_success", request, email_domain=credentials.email.split("@")[-1])`
   - In the except block (line ~222): Replace `logger.warning(f"Login attempt failed: {e}")` with `_log_auth_event("login_failure", request, email_domain=credentials.email.split("@")[-1], reason="invalid_credentials")`

3. **refresh_token** endpoint:
   - After successful refresh (before `return TokenResponse`): `_log_auth_event("token_refresh_success", request)`
   - In the except block: Replace `logger.warning(f"Token refresh failed: {e}")` with `_log_auth_event("token_refresh_failure", request, reason="invalid_refresh_token")`

4. **send_phone_otp** endpoint:
   - After successful send (before `return`): `_log_auth_event("otp_send_success", request)`
   - In the except block: Replace `logger.error(...)` with `_log_auth_event("otp_send_failure", request, reason="send_failed")`

5. **verify_phone_otp** endpoint:
   - After successful verify (before `return TokenResponse`): `_log_auth_event("otp_verify_success", request)`
   - In the except block: Replace `logger.warning(...)` with `_log_auth_event("otp_verify_failure", request, reason="invalid_otp")`

**CRITICAL POPIA rules:**
- NEVER log full email addresses — only `email.split("@")[-1]` (domain)
- NEVER log phone numbers
- Truncate user_id to 8 chars
- Truncate user-agent to 200 chars
  </action>
  <verify>
    <automated>cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine && python -c "from src.api.v1.auth import _log_auth_event; print('_log_auth_event imported OK')"</automated>
    <manual>Inspect auth.py — every endpoint should have success and failure logging calls. No full email addresses in any log call.</manual>
  </verify>
  <done>All 5 auth endpoints (register, login, refresh, OTP send, OTP verify) log success and failure events via _log_auth_event. Zero PII in log output — only email domain, truncated user_id, generic reason strings.</done>
</task>

<task type="auto">
  <name>Task 3: Add password validation and auth event logging unit tests</name>
  <files>tests/test_security_unit.py</files>
  <action>
**Add two new test classes to the EXISTING `tests/test_security_unit.py` file** (after the existing `TestSupabaseJWTVerification` class). Do NOT create a new test file.

**Class 1: TestPasswordValidation**

```python
class TestPasswordValidation:
    """Test password complexity validation on UserCreate schema."""

    def test_password_min_length_12_accepted(self):
        """Password with 12+ chars and complexity requirements is accepted."""
        user = UserCreate(
            email="test@example.com",
            password="SecurePass12",
            full_name="Test User",
            municipality_code="JHB",
        )
        assert user.password == "SecurePass12"

    def test_password_below_12_chars_rejected(self):
        """Password shorter than 12 characters is rejected."""
        with pytest.raises(ValidationError) as exc_info:
            UserCreate(
                email="test@example.com",
                password="Short1A",
                full_name="Test User",
                municipality_code="JHB",
            )
        assert "at least 12 characters" in str(exc_info.value).lower() or "ensure this value has at least 12" in str(exc_info.value).lower()

    def test_password_missing_uppercase_rejected(self):
        """Password without uppercase letter is rejected."""
        with pytest.raises(ValidationError) as exc_info:
            UserCreate(
                email="test@example.com",
                password="alllowercase1",
                full_name="Test User",
                municipality_code="JHB",
            )
        assert "uppercase" in str(exc_info.value).lower()

    def test_password_missing_lowercase_rejected(self):
        """Password without lowercase letter is rejected."""
        with pytest.raises(ValidationError) as exc_info:
            UserCreate(
                email="test@example.com",
                password="ALLUPPERCASE1",
                full_name="Test User",
                municipality_code="JHB",
            )
        assert "lowercase" in str(exc_info.value).lower()

    def test_password_missing_digit_rejected(self):
        """Password without digit is rejected."""
        with pytest.raises(ValidationError) as exc_info:
            UserCreate(
                email="test@example.com",
                password="NoDigitsHere!",
                full_name="Test User",
                municipality_code="JHB",
            )
        assert "digit" in str(exc_info.value).lower()

    def test_password_multiple_failures_reported(self):
        """Multiple missing requirements reported in single error."""
        with pytest.raises(ValidationError) as exc_info:
            UserCreate(
                email="test@example.com",
                password="nouppernodgt",
                full_name="Test User",
                municipality_code="JHB",
            )
        error_str = str(exc_info.value).lower()
        assert "uppercase" in error_str
        assert "digit" in error_str

    def test_password_symbols_not_required(self):
        """Password without symbols is accepted (symbols are optional)."""
        user = UserCreate(
            email="test@example.com",
            password="ValidPass1234",
            full_name="Test User",
            municipality_code="JHB",
        )
        assert user.password == "ValidPass1234"

    def test_password_max_length_128(self):
        """Password exceeding 128 characters is rejected."""
        with pytest.raises(ValidationError):
            UserCreate(
                email="test@example.com",
                password="A" * 100 + "a" * 20 + "1" * 10,  # 130 chars
                full_name="Test User",
                municipality_code="JHB",
            )
```

**Class 2: TestAuthEventLogging**

```python
class TestAuthEventLogging:
    """Test POPIA-safe auth event logging helper."""

    def test_log_auth_event_success_uses_info(self):
        """Success events logged at INFO level."""
        mock_request = MagicMock()
        mock_request.client.host = "192.168.1.1"
        mock_request.headers.get.return_value = "Mozilla/5.0"

        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("login_success", mock_request, email_domain="example.com")
            mock_logger.info.assert_called_once()
            call_args = mock_logger.info.call_args
            assert "login_success" in call_args[0][0]

    def test_log_auth_event_failure_uses_warning(self):
        """Failure events logged at WARNING level."""
        mock_request = MagicMock()
        mock_request.client.host = "10.0.0.1"
        mock_request.headers.get.return_value = "curl/7.0"

        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("login_failure", mock_request, reason="invalid_credentials")
            mock_logger.warning.assert_called_once()

    def test_log_auth_event_no_full_email(self):
        """Auth event logs email domain only, never full email."""
        mock_request = MagicMock()
        mock_request.client.host = "10.0.0.1"
        mock_request.headers.get.return_value = "test"

        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("login_success", mock_request, email_domain="example.com")
            call_kwargs = mock_logger.info.call_args[1]
            extra = call_kwargs.get("extra", {})
            assert extra.get("email_domain") == "example.com"
            # Verify no 'email' key in extra (only domain)
            assert "email" not in extra or extra.get("email") is None

    def test_log_auth_event_truncates_user_id(self):
        """User ID truncated to 8 chars for POPIA compliance."""
        mock_request = MagicMock()
        mock_request.client.host = "10.0.0.1"
        mock_request.headers.get.return_value = "test"

        full_uuid = "12345678-1234-1234-1234-123456789012"
        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("register_success", mock_request, user_id=full_uuid)
            call_kwargs = mock_logger.info.call_args[1]
            extra = call_kwargs.get("extra", {})
            assert extra.get("user_id") == "12345678..."
            assert full_uuid not in str(extra)

    def test_log_auth_event_handles_missing_client(self):
        """Handles request with no client (e.g., test environment)."""
        mock_request = MagicMock()
        mock_request.client = None
        mock_request.headers.get.return_value = "test"

        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("login_success", mock_request)
            call_kwargs = mock_logger.info.call_args[1]
            extra = call_kwargs.get("extra", {})
            assert extra.get("ip") == "unknown"

    def test_log_auth_event_truncates_user_agent(self):
        """User-agent truncated to 200 chars to prevent log injection."""
        mock_request = MagicMock()
        mock_request.client.host = "10.0.0.1"
        mock_request.headers.get.return_value = "A" * 500

        with patch("src.api.v1.auth.logger") as mock_logger:
            _log_auth_event("login_success", mock_request)
            call_kwargs = mock_logger.info.call_args[1]
            extra = call_kwargs.get("extra", {})
            assert len(extra.get("user_agent", "")) <= 200
```

**Required imports to add at top of file:**
- `import pytest`
- `from unittest.mock import MagicMock, patch`
- `from pydantic import ValidationError`
- `from src.schemas.user import UserCreate`
- `from src.api.v1.auth import _log_auth_event`
  </action>
  <verify>
    <automated>cd C:/Users/Bantu/mzansi-agentive/salga-trust-engine && python -m pytest tests/test_security_unit.py -x -q</automated>
    <manual>All tests green. Existing JWT verification tests still pass alongside new password and logging tests.</manual>
    <sampling_rate>run after this task commits, before any further work</sampling_rate>
  </verify>
  <done>TestPasswordValidation (8 tests) covers min length, complexity requirements, multiple failures, symbols optional, max length. TestAuthEventLogging (6 tests) covers INFO vs WARNING levels, POPIA-safe domain-only logging, user_id truncation, missing client handling, user-agent truncation. All tests pass alongside existing JWT tests.</done>
</task>

</tasks>

<verification>
1. Run full security test file: `pytest tests/test_security_unit.py -x -q` — all tests pass (existing + new)
2. Run full test suite: `pytest tests/ -q --ignore=tests/test_api_security_audit.py` — no regressions
3. Verify no PII in auth.py logging calls: `grep -n "credentials.email\b" src/api/v1/auth.py` returns 0 matches (only split("@")[-1] usage)
4. Verify password min_length: `grep "min_length" src/schemas/user.py` shows 12, not 8
5. Verify OperationType has auth values: `grep "AUTH_" src/models/audit_log.py` shows 6 entries
</verification>

<success_criteria>
- Password validation rejects "short1A" (too short), "alllowercase1" (no uppercase), "ALLUPPERCASE1" (no lowercase), "NoDigitsHere!" (no digit)
- Password validation accepts "SecurePass12" (meets all requirements)
- All auth endpoints log success and failure events via _log_auth_event
- No full email addresses appear in any logging statement in auth.py
- OperationType enum has 10 values total
- All tests in test_security_unit.py pass (existing + new)
- No regressions in broader test suite
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-auth-system-security-hardening/10.2-01-SUMMARY.md`
</output>
