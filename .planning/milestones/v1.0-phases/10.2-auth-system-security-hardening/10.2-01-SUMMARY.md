---
phase: 10.2-auth-system-security-hardening
plan: 01
subsystem: auth
tags: [security, password-validation, popia, audit-logging, hardening]
dependency_graph:
  requires: []
  provides: [password-complexity-enforcement, auth-event-logging]
  affects: [src/schemas/user.py, src/api/v1/auth.py, src/models/audit_log.py]
tech_stack:
  added: []
  patterns: [pydantic-field-validator, popia-safe-logging, structured-auth-events]
key_files:
  created:
    - tests/test_security_unit.py (expanded with 2 new test classes)
  modified:
    - src/schemas/user.py
    - src/models/audit_log.py
    - src/api/v1/auth.py
    - tests/test_security_unit.py
decisions:
  - "Symbols not required in password policy — usability tradeoff for citizens per research decision"
  - "POPIA: only email domain logged in auth events (never full email)"
  - "User IDs truncated to 8 chars in log output for correlation without full exposure"
  - "Failure events use WARNING level, success events use INFO level"
  - "OperationType enum extended (not replaced) with 6 new AUTH_ values"
metrics:
  duration: 1616s
  completed: 2026-02-25
  tasks_completed: 3
  files_modified: 4
---

# Phase 10.2 Plan 01: Auth Security Hardening — Password Validation and POPIA-Safe Audit Logging Summary

**One-liner:** Strengthened password policy (12 chars, complexity) and added POPIA-compliant auth event logging across all 5 auth endpoints with structured `_log_auth_event()` helper.

## What Was Built

### Password Complexity Enforcement (SEC-06)

`src/schemas/user.py` — `UserCreate` schema now enforces:
- Minimum 12 characters (raised from 8), maximum 128 characters
- At least one uppercase letter (`[A-Z]`)
- At least one lowercase letter (`[a-z]`)
- At least one digit (`\d`)
- Symbols NOT required (usability decision for citizens)
- All missing requirements reported in a single comma-separated error message

### OperationType Enum Extension (SEC-07)

`src/models/audit_log.py` — 6 new enum values added:
- `AUTH_LOGIN_SUCCESS`
- `AUTH_LOGIN_FAILURE`
- `AUTH_REGISTER`
- `AUTH_OTP_SEND`
- `AUTH_OTP_VERIFY`
- `AUTH_TOKEN_REFRESH`

Original 4 values (CREATE, READ, UPDATE, DELETE) preserved.

### POPIA-Safe Auth Event Logging (SEC-08)

`src/api/v1/auth.py` — New `_log_auth_event()` helper function and logging calls on all 5 endpoints:

| Endpoint | Success Event | Failure Event |
|----------|--------------|---------------|
| `/register` | `register_success` | `register_failure` |
| `/login` | `login_success` | `login_failure` |
| `/refresh` | `token_refresh_success` | `token_refresh_failure` |
| `/otp/send` | `otp_send_success` | `otp_send_failure` |
| `/otp/verify` | `otp_verify_success` | `otp_verify_failure` |

POPIA compliance enforced:
- Email domain only logged (`.split("@")[-1]`) — never full email
- User ID truncated to 8 chars + "..."
- User-agent truncated to 200 chars (log injection prevention)
- Missing `request.client` handled gracefully (logs "unknown" for IP)
- Failure/error events: WARNING level; success events: INFO level

### Unit Tests

`tests/test_security_unit.py` — 2 new test classes added (14 new tests):

**TestPasswordValidation (8 tests):**
- Min 12 chars accepted, below-12 rejected
- Missing uppercase rejected
- Missing lowercase rejected
- Missing digit rejected
- Multiple failures reported in single error
- Symbols not required (optional)
- Max 128 chars enforced

**TestAuthEventLogging (6 tests):**
- Success events use INFO level
- Failure events use WARNING level
- No full email in log output (domain only)
- User ID truncated to 8 chars
- Missing client handled gracefully
- User-agent truncated to 200 chars

## Verification Results

```
tests/test_security_unit.py: 20 passed (6 JWT + 8 password + 6 logging)
tests/test_auth.py: 9 skipped (PostgreSQL integration, expected)
tests/test_middleware.py: 7 passed, 8 skipped
tests/test_tenant_unit.py: 3 passed
Total: 30 passed, 17 skipped, 0 failed
```

Additional checks:
- `grep "min_length" src/schemas/user.py` → shows 12 (not 8)
- `grep "AUTH_" src/models/audit_log.py` → 6 entries
- No bare full email in any logger call in auth.py

## Commits

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Strengthen password validation + extend OperationType | a7453ee | src/schemas/user.py, src/models/audit_log.py |
| 2 | Add POPIA-safe auth event logging to all endpoints | a9c44af | src/api/v1/auth.py |
| 3 | Add unit tests (TestPasswordValidation + TestAuthEventLogging) | 6a080a0 | tests/test_security_unit.py |

## Deviations from Plan

**1. [Rule 1 - Bug] Removed PII-leaking logger.error in register except block**

- **Found during:** Task 2
- **Issue:** The original `logger.error(f"Supabase Auth user creation failed: {e}", exc_info=True)` could expose the full email address if the exception message from Supabase included it
- **Fix:** Replaced with a sanitized message `"Supabase Auth user creation failed (see structured log for domain)"` while keeping `exc_info=True` for the traceback. The `_log_auth_event("register_failure", ...)` call already handles structured POPIA-safe logging.
- **Files modified:** src/api/v1/auth.py
- **Commit:** a9c44af

## Self-Check: PASSED

Files exist:
- src/schemas/user.py: FOUND
- src/models/audit_log.py: FOUND
- src/api/v1/auth.py: FOUND
- tests/test_security_unit.py: FOUND
- .planning/phases/10.2-auth-system-security-hardening/10.2-01-SUMMARY.md: FOUND

Commits exist:
- a7453ee: FOUND
- a9c44af: FOUND
- 6a080a0: FOUND
