---
phase: 08-wire-web-portal-report-submission
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/v1/reports.py
  - tests/test_reports_api.py
autonomous: true
requirements:
  - RPT-04
  - RPT-08

must_haves:
  truths:
    - "GPS coordinates are persisted as PostGIS location field when a report is submitted with lat/lng (structural verification — runtime requires PostgreSQL+PostGIS)"
    - "Route GET /reports/my is matched before GET /reports/{tracking_number} so /my does not 404"
    - "Unit tests mock ManagerCrew instead of removed IntakeFlow"
    - "GBV encryption path activates when is_gbv=True and a real ticket is created"
  artifacts:
    - path: "src/api/v1/reports.py"
      provides: "PostGIS location assignment via from_shape, route ordering fix, USE_POSTGIS guard"
      contains: "from_shape"
    - path: "tests/test_reports_api.py"
      provides: "Updated test mocks for ManagerCrew pipeline"
      contains: "ManagerCrew"
  key_links:
    - from: "src/api/v1/reports.py"
      to: "src/models/ticket.py"
      via: "Ticket(location=location_value) using WKBElement from from_shape"
      pattern: "location=location_value"
    - from: "tests/test_reports_api.py"
      to: "src/api/v1/reports.py"
      via: "patch('src.api.v1.reports.ManagerCrew')"
      pattern: "ManagerCrew"
---

<objective>
Fix backend report submission bugs and update stale test mocks before frontend wiring.

Purpose: The `reports.py` submit handler has a PostGIS location bug (passes `latitude=`/`longitude=` to Ticket constructor, but these are read-only @property members, not columns). The route `/my` is defined after `/{tracking_number}`, causing a 404. Tests mock `IntakeFlow` which no longer exists. These must be fixed before the frontend can successfully call the API.

Output: Working `POST /api/v1/reports/submit` endpoint that persists GPS coordinates to PostGIS, correct route ordering, and passing test suite with ManagerCrew mocks.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-wire-web-portal-report-submission/08-RESEARCH.md
@src/api/v1/reports.py
@src/models/ticket.py
@src/services/routing_service.py
@tests/test_reports_api.py
@src/schemas/report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PostGIS location bug and route ordering in reports.py</name>
  <files>src/api/v1/reports.py</files>
  <action>
Fix three issues in `src/api/v1/reports.py`:

**1. Add USE_POSTGIS guard and imports (top of file, after existing imports):**
Follow the exact pattern from `src/services/routing_service.py`:
```python
import os
USE_POSTGIS = os.getenv("USE_SQLITE_TESTS") != "1"
if USE_POSTGIS:
    try:
        from shapely.geometry import Point
        from geoalchemy2.shape import from_shape
    except ImportError:
        USE_POSTGIS = False
```

**2. Fix PostGIS location assignment in submit_report() — Step 3:**
Replace the current location extraction block (lines ~119-131):
```python
# Step 3: Extract location data
location_value = None
address = report.manual_address

if report.location:
    lat = report.location.latitude
    lng = report.location.longitude
    if USE_POSTGIS:
        location_value = from_shape(Point(lng, lat), srid=4326)  # Point(longitude, latitude)
    if not address:
        address = f"{lat}, {lng}"
```

Then in the Ticket constructor (lines ~144-160), replace:
- `latitude=latitude,` and `longitude=longitude,` with `location=location_value,`
- Keep `address=address,`
- Remove any reference to `latitude` or `longitude` as constructor kwargs

The final Ticket constructor should look like:
```python
ticket = Ticket(
    tracking_number=tracking_number,
    category=category,
    description=ticket_description,
    encrypted_description=encrypted_description,
    location=location_value,
    address=address,
    severity=severity,
    status="open",
    language=report.language,
    user_id=current_user.id,
    is_sensitive=(category == "gbv" or report.is_gbv),
    tenant_id=current_user.tenant_id,
    created_by=current_user.id,
    updated_by=current_user.id,
)
```

**3. Fix route ordering — move `/my` before `/{tracking_number}`:**
Move the entire `get_my_reports` function definition (the `@router.get("/my", ...)` block) BEFORE the `get_report_by_tracking` function (`@router.get("/{tracking_number}", ...)`).

This prevents FastAPI from matching "my" as a `{tracking_number}` path parameter.

Also fix the SAPS notification call at Step 6 to use the `address` variable consistently (replace `f"{latitude}, {longitude}"` with `address or "Location not provided"`).
  </action>
  <verify>
Run `python -c "from src.api.v1 import reports; print('import OK')"` to verify clean import.
Run `grep -n "def get_my_reports\|def get_report_by_tracking" src/api/v1/reports.py` to verify `/my` appears before `/{tracking_number}`.
Run `grep -n "location_value\|from_shape\|USE_POSTGIS" src/api/v1/reports.py` to verify PostGIS integration.
Verify NO occurrences of `latitude=latitude` or `longitude=longitude` in the Ticket constructor: `grep "latitude=latitude\|longitude=longitude" src/api/v1/reports.py` should return nothing.
  </verify>
  <done>
reports.py imports compile cleanly. PostGIS location written via from_shape(Point(lng, lat), srid=4326) with USE_POSTGIS guard. Route /my defined before /{tracking_number}. No latitude=/longitude= kwargs in Ticket constructor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test mocks from IntakeFlow to ManagerCrew</name>
  <files>tests/test_reports_api.py</files>
  <action>
Update `tests/test_reports_api.py` to fix stale mocks:

**1. Replace IntakeFlow patches with ManagerCrew patches:**

In `test_submit_report_with_category` (line ~121): Replace `patch('src.api.v1.reports.IntakeFlow')` with `patch('src.api.v1.reports.ManagerCrew')`. Update the assertion from `mock_flow_class.assert_not_called()` to `mock_crew_class.assert_not_called()`. The variable name should change from `mock_flow_class` to `mock_crew_class`.

In `test_submit_report_without_category` (line ~154): Replace `patch('src.api.v1.reports.IntakeFlow')` with `patch('src.api.v1.reports.ManagerCrew')`. Replace the old mock setup:
```python
# OLD:
mock_flow = MagicMock()
mock_flow.state = MagicMock(category="municipal", subcategory="water")
mock_flow.receive_message = MagicMock()
mock_flow.classify_message = MagicMock()
mock_flow_class.return_value = mock_flow
```
With the new ManagerCrew mock pattern:
```python
# NEW:
mock_crew = MagicMock()
mock_crew.kickoff = AsyncMock(return_value={"routing_phase": "municipal"})
mock_crew_class.return_value = mock_crew
```
Update the category assertion: the result category will be `"other"` (from `_PHASE_TO_CATEGORY` mapping where `"municipal"` maps to `"other"`) instead of `"water"`.

**2. Fix Ticket constructor usage in test fixtures:**

In `test_get_report_by_tracking` (line ~317-330) and other tests that create Ticket objects directly: Remove `latitude=-26.2041,` and `longitude=28.0473,` from the Ticket constructor calls. These are read-only properties. If location is needed for tests, set `location=None` (the default). In SQLite test mode, PostGIS fields are None anyway.

Check and fix ALL Ticket() constructor calls in the file — remove any `latitude=` or `longitude=` kwargs. The `address` field can remain.

**3. Fix GBV test (test_submit_report_gbv_encrypted):**

The `notify_saps` patch at line ~260 patches `'src.api.v1.reports.notify_saps'` but the actual import in reports.py is inside a try block: `from src.agents.tools.saps_tool import notify_saps`. The patch should be `'src.agents.tools.saps_tool.notify_saps'` OR since it's imported inside the function, patch it at the source. Check current behavior and keep the test consistent.

**4. Add `accuracy` to location test data:**

In `test_submit_report_with_gps`, add `"accuracy": 10.0` and `"source": "gps"` to the location object in request_data, since `LocationData` now requires `accuracy` (gt=0 validation).
  </action>
  <verify>
Run `USES_SQLITE_TESTS=1 python -m pytest tests/test_reports_api.py -v --tb=short 2>&1 | tail -20` (integration tests will be skipped, but import and structure should validate).
Run `grep -c "IntakeFlow" tests/test_reports_api.py` — should return 0 (no stale references).
Run `grep -c "ManagerCrew" tests/test_reports_api.py` — should return at least 2 (the two patched tests).
  </verify>
  <done>
All IntakeFlow references replaced with ManagerCrew. Ticket constructor calls no longer use latitude=/longitude= kwargs. LocationData test fixtures include accuracy field. Tests collect without import errors.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.api.v1.reports import router; print(f'{len(router.routes)} routes OK')"` — imports cleanly
2. `grep -c "IntakeFlow" src/api/v1/reports.py tests/test_reports_api.py` — 0 in both files
3. `grep -n "location_value" src/api/v1/reports.py` — PostGIS location variable used
4. `grep -n "def get_my_reports" src/api/v1/reports.py` — appears before `def get_report_by_tracking`
5. `USES_SQLITE_TESTS=1 python -m pytest tests/test_reports_api.py --collect-only` — tests collect without errors
</verification>

<success_criteria>
- POST /api/v1/reports/submit correctly writes GPS coordinates as PostGIS location field (not read-only properties)
- GET /reports/my resolves correctly (not intercepted by /{tracking_number})
- GBV encryption flow (encrypted_description + is_sensitive) activates on is_gbv=True
- USE_POSTGIS guard matches routing_service.py pattern (SQLite test compatibility)
- All test mocks reference ManagerCrew, not IntakeFlow
- No regressions in test collection
</success_criteria>

<output>
After completion, create `.planning/phases/08-wire-web-portal-report-submission/08-01-SUMMARY.md`
</output>
