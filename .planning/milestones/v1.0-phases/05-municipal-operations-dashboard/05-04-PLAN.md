---
phase: 05-municipal-operations-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["05-03"]
files_modified:
  - frontend/src/components/dashboard/MetricsCards.tsx
  - frontend/src/components/dashboard/VolumeChart.tsx
  - frontend/src/components/dashboard/SLAComplianceChart.tsx
  - frontend/src/components/dashboard/TeamWorkloadChart.tsx
  - frontend/src/components/dashboard/RealtimeIndicator.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page shows ticket volume, SLA compliance, and team workload charts"
    - "Metrics cards show total open tickets, resolved tickets, SLA compliance %, and breaches"
    - "Dashboard updates in real-time via SSE (no page refresh)"
    - "Ward councillor sees filtered dashboard (only their ward's data)"
    - "App.tsx routes between dashboard page and ticket list page"
  artifacts:
    - path: "frontend/src/pages/DashboardPage.tsx"
      provides: "Main dashboard with metrics and charts"
      contains: "DashboardPage"
    - path: "frontend/src/components/dashboard/MetricsCards.tsx"
      provides: "Summary metric cards"
      contains: "MetricsCards"
    - path: "frontend/src/components/dashboard/VolumeChart.tsx"
      provides: "Ticket volume bar chart"
      contains: "BarChart"
    - path: "frontend/src/components/dashboard/SLAComplianceChart.tsx"
      provides: "SLA compliance gauge"
      contains: "PieChart"
    - path: "frontend/src/components/dashboard/TeamWorkloadChart.tsx"
      provides: "Team workload bar chart"
      contains: "BarChart"
    - path: "frontend/src/App.tsx"
      provides: "Client-side routing for dashboard"
      contains: "DashboardPage"
  key_links:
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/hooks/useSSE.ts"
      via: "Real-time event subscription"
      pattern: "useSSE"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/services/api.ts"
      via: "Metrics data fetching"
      pattern: "fetchDashboardMetrics"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/DashboardPage.tsx"
      via: "Route rendering"
      pattern: "DashboardPage"
---

<objective>
Build the dashboard metrics page with Recharts visualizations, real-time SSE integration, and client-side routing between dashboard and ticket list views.

Purpose: OPS-04 (real-time metrics), OPS-03 (ward councillor view). This completes the dashboard UI with live visualizations.
Output: DashboardPage with MetricsCards, VolumeChart, SLAComplianceChart, TeamWorkloadChart + routing
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-municipal-operations-dashboard/05-RESEARCH.md
@.planning/phases/05-municipal-operations-dashboard/05-03-SUMMARY.md
@frontend/src/types/dashboard.ts
@frontend/src/services/api.ts
@frontend/src/hooks/useSSE.ts
@frontend/src/stores/dashboardStore.ts
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard metric components and charts</name>
  <files>frontend/src/components/dashboard/MetricsCards.tsx, frontend/src/components/dashboard/VolumeChart.tsx, frontend/src/components/dashboard/SLAComplianceChart.tsx, frontend/src/components/dashboard/TeamWorkloadChart.tsx, frontend/src/components/dashboard/RealtimeIndicator.tsx</files>
  <action>
    1. Create `frontend/src/components/dashboard/MetricsCards.tsx`:
       - Props: `metrics: DashboardMetrics | null`, `isLoading: boolean`
       - Renders 4 metric cards in a horizontal row (CSS grid, 4 columns on desktop, 2 on mobile):
         - "Open Tickets" — metrics.total_open (blue accent)
         - "Resolved" — metrics.total_resolved (green accent)
         - "SLA Compliance" — metrics.sla_compliance_percent + "%" (green if >=80, amber if >=60, red if <60)
         - "SLA Breaches" — metrics.sla_breaches (red accent)
       - Each card: title (small text), value (large number), subtle background color
       - Loading state: show skeleton/placeholder values
       - Style with inline CSS or a small `<style>` block in the component using CSS variables

    2. Create `frontend/src/components/dashboard/VolumeChart.tsx`:
       - Props: `data: CategoryVolume[]`, `isLoading: boolean`
       - Uses Recharts: `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend`, `ResponsiveContainer`
       - Displays stacked/grouped bar chart with "open" (amber #f59e0b) and "resolved" (green #10b981) bars per category
       - `ResponsiveContainer width="100%" height={300}`
       - Title: "Ticket Volume by Category"
       - Loading state: show "Loading..." text

    3. Create `frontend/src/components/dashboard/SLAComplianceChart.tsx`:
       - Props: `data: SLACompliance | null`, `isLoading: boolean`
       - Uses Recharts: `PieChart`, `Pie`, `Cell`, `ResponsiveContainer`
       - Displays semi-circle gauge (startAngle=180, endAngle=0) for resolution_compliance_percent
       - Colors: green (#10b981) if >=80%, amber (#f59e0b) if >=60%, red (#ef4444) if <60%
       - Center text shows the percentage value
       - Below gauge: text showing "Response: X% | Resolution: Y%"
       - Title: "SLA Compliance"

    4. Create `frontend/src/components/dashboard/TeamWorkloadChart.tsx`:
       - Props: `data: TeamWorkload[]`, `isLoading: boolean`
       - Uses Recharts: `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `ResponsiveContainer`
       - Horizontal bar chart showing open_count per team
       - XAxis: team_name, YAxis: count
       - Bar color: blue (#3b82f6) for open tickets
       - Title: "Team Workload"

    5. Create `frontend/src/components/dashboard/RealtimeIndicator.tsx`:
       - Props: `isConnected: boolean`, `error: string | null`, `lastUpdated: Date | null`
       - Renders: small indicator dot (green=connected, red=disconnected) + text "Live" or "Reconnecting..."
       - If lastUpdated: show "Updated X seconds ago" (use date-fns `formatDistanceToNow`)
       - Positioned in top-right of dashboard header
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20` shows no new TypeScript errors
    - Files exist: MetricsCards.tsx, VolumeChart.tsx, SLAComplianceChart.tsx, TeamWorkloadChart.tsx, RealtimeIndicator.tsx
  </verify>
  <done>
    - MetricsCards renders 4 key metrics with color coding
    - VolumeChart shows bar chart of tickets per category
    - SLAComplianceChart shows gauge with compliance percentage
    - TeamWorkloadChart shows bar chart of open tickets per team
    - RealtimeIndicator shows SSE connection status
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DashboardPage and wire up App.tsx routing</name>
  <files>frontend/src/pages/DashboardPage.tsx, frontend/src/App.tsx</files>
  <action>
    1. Create `frontend/src/pages/DashboardPage.tsx`:
       - Composes: MetricsCards, VolumeChart, SLAComplianceChart, TeamWorkloadChart, RealtimeIndicator
       - Uses `useSSE` hook for real-time updates
       - Uses `useDashboardStore` for state management
       - Data fetching on mount (useEffect):
         - Call `fetchDashboardMetrics(wardId)` -> store.setMetrics
         - Call `fetchVolumeByCategory(wardId)` -> store.setVolumeData
         - Call `fetchSLACompliance(wardId)` -> store.setSlaData
         - Call `fetchTeamWorkload(wardId)` -> store.setWorkloadData
       - SSE event handling:
         - On "ticket_updated" or "ticket_created": re-fetch all metrics (simple approach; buffer per research recommendation is overkill for v1)
         - On "sla_breach": re-fetch metrics and SLA data
         - Use `useCallback` for SSE handler to prevent re-renders
       - Tab visibility: disable SSE when tab inactive (document.hidden)
       - Layout:
         ```
         <div>
           <header>
             <h1>Municipal Operations Dashboard</h1>
             <RealtimeIndicator />
           </header>
           <MetricsCards />
           <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
             <VolumeChart />
             <SLAComplianceChart />
           </div>
           <TeamWorkloadChart />
           <nav>
             <a href="#tickets">View All Tickets →</a>
           </nav>
         </div>
         ```
       - Accept optional `wardId` prop for ward councillor view
       - Refresh metrics every 60 seconds as backup (in case SSE misses events)

    2. Update `frontend/src/App.tsx`:
       - Implement simple hash-based routing (no react-router dependency needed):
         ```typescript
         import { useState, useEffect } from 'react';
         import { DashboardPage } from './pages/DashboardPage';
         import { TicketListPage } from './pages/TicketListPage';
         import { ReportForm } from './components/ReportForm';

         function App() {
           const [currentPage, setCurrentPage] = useState(window.location.hash || '#dashboard');

           useEffect(() => {
             const handleHashChange = () => setCurrentPage(window.location.hash || '#dashboard');
             window.addEventListener('hashchange', handleHashChange);
             return () => window.removeEventListener('hashchange', handleHashChange);
           }, []);

           return (
             <div className="App">
               <nav style={{ padding: '1rem', borderBottom: '1px solid #e5e7eb', display: 'flex', gap: '1rem' }}>
                 <a href="#dashboard" style={{ fontWeight: currentPage === '#dashboard' ? 'bold' : 'normal' }}>Dashboard</a>
                 <a href="#tickets" style={{ fontWeight: currentPage === '#tickets' ? 'bold' : 'normal' }}>Tickets</a>
                 <a href="#report" style={{ fontWeight: currentPage === '#report' ? 'bold' : 'normal' }}>Report Issue</a>
               </nav>

               {currentPage === '#dashboard' && <DashboardPage />}
               {currentPage === '#tickets' && <TicketListPage />}
               {currentPage === '#report' && <ReportForm />}
               {!['#dashboard', '#tickets', '#report'].includes(currentPage) && <DashboardPage />}
             </div>
           );
         }

         export default App;
         ```
       - Keep existing ReportForm as one of the navigation targets
       - Default to dashboard view
       - Simple nav bar at top for switching views

    Note: This uses hash-based routing to avoid adding react-router as a dependency. The existing `ReportForm` is preserved. The ward councillor view uses the same DashboardPage but with wardId prop (in a future iteration, this would be set from user profile). For now, the dashboard shows all data for the municipality (RBAC filtering happens server-side based on the JWT token's role).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20` shows no new TypeScript errors
    - `cd frontend && npm run build 2>&1 | tail -10` builds successfully
    - Files exist: pages/DashboardPage.tsx, updated App.tsx
  </verify>
  <done>
    - DashboardPage renders metrics cards and charts with real-time SSE updates
    - App.tsx has hash-based routing between Dashboard, Tickets, and Report views
    - SSE disconnects when tab inactive (saves connections)
    - Metrics auto-refresh every 60 seconds as SSE backup
    - Frontend builds and renders without errors
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npm run build` completes successfully
- `cd frontend && npx tsc --noEmit` passes type checking
- App.tsx renders navigation and routes between 3 pages
- DashboardPage renders all 4 chart components
- SSE hook connects and receives events
</verification>

<success_criteria>
- Dashboard shows real-time ticket volumes, SLA compliance metrics, and team workload
- Charts render correctly with Recharts
- Real-time indicator shows SSE connection status
- Navigation works between Dashboard, Tickets, and Report pages
- Ward councillor filtering works via server-side RBAC (ward_id parameter)
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-municipal-operations-dashboard/05-04-SUMMARY.md`
</output>
