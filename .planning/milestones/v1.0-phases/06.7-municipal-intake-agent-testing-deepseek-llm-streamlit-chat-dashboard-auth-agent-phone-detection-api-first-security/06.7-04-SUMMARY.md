---
phase: 06.7-municipal-intake-agent-testing
plan: "04"
subsystem: api
tags: [fastapi, crewai, deepseek, redis, sqlalchemy, phone-detection, auth-agent, intake-flow]

# Dependency graph
requires:
  - phase: 06.7-01
    provides: phone_detection.py, llm.py, auth_tool.py
  - phase: 06.7-02
    provides: AuthCrew with kickoff(context) async interface
  - phase: 06.7-03
    provides: MunicipalCrew, GBVCrew, IntakeFlow wired to DeepSeek LLM

provides:
  - "src/api/v1/crew_server.py — standalone FastAPI crew_app on localhost:8001"
  - "GET /api/v1/health endpoint"
  - "POST /api/v1/chat endpoint with phone detection and agent routing"
  - "POST /api/v1/session/reset endpoint"
  - "X-API-Key security middleware (skip if empty for dev mode)"
  - "session_override test mode (new/expired without DB)"

affects: [06.7-05, 06.7-06, 06.7-07, streamlit-dashboard]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Standalone FastAPI process pattern: crew_app separate from main.py app"
    - "Lazy sync engine creation for cross-process DB access (mirrors ticket_tool.py)"
    - "session_override test mode for API testing without real DB"
    - "GBV debug redaction: only metadata when is_gbv=True (Pitfall 6)"
    - "os.environ.setdefault at module level for CrewAI OPENAI_API_KEY validation (Pitfall 1)"

key-files:
  created:
    - src/api/v1/crew_server.py
  modified: []

key-decisions:
  - "Crew server is a separate FastAPI app (crew_app), NOT a router on main.py — keeps CrewAI lifecycle isolated"
  - "If CREW_SERVER_API_KEY is empty, X-API-Key validation is skipped (easy local dev)"
  - "session_override='new' maps to session_status='none' for test mode"
  - "Database unavailable during phone detection falls open (treat as new user) — correct for dev"
  - "Phone used as both user_id and session_id in crew server Redis keys for simplicity"

patterns-established:
  - "Fail-fast on DeepSeek API errors: return 'DeepSeek API unavailable, please retry' with no retry"
  - "GBV debug redaction: agent_name + turn_count + session_status only — NO conversation content"
  - "Conversation history formatted as 'Role: content' lines injected into crew context"

requirements-completed: []

# Metrics
duration: 20min
completed: 2026-02-17
---

# Phase 06.7 Plan 04: Crew Server Summary

**Standalone FastAPI crew server on localhost:8001 with phone-detection routing to AuthCrew (new/expired) or IntakeFlow (active), X-API-Key security, Redis conversation history, and GBV content redaction in debug output**

## Performance

- **Duration:** 20 min (1217s)
- **Started:** 2026-02-17T08:42:59Z
- **Completed:** 2026-02-17T09:03:16Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments

- Created `src/api/v1/crew_server.py` as a standalone FastAPI app (`crew_app`) — not added to main.py router, runs as its own process on port 8001
- Implemented all three endpoints: GET /api/v1/health, POST /api/v1/chat (phone detection + agent routing), POST /api/v1/session/reset (Redis conversation clear)
- Phone detection routes correctly: `session_status == "active"` to IntakeFlow, `"expired"` or `"none"` to AuthCrew
- X-API-Key header validation with dev-mode bypass (empty key skips validation)
- GBV debug output redacted to metadata-only (agent_name, turn_count, session_status) — never exposes conversation content
- OPENAI_API_KEY dummy set at module level before any CrewAI imports (Pitfall 1 prevention)
- session_override test mode enables testing without real database

## Task Commits

1. **Task 1: Create crew server with /chat, /session/reset, /health endpoints** - `f8ecd68` (feat)

## Files Created/Modified

- `src/api/v1/crew_server.py` — Standalone FastAPI crew server. Pydantic models (ChatRequest, ChatResponse, SessionResetRequest, HealthResponse), phone detection routing, auth/intake agent dispatch, conversation history management via ConversationManager, X-API-Key security, GBV debug redaction, sync engine for DB access.

## Decisions Made

- Crew server is a separate FastAPI app (`crew_app`), NOT a router added to `main.py` — keeps CrewAI lifecycle isolated from production API per locked decision
- `CREW_SERVER_API_KEY` empty = dev mode (skip validation) so local testing requires no setup
- `session_override='new'` maps to `session_status='none'` for test mode clarity
- Phone used as both `user_id` and `session_id` in Redis keys for crew server simplicity (phone is already a unique identifier)
- Database unavailable during phone detection falls open (treats as new user) — appropriate for local dev where DB may not be running
- Fail-fast on DeepSeek API errors: return `"DeepSeek API unavailable, please retry"` immediately — no retry, no fallback (per locked decision)

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None. All verification checks passed on first run:
- `from src.api.v1.crew_server import crew_app` imports without error
- All 3 endpoints registered: GET /api/v1/health, POST /api/v1/chat, POST /api/v1/session/reset
- ChatRequest and ChatResponse models have all required fields
- OPENAI_API_KEY dummy value confirmed set
- Pre-existing test failures (`test_rls_policies.py`, `test_event_broadcaster.py`) confirmed as unrelated to this plan's changes

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness

- Crew server ready for Streamlit dashboard to connect to `http://localhost:8001`
- Start with: `uvicorn src.api.v1.crew_server:crew_app --port 8001` or `python -m src.api.v1.crew_server`
- Test without DB: POST /api/v1/chat with `session_override: "new"` or `"expired"`
- Plan 05 can build the Streamlit chat dashboard on top of these endpoints

## Self-Check: PASSED

- FOUND: `src/api/v1/crew_server.py`
- FOUND: commit `f8ecd68` — feat(06.7-04): create standalone crew server with /chat, /session/reset, /health endpoints

---
*Phase: 06.7-municipal-intake-agent-testing*
*Completed: 2026-02-17*
