# Phase 06.7: Municipal Intake Agent Testing - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

<domain>
## Phase Boundary

Build an end-to-end testable municipal intake agent system powered by DeepSeek V3.2 LLM via CrewAI. Includes: an authentication agent that gates all report access, an automated phone detection system for session management, API-first secure endpoints, and a Streamlit chat dashboard for manual multi-turn testing. All reports require authenticated citizens. GBV-sensitive reports use same auth but different routing at intake level. This phase connects the existing CrewAI agent architecture (Phase 2) to a real LLM and provides a testing interface.

</domain>

<decisions>
## Implementation Decisions

### Auth Agent Conversation Flow
- Dual registration option: auth agent asks "Register with phone or email?" and adapts flow based on user choice
- Phone registration: collect phone -> send OTP -> verify -> collect name + email -> proof of residence upload (OCR) -> municipality assignment
- Email registration: collect email -> send OTP -> verify -> collect name + phone -> proof of residence upload (OCR) -> municipality assignment
- Proof of residence is REQUIRED before municipality assignment (strict verification, not deferred to profile)
- Returning users with expired sessions re-authenticate via OTP only (no password flow)
- GBV reports use same auth as municipal reports — sensitivity is handled at intake agent level, not auth agent level
- Auth agent must create Supabase Auth account and populate user_metadata (role, tenant_id, residence_verified)

### Phone Detection & Session Management
- Detection triggers on session start only — if active session exists, skip detection and go straight to intake agent
- Phone-only lookup for initial detection (email lookup happens inside auth agent if needed)
- Minimal context passed to auth agent: user_exists (bool), session_status (active/expired/none), user_id (if exists)
- Auth agent fetches additional user details from DB if needed (not detection system's job)
- 24hr session expiry via database timestamp: session table with created_at, detection system compares current time vs created_at + 24hr
- Expired sessions get status='expired' and require OTP re-authentication

### Streamlit Chat Dashboard
- WhatsApp-style layout: message bubbles (user on right, agent on left), scrolling conversation, text input at bottom
- Agent labels hidden from main chat view (mimics real WhatsApp experience) — agent identification in separate debug panel/log
- Rich test controls in sidebar: phone number input, Reset conversation button, Language selector (EN/ZU/AF), Municipality picker, Session override (force expired/new), Scenario presets (municipal/GBV), Agent state viewer
- Connects to live Supabase database — test with real data, see results in existing dashboards
- Debug panel shows: current agent, conversation state, session info, last API response

### DeepSeek & CrewAI Configuration
- Model: DeepSeek V3.2 specifically
- API key located in root .env file (DEEPSEEK_API_KEY) — NEVER read or display this file
- OpenAI-compatible endpoint integration: CrewAI LLM config with DeepSeek's base_url + api_key
- Persistent crew server: CrewAI crew runs as long-lived process, Streamlit connects via HTTP
- No fallback model: if DeepSeek API is unavailable, show clear error in Streamlit chat ('DeepSeek API unavailable, please retry')
- No retry logic for API failures — fail fast and clear

### Claude's Discretion
- Exact CrewAI agent/task/tool structure for auth agent and intake agent
- Session table schema design
- Streamlit component layout and styling
- API endpoint URL structure and request/response schemas
- Error message wording and UX copy
- Debug panel implementation details

</decisions>

<specifics>
## Specific Ideas

- Auth flow should feel conversational, not like a form — the agent guides the user through steps naturally
- Phone detection is a code-based system (not an agent) — deterministic lookup, no LLM involved
- The Streamlit dashboard is a TESTING tool for developers, not a production citizen interface
- Crew server should be startable independently of FastAPI (separate process)
- Existing Phase 2 CrewAI agents (manager, municipal intake, GBV specialist) should be adapted/enhanced, not rewritten from scratch
- Security for sensitive reports must be maintained even in the test dashboard (GBV firewall intact)
- All API endpoints must be built BEFORE the Streamlit dashboard — API-first approach

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 06.7-municipal-intake-agent-testing*
*Context gathered: 2026-02-17*
