---
phase: 06.7-municipal-intake-agent-testing
plan: 02
subsystem: auth
tags: [crewai, supabase, pydantic, otp, trilingual, registration, auth-crew]

# Dependency graph
requires:
  - phase: 06.7-01
    provides: auth tools (send_otp_tool, verify_otp_tool, create_supabase_user_tool, lookup_user_tool) and LLM factory (get_deepseek_llm)

provides:
  - AuthCrew class with create_crew() and kickoff() methods
  - Trilingual auth prompts (EN/ZU/AF) for conversational dual-path registration
  - AuthResult Pydantic output model for structured crew output
  - build_auth_task_description() helper for context-aware task templating
  - agents.yaml auth_agent entry
  - tasks.yaml auth_task entry

affects: [06.7-03, 06.7-04, 06.7-05, 06.7-06, 06.7-07, crew-server, streamlit-chat]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "AuthCrew pattern: same create_crew(context)/async kickoff(context) structure as MunicipalCrew/GBVCrew"
    - "memory=False on Crew for PII isolation (same as GBVCrew)"
    - "Lazy LLM resolution: llm=None defaults to get_deepseek_llm() inside create_crew()"
    - "run_in_executor for async wrapping of synchronous CrewAI crew.kickoff()"
    - "build_auth_task_description() fills AUTH_TASK_TEMPLATE with context-specific instruction variant"

key-files:
  created:
    - src/agents/prompts/auth.py
    - src/agents/crews/auth_crew.py
  modified:
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml

key-decisions:
  - "AuthCrew accepts llm=None and resolves get_deepseek_llm() lazily inside create_crew() to prevent circular imports during testing"
  - "memory=False on AuthCrew Crew — auth handles PII (phone, email, OTP codes), same rationale as GBVCrew"
  - "max_iter=15 for AuthCrew (vs 8 for GBVCrew, 10 for MunicipalCrew) — full registration is 6+ steps"
  - "AUTH_PROMPTS backstory language selected per-request (context['language'] overrides self.language)"
  - "build_auth_task_description() generates different instruction text for new vs returning users via _NEW_USER_INSTRUCTION / _RETURNING_USER_INSTRUCTION fragments"

patterns-established:
  - "Crew pattern: __init__(language, llm) + create_crew(context) + async kickoff(context)"
  - "Task template pattern: AUTH_TASK_TEMPLATE with build_*() helper that injects flow-specific instruction variant"
  - "AuthResult Pydantic model as output_pydantic for structured crew output"

requirements-completed: []

# Metrics
duration: 12min
completed: 2026-02-17
---

# Phase 06.7 Plan 02: AuthCrew Summary

**AuthCrew with trilingual conversational prompts — dual-path registration (phone/email), OTP verification, proof of residence gate, and re-authentication flow using memory=False PII isolation**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-17T08:26:09Z
- **Completed:** 2026-02-17T08:38:30Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- AuthCrew class mirrors MunicipalCrew/GBVCrew pattern with full dual-path registration and OTP re-auth support
- Trilingual auth prompts (EN/ZU/AF) guide citizens conversationally through phone-first or email-first registration
- memory=False prevents PII (phone, email, OTP codes) from leaking across crew sessions
- AUTH_TASK_TEMPLATE + build_auth_task_description() generates context-specific task descriptions for new vs returning users
- AuthResult Pydantic model provides structured output (authenticated, user_id, session_status, municipality_id, message, error)
- agents.yaml and tasks.yaml updated with auth_agent and auth_task entries

## Task Commits

Each task was committed atomically:

1. **Task 1: Create trilingual auth prompts** - `ecb24f9` (feat)
2. **Task 2: Create AuthCrew class and update YAML configs** - `ed0c9e4` (feat)

**Plan metadata:** (docs commit below)

## Files Created/Modified

- `src/agents/prompts/auth.py` — AUTH_PROMPTS (EN/ZU/AF), AUTH_TASK_TEMPLATE, build_auth_task_description(), AuthResult Pydantic model
- `src/agents/crews/auth_crew.py` — AuthCrew class with create_crew(context) and async kickoff(context)
- `src/agents/config/agents.yaml` — Added auth_agent entry
- `src/agents/config/tasks.yaml` — Added auth_task entry

## Decisions Made

- **Lazy LLM resolution**: AuthCrew accepts `llm=None` and resolves `get_deepseek_llm()` lazily inside `create_crew()`. This prevents circular imports during testing where fake API keys are used.
- **memory=False**: Auth conversations contain PII (phone, email, OTP codes). Disabling CrewAI memory matches the GBVCrew pattern and prevents cross-session data leakage.
- **max_iter=15**: Full registration is 6+ steps (confirm identity → OTP → collect name → collect secondary contact → proof of residence → municipality assignment). 15 iterations accommodates this plus error recovery turns.
- **Context-aware task instructions**: `build_auth_task_description()` injects different instruction blocks for new users (full registration) vs returning users (OTP-only re-auth) rather than a single generic prompt.
- **Language override per request**: `context['language']` overrides `self.language` inside `create_crew()` to handle cases where WhatsApp session language detection identifies a different language mid-conversation.

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None. Pre-existing test failures in `test_whatsapp_session.py`, `test_event_broadcaster.py`, `test_storage_service.py`, and `test_rls_policies.py` were confirmed to be pre-existing (not caused by this plan's changes). 330 tests pass, 26 fail pre-existing, 111 skipped (PostgreSQL unavailable).

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness

- AuthCrew is ready for integration into the crew server (Plan 03)
- auth_tool.py (Plan 01) + auth_crew.py (Plan 02) provide the complete auth layer
- Streamlit chat dashboard (Plan 04/05) can wire AuthCrew for gated report submission
- All YAML configs updated and importable

---
*Phase: 06.7-municipal-intake-agent-testing*
*Completed: 2026-02-17*

## Self-Check: PASSED

- FOUND: src/agents/prompts/auth.py
- FOUND: src/agents/crews/auth_crew.py
- FOUND: .planning/phases/.../06.7-02-SUMMARY.md
- FOUND commit: ecb24f9 (feat: trilingual auth prompts)
- FOUND commit: ed0c9e4 (feat: AuthCrew + YAML configs)
