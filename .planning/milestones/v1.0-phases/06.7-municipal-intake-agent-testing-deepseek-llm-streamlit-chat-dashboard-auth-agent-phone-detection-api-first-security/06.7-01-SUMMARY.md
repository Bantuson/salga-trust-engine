---
phase: "06.7-municipal-intake-agent-testing"
plan: "01"
subsystem: "agents/foundation"
tags: ["deepseek", "crewai", "auth-tools", "phone-detection", "config"]
dependency_graph:
  requires: []
  provides:
    - "src/core/config.py -> DEEPSEEK_API_KEY, DEEPSEEK_BASE_URL, CREW_SERVER_URL, CREW_SERVER_API_KEY fields"
    - "src/agents/llm.py -> get_deepseek_llm() factory"
    - "src/services/phone_detection.py -> detect_phone_session()"
    - "src/agents/tools/auth_tool.py -> send_otp_tool, verify_otp_tool, create_supabase_user_tool, lookup_user_tool"
  affects:
    - "06.7-02 (auth crew depends on auth tools and LLM factory)"
    - "06.7-03 (crew server depends on LLM factory and crew server config)"
tech_stack:
  added:
    - "crewai.LLM for DeepSeek provider routing via LiteLLM (deepseek/deepseek-chat)"
  patterns:
    - "_impl() + @tool wrapper for synchronous CrewAI tools (existing project pattern)"
    - "Lazy singleton pattern for Supabase admin client access"
    - "E.164 phone normalization with South African 0XX -> +27XX conversion"
key_files:
  created:
    - "src/agents/llm.py"
    - "src/services/phone_detection.py"
    - "src/agents/tools/auth_tool.py"
  modified:
    - "src/core/config.py"
decisions:
  - "LLM factory kept in separate module (llm.py) from config.py to prevent circular imports — config is imported by many modules"
  - "Auth tools return string messages not complex objects — required for LLM consumption in CrewAI agents"
  - "Auth tools are stateless (no class, no instance state) — prevents PII (phone/OTP/email) from persisting between agent calls"
  - "Phone detection is pure code logic (no LLM) — locked decision from research; deterministic results, no hallucination risk"
  - "lookup_user_tool iterates list_users() to find by phone/email — Supabase Admin SDK lacks direct phone/email filter"
metrics:
  duration: "12.9 minutes (776 seconds)"
  completed: "2026-02-17"
  tasks_completed: 2
  files_modified: 4
---

# Phase 06.7 Plan 01: Foundation Layer — DeepSeek Config, Phone Detection, Auth Tools

**One-liner:** DeepSeek V3.2 LLM factory, deterministic WhatsApp phone session detection, and four synchronous Supabase Auth CrewAI tools providing the building blocks for the auth crew.

## What Was Built

### Task 1: DeepSeek Config Fields and LLM Factory (commit: 76b2c81)

Added four new environment variable fields to `src/core/config.py` Settings class:
- `DEEPSEEK_API_KEY` — API key for DeepSeek V3.2
- `DEEPSEEK_BASE_URL` — OpenAI-compatible endpoint (default: `https://api.deepseek.com/v1`)
- `CREW_SERVER_URL` — URL for Streamlit to connect to crew server (default: `http://localhost:8001`)
- `CREW_SERVER_API_KEY` — API key for crew server authentication

Created `src/agents/llm.py` with `get_deepseek_llm()` factory function:
- Uses LiteLLM routing format `deepseek/deepseek-chat` for provider routing
- Returns `crewai.LLM` instance with `temperature=0.7`, `max_tokens=2048`
- Separate module from `config.py` to avoid circular import issues

### Task 2: Phone Detection Service and Auth Tools (commit: 282cd8d)

Created `src/services/phone_detection.py`:
- `detect_phone_session(phone_number, db_session)` — pure code lookup against `WhatsAppSession` table
- `_normalize_phone()` — converts South African `0XX` format to E.164 `+27XX`
- Returns `{user_exists, session_status, user_id}` — minimal context for auth agent routing
- Three possible results: `none` (no session), `active`, or `expired`

Created `src/agents/tools/auth_tool.py` with four synchronous CrewAI tools:
1. `send_otp_tool` — Sends OTP via SMS or email using `supabase.auth.sign_in_with_otp()`
2. `verify_otp_tool` — Verifies 6-digit OTP code using `supabase.auth.verify_otp()`
3. `create_supabase_user_tool` — Creates citizen user with `app_metadata` (role, tenant_id) and `user_metadata` (full_name, residence_verified, preferred_language)
4. `lookup_user_tool` — Looks up existing user by phone or email via `supabase.auth.admin.list_users()`

All tools follow `_impl() + @tool` wrapper pattern from `ticket_tool.py`. Exception handling returns error strings instead of raising — prevents agent crash loops.

## Deviations from Plan

None — plan executed exactly as written.

## Test Results

- Pre-existing test failures confirmed identical before and after changes: `17 failed, 330 passed, 111 skipped, 9 errors`
- Zero regressions introduced by this plan
- Pre-existing failures: `test_event_broadcaster.py` (9 failures), `test_rls_policies.py` (import error for missing `src.core.context`), `test_storage_service.py` and `test_supabase_auth.py` (pre-existing errors)

## Self-Check: PASSED

All created files confirmed present on disk:
- FOUND: src/core/config.py
- FOUND: src/agents/llm.py
- FOUND: src/services/phone_detection.py
- FOUND: src/agents/tools/auth_tool.py

All commits confirmed in git log:
- FOUND: 76b2c81 (Task 1 — DeepSeek config + LLM factory)
- FOUND: 282cd8d (Task 2 — phone detection + auth tools)
