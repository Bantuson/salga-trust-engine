---
phase: 06.1.1-teams-analytics-settings
plan: 04
type: execute
wave: 2
depends_on: ["06.1.1-03"]
files_modified:
  - frontend-dashboard/src/components/teams/QuickInviteForm.tsx
  - frontend-dashboard/src/components/teams/BulkInviteDialog.tsx
  - frontend-dashboard/src/components/teams/RoleAssignPreview.tsx
  - frontend-dashboard/src/components/teams/PermissionMatrix.tsx
  - frontend-dashboard/src/components/teams/TeamDetailModal.tsx
  - frontend-dashboard/src/components/teams/MembersTab.tsx
autonomous: true
requirements:
  - SEC-04

must_haves:
  truths:
    - "Quick invite form sends single invitation with email + role from within the team detail modal"
    - "Bulk invite dialog accepts multiple emails with shared role selection"
    - "Role assignment shows permission summary preview before confirming"
    - "Permission matrix displays visual grid of role x capability checkmarks"
    - "Managers can remove members and deactivate accounts with confirmation"
  artifacts:
    - path: "frontend-dashboard/src/components/teams/QuickInviteForm.tsx"
      provides: "Inline single-invite form"
      contains: "QuickInviteForm"
    - path: "frontend-dashboard/src/components/teams/BulkInviteDialog.tsx"
      provides: "Multi-email bulk invite dialog"
      contains: "BulkInviteDialog"
    - path: "frontend-dashboard/src/components/teams/RoleAssignPreview.tsx"
      provides: "Permission preview before role confirmation"
      contains: "RoleAssignPreview"
    - path: "frontend-dashboard/src/components/teams/PermissionMatrix.tsx"
      provides: "Visual role x capability grid"
      contains: "PermissionMatrix"
  key_links:
    - from: "frontend-dashboard/src/components/teams/QuickInviteForm.tsx"
      to: "frontend-dashboard/src/services/api.ts"
      via: "createInvitation API call"
      pattern: "createInvitation"
    - from: "frontend-dashboard/src/components/teams/BulkInviteDialog.tsx"
      to: "frontend-dashboard/src/services/api.ts"
      via: "createBulkInvitations API call"
      pattern: "createBulkInvitations"
---

<objective>
Build the member management components for the Teams page: invitation forms, role assignment preview, and permission matrix.

Purpose: Complete the Teams page member management flow — the locked decisions specify quick invite, bulk invite, role preview + confirm, and permission matrix. This plan adds those interactive components to the existing Team Detail modal.

Output: 4 new components integrated into the existing TeamDetailModal.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-03-SUMMARY.md
@frontend-dashboard/src/components/teams/TeamDetailModal.tsx
@frontend-dashboard/src/components/teams/MembersTab.tsx
@frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx
@frontend-dashboard/src/constants/permissions.ts
@shared/components/ui/Button.tsx
@shared/components/ui/Input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuickInviteForm + BulkInviteDialog + RoleAssignPreview</name>
  <files>
    frontend-dashboard/src/components/teams/QuickInviteForm.tsx
    frontend-dashboard/src/components/teams/BulkInviteDialog.tsx
    frontend-dashboard/src/components/teams/RoleAssignPreview.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/components/teams/QuickInviteForm.tsx`:
   Per locked decision: "Quick single invite: inline email + role form within the team detail modal"

   Props: teamId: string, onInvited: () => void

   Structure:
   - Compact horizontal form: email Input (placeholder "team.member@municipality.gov.za") + role select dropdown + "Invite" Button
   - Role select shows InvitationRole values: manager, ward_councillor, field_worker (from constants/permissions.ts ROLES, filtered to invitable roles — exclude citizen, admin, saps_liaison)
   - On selecting a role, show RoleAssignPreview component BELOW the form (animated slide-down)
   - Submit button disabled until email is valid and role is selected AND preview is confirmed
   - Per locked decision: "Role assignment includes preview + confirm step"
   - On submit: call createInvitation({ email, role, team_id: teamId }), show success toast (simple green div that auto-fades), call onInvited to refresh list
   - Error handling: show inline error message (red text below form)
   - Use single form state: { email: '', role: '', showPreview: false, confirmed: false }

2. Create `frontend-dashboard/src/components/teams/RoleAssignPreview.tsx`:
   Per locked decision: "after selecting role, show brief permission summary before confirming — prevents accidental over-privilege"

   Props: role: string, onConfirm: () => void, onCancel: () => void

   Structure:
   - GlassCard (variant="default") with slightly elevated styling
   - Header: "Assigning role: {ROLE_LABELS[role]}" with role badge
   - Body: Brief text "This role grants the following permissions:" followed by a bullet list of capabilities from PERMISSION_MATRIX[role], displayed as human-readable labels from CAPABILITIES
   - Footer: "Confirm" Button (variant="secondary") and "Change" link/button
   - Visual: light amber background hint (rgba(255, 213, 79, 0.1)) to draw attention to the preview

3. Create `frontend-dashboard/src/components/teams/BulkInviteDialog.tsx`:
   Per locked decision: "Bulk invite: separate 'Bulk Invite' button opens a batch dialog (multi-line email input + role selector)"

   Props: teamId: string, isOpen: boolean, onClose: () => void, onInvited: () => void

   Structure:
   - Modal overlay (same glassmorphic pattern as TeamDetailModal but smaller: maxWidth 520px)
   - Header: "Bulk Invite Team Members" + close X button
   - Body:
     - Textarea (styled with design tokens) for multi-line email input. Placeholder: "Enter email addresses, one per line"
     - Role selector dropdown (same options as QuickInviteForm)
     - Helper text: "All invitees will receive the same role. You can change individual roles later."
   - When role is selected, show RoleAssignPreview
   - Footer: "Send {N} Invitations" Button (shows count of valid emails parsed) + Cancel
   - Email parsing: split textarea by newline, trim, filter valid email patterns
   - On submit: call createBulkInvitations with parsed emails + role + team_id
   - Show progress during submission (loading state on button)
   - Success: close dialog, call onInvited
   - Error: show error message inline
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/components/teams/QuickInviteForm.tsx src/components/teams/BulkInviteDialog.tsx src/components/teams/RoleAssignPreview.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>Quick invite form handles single invites with role preview. Bulk invite dialog handles batch email input. Both show permission preview before confirming role assignment.</done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionMatrix + integrate invite components into modal</name>
  <files>
    frontend-dashboard/src/components/teams/PermissionMatrix.tsx
    frontend-dashboard/src/components/teams/TeamDetailModal.tsx
    frontend-dashboard/src/components/teams/MembersTab.tsx
  </files>
  <action>
1. Create `frontend-dashboard/src/components/teams/PermissionMatrix.tsx`:
   Per locked decision: "Permission matrix: visual grid showing role x capability with checkmarks"
   Per context: "Permission matrix should be read-only for managers, editable display labels for admins only"

   Props: editableLabels?: boolean (default false), onLabelChange?: (role: string, label: string) => void

   Structure:
   - Table-like grid using CSS grid (not HTML table for styling control)
   - Header row: blank corner cell + one column per ROLE (6 columns)
   - Each capability row: capability label (left) + checkmark or empty for each role
   - Checkmarks: use teal checkmark character or SVG icon (var(--color-teal))
   - Empty cells: subtle dash or empty
   - Role column headers: show ROLE_LABELS[role] text
   - If editableLabels: role headers are editable inputs (admin can rename "Manager" to "Department Head")
   - Styling: glassmorphic background, alternating row hint (subtle rgba stripes), text aligned center for checkmarks
   - Responsive: on small screens, horizontally scroll the matrix

   Per locked decision: "Municipalities can set display labels for roles"

2. Update `frontend-dashboard/src/components/teams/MembersTab.tsx`:
   - Add QuickInviteForm at the TOP of the members tab (always visible)
   - Add "Bulk Invite" button next to the invite form (opens BulkInviteDialog)
   - Add "View Permissions" toggle button that shows/hides PermissionMatrix below the members list
   - When member is removed, add confirmation dialog: "Remove {name} from this team? They will lose access to team tickets."
   - Add "Deactivate Account" option in member row dropdown (only visible to admin role users) per locked decision: "Managers can remove members from team AND have option to deactivate user accounts (admin-level action with confirmation)"
   - Deactivate confirmation dialog: "This will deactivate {name}'s account across the entire municipality. They will no longer be able to log in. This action can be reversed by an admin." with red "Deactivate" button

3. Update `frontend-dashboard/src/components/teams/TeamDetailModal.tsx`:
   - Import and render BulkInviteDialog (managed by isBulkDialogOpen state)
   - Pass onInvited callback that refreshes the active tab data
   - Ensure the modal's scroll lock doesn't conflict with BulkInviteDialog's own overlay (use z-index layering: modal at 1000, bulk dialog at 1100)
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/components/teams/PermissionMatrix.tsx 2>&1 | head -10` — should compile.
    Run `cd frontend-dashboard && npx tsc --noEmit src/components/teams/TeamDetailModal.tsx 2>&1 | head -10` — should compile.
  </verify>
  <done>PermissionMatrix renders role x capability grid with optional editable labels. QuickInviteForm and BulkInviteDialog are integrated into MembersTab. Confirmation dialogs protect destructive actions.</done>
</task>

</tasks>

<verification>
1. QuickInviteForm sends invitation with role preview confirmation step
2. BulkInviteDialog parses multi-line emails and sends batch
3. RoleAssignPreview shows capability list for selected role
4. PermissionMatrix renders 6 roles x 8 capabilities grid
5. Remove member has confirmation dialog
6. Deactivate account option visible only to admin users
7. All components use inline styles + design tokens
</verification>

<success_criteria>
- Quick invite: email + role + preview + confirm + send works end to end
- Bulk invite: paste emails + select role + preview + send N invitations
- Permission matrix: visual grid with checkmarks, read-only for managers
- Destructive actions guarded by confirmation dialogs
- All invite actions refresh the member/invitation lists
</success_criteria>

<output>
After completion, create `.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-04-SUMMARY.md`
</output>
