---
phase: 06.1.1-teams-analytics-settings
plan: 01
subsystem: backend-api
tags: [teams, settings, audit-logs, dashboard, rbac, sla, tenant-isolation]
dependency_graph:
  requires:
    - src/models/team.py
    - src/models/team_invitation.py
    - src/models/sla_config.py
    - src/models/audit_log.py
    - src/models/municipality.py
    - src/api/deps.py
    - src/services/dashboard_service.py
  provides:
    - GET/POST/PATCH /api/v1/teams/*
    - GET/PUT /api/v1/settings/sla/*
    - GET/PUT /api/v1/settings/municipality
    - GET /api/v1/audit-logs/
    - Dashboard date range filtering
  affects:
    - src/main.py (3 new routers registered)
    - src/schemas/team.py (TeamUpdate, TeamMemberResponse added)
    - src/schemas/invitation.py (team_id field added)
    - src/models/team_invitation.py (team_id FK column added)
    - src/services/dashboard_service.py (date range params added to all 4 methods)
tech_stack:
  added: []
  patterns:
    - FastAPI APIRouter with RBAC via require_role dependency
    - Tenant isolation via current_user.tenant_id scoping
    - Partial PATCH via model_dump(exclude_unset=True)
    - Pydantic inline schemas for endpoint-local types (AuditLogEntry, SLAConfigResponse)
    - Upsert pattern via check-then-update (settings SLA)
    - Computed fields pattern for TeamResponse (member_count, manager_name, active_ticket_count)
key_files:
  created:
    - src/api/v1/teams.py
    - src/api/v1/settings.py
    - src/api/v1/audit_logs.py
  modified:
    - src/models/team_invitation.py (team_id FK column)
    - src/schemas/team.py (TeamUpdate, TeamMemberResponse, computed fields on TeamResponse)
    - src/schemas/invitation.py (team_id in Create and Response)
    - src/api/v1/invitations.py (store team_id in POST / and POST /bulk)
    - src/api/v1/dashboard.py (start_date/end_date params on all 4 endpoints)
    - src/services/dashboard_service.py (start_date/end_date on all 4 methods)
    - src/main.py (teams, settings_api, audit_logs routers registered)
decisions:
  - settings as settings_api alias in main.py to avoid conflict with src.core.config.settings
  - TeamInvitation.team_id nullable=True for backward compatibility with existing municipality-level invitations
  - SAPS teams excluded from GET /teams list endpoint (SEC-05 boundary enforcement)
  - DashboardService date range params use created_at filtering (ticket creation time)
  - Municipality.contact_phone and logo_url silently skipped in settings PUT (fields not yet in model — forward compatible)
  - Audit log endpoint uses AuditLogEntry inline schema (avoids exposing ORM enum directly)
  - SLA 'default' category URL parameter maps to NULL in database (normalization at API layer)
metrics:
  duration: 8.9m (538s)
  completed: 2026-02-19
  tasks_completed: 2
  files_modified: 10
---

# Phase 06.1.1 Plan 01: Backend API — Teams, Settings, Audit Logs, Dashboard Date Range

**One-liner:** Three new API routers (7 teams endpoints, 4 settings endpoints, 1 audit-log endpoint) with RBAC and tenant isolation, plus date range filtering on all 4 dashboard endpoints.

## What Was Built

### Task 1: Teams CRUD API + Team-Scoped Invitations

**Commit:** `02b5d87`

Created `src/api/v1/teams.py` with 7 endpoints:

| Endpoint | Method | RBAC | Purpose |
|----------|--------|------|---------|
| `/api/v1/teams/` | GET | MANAGER, ADMIN, WARD_COUNCILLOR | List active non-SAPS teams for municipality |
| `/api/v1/teams/` | POST | ADMIN, MANAGER | Create new team |
| `/api/v1/teams/{id}` | GET | MANAGER, ADMIN | Get single team with computed fields |
| `/api/v1/teams/{id}` | PATCH | ADMIN, MANAGER | Partial update (name, category, manager_id, is_active) |
| `/api/v1/teams/{id}/members` | GET | MANAGER, ADMIN | List accepted members with user details |
| `/api/v1/teams/{id}/members/{inv_id}` | DELETE | ADMIN, MANAGER | Remove member (sets status='removed') |
| `/api/v1/teams/{id}/invitations` | GET | MANAGER, ADMIN | List all invitations for team |

All endpoints verify `team.tenant_id == current_user.tenant_id` for tenant isolation.

TeamResponse includes computed fields: `member_count`, `manager_name`, `active_ticket_count` (all computed per-request via additional queries).

**Model changes:**
- `TeamInvitation.team_id` — nullable FK to `teams.id`, backward compatible
- `TeamInvitationCreate.team_id` — optional UUID field
- `TeamResponse` — added `member_count: int = 0`, `manager_name: str | None`, `active_ticket_count: int = 0`
- New `TeamUpdate` schema for PATCH (all fields optional)
- New `TeamMemberResponse` schema for GET members endpoint

Updated `invitations.py` POST `/` and POST `/bulk` to store optional `team_id`.

### Task 2: Settings API + Audit Logs + Dashboard Date Range

**Commit:** `974dcc7`

**Settings API** (`src/api/v1/settings.py`, 4 endpoints):
- `GET /api/v1/settings/sla` — list SLA configs (MANAGER+ADMIN)
- `PUT /api/v1/settings/sla/{category}` — upsert SLA config (ADMIN only), special `default` category maps to NULL
- `GET /api/v1/settings/municipality` — get municipality profile
- `PUT /api/v1/settings/municipality` — update profile (ADMIN only)

**Audit Logs API** (`src/api/v1/audit_logs.py`, 1 endpoint):
- `GET /api/v1/audit-logs/` — paginated audit log listing (ADMIN only)
- Supports `page`, `page_size` (max 100), `table_name`, `operation` filters
- Returns `{logs: [...], total: int, page: int, page_size: int}`

**Dashboard date range** — Added `start_date` and `end_date` optional query params (YYYY-MM-DD format) to all 4 dashboard endpoints. DashboardService updated to accept and apply `created_at` range filters.

**main.py registration:**
```python
app.include_router(teams.router, prefix="/api/v1")
app.include_router(settings_api.router, prefix="/api/v1")
app.include_router(audit_logs.router, prefix="/api/v1")
```

## Verification Results

All 7 plan success criteria verified:

1. All new API files import without errors
2. main.py includes all 3 new routers (total routes: 73)
3. Teams endpoints enforce RBAC (MANAGER/ADMIN via require_role)
4. Settings SLA update is ADMIN-only
5. Audit logs listing is ADMIN-only
6. Dashboard endpoints accept start_date/end_date params
7. TeamInvitation model has team_id FK column

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added DashboardService date params**
- **Found during:** Task 2
- **Issue:** Plan specified adding date range params to dashboard endpoints but DashboardService methods didn't accept them — calling the service without updating it would silently ignore the date range
- **Fix:** Updated all 4 DashboardService methods to accept `start_date: datetime | None` and `end_date: datetime | None` and apply `Ticket.created_at` range filters
- **Files modified:** `src/services/dashboard_service.py`
- **Commit:** 974dcc7

**2. [Rule 2 - Missing Critical] Added TeamInvitationResponse.team_id and TeamInvitation status 'removed'**
- **Found during:** Task 1
- **Issue:** The TeamInvitationResponse schema didn't expose team_id, making it invisible to API consumers. Also, the 'removed' status lifecycle state was not documented in the model docstring.
- **Fix:** Added `team_id: UUID | None = None` to TeamInvitationResponse schema; added 'removed' to TeamInvitation docstring status lifecycle
- **Files modified:** `src/schemas/invitation.py`, `src/models/team_invitation.py`
- **Commit:** 02b5d87

## Self-Check: PASSED

| Item | Status |
|------|--------|
| src/api/v1/teams.py | FOUND |
| src/api/v1/settings.py | FOUND |
| src/api/v1/audit_logs.py | FOUND |
| Commit 02b5d87 (Task 1) | FOUND |
| Commit 974dcc7 (Task 2) | FOUND |
