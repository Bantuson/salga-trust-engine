# Phase 06.1.1: Teams, Analytics & Settings Pages UI — Research

**Researched:** 2026-02-19
**Domain:** React/TypeScript frontend UI — glassmorphic dashboard pages, RBAC, modal patterns, data visualization
**Confidence:** HIGH (codebase verified directly)

---

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

**Teams Page — Layout & Display**
- Card grid layout — each team rendered as a GlassCard
- Card shows: team name, category badge (icon + colored pill), member count, manager name, active ticket count
- Category icons per service type (water, electricity, roads, waste, sanitation, GBV, other) with unique accent colors
- Both icon AND colored badge together for strong visual category distinction
- Create team via inline "+" card in the grid — expands into a creation form (name, category dropdown, service area, assign manager)

**Teams Page — Team Detail**
- Clicking a team card opens a full detail MODAL (not page navigation, not inline expand)
- Modal has tabbed layout: Members | Pending Invitations | Activity
- Members tab shows active team members with role badges
- Pending Invitations tab shows sent invitations with status and resend/cancel actions

**Teams Page — Member Management**
- Quick single invite: inline email + role form within the team detail modal
- Bulk invite: separate "Bulk Invite" button opens a batch dialog (multi-line email input + role selector)
- Both invitation paths available — quick for one-off, bulk for onboarding
- Managers can remove members from team AND have option to deactivate user accounts (admin-level action with confirmation)
- Role assignment happens contextually when inviting or editing members on the Teams page

**Analytics Page — Scope & Data**
- Full analytics suite: time-series trends AND cross-dimensional comparisons
- Trends: ticket volume, SLA compliance, resolution rates over configurable time periods
- Comparisons: performance across teams, categories, wards — identify bottlenecks and top performers
- Time range controls: preset buttons (7d, 30d, 90d, 6mo, 1yr) PLUS custom date range picker

**Analytics Page — Visualization Approach**
- Mixed approach prioritizing clarity over chart complexity:
  - Top-level KPIs as large stat cards with inline sparklines (Stripe/Linear dashboard style)
  - Team/category comparisons as horizontal bar rankings with progress bars and trend arrows (leaderboard style)
  - Minimal traditional charts — only where sparklines and bars are insufficient
- IMPORTANT: Claude historically struggles with chart/pie implementations — be careful and thoughtful with any Recharts usage, keep visualizations simple and data-dense rather than visually complex
- Ward councillor analytics view filtered to their ward (existing backend support via ward_id param)

**Settings Page — Structure & Organization**
- Single scrollable page with clearly separated sections + anchor navigation at top
- Full settings suite exposed:
  - Municipality profile (name, logo, contact info)
  - SLA targets (response/resolution hours per category)
  - Notification preferences
  - Team defaults
  - Ward boundaries
  - Branding/logo
  - Data export
  - Audit log viewer
- Each section has explicit Save button — changes don't auto-save
- Role-based visibility: some sections admin-only, some manager-accessible

**Role Management — Approach**
- Fixed 6 system roles (citizen, field_worker, manager, ward_councillor, admin, saps_liaison) — no custom role creation
- Municipalities can set display labels for roles (e.g., "Manager" -> "Department Head") for local context
- Role management lives on the Teams page, integrated contextually when managing members
- Permission matrix: visual grid showing role x capability with checkmarks (view tickets, assign, export, manage teams, etc.)
- Role assignment includes preview + confirm step: after selecting role, show brief permission summary before confirming — prevents accidental over-privilege

### Claude's Discretion
- Audit log placement: inline preview on Settings page vs separate /audit route — decide based on page complexity
- Exact sparkline library choice (lightweight options preferred)
- Analytics page section ordering and grouping
- Team detail modal sizing and responsive behavior
- Empty states for each page (no teams yet, no analytics data yet, etc.)
- Loading skeleton patterns per page
- Export functionality on Analytics page (PDF/CSV of analytics data)
- Mobile responsive adaptations for all three pages

### Deferred Ideas (OUT OF SCOPE)
- Municipalities page (/municipalities) — platform_admin management of municipalities (separate phase)
- System page (/system) — system-wide administration for platform_admin (separate phase)
- Reports page (/reports) — SAPS liaison reports dashboard (separate phase)
- Custom role creation with granular permissions — noted for future if municipalities need beyond 6 roles
- Real-time analytics updates via Supabase Realtime (current phase uses fetch-on-load + manual refresh)
</user_constraints>

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| OPS-01 | Municipal manager can view, filter, search, and assign tickets via web dashboard | Analytics page time-range filtering + teams leaderboard enables manager oversight; existing `/api/v1/tickets` with filters already wired |
| OPS-02 | Municipal manager can export issue data to Excel/CSV | Backend `/api/v1/export/tickets/csv` and `/api/v1/export/tickets/excel` already implemented; Settings page Data Export section will surface this |
| OPS-03 | Ward councillor can view dashboard filtered to issues in their ward | Analytics page inherits `ward_id` param support from existing `/api/v1/dashboard/*` endpoints; ward councillor role only sees ward-scoped nav |
| OPS-04 | Dashboard shows real-time ticket volumes, SLA compliance, and team workload | Analytics page upgrades the static "Coming Soon" with KPI cards + sparklines + team leaderboard using existing dashboard endpoints |
| SEC-04 | Role-based access control (citizen, field_worker, manager, admin, SAPS liaison) | Teams page role management, permission matrix, and invite confirm-preview step enforce RBAC; Settings sections gated by admin vs manager role |
</phase_requirements>

---

## Summary

Phase 06.1.1 is a **frontend-only UI build**. All three target pages (/teams, /analytics, /settings) currently render "Coming Soon" placeholder divs in `App.tsx`. Backend APIs for teams (invitations), dashboard metrics, SLA config, and audit logs are **already implemented and registered** in FastAPI. The task is to create the page components, wire them to existing APIs, and match the established design system exactly.

The codebase has a mature design foundation: `GlassCard`, `AnimatedCard`, `Badge`, `Button`, `Input`, `Skeleton` from `@shared/components/ui/*`, design tokens in `shared/design-tokens.css`, GSAP for entrance animations, and anime.js for counter animations. The existing `DashboardPage`, `TicketListPage`, and `OnboardingWizardPage` set clear precedents for layout, data fetching, and component composition.

The most technically complex area is the **Teams page modal**: a tabbed detail modal with member management, invitation handling (single and bulk), and role-assign preview. The Analytics page requires careful Recharts usage — the user explicitly flagged that Claude historically struggles with charts; the plan must favour CSS progress bars, inline sparklines, and horizontal bar rankings over complex chart configurations. The Settings page is wide in scope but shallow in complexity — it is essentially a form collection with section-based layout.

**Primary recommendation:** Build pages in order — Teams (most complex, modal + invite flows) → Analytics (KPI layout + sparklines) → Settings (long form with section nav). All three share the same API layer pattern already established in `services/api.ts`.

---

## Standard Stack

### Core (already in package.json — no new installs needed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| React | 19.2.0 | UI framework | Project baseline |
| TypeScript | 5.9.3 | Type safety | Project baseline |
| React Router DOM | 7.13.0 | Routing (already wired) | Project baseline |
| Recharts | 2.15.4 | Charts (already installed) | Used in SLAComplianceChart, VolumeChart, TeamWorkloadChart |
| GSAP + @gsap/react | 3.14.2 / 2.1.2 | Entrance animations | Used in AnimatedCard |
| anime.js | 4.3.5 | Counter animations | Used in MetricsCards |
| Zustand | 5.0.11 | State store | Used in dashboardStore |
| Axios | 1.6 | API calls | Used in services/api.ts |
| date-fns | 4.1.0 | Date formatting | Already installed |
| react-loading-skeleton | 3.5.0 | Loading states | Used in MetricsCards |
| @supabase/supabase-js | 2.39.3 | Auth + realtime | Project baseline |

### What Claude's Discretion Should Decide: Sparklines

The decision is between:

1. **Pure CSS sparklines** — draw trend lines with SVG path elements inline in the KPI card. Zero dependency, full control over styling, renders on all browsers. Recommended for this project since the data is simple (7-30 data points per trend line).
2. **recharts `LineChart` with width/height constrained** — already installed, but small inline uses risk the Recharts layout complexity the user warned about.
3. **react-sparklines** — lightweight dedicated library (~3KB). Would need installing.

**Recommendation: Pure SVG sparklines** drawn inline. Given Recharts struggles historically, and sparklines are simple polylines, a hand-rolled `<SparkLine data={numbers[]} width={80} height={32} />` component using an SVG `<polyline>` is 20 lines of code, zero dependencies, and perfectly styled with design tokens.

### What Claude's Discretion Should Decide: Analytics Export

The existing `exportTicketsCSV` and `exportTicketsExcel` functions in `services/api.ts` already download blobs. Use the same pattern for the Analytics export button on the Settings page — no new library needed.

### What Claude's Discretion Should Decide: Audit Log Placement

**Recommendation: Inline preview on Settings page** — a scrollable table of the last 50 audit events, with a "Load more" button. Given that /audit as a separate route would need nav item additions and additional routing complexity, an inline preview fits the "single scrollable settings page" decision cleanly. Admins-only section.

### What Claude's Discretion Should Decide: Date Range Picker

`date-fns` is already installed. For the custom date range picker on Analytics, use two `<input type="date">` elements styled with design tokens rather than adding a new date picker library. Simple, accessible, zero new dependencies.

### Installation

```bash
# No new npm packages required — all dependencies already installed
```

---

## Architecture Patterns

### Recommended File Structure

```
frontend-dashboard/src/
├── pages/
│   ├── TeamsPage.tsx            # New — Teams grid + create inline card
│   ├── AnalyticsPage.tsx        # New — KPI cards + leaderboards + time range
│   └── SettingsPage.tsx         # New — scrollable sections + anchor nav
├── components/
│   ├── teams/
│   │   ├── TeamCard.tsx         # GlassCard with category badge + stats
│   │   ├── TeamCreateCard.tsx   # Inline "+" card that expands to form
│   │   ├── TeamDetailModal.tsx  # Full modal with tabs
│   │   ├── MembersTab.tsx       # Members list with role badges
│   │   ├── InvitationsTab.tsx   # Pending invitations list
│   │   ├── ActivityTab.tsx      # Team activity log
│   │   ├── QuickInviteForm.tsx  # Single email+role inline form
│   │   ├── BulkInviteDialog.tsx # Batch dialog (multi-line email)
│   │   ├── RoleAssignPreview.tsx# Permission summary before confirm
│   │   └── PermissionMatrix.tsx # Role x capability grid
│   ├── analytics/
│   │   ├── KPICard.tsx          # Stat card with inline SVG sparkline
│   │   ├── SparkLine.tsx        # Pure SVG sparkline component
│   │   ├── TeamLeaderboard.tsx  # Horizontal bar rankings
│   │   ├── CategoryComparison.tsx # Category performance bars
│   │   └── TimeRangeControls.tsx  # Preset buttons + date inputs
│   └── settings/
│       ├── SettingsSection.tsx  # Reusable section wrapper with Save btn
│       ├── MunicipalityProfile.tsx
│       ├── SLATargetsSection.tsx
│       ├── NotificationsSection.tsx
│       ├── TeamDefaultsSection.tsx
│       ├── BrandingSection.tsx
│       ├── DataExportSection.tsx
│       └── AuditLogSection.tsx  # Admin-only inline viewer
├── hooks/
│   ├── useTeams.ts             # Fetch + manage teams state
│   ├── useAnalytics.ts         # Fetch analytics data with time range
│   └── useSettings.ts          # Fetch + save municipality settings
└── types/
    ├── teams.ts                # Team, TeamMember, Invitation types
    ├── analytics.ts            # AnalyticsMetrics, TimeRange types
    └── settings.ts             # MunicipalitySettings, SLAConfig types
```

### Pattern 1: Page Registration in App.tsx

The three new pages must replace the placeholder divs in `App.tsx`:

```typescript
// Before (lines 75-77 in App.tsx):
<Route path="/teams" element={<DashboardLayout><div style={styles.placeholder}>Teams (Coming Soon)</div></DashboardLayout>} />
<Route path="/analytics" element={<DashboardLayout><div style={styles.placeholder}>Analytics (Coming Soon)</div></DashboardLayout>} />
<Route path="/settings" element={<DashboardLayout><div style={styles.placeholder}>Settings (Coming Soon)</div></DashboardLayout>} />

// After:
<Route path="/teams" element={<DashboardLayout><TeamsPage /></DashboardLayout>} />
<Route path="/analytics" element={<DashboardLayout><AnalyticsPage /></DashboardLayout>} />
<Route path="/settings" element={<DashboardLayout><SettingsPage /></DashboardLayout>} />
```

### Pattern 2: Page Layout (match DashboardPage)

All three new pages must follow the same layout as `DashboardPage`:

```typescript
export function TeamsPage() {
  return (
    <div style={styles.container}>  {/* maxWidth: 1400px, margin: 0 auto, padding: 2rem */}
      <header style={styles.header}>
        <h1 style={styles.title}>Teams</h1>
        {/* action buttons */}
      </header>
      {/* page content */}
    </div>
  );
}

const styles = {
  container: {
    maxWidth: '1400px',
    margin: '0 auto',
    padding: '2rem',
  } as React.CSSProperties,
  header: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: '2rem',
  } as React.CSSProperties,
  title: {
    fontSize: '1.875rem',
    fontWeight: '700',
    color: 'var(--text-primary)',
    textShadow: '0 1px 3px rgba(0, 0, 0, 0.2)',
  } as React.CSSProperties,
};
```

### Pattern 3: Card Grid (match MetricsCards layout)

Team cards must use the same grid pattern as `MetricsCards`:

```typescript
// Team grid — same grid-template-columns pattern as MetricsCards
const styles = {
  grid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
    gap: 'var(--space-lg)',
  } as React.CSSProperties,
};
```

### Pattern 4: GlassCard with AnimatedCard (established MetricsCards pattern)

```typescript
// Per CONTEXT.md: "Team cards should match the existing MetricsCards pattern (AnimatedCard wrapper + GlassCard)"
<AnimatedCard glowColor="coral" delay={index * 0.05}>
  <GlassCard variant="interactive" onClick={() => openTeamModal(team)}>
    {/* team content */}
  </GlassCard>
</AnimatedCard>
```

### Pattern 5: Modal Pattern (match OnboardingWizardPage approach)

The team detail modal uses glassmorphic styling consistent with existing onboarding wizard dialogs. The wizard uses full-screen overlay + centered glass container. The team modal should be similar but smaller (not full-screen):

```typescript
// Modal overlay + centered glass container
<div style={styles.overlay} onClick={onClose}>
  <div style={styles.modal} onClick={e => e.stopPropagation()}>
    {/* Tabbed content */}
  </div>
</div>

const styles = {
  overlay: {
    position: 'fixed' as const,
    inset: 0,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    backdropFilter: 'blur(4px)',
    zIndex: 1000,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 'var(--space-lg)',
  } as React.CSSProperties,
  modal: {
    background: 'var(--glass-pink-frost)',
    backdropFilter: 'blur(var(--glass-blur-medium))',
    WebkitBackdropFilter: 'blur(var(--glass-blur-medium))',
    border: '1px solid var(--glass-border)',
    borderRadius: 'var(--radius-xl)',
    width: '100%',
    maxWidth: '720px',
    maxHeight: '85vh',
    overflowY: 'auto' as const,
    padding: 'var(--space-xl)',
  } as React.CSSProperties,
};
```

### Pattern 6: Role-Gated Sections

The `useAuth` hook exposes `getUserRole()` which reads from Supabase `app_metadata.role`. Use this to conditionally render admin-only Settings sections:

```typescript
const { getUserRole } = useAuth();
const role = getUserRole();
const isAdmin = role === 'admin';
const isManager = role === 'manager' || role === 'admin';

// In Settings page:
{isAdmin && <AuditLogSection />}
{isAdmin && <BrandingSection />}
{isManager && <SLATargetsSection />}
```

### Pattern 7: API Service Extension

New API functions follow the exact pattern established in `services/api.ts`:

```typescript
// Example: Fetch teams
export async function fetchTeams(): Promise<Team[]> {
  const response = await api.get('/teams');
  return response.data;
}

// Example: Create team
export async function createTeam(data: TeamCreate): Promise<Team> {
  const response = await api.post('/teams', data);
  return response.data;
}
```

Note: The `/teams` CRUD endpoints do NOT currently exist in the backend (only invitations, not teams). The backend has the `Team` model and `TeamCreate`/`TeamResponse` schemas but no registered API router for teams. This phase requires creating backend team CRUD endpoints.

### Pattern 8: Pure SVG Sparkline Component

For Analytics KPI cards (Stripe-style):

```typescript
interface SparkLineProps {
  data: number[];
  width?: number;
  height?: number;
  color?: string;
}

export function SparkLine({ data, width = 80, height = 32, color = 'var(--color-teal)' }: SparkLineProps) {
  if (!data || data.length < 2) return null;

  const max = Math.max(...data);
  const min = Math.min(...data);
  const range = max - min || 1;

  const points = data.map((val, i) => {
    const x = (i / (data.length - 1)) * width;
    const y = height - ((val - min) / range) * height;
    return `${x},${y}`;
  }).join(' ');

  return (
    <svg width={width} height={height} style={{ overflow: 'visible' }}>
      <polyline
        points={points}
        fill="none"
        stroke={color}
        strokeWidth="1.5"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}
```

### Pattern 9: Leaderboard Row (Analytics teams ranking)

Horizontal bar progress pattern — no Recharts needed:

```typescript
function LeaderboardRow({ name, value, max, rank, trend }: LeaderboardRowProps) {
  const pct = (value / max) * 100;
  return (
    <div style={styles.row}>
      <span style={styles.rank}>#{rank}</span>
      <span style={styles.name}>{name}</span>
      <div style={styles.barTrack}>
        <div style={{ ...styles.barFill, width: `${pct}%` }} />
      </div>
      <span style={styles.value}>{value}</span>
      <span style={{ color: trend > 0 ? 'var(--color-teal)' : 'var(--color-coral)' }}>
        {trend > 0 ? '↑' : '↓'}
      </span>
    </div>
  );
}
```

### Anti-Patterns to Avoid

- **Using Recharts PieChart for analytics KPIs** — the SLAComplianceChart already uses a PieChart gauge and it's complex to style. Use CSS progress bars or percentage text instead.
- **Multiple useState for form fields** — use a single form object state: `const [form, setForm] = useState({ name: '', category: '', ... })`.
- **Unguarded admin actions** — always confirm destructive actions (remove member, deactivate account) with a confirmation step before calling the API.
- **Auto-save on settings** — explicitly locked by user decision. Every section must have its own "Save" button with loading state.
- **Global Zustand store for all three pages** — the existing `dashboardStore.ts` pattern is fine for the shared overview dashboard, but Teams, Analytics, and Settings each manage their own local state or a dedicated hook. Don't pollute the existing dashboard store.
- **Direct DOM manipulation for modals** — use React state (`isModalOpen`, `selectedTeam`) to control modal visibility. Don't use `document.querySelector`.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Loading skeleton | Custom loading placeholder | `Skeleton` + `SkeletonTheme` from `@shared/components/ui/Skeleton` | Already used in MetricsCards |
| GlassCard | Custom glassmorphic div | `GlassCard` from `@shared/components/ui/GlassCard` | Already handles blur, border, variants |
| Animated entrance | CSS animation | `AnimatedCard` from `components/AnimatedCard.tsx` | Wraps GSAP slide-up with correct delay |
| Role badges | Inline styled span | `Badge` from `@shared/components/ui/Badge` | Already sized and styled |
| Auth/role reading | Direct Supabase call | `useAuth()` hook → `getUserRole()` | Already reads `app_metadata.role` |
| CSV download | Manual Blob construction | `exportTicketsCSV()` from `services/api.ts` | Already implemented, handles streaming |
| Date formatting | Custom string interpolation | `date-fns` `format()`, `formatDistanceToNow()` | Already installed, handles edge cases |
| Counter animation | `setInterval` counter | `animate()` from `animejs` | Already used in MetricsCards |

**Key insight:** The shared component library and API service layer are complete and proven. Using them directly avoids re-solving solved problems and maintains design consistency.

---

## Critical Backend Gap: Teams CRUD API Missing

**IMPORTANT:** The backend has the Team model and schemas, but NO registered API router for team CRUD operations. Specifically missing:

- `GET /api/v1/teams` — list teams for municipality
- `POST /api/v1/teams` — create new team
- `GET /api/v1/teams/{id}` — get team detail
- `PATCH /api/v1/teams/{id}` — update team
- `GET /api/v1/teams/{id}/members` — get team members
- `DELETE /api/v1/teams/{id}/members/{user_id}` — remove member from team
- `GET /api/v1/teams/{id}/invitations` — invitations scoped to team

The existing `/api/v1/invitations/` endpoints exist but are **NOT scoped to a team** — they operate at municipality level only. The `TeamInvitation` model and `TeamInvitationCreate` schema do not include a `team_id` field.

**Action required:** Create `src/api/v1/teams.py` with CRUD endpoints and register in `main.py`. This is a prerequisite for the Teams page.

**Also missing for Settings page:**
- `GET /api/v1/settings/sla` — list SLA configs for municipality
- `PUT /api/v1/settings/sla/{category}` — update SLA config
- `GET /api/v1/settings/municipality` — get municipality profile
- `PUT /api/v1/settings/municipality` — update municipality profile
- `GET /api/v1/audit-logs` — list audit logs (admin only)

The `SLAConfig` model exists but no SLA config CRUD API is registered. The `AuditLog` model exists but no audit log listing endpoint exists.

**For Analytics:** The existing `/api/v1/dashboard/*` endpoints return point-in-time snapshots. Time-series trend data (volume over 7d/30d/etc.) requires new backend endpoints with date range parameters — these do not exist yet. Option: either add new analytics endpoints to `dashboard.py` (recommended), or compute trend data client-side from ticket list data (hacky). Planning must account for this gap.

---

## Common Pitfalls

### Pitfall 1: Recharts Responsive Container Height
**What goes wrong:** `<ResponsiveContainer height="100%">` inside a flex container with no explicit height causes Recharts to render 0px height.
**Why it happens:** Recharts uses ResizeObserver on the parent; if parent has no height, chart is invisible.
**How to avoid:** Always set `height={300}` (px, not %) or wrap in a div with explicit height style.
**Warning signs:** Chart appears but shows no data; empty SVG in DevTools.

### Pitfall 2: Modal Scroll Lock
**What goes wrong:** When team detail modal is open, the body behind it continues to scroll.
**Why it happens:** CSS `overflow` is not blocked on body.
**How to avoid:** Add `document.body.style.overflow = 'hidden'` on modal open; restore on close. Use `useEffect` cleanup.
**Warning signs:** User can scroll past the backdrop while modal is open.

### Pitfall 3: Supabase JWT Role vs Backend Role
**What goes wrong:** `getUserRole()` reads from `app_metadata.role` (Supabase JWT metadata), but backend RBAC reads from the `users` table `role` column. These can diverge if a user's role is updated in the DB but their JWT hasn't refreshed.
**Why it happens:** Supabase doesn't automatically refresh JWT claims when DB metadata changes.
**How to avoid:** For display purposes, read from JWT (fast, no API call). For gate-keeping actual API calls, rely on the backend 403 responses. Don't make security decisions purely on frontend role check.
**Warning signs:** User sees admin UI but gets 403 from API.

### Pitfall 4: Inline GlassCard glow not triggering
**What goes wrong:** `GlassCard variant="interactive" glow="teal"` shows no glow on hover.
**Why it happens:** The GlassCard component only applies glow when `variant === 'interactive' && isHovered`. If you pass `variant="default"` it won't glow.
**How to avoid:** Always use `variant="interactive"` for clickable team cards.

### Pitfall 5: animejs `animate()` targeting unmounted refs
**What goes wrong:** Counter animation throws "Cannot set properties of null" after component unmounts.
**Why it happens:** anime.js animation continues after component unmounts if not cancelled.
**How to avoid:** Return animation cleanup in `useEffect`: `return () => animation.pause()`.

### Pitfall 6: Settings form dirty state without auto-save
**What goes wrong:** User edits multiple settings sections, navigates away, all changes lost with no warning.
**Why it happens:** The "explicit Save" decision means form state is local — no global save on unmount.
**How to avoid:** Track `isDirty` flag per section. Show `beforeunload` warning if any section has unsaved changes. Each section's Save button should be disabled when not dirty.

### Pitfall 7: Missing team_id on invitations
**What goes wrong:** Invitations created via the Teams page detail modal aren't associated with the specific team — they're municipality-level only.
**Why it happens:** The existing `TeamInvitation` model and backend `POST /invitations/` endpoint have no `team_id` field.
**How to avoid:** When creating the Teams backend API, add `team_id` to `TeamInvitation` schema or create a team-scoped invitation endpoint. The planner must schedule backend work before frontend invitation forms.

---

## Code Examples

### Category Color Map (consistent between Teams and Analytics)

```typescript
// Source: Derived from design-tokens.css and TicketCategory enum
export const CATEGORY_CONFIG: Record<string, { color: string; bgColor: string; label: string }> = {
  water:       { color: '#00bfa5', bgColor: 'rgba(0, 191, 165, 0.15)',    label: 'Water' },
  electricity: { color: '#ffd54f', bgColor: 'rgba(255, 213, 79, 0.15)',   label: 'Electricity' },
  roads:       { color: '#ff8a65', bgColor: 'rgba(255, 138, 101, 0.15)',  label: 'Roads' },
  waste:       { color: '#81c784', bgColor: 'rgba(129, 199, 132, 0.15)',  label: 'Waste' },
  sanitation:  { color: '#64b5f6', bgColor: 'rgba(100, 181, 246, 0.15)', label: 'Sanitation' },
  gbv:         { color: '#e57373', bgColor: 'rgba(229, 115, 115, 0.15)', label: 'GBV' },
  other:       { color: '#b0bec5', bgColor: 'rgba(176, 190, 197, 0.15)', label: 'Other' },
};
```

### Permission Matrix Data (role x capability)

```typescript
// Fixed 6 roles from UserRole enum in src/models/user.py
export const ROLES = ['citizen', 'field_worker', 'manager', 'ward_councillor', 'admin', 'saps_liaison'] as const;

export const CAPABILITIES = [
  { key: 'view_tickets', label: 'View Tickets' },
  { key: 'assign_tickets', label: 'Assign Tickets' },
  { key: 'export_data', label: 'Export Data' },
  { key: 'manage_teams', label: 'Manage Teams' },
  { key: 'invite_members', label: 'Invite Members' },
  { key: 'view_analytics', label: 'View Analytics' },
  { key: 'manage_settings', label: 'Manage Settings' },
  { key: 'view_gbv_cases', label: 'View GBV Cases' },
];

export const PERMISSION_MATRIX: Record<string, string[]> = {
  citizen:         [],
  field_worker:    ['view_tickets'],
  manager:         ['view_tickets', 'assign_tickets', 'export_data', 'manage_teams', 'invite_members', 'view_analytics'],
  ward_councillor: ['view_tickets', 'view_analytics'],
  admin:           ['view_tickets', 'assign_tickets', 'export_data', 'manage_teams', 'invite_members', 'view_analytics', 'manage_settings'],
  saps_liaison:    ['view_gbv_cases'],
};
```

### Skeleton Loading Pattern (match MetricsCards)

```typescript
// Source: MetricsCards.tsx — established pattern
import { Skeleton, SkeletonTheme } from '@shared/components/ui/Skeleton';

function TeamsPageSkeleton() {
  return (
    <div style={gridStyles}>
      <SkeletonTheme>
        {[0, 1, 2, 3, 4, 5].map((i) => (
          <GlassCard key={i} variant="default">
            <Skeleton height={14} width="60%" style={{ marginBottom: 'var(--space-sm)' }} />
            <Skeleton height={20} width="40%" style={{ marginBottom: 'var(--space-md)' }} />
            <Skeleton height={12} width="80%" />
          </GlassCard>
        ))}
      </SkeletonTheme>
    </div>
  );
}
```

### Tab Component (for Team Detail Modal)

```typescript
// No external tab library — built inline with state
const [activeTab, setActiveTab] = useState<'members' | 'invitations' | 'activity'>('members');

const tabStyle = (tab: string): React.CSSProperties => ({
  padding: 'var(--space-sm) var(--space-md)',
  border: 'none',
  borderBottom: activeTab === tab ? '2px solid var(--color-teal)' : '2px solid transparent',
  background: 'transparent',
  color: activeTab === tab ? 'var(--text-primary)' : 'var(--text-muted)',
  cursor: 'pointer',
  fontFamily: 'var(--font-body)',
  fontWeight: activeTab === tab ? '600' : '400',
  transition: 'var(--transition-fast)',
});
```

### Settings Section Wrapper Pattern

```typescript
interface SettingsSectionProps {
  id: string;               // for anchor navigation
  title: string;
  description?: string;
  adminOnly?: boolean;
  children: React.ReactNode;
  onSave: () => Promise<void>;
  isDirty: boolean;
  isSaving: boolean;
}

export function SettingsSection({ id, title, description, children, onSave, isDirty, isSaving }: SettingsSectionProps) {
  return (
    <section id={id} style={styles.section}>
      <div style={styles.sectionHeader}>
        <div>
          <h2 style={styles.sectionTitle}>{title}</h2>
          {description && <p style={styles.sectionDescription}>{description}</p>}
        </div>
        <Button
          variant="secondary"
          onClick={onSave}
          loading={isSaving}
          disabled={!isDirty || isSaving}
        >
          Save Changes
        </Button>
      </div>
      {children}
    </section>
  );
}
```

### Analytics Time Range Hook

```typescript
// Time range state and data fetching pattern
type TimeRange = '7d' | '30d' | '90d' | '6mo' | '1yr' | 'custom';

function useAnalytics(wardId?: string) {
  const [timeRange, setTimeRange] = useState<TimeRange>('30d');
  const [customStart, setCustomStart] = useState<string>('');
  const [customEnd, setCustomEnd] = useState<string>('');
  const [data, setData] = useState<AnalyticsData | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // Derive date range from timeRange
  const getDateRange = () => {
    if (timeRange === 'custom') return { start: customStart, end: customEnd };
    const end = new Date();
    const start = new Date();
    const days = { '7d': 7, '30d': 30, '90d': 90, '6mo': 180, '1yr': 365 }[timeRange] || 30;
    start.setDate(end.getDate() - days);
    return {
      start: start.toISOString().split('T')[0],
      end: end.toISOString().split('T')[0],
    };
  };

  useEffect(() => {
    const { start, end } = getDateRange();
    if (timeRange === 'custom' && (!start || !end)) return;
    fetchAnalyticsData(start, end, wardId).then(setData).finally(() => setIsLoading(false));
  }, [timeRange, customStart, customEnd, wardId]);

  return { data, isLoading, timeRange, setTimeRange, customStart, setCustomStart, customEnd, setCustomEnd };
}
```

---

## Backend Gaps Summary

These backend pieces are MISSING and must be created as part of this phase:

| Gap | Files to Create | Priority |
|-----|----------------|----------|
| Teams CRUD API | `src/api/v1/teams.py` | CRITICAL — Teams page blocked without it |
| SLA Config CRUD | `src/api/v1/settings.py` (new) or add to dashboard.py | HIGH — Settings SLA section blocked |
| Municipality profile API | Add PUT endpoint to `src/api/v1/municipalities.py` (currently admin-only platform level) | MEDIUM — Settings profile section |
| Analytics time-series endpoints | Add to `src/api/v1/dashboard.py` with `start_date`/`end_date` params | HIGH — Analytics trends blocked |
| Audit log listing endpoint | `src/api/v1/audit_logs.py` or inline in settings.py | MEDIUM — Settings audit section |

Teams CRUD is the most critical gap. Without it, the Teams page cannot list, create, or manage teams at all.

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Context API for global state | Zustand (dashboardStore.ts) | Already in codebase | New pages should use local state or custom hooks, not Context |
| CSS modules / styled-components | Inline `style` objects + CSS variables | Already in codebase | All new components must use inline styles + design tokens, not external CSS-in-JS |
| Page-level routing with `<a>` tags | React Router DOM v7 `NavLink`/`<Route>` | Already in codebase | Use `useNavigate` if programmatic nav needed |
| Global CSS class names | Per-component inline styles | Already in codebase | Don't create new global CSS classes; use CSS custom properties via `style={{}}` |
| Traditional chart libraries (Chart.js) | Recharts (already installed) | Already in codebase | Recharts only where needed; favour CSS for simple progress bars |

---

## Open Questions

1. **Analytics time-series: does backend need new endpoints or can frontend aggregate from existing?**
   - What we know: `/api/v1/dashboard/metrics`, `/api/v1/dashboard/volume`, `/api/v1/dashboard/sla`, `/api/v1/dashboard/workload` all return current-state aggregates, not historical time series.
   - What's unclear: Whether `ticket.created_at` and `ticket.resolved_at` could be queried to compute historical trend data with new backend endpoints, or if the existing data model supports it.
   - Recommendation: Add `start_date` and `end_date` query params to the existing dashboard endpoints. This is the minimal backend change required.

2. **Team members: how are users associated with teams?**
   - What we know: `Team` model has `manager_id` (FK to users). The `TeamInvitation` model exists. But there is no `team_members` junction table or `user.team_id` field.
   - What's unclear: How accepted invitations translate to team membership in the data model. The `TeamInvitation` model has `status` ("pending"/"accepted"/"expired") but no membership table.
   - Recommendation: The planner must decide whether to add a `team_memberships` junction table or use `TeamInvitation` status=accepted as the membership record. The latter is simpler and may already be the intent.

3. **Ward boundaries: how are wards stored?**
   - What we know: `ward_id` is used as a string filter param throughout the dashboard. The `Municipality` model has no ward data. No `Ward` model exists.
   - What's unclear: What the Ward Boundaries section of Settings should actually configure — this may be a placeholder that's out of scope for v1.
   - Recommendation: The Ward Boundaries settings section should be a read-only display of any configured ward IDs, with a "Contact SALGA support to configure" message. Don't try to build a ward boundary editor without a data model to back it.

---

## Sources

### Primary (HIGH confidence — verified in codebase)
- `frontend-dashboard/src/App.tsx` — current routing, placeholder pages confirmed
- `frontend-dashboard/src/components/dashboard/MetricsCards.tsx` — AnimatedCard + GlassCard + anime.js counter pattern
- `frontend-dashboard/src/components/layout/DashboardLayout.tsx` — layout structure
- `frontend-dashboard/src/components/layout/Sidebar.tsx` — role-based nav items
- `frontend-dashboard/src/hooks/useRoleBasedNav.ts` — role enum values and nav mapping
- `frontend-dashboard/src/hooks/useAuth.ts` — getUserRole() from app_metadata
- `frontend-dashboard/src/services/api.ts` — axios instance, JWT interceptor, API function patterns
- `frontend-dashboard/src/types/dashboard.ts` — DashboardMetrics, TeamWorkload, SLACompliance types
- `frontend-dashboard/src/components/onboarding/InviteTeamStep.tsx` — invitation form pattern
- `frontend-dashboard/src/components/onboarding/SetSLAStep.tsx` — SLA slider pattern
- `frontend-dashboard/package.json` — confirmed installed packages (Recharts 2.15.4, GSAP, animejs, date-fns, Zustand)
- `shared/design-tokens.css` — complete design token set
- `shared/components/ui/GlassCard.tsx` — GlassCard variants and props
- `src/api/v1/invitations.py` — POST /invitations/, POST /invitations/bulk, GET /invitations/, DELETE /invitations/{id}
- `src/api/v1/dashboard.py` — GET /dashboard/metrics, /volume, /sla, /workload (all support ward_id)
- `src/api/v1/export.py` — GET /export/tickets/csv, /export/tickets/excel
- `src/models/team.py` — Team model fields: name, category, manager_id, is_active, is_saps
- `src/models/user.py` — UserRole enum: CITIZEN, FIELD_WORKER, MANAGER, WARD_COUNCILLOR, ADMIN, SAPS_LIAISON
- `src/models/sla_config.py` — SLAConfig fields: response_hours, resolution_hours, warning_threshold_pct, category
- `src/models/audit_log.py` — AuditLog fields: tenant_id, user_id, operation, table_name, record_id, changes, timestamp
- `src/schemas/team.py` — TeamCreate (name, category, manager_id, is_saps), TeamResponse
- `src/schemas/invitation.py` — InvitationRole enum, TeamInvitationCreate, TeamInvitationResponse
- `src/models/ticket.py` — TicketCategory enum: WATER, ROADS, ELECTRICITY, WASTE, SANITATION, GBV, OTHER
- `src/main.py` — confirmed registered routers (no teams router, no settings/SLA router, no audit-logs router)

### Secondary (MEDIUM confidence)
- `src/api/v1/__init__.py` — confirmed teams is NOT in the registered modules list

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — verified from package.json and existing component imports
- Architecture patterns: HIGH — derived from existing proven patterns in codebase
- Backend gaps: HIGH — confirmed by reading main.py router registrations and model files
- Pitfalls: MEDIUM — derived from existing code patterns and known Recharts behaviour
- Open questions: MEDIUM — structural gaps identified, solutions are recommendations not confirmed

**Research date:** 2026-02-19
**Valid until:** 2026-03-19 (stable codebase; frontend patterns won't shift in 30 days)
