---
phase: 06.1.1-teams-analytics-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend-dashboard/src/types/teams.ts
  - frontend-dashboard/src/types/analytics.ts
  - frontend-dashboard/src/types/settings.ts
  - frontend-dashboard/src/services/api.ts
  - frontend-dashboard/src/constants/categories.ts
  - frontend-dashboard/src/constants/permissions.ts
  - frontend-dashboard/src/components/analytics/SparkLine.tsx
autonomous: true
requirements:
  - OPS-01
  - OPS-04
  - SEC-04

must_haves:
  truths:
    - "TypeScript types exist for Team, TeamMember, Invitation, AnalyticsData, SLAConfig, AuditLog"
    - "API service has functions for fetchTeams, createTeam, fetchSLAConfigs, fetchAuditLogs, fetchAnalyticsMetrics"
    - "Category config maps each service type to a color and icon label"
    - "Permission matrix defines capabilities per role for all 6 system roles"
    - "SparkLine component renders SVG polyline from numeric data array"
  artifacts:
    - path: "frontend-dashboard/src/types/teams.ts"
      provides: "Team, TeamMember, TeamCreate TypeScript interfaces"
      contains: "interface Team"
    - path: "frontend-dashboard/src/types/analytics.ts"
      provides: "AnalyticsData, TimeRange TypeScript types"
      contains: "type TimeRange"
    - path: "frontend-dashboard/src/services/api.ts"
      provides: "All API functions for Teams, Settings, Analytics, AuditLogs"
      contains: "fetchTeams"
    - path: "frontend-dashboard/src/components/analytics/SparkLine.tsx"
      provides: "Pure SVG sparkline component"
      contains: "polyline"
  key_links:
    - from: "frontend-dashboard/src/services/api.ts"
      to: "/api/v1/teams"
      via: "axios get/post"
      pattern: "api\\.(get|post).*teams"
    - from: "frontend-dashboard/src/services/api.ts"
      to: "/api/v1/settings"
      via: "axios get/put"
      pattern: "api\\.(get|put).*settings"
---

<objective>
Create all shared TypeScript types, API service functions, constants, and reusable components needed by the Teams, Analytics, and Settings pages.

Purpose: Establish the data layer and shared utilities before page components are built. This eliminates duplication and ensures type safety across all 3 pages.

Output: Type definitions, API functions, category/permission constants, and the SVG SparkLine component.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@frontend-dashboard/src/types/dashboard.ts
@frontend-dashboard/src/services/api.ts
@frontend-dashboard/src/hooks/useAuth.ts
@shared/design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types and constants for Teams, Analytics, and Settings</name>
  <files>
    frontend-dashboard/src/types/teams.ts
    frontend-dashboard/src/types/analytics.ts
    frontend-dashboard/src/types/settings.ts
    frontend-dashboard/src/constants/categories.ts
    frontend-dashboard/src/constants/permissions.ts
  </files>
  <action>
1. Create `frontend-dashboard/src/types/teams.ts`:
   ```typescript
   export interface Team {
     id: string;
     name: string;
     category: string;
     manager_id: string | null;
     manager_name: string | null;
     is_active: boolean;
     is_saps: boolean;
     member_count: number;
     active_ticket_count: number;
     created_at: string;
   }

   export interface TeamCreate {
     name: string;
     category: string;
     manager_id?: string;
     is_saps?: boolean;
   }

   export interface TeamMember {
     id: string;
     email: string;
     full_name: string;
     role: string;
     joined_at: string | null;
   }

   export interface TeamInvitation {
     id: string;
     municipality_id: string;
     team_id: string | null;
     email: string;
     role: string;
     invited_by: string;
     status: 'pending' | 'accepted' | 'expired' | 'removed';
     accepted_at: string | null;
     expires_at: string | null;
     created_at: string;
   }

   export interface InvitationCreate {
     email: string;
     role: string;
     team_id?: string;
   }

   export interface BulkInvitationCreate {
     invitations: InvitationCreate[];
   }
   ```

2. Create `frontend-dashboard/src/types/analytics.ts`:
   ```typescript
   export type TimeRange = '7d' | '30d' | '90d' | '6mo' | '1yr' | 'custom';

   export interface AnalyticsData {
     metrics: {
       total_open: number;
       total_resolved: number;
       sla_compliance_percent: number;
       avg_response_hours: number;
       sla_breaches: number;
     };
     volume: Array<{ category: string; open: number; resolved: number }>;
     sla: {
       response_compliance_percent: number;
       resolution_compliance_percent: number;
       total_with_sla: number;
       response_breaches: number;
       resolution_breaches: number;
     };
     workload: Array<{ team_id: string; team_name: string; open_count: number; total_count: number }>;
   }

   export interface KPIMetric {
     label: string;
     value: number;
     unit?: string;
     trend?: number[];
     trendDirection?: 'up' | 'down' | 'neutral';
     color: string;
   }
   ```

3. Create `frontend-dashboard/src/types/settings.ts`:
   ```typescript
   export interface SLAConfig {
     category: string | null;
     response_hours: number;
     resolution_hours: number;
     warning_threshold_pct: number;
     is_active: boolean;
   }

   export interface MunicipalityProfile {
     id: string;
     name: string;
     code: string;
     province: string;
     contact_email: string | null;
     contact_phone: string | null;
     logo_url: string | null;
   }

   export interface AuditLogEntry {
     id: string;
     tenant_id: string;
     user_id: string | null;
     operation: string;
     table_name: string;
     record_id: string;
     changes: string | null;
     timestamp: string;
   }

   export interface PaginatedAuditLogs {
     logs: AuditLogEntry[];
     total: number;
     page: number;
     page_size: number;
   }
   ```

4. Create `frontend-dashboard/src/constants/categories.ts`:
   Export a `CATEGORY_CONFIG` record mapping each category string to `{ color, bgColor, icon, label }`.
   Categories: water (#00bfa5), electricity (#ffd54f), roads (#ff8a65), waste (#81c784), sanitation (#64b5f6), gbv (#e57373), other (#b0bec5).
   Icon names: 'droplet', 'zap', 'road', 'trash', 'pipe', 'shield', 'help-circle'.
   Per context: "Category icons per service type with unique accent colors" and "Both icon AND colored badge together".

5. Create `frontend-dashboard/src/constants/permissions.ts`:
   Export `ROLES` array of 6 system roles.
   Export `CAPABILITIES` array of {key, label} objects (view_tickets, assign_tickets, export_data, manage_teams, invite_members, view_analytics, manage_settings, view_gbv_cases).
   Export `PERMISSION_MATRIX` record mapping each role to array of capability keys.
   Export `ROLE_LABELS` record: default display labels for each role (e.g., 'manager' -> 'Manager', 'field_worker' -> 'Field Worker').
   Per context: "Fixed 6 system roles" and "Permission matrix: visual grid showing role x capability with checkmarks".
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/types/teams.ts src/types/analytics.ts src/types/settings.ts 2>&1 | head -5` — should show no errors (or only unrelated ones from other files).
  </verify>
  <done>All TypeScript type definitions exist and compile. Category config and permission constants are ready for use by all 3 pages.</done>
</task>

<task type="auto">
  <name>Task 2: Extend API service + create SparkLine component</name>
  <files>
    frontend-dashboard/src/services/api.ts
    frontend-dashboard/src/components/analytics/SparkLine.tsx
  </files>
  <action>
1. Add these functions to `frontend-dashboard/src/services/api.ts`, following the existing pattern (axios instance, error handling):

   **Teams API:**
   - `fetchTeams(): Promise<Team[]>` — GET /teams
   - `createTeam(data: TeamCreate): Promise<Team>` — POST /teams
   - `fetchTeamDetail(teamId: string): Promise<Team>` — GET /teams/{teamId}
   - `updateTeam(teamId: string, data: Partial<TeamCreate>): Promise<Team>` — PATCH /teams/{teamId}
   - `fetchTeamMembers(teamId: string): Promise<TeamMember[]>` — GET /teams/{teamId}/members
   - `removeTeamMember(teamId: string, invitationId: string): Promise<void>` — DELETE /teams/{teamId}/members/{invitationId}
   - `fetchTeamInvitations(teamId: string): Promise<TeamInvitation[]>` — GET /teams/{teamId}/invitations
   - `createInvitation(data: InvitationCreate): Promise<TeamInvitation>` — POST /invitations/ (update existing function signature to accept team_id)
   - `createBulkInvitations(data: BulkInvitationCreate): Promise<TeamInvitation[]>` — POST /invitations/bulk

   **Settings/SLA API:**
   - `fetchSLAConfigs(): Promise<SLAConfig[]>` — GET /settings/sla
   - `updateSLAConfig(category: string, data: { response_hours: number; resolution_hours: number; warning_threshold_pct: number }): Promise<SLAConfig>` — PUT /settings/sla/{category}
   - `fetchMunicipalityProfile(): Promise<MunicipalityProfile>` — GET /settings/municipality
   - `updateMunicipalityProfile(data: Partial<MunicipalityProfile>): Promise<MunicipalityProfile>` — PUT /settings/municipality

   **Audit Logs API:**
   - `fetchAuditLogs(params: { page?: number; page_size?: number; table_name?: string; operation?: string }): Promise<PaginatedAuditLogs>` — GET /audit-logs

   **Analytics (extend existing):**
   - `fetchAnalyticsData(startDate: string, endDate: string, wardId?: string): Promise<AnalyticsData>` — Calls all 4 existing dashboard endpoints (metrics, volume, sla, workload) in parallel with start_date + end_date params, returns combined AnalyticsData object.

   Add the necessary type imports at the top of api.ts from the new type files.

2. Create `frontend-dashboard/src/components/analytics/SparkLine.tsx`:
   A pure SVG sparkline component. No Recharts — just an SVG `<polyline>`.

   Props: `data: number[], width?: number (default 80), height?: number (default 32), color?: string (default 'var(--color-teal)')`.

   Implementation:
   - Return null if data.length < 2
   - Compute min/max of data, map each point to x/y coordinates within width/height
   - Render `<svg>` with `<polyline>` using computed points string
   - strokeWidth 1.5, strokeLinecap round, strokeLinejoin round, fill none
   - Add a subtle gradient fill below the line: create a `<linearGradient>` from color at 30% opacity to transparent, render a `<polygon>` that closes the polyline path to the bottom

   Per context: "Pure SVG sparklines drawn inline... 20 lines of code, zero dependencies"
   Per research: "Claude historically struggles with chart/pie implementations — be careful... keep visualizations simple"
  </action>
  <verify>
    Run `cd frontend-dashboard && npx tsc --noEmit src/services/api.ts 2>&1 | head -10` — should compile without type errors.
    Run `cd frontend-dashboard && npx tsc --noEmit src/components/analytics/SparkLine.tsx 2>&1 | head -5` — should compile.
  </verify>
  <done>API service has 16+ new functions covering all backend endpoints. SparkLine is a zero-dependency SVG component ready for Analytics KPI cards.</done>
</task>

</tasks>

<verification>
1. All type files compile with tsc --noEmit
2. API service imports resolve correctly
3. SparkLine renders an SVG element (can verify by importing)
4. Category config has entries for all 7 categories
5. Permission matrix has entries for all 6 roles
6. No new npm packages required (all dependencies already installed)
</verification>

<success_criteria>
- 3 type definition files with complete interfaces for teams, analytics, settings
- 2 constants files (categories, permissions) with complete data
- API service extended with 16+ functions matching backend endpoints
- SparkLine component renders SVG polyline from numeric array
- All files compile with TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/06.1.1-teams-analytics-and-settings-pages-ui-full-implementations-with-user-roles-municipal-multi-tenancy-new-roles-new-teams-user-journeys-design-consistency/06.1.1-02-SUMMARY.md`
</output>
