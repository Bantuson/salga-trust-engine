---
phase: 06.1.1-teams-analytics-settings
plan: 02
subsystem: ui
tags: [typescript, react, svg, axios, teams, analytics, settings, sla, audit-logs]

# Dependency graph
requires:
  - phase: 06.1.1-01
    provides: "Phase context and research — Teams, Analytics, Settings page designs"
  - phase: 05
    provides: "Dashboard types (DashboardMetrics, CategoryVolume, SLACompliance, TeamWorkload) in dashboard.ts"
provides:
  - "TypeScript interfaces for Team, TeamMember, TeamInvitation, InvitationCreate, BulkInvitationCreate"
  - "TypeScript types for TimeRange, AnalyticsData, KPIMetric"
  - "TypeScript interfaces for SLAConfig, MunicipalityProfile, AuditLogEntry, PaginatedAuditLogs"
  - "CATEGORY_CONFIG record with color/bgColor/icon/label for 7 service categories"
  - "PERMISSION_MATRIX with capability arrays for all 6 system roles"
  - "16 new API service functions covering Teams, Settings, Audit Logs, Analytics endpoints"
  - "SparkLine SVG component — pure SVG polyline with gradient fill, zero dependencies"
affects:
  - "06.1.1-03 (Teams page component)"
  - "06.1.1-04 (Analytics page component)"
  - "06.1.1-05 (Settings page component)"
  - "06.1.1-06 and beyond — all pages sharing these types"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Type-safe API functions with AxiosError-typed error handling pattern"
    - "fetchAnalyticsData: parallel Promise.all for 4 dashboard endpoints — single call returns AnalyticsData"
    - "CATEGORY_CONFIG: record keyed by category string with getCategoryConfig(category) fallback helper"
    - "PERMISSION_MATRIX: role -> capability[] map with hasCapability(role, cap) helper"
    - "SparkLine: pure SVG — padded coordinate mapping, stable random gradient ID per render"

key-files:
  created:
    - "frontend-dashboard/src/types/teams.ts"
    - "frontend-dashboard/src/types/analytics.ts"
    - "frontend-dashboard/src/types/settings.ts"
    - "frontend-dashboard/src/constants/categories.ts"
    - "frontend-dashboard/src/constants/permissions.ts"
    - "frontend-dashboard/src/components/analytics/SparkLine.tsx"
  modified:
    - "frontend-dashboard/src/services/api.ts"

key-decisions:
  - "fetchAnalyticsData uses Promise.all for 4 parallel backend calls — matches existing dashboard endpoint structure, no new endpoints needed"
  - "SparkLine uses random gradient ID per render to avoid SVG ID conflicts when multiple SparkLines appear on same page"
  - "getCategoryConfig() helper returns 'other' as fallback — prevents undefined crashes for unknown categories"
  - "hasCapability() helper in permissions.ts — UI utility; backend enforces actual permissions via RLS"
  - "ROLES defined as const assertion (as const) for type inference of SystemRole union type"

patterns-established:
  - "All API functions wrapped in try/catch with AxiosError check, throwing plain Error with detail message"
  - "Constants files export both data objects and helper functions for common access patterns"

requirements-completed:
  - OPS-01
  - OPS-04
  - SEC-04

# Metrics
duration: 5min
completed: 2026-02-19
---

# Phase 06.1.1 Plan 02: Data Layer Summary

**TypeScript types + API functions + CATEGORY_CONFIG + PERMISSION_MATRIX + SVG SparkLine — complete data layer for Teams, Analytics, and Settings pages**

## Performance

- **Duration:** 5 min (305s)
- **Started:** 2026-02-19T17:42:25Z
- **Completed:** 2026-02-19T17:47:30Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Created 3 TypeScript type files covering all Teams, Analytics, and Settings domain objects
- Created 2 constants files with category config (7 service types) and permission matrix (6 roles x 8 capabilities)
- Extended API service with 16 new functions covering Teams, Settings, Audit Logs, and Analytics endpoints
- Created SparkLine — a pure SVG component with gradient fill, no chart library dependency

## Task Commits

Each task was committed atomically:

1. **Task 1: TypeScript types and constants** - `1803ca2` (feat)
2. **Task 2: Extend API service + SparkLine component** - `679bbd2` (feat)

**Plan metadata:** (committed with docs commit below)

## Files Created/Modified
- `frontend-dashboard/src/types/teams.ts` - Team, TeamCreate, TeamMember, TeamInvitation, InvitationCreate, BulkInvitationCreate
- `frontend-dashboard/src/types/analytics.ts` - TimeRange, AnalyticsData, KPIMetric
- `frontend-dashboard/src/types/settings.ts` - SLAConfig, MunicipalityProfile, AuditLogEntry, PaginatedAuditLogs
- `frontend-dashboard/src/constants/categories.ts` - CATEGORY_CONFIG (7 categories: water, electricity, roads, waste, sanitation, gbv, other) + getCategoryConfig() helper
- `frontend-dashboard/src/constants/permissions.ts` - ROLES, ROLE_LABELS, CAPABILITIES (8), PERMISSION_MATRIX (6 roles), hasCapability() helper
- `frontend-dashboard/src/services/api.ts` - Added 16 functions + type imports from new files
- `frontend-dashboard/src/components/analytics/SparkLine.tsx` - Pure SVG sparkline with linearGradient fill polygon + polyline

## Decisions Made
- `fetchAnalyticsData` uses `Promise.all` to call 4 existing dashboard endpoints in parallel — no new backend endpoints needed, reduces latency vs sequential calls
- SparkLine generates a random suffix for gradient IDs to prevent SVG conflicts when multiple instances render on the same page
- `getCategoryConfig()` falls back to "other" for unknown categories — prevents runtime crashes when new categories added to backend
- Permission matrix is UI-only (displayed in Settings grid); backend enforces actual access via RLS policies and FastAPI guards

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Running `tsc --noEmit src/services/api.ts` without the project tsconfig reports `import.meta` and JSX errors (no Vite context). Confirmed with `tsc --noEmit -p tsconfig.json` — zero errors. This is expected behavior for Vite projects run outside Vite's tsconfig.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All types, constants, API functions, and SparkLine component are ready for consumption
- Plans 03, 04, and 05 can now build Teams, Analytics, and Settings page components without duplicating types or API calls
- Zero new npm packages required — all utilities use existing axios, React, and TypeScript

---
*Phase: 06.1.1-teams-analytics-settings*
*Completed: 2026-02-19*
