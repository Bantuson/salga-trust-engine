---
phase: 06.9.2-system-wide-integration-validation
plan: 03
subsystem: infra
tags: [ruff, github-actions, ci-cd, render, celery, crewai, staging, linting]

# Dependency graph
requires:
  - phase: 06.9.2-system-wide-integration-validation
    provides: All backend services (FastAPI, CrewAI crew server, Celery worker) that need CI/CD

provides:
  - Ruff linter configuration with security rules (bandit), isort, pyflakes, pyupgrade
  - GitHub Actions CI pipeline running lint, unit tests, coverage, and both frontend builds
  - Render Blueprint for staging deployment (4 services + 1 database)

affects:
  - future-phases: all future plans benefit from CI checks on every push
  - deployment: render.yaml enables one-click staging deployment

# Tech tracking
tech-stack:
  added:
    - ruff>=0.8.0 (Python linter and formatter)
    - GitHub Actions (CI/CD pipeline)
    - Render Blueprint (staging deployment config)
  patterns:
    - Lint job gates unit-test job (needs: lint) for fast feedback
    - Secrets marked sync:false in render.yaml (manual Render dashboard configuration required)
    - generateValue:true for SECRET_KEY and CREW_SERVER_API_KEY (auto-generated)

key-files:
  created:
    - .ruff.toml
    - .github/workflows/ci.yml
    - render.yaml
  modified:
    - pyproject.toml

key-decisions:
  - "Ruff selected over flake8/pylint — single fast tool covers linting, formatting, and security checks"
  - "Lint job gates test job (needs: lint) — fail fast before expensive test runs"
  - "CI uses sqlite+aiosqlite test DB — no PostgreSQL service required in CI, tests already handle this via USES_SQLITE_TESTS"
  - "Render plan: starter for all services ($7/month each) — appropriate for staging, not production"
  - "Crew server runs as separate web service (not worker) — needs HTTP health check endpoint for Render routing"
  - "OPENAI_API_KEY=dummy-key-for-crewai-validation on crew server — prevents LiteLLM validation errors at startup"

patterns-established:
  - "CI pipeline pattern: lint → test → frontend builds (sequential dependency via needs:)"
  - "Render secrets pattern: sync:false for external credentials, generateValue:true for internal keys"

requirements-completed:
  - PLAT-05

# Metrics
duration: 6.7min
completed: 2026-02-20
---

# Phase 06.9.2 Plan 03: Code Quality, CI/CD, and Render Staging Summary

**Ruff linter with security rules, 4-job GitHub Actions CI pipeline, and Render Blueprint defining 3 backend services + Redis + PostgreSQL for staging**

## Performance

- **Duration:** 6.7 min (403s)
- **Started:** 2026-02-20T15:44:07Z
- **Completed:** 2026-02-20T15:50:50Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Created `.ruff.toml` with 9 rule categories including bandit security rules, pyflakes, isort, pyupgrade, and flake8-bugbear; verified it runs against the codebase
- Created `.github/workflows/ci.yml` with 4 jobs: `lint` (ruff check + format check), `test` (unit tests + coverage with artifact upload), `frontend-dashboard` build, `frontend-public` build; YAML validated
- Created `render.yaml` Render Blueprint with 4 services (salga-api, salga-crew-server, salga-celery worker, salga-redis) and 1 PostgreSQL database; all secrets marked `sync:false` for manual Render dashboard configuration
- Added `ruff>=0.8.0` to `pyproject.toml` dev dependencies

## Task Commits

Each task was committed atomically:

1. **Task 1: Configure ruff linter and GitHub Actions CI pipeline** - `7ecfb60` (feat)
2. **Task 2: Create Render Blueprint for staging deployment** - `12b8d99` (feat)

**Plan metadata:** (included in final docs commit)

## Files Created/Modified

- `.ruff.toml` - Ruff linter config: line-length=120, py312, security (bandit), isort, pyflakes, pyupgrade, bugbear, simplify rules; per-file ignores for tests and alembic
- `.github/workflows/ci.yml` - 4-job CI pipeline: lint (ruff), test (pytest + coverage), frontend-dashboard build, frontend-public build; test env uses sqlite+aiosqlite
- `render.yaml` - Render Blueprint: salga-api web, salga-crew-server web, salga-celery worker, salga-redis; salga-db PostgreSQL 15; all credentials `sync:false`
- `pyproject.toml` - Added `ruff>=0.8.0` to `[project.optional-dependencies] dev`

## Decisions Made

- Ruff chosen over flake8/pylint — single fast binary covers linting, formatting, import sorting, and security in one tool
- `lint` job gates `test` job via `needs: lint` — ensures no test resources wasted on code that fails linting
- CI test environment uses `sqlite+aiosqlite` with `USES_SQLITE_TESTS=1` — matches existing unit test infrastructure, no PostgreSQL service needed
- Render `starter` plan ($7/month) for all services — sufficient for staging workloads
- Crew server deployed as separate `web` service (not `worker`) — needs HTTP health check path for Render load balancer
- `OPENAI_API_KEY: dummy-key-for-crewai-validation` set on crew server — prevents LiteLLM validation errors at startup without real OpenAI usage

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - both tasks completed cleanly. Ruff not pre-installed on the system but installed successfully via `pip install ruff` for local verification.

## User Setup Required

**Manual Render dashboard steps required after Blueprint deployment:**
In the Render dashboard, after creating the Blueprint instance pointing at this repo, set these env vars manually for each service:
- `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` (all 3 services)
- `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_WHATSAPP_FROM` (salga-api and salga-celery)
- `DEEPSEEK_API_KEY` (salga-api and salga-crew-server)
- `CREW_SERVER_API_KEY` (salga-crew-server — use the auto-generated value from salga-api env)

Live Twilio staging integration testing is performed after services are running.

## Next Phase Readiness

- CI pipeline is live — every push to `main` now runs lint, tests, and frontend builds
- Render Blueprint ready for one-click staging deployment
- Ruff configured and available locally for pre-commit quality checks
- No blockers for remaining Phase 06.9.2 plans

---
*Phase: 06.9.2-system-wide-integration-validation*
*Completed: 2026-02-20*

## Self-Check: PASSED

- FOUND: .ruff.toml
- FOUND: .github/workflows/ci.yml
- FOUND: render.yaml
- FOUND: pyproject.toml (modified)
- FOUND: commit 7ecfb60 (Task 1 — ruff + CI pipeline)
- FOUND: commit 12b8d99 (Task 2 — render.yaml)
- FOUND: 06.9.2-03-SUMMARY.md
