# Phase 06.9.2 Research: System-wide Integration Validation

## 1. API Endpoint Inventory

### Main FastAPI App (src/main.py → port 8000)
24 route modules in `src/api/v1/`, 68 total endpoint handlers across 22 files:

| Module | Endpoints | Auth | Rate Limited |
|--------|-----------|------|-------------|
| auth.py | 5 | Mixed (register/login public) | Yes (auth-specific) |
| tickets.py | 5 | Yes (RBAC) | No explicit |
| teams.py | 7 | Yes (RBAC) | No explicit |
| public.py | 5 | No (public) | No explicit |
| municipalities.py | 4 | Yes | No explicit |
| dashboard.py | 4 | Yes (RBAC) | No explicit |
| settings.py | 4 | Yes (RBAC) | No explicit |
| invitations.py | 4 | Yes | No explicit |
| access_requests.py | 3 | Mixed | No explicit |
| consent.py | 3 | Yes | No explicit |
| onboarding.py | 3 | Yes | No explicit |
| reports.py | 3 | Yes | No explicit |
| verification.py | 3 | Yes | No explicit |
| citizen.py | 2 | Yes | No explicit |
| data_rights.py | 2 | Yes | Yes |
| export.py | 2 | Yes (RBAC) | No explicit |
| messages.py | 2 | Yes | No explicit |
| uploads.py | 2 | Yes | No explicit |
| whatsapp.py | 2 | Twilio signature | No explicit |
| audit_logs.py | 1 | Yes (admin) | No explicit |
| events.py | 1 | Yes | No explicit |
| users.py | 1 | Yes | No explicit |

### CrewAI Server (src/api/v1/crew_server.py → port 8001)
Separate FastAPI app (`crew_app`), 3 endpoints:
- `GET /api/v1/health` — no auth
- `POST /api/v1/session/reset` — API key auth (CREW_SERVER_API_KEY)
- `POST /api/v1/chat` — API key auth

**Gap:** Crew server has no rate limiting. No CORS config. No input validation schemas beyond basic Pydantic.

## 2. Rate Limiting Status

Current implementation in `src/middleware/rate_limit.py`:
- Uses slowapi with Redis backend (production) / in-memory (dev)
- Applied globally via middleware in main.py
- Specific limits on auth (5/hour login, data_rights (5/hour export, 1/day deletion)
- **Gap:** Most endpoints rely on global rate limit only. Crew server has NO rate limiting at all.

## 3. Dashboard Fetch Analysis

### Municipal Dashboard (frontend-dashboard/)
Fetches in 3 files:
- `RequestAccessPage.tsx` — fetch to `/api/v1/access-requests`
- `OnboardingWizardPage.tsx` — fetch to `/api/v1/onboarding`
- `useOnboarding.ts` — fetch to `/api/v1/onboarding/state`
- Additional: `useTeams`, `useSettings`, analytics hooks fetch via API service layer

**Potential failure points:** Auth token expiry, CORS misconfig on crew_server, missing error handling on network failures, stale Supabase sessions.

### Public Dashboard (frontend-public/)
Fetches in 2 files:
- `usePublicStats.ts` — queries Supabase RLS views directly
- `useCitizenReports.ts` — queries Supabase for citizen tickets

**Potential failure points:** Supabase anon key misconfigured, RLS view not returning data, CORS on Supabase project.

## 4. 3-Way Communication Flow

The end-to-end data flow:
1. **CrewAI Agent → Ticket Creation:** WhatsApp message → crew_server `/api/v1/chat` → ManagerCrew routes to MunicipalIntakeCrew → `ticket_tool.py` creates ticket in Supabase via admin client
2. **Ticket → Municipal Dashboard:** Dashboard fetches from FastAPI `/api/v1/tickets` with auth + tenant filter. SSE/Realtime via Supabase pg_notify triggers for live updates.
3. **Municipal Stats → Public Dashboard:** Public dashboard queries `public_ticket_stats`, `public_municipalities`, `public_heatmap` RLS views via Supabase anon key. These views aggregate from the same tickets table, excluding GBV (is_sensitive=false filter).

**Validation needed:** Ticket created by agent → visible in municipal dashboard → stats reflected in public dashboard. Full round-trip.

## 5. Security Audit Scope

### OWASP Top 10 Checklist for FastAPI
1. **Broken Access Control (A01):** Verify RBAC on all endpoints, RLS policies, tenant isolation
2. **Cryptographic Failures (A02):** TLS in transit, Supabase encryption at rest
3. **Injection (A03):** SQLAlchemy ORM prevents SQL injection; verify no raw SQL
4. **Insecure Design (A04):** GBV firewall architecture review
5. **Security Misconfiguration (A05):** CORS origins, security headers, debug mode off
6. **Vulnerable Components (A06):** Dependency audit (pip audit, npm audit)
7. **Auth Failures (A07):** JWT validation, token rotation, session management
8. **Data Integrity (A08):** Input validation on all endpoints
9. **Logging Failures (A09):** Audit logging coverage
10. **SSRF (A10):** External URL handling in media uploads

### SEC-05 GBV Firewall (5 layers)
1. Routing layer: GBV → SAPS teams only
2. Database RLS: is_sensitive filter
3. API layer: 403 for non-SAPS/admin
4. Storage: gbv-evidence bucket restricted
5. Public views: exclude is_sensitive=true

## 6. CI/CD Infrastructure (None exists)

**Needed:**
- `.github/workflows/ci.yml` — GitHub Actions pipeline
- `render.yaml` — Render Blueprint for staging deployment

### GitHub Actions Pipeline Components
1. **Lint:** ruff or flake8 (no linter currently configured in pyproject.toml)
2. **Type check:** mypy (not currently configured)
3. **Unit tests:** `pytest` with SQLite (existing 310+ tests)
4. **Coverage:** `pytest --cov=src` with 80% minimum (already in pyproject.toml)
5. **Frontend build:** `npm run build` for both dashboards
6. **Frontend lint:** `npm run lint` for both dashboards

### Render Staging Services
- **Web service:** FastAPI main app (`uvicorn src.main:app --host 0.0.0.0 --port $PORT`)
- **Background worker:** Celery (`celery -A src.celery_app worker --loglevel=info --pool=solo`)
- **Redis:** Key-value store for Celery broker + rate limiting
- **Environment:** All env vars from .env (Supabase, Twilio, DeepSeek, etc.)

### render.yaml Structure
```yaml
services:
  - type: web
    name: salga-trust-engine
    runtime: python
    buildCommand: pip install -e ".[dev]"
    startCommand: uvicorn src.main:app --host 0.0.0.0 --port $PORT
    envVars: [from .env]
  - type: worker
    name: salga-celery
    runtime: python
    buildCommand: pip install -e ".[dev]"
    startCommand: celery -A src.celery_app worker --loglevel=info --concurrency=4
  - type: web
    name: salga-crew-server
    runtime: python
    buildCommand: pip install -e ".[dev]"
    startCommand: uvicorn src.api.v1.crew_server:crew_app --host 0.0.0.0 --port $PORT
```

## 7. Code Quality Status

- **Python linting:** No ruff/flake8/black config in pyproject.toml (only alembic.ini has commented examples)
- **Type checking:** No mypy config
- **Frontend linting:** ESLint configured in both dashboards
- **Test coverage:** 80% minimum enforced in pyproject.toml (`fail_under = 80`)
- **Existing tests:** 310+ unit tests, 130 E2E tests (Playwright)

## 8. Key Risks & Gaps

1. **Most API endpoints have no explicit rate limiting** — only global middleware limit
2. **Crew server has zero security hardening** — no rate limit, no CORS, no input sanitization beyond Pydantic
3. **No CI/CD pipeline exists** — no .github/workflows, no render.yaml
4. **No Python linter configured** — code quality checks are manual
5. **Dashboard fetch errors need investigation** — user reports failing fetches
6. **3-way communication untested end-to-end** — each piece works in isolation
7. **Celery on Render requires paid plan** — budget consideration

## 9. Testing Strategy (Per User Direction)

Tests should be behavioral and focused:
- **Component behavior:** Does endpoint X return expected data for role Y?
- **Failure points:** What happens when auth fails? When Supabase is down? When rate limit is hit?
- **System design soundness:** Does the 3-way flow actually work? Does GBV firewall hold?
- **NOT overengineered:** No mocking every dependency. No 100% coverage obsession. Test what matters.

## RESEARCH COMPLETE
