---
phase: 02-agentic-ai-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/agents/__init__.py
  - src/agents/flows/__init__.py
  - src/agents/flows/state.py
  - src/agents/flows/intake_flow.py
  - src/agents/crews/__init__.py
  - src/agents/crews/municipal_crew.py
  - src/agents/tools/__init__.py
  - src/agents/tools/ticket_tool.py
  - src/agents/config/agents.yaml
  - src/agents/config/tasks.yaml
  - src/agents/prompts/__init__.py
  - src/agents/prompts/municipal.py
  - tests/test_intake_flow.py
  - tests/test_municipal_crew.py
autonomous: true

must_haves:
  truths:
    - "Manager agent (Flow) receives a message and routes it to the correct specialist crew based on content"
    - "Municipal services crew conducts structured intake asking for category, location, description, and severity"
    - "Intake produces a validated TicketData Pydantic model with all required fields"
    - "Agent responds in the same language the citizen uses (EN/ZU/AF)"
    - "Flow state tracks conversation across multiple turns"
  artifacts:
    - path: "src/agents/flows/intake_flow.py"
      provides: "CrewAI Flow for message routing and orchestration"
      contains: "class IntakeFlow"
    - path: "src/agents/flows/state.py"
      provides: "Flow state model for tracking conversation"
      contains: "class IntakeState"
    - path: "src/agents/crews/municipal_crew.py"
      provides: "Municipal services intake crew with structured intake"
      contains: "class MunicipalCrew"
    - path: "src/agents/tools/ticket_tool.py"
      provides: "Tool for creating tickets in database"
      contains: "create_ticket"
    - path: "src/agents/prompts/municipal.py"
      provides: "Trilingual prompt templates for municipal intake"
      contains: "MUNICIPAL_PROMPTS"
  key_links:
    - from: "src/agents/flows/intake_flow.py"
      to: "src/core/language.py"
      via: "language_detector.detect()"
      pattern: "language_detector"
    - from: "src/agents/flows/intake_flow.py"
      to: "src/agents/crews/municipal_crew.py"
      via: "crew instantiation and kickoff"
      pattern: "MunicipalCrew"
    - from: "src/agents/crews/municipal_crew.py"
      to: "src/schemas/ticket.py"
      via: "output_pydantic=TicketData"
      pattern: "TicketData"
    - from: "src/agents/tools/ticket_tool.py"
      to: "src/models/ticket.py"
      via: "Ticket model creation"
      pattern: "Ticket\\("
---

<objective>
Build the CrewAI agent framework with Flow-based message routing and the municipal services specialist crew for structured intake of service reports.

Purpose: This is the core agentic AI system (AI-01, AI-02, AI-03, AI-05). The Flow receives citizen messages, detects language, classifies category, and routes to the municipal services crew which conducts structured conversational intake to gather all required ticket information.

Output: IntakeFlow (orchestration), MunicipalCrew (intake agent), ticket creation tool, trilingual prompt templates, unit tests with mocked LLM calls.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agentic-ai-system/02-RESEARCH.md
@.planning/phases/02-agentic-ai-system/02-01-SUMMARY.md

# Phase 1 and Plan 01 artifacts
@src/core/config.py
@src/core/database.py
@src/core/language.py
@src/core/conversation.py
@src/models/ticket.py
@src/schemas/ticket.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CrewAI Flow architecture, state model, and message routing</name>
  <files>
    src/agents/__init__.py
    src/agents/flows/__init__.py
    src/agents/flows/state.py
    src/agents/flows/intake_flow.py
    src/agents/prompts/__init__.py
    src/agents/prompts/municipal.py
    tests/test_intake_flow.py
  </files>
  <action>
1. Create package structure:
   - `src/agents/__init__.py` (empty)
   - `src/agents/flows/__init__.py` (export IntakeFlow, IntakeState)
   - `src/agents/prompts/__init__.py` (empty)

2. Create `src/agents/flows/state.py`:
   - Define `IntakeState(BaseModel)`:
     - message_id: str (unique message identifier)
     - user_id: str
     - tenant_id: str
     - session_id: str
     - language: str = "en"
     - message: str (current user message)
     - category: str | None = None ("municipal" or "gbv")
     - subcategory: str | None = None (water, roads, electricity, waste, sanitation for municipal)
     - ticket_data: dict | None = None (completed ticket info)
     - ticket_id: str | None = None (after ticket creation)
     - routing_confidence: float = 0.0
     - turn_count: int = 0
     - is_complete: bool = False
     - error: str | None = None

3. Create `src/agents/prompts/municipal.py`:
   - Define CATEGORY_CLASSIFICATION_PROMPT: A system prompt that classifies messages into categories.
     Must handle EN/ZU/AF. Include examples:
     - "Water pipe burst" -> municipal/water
     - "Pothole on road" -> municipal/roads
     - "Streetlight broken" -> municipal/electricity
     - "Trash not collected" -> municipal/waste
     - "Sewage overflow" -> municipal/sanitation
     - "My husband hits me" -> gbv
     - "Domestic violence" -> gbv
     Include ZU examples: "Amanzi ayaphuma" -> municipal/water, "Umyeni wami uyangihlukumeza" -> gbv
     Include AF examples: "Water lek" -> municipal/water, "Huishoudelike geweld" -> gbv
     Response format: JSON {"category": "municipal|gbv", "subcategory": "water|roads|...|null", "confidence": 0.0-1.0}

   - Define MUNICIPAL_INTAKE_PROMPTS dict keyed by language ("en", "zu", "af"):
     Each prompt instructs the agent to:
     - Greet the citizen in their language
     - Ask clarifying questions to gather: exact location (address/landmarks), category confirmation, detailed description, severity assessment
     - Be empathetic and concise
     - Include 2-3 few-shot conversation examples in the target language
     - Specify required output fields matching TicketData schema
     - Include the isiZulu and Afrikaans prompts from research (Pattern 3)

4. Create `src/agents/flows/intake_flow.py`:
   - Import CrewAI Flow and task decorators (from crewai.flow.flow import Flow, start, listen, router)
   - Import language_detector from src.core.language
   - Import ConversationManager from src.core.conversation
   - Import IntakeState from src.agents.flows.state

   - Class `IntakeFlow(Flow[IntakeState])`:
     - Constructor takes: redis_url (str), llm_model (str, default "gpt-4o")
     - Initialize ConversationManager with redis_url

     - `@start()` method `receive_message(self)`:
       - Detect language using language_detector.detect(self.state.message, fallback="en")
       - Store detected language in self.state.language
       - Increment turn_count
       - Return language

     - `@listen(receive_message)` method `classify_message(self)`:
       - Use LLM (via crewai's LLM wrapper or direct API call) with CATEGORY_CLASSIFICATION_PROMPT
       - Parse JSON response to get category, subcategory, confidence
       - Store in self.state.category, self.state.subcategory, self.state.routing_confidence
       - If confidence < 0.6, set category to "municipal" (safe default)
       - Return category

     - `@router(classify_message)` method `route_to_crew(self)`:
       - If self.state.category == "gbv": return "gbv_intake"
       - Else: return "municipal_intake"

     - `@listen("municipal_intake")` method `handle_municipal(self)`:
       - Import and run MunicipalCrew (from plan 02-02 task 2)
       - Pass state with language, message, conversation history
       - Store result in self.state.ticket_data
       - Set self.state.is_complete = True

     - `@listen("gbv_intake")` method `handle_gbv(self)`:
       - Placeholder: set self.state.error = "GBV crew not yet implemented"
       - Will be implemented in Plan 02-03

   IMPORTANT: Use `from crewai.flow.flow import Flow, start, listen, router` (the correct import path per CrewAI docs). Do NOT use `from crewai import Flow, task` as shown in some research examples -- the actual API uses start/listen/router decorators, not @task.

5. Create `tests/test_intake_flow.py` (unit tests):
   - Mock the LLM calls (do NOT make real API calls in tests)
   - Mock language_detector to return deterministic values
   - Test that receive_message detects language correctly
   - Test that classify_message routes "water pipe burst" to municipal/water
   - Test that classify_message routes "domestic violence" to gbv
   - Test that route_to_crew returns "municipal_intake" for municipal category
   - Test that route_to_crew returns "gbv_intake" for gbv category
   - Test IntakeState serialization/deserialization
   - Use unittest.mock.patch for LLM and language detector mocking

Run `pytest tests/test_intake_flow.py -v` to verify.
  </action>
  <verify>
    `pytest tests/test_intake_flow.py -v` passes all tests.
    `python -c "from src.agents.flows.intake_flow import IntakeFlow; print('OK')"` imports without error.
    `python -c "from src.agents.flows.state import IntakeState; s = IntakeState(message_id='1', user_id='u1', tenant_id='t1', session_id='s1', message='test'); print(s.language)"` outputs "en".
  </verify>
  <done>
    IntakeFlow receives messages, detects language, classifies category via LLM, and routes to correct crew handler. State model tracks all conversation metadata. Trilingual prompts guide classification and intake. All tests pass with mocked LLM.
  </done>
</task>

<task type="auto">
  <name>Task 2: Municipal services crew with ticket creation tool</name>
  <files>
    src/agents/crews/__init__.py
    src/agents/crews/municipal_crew.py
    src/agents/tools/__init__.py
    src/agents/tools/ticket_tool.py
    src/agents/config/agents.yaml
    src/agents/config/tasks.yaml
    tests/test_municipal_crew.py
  </files>
  <action>
1. Create package structure:
   - `src/agents/crews/__init__.py` (export MunicipalCrew)
   - `src/agents/tools/__init__.py` (export create_ticket tool)
   - `src/agents/config/` directory (no __init__.py, YAML config files)

2. Create `src/agents/tools/ticket_tool.py`:
   - Import `from crewai.tools import tool`
   - Import Ticket model and TicketCategory enum from src.models.ticket
   - Import database session from src.core.database

   - Define `@tool` decorated function `create_municipal_ticket`:
     - Args: category (str), description (str), latitude (float|None), longitude (float|None), address (str|None), severity (str), user_id (str), tenant_id (str), language (str)
     - Validate category against TicketCategory values (raise ValueError if invalid)
     - Generate tracking_number: f"TKT-{date.today().strftime('%Y%m%d')}-{secrets.token_hex(3).upper()}"
     - Create Ticket instance with all fields
     - Use synchronous session (CrewAI tools run synchronously by default):
       Use `from sqlalchemy import create_engine` and `from sqlalchemy.orm import Session` for sync access
       Get sync DATABASE_URL by replacing postgresql+psycopg:// with postgresql+psycopg2:// or use a sync engine
     - IMPORTANT: Wrap in try/finally to always close session (research Pitfall 6)
     - Return dict: {"id": str(ticket.id), "tracking_number": ticket.tracking_number, "status": "open"}

   - Define helper `_get_sync_engine()` that creates a synchronous engine from settings.DATABASE_URL
     Cache it module-level to avoid creating new engines per call
     Note: For tests, this will be mocked entirely

3. Create `src/agents/config/agents.yaml`:
   ```yaml
   municipal_intake_agent:
     role: "Municipal Services Intake Specialist"
     goal: "Gather complete information for municipal service requests in {language}"
     backstory: >
       You are a helpful municipal services agent for South African municipalities.
       You guide citizens through reporting issues by asking clarifying questions.
       You must collect: exact location, service category, detailed description, and severity.
       Always respond in {language}. Be empathetic, concise, and professional.
     allow_delegation: false
     max_iter: 10
     verbose: false
   ```

4. Create `src/agents/config/tasks.yaml`:
   ```yaml
   municipal_intake_task:
     description: >
       Conduct intake for a municipal service report from a citizen.
       The citizen's message: {message}
       Language: {language}
       Municipality: {tenant_id}

       Gather the following information through conversation:
       1. Service category (water, roads, electricity, waste, sanitation)
       2. Exact location (address or landmarks)
       3. Detailed description of the issue
       4. Severity assessment (low, medium, high, critical)

       If the citizen has provided enough information, create the ticket.
       If information is missing, ask clarifying questions.
     expected_output: >
       A complete municipal service ticket with all required fields filled in.
       Return the ticket tracking number to the citizen.
   ```

5. Create `src/agents/crews/municipal_crew.py`:
   - Import Agent, Crew, Task, Process from crewai
   - Import MUNICIPAL_INTAKE_PROMPTS from src.agents.prompts.municipal
   - Import create_municipal_ticket from src.agents.tools.ticket_tool
   - Import TicketData from src.schemas.ticket
   - Load agent config from agents.yaml using yaml.safe_load
   - Load task config from tasks.yaml using yaml.safe_load

   - Class `MunicipalCrew`:
     - `__init__(self, language: str = "en", llm_model: str = "gpt-4o")`:
       - Store language, llm_model
       - Load YAML configs at init

     - Method `create_crew(self, message: str, user_id: str, tenant_id: str) -> Crew`:
       - Create Agent from YAML config, injecting {language} into role/goal/backstory
       - Override backstory with full language-specific prompt from MUNICIPAL_INTAKE_PROMPTS[self.language]
       - Set tools=[create_municipal_ticket]
       - Set llm=self.llm_model
       - Create Task from YAML config, injecting {message}, {language}, {tenant_id}
       - Set output_pydantic=TicketData on the task
       - Return Crew(agents=[agent], tasks=[task], process=Process.sequential, verbose=False)

     - Method `async kickoff(self, message: str, user_id: str, tenant_id: str) -> dict`:
       - Create crew via create_crew()
       - Run crew.kickoff(inputs={"message": message, "language": self.language, "tenant_id": tenant_id})
       - Extract result.pydantic (TicketData) if available
       - Return ticket_data as dict
       - Handle errors: catch exceptions, return {"error": str(e)}

6. Create `tests/test_municipal_crew.py` (unit tests):
   - Mock crewai Agent, Crew, Task classes to avoid real LLM calls
   - Test MunicipalCrew instantiation with different languages
   - Test create_crew returns a Crew object with correct agent configuration
   - Test that agent backstory uses the correct language prompt
   - Test that task has output_pydantic=TicketData
   - Test create_municipal_ticket tool validates category (mock database)
   - Test create_municipal_ticket rejects invalid category
   - Test tracking_number format: TKT-YYYYMMDD-XXXXXX

Run `pytest tests/test_municipal_crew.py -v` to verify.
  </action>
  <verify>
    `pytest tests/test_municipal_crew.py -v` passes all tests.
    `python -c "from src.agents.crews.municipal_crew import MunicipalCrew; print('OK')"` imports without error.
    `python -c "from src.agents.tools.ticket_tool import create_municipal_ticket; print(create_municipal_ticket.name)"` shows tool name.
    YAML config files exist and are valid: `python -c "import yaml; yaml.safe_load(open('src/agents/config/agents.yaml')); print('OK')"`
  </verify>
  <done>
    Municipal services crew conducts structured intake, collects all required ticket information via conversational agent, creates tickets through database tool, supports trilingual prompts (EN/ZU/AF). All tests pass with mocked LLM and database.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_intake_flow.py tests/test_municipal_crew.py -v` -- all tests pass
2. IntakeFlow correctly routes municipal messages to municipal handler
3. MunicipalCrew creates properly configured agents with language-specific prompts
4. Ticket creation tool validates input and generates proper tracking numbers
5. All Phase 1 tests still pass: `pytest tests/ -v -k "not intake_flow and not municipal_crew"`
</verification>

<success_criteria>
- IntakeFlow receives message, detects language, classifies category, routes to correct crew
- Municipal crew has agent with trilingual prompts that asks for location, category, description, severity
- Ticket creation tool validates category, generates tracking number, persists to database
- Agent output validated against TicketData Pydantic schema
- All unit tests pass with mocked LLM (no real API calls)
- All Phase 1 tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-agentic-ai-system/02-02-SUMMARY.md`
</output>
