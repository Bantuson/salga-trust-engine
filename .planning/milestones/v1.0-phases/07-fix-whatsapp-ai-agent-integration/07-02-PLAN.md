---
phase: 07-fix-whatsapp-ai-agent-integration
plan: 02
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - src/api/v1/crew_server.py
  - src/services/whatsapp_service.py
  - tests/test_messages_api.py
  - tests/test_whatsapp_service.py
autonomous: true
requirements:
  - RPT-07

must_haves:
  truths:
    - "GBV confirmation step exists before routing to SAPS — citizen must explicitly confirm"
    - "Citizen who confirms GBV gets routed to GBVCrew with SAPS notification"
    - "Citizen who declines GBV gets treated as regular municipal ticket"
    - "GBV confirmation message includes emergency numbers (10111, 0800 150 150)"
    - "Existing tests updated to match new ManagerCrew-based pipeline"
    - "New tests cover GBV confirmation accept/decline paths"
  artifacts:
    - path: "src/api/v1/crew_server.py"
      provides: "GBV confirmation state machine in crew_server chat()"
      contains: "gbv_pending_confirm"
    - path: "src/services/whatsapp_service.py"
      provides: "GBV confirmation state machine in WhatsApp service"
      contains: "gbv_pending_confirm"
    - path: "tests/test_messages_api.py"
      provides: "Updated unit tests for ManagerCrew-based messages pipeline"
      contains: "ManagerCrew"
    - path: "tests/test_whatsapp_service.py"
      provides: "Tests for GBV confirmation flow"
      contains: "gbv_pending_confirm"
  key_links:
    - from: "src/api/v1/crew_server.py"
      to: "ConversationState.routing_phase"
      via: "gbv_pending_confirm intermediate state"
      pattern: "gbv_pending_confirm"
    - from: "src/services/whatsapp_service.py"
      to: "ConversationState.routing_phase"
      via: "gbv_pending_confirm intermediate state"
      pattern: "gbv_pending_confirm"
---

<objective>
Add the GBV confirmation step before SAPS routing and update all affected test files to match the new ManagerCrew-based pipeline.

Purpose: RPT-07 requires GBV reports to route to SAPS, but the user decision mandates a confirmation step first — citizens must explicitly confirm before their report is forwarded to emergency services. Also, the tests from Plan 01's changes (MockIntakeFlow signature, removed method mocks) must be updated to avoid test suite regressions.

Output: GBV confirmation state machine in both crew_server.py and whatsapp_service.py, plus updated and new tests covering the full fixed pipeline.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-fix-whatsapp-ai-agent-integration/07-CONTEXT.md
@.planning/phases/07-fix-whatsapp-ai-agent-integration/07-RESEARCH.md
@.planning/phases/07-fix-whatsapp-ai-agent-integration/07-01-SUMMARY.md

Key reference files:
@src/api/v1/crew_server.py (add GBV confirmation state machine to chat() function)
@src/services/whatsapp_service.py (add GBV confirmation to process_incoming_message())
@src/agents/crews/manager_crew.py (ManagerCrew.kickoff() returns dict with routing_phase)
@tests/test_messages_api.py (update MockIntakeFlow to MockManagerCrew)
@tests/test_whatsapp_service.py (add GBV confirmation tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GBV confirmation state machine to crew_server.py and whatsapp_service.py</name>
  <files>src/api/v1/crew_server.py, src/services/whatsapp_service.py</files>
  <action>
Add the GBV confirmation two-turn state machine to both intake paths. The state machine uses `routing_phase = "gbv_pending_confirm"` as an intermediate state that is NOT in the specialist short-circuit map (so it falls through to the confirmation handler, not to GBVCrew directly).

**A. Add to `src/api/v1/crew_server.py` — in the chat() function after Step 3 routing:**

1. **Define the confirmation message constant** at module level (near the _FALLBACK_REPLIES dict):
   ```python
   GBV_CONFIRMATION_MESSAGES = {
       "en": (
           "I hear you, and your safety is the most important thing right now. "
           "I'd like to create a confidential report and alert emergency services on your behalf. "
           "Can I go ahead and do that?\n\n"
           "Reply YES to confirm, or NO if you'd prefer not to.\n\n"
           "Emergency: SAPS 10111 | GBV Command Centre: 0800 150 150"
       ),
       "zu": (
           "Ngiyakuzwa, futhi ukuphepha kwakho kubaluleke kakhulu manje. "
           "Ngingathanda ukwenza umbiko oyimfihlo futhi ngixwayise izinsizakalo zezimo eziphuthumayo. "
           "Ngingaqhubeka ngikwenzele lokho?\n\n"
           "Phendula YEBO ukuqinisekisa, noma CHA uma ungathandi.\n\n"
           "Isimo esiphuthumayo: SAPS 10111 | GBV Command Centre: 0800 150 150"
       ),
       "af": (
           "Ek hoor jou, en jou veiligheid is die belangrikste ding nou. "
           "Ek wil 'n vertroulike verslag skep en nooddienste namens jou waarsku. "
           "Kan ek daarmee voortgaan?\n\n"
           "Antwoord JA om te bevestig, of NEE as jy verkies om nie.\n\n"
           "Noodgeval: SAPS 10111 | GBV Command Centre: 0800 150 150"
       ),
   }
   ```

2. **Add GBV confirmation handling** in the Step 3 routing section of `chat()`. Insert this BEFORE the existing specialist short-circuit block (before `if routing_phase != "manager":`):

   ```python
   # --- GBV CONFIRMATION GATE ---
   # If routing_phase is "gbv_pending_confirm", the citizen needs to confirm
   # before we route to GBVCrew. This is a two-turn safety gate.
   if routing_phase == "gbv_pending_confirm":
       lower_msg = request.message.strip().lower()
       positive = any(w in lower_msg for w in ["yes", "yebo", "ja", "confirm", "okay", "ok"])
       negative = any(w in lower_msg for w in ["no", "cha", "nee", "cancel", "stop"])

       if positive:
           # Confirmed — route to GBV crew
           conv_state.routing_phase = "gbv"
           if hasattr(manager, 'save_state'):
               try:
                   await manager.save_state(conv_state, is_gbv=True)
               except Exception:
                   pass
           # Fall through to the specialist short-circuit below (routing_phase is now "gbv")
           routing_phase = "gbv"
       elif negative:
           # Declined — treat as regular municipal ticket
           conv_state.routing_phase = "municipal"
           if hasattr(manager, 'save_state'):
               try:
                   await manager.save_state(conv_state, is_gbv=False)
               except Exception:
                   pass
           reply = "Understood. If you'd like to report a service issue, I'm here to help. What can I assist you with?"
           agent_name = "manager"
           agent_result = {"message": reply, "routing_phase": "municipal", "agent": "manager"}
           # Skip crew routing entirely — go straight to Step 3.25
           routing_phase = "_handled"
       else:
           # Ambiguous — resend confirmation
           lang = detected_language if detected_language in ("en", "zu", "af") else "en"
           reply = GBV_CONFIRMATION_MESSAGES[lang]
           agent_name = "manager"
           agent_result = {"message": reply, "routing_phase": "gbv_pending_confirm", "agent": "manager"}
           routing_phase = "_handled"
   ```

3. **After ManagerCrew routing** (in the section that persists routing_phase), add the GBV confirmation interception:
   After `new_routing_phase = agent_result.get("routing_phase", "manager")`, add:
   ```python
   # If ManagerCrew classified as GBV, intercept with confirmation gate
   if new_routing_phase == "gbv" and routing_phase == "manager":
       # First GBV signal — enter confirmation state (don't route to GBVCrew yet)
       new_routing_phase = "gbv_pending_confirm"
       lang = detected_language if detected_language in ("en", "zu", "af") else "en"
       reply = GBV_CONFIRMATION_MESSAGES[lang]
       agent_name = "manager"
       agent_result = {"message": reply, "routing_phase": "gbv_pending_confirm", "agent": "manager"}
   ```
   Then `conv_state.routing_phase = new_routing_phase` persists the pending state.

4. **Guard the specialist short-circuit and manager path** with a check for `routing_phase != "_handled"` so the confirmation response path doesn't accidentally re-route.

**B. Add to `src/services/whatsapp_service.py` — in process_incoming_message():**

Add the same GBV confirmation pattern after the ManagerCrew kickoff call (added in Plan 01). The WhatsApp service gets conversation state from ConversationManager and can check/set `routing_phase` on the state object.

1. Import the GBV confirmation messages: `from src.api.v1.crew_server import GBV_CONFIRMATION_MESSAGES`

2. After `agent_result = await manager_crew.kickoff(...)`, check if the result indicates GBV:
   ```python
   routing_phase = agent_result.get("routing_phase", "other")

   # GBV confirmation gate — intercept before SAPS routing
   if routing_phase == "gbv":
       # Check if this is the first GBV signal (not a confirmed re-entry)
       current_routing = getattr(conversation_state, 'routing_phase', 'manager')
       if current_routing != "gbv":
           # Enter confirmation state
           conversation_state.routing_phase = "gbv_pending_confirm"
           lang = conversation_state.language if conversation_state.language in ("en", "zu", "af") else "en"
           agent_response = GBV_CONFIRMATION_MESSAGES[lang]
           # Save state and return early
           await conversation_manager.append_turn(...)
           return {"response": agent_response, "tracking_number": None, "is_complete": False}
   ```

3. At the START of process_incoming_message (after getting conversation_state), check if `routing_phase == "gbv_pending_confirm"`:
   ```python
   current_routing = getattr(conversation_state, 'routing_phase', None)
   if current_routing == "gbv_pending_confirm":
       # Handle confirmation/decline
       lower_msg = (message_body or "").strip().lower()
       positive = any(w in lower_msg for w in ["yes", "yebo", "ja", "confirm", "okay", "ok"])
       negative = any(w in lower_msg for w in ["no", "cha", "nee", "cancel", "stop"])

       if positive:
           conversation_state.routing_phase = "gbv"
           # Continue to ManagerCrew kickoff — it will short-circuit to GBVCrew
       elif negative:
           conversation_state.routing_phase = "municipal"
           return {"response": "Understood. If you'd like to report a service issue, I'm here to help.", "tracking_number": None, "is_complete": False}
       else:
           # Ambiguous — resend confirmation
           lang = conversation_state.language if conversation_state.language in ("en", "zu", "af") else "en"
           return {"response": GBV_CONFIRMATION_MESSAGES[lang], "tracking_number": None, "is_complete": False}
   ```

Note: The exact implementation depends on how Plan 01 restructured whatsapp_service.py. Adapt the confirmation gate to work with the ManagerCrew-based flow from Plan 01.
  </action>
  <verify>
Run: `grep -c "gbv_pending_confirm" src/api/v1/crew_server.py` — returns >= 3 (state check, state set, state compare).
Run: `grep -c "gbv_pending_confirm" src/services/whatsapp_service.py` — returns >= 2.
Run: `grep -c "GBV_CONFIRMATION_MESSAGES" src/api/v1/crew_server.py` — returns >= 1.
Run: `grep -c "10111" src/api/v1/crew_server.py` — returns >= 1 (in confirmation messages).
Run: `python -c "from src.api.v1.crew_server import chat, GBV_CONFIRMATION_MESSAGES; print('crew_server imports OK')"` — no ImportError.
  </verify>
  <done>GBV confirmation state machine exists in both crew_server.py and whatsapp_service.py. State "gbv_pending_confirm" intercepts first GBV classification. Citizen YES routes to GBVCrew + SAPS. Citizen NO treats as municipal. Ambiguous re-sends confirmation. All confirmation messages include emergency numbers (10111, 0800 150 150) in all 3 languages.</done>
</task>

<task type="auto">
  <name>Task 2: Update test files for ManagerCrew-based pipeline</name>
  <files>tests/test_messages_api.py, tests/test_whatsapp_service.py</files>
  <action>
Update existing test mocks and add new tests for the GBV confirmation flow. The old MockIntakeFlow with `llm_model: str` parameter is now invalid since messages.py uses ManagerCrew directly.

**A. Update `tests/test_messages_api.py`:**

1. **Remove MockIntakeFlow class entirely** (lines 39-62) — it mocked IntakeFlow which is no longer used.

2. **Replace with MockManagerCrew:**
   ```python
   class MockManagerCrew:
       """Mock ManagerCrew for testing messages API."""

       def __init__(self, language: str = "en", llm=None):
           self.language = language

       async def kickoff(self, context: dict) -> dict:
           """Mock kickoff returns a result dict matching ManagerCrew output."""
           message = context.get("message", "")
           message_lower = message.lower()

           if "abuse" in message_lower or "violence" in message_lower:
               return {
                   "message": "I hear you. Are you in a safe place right now?",
                   "routing_phase": "gbv",
                   "agent": "gbv_intake",
                   "raw_output": "mock raw output",
               }
           else:
               return {
                   "message": "Your report has been received. Tracking number: TKT-20260221-ABC123",
                   "routing_phase": "municipal",
                   "agent": "municipal_intake",
                   "tracking_number": "TKT-20260221-ABC123",
                   "raw_output": "mock raw output",
               }
   ```

3. **Update the `mock_intake_flow` fixture** to mock ManagerCrew instead:
   ```python
   @pytest.fixture
   def mock_manager_crew():
       """Mock ManagerCrew."""
       with patch("src.api.v1.messages.ManagerCrew", MockManagerCrew):
           yield
   ```

4. **Update all test methods** that use `mock_intake_flow` fixture to use `mock_manager_crew` instead. Update assertions:
   - `test_send_message_valid`: assert `response.category == "municipal"` (from routing_phase)
   - `test_send_message_detects_gbv`: assert `response.category == "gbv"` (from routing_phase)
   - Other tests: update fixture references

5. **Also mock `sanitize_reply`** import in messages.py — either patch it or let it pass through (it's a pure function that won't crash with mock data):
   ```python
   with patch("src.api.v1.messages.sanitize_reply", side_effect=lambda text, **kw: text):
       ...
   ```

**B. Update `tests/test_whatsapp_service.py`:**

Read the existing file first to understand what needs updating. Then:

1. **Replace any IntakeFlow mocking** with ManagerCrew mocking (same pattern as test_messages_api.py).

2. **Add GBV confirmation tests:**
   ```python
   class TestGBVConfirmation:
       """Tests for GBV confirmation state machine in WhatsApp service."""

       async def test_gbv_first_signal_enters_confirmation(self, ...):
           """First GBV classification enters gbv_pending_confirm state."""
           # Mock ManagerCrew to return routing_phase="gbv"
           # Assert response contains confirmation message with emergency numbers
           # Assert conversation_state.routing_phase == "gbv_pending_confirm"

       async def test_gbv_confirmed_routes_to_saps(self, ...):
           """Citizen confirming GBV routes through GBVCrew."""
           # Set up conversation_state.routing_phase = "gbv_pending_confirm"
           # Send message "yes"
           # Assert GBVCrew is called (or routing_phase changes to "gbv")

       async def test_gbv_declined_routes_to_municipal(self, ...):
           """Citizen declining GBV gets treated as municipal."""
           # Set up routing_phase = "gbv_pending_confirm"
           # Send message "no"
           # Assert routing_phase changes to "municipal"
           # Assert response acknowledges and offers help

       async def test_gbv_ambiguous_resends_confirmation(self, ...):
           """Ambiguous reply resends GBV confirmation message."""
           # Set up routing_phase = "gbv_pending_confirm"
           # Send message "maybe"
           # Assert confirmation message resent with emergency numbers

       async def test_gbv_confirmation_includes_emergency_numbers(self, ...):
           """GBV confirmation message always includes 10111 and 0800 150 150."""
           # Check all 3 language variants contain both numbers
   ```

3. **Verify emergency number presence** in confirmation messages:
   ```python
   def test_gbv_confirmation_messages_have_emergency_numbers():
       """All GBV confirmation messages include SAPS and GBV helpline numbers."""
       from src.api.v1.crew_server import GBV_CONFIRMATION_MESSAGES
       for lang, msg in GBV_CONFIRMATION_MESSAGES.items():
           assert "10111" in msg, f"SAPS number missing in {lang} confirmation"
           assert "0800 150 150" in msg, f"GBV helpline missing in {lang} confirmation"
   ```

Run `pytest tests/test_messages_api.py tests/test_whatsapp_service.py -x -q` after all changes to verify tests pass.
  </action>
  <verify>
Run: `pytest tests/test_messages_api.py -x -q --no-header` — all tests pass.
Run: `pytest tests/test_whatsapp_service.py -x -q --no-header` — all tests pass (or skip if marked integration).
Run: `grep -c "MockManagerCrew\|ManagerCrew" tests/test_messages_api.py` — returns >= 2.
Run: `grep -c "gbv_pending_confirm" tests/test_whatsapp_service.py` — returns >= 1.
Run: `grep -c "IntakeFlow\|MockIntakeFlow" tests/test_messages_api.py` — returns 0.
  </verify>
  <done>test_messages_api.py uses MockManagerCrew (not MockIntakeFlow), all existing tests pass with updated mocks. test_whatsapp_service.py has GBV confirmation tests covering: first signal enters pending state, YES confirms and routes to GBVCrew/SAPS, NO declines and routes to municipal, ambiguous resends confirmation. Emergency numbers (10111, 0800 150 150) verified in all confirmation message variants.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `pytest tests/test_messages_api.py tests/test_whatsapp_service.py -x -q` — all tests pass
2. `grep -rn "gbv_pending_confirm" src/` — found in crew_server.py and whatsapp_service.py
3. `grep -rn "10111" src/api/v1/crew_server.py` — found in GBV_CONFIRMATION_MESSAGES
4. `grep -rn "IntakeFlow\|MockIntakeFlow" tests/test_messages_api.py` — 0 matches
5. GBV confirmation flow: first GBV signal -> pending_confirm -> citizen YES -> GBVCrew (SAPS notified) OR citizen NO -> municipal routing
6. All confirmation messages include both emergency numbers in all 3 languages
</verification>

<success_criteria>
- GBV confirmation state machine works in both crew_server.py and whatsapp_service.py
- "gbv_pending_confirm" intermediate state prevents immediate SAPS routing
- Citizen can confirm (yes/yebo/ja) to proceed to GBVCrew + SAPS notification
- Citizen can decline (no/cha/nee) to be treated as municipal report
- Ambiguous responses resend the confirmation message
- All confirmation messages include SAPS 10111 and GBV Helpline 0800 150 150
- test_messages_api.py passes with ManagerCrew mocks (no IntakeFlow references)
- test_whatsapp_service.py has new GBV confirmation tests
- No test regressions from Plan 01 changes
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-whatsapp-ai-agent-integration/07-02-SUMMARY.md`
</output>
