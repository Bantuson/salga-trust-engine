---
phase: 06.8-gugu-persona-email-otp-fix
plan: "04"
subsystem: auth
tags: [crewai, auth-agent, gugu-persona, language-detection, conversation-state, prompts]

requires:
  - phase: 06.8-01
    provides: Gugu persona added to EN/ZU/AF auth prompts (base identity)
  - phase: 06.8-03
    provides: sanitize_reply() utility and warm Gugu fallbacks in crew_server

provides:
  - CRITICAL IDENTITY anchor sections in all 3 auth prompts prevent Gugu name confusion
  - GREETING FIRST block in _NEW_USER_INSTRUCTION ensures warm intro on bare greetings
  - LANGUAGE RULES sections in all 3 prompts instruct language preference asking and locking
  - _detect_language_preference() function in crew_server for explicit language choice detection
  - Language preference persistence across turns via system turns (lang_pref: prefix)
  - language_preference field in debug output for full resolution chain visibility
affects: [auth, crew_server, conversation_state, streamlit_dashboard]

tech-stack:
  added: []
  patterns:
    - CRITICAL IDENTITY anchor at prompt top as LLM identity guard
    - Language preference stored as system turn (lang_pref: prefix) for cross-turn persistence
    - Priority chain for language resolution: explicit > stored > auto-detected > hint

key-files:
  created: []
  modified:
    - src/agents/prompts/auth.py
    - src/api/v1/crew_server.py

key-decisions:
  - "CRITICAL IDENTITY sections placed at the VERY TOP of each prompt as first-priority LLM instruction — identity anchor must precede all other content"
  - "GREETING FIRST block inserted between RESUME CHECK and STEP 1 — preserves step numbering while adding warm greeting gate for bare messages"
  - "Language preference stored as system role turn with lang_pref: prefix — zero schema changes, uses existing ConversationState turn storage"
  - "Priority chain: explicit preference in current message > stored preference from history > auto-detected > request hint — covers all cases without breaking existing auto-detection"

requirements-completed:
  - AI-05
  - AI-06
  - AI-07

duration: 6.7min
completed: 2026-02-17
---

# Phase 06.8 Plan 04: Gugu Identity Hardening and Language Lock Summary

**Hardened auth agent identity with CRITICAL IDENTITY anchor sections, greeting-first gate for bare messages, and cross-turn language preference persistence using system turns in conversation state**

## Performance

- **Duration:** 6.7 min (400s)
- **Started:** 2026-02-17T18:36:21Z
- **Completed:** 2026-02-17T18:43:02Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added CRITICAL IDENTITY anchor sections at the top of all 3 auth prompts (EN/ZU/AF) — LLM is now explicitly instructed that its name is Gugu and it must never assume the citizen's name is Gugu
- Added GREETING FIRST block to _NEW_USER_INSTRUCTION that gates bare greetings (hi/hello/sawubona/hallo) behind a warm intro + name ask + language preference ask before jumping to registration
- Added LANGUAGE RULES sections in all 3 language prompts instructing the agent to ask for language preference upfront and lock to the chosen language for the entire conversation
- Added _detect_language_preference() function with EN/ZU/AF keyword pattern matching for explicit language choices
- Added language preference persistence as system turns (lang_pref: prefix) in conversation state with cross-turn lookup — priority chain: explicit > stored > auto-detected

## Task Commits

Each task was committed atomically:

1. **Task 1: Harden auth prompts — identity reinforcement, greeting-first flow, language lock** - `7554003` (feat)
2. **Task 2: Add language preference persistence to crew_server.py conversation state** - `03146d9` (feat)

**Plan metadata:** committed with docs commit (see final commit)

## Files Created/Modified

- `src/agents/prompts/auth.py` — Added CRITICAL IDENTITY sections (EN/ZU/AF), GREETING FIRST block in _NEW_USER_INSTRUCTION, LANGUAGE RULES sections (LANGUAGE RULES/IMITHETHO YOLIMI/TAALREELS) in all 3 prompts
- `src/api/v1/crew_server.py` — Added _LANGUAGE_PREFERENCE_PATTERNS dict, _detect_language_preference() function, Step 1.6 in chat() endpoint, stored_pref lookup, explicit_pref storage as system turns, language_preference in debug dict

## Decisions Made

- CRITICAL IDENTITY sections placed at the VERY TOP of each prompt as first-priority LLM instruction — identity anchor must precede all other content to override any LLM tendency to mirror input
- GREETING FIRST block inserted between RESUME CHECK and STEP 1 in _NEW_USER_INSTRUCTION — preserves existing step numbering (STEP 1-5 unchanged) while adding warm greeting gate
- Language preference stored as system role turn with lang_pref: prefix — zero schema changes, uses existing ConversationState turn storage without any new fields or migrations
- Priority chain (explicit > stored > auto-detected > hint) covers all cases: new citizen choosing language, returning citizen with stored pref, non-English first message, and English fallback

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

The overall verification script searched for the string "STEP 1" in _NEW_USER_INSTRUCTION to check that GREETING FIRST precedes it — but the RESUME CHECK bullet (which says "start at STEP 1") appears before the GREETING FIRST block, causing a false failure. The actual `STEP 1 — Ask:` instruction heading correctly follows GREETING FIRST (position 789 vs 1562). The implementation is correct; the verification script needed to search for `STEP 1 — Ask:` specifically. This was a test script issue, not an implementation issue.

## Self-Check: PASSED

- FOUND: src/agents/prompts/auth.py
- FOUND: src/api/v1/crew_server.py
- FOUND: .planning/phases/06.8-gugu-persona-email-otp-fix/06.8-04-SUMMARY.md
- FOUND: commit 7554003 (feat: harden auth prompts)
- FOUND: commit 03146d9 (feat: language preference persistence)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Auth agent identity is now hardened against Gugu name confusion
- Bare greetings will produce warm intro + name ask + language preference ask
- Language preferences persist across turns via conversation state
- Ready for Phase 06.8 Plan 05 (email OTP fix: magic links to 6-digit codes)
- All existing auth flow functionality preserved (registration paths, OTP, proof of residence)

---
*Phase: 06.8-gugu-persona-email-otp-fix*
*Completed: 2026-02-17*
