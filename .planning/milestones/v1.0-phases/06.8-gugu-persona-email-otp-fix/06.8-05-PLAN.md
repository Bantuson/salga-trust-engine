---
phase: 06.8-gugu-persona-email-otp-fix
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/email/otp-verification.html
autonomous: false
requirements:
  - AI-07
gap_closure: true

must_haves:
  truths:
    - "A branded HTML email template exists that displays {{ .Token }} as a large, styled 6-digit code — NOT as a clickable link"
    - "Template uses SALGA Trust Engine branding with pink/rose (#cd5e81) colors matching the platform theme"
    - "Template includes clear instructions: 'Enter this code in the app' and '60-minute expiry' note"
    - "Template includes safety footer for GBV context: 'If you did not request this code, please ignore this email'"
    - "Template is a standalone HTML file the user can copy-paste into Supabase Dashboard email template editor"
  artifacts:
    - path: "templates/email/otp-verification.html"
      provides: "Branded Supabase email OTP template with 6-digit code display"
      contains: ".Token"
  key_links:
    - from: "templates/email/otp-verification.html"
      to: "Supabase Dashboard -> Authentication -> Email Templates"
      via: "Manual copy-paste by user into Supabase Dashboard"
      pattern: "Token"

user_setup:
  - service: supabase-dashboard
    why: "Email OTP template must be pasted into Supabase Dashboard — cannot be automated via API"
    dashboard_config:
      - task: "Replace email OTP template with branded SALGA version"
        location: "Supabase Dashboard -> Authentication -> Email Templates -> Magic Link"
        action: "Copy the contents of templates/email/otp-verification.html and paste into the email body field. Save."
---

<objective>
Create a branded HTML email template for Supabase OTP verification that displays the 6-digit code as prominent styled text (not a clickable link). The current template wraps {{ .Token }} in an anchor tag, making it a magic link URL instead of a readable verification code.

Purpose: Unblocks the entire auth registration flow. Citizens cannot verify their email because the OTP arrives as a clickable link that doesn't work as a verification code in the app. This template fix (combined with the user pasting it into Supabase Dashboard) resolves the blocker.

Output: A branded HTML email template file at templates/email/otp-verification.html ready for copy-paste into Supabase Dashboard.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@shared/design-tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create branded HTML email OTP template</name>
  <files>
    templates/email/otp-verification.html
  </files>
  <action>
Create directory `templates/email/` at project root and write `otp-verification.html`.

The template must be a COMPLETE, self-contained HTML email with inline CSS (email clients ignore external stylesheets). Use the SALGA Trust Engine design language:

**Design specs (from shared/design-tokens.css):**
- Primary rose: #cd5e81
- Gold accent: #ffd54f
- Light rose for backgrounds: #f8e8ee
- Dark text: #2d2d2d
- Body background: #f4f4f4 (light gray)
- Card background: #ffffff (white)
- Font: Arial, Helvetica, sans-serif (email-safe, no custom fonts)

**Template structure:**
1. **Header strip** — rose (#cd5e81) background, white text, "SALGA Trust Engine" in bold
2. **Main card** — white background, centered, max-width 520px, rounded corners, subtle shadow
3. **Greeting** — "Your Verification Code" heading
4. **Code display** — {{ .Token }} in a large (36-40px), bold, letter-spaced box with rose border and light rose background. This is the CRITICAL element — it MUST be plain text, NOT wrapped in an `<a>` tag
5. **Instructions** — "Enter this 6-digit code in the SALGA Trust Engine app to verify your identity."
6. **Expiry notice** — "This code expires in 60 minutes."
7. **Safety footer** — "If you did not request this code, please ignore this email. Your account is safe."
8. **Platform footer** — "SALGA Trust Engine | South Africa's Municipal Services Platform" in small text, rose color

**HTML email constraints:**
- ALL CSS must be inline (style="" attributes) — no `<style>` blocks in `<head>` (many email clients strip them)
- Use `<table>` layout (not flexbox/grid — email clients don't support them)
- Use `bgcolor` attributes alongside background-color for Outlook compatibility
- Include both `style` and HTML attributes for widths (width="" and style="width:")
- `<img>` tags not needed — text-only template for reliability
- Use `&nbsp;` for spacing if needed
- Set explicit font-family on every text element (email inheritance is unreliable)

**Supabase template variables:**
- `{{ .Token }}` — the 6-digit OTP code (this is the ONLY variable needed)
- Do NOT use `{{ .ConfirmationURL }}` — that creates the magic link problem we're fixing
- Do NOT use `{{ .SiteURL }}` — not needed for OTP code display

Write the template as a complete HTML document (with `<!DOCTYPE html>`, `<html>`, `<head>`, `<body>`) so it can be previewed in a browser for verification, and also copy-pasted into Supabase's email template editor (which accepts HTML body content).
  </action>
  <verify>
Verify the file exists and contains the required elements:
```
python -c "
import pathlib
f = pathlib.Path('templates/email/otp-verification.html')
assert f.exists(), 'Template file not found'
content = f.read_text()

# Must contain the token variable (plain text, not as a link)
assert '{{ .Token }}' in content, 'Missing {{ .Token }} variable'
assert '<a' not in content.split('{{ .Token }}')[0].split('{{ .Token }}')[-1] if '{{ .Token }}' in content else True, 'Token may be inside an anchor tag'

# Must NOT contain magic link URL variable
assert '{{ .ConfirmationURL }}' not in content, 'Contains ConfirmationURL — this creates magic links!'

# Must contain branding
assert '#cd5e81' in content, 'Missing rose brand color'
assert 'SALGA Trust Engine' in content, 'Missing platform name'

# Must contain instructions
assert '60 minute' in content.lower() or '60-minute' in content.lower(), 'Missing expiry notice'
assert 'did not request' in content.lower(), 'Missing safety footer'

# Must be inline CSS (no <style> blocks)
# Allow for a basic reset in <head> but main styles should be inline
style_block_count = content.lower().count('<style')
assert style_block_count <= 1, f'Too many <style> blocks ({style_block_count}) — email clients may strip them'

print('Template validation: OK')
print(f'File size: {len(content)} bytes')
"
```

Open the file in a browser to visually inspect:
```
echo "Template created at templates/email/otp-verification.html — open in browser to preview"
```
  </verify>
  <done>
A branded HTML email template exists at templates/email/otp-verification.html with: SALGA Trust Engine header in rose (#cd5e81), large styled {{ .Token }} code display (NOT a link), clear instructions, 60-minute expiry notice, safety footer, and platform footer. All CSS is inline for email client compatibility. No {{ .ConfirmationURL }} magic link variable present.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Paste email template into Supabase Dashboard</name>
  <action>
The branded email template has been created at `templates/email/otp-verification.html`. This template must be manually pasted into the Supabase Dashboard because the email template API is not available via CLI.

**Steps:**

1. Open `templates/email/otp-verification.html` in a text editor
2. Select ALL the HTML content (Ctrl+A)
3. Copy it (Ctrl+C)
4. Open the Supabase Dashboard for the project
5. Navigate to: **Authentication -> Email Templates -> Magic Link**
6. Clear the existing template body
7. Paste the new HTML content (Ctrl+V)
8. Save the template
9. Test by triggering an email OTP (sign_in_with_otp for an email address)
10. Check the received email — it should show a styled 6-digit code, NOT a clickable link
  </action>
  <how-to-verify>
1. Trigger an email OTP send (via Streamlit dashboard or directly via Supabase client)
2. Check the received email:
   - Has SALGA Trust Engine header in pink/rose
   - Shows a large 6-digit code (not a URL/link)
   - Has "Enter this code" instructions
   - Has "60 minutes" expiry note
   - Has "If you did not request" safety footer
3. Confirm the code can be entered in the app to complete verification
  </how-to-verify>
  <resume-signal>Type "email template applied" if successful, or describe any issues with the template rendering</resume-signal>
</task>

</tasks>

<verification>
1. templates/email/otp-verification.html exists with branded SALGA design
2. Template uses {{ .Token }} as plain text display, NOT as a link
3. Template does NOT contain {{ .ConfirmationURL }}
4. Template has inline CSS (email-safe)
5. Template pasted into Supabase Dashboard and tested
6. Email OTP sends a styled 6-digit code, not a magic link
</verification>

<success_criteria>
- Branded email template file exists at templates/email/otp-verification.html
- Template displays {{ .Token }} as a large, styled 6-digit code in a rose-bordered box
- User has pasted template into Supabase Dashboard
- Test email OTP shows the branded template with readable code (not a clickable link)
- Auth registration flow is unblocked — citizens can receive and enter their verification code
</success_criteria>

<output>
After completion, create `.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-05-SUMMARY.md`
</output>
