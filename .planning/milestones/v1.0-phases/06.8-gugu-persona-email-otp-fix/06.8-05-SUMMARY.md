---
phase: 06.8-gugu-persona-email-otp-fix
plan: 05
subsystem: auth
tags: [supabase, email, otp, html-email, branding]

# Dependency graph
requires:
  - phase: 06.8-01
    provides: Gugu persona established for auth, municipal, GBV agents
  - phase: 06.8-03
    provides: sanitize_reply() utility and crew output cleanup

provides:
  - Branded HTML email OTP template at templates/email/otp-verification.html
  - Supabase-ready email template displaying {{ .Token }} as large plain-text 6-digit code
  - Eliminates magic link problem — token shown as styled text, not clickable URL

affects: [supabase-auth, email-otp, citizen-registration, streamlit-dashboard]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "HTML email with inline CSS only (no <style> blocks) for maximum email client compatibility"
    - "Table-based layout with bgcolor attributes for Outlook compatibility"
    - "Supabase {{ .Token }} variable as plain text, never in anchor tags"

key-files:
  created:
    - templates/email/otp-verification.html
  modified: []

key-decisions:
  - "Use {{ .Token }} only (not {{ .ConfirmationURL }}) — eliminates magic link, shows 6-digit code"
  - "All CSS inline (no <style> blocks) — email clients (Gmail, Outlook) strip head styles"
  - "Table-based layout with bgcolor attrs alongside background-color — Outlook does not support CSS backgrounds"
  - "Monospace font (Courier New) for the code digit display — maximum readability and digit spacing"
  - "Template deployed via manual copy-paste into Supabase Dashboard (no API available for email templates)"

patterns-established:
  - "Supabase email OTP templates: use {{ .Token }}, never {{ .ConfirmationURL }}"
  - "HTML email: all styles inline, table layout, bgcolor attrs, no external fonts"

requirements-completed:
  - AI-07

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 06.8 Plan 05: Branded Supabase Email OTP Template Summary

**Inline-CSS HTML email template with rose-branded SALGA Trust Engine header displaying {{ .Token }} as a large monospace 6-digit code — eliminating the Supabase magic link problem**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-17T07:36:23Z
- **Completed:** 2026-02-17T07:38:57Z
- **Tasks:** 1 of 2 completed (Task 2 is a manual Supabase Dashboard gate)
- **Files modified:** 1

## Accomplishments

- Created `templates/email/otp-verification.html` — complete, self-contained HTML email template
- SALGA Trust Engine rose (#cd5e81) header strip with platform name and tagline
- `{{ .Token }}` displayed as 40px bold monospace text in a light rose (#f8e8ee) box with rose border — plain text, NOT a link
- No `{{ .ConfirmationURL }}` present — eliminates the magic link problem entirely
- All CSS inline, table layout with `bgcolor` attributes for Outlook/Gmail/Apple Mail compatibility
- 60-minute expiry notice, GBV-aware safety footer ("If you did not request this code, please ignore")
- Platform footer in rose color: "SALGA Trust Engine | South Africa's Municipal Services Platform"
- Template validated: 6,250 bytes, 0 style blocks, token present, no anchor tags, no ConfirmationURL

## Task Commits

Each task was committed atomically:

1. **Task 1: Create branded HTML email OTP template** - `a940145` (feat)
2. **Task 2: Paste email template into Supabase Dashboard** - PENDING human action (manual Supabase Dashboard gate)

**Plan metadata:** See final docs commit below.

## Files Created/Modified

- `templates/email/otp-verification.html` — Branded Supabase email OTP template with {{ .Token }} code display

## Decisions Made

- **{{ .Token }} only, never {{ .ConfirmationURL }}** — The root cause of the magic link problem was wrapping token in an anchor with the confirmation URL. Using only `{{ .Token }}` as plain text resolves this.
- **Inline CSS, table layout** — HTML email clients (especially Outlook) strip `<style>` blocks and ignore CSS Grid/Flexbox. All styles applied as `style=""` attributes; layout uses `<table>` elements with `bgcolor` attributes.
- **Monospace font for code** — `Courier New, Courier, 'Lucida Console', monospace` gives each digit equal width, improving readability for 6-digit codes.
- **Manual deployment** — Supabase does not expose an API for updating email templates. The template must be copy-pasted via Supabase Dashboard -> Authentication -> Email Templates -> Magic Link.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed HTML comment containing `<a>` to pass token-in-link check**
- **Found during:** Task 1 verification
- **Issue:** Inline HTML comment text "NOT wrapped in any `<a>` tag" contained the literal string `<a>` which caused the plan's validation script to flag a false-positive anchor tag detection
- **Fix:** Rewrote comment to "no clickable link" — functionally identical, passes validation correctly
- **Files modified:** `templates/email/otp-verification.html`
- **Verification:** `python -c "..."` validation script passes with "Template validation: OK"
- **Committed in:** `a940145` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - false positive in verification comment)
**Impact on plan:** Trivial comment wording change. No functional impact.

## Issues Encountered

None beyond the comment false-positive noted above.

## User Setup Required

**Manual Supabase Dashboard configuration required for email OTP to work:**

1. Open `templates/email/otp-verification.html` in a text editor
2. Select all content (Ctrl+A) and copy (Ctrl+C)
3. Open Supabase Dashboard for the project
4. Navigate to: **Authentication -> Email Templates -> Magic Link**
5. Clear the existing template body
6. Paste the new HTML content (Ctrl+V)
7. Save the template
8. Test by triggering an OTP send — email should show a large styled 6-digit code, NOT a clickable link

## Next Phase Readiness

- Template ready at `templates/email/otp-verification.html`
- Paste into Supabase Dashboard unblocks the full citizen auth registration flow
- After pasting, citizens can receive and enter the 6-digit code in the Streamlit dashboard
- Phase 06.8 plans 01, 03, 05 all complete — Gugu persona + response sanitization + email OTP template

## Self-Check: PASSED

- templates/email/otp-verification.html: FOUND
- .planning/phases/06.8-gugu-persona-email-otp-fix/06.8-05-SUMMARY.md: FOUND
- Commit a940145: FOUND

---
*Phase: 06.8-gugu-persona-email-otp-fix*
*Completed: 2026-02-17*
