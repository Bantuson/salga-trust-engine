---
phase: 06.8-gugu-persona-email-otp-fix
plan: 03
subsystem: api
tags: [crewai, sanitization, llm, regex, pydantic, fallback, i18n]

# Dependency graph
requires:
  - phase: 06.8-01
    provides: "Gugu persona applied to all agent backstory prompts (auth, municipal, GBV)"
provides:
  - "sanitize_reply() utility in crew_server.py for stripping LLM artifacts from citizen-facing output"
  - "Warm Gugu-voiced trilingual fallback messages for auth, municipal, GBV, and error agent types"
  - "Defense-in-depth Final Answer extraction in all three crew kickoff() methods"
  - "raw_output field in all crew return dicts for Streamlit debug inspection"
affects: [06.8-02, streamlit-dashboard, citizen-whatsapp]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Two-layer sanitization: crews do basic Final Answer extraction, crew_server.py does full artifact stripping"
    - "Warm fallback pattern: agent-specific, language-specific Gugu-voiced messages for all error/empty paths"
    - "raw_output preservation: crews always include raw LLM output for debug, sanitize_reply preserves raw_reply in debug dict"

key-files:
  created: []
  modified:
    - src/api/v1/crew_server.py
    - src/agents/crews/auth_crew.py
    - src/agents/crews/municipal_crew.py
    - src/agents/crews/gbv_crew.py

key-decisions:
  - "Two-layer defense-in-depth: crews strip Final Answer prefix, crew_server.py does full sanitization"
  - "GBV error fallback always includes emergency numbers (10111, 0800 150 150) at both crew and server layers"
  - "Municipal error fallback includes Gugu identity and warm retry prompt"
  - "raw_output field in crew return dicts enables Streamlit debug without exposing artifacts to citizens"

patterns-established:
  - "sanitize_reply(raw, agent_name, language) as the single sanitization entry point for all agent output"
  - "_get_fallback(agent_name, language) for warm Gugu-voiced error messages"
  - "Final Answer extraction regex: re.search(r'Final Answer:?\\s*(.+)', raw, re.DOTALL | re.IGNORECASE)"

requirements-completed: [AI-05, AI-07]

# Metrics
duration: 7min
completed: 2026-02-17
---

# Phase 06.8 Plan 03: Response Sanitization Summary

**sanitize_reply() utility with LLM artifact stripping, trilingual Gugu fallbacks, and defense-in-depth Final Answer extraction across all three crew kickoff() methods**

## Performance

- **Duration:** 7 min (408s)
- **Started:** 2026-02-17T16:59:41Z
- **Completed:** 2026-02-17T17:06:29Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- sanitize_reply() function strips CrewAI reasoning markers (Thought/Action/Observation), JSON blobs, Final Answer prefix, LLM self-talk, and exception traces
- Warm Gugu-voiced fallback messages in EN/ZU/AF for auth, municipal, GBV, and error agent types (GBV includes emergency numbers)
- All three crew kickoff() methods extract "Final Answer:" content and provide raw_output for debug
- Error paths throughout the system use warm Gugu-voiced messages instead of generic English

## Task Commits

Each task was committed atomically:

1. **Task 1: Create sanitize_reply() utility and warm fallback messages** - `f6e16eb` (feat)
2. **Task 2: Sanitize crew kickoff() outputs in all three crews** - `f59ffba` (feat)

## Files Created/Modified
- `src/api/v1/crew_server.py` - sanitize_reply(), _LLM_ARTIFACT_PATTERNS, _FALLBACK_REPLIES, _get_fallback(), error handler using fallbacks, raw_reply in debug dict
- `src/agents/crews/auth_crew.py` - re import, Final Answer stripping in Pydantic and fallback branches, raw_output field
- `src/agents/crews/municipal_crew.py` - Final Answer extraction, clean_message in all return paths, raw_output field, warm error message
- `src/agents/crews/gbv_crew.py` - Final Answer extraction, clean_message in all return paths, raw_output field, emergency numbers in error fallback

## Decisions Made
- Two-layer defense-in-depth: crews do basic Final Answer prefix extraction, crew_server.py sanitize_reply() does full artifact stripping (belt-and-suspenders)
- GBV error fallback always includes emergency numbers (10111, 0800 150 150) at both the crew layer and the server fallback layer
- Municipal error fallback includes Gugu identity and warm retry prompt (not generic "error occurred")
- raw_output field added to all crew return dicts to enable Streamlit debug inspection without exposing LLM artifacts to citizens

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Response sanitization complete, citizens never see raw LLM reasoning or artifacts
- Streamlit dashboard can still inspect full raw output via debug dict
- Ready for Phase 06.8-02 (email OTP fix) if not already applied

## Self-Check: PASSED

- All 4 modified files exist on disk
- Both task commits verified in git log (f6e16eb, f59ffba)
- All Python imports succeed (AuthCrew, MunicipalCrew, GBVCrew, sanitize_reply)
- All verification assertions pass (artifact stripping, fallbacks, JSON removal, emergency numbers)

---
*Phase: 06.8-gugu-persona-email-otp-fix*
*Completed: 2026-02-17*
