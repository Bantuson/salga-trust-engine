---
phase: 06.8-gugu-persona-email-otp-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/v1/crew_server.py
autonomous: false
requirements:
  - AI-06
  - AI-07

must_haves:
  truths:
    - "Crew server auto-detects language from citizen's message text before routing to any agent"
    - "Detected language overrides the static dashboard language hint when detection is confident"
    - "Short messages (<20 chars) or low-confidence detections fall back to the dashboard language hint"
    - "Language detection uses the existing singleton from src/core/language.py (no new instantiation)"
    - "Supabase email OTP sends 6-digit codes instead of magic links after dashboard template fix"
    - "SMS OTP evaluation documented with clear next steps (configure or defer)"
  artifacts:
    - path: "src/api/v1/crew_server.py"
      provides: "Language auto-detection call before agent routing"
      contains: "language_detector"
  key_links:
    - from: "src/api/v1/crew_server.py"
      to: "src/core/language.py"
      via: "import language_detector singleton"
      pattern: "from src.core.language import language_detector"
    - from: "src/api/v1/crew_server.py"
      to: "src/agents/crews/auth_crew.py"
      via: "AuthCrew(language=detected_language) — detected language passed to crew constructor"
      pattern: "AuthCrew.*language.*detected"

user_setup:
  - service: supabase-dashboard
    why: "Email OTP sends magic links instead of 6-digit codes — dashboard template must be changed"
    dashboard_config:
      - task: "Change Magic Link email template to show OTP code"
        location: "Supabase Dashboard -> Authentication -> Email Templates -> Magic Link"
        action: "Replace {{ .ConfirmationURL }} link with {{ .Token }} code display. New body: 'Your SALGA verification code is: {{ .Token }}. This code expires in 60 minutes.'"
      - task: "Evaluate SMS OTP via Twilio provider configuration"
        location: "Supabase Dashboard -> Authentication -> Providers -> Phone"
        action: "Check if Phone provider can be enabled with Twilio credentials (Account SID, Auth Token, SMS phone number). If Twilio account has a plain SMS number (not WhatsApp sandbox), enable it. If not, defer SMS OTP to a future phase."
---

<objective>
Add automatic language detection in the crew server's /chat endpoint so agents respond in the citizen's actual language (not the static dashboard setting), and guide the Supabase Dashboard configuration fix for email OTP (magic links to 6-digit codes) plus SMS OTP evaluation.

Purpose: Fixes the reported issue where citizens type in isiZulu but the agent responds in English (AI-06). The email OTP fix addresses the broken authentication flow. SMS OTP evaluation determines if Twilio phone provider can be enabled.

Output: Updated crew_server.py with language detection, plus verified Supabase Dashboard configuration for email OTP.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-RESEARCH.md

@src/api/v1/crew_server.py
@src/core/language.py
@src/agents/crews/auth_crew.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language auto-detection to crew_server.py /chat endpoint</name>
  <files>
    src/api/v1/crew_server.py
  </files>
  <action>
Add language auto-detection to the `/api/v1/chat` endpoint in `src/api/v1/crew_server.py`:

1. **Import the singleton** at the top of the file (with existing imports, after the `from src.core.config import settings` line):
   ```python
   from src.core.language import language_detector
   ```

2. **Detect language from the citizen's message** in the `chat()` function, BEFORE Step 2 (conversation history) and BEFORE Step 3 (agent routing). Add this between the "Step 1: Determine session status" block and "Step 2: Load / create conversation history" block:

   ```python
   # ------------------------------------------------------------------
   # Step 1.5: Auto-detect language from citizen's message
   # ------------------------------------------------------------------
   # Override the static dashboard language hint with detected language.
   # Falls back to request.language if text is too short (<20 chars)
   # or detection confidence is below threshold (0.7).
   detected_language = language_detector.detect(
       request.message,
       fallback=request.language,
   )
   ```

3. **Replace `request.language` with `detected_language`** in ALL downstream usages within the chat() function. Specifically:
   - Line where `conv_state` is created: change `language=request.language` to `language=detected_language`
   - Line where `IntakeState` is built: change `language=request.language` to `language=detected_language`
   - Line where `AuthCrew` is constructed: change `AuthCrew(language=request.language)` to `AuthCrew(language=detected_language)`
   - In `auth_context` dict: change `"language": request.language` to `"language": detected_language`
   - In the non-GBV debug dict: change `"language": request.language` to `"language": detected_language`

4. **Add detected_language to debug output** for non-GBV responses:
   Add `"detected_language": detected_language` to the debug dict (alongside the existing `"language"` field) so the Streamlit dashboard can show what language was detected vs. what was requested.

CRITICAL CONSTRAINTS:
- Import `language_detector` (the module-level singleton instance), NOT the `LanguageDetector` class. Do NOT instantiate a new detector per request (per research anti-pattern: it's heavy, builds ML model).
- Do NOT change the ChatRequest model — `language` field stays as the dashboard hint. Detection happens server-side.
- Do NOT change the ChatResponse model.
- Do NOT change any other endpoint (health, session/reset).
- Preserve all existing imports, models, helpers, and error handling.
  </action>
  <verify>
Run `python -c "from src.api.v1.crew_server import crew_app; print('Import OK')"` — must succeed (no import errors).

Grep for `language_detector` in crew_server.py — must find the import AND the .detect() call.
Grep for `detected_language` in crew_server.py — must find it used in AuthCrew constructor, IntakeState, auth_context, and debug dict.
Grep for `request.language` in crew_server.py chat() function — should only appear in the ChatRequest definition and as the fallback parameter to language_detector.detect(). It should NOT be used directly for crew construction or context building anymore.
  </verify>
  <done>
crew_server.py imports language_detector singleton and calls .detect(request.message, fallback=request.language) before agent routing. All downstream crew constructors and context dicts use detected_language instead of request.language. Debug output includes detected_language field. No new dependencies, no model changes, no other endpoints affected.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Supabase Dashboard — email OTP template fix and SMS OTP evaluation</name>
  <action>
Two manual Supabase Dashboard configuration changes are needed. These CANNOT be automated via CLI or API — they require the Supabase Dashboard UI.

**PART A: Email OTP Template Fix (REQUIRED)**

1. Open the Supabase Dashboard for the project
2. Navigate to: **Authentication -> Email Templates -> Magic Link**
3. Find the email template body — it currently contains `{{ .ConfirmationURL }}` (a clickable link)
4. Replace the template body with:
   ```html
   <h2>Your SALGA Verification Code</h2>
   <p>Your verification code is:</p>
   <h1 style="letter-spacing: 0.3em; font-size: 32px;">{{ .Token }}</h1>
   <p>Enter this 6-digit code in the app to verify your identity.</p>
   <p>This code expires in 60 minutes. If you did not request this code, please ignore this email.</p>
   ```
5. Save the template
6. Verify by checking auth logs after a test OTP send — `mail_type` should change from `"magic_link"` to include the token

**PART B: SMS OTP Evaluation (EVALUATE ONLY)**

1. Navigate to: **Authentication -> Providers -> Phone**
2. Check if Phone provider can be enabled
3. If a Twilio account is available with a plain SMS-capable number (NOT the WhatsApp sandbox number):
   - Enable Phone provider
   - Set SMS Provider to "Twilio"
   - Enter: Account SID, Auth Token, and the SMS phone number
   - Save and test with a phone OTP send
4. If no dedicated SMS number is available:
   - Note: SMS OTP requires a dedicated Twilio SMS number (separate from WhatsApp)
   - This can be deferred — the phone_provider_disabled error is expected until a number is configured
   - No code changes needed; the existing `sign_in_with_otp({"phone": ...})` call will work once the provider is enabled
  </action>
  <how-to-verify>
1. After Part A: Send a test OTP via email (trigger sign_in_with_otp for an email address). Check the email — it should contain a 6-digit code, NOT a clickable magic link.
2. After Part A: Check Supabase auth logs (mcp__supabase-project1__get_logs service="auth") — look for `mail_type` to confirm it's no longer "magic_link".
3. For Part B: Report whether SMS OTP was enabled or deferred, and why.
  </how-to-verify>
  <resume-signal>Report: (1) "Email OTP fixed" or describe issue, (2) "SMS OTP enabled" or "SMS OTP deferred — [reason]"</resume-signal>
</task>

</tasks>

<verification>
1. crew_server.py imports language_detector from src.core.language
2. chat() endpoint calls language_detector.detect() before agent routing
3. All crew constructors and contexts use detected_language (not request.language)
4. Email OTP sends 6-digit codes (verified via test send or auth logs)
5. SMS OTP status documented (enabled or deferred with reason)
6. No import errors in crew_server.py
</verification>

<success_criteria>
- Language auto-detection active on every /chat request
- Detected language passed to all crew constructors and task contexts
- Email OTP template updated to show {{ .Token }} instead of {{ .ConfirmationURL }}
- SMS OTP evaluation completed with documented outcome
- No regressions in crew_server.py functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-02-SUMMARY.md`
</output>
