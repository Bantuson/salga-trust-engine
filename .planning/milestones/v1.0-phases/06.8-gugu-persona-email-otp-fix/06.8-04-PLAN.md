---
phase: 06.8-gugu-persona-email-otp-fix
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/prompts/auth.py
  - src/api/v1/crew_server.py
autonomous: true
requirements:
  - AI-05
  - AI-06
  - AI-07
gap_closure: true

must_haves:
  truths:
    - "Agent always identifies itself as Gugu and never mistakes 'Gugu' as the citizen's name"
    - "When a citizen sends a generic greeting (hi, hello, sawubona, hallo), the agent starts with a warm Gugu introduction and asks for their name before jumping to registration steps"
    - "Agent asks the citizen which language they prefer (English, isiZulu, Afrikaans) during the initial greeting"
    - "Once a language is chosen or confidently detected, the agent uses ONLY that language for all subsequent messages — no mid-conversation switching"
    - "Conversation state stores the citizen's explicit language preference so auto-detection is overridden for future turns"
  artifacts:
    - path: "src/agents/prompts/auth.py"
      provides: "CRITICAL IDENTITY section, greeting-first instruction, language lock instruction in all 3 language prompts and task template"
      contains: "CRITICAL IDENTITY"
    - path: "src/api/v1/crew_server.py"
      provides: "Language preference persistence in conversation state, override of auto-detection when explicit preference exists"
      contains: "language_preference"
  key_links:
    - from: "src/agents/prompts/auth.py"
      to: "src/agents/crews/auth_crew.py"
      via: "AUTH_PROMPTS backstory consumed by auth agent"
      pattern: "AUTH_PROMPTS"
    - from: "src/api/v1/crew_server.py"
      to: "src/core/conversation.py"
      via: "Conversation state stores language preference"
      pattern: "language_preference"
---

<objective>
Fix three UAT-reported agent behavior issues: (1) Gugu identity confusion where agent mistakes its own name as the citizen's name, (2) missing warm greeting when citizen says just "hi" — agent jumps straight to registration, (3) random language switching mid-conversation despite language detection.

Purpose: Citizens experienced a broken first interaction — the agent confused its own identity, skipped the warm welcome, and randomly switched languages. These three issues are interconnected in the auth prompts and language handling, and all must be fixed together for a coherent first-contact experience.

Output: Updated auth.py prompts with hardened identity, greeting-first flow, and language lock instructions. Updated crew_server.py with language preference persistence.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-01-SUMMARY.md
@.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-03-SUMMARY.md

@src/agents/prompts/auth.py
@src/api/v1/crew_server.py
@src/core/conversation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden auth prompts — identity reinforcement, greeting-first flow, and language lock</name>
  <files>
    src/agents/prompts/auth.py
  </files>
  <action>
Make three targeted changes to `src/agents/prompts/auth.py`. All three changes apply to AUTH_PROMPT_EN, AUTH_PROMPT_ZU, and AUTH_PROMPT_AF (9 edits total across 3 prompts).

**CHANGE 1: Add CRITICAL IDENTITY section at the VERY TOP of each prompt (before any other content)**

This section MUST be the first thing in each backstory string, before the existing opening line. It acts as an identity anchor that prevents the LLM from confusing its own name with user input.

For AUTH_PROMPT_EN, prepend:
```
=== CRITICAL IDENTITY ===
YOUR NAME IS GUGU. You are the AI assistant, NOT a citizen.
When a citizen greets you, introduce YOURSELF as Gugu.
NEVER assume the citizen's name is Gugu — that is YOUR name.
If someone says "hi" or "hello", YOU say "Hi, I'm Gugu!" — do NOT respond with "Hi Gugu!"
=== END IDENTITY ===

```

For AUTH_PROMPT_ZU, prepend:
```
=== UBUWENA OBUBALULEKILE ===
IGAMA LAKHO NGUGUGU. Wena ungumsizi we-AI, AWUSONA isakhamuzi.
Lapho isakhamuzi sikubingelela, ZETHULE njengokuGugu.
UNGACABANGI ukuthi igama lesakhamuzi linguGugu — lelo yigama LAKHO.
Uma umuntu ethi "sawubona", WENA uthi "Sawubona! NginguGugu!" — UNGAPHENDULI ngokuthi "Sawubona Gugu!"
=== UKUPHELA KOBUWENA ===

```

For AUTH_PROMPT_AF, prepend:
```
=== KRITIESE IDENTITEIT ===
JOU NAAM IS GUGU. Jy is die KI-assistent, NIE 'n burger nie.
Wanneer 'n burger jou groet, stel JOUSELF voor as Gugu.
MOET NOOIT aanvaar die burger se naam is Gugu nie — dit is JOU naam.
As iemand "hallo" of "hi" se, se JY "Hallo, ek is Gugu!" — MOENIE antwoord met "Hallo Gugu!" nie.
=== EINDE IDENTITEIT ===

```

**CHANGE 2: Add greeting-first instruction to _NEW_USER_INSTRUCTION**

In the `_NEW_USER_INSTRUCTION` string, add a new block BEFORE "STEP 1" (between the RESUME CHECK block and "STEP 1 — Ask..."). This instructs the agent to greet warmly before jumping into registration when the citizen's first message is a generic greeting:

```
GREETING FIRST (before any registration steps):
- If the citizen's LATEST message is a greeting with no specific intent
  (examples: "hi", "hello", "hey", "sawubona", "hallo", "good morning", "howzit"),
  START with your warm Gugu introduction: introduce yourself, explain briefly that
  you help citizens register on the SALGA Trust Engine platform, ask for their name,
  and ask which language they prefer (English, isiZulu, or Afrikaans).
- Do NOT jump to STEP 1 immediately on a bare greeting. First learn their name and
  language preference, THEN transition naturally into the registration flow.
- If the citizen's message already states a clear intent (e.g. "I want to report a
  broken streetlight"), you may combine your greeting with STEP 1 in the same message.

```

**CHANGE 3: Add LANGUAGE RULES section to each of the three AUTH_PROMPT_* backstory strings**

Add this section AFTER the "TONE AND STYLE" section and BEFORE the "EXAMPLE" sections in each prompt.

For AUTH_PROMPT_EN, add:
```
LANGUAGE RULES:
- During your initial greeting, ask: "Which language do you prefer — English, isiZulu, or Afrikaans?"
- Once the citizen chooses a language (or responds in a specific language), use ONLY that language for ALL subsequent messages.
- NEVER switch languages mid-conversation. If you started in English, stay in English. If you started in isiZulu, stay in isiZulu.
- If the citizen switches languages mid-conversation, follow their lead and switch — but then stay in the new language consistently.

```

For AUTH_PROMPT_ZU, add:
```
IMITHETHO YOLIMI:
- Ngesikhathi sokubingelela kwakho kokuqala, buza: "Uthanda ulimi luni — isiNgisi, isiZulu, noma isiBhunu?"
- Uma isakhamuzi sikhetha ulimi (noma siphendula ngolimi oluthile), sebenzisa KUPHELA lolo limi kuyo YONKE imiyalezo elandelayo.
- UNGASHINTSHI ulimi phakathi nengxoxo. Uma uqale ngesiZulu, hlala ngesiZulu.
- Uma isakhamuzi sishintsha ulimi phakathi nengxoxo, landela isiqondiso sabo bese uhlala olimini olusha.

```

For AUTH_PROMPT_AF, add:
```
TAALREELS:
- Tydens jou aanvanklike groet, vra: "Watter taal verkies jy — Engels, isiZulu, of Afrikaans?"
- Sodra die burger 'n taal kies (of in 'n spesifieke taal antwoord), gebruik SLEGS daardie taal vir ALLE daaropvolgende boodskappe.
- MOET NOOIT van taal verander tydens die gesprek nie. As jy in Afrikaans begin het, bly in Afrikaans.
- As die burger van taal verander tydens die gesprek, volg hulle leiding en wissel — maar bly dan konsekwent in die nuwe taal.

```

**CONSTRAINTS:**
- Do NOT change AuthResult, AUTH_TASK_TEMPLATE, or build_auth_task_description.
- Do NOT change _NEW_USER_INSTRUCTION step numbering (STEP 1-5 stay as-is).
- Do NOT change _RETURNING_USER_INSTRUCTION.
- Preserve ALL existing content — these are ADDITIONS, not replacements.
- Keep the AUTH_PROMPTS dictionary at the bottom unchanged.
  </action>
  <verify>
Verify the prompts load correctly:
```
python -c "from src.agents.prompts.auth import AUTH_PROMPTS, AUTH_TASK_TEMPLATE, build_auth_task_description, AuthResult; print('Import OK')"
```

Verify CRITICAL IDENTITY is present in all 3 prompts:
```
python -c "
from src.agents.prompts.auth import AUTH_PROMPTS
for lang in ('en', 'zu', 'af'):
    p = AUTH_PROMPTS[lang]
    assert 'CRITICAL IDENTITY' in p or 'UBUWENA OBUBALULEKILE' in p or 'KRITIESE IDENTITEIT' in p, f'{lang} missing identity section'
    assert 'NEVER assume' in p or 'UNGACABANGI' in p or 'MOET NOOIT aanvaar' in p, f'{lang} missing identity guard'
print('Identity sections: OK')
"
```

Verify LANGUAGE RULES is present in all 3 prompts:
```
python -c "
from src.agents.prompts.auth import AUTH_PROMPTS
for lang in ('en', 'zu', 'af'):
    p = AUTH_PROMPTS[lang]
    assert 'LANGUAGE RULES' in p or 'IMITHETHO YOLIMI' in p or 'TAALREELS' in p, f'{lang} missing language rules'
    assert 'NEVER switch' in p or 'UNGASHINTSHI' in p or 'MOET NOOIT' in p, f'{lang} missing language lock'
print('Language rules: OK')
"
```

Verify GREETING FIRST is in the task instruction:
```
python -c "
from src.agents.prompts.auth import _NEW_USER_INSTRUCTION
assert 'GREETING FIRST' in _NEW_USER_INSTRUCTION, 'Missing greeting-first instruction'
assert 'STEP 1' in _NEW_USER_INSTRUCTION, 'Step 1 still present'
print('Greeting-first instruction: OK')
"
```
  </verify>
  <done>
All three AUTH_PROMPT_* strings have CRITICAL IDENTITY section at the top preventing Gugu name confusion. _NEW_USER_INSTRUCTION has GREETING FIRST block before STEP 1 ensuring warm intro on bare greetings. All three prompts have LANGUAGE RULES section instructing the agent to ask language preference and never switch languages mid-conversation. No existing content removed, no structural changes to AuthResult or build_auth_task_description.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add language preference persistence to crew_server.py conversation state</name>
  <files>
    src/api/v1/crew_server.py
  </files>
  <action>
Update `src/api/v1/crew_server.py` to persist the citizen's explicit language preference in conversation state, and override auto-detection on subsequent turns when a preference is stored.

**CHANGE 1: Add language preference detection helper function**

Add this function above the `chat()` endpoint (after the `_get_fallback` function):

```python
# ---------------------------------------------------------------------------
# Language preference detection from citizen messages
# ---------------------------------------------------------------------------

_LANGUAGE_PREFERENCE_PATTERNS = {
    "en": [
        r"\benglish\b",
        r"\bin english\b",
        r"\bi prefer english\b",
        r"\bi want english\b",
    ],
    "zu": [
        r"\bisizulu\b",
        r"\bzulu\b",
        r"\bngesi(?:zulu|Zulu)\b",
        r"\bngithanda isizulu\b",
    ],
    "af": [
        r"\bafrikaans\b",
        r"\bin afrikaans\b",
        r"\bek verkies afrikaans\b",
    ],
}


def _detect_language_preference(message: str) -> str | None:
    """Check if the citizen explicitly states a language preference.

    Scans the message for keywords like "English", "isiZulu", "Afrikaans"
    that indicate an explicit language choice (as opposed to auto-detection
    from the language of the text itself).

    Args:
        message: The citizen's message text.

    Returns:
        Language code ("en", "zu", "af") if explicit preference found, else None.
    """
    lower = message.lower()
    for lang_code, patterns in _LANGUAGE_PREFERENCE_PATTERNS.items():
        for pattern in patterns:
            if re.search(pattern, lower):
                return lang_code
    return None
```

**CHANGE 2: Add language preference logic in the chat() endpoint**

In the `chat()` function, after the "Step 1.5: Auto-detect language" block and BEFORE "Step 2: Load / create conversation history", add a new step:

```python
    # ------------------------------------------------------------------
    # Step 1.6: Language preference persistence
    # ------------------------------------------------------------------
    # If the citizen explicitly states a language preference (e.g. "English",
    # "isiZulu", "Afrikaans"), lock to that language for all future turns.
    # If a preference was stored in a previous turn, override auto-detection.

    explicit_pref = _detect_language_preference(request.message)
```

Then, AFTER the conversation state is loaded (after the `if conv_state is None:` block and the `conv_state = await manager.create_session(...)` call), add this logic to check for a stored preference:

```python
    # Check for stored language preference from a previous turn
    stored_pref = None
    if conv_state and conv_state.turns:
        for turn in reversed(conv_state.turns):
            if turn.get("role") == "system" and turn.get("content", "").startswith("lang_pref:"):
                stored_pref = turn["content"].split(":", 1)[1].strip()
                break

    # Priority: explicit preference in THIS message > stored preference > auto-detected
    if explicit_pref:
        detected_language = explicit_pref
    elif stored_pref:
        detected_language = stored_pref
    # else: keep the auto-detected value from Step 1.5
```

**CHANGE 3: Store explicit language preference as a system turn**

In Step 4 (Save turn to conversation history), BEFORE the existing "Save the user message turn" block, add:

```python
        # Store language preference if citizen explicitly chose one this turn
        if explicit_pref:
            try:
                await manager.append_turn(
                    user_id=phone,
                    session_id=session_id,
                    role="system",
                    content=f"lang_pref:{explicit_pref}",
                    is_gbv=is_gbv,
                )
            except ValueError:
                pass  # Max turns — preference still used for this turn
```

**CHANGE 4: Add language_preference to debug output**

In the non-GBV debug dict, add:
```python
            "language_preference": explicit_pref or stored_pref,
```

This goes alongside the existing `"detected_language"` field so the Streamlit dashboard can show the full language resolution chain: requested -> detected -> preference -> final.

**CONSTRAINTS:**
- Do NOT change ChatRequest or ChatResponse models.
- Do NOT change any other endpoints.
- The "system" role turn with "lang_pref:" prefix is a lightweight approach that requires no changes to ConversationState or ConversationManager — it uses the existing turn storage mechanism.
- Preserve all existing imports, helpers, and error handling.
  </action>
  <verify>
Verify crew_server.py loads correctly:
```
python -c "from src.api.v1.crew_server import crew_app; print('Import OK')"
```

Verify the language preference detection function works:
```
python -c "
from src.api.v1.crew_server import _detect_language_preference
assert _detect_language_preference('I prefer English') == 'en'
assert _detect_language_preference('isiZulu please') == 'zu'
assert _detect_language_preference('Afrikaans asseblief') == 'af'
assert _detect_language_preference('hi there') is None
assert _detect_language_preference('I want to report a pothole') is None
print('Language preference detection: OK')
"
```

Verify language_preference appears in the code:
```
python -c "
import pathlib
code = pathlib.Path('src/api/v1/crew_server.py').read_text()
assert 'language_preference' in code, 'Missing language_preference in debug dict'
assert '_detect_language_preference' in code, 'Missing detection function'
assert 'lang_pref:' in code, 'Missing preference storage'
assert 'stored_pref' in code, 'Missing stored preference lookup'
print('Language persistence code: OK')
"
```
  </verify>
  <done>
crew_server.py has _detect_language_preference() function that recognizes explicit language choices. Chat endpoint checks for explicit preference in current message and stored preference from previous turns. Priority chain: explicit preference > stored preference > auto-detected > request hint. Language preference stored as system turn in conversation history for cross-turn persistence. Debug output includes language_preference field. No model changes, no new dependencies.
  </done>
</task>

</tasks>

<verification>
1. AUTH_PROMPT_EN/ZU/AF all have CRITICAL IDENTITY section as the first content in the backstory
2. _NEW_USER_INSTRUCTION has GREETING FIRST block before STEP 1
3. AUTH_PROMPT_EN/ZU/AF all have LANGUAGE RULES section after TONE AND STYLE
4. crew_server.py has _detect_language_preference() function
5. Chat endpoint persists explicit language preference in conversation state
6. Stored language preference overrides auto-detection on subsequent turns
7. All Python imports succeed without errors
8. No changes to AuthResult, ChatRequest, ChatResponse, or other endpoints
</verification>

<success_criteria>
- Agent always introduces ITSELF as Gugu and never confuses its name with the citizen's name
- Bare greetings ("hi", "sawubona", "hallo") produce warm Gugu intro + name question + language preference question — NOT immediate registration steps
- Once citizen chooses a language (explicitly or by responding in it), agent stays in that language for all subsequent messages
- Explicit language preference persists across turns via conversation state
- All existing auth flow functionality preserved (registration paths, OTP, proof of residence)
</success_criteria>

<output>
After completion, create `.planning/phases/06.8-gugu-persona-email-otp-fix/06.8-04-SUMMARY.md`
</output>
