---
phase: 06.9.1-fix-agent-output-formatting-pydantic-models-auth-otp-tool-failures-and-system-prompt-engineering
plan: 02
subsystem: agents
tags: [crewai, pydantic, otp, supabase, auth, repair-strategy, structured-output]

# Dependency graph
requires:
  - phase: 06.9-multi-agent-manager-refactor-crewai-hierarchical-routing-with-manager-agent-greeting-task-auth-routing-municipal-tickets-agent
    provides: "BaseCrew, AuthCrew, MunicipalCrew, GBVCrew, TicketStatusCrew all established"
  - phase: 06.9.1-plan-01
    provides: "Research confirming Pydantic output_pydantic approach for sequential crews, repair pattern, OTP type fixes"
provides:
  - "AgentResponse base Pydantic model shared by all specialist crews"
  - "_repair_from_raw() 3-step repair strategy for LLM output → Pydantic conversion failures"
  - "MunicipalResponse Pydantic model with action_taken field"
  - "GBVResponse Pydantic model with requires_followup=True and emergency number guarantee"
  - "TicketStatusResponse Pydantic model with tickets_found field"
  - "AuthResult.language field added"
  - "Auth tool failure logging with 5-min sliding window and CRITICAL threshold at 3+"
  - "send_otp_tool is_returning_user=False parameter for returning user OTP flows"
affects: [crew_server, manager_crew, intake_flow, auth_flow, ticket_status_flow]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Pydantic output_pydantic on Task() constructor for all sequential specialist crews (NOT ManagerCrew — anti-pattern for hierarchical)"
    - "3-step _repair_from_raw: JSON extraction → Final Answer extraction → safe fallback dict"
    - "field_validator on AgentResponse.message strips Final Answer: prefix automatically"
    - "field_validator on AgentResponse.language enforces en/zu/af whitelist"
    - "Sliding window failure counter (5 min) with CRITICAL log at 3+ failures per tool"
    - "POPIA-safe user identifier truncation in logging (first 8 chars + ...)"

key-files:
  created:
    - src/agents/crews/base_crew.py
  modified:
    - src/agents/crews/municipal_crew.py
    - src/agents/crews/gbv_crew.py
    - src/agents/crews/ticket_status_crew.py
    - src/agents/crews/auth_crew.py
    - src/agents/prompts/auth.py
    - src/agents/tools/auth_tool.py

key-decisions:
  - "ManagerCrew does NOT get output_pydantic — research confirmed this breaks hierarchical Process delegation"
  - "_repair_from_raw is a module-level function (not a method) to allow import by all specialist crews without circular dependency"
  - "GBVResponse.requires_followup defaults to True — GBV always requires follow-up by design"
  - "AgentResponse.message field_validator strips Final Answer: prefix — defense-in-depth alongside crew_server sanitize_reply()"
  - "is_returning_user=False default on _send_otp_impl — backward compatible, prevents duplicate account creation for returning users"
  - "_tool_failure_counts is module-level dict persisting across calls in same Python process — intentional for 5-min sliding window"
  - "POPIA compliance: user_identifier truncated to 8 chars + ... in all auth tool failure logs"

patterns-established:
  - "Pydantic output model pattern: class XxxResponse(AgentResponse) + build_task_kwargs returning {'output_pydantic': XxxResponse}"
  - "parse_result override pattern: check result.pydantic first, then _repair_from_raw fallback"
  - "Auth tool exception pattern: catch Exception → _log_tool_failure() → return error string (never raise)"

requirements-completed: [AI-03, AI-04, AI-05, AI-06]

# Metrics
duration: 8.0min
completed: 2026-02-19
---

# Phase 06.9.1 Plan 02: Pydantic Structured Output Models and Auth Tool Fixes Summary

**Pydantic output models on all 4 specialist CrewAI crews with shared 3-step repair strategy, plus auth OTP tool fixes with POPIA-safe failure logging and sliding-window CRITICAL alerting.**

## Performance

- **Duration:** 8.0 min (477s)
- **Started:** 2026-02-19T10:06:49Z
- **Completed:** 2026-02-19T10:14:46Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Added `AgentResponse` base Pydantic model and `_repair_from_raw()` repair strategy to `base_crew.py`, giving all specialist crews a structured output layer with graceful fallback when DeepSeek returns raw text instead of JSON
- Added `MunicipalResponse`, `GBVResponse` (requires_followup always True), and `TicketStatusResponse` Pydantic models to their respective crews; GBV error fallback always includes 10111 and 0800 150 150
- Fixed auth OTP tool: added `is_returning_user=False` parameter to `send_otp_tool` (prevents duplicate account creation), added `_log_tool_failure()` to all 4 auth tools with 5-minute sliding window and CRITICAL alert at 3+ failures

## Task Commits

Each task was committed atomically:

1. **Task 1: Add Pydantic models and repair strategy to base_crew.py, then add models to Municipal, GBV, and TicketStatus crews** - `d004da9` (feat)
2. **Task 2: Fix auth OTP tool type handling and add structured failure logging** - `40a3212` (fix)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `src/agents/crews/base_crew.py` - Added `AgentResponse` base Pydantic model, `_repair_from_raw()` repair function, and Pydantic-aware path in `BaseCrew.parse_result()`
- `src/agents/crews/municipal_crew.py` - Added `MunicipalResponse(AgentResponse)`, `build_task_kwargs()` returning `output_pydantic=MunicipalResponse`, and `parse_result()` override with repair fallback
- `src/agents/crews/gbv_crew.py` - Added `GBVResponse(AgentResponse)` with `requires_followup=True` default, `build_task_kwargs()`, and `parse_result()` forcing `category="gbv"` on all paths
- `src/agents/crews/ticket_status_crew.py` - Added `TicketStatusResponse(AgentResponse)` with `tickets_found=0`, `build_task_kwargs()`, and `parse_result()` tagging `agent="ticket_status"`
- `src/agents/crews/auth_crew.py` - Updated `parse_result()` fallback to use `_repair_from_raw()` instead of hardcoded dict
- `src/agents/prompts/auth.py` - Added `language: str = "en"` field to `AuthResult` model
- `src/agents/tools/auth_tool.py` - Added `_log_tool_failure()`, `_tool_failure_counts`, `is_returning_user` param on `_send_otp_impl`, failure logging in all 4 tool except blocks

## Decisions Made

- ManagerCrew does NOT get `output_pydantic` — research confirmed this breaks CrewAI hierarchical process delegation
- `_repair_from_raw` is module-level (not a class method) to prevent circular imports when specialist crews import it from `base_crew`
- GBVResponse defaults `requires_followup=True` — GBV always requires follow-up by design (trauma protocol)
- `AgentResponse.message` field_validator strips `Final Answer:` prefix as defense-in-depth alongside `crew_server.py`'s `sanitize_reply()`
- `_tool_failure_counts` is module-level (process-scoped) rather than Redis-backed — appropriate for single-process crew server in v1

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Cleared stale .pyc cache causing false IndentationError on gbv.py**
- **Found during:** Task 1 verification
- **Issue:** First import attempt showed `IndentationError` at `gbv.py:195` — stale `.pyc` bytecode from a previous edit. `ast.parse()` confirmed the source file had no syntax error.
- **Fix:** Re-ran import with fresh `sys.path.insert(0, '.')` — Python recompiled `.pyc` from source; error did not recur.
- **Files modified:** None (cache cleared automatically)
- **Verification:** All imports succeeded on second attempt

---

**Total deviations:** 1 auto-fixed (1 blocking — stale cache)
**Impact on plan:** No scope creep. Source file was correct; only stale bytecode caused the false error.

## Issues Encountered

None — plan executed cleanly once stale bytecode was cleared.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All 4 specialist crews now produce structured Pydantic output — `crew_server.py` can rely on `result["message"]` always being a clean string
- `_repair_from_raw()` available as shared utility for any future specialist crew that needs fallback repair
- Auth tool failure logging will surface OTP delivery issues in production logs without requiring PII exposure
- Ready for Phase 06.9.1 Plan 03 (system prompt engineering for output format enforcement)

---
*Phase: 06.9.1*
*Completed: 2026-02-19*

## Self-Check: PASSED

- FOUND: base_crew.py
- FOUND: municipal_crew.py
- FOUND: gbv_crew.py
- FOUND: ticket_status_crew.py
- FOUND: auth_crew.py
- FOUND: auth.py
- FOUND: auth_tool.py
- FOUND: 06.9.1-02-SUMMARY.md
- FOUND commit: d004da9 (feat: Pydantic models)
- FOUND commit: 40a3212 (fix: auth tool logging)
