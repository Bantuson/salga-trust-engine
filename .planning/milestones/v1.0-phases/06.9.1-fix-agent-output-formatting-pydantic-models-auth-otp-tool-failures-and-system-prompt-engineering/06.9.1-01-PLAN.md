---
phase: 06.9.1-fix-agent-output-formatting-pydantic-models-auth-otp-tool-failures-and-system-prompt-engineering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/prompts/auth.py
  - src/agents/prompts/municipal.py
  - src/agents/prompts/gbv.py
  - src/agents/config/agents.yaml
  - src/agents/config/tasks.yaml
autonomous: true
requirements: [AI-03, AI-04, AI-05, AI-07]

must_haves:
  truths:
    - "No agent prompt allows internal reasoning narration to reach citizens"
    - "Auth agent prompt explicitly enumerates all 4 tools and prohibits non-existent methods"
    - "GBV agent prompt has ultra-strict guardrails with banned patterns and emergency number mandate"
    - "All agent YAML backstories contain universal response rules forbidding role narration and delegation text"
    - "Manager task YAML no longer contains delegation step descriptions that leak to citizens"
  artifacts:
    - path: "src/agents/prompts/auth.py"
      provides: "Hardened auth prompts with tool hard-block in all 3 languages"
      contains: "AVAILABLE TOOLS"
    - path: "src/agents/prompts/municipal.py"
      provides: "Municipal prompts with universal guardrails in all 3 languages"
      contains: "RESPONSE RULES"
    - path: "src/agents/prompts/gbv.py"
      provides: "GBV prompts with ultra-strict guardrails in all 3 languages"
      contains: "RESPONSE RULES"
    - path: "src/agents/config/agents.yaml"
      provides: "All 5 agent configs with universal response rules in backstory"
      contains: "NEVER narrate"
    - path: "src/agents/config/tasks.yaml"
      provides: "Updated task configs with structured output expectations and no delegation narration"
      contains: "output_pydantic"
  key_links:
    - from: "src/agents/config/agents.yaml"
      to: "src/agents/crews/base_crew.py"
      via: "YAML backstory loaded by BaseCrew.create_crew()"
      pattern: "agent_config.*backstory"
    - from: "src/agents/prompts/auth.py"
      to: "src/agents/crews/auth_crew.py"
      via: "AUTH_PROMPTS dict used in get_language_prompt()"
      pattern: "AUTH_PROMPTS"
---

<objective>
Harden all system prompts and YAML agent/task configs to prevent internal reasoning leakage, tool hallucination, and delegation text reaching citizens.

Purpose: This is the highest-impact fix — the critical failure transcript showed the manager agent leaking "As the Municipal Services Manager, here is the complete and correct procedure for you, Gugu, to follow: Step 1..." directly to a citizen. Prompt hardening is the first defense layer.

Output: Updated prompt files (auth.py, municipal.py, gbv.py) and YAML configs (agents.yaml, tasks.yaml) with tool hard-blocks, universal response rules, banned narration patterns, and per-crew strictness levels.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.9.1-fix-agent-output-formatting-pydantic-models-auth-otp-tool-failures-and-system-prompt-engineering/06.9.1-RESEARCH.md
@src/agents/prompts/auth.py
@src/agents/prompts/municipal.py
@src/agents/prompts/gbv.py
@src/agents/config/agents.yaml
@src/agents/config/tasks.yaml
@src/agents/crews/base_crew.py
@src/agents/crews/manager_crew.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add universal guardrails and tool hard-blocks to all prompt files</name>
  <files>
    src/agents/prompts/auth.py
    src/agents/prompts/municipal.py
    src/agents/prompts/gbv.py
  </files>
  <action>
    Add response rules and tool hard-blocks to ALL three prompt files in ALL three languages (EN/ZU/AF). Each prompt file gets different strictness levels per locked decision:

    **auth.py** (structured strictness):
    Add an _AUTH_TOOL_HARD_BLOCK constant at module level. Append it to AUTH_PROMPT_EN, AUTH_PROMPT_ZU, and AUTH_PROMPT_AF. Contents:
    - AVAILABLE TOOLS section listing exactly 4 tools: send_otp_tool, verify_otp_tool, create_supabase_user_tool, lookup_user_tool — with brief descriptions of what each does
    - "YOU DO NOT HAVE AND CANNOT OFFER:" section explicitly listing: phone call verification, WhatsApp code delivery, video verification, any method not listed above
    - "RESPONSE RULES - MANDATORY:" section with these bans:
      * NEVER narrate your reasoning steps to the citizen
      * NEVER say "Step 1:", "Step 2:" in citizen-facing messages
      * NEVER describe your role or who assigned you
      * NEVER say "As the authentication specialist..." or "The manager has asked me to..."
      * Speak DIRECTLY to the citizen as a friendly human helper
      * If a tool fails: apologize, retry once, then give manual contact alternative
    - The ZU and AF versions translate these rules to match the existing language register (not literal translation) — adapt naturally to the conversational style already in those prompts

    **municipal.py** (moderate strictness):
    Add a _MUNICIPAL_RESPONSE_RULES constant at module level. Append to each of the 3 language variants. Contents:
    - AVAILABLE TOOLS section listing exactly 1 tool: create_municipal_ticket — with brief param summary
    - RESPONSE RULES section:
      * NEVER narrate internal reasoning
      * NEVER say "Step 1:", "As the specialist...", "I am delegating..."
      * Speak directly to citizen in conversational tone
      * Light formatting: occasional bold, numbered steps for instructions only
      * Keep confirmations short (1-3 sentences), longer for explaining or gathering info
    - ZU/AF versions adapted to existing language register

    **gbv.py** (ultra-strict):
    Add a _GBV_RESPONSE_RULES constant at module level. Append to each of the 3 language variants. Contents:
    - AVAILABLE TOOLS section listing exactly 2 tools: create_municipal_ticket (with category="gbv"), notify_saps
    - ULTRA-STRICT RESPONSE RULES:
      * NEVER narrate internal reasoning
      * NEVER describe your role, delegation, or agent assignments
      * NEVER use technical jargon (tool names, API terms, JSON, etc.)
      * NEVER ask more than 4 questions total
      * ALWAYS include emergency numbers (10111, 0800 150 150) in EVERY response
      * If ANY error occurs: include emergency numbers in the error message
      * Keep responses SHORT and empathetic — no paragraphs
    - ZU/AF versions adapted to existing language register

    IMPORTANT: Do NOT remove or rewrite any existing prompt content. APPEND the new rules as a new section at the end of each language prompt string. The existing content is working and must stay.
  </action>
  <verify>
    Grep for "AVAILABLE TOOLS" in all three prompt files — must appear 3 times each (EN/ZU/AF).
    Grep for "RESPONSE RULES" in all three files.
    Grep for "phone call verification" in auth.py (hard block must exist).
    Grep for "NEVER narrate" in all three files.
    Python syntax check: `python -c "from src.agents.prompts.auth import AUTH_PROMPTS; from src.agents.prompts.municipal import MUNICIPAL_INTAKE_PROMPTS; from src.agents.prompts.gbv import GBV_INTAKE_PROMPTS; print('OK')"` with OPENAI_API_KEY=dummy
  </verify>
  <done>
    All 9 prompt variants (3 files x 3 languages) have appended response rules with tool hard-blocks, banned narration patterns, and per-crew strictness. Auth has explicit "phone call verification DOES NOT EXIST" block. GBV has "ALWAYS include emergency numbers" rule. Python imports succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update agents.yaml and tasks.yaml with universal guardrails and structured output expectations</name>
  <files>
    src/agents/config/agents.yaml
    src/agents/config/tasks.yaml
  </files>
  <action>
    **agents.yaml changes:**

    For ALL 5 agent backstories (auth_agent, municipal_intake_agent, gbv_agent, manager_agent, ticket_status_agent), append a universal response rules block at the END of the backstory (keep all existing content):

    ```
    RESPONSE RULES (MANDATORY FOR ALL RESPONSES):
    - NEVER narrate your internal reasoning to the citizen
    - NEVER say "Step 1:", "As the [role]...", "I am delegating...", "The manager has..."
    - NEVER describe which agent you are or how you were assigned
    - NEVER output JSON, tool names, or technical terms to citizens
    - Speak directly to the citizen as a friendly, professional human helper
    ```

    For manager_agent specifically, add additionally:
    ```
    DELEGATION RULES:
    - When you delegate to a specialist, the specialist's response IS your response
    - Do NOT narrate the delegation process to the citizen
    - Do NOT say "I am now routing you to..." or "The specialist will handle..."
    - The citizen should not know delegation happened — it should feel seamless
    ```

    Add YAML comments (not functional keys) documenting which tools each agent receives:
    ```yaml
    # Tools (passed via code in crews/*.py): send_otp_tool, verify_otp_tool, ...
    ```

    Set manager_agent verbose to false (was true for testing, now production-ready):
    ```yaml
    verbose: false
    ```

    **tasks.yaml changes:**

    For manager_task:
    - In the description, remove the explicit "STEP 4 - DELEGATE" section that lists specialist agent names and what to pass. Replace with a simpler instruction: "Route the citizen's request to the appropriate specialist. The specialist will handle the interaction from here. Do NOT describe the routing process to the citizen."
    - Update expected_output to: "A clean, citizen-facing response. If delegation occurred, return ONLY the specialist's response — no routing narration, no delegation description, no internal steps."

    For auth_task:
    - Update expected_output to reference the AuthResult Pydantic model: "An AuthResult JSON with fields: authenticated (bool), session_status (str), message (str), user_id (str|null), error (str|null). The message field must be clean citizen-facing text with no internal reasoning."

    For municipal_intake_task:
    - Update expected_output to reference the new MunicipalResponse Pydantic model: "A MunicipalResponse JSON with fields: message (str), language (str), action_taken (str), requires_followup (bool), tracking_number (str|null). The message must be clean citizen-facing text."

    For gbv_intake_task:
    - Update expected_output to reference the new GBVResponse Pydantic model: "A GBVResponse JSON with fields: message (str), language (str), action_taken (str), requires_followup (bool), tracking_number (str|null). The message MUST include emergency numbers (10111, 0800 150 150)."

    For ticket_status_task:
    - Update expected_output to reference the new TicketStatusResponse Pydantic model: "A TicketStatusResponse JSON with fields: message (str), language (str), action_taken (str), requires_followup (bool), tickets_found (int). The message must be plain-language ticket information."

    IMPORTANT: Do NOT change task description content beyond what is specified (the descriptions contain format placeholders like {message}, {language}, etc. that MUST be preserved). Only change expected_output and the manager_task delegation narration.
  </action>
  <verify>
    Grep for "RESPONSE RULES" in agents.yaml — must appear at least 5 times.
    Grep for "DELEGATION RULES" in agents.yaml — must appear 1 time (manager only).
    Grep for "MunicipalResponse" in tasks.yaml.
    Grep for "GBVResponse" in tasks.yaml.
    Grep for "TicketStatusResponse" in tasks.yaml.
    Confirm manager_agent verbose is false: grep for "verbose: false" in agents.yaml.
    YAML syntax check: `python -c "import yaml; yaml.safe_load(open('src/agents/config/agents.yaml')); yaml.safe_load(open('src/agents/config/tasks.yaml')); print('OK')"` from project root
  </verify>
  <done>
    All 5 agent YAML backstories have universal response rules appended. Manager has additional delegation rules. All 5 task expected_outputs reference Pydantic model shapes. Manager task no longer describes delegation step-by-step. Manager agent verbose set to false. YAML loads without error.
  </done>
</task>

</tasks>

<verification>
1. All prompt files import successfully with no syntax errors
2. All YAML files parse without errors
3. "AVAILABLE TOOLS" appears in auth.py (3x), municipal.py (3x), gbv.py (3x)
4. "NEVER narrate" appears across all prompt files and agents.yaml
5. "phone call verification" hard-block exists in auth.py
6. Manager task YAML no longer has step-by-step delegation instructions
7. No existing prompt content was removed — only appended
</verification>

<success_criteria>
All system prompts and YAML configs hardened with response rules. Auth has tool hard-block preventing hallucinated capabilities. GBV has ultra-strict rules with emergency number mandate. Manager task no longer leaks delegation narration. All files parse/import successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/06.9.1-fix-agent-output-formatting-pydantic-models-auth-otp-tool-failures-and-system-prompt-engineering/06.9.1-01-SUMMARY.md`
</output>
