---
phase: 06.9.1-fix-agent-output-formatting-pydantic-models-auth-otp-tool-failures-and-system-prompt-engineering
plan: 03
subsystem: agents
tags: [crewai, delegation-filtering, sanitization, gbv-safety, pydantic-validation, defense-in-depth]

# Dependency graph
requires:
  - phase: 06.9.1-plan-01
    provides: "Prompt hardening with RESPONSE RULES and tool hard-blocks on all 5 agents"
  - phase: 06.9.1-plan-02
    provides: "AgentResponse Pydantic models, _repair_from_raw(), auth tool failure logging"
provides:
  - "_DELEGATION_ARTIFACT_PATTERNS list (12 patterns) in crew_server.py for sanitize_reply()"
  - "_validate_crew_output() pre-sanitization helper for chat() endpoint"
  - "GBV emergency number safety guarantee in sanitize_reply() (re-adds if stripped)"
  - "_DELEGATION_PATTERNS compiled regexes (12) in manager_crew.py"
  - "ManagerCrew.parse_result() delegation line filter (strips 'As the Manager...', 'Step N:' etc)"
  - "ManagerCrew verbose=False (production mode)"
affects: [crew_server, manager_crew]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Three-layer delegation defense: prompt hardening (Plan 01) + ManagerCrew.parse_result() filter + sanitize_reply() filter"
    - "GBV emergency number re-injection: if stripped by sanitization, re-appended at end"
    - "Pre-sanitization validation: _validate_crew_output() extracts citizen content before sanitize_reply() runs"
    - "Compiled regex delegation patterns in ManagerCrew vs string patterns in crew_server (module-level vs per-call)"

key-files:
  created: []
  modified:
    - src/api/v1/crew_server.py
    - src/agents/crews/manager_crew.py

key-decisions:
  - "GBV emergency number check is agent_name-based (not category-based) — matches the agent_name values 'gbv_intake' and 'gbv' as used in practice"
  - "Step 3.25 (_validate_crew_output) sits between crew kickoff and sanitize_reply() — it is the extraction layer, sanitize_reply() is the cleanup layer"
  - "raw_reply now reads from agent_result['raw_output'] (not the pre-validation reply) for accurate Streamlit debug output"
  - "ManagerCrew verbose=False — testing phase complete, production mode reduces token logging overhead"
  - "_DELEGATION_PATTERNS uses compiled re.compile() objects in manager_crew (faster for repeated use in parse_result); crew_server uses raw strings (matched inline in loops)"

patterns-established:
  - "Three-layer defense: LLM prompt guardrails (layer 0) + ManagerCrew.parse_result() filter (layer 1) + crew_server validation + sanitization (layers 2-3)"
  - "GBV safety guarantee: error fallback always has emergency numbers, AND sanitize_reply() re-injects if missing"

requirements-completed: [AI-01, AI-02, AI-07]

# Metrics
duration: 5.4min
completed: 2026-02-19
---

# Phase 06.9.1 Plan 03: Delegation Text Filtering and Pydantic Validation Layer Summary

**Three-layer defense-in-depth against delegation artifact leakage: compiled regex filters in ManagerCrew.parse_result(), pre-sanitization validation helper in crew_server.py, and GBV emergency number safety guarantee.**

## Performance

- **Duration:** 5.4 min (321s)
- **Started:** 2026-02-19T10:21:46Z
- **Completed:** 2026-02-19T10:27:07Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added `_DELEGATION_ARTIFACT_PATTERNS` (12 patterns) to `crew_server.py` and updated `sanitize_reply()` to check both LLM artifact patterns AND delegation artifact patterns in its line-by-line filter loop
- Added GBV emergency number safety check to `sanitize_reply()`: if sanitization strips the numbers (10111, 0800 150 150) from a GBV response, they are re-appended to guarantee citizen safety
- Added `_validate_crew_output()` as Step 3.25 in the `chat()` endpoint — this is the extraction layer that pulls clean citizen-facing content from delegation-polluted output before `sanitize_reply()` runs
- Added `_DELEGATION_PATTERNS` (12 compiled regexes) to `manager_crew.py` and rewrote `parse_result()` to strip delegation narration lines line-by-line, with warm Gugu fallback if everything is stripped
- Set `verbose=False` in `ManagerCrew` Crew constructor (production mode — testing phase complete)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add delegation artifact patterns to sanitize_reply() and Pydantic validation layer to crew_server.py** - `e544069` (feat)
2. **Task 2: Add delegation text filter to ManagerCrew.parse_result() and set verbose=False** - `022a448` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `src/api/v1/crew_server.py` - Added `_DELEGATION_ARTIFACT_PATTERNS` (12 patterns), updated `sanitize_reply()` line filter to use both pattern lists, added GBV emergency number safety check, added `_validate_crew_output()` helper, integrated Step 3.25 in `chat()` endpoint
- `src/agents/crews/manager_crew.py` - Added `_DELEGATION_PATTERNS` (12 compiled regexes), rewrote `parse_result()` with delegation line filtering and warm fallback, set `verbose=False` in Crew constructor

## Decisions Made

- GBV emergency number check is `agent_name`-based (checks for `"gbv_intake"` and `"gbv"`) to match the actual agent_name values set in practice
- Step 3.25 (`_validate_crew_output`) is the extraction layer before sanitize_reply() — it attempts to rescue citizen-facing content from messages that START with delegation text; sanitize_reply() is the cleanup layer for line-by-line artifact removal
- `raw_reply` in debug output now reads from `agent_result.get("raw_output", reply)` — this captures the actual crew raw output rather than the post-validation reply, giving more useful Streamlit debugging
- `_DELEGATION_PATTERNS` uses compiled `re.compile()` objects in manager_crew (called once per turn in a loop over all lines); crew_server uses raw strings (matched inline via `re.match()` in the loop)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Three-layer delegation defense is now complete: prompt hardening prevents generation (Plan 01), ManagerCrew.parse_result() filters at crew level (this plan), crew_server.py sanitize_reply() filters at API level (this plan)
- GBV emergency numbers are guaranteed regardless of what sanitization removes
- ManagerCrew is now in production mode (verbose=False) — ready for production traffic
- Ready for Phase 06.9.1 Plan 04 (Wave 3 — remaining system prompt engineering work)

---
*Phase: 06.9.1*
*Completed: 2026-02-19*

## Self-Check: PASSED

- FOUND: src/api/v1/crew_server.py (modified — _DELEGATION_ARTIFACT_PATTERNS, _validate_crew_output, GBV safety)
- FOUND: src/agents/crews/manager_crew.py (modified — _DELEGATION_PATTERNS, parse_result delegation filter, verbose=False)
- FOUND commit: e544069 (feat(06.9.1-03): crew_server.py changes)
- FOUND commit: 022a448 (feat(06.9.1-03): manager_crew.py changes)
- All 7 verification checks PASSED
