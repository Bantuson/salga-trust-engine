---
phase: 06.9.1
plan: 01
subsystem: agents/prompts
tags: [prompt-engineering, guardrails, system-prompts, yaml-config, agent-backstory]
dependency_graph:
  requires: []
  provides: [hardened-prompt-guardrails, tool-hard-blocks, structured-output-contracts]
  affects: [auth_crew, municipal_crew, gbv_crew, manager_crew, ticket_status_crew]
tech_stack:
  added: []
  patterns: [appended-guardrail-constants, native-language-rule-equivalents, pydantic-output-contracts]
key_files:
  created: []
  modified:
    - src/agents/prompts/auth.py
    - src/agents/prompts/municipal.py
    - src/agents/prompts/gbv.py
    - src/agents/config/agents.yaml
    - src/agents/config/tasks.yaml
decisions:
  - "Guardrails appended as named constants (_AUTH_TOOL_HARD_BLOCK_EN/ZU/AF) rather than inline — enables isolated testing and future updates"
  - "ZU and AF rule sections use native language equivalents (AMATHULUZI ATHOLAKALAYO, BESKIKBARE GEREEDSKAP, IMITHETHO YEMPENDULO) rather than English section headers — maintains language register consistency"
  - "GBV prompts restructured from inline dict literal to named variables — required to enable appending response rules cleanly"
  - "Manager task STEP 3 updated to remove 'delegate to Citizen Authentication Specialist' text — reduces delegation narration leakage"
  - "Pydantic model names referenced in task expected_output as shape contracts (not actual imports) — YAML-safe, sets LLM output expectations"
metrics:
  duration: 8.9m (535s)
  completed: 2026-02-19
  tasks: 2
  files: 5
---

# Phase 6.9.1 Plan 01: System Prompt Hardening — Universal Guardrails Summary

Hardened all system prompts and YAML agent/task configs to prevent internal reasoning leakage, tool hallucination, and delegation text reaching citizens. Auth prompt now has explicit phone call hard-block; GBV has ultra-strict emergency number mandate; all 5 agent backstories carry universal RESPONSE RULES; manager task delegation narration eliminated.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Add universal guardrails and tool hard-blocks to all prompt files | d9b957a | auth.py, municipal.py, gbv.py |
| 2 | Update agents.yaml and tasks.yaml with universal guardrails and structured output | 41c2786 | agents.yaml, tasks.yaml |

## What Was Built

### Task 1 — Prompt Guardrails (3 files, 9 prompt variants)

**auth.py:**
- Added `_AUTH_TOOL_HARD_BLOCK_EN/ZU/AF` constants at module level
- Appended to `AUTH_PROMPT_EN`, `AUTH_PROMPT_ZU`, `AUTH_PROMPT_AF`
- EN block: exact 4-tool listing (send_otp_tool, verify_otp_tool, create_supabase_user_tool, lookup_user_tool)
- Hard block: "Phone call verification (calling the citizen on the phone)" — explicitly prohibited
- RESPONSE RULES: NEVER narrate, NEVER say Step 1/Step 2, speak directly as friendly human helper

**municipal.py:**
- Added `_MUNICIPAL_RESPONSE_RULES_EN/ZU/AF` constants
- Appended to all 3 language prompt strings
- 1-tool listing: create_municipal_ticket with param summary
- Response rules: narration ban, delegation phrase ban, light formatting guidance

**gbv.py:**
- Refactored from inline dict literal to named variables (`_GBV_INTAKE_PROMPT_EN/ZU/AF`)
- Added `_GBV_RESPONSE_RULES_EN/ZU/AF` constants (ultra-strict)
- 2-tool listing: create_municipal_ticket (category=gbv), notify_saps
- Ultra-strict rules: max 4 questions, emergency numbers in EVERY response, error messages must include emergency numbers
- `GBV_INTAKE_PROMPTS` dict now constructed from named variables post-append

### Task 2 — YAML Configs (2 files, 5 agents, 5 tasks)

**agents.yaml:**
- 5 agent backstories: universal RESPONSE RULES block appended to each
- manager_agent: additional DELEGATION RULES block (delegation should be invisible to citizens)
- All 5 agents: tool comments added (YAML comments, not functional keys)
- manager_agent `verbose: false` was already false — confirmed and preserved

**tasks.yaml:**
- `auth_task` expected_output: AuthResult JSON shape with field list
- `municipal_intake_task` expected_output: MunicipalResponse JSON shape
- `gbv_intake_task` expected_output: GBVResponse JSON shape with emergency number requirement
- `ticket_status_task` expected_output: TicketStatusResponse JSON shape
- `manager_task` STEP 4: removed delegate-to-agent names, replaced with clean routing instruction
- `manager_task` STEP 3: removed `delegate to "Citizen Authentication Specialist"` text
- `manager_task` expected_output: "no routing narration, no delegation description" explicit requirement

## Verification Results

All 7 plan verification criteria passed:
1. Prompt imports: OK (no syntax errors)
2. YAML parse: OK (both files)
3. AVAILABLE TOOLS in all 3 prompt files (EN): confirmed
4. NEVER narrate in all 3 prompt files + agents.yaml: confirmed
5. Phone call verification hard-block in auth.py: confirmed
6. Manager task no step-by-step delegation: confirmed
7. All existing prompt content preserved (not removed): confirmed

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] GBV prompts dict literal incompatible with append pattern**
- **Found during:** Task 1
- **Issue:** `GBV_INTAKE_PROMPTS` was defined as an inline dict literal with string values — impossible to append `_GBV_RESPONSE_RULES` to each value without refactoring
- **Fix:** Extracted each dict value to named variables (`_GBV_INTAKE_PROMPT_EN/ZU/AF`), appended rules to each, then constructed dict from named variables
- **Files modified:** src/agents/prompts/gbv.py
- **Commit:** d9b957a

**2. [Rule 1 - Bug] Manager STEP 3 still referenced "delegate to Citizen Authentication Specialist"**
- **Found during:** Task 2 verification
- **Issue:** The plan specified removing delegation narration from STEP 4 but STEP 3 also contained `delegate to "Citizen Authentication Specialist" FIRST` — would still leak agent role to LLM output
- **Fix:** Updated STEP 3 text from `delegate to "Citizen Authentication Specialist" FIRST` to `route to authentication first`
- **Files modified:** src/agents/config/tasks.yaml
- **Commit:** 41c2786

## Self-Check: PASSED

Files verified (all FOUND):
- src/agents/prompts/auth.py
- src/agents/prompts/municipal.py
- src/agents/prompts/gbv.py
- src/agents/config/agents.yaml
- src/agents/config/tasks.yaml

Commits verified (both in git log):
- d9b957a: feat(06.9.1-01): add universal guardrails and tool hard-blocks to all prompt files
- 41c2786: feat(06.9.1-01): update agents.yaml and tasks.yaml with universal guardrails and structured output
