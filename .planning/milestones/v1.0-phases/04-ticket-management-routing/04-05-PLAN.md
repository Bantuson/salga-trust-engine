---
phase: 04-ticket-management-routing
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - tests/test_routing_service.py
  - tests/test_sla_service.py
  - tests/test_escalation_service.py
  - tests/test_notification_service.py
  - tests/test_assignment_service.py
  - tests/test_tickets_api.py
  - tests/test_gbv_firewall.py
autonomous: true

must_haves:
  truths:
    - "Routing service unit tests verify municipal and GBV routing logic"
    - "SLA service unit tests verify deadline calculation and breach detection"
    - "Escalation service unit tests verify status change and advisory lock behavior"
    - "Notification service unit tests verify trilingual message formatting"
    - "API tests verify RBAC, status transitions, and GBV access controls"
    - "GBV firewall tests verify GBV tickets never route to municipal teams"
    - "All Phase 1-3 tests still pass (no regressions)"
    - "Phase 4 code achieves >= 80% line coverage"
  artifacts:
    - path: "tests/test_routing_service.py"
      provides: "Routing service unit tests"
      contains: "test_route_municipal_ticket"
    - path: "tests/test_sla_service.py"
      provides: "SLA service unit tests"
      contains: "test_calculate_deadlines"
    - path: "tests/test_tickets_api.py"
      provides: "Ticket API endpoint tests"
      contains: "test_update_ticket_status"
    - path: "tests/test_gbv_firewall.py"
      provides: "GBV security boundary tests"
      contains: "test_gbv_ticket_never_assigned_municipal"
  key_links:
    - from: "tests/test_routing_service.py"
      to: "src/services/routing_service.py"
      via: "tests RoutingService with mocked database"
      pattern: "RoutingService"
    - from: "tests/test_gbv_firewall.py"
      to: "src/services/routing_service.py"
      via: "verifies GBV never routes to municipal"
      pattern: "is_saps|gbv"
---

<objective>
Create comprehensive test suite for all Phase 4 code: routing service, SLA service, escalation service, notification service, assignment service, ticket API endpoints, and GBV firewall security boundary. Verify >= 80% coverage and zero regressions.

Purpose: Phase verification policy requires unit tests for every module, >= 80% coverage on phase code, and full regression check across all prior phases. This plan is the testing gate before Phase 4 can be considered complete.

Output: 7 test files covering all Phase 4 functionality. All tests passing, >= 80% coverage, zero regressions.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ticket-management-routing/04-01-SUMMARY.md
@.planning/phases/04-ticket-management-routing/04-02-SUMMARY.md
@.planning/phases/04-ticket-management-routing/04-03-SUMMARY.md
@.planning/phases/04-ticket-management-routing/04-04-SUMMARY.md
@tests/conftest.py
@src/services/routing_service.py
@src/services/sla_service.py
@src/services/escalation_service.py
@src/services/notification_service.py
@src/services/assignment_service.py
@src/api/v1/tickets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for Phase 4 services (routing, SLA, escalation, notification, assignment)</name>
  <files>
    tests/test_routing_service.py
    tests/test_sla_service.py
    tests/test_escalation_service.py
    tests/test_notification_service.py
    tests/test_assignment_service.py
  </files>
  <action>
    Create pure unit tests using mocks (no database required). Follow the established testing pattern from prior phases: mock database sessions, use unittest.mock.AsyncMock for async methods, create fixture objects for models.

    1. Create `tests/test_routing_service.py` (~12-15 tests):
       - `test_route_municipal_ticket_with_location`: Mock DB to return team within radius. Verify team returned.
       - `test_route_municipal_ticket_no_location_fallback`: ticket.location is None. Verify fallback to category-based routing.
       - `test_route_municipal_ticket_no_match`: Mock DB to return empty. Verify None returned.
       - `test_route_gbv_ticket_to_saps`: Mock DB with SAPS team. Verify is_saps=True team returned.
       - `test_route_gbv_ticket_never_municipal`: Ensure query filters is_saps=True. Verify non-SAPS teams never returned.
       - `test_route_gbv_ticket_no_saps_team`: Mock empty result. Verify None returned and warning logged.
       - `test_route_ticket_dispatches_correctly`: Verify GBV goes to _route_gbv_ticket, municipal goes to _route_municipal_ticket.
       - `test_find_teams_near_location`: Verify returns list ordered by distance.

       Mock strategy: Mock AsyncSession.execute() to return mock Result with scalars(). Create mock Team objects with required attributes.

    2. Create `tests/test_sla_service.py` (~10-12 tests):
       - `test_get_sla_config_exact_match`: Category-specific config found.
       - `test_get_sla_config_default_fallback`: No category config, falls back to municipality default (category=None).
       - `test_get_sla_config_system_defaults`: No config at all, returns None (caller uses system defaults).
       - `test_calculate_deadlines_from_config`: Verify deadlines = created_at + config hours.
       - `test_calculate_deadlines_system_defaults`: No config, uses 24h/168h defaults.
       - `test_set_ticket_deadlines_skips_gbv`: is_sensitive=True ticket, verify deadlines NOT set.
       - `test_find_breached_tickets_response_breach`: Ticket open past response deadline.
       - `test_find_breached_tickets_resolution_breach`: Ticket in_progress past resolution deadline.
       - `test_find_breached_tickets_excludes_gbv`: is_sensitive tickets not in results.
       - `test_find_breached_tickets_no_breaches`: All tickets within SLA.
       - `test_find_warning_tickets`: Tickets approaching threshold returned.

       Mock strategy: Create mock Ticket objects with specific created_at, sla_response_deadline, sla_resolution_deadline. Use datetime manipulation.

    3. Create `tests/test_escalation_service.py` (~8-10 tests):
       - `test_escalate_ticket_success`: Lock acquired, ticket escalated to ESCALATED status.
       - `test_escalate_ticket_already_escalated`: Ticket already ESCALATED, returns False.
       - `test_escalate_ticket_lock_not_acquired`: Advisory lock fails, returns False (another worker processing).
       - `test_escalate_ticket_assigns_to_manager`: Verify ticket.assigned_to set to team.manager_id.
       - `test_escalate_ticket_no_manager`: Team has no manager_id, ticket still escalated but assigned_to unchanged.
       - `test_escalate_ticket_sets_escalation_fields`: Verify escalated_at and escalation_reason set.
       - `test_bulk_escalate_counts_correctly`: 3 tickets, 2 escalated, 1 skipped. Verify returns 2.
       - `test_escalate_ticket_creates_assignment_record`: Verify TicketAssignment created with reason="escalation".

       Mock strategy: Mock db.execute for advisory lock (return True/False scalar), mock db.get for ticket load.

    4. Create `tests/test_notification_service.py` (~8-10 tests):
       - `test_send_status_update_english`: Verify correct English message format.
       - `test_send_status_update_zulu`: Verify isiZulu message includes correct status text.
       - `test_send_status_update_afrikaans`: Verify Afrikaans message includes correct status text.
       - `test_send_status_update_no_twilio_client`: No credentials configured, returns None without error.
       - `test_send_status_update_twilio_error`: TwilioRestException raised, returns None and logs error.
       - `test_status_display_text_all_statuses`: Verify all 5 statuses have display text in all 3 languages.
       - `test_send_escalation_notice`: Verify escalation-specific message sent.
       - `test_send_sla_warning_logs_only`: Verify warning logged, no WhatsApp sent.

       Mock strategy: Mock Twilio Client.messages.create(). Verify call args contain correct body/to/from.

    5. Create `tests/test_assignment_service.py` (~8-10 tests):
       - `test_assign_ticket_creates_record`: New assignment created with is_current=True.
       - `test_assign_ticket_deactivates_previous`: Previous assignment set to is_current=False.
       - `test_assign_ticket_updates_ticket`: ticket.assigned_team_id and assigned_to updated.
       - `test_assign_ticket_sets_first_responded_at`: If assigned_to set and status is open, first_responded_at set.
       - `test_assign_ticket_preserves_first_responded_at`: If already responded, first_responded_at not overwritten.
       - `test_auto_route_and_assign_with_match`: RoutingService finds team, assignment created.
       - `test_auto_route_and_assign_no_match`: RoutingService returns None, no assignment.
       - `test_reassign_ticket_gbv_guard`: GBV ticket reassigned to non-SAPS team raises ValueError.
       - `test_reassign_ticket_gbv_to_saps`: GBV ticket reassigned to SAPS team succeeds.
       - `test_get_assignment_history`: Returns all assignments ordered by created_at desc.

       Mock strategy: Mock db session, RoutingService.route_ticket, create mock TicketAssignment objects.

    IMPORTANT testing patterns:
    - Use `@pytest.mark.asyncio` for all async tests (or module-level pytestmark)
    - Use `unittest.mock.AsyncMock` for async mocked methods
    - Use `unittest.mock.MagicMock` for sync mocked objects
    - Create helper factories for mock models: `make_mock_ticket(category="water", is_sensitive=False, ...)`
    - Do NOT import geoalchemy2 in tests that don't need it -- mock the Geometry-related calls
    - Follow existing test patterns from tests/test_whatsapp_service.py and tests/test_storage_service.py
  </action>
  <verify>
    Run `pytest tests/test_routing_service.py tests/test_sla_service.py tests/test_escalation_service.py tests/test_notification_service.py tests/test_assignment_service.py -v` -- all tests pass.
    Count total new tests (target: 46-57 tests across 5 files).
    Run `pytest tests/ -x -m "not integration" -q` to confirm no regressions across ALL phases.
  </verify>
  <done>
    5 test files with 46-57 unit tests covering all Phase 4 services. GBV firewall verified in routing, assignment, and escalation tests. All tests pass, zero regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API tests, GBV firewall tests, and verify coverage</name>
  <files>
    tests/test_tickets_api.py
    tests/test_gbv_firewall.py
  </files>
  <action>
    1. Create `tests/test_tickets_api.py` (~12-15 tests):
       Use FastAPI TestClient with dependency overrides (same pattern as tests/test_reports_api.py).

       - `test_list_tickets_manager_role`: Manager sees non-sensitive tickets.
       - `test_list_tickets_saps_liaison_sees_gbv_only`: SAPS liaison only sees is_sensitive=True tickets.
       - `test_list_tickets_citizen_forbidden`: Citizens cannot access /tickets/ list. Returns 403.
       - `test_list_tickets_filter_by_status`: ?status=open returns only open tickets.
       - `test_list_tickets_filter_by_category`: ?category=water returns only water tickets.
       - `test_get_ticket_detail_owner`: Citizen can see their own ticket detail.
       - `test_get_ticket_detail_manager`: Manager can see any non-sensitive ticket.
       - `test_get_ticket_detail_gbv_saps_only`: GBV ticket returns 403 for manager, 200 for SAPS liaison.
       - `test_update_ticket_status`: Manager updates status from open to in_progress.
       - `test_update_ticket_status_invalid_transition`: closed -> in_progress rejected (or per rules).
       - `test_update_ticket_status_triggers_notification`: Verify send_status_notification.delay called.
       - `test_assign_ticket_auto_route`: POST /tickets/{id}/assign with team_id=None triggers auto-routing.
       - `test_assign_ticket_manual`: POST /tickets/{id}/assign with team_id set creates assignment.
       - `test_get_ticket_history`: Returns assignment history for ticket.

       Mock strategy: Override get_current_user to return mock users with different roles. Override get_db to return mock session. Mock AssignmentService, SLAService, send_status_notification.

    2. Create `tests/test_gbv_firewall.py` (~8-10 security-focused tests):
       This is the SEC-05 compliance test file. Tests that GBV data is NEVER accessible to unauthorized roles.

       - `test_gbv_ticket_not_in_municipal_list`: List tickets with MANAGER role, GBV tickets not present.
       - `test_gbv_ticket_403_for_citizen`: Citizen tries to access GBV ticket detail, gets 403.
       - `test_gbv_ticket_403_for_manager`: Manager tries to access GBV ticket detail, gets 403.
       - `test_gbv_ticket_403_for_field_worker`: Field worker tries to access GBV ticket detail, gets 403.
       - `test_gbv_ticket_200_for_saps_liaison`: SAPS liaison can access GBV ticket, gets 200.
       - `test_gbv_ticket_200_for_admin`: Admin can access GBV ticket, gets 200.
       - `test_gbv_routing_never_municipal_team`: Route GBV ticket, verify only SAPS teams considered.
       - `test_gbv_reassign_to_municipal_rejected`: Reassign GBV ticket to non-SAPS team raises error.
       - `test_gbv_ticket_excluded_from_sla`: GBV ticket not returned by find_breached_tickets.

       IMPORTANT: These are SECURITY tests. They verify the SEC-05 boundary at every layer:
       - Routing layer (routing_service)
       - Assignment layer (assignment_service)
       - API layer (tickets endpoints)
       - SLA layer (excluded from monitoring)
       Each test should have a comment explaining what security boundary it tests.

    3. Run coverage report:
       After all tests pass, run:
       `pytest tests/ -m "not integration" --cov=src --cov-report=term-missing -q`

       Phase 4 files to verify coverage on:
       - src/services/routing_service.py >= 80%
       - src/services/sla_service.py >= 80%
       - src/services/escalation_service.py >= 80%
       - src/services/notification_service.py >= 80%
       - src/services/assignment_service.py >= 80%
       - src/api/v1/tickets.py >= 80%
       - src/models/team.py >= 80%
       - src/models/assignment.py >= 80%
       - src/models/sla_config.py >= 80%
       - src/tasks/sla_monitor.py (may be < 80% since it uses asyncio.run in Celery - acceptable)
       - src/tasks/status_notify.py (may be < 80% for same reason)

       If coverage is below 80% on any critical file, add targeted tests to fill gaps.

    4. Run full regression check:
       `pytest tests/ -m "not integration" -q`
       ALL tests from Phase 1, 2, 3, and 4 must pass.
  </action>
  <verify>
    Run `pytest tests/test_tickets_api.py tests/test_gbv_firewall.py -v` -- all tests pass.
    Run `pytest tests/ -m "not integration" -q` -- ALL tests pass (Phase 1-4).
    Run `pytest tests/ -m "not integration" --cov=src --cov-report=term-missing -q` -- verify >= 80% on Phase 4 files.
    Count total tests (should be 200+ including prior phases).
  </verify>
  <done>
    Phase 4 test suite complete: 7 test files, 66-82 new tests. GBV firewall verified at every layer (routing, assignment, API, SLA). Coverage >= 80% on Phase 4 code. All Phase 1-3 tests still pass. Zero regressions.
  </done>
</task>

</tasks>

<verification>
1. All Phase 4 test files exist and tests pass
2. GBV firewall tests verify SEC-05 at routing, assignment, API, and SLA layers
3. Coverage >= 80% on Phase 4 source files
4. Full regression: all Phase 1-4 tests pass
5. Test count: 200+ total (including prior phases)
</verification>

<success_criteria>
- 7 test files with 66-82 new tests
- SEC-05 firewall verified at every layer
- Phase 4 code >= 80% line coverage
- Zero regressions (all Phase 1-3 tests pass)
- Total test suite: 200+ tests, all passing
</success_criteria>

<output>
After completion, create `.planning/phases/04-ticket-management-routing/04-05-SUMMARY.md`
</output>
