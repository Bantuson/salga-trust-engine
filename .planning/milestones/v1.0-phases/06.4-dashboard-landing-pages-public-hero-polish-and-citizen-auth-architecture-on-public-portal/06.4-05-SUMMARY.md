---
phase: 06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal
plan: 05
subsystem: frontend-public
tags: [routing, authentication, protected-routes, header-auth-state]

dependency_graph:
  requires:
    - citizen_auth_context (from 06.4-01)
    - useAuth_hook (from 06.4-01)
    - protected_route_wrapper (from 06.4-01)
  provides:
    - auth_gated_routing
    - authenticated_header_ui
    - user_menu_dropdown
    - protected_citizen_routes
  affects:
    - frontend-public/src/App.tsx
    - frontend-public/src/components/layout/PublicHeader.tsx
    - future Plan 04 (will replace placeholder login/register pages)
    - future Plan 06 (will replace placeholder report page)
    - future Plan 07 (will replace placeholder profile page)

tech_stack:
  added:
    - "React Router protected route pattern"
    - "Conditional header rendering based on auth state"
  patterns:
    - "AuthProvider wrapping entire app at BrowserRouter level"
    - "ProtectedRoute wrapper for auth-gated pages"
    - "Conditional UI rendering (authenticated vs unauthenticated)"
    - "Click-outside handler for dropdown menus"
    - "Placeholder pages for future implementation"

key_files:
  created:
    - frontend-public/src/pages/CitizenLoginPage.tsx
    - frontend-public/src/pages/CitizenRegisterPage.tsx
    - frontend-public/src/pages/ReportIssuePage.tsx
    - frontend-public/src/pages/ProfilePage.tsx
  modified:
    - frontend-public/src/App.tsx
    - frontend-public/src/components/layout/PublicHeader.tsx
    - frontend-public/src/App.css

decisions:
  - decision: "Keep existing My Reports nav link in unauthenticated state"
    rationale: "Per user decision - My Reports acts as auth gateway (clicking when not logged in triggers redirect to /login)"
    alternatives: ["Remove My Reports from unauthenticated nav", "Replace with Login button"]
    chosen: "Keep My Reports - it's the primary entry point for citizen features"

  - decision: "Hide mobile Report Issue CTA when authenticated"
    rationale: "Report Issue is in the dropdown menu for authenticated users. Showing both is redundant."
    alternatives: ["Show CTA always", "Replace CTA with user menu button"]
    chosen: "Hide CTA when authenticated - cleaner mobile UX"

  - decision: "Create placeholder pages for login/register/report/profile"
    rationale: "Plans 04, 06, 07 will implement these pages. Placeholders allow routing to work now without blocking progress."
    alternatives: ["Wait for full implementation before adding routes", "Use 404 pages"]
    chosen: "Placeholders - shows user intent, TypeScript-safe, easy to replace"

metrics:
  duration_seconds: 193
  duration_minutes: 3.2
  tasks_completed: 2
  files_created: 4
  files_modified: 3
  commits: 2
  completed_at: "2026-02-13T09:59:58Z"
---

# Phase 06.4 Plan 05: Auth-Gated Routing and Authenticated Header Summary

**One-liner:** Updated App.tsx with AuthProvider and ProtectedRoute wrappers, added authenticated header state with user menu dropdown

## Overview

Connected the auth infrastructure (Plan 01) into the application routing and UI. App.tsx now wraps all routes in AuthProvider, splits routes into public (always accessible), auth pages (login/register), and protected pages (require citizen login). PublicHeader adapts to show a user menu dropdown when authenticated on desktop, and user identity + auth links on mobile.

This plan creates the full auth-gated architecture that future plans will build upon. Login/register pages (Plan 04), report page (Plan 06), and profile page (Plan 07) will replace the placeholder pages created here.

## Tasks Completed

### Task 1: Update App.tsx with AuthProvider and protected routes

**Status:** ✅ Complete
**Commit:** `c96e1f6` - feat(06.4-05): update App.tsx with AuthProvider and protected routes

**What was done:**
- Updated `frontend-public/src/App.tsx`:
  - Added imports: `AuthProvider`, `ProtectedRoute`, `CitizenLoginPage`, `CitizenRegisterPage`, `ReportIssuePage`, `ProfilePage`
  - Removed import: `ReportRedirectPage` (route replaced, file stays on disk)
  - Wrapped in AuthProvider: `<BrowserRouter>` → `<AuthProvider>` → `<LenisProvider>` → routes
  - Updated routes:
    - **Public pages:** `/`, `/dashboard`, `/about` - always accessible
    - **Auth pages:** `/login`, `/register` - publicly accessible
    - **Protected pages:** `/my-reports`, `/report`, `/profile` - wrapped in `<ProtectedRoute>`
    - **Catch-all:** `*` → redirect to `/`
  - Updated JSDoc comment to reflect auth architecture

- Created placeholder pages (to be replaced in future plans):
  - `frontend-public/src/pages/CitizenLoginPage.tsx` - Plan 04 will implement
  - `frontend-public/src/pages/CitizenRegisterPage.tsx` - Plan 04 will implement
  - `frontend-public/src/pages/ReportIssuePage.tsx` - Plan 06 will implement
  - `frontend-public/src/pages/ProfilePage.tsx` - Plan 07 will implement
  - All placeholders use GlassCard with "coming soon" message

**Verification:**
- ✅ TypeScript compiles with `npx tsc --noEmit` (zero errors)
- ✅ App.tsx has AuthProvider wrapping routes
- ✅ /my-reports, /report, /profile wrapped in ProtectedRoute
- ✅ /login and /register routes exist

**Files:**
- `frontend-public/src/App.tsx` (modified)
- `frontend-public/src/pages/CitizenLoginPage.tsx` (created)
- `frontend-public/src/pages/CitizenRegisterPage.tsx` (created)
- `frontend-public/src/pages/ReportIssuePage.tsx` (created)
- `frontend-public/src/pages/ProfilePage.tsx` (created)

---

### Task 2: Add authenticated header state with user menu dropdown

**Status:** ✅ Complete
**Commit:** `6bae380` - feat(06.4-05): add authenticated header state with user menu dropdown

**What was done:**
- Updated `frontend-public/src/components/layout/PublicHeader.tsx`:
  - Added imports: `useAuth` from `../../hooks/useAuth`
  - Added state: `isUserMenuOpen` (for dropdown), `user` and `signOut` from useAuth
  - Added useEffect: click-outside handler to close dropdown when clicking outside `.header-user-menu-wrapper`

  - **Desktop header (authenticated state):**
    - Replace "Report Issue" Button with user menu
    - User button shows: avatar (first letter of name/email), name, dropdown chevron
    - Dropdown shows: My Reports, Profile, Report Issue, divider, Sign Out
    - Clicking dropdown item closes dropdown
    - Sign Out calls `signOut()` and closes dropdown
    - User button styling: pink frost background, coral border, hover effect

  - **Desktop header (unauthenticated state):**
    - Existing "Report Issue" Button unchanged

  - **Mobile menu (authenticated state):**
    - User identity block at top: avatar + name
    - Existing nav links: Home, Dashboard, About, My Reports
    - Auth-specific links: Profile
    - Divider
    - Sign Out button (coral color)
    - Hide mobile "Report Issue" CTA (redundant when authenticated)

  - **Mobile menu (unauthenticated state):**
    - Existing mobile menu unchanged
    - "Report Issue" CTA at bottom

- Updated `frontend-public/src/App.css`:
  - Added `.header-user-menu-wrapper` - relative positioning for dropdown
  - Added `.header-user-button` - pink frost button with avatar, name, chevron
  - Added `.user-avatar` - 28px circle with gradient background, white text
  - Added `.user-name` - max-width 120px, ellipsis overflow
  - Added `.header-user-dropdown` - absolute positioned, glassmorphism card, z-index 100
  - Added `.dropdown-item` - padding, hover effect (pink frost)
  - Added `.dropdown-divider` - 1px white border-top
  - Added `.dropdown-signout` - coral color
  - Added `.mobile-user-identity` - flex layout with avatar + name
  - Added `.mobile-user-name` - font styling
  - Added `.mobile-nav-divider` - 1px white border-top
  - Added `.mobile-signout` - coral color, full width, left-aligned

**Verification:**
- ✅ TypeScript compiles with `npx tsc --noEmit` (zero errors)
- ✅ PublicHeader imports useAuth and shows different UI based on user state
- ✅ Dropdown contains My Reports, Profile, Report Issue, Sign Out items
- ✅ App.css has .header-user-dropdown and .mobile-user-identity styles
- ✅ Mobile menu shows user avatar and name when authenticated

**Files:**
- `frontend-public/src/components/layout/PublicHeader.tsx` (modified)
- `frontend-public/src/App.css` (modified)

---

## Deviations from Plan

None - plan executed exactly as written.

---

## Verification Results

**Overall verification (Plan success criteria):**

1. ✅ TypeScript compiles with zero errors (`npx tsc --noEmit` in frontend-public)
2. ✅ App.tsx has AuthProvider wrapping routes
3. ✅ /my-reports, /report, /profile wrapped in ProtectedRoute
4. ✅ /login and /register routes exist
5. ✅ PublicHeader shows user dropdown when authenticated (desktop)
6. ✅ Mobile hamburger menu shows user avatar, Profile link, Sign Out when authenticated
7. ✅ Clicking "My Reports" when not logged in will redirect to /login (ProtectedRoute behavior)

**Success criteria (from plan):**
- ✅ AuthProvider wraps entire app providing session state
- ✅ Public pages always accessible, protected pages redirect to login
- ✅ Desktop header adapts to show user menu dropdown when logged in
- ✅ Mobile hamburger menu shows user identity and auth links when logged in
- ✅ Navigation between public and protected pages works seamlessly

---

## Self-Check: PASSED

**Created files exist:**
```
✅ FOUND: frontend-public/src/pages/CitizenLoginPage.tsx
✅ FOUND: frontend-public/src/pages/CitizenRegisterPage.tsx
✅ FOUND: frontend-public/src/pages/ReportIssuePage.tsx
✅ FOUND: frontend-public/src/pages/ProfilePage.tsx
```

**Commits exist:**
```
✅ FOUND: c96e1f6 (Task 1)
✅ FOUND: 6bae380 (Task 2)
```

**Key changes verified:**
```
✅ App.tsx wrapped in AuthProvider
✅ Protected routes use ProtectedRoute wrapper
✅ PublicHeader imports useAuth
✅ User menu dropdown renders when authenticated
✅ Mobile menu shows user identity when authenticated
✅ App.css has user menu styles
```

---

## Next Steps

This plan provides the auth-gated routing and authenticated header UI. Subsequent plans will:

1. **Plan 04** - Replace CitizenLoginPage and CitizenRegisterPage placeholders with full email/phone/OTP authentication
2. **Plan 06** - Replace ReportIssuePage placeholder with full report submission form
3. **Plan 07** - Replace ProfilePage placeholder with citizen profile management

**User flow after completion:**
1. Unauthenticated user clicks "My Reports" → redirected to /login (ProtectedRoute)
2. User logs in → redirected back to /my-reports (return URL preservation from Plan 01)
3. Header updates to show user menu dropdown (avatar, name)
4. User can access My Reports, Report Issue, Profile from dropdown
5. User clicks Sign Out → session cleared, header reverts to unauthenticated state

**Architectural note:** The dual-state header (authenticated vs unauthenticated) is a clean pattern. No conditional logic in routes - ProtectedRoute handles auth gates. Header adapts automatically based on `user` from useAuth. Mobile and desktop UX are both first-class (not "mobile as afterthought").

---

## Technical Notes

### Pattern: Authenticated Header UI

**Desktop:**
- Unauthenticated: existing nav + "Report Issue" CTA
- Authenticated: existing nav + user menu dropdown (avatar, name, dropdown with links)

**Mobile:**
- Unauthenticated: hamburger → full-screen overlay → nav links + "Report Issue" CTA
- Authenticated: hamburger → full-screen overlay → user identity block + nav links + Profile + Sign Out

This pattern gives mobile users the same capabilities as desktop users without cramming UI into a small dropdown.

### Pattern: Placeholder Pages

Creating placeholder pages for future plans allows:
- Routes to be defined now (TypeScript-safe imports)
- Navigation to work immediately (no 404s)
- Easy replacement (Plans 04, 06, 07 just update the file contents)
- Clear separation of concerns (routing vs implementation)

The placeholders use GlassCard for visual consistency and show "coming soon" messages so users know it's intentional (not broken).

### Pattern: Click-Outside Handler

```typescript
useEffect(() => {
  const handleClickOutside = (e: MouseEvent) => {
    if (isUserMenuOpen && !(e.target as Element)?.closest('.header-user-menu-wrapper')) {
      setIsUserMenuOpen(false);
    }
  };
  document.addEventListener('click', handleClickOutside);
  return () => document.removeEventListener('click', handleClickOutside);
}, [isUserMenuOpen]);
```

This pattern:
- Only adds listener when dropdown is open (performance)
- Uses `.closest()` to check if click is inside wrapper (handles nested elements)
- Cleans up listener on unmount (no memory leaks)
- Re-runs only when `isUserMenuOpen` changes (stable)

### Auth Gate Behavior

When unauthenticated user clicks "My Reports" or "Report Issue":
1. ProtectedRoute checks `user` from useAuth → null
2. Stores current URL in sessionStorage as `returnUrl`
3. Redirects to `/login` with `state={{ from: location }}`
4. Login page (Plan 04) will read return URL and redirect after successful login
5. User lands on originally requested page

This creates a seamless "gateway" UX where protected pages are discoverable but gated.

---

**Completed:** 2026-02-13T09:59:58Z
**Duration:** 3.2 minutes (193 seconds)
**Tasks:** 2/2 (100%)
**Commits:** 2 (c96e1f6, 6bae380)
