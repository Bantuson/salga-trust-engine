---
phase: 06.4-dashboard-landing-pages-public-hero-polish-and-citizen-auth-architecture-on-public-portal
plan: 01
subsystem: frontend-public
tags: [authentication, infrastructure, citizen-portal, supabase-auth]

dependency_graph:
  requires: []
  provides:
    - citizen_auth_context
    - useAuth_hook
    - protected_route_wrapper
    - supabase_session_persistence
  affects:
    - frontend-public/src/App.tsx (will wrap with AuthProvider)
    - future login/register pages (will consume useAuth)
    - future protected routes (will use ProtectedRoute)

tech_stack:
  added:
    - "@supabase/supabase-js auth state management"
    - "React Context API for auth state"
    - "sessionStorage for return URL persistence"
  patterns:
    - "Context provider pattern for global auth state"
    - "Hook re-export pattern (hooks/ imports from contexts/)"
    - "Protected route wrapper with return URL preservation"

key_files:
  created:
    - frontend-public/src/contexts/AuthContext.tsx
    - frontend-public/src/hooks/useAuth.ts
    - frontend-public/src/components/auth/ProtectedRoute.tsx
  modified:
    - frontend-public/src/lib/supabase.ts
    - .gitignore

decisions:
  - decision: "Enable session persistence on public portal Supabase client"
    rationale: "Citizens need to stay logged in across page refreshes. Backward-compatible - anon queries still work."
    alternatives: ["Keep persistSession: false, require re-login on refresh"]
    chosen: "persistSession: true + autoRefreshToken: true"

  - decision: "Store return URL in both sessionStorage and React Router state"
    rationale: "React Router state is lost on page refresh. sessionStorage survives refresh for better UX."
    alternatives: ["Only React Router state", "Only sessionStorage"]
    chosen: "Both - sessionStorage as fallback, state as primary"

  - decision: "Add .gitignore exceptions for frontend lib/ folders"
    rationale: "Python lib/ exclusion was blocking Supabase client files. Matches shared/lib/ exception pattern."
    alternatives: ["Rename src/lib/ to src/config/", "Force add with -f flag"]
    chosen: "Add !frontend-public/src/lib/ and !frontend-dashboard/src/lib/ exceptions"

metrics:
  duration_seconds: 180
  duration_minutes: 3.0
  tasks_completed: 2
  files_created: 3
  files_modified: 2
  commits: 2
  completed_at: "2026-02-13T11:50:51Z"
---

# Phase 06.4 Plan 01: Citizen Auth Infrastructure Summary

**One-liner:** React Context auth infrastructure with email/phone/OTP methods, session persistence, and protected route wrapper for citizen portal

## Overview

Built the foundational authentication layer for the public portal (frontend-public), enabling citizen login/registration and protected routes. Reused the proven pattern from the municipal dashboard while adapting it for citizen use cases (citizen registration with metadata, dual auth methods).

The Supabase client now supports both anonymous public queries AND authenticated citizen sessions - a dual-purpose design that's backward-compatible with existing public dashboard features.

## Tasks Completed

### Task 1: Update Supabase client + Create AuthContext provider and useAuth hook

**Status:** ✅ Complete
**Commit:** `09b46d3` - feat(06.4-01): enable citizen auth infrastructure on public portal

**What was done:**
- Updated `frontend-public/src/lib/supabase.ts`:
  - Changed `persistSession: false` → `persistSession: true`
  - Changed `autoRefreshToken: false` → `autoRefreshToken: true`
  - Added `detectSessionInUrl: true` for OAuth/magic link flows
  - Added env var validation (throw Error if missing)
  - Updated JSDoc to reflect dual-purpose: public queries + citizen auth

- Created `frontend-public/src/contexts/AuthContext.tsx`:
  - AuthProvider component with React Context API
  - State management: `user`, `session`, `loading`
  - Auth methods: `signInWithEmail`, `signInWithPhone`, `verifyOtp`, `signUp` (with metadata), `signOut`
  - useEffect hook: calls `getSession()` on mount, subscribes to `onAuthStateChange`
  - Cleanup: unsubscribe on unmount
  - `signOut` clears sessionStorage and resets state
  - `signUp` accepts optional metadata (`full_name`, `phone`) passed to Supabase user metadata

- Created `frontend-public/src/hooks/useAuth.ts`:
  - Thin re-export wrapper: `export { useAuth } from '../contexts/AuthContext'`
  - Allows components to import from hooks/ (consistent with dashboard pattern)

**Verification:**
- ✅ TypeScript compiles with `npx tsc --noEmit` (zero errors)
- ✅ All three files exist with correct exports
- ✅ supabase.ts has `persistSession: true`
- ✅ AuthContext exports `AuthProvider` and `useAuth`

**Files:**
- `frontend-public/src/lib/supabase.ts` (modified)
- `frontend-public/src/contexts/AuthContext.tsx` (created)
- `frontend-public/src/hooks/useAuth.ts` (created)

---

### Task 2: Create ProtectedRoute wrapper with return URL preservation

**Status:** ✅ Complete
**Commit:** `6a8ca84` - feat(06.4-01): add ProtectedRoute wrapper with return URL preservation

**What was done:**
- Created `frontend-public/src/components/auth/ProtectedRoute.tsx`:
  - Accepts `children: React.ReactNode` prop
  - Uses `useAuth()` to get `user` and `loading` state
  - Uses `useLocation()` from react-router-dom to get current pathname
  - **Loading state:** Renders centered spinner (48px, teal border-top, matches dashboard pattern)
  - **Not authenticated:**
    - Stores `location.pathname + location.search` in sessionStorage as `returnUrl`
    - Returns `<Navigate to="/login" state={{ from: location }} replace />`
  - **Authenticated:** Renders `<>{children}</>`

**Design decisions:**
- Dual return URL storage (sessionStorage + React Router state) ensures URL survives page refresh
- Login page will read from both sources (state first, sessionStorage as fallback)
- Auth gate happens once per session (per user requirement) - after login, ProtectedRoute passes through

**Verification:**
- ✅ TypeScript compiles with `npx tsc --noEmit` (zero errors)
- ✅ File exists at correct path
- ✅ Exports `ProtectedRoute` function component
- ✅ Uses `Navigate` with `state={{ from: location }}`

**Files:**
- `frontend-public/src/components/auth/ProtectedRoute.tsx` (created)

---

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking Issue] Fixed .gitignore blocking frontend lib/ folders**
- **Found during:** Task 1 staging
- **Issue:** `git add` failed with "The following paths are ignored by one of your .gitignore files: frontend-public/src/lib" - Python lib/ exclusion was blocking Supabase client files
- **Fix:** Added exceptions `!frontend-public/src/lib/` and `!frontend-dashboard/src/lib/` to .gitignore (matches existing `!shared/lib/` pattern from Phase 06.2-01)
- **Files modified:** `.gitignore` (lines 19-20)
- **Commit:** Included in Task 1 commit `09b46d3`
- **Rationale:** Blocking issue preventing task completion. Frontend lib/ folders contain source code (Supabase client config), not Python packages. Exception pattern already established for shared/.

---

## Verification Results

**Overall verification (Plan success criteria):**

1. ✅ TypeScript compiles with zero errors (`npx tsc --noEmit` in frontend-public)
2. ✅ All four files exist with correct exports:
   - `frontend-public/src/lib/supabase.ts` - exports `supabase` client
   - `frontend-public/src/contexts/AuthContext.tsx` - exports `AuthProvider` and `useAuth`
   - `frontend-public/src/hooks/useAuth.ts` - re-exports `useAuth`
   - `frontend-public/src/components/auth/ProtectedRoute.tsx` - exports `ProtectedRoute`
3. ✅ supabase.ts has `persistSession: true` (line 28)
4. ✅ AuthContext.tsx has `AuthProvider` and `useAuth` exports
5. ✅ ProtectedRoute.tsx uses `Navigate` with `state={{ from: location }}` (line 51)

**Success criteria (from plan):**
- ✅ Citizen auth infrastructure is ready for login/register pages to consume
- ✅ ProtectedRoute wrapper is ready to gate My Reports, Report Issue, and Profile routes
- ✅ Supabase client supports both anonymous public queries and authenticated citizen sessions
- ✅ Pattern matches municipal dashboard auth architecture for consistency

---

## Self-Check: PASSED

**Created files exist:**
```
✅ FOUND: frontend-public/src/contexts/AuthContext.tsx
✅ FOUND: frontend-public/src/hooks/useAuth.ts
✅ FOUND: frontend-public/src/components/auth/ProtectedRoute.tsx
```

**Commits exist:**
```
✅ FOUND: 09b46d3 (Task 1)
✅ FOUND: 6a8ca84 (Task 2)
```

**Key exports verified:**
```
✅ persistSession: true in supabase.ts
✅ AuthProvider and useAuth in AuthContext.tsx
✅ ProtectedRoute in ProtectedRoute.tsx
✅ Navigate with state={{ from: location }} in ProtectedRoute.tsx
```

---

## Next Steps

This plan provides the auth foundation. Subsequent plans will:

1. **Wrap App.tsx with AuthProvider** - Make auth context available to entire app
2. **Create Login page** - Consume useAuth hook for signInWithEmail/signInWithPhone
3. **Create Register page** - Consume useAuth hook for signUp with metadata
4. **Gate citizen routes** - Wrap My Reports, Report Issue, Profile with `<ProtectedRoute>`
5. **Add return URL redirect** - Login page reads sessionStorage and redirects after success

**Architectural note:** The dual-purpose Supabase client (anon queries + citizen auth) is a clean design. Existing public dashboard features (heatmap, stats, municipality selector) continue to work unchanged. Authenticated citizen features (My Reports, Report Issue) will use the same client with user context.

---

## Technical Notes

### Pattern: Hook Re-export
```typescript
// frontend-public/src/hooks/useAuth.ts
export { useAuth } from '../contexts/AuthContext';
```

This pattern allows:
- Implementation in `contexts/` (colocated with AuthProvider)
- Imports from `hooks/` (consistent API across dashboard and public portal)
- Single source of truth (no duplication)

### Pattern: Dual Return URL Storage
```typescript
// Store in both locations
sessionStorage.setItem('returnUrl', location.pathname + location.search);
return <Navigate to="/login" state={{ from: location }} replace />;

// Login page will check both:
// 1. location.state?.from (survives initial redirect, lost on refresh)
// 2. sessionStorage.getItem('returnUrl') (survives refresh)
```

### Backward Compatibility
The supabase.ts change from `persistSession: false` to `persistSession: true` is backward-compatible:
- Anonymous queries (current public dashboard) still work - RLS policies allow anon role
- Authenticated queries (future citizen features) now work - user context available
- No breaking changes to existing components

---

**Completed:** 2026-02-13T11:50:51Z
**Duration:** 3.0 minutes (180 seconds)
**Tasks:** 2/2 (100%)
**Commits:** 2 (09b46d3, 6a8ca84)
