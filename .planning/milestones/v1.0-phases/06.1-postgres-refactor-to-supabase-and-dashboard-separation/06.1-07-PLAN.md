---
phase: 06.1-postgres-refactor-to-supabase-and-dashboard-separation
plan: 07
type: execute
wave: 5
depends_on: ["06.1-02", "06.1-03", "06.1-04", "06.1-05", "06.1-06"]
files_modified:
  - tests/conftest.py
  - tests/test_supabase_auth.py
  - tests/test_supabase_storage.py
  - tests/test_supabase_realtime.py
  - tests/test_rls_policies.py
  - tests/test_whatsapp_session.py
  - tests/test_public_dashboard_supabase.py
autonomous: false

must_haves:
  truths:
    - "All existing 338 tests still pass (no regressions from migration)"
    - "Supabase Auth integration has unit tests (register, login, OTP, JWT verification)"
    - "Supabase Storage migration has unit tests (upload, signed URL, GBV bucket)"
    - "RLS policy migration has unit tests (tenant isolation, role-based access, GBV firewall)"
    - "WhatsApp session model has unit tests (create, lookup, expiry)"
    - "Public dashboard Supabase queries have unit tests (stats, heatmap, GBV exclusion)"
    - "Both frontend apps build successfully"
    - "GBV firewall verified at all new layers (storage RLS, database RLS, public views)"
  artifacts:
    - path: "tests/test_supabase_auth.py"
      provides: "Auth migration test suite"
      contains: "verify_supabase_token"
    - path: "tests/test_rls_policies.py"
      provides: "RLS policy verification tests"
      contains: "tenant_isolation"
    - path: "tests/test_whatsapp_session.py"
      provides: "WhatsApp session model tests"
      contains: "WhatsAppSession"
  key_links:
    - from: "tests/conftest.py"
      to: "src/core/supabase.py"
      via: "Mock Supabase clients for testing"
      pattern: "mock.*supabase"
---

<objective>
Update test suite for Supabase migration: fix broken tests from auth/storage/realtime changes, add new tests for Supabase-specific functionality (JWT verification, storage buckets, RLS policies, WhatsApp sessions), verify both frontend apps build, and run full regression suite.

Purpose: Ensure the migration hasn't broken anything and all new Supabase integrations are tested. This is the final quality gate before Phase 06.1 is complete.

Output: All tests pass, both frontends build, GBV firewall verified at all layers.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-CONTEXT.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-02-SUMMARY.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-03-SUMMARY.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-04-SUMMARY.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-05-SUMMARY.md
@.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-06-SUMMARY.md
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix broken tests and add Supabase-specific test suite</name>
  <files>
    tests/conftest.py
    tests/test_supabase_auth.py
    tests/test_supabase_storage.py
    tests/test_supabase_realtime.py
    tests/test_rls_policies.py
    tests/test_whatsapp_session.py
    tests/test_public_dashboard_supabase.py
  </files>
  <action>
    **Step 1: Update tests/conftest.py**
    - Add mock Supabase clients: patch src.core.supabase module to return Mock objects
    - Mock supabase_admin.auth.admin (for create_user, sign_in_with_password, etc.)
    - Mock supabase_admin.storage.from_() (for upload, create_signed_url)
    - Keep existing SQLite/PostgreSQL test database fixtures
    - Add fixture for creating Supabase-style JWT tokens for testing:
      ```python
      @pytest.fixture
      def supabase_jwt_token():
          """Create a test JWT mimicking Supabase token structure."""
          import jwt
          payload = {
              "sub": str(uuid4()),
              "aud": "authenticated",
              "role": "authenticated",
              "app_metadata": {
                  "role": "citizen",
                  "tenant_id": str(uuid4()),
              },
              "exp": datetime.now(timezone.utc) + timedelta(hours=1),
          }
          return jwt.encode(payload, "test-supabase-jwt-secret", algorithm="HS256")
      ```

    **Step 2: Fix existing auth tests**
    Tests that reference the old auth patterns (Argon2 hash, custom JWT create/decode) need updating:
    - Tests importing create_access_token, decode_access_token from security.py — update to use verify_supabase_token
    - Tests that call /api/v1/auth/register — mock supabase_admin.auth.admin.create_user
    - Tests that call /api/v1/auth/login — mock supabase_admin.auth.sign_in_with_password
    - Tests that check password hashing — remove (no longer relevant, Supabase handles it)

    **Step 3: Create tests/test_supabase_auth.py**
    New test file:
    - test_verify_supabase_token_valid: Valid JWT returns payload with sub, app_metadata
    - test_verify_supabase_token_expired: Expired JWT returns None
    - test_verify_supabase_token_invalid_signature: Wrong secret returns None
    - test_verify_supabase_token_missing_audience: Missing "authenticated" audience returns None
    - test_get_current_user_extracts_role_from_jwt: Verify role extraction from app_metadata
    - test_get_current_user_extracts_tenant_from_jwt: Verify tenant_id extraction from app_metadata
    - test_register_calls_supabase_create_user: Mock supabase_admin.auth.admin.create_user
    - test_login_calls_supabase_sign_in: Mock supabase_admin.auth.sign_in_with_password
    - test_phone_otp_send: Mock supabase_admin.auth.sign_in_with_otp
    - test_phone_otp_verify: Mock supabase_admin.auth.verify_otp

    **Step 4: Create tests/test_supabase_storage.py**
    - test_upload_file_to_evidence_bucket: Mock storage.from_('evidence').upload()
    - test_upload_file_to_gbv_bucket: Mock storage.from_('gbv-evidence').upload()
    - test_get_signed_url: Mock storage.from_().create_signed_url()
    - test_download_and_upload_media: Mock httpx download + Supabase upload
    - test_storage_service_no_supabase: Raises StorageServiceError when not configured

    **Step 5: Create tests/test_whatsapp_session.py**
    - test_create_whatsapp_session: Creates session with 24hr expiry
    - test_lookup_valid_session: Returns session when not expired
    - test_lookup_expired_session: Returns None when expired
    - test_upsert_session: Updates existing session

    **Step 6: Create tests/test_rls_policies.py** (unit tests, no real DB)
    - test_tenant_filter_defense_in_depth: Verify application-level filter still works
    - test_tenant_filter_raises_on_missing_context: SecurityError on missing tenant
    - test_public_view_excludes_gbv: Verify the SQL view definition excludes is_sensitive=true

    **Step 7: Create tests/test_public_dashboard_supabase.py**
    - test_public_municipalities_hook_queries_view: Verify correct Supabase query
    - test_public_response_times_excludes_gbv: Verify GBV exclusion in query
    - test_public_heatmap_k_anonymity: Verify threshold >= 3

    **Step 8: Fix any broken imports across existing test files**
    Grep for old imports and update:
    - `from src.core.security import create_access_token` -> verify_supabase_token
    - `from src.core.security import get_password_hash` -> remove or mock
    - Any test that imports EventBroadcaster and expects Redis -> update mock
    - Any test that imports StorageService and expects S3 -> update mock
  </action>
  <verify>
    - `pytest tests/ -x --ignore=tests/integration -v` passes all tests
    - `pytest tests/ --co -q | wc -l` shows test count (should be >= 338 + new tests)
    - No import errors: `python -c "import tests.test_supabase_auth; print('OK')"` etc.
  </verify>
  <done>
    All existing tests fixed for Supabase patterns. New test suites for auth, storage, realtime, RLS, WhatsApp sessions, and public dashboard. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete migration — both frontends build, all tests pass</name>
  <action>
    Complete Phase 06.1 Supabase migration verification:
    - Backend: Supabase Auth, Storage, Realtime, RLS policies
    - frontend-dashboard/: Municipal operations dashboard with Supabase Auth + Realtime
    - frontend-public/: Public transparency dashboard with Supabase anon + RLS views
    - Test suite updated and expanded
    - User must enable Custom Access Token Hook in Supabase Dashboard:
      Dashboard -> Auth -> Hooks -> Custom Access Token -> Select "custom_access_token_hook" function
  </action>
  <verify>
    1. Run full test suite: `pytest tests/ -x -v --ignore=tests/integration` — all pass (0 failures)
    2. Build municipal dashboard: `cd frontend-dashboard && npm run build` — succeeds, dist/ created
    3. Build public dashboard: `cd frontend-public && npm run build` — succeeds, dist/ created
    4. Verify no S3 references: `grep -r "boto3" src/` returns 0 results
    5. Verify no Redis in event broadcaster: `grep -r "redis" src/services/event_broadcaster.py` returns 0
    6. Check Supabase connection: `python -c "from src.core.supabase import get_supabase_admin; print('OK')"`
    7. Review .env has all SUPABASE_* variables populated
    8. Custom Access Token Hook enabled in Supabase Dashboard
    Type "approved" to mark Phase 06.1 as complete, or describe any issues
  </verify>
  <done>
    All tests pass, both frontends build, GBV firewall verified, Supabase infrastructure fully integrated. Phase 06.1 complete.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/ -x --ignore=tests/integration` — all pass
2. `cd frontend-dashboard && npm run build` — succeeds
3. `cd frontend-public && npm run build` — succeeds
4. No boto3/S3 references in src/ (storage fully migrated)
5. No Redis references in event_broadcaster.py (realtime fully migrated)
6. Supabase Auth creates users (mock verified in tests)
7. GBV firewall verified at: storage RLS, database RLS, public views, application filter
8. Custom access token hook migration exists
</verification>

<success_criteria>
- All 338+ existing tests pass (no regressions)
- New Supabase-specific tests pass (auth, storage, realtime, RLS, WhatsApp, public)
- Both frontend apps build with zero errors
- No S3 or Redis dependencies in migrated code
- GBV firewall intact at all layers
- Phase 06.1 migration complete
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-postgres-refactor-to-supabase-and-dashboard-separation/06.1-07-SUMMARY.md`
</output>
