# Phase 6.1 UI Design Layer — Research

**Researched:** 2026-02-10
**Scope:** Premium UI design system, animations, landing pages, 3D elements for both dashboards

---

## 1. GSAP + React Integration

### @gsap/react — useGSAP Hook
- **Package:** `@gsap/react` (official)
- **Pattern:** Drop-in replacement for `useEffect()`/`useLayoutEffect()`
- **Automatic cleanup:** All GSAP animations, ScrollTriggers reverted on unmount via `gsap.context()`
- **Scoped selectors:** `{ scope: containerRef }` limits selector queries to descendants
- **Context-safe handlers:** Event handlers need `contextSafe()` wrapper for cleanup tracking

```typescript
import { useRef } from 'react';
import gsap from 'gsap';
import { useGSAP } from '@gsap/react';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

gsap.registerPlugin(useGSAP, ScrollTrigger);

function AnimatedSection() {
  const container = useRef<HTMLDivElement>(null);
  const { contextSafe } = useGSAP({ scope: container });

  useGSAP(() => {
    gsap.from('.hero-text', {
      y: 100, opacity: 0, duration: 1,
      scrollTrigger: { trigger: '.hero-text', start: 'top 80%' }
    });
  }, { scope: container });

  return <div ref={container}>...</div>;
}
```

**Key pattern:** Always use `gsap.context()` cleanup. Never create animations in raw `useEffect`.

Sources: [GSAP React Docs](https://gsap.com/resources/React/), [@gsap/react npm](https://www.npmjs.com/package/@gsap/react)

---

## 2. Lenis Smooth Scroll + GSAP ScrollTrigger

### Integration Pattern
- **Package:** `lenis` v1.3.17 (stable)
- **React binding:** `lenis/react` — provides `<ReactLenis>` wrapper and `useLenis` hook
- **GSAP sync:** Lenis feeds into GSAP ticker, ScrollTrigger.update synced on scroll

```typescript
import Lenis from 'lenis';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

// Initialize Lenis and sync with GSAP
const lenis = new Lenis();
lenis.on('scroll', ScrollTrigger.update);
gsap.ticker.add((time) => lenis.raf(time * 1000));
gsap.ticker.lagSmoothing(0);
```

### React Provider Pattern
```typescript
import { ReactLenis } from 'lenis/react';

function App() {
  return (
    <ReactLenis root options={{ lerp: 0.1, duration: 1.2, smoothWheel: true }}>
      <Routes>...</Routes>
    </ReactLenis>
  );
}
```

### Key Config for Mobile
- `syncTouch: true` — Enable touch inertia smoothing on mobile
- `touchMultiplier: 2` — Increase touch scroll sensitivity
- `lerp: 0.1` — Smooth interpolation (lower = smoother, higher = snappier)

Sources: [Lenis GitHub](https://github.com/darkroomengineering/lenis), [Lenis npm](https://www.npmjs.com/package/lenis)

---

## 3. Barba.js vs React SPA Transitions

### Finding: Barba.js is NOT ideal for React SPAs

Barba.js is designed for multi-page sites (MPA). It intercepts `<a>` clicks and manages DOM replacement between server-rendered pages. In React SPAs with client-side routing, this conflicts with React's virtual DOM.

### Recommended Alternative: GSAP + React Router
Instead of Barba.js, implement the same **color overlay sweep** transition using:
- `react-router-dom` v6 `useLocation` for route changes
- GSAP `timeline` for the overlay animation
- `AnimatePresence`-style wrapper using `useRef` + GSAP

```typescript
// PageTransition.tsx — Color overlay sweep
function PageTransition({ children }: { children: React.ReactNode }) {
  const overlayRef = useRef<HTMLDivElement>(null);
  const location = useLocation();

  useGSAP(() => {
    const tl = gsap.timeline();
    tl.fromTo(overlayRef.current,
      { scaleX: 0, transformOrigin: 'left' },
      { scaleX: 1, duration: 0.5, ease: 'power2.inOut' }
    )
    .fromTo(overlayRef.current,
      { scaleX: 1, transformOrigin: 'right' },
      { scaleX: 0, duration: 0.5, ease: 'power2.inOut' }
    );
  }, { dependencies: [location.pathname] });

  return (
    <>
      <div ref={overlayRef} className="page-overlay" style={{
        position: 'fixed', inset: 0, zIndex: 9999,
        background: 'linear-gradient(135deg, #FF6B4A, #0A0E1A)',
        transformOrigin: 'left', transform: 'scaleX(0)'
      }} />
      {children}
    </>
  );
}
```

**Decision:** Skip Barba.js. Use GSAP page transitions with React Router. Same visual effect, native React integration, zero conflicts.

Sources: [Barba.js GitHub Issue #221](https://github.com/barbajs/barba/issues/221), [React-Barba-Effect](https://github.com/ShyamBhuptani/React-Barba-Effect)

---

## 4. Three.js 3D Globe — South Africa Map

### Library Stack
- **react-three-fiber** (`@react-three/fiber`) — React renderer for Three.js
- **drei** (`@react-three/drei`) — Helpers (OrbitControls, Html, Detailed, etc.)
- **three-globe** or custom geometry — Globe visualization
- **d3-geo** — GeoJSON projection for extruding municipal boundaries

### South Africa GeoJSON Sources
1. **Municipal Demarcation Board (MapIt API)** — REST API serving municipality/ward GeoJSON
   - URL: `https://mapit.code4sa.org/`
2. **SimpleMaps** — Free SA admin boundary GeoJSON/Shapefile
   - URL: `https://simplemaps.com/gis/country/za`
3. **IGISMAP** — KML/GeoJSON for provinces, districts, municipalities
4. **mapscaping.com** — Country-level GeoJSON

### Approach: GeoJSON → Extruded 3D Geometry
```typescript
import { GeoJsonGeometry } from 'three-geojson-geometry';
// or use d3-geo + three.js ExtrudeGeometry

// 1. Load SA municipal GeoJSON
// 2. Project with d3.geoMercator() or d3.geoOrthographic()
// 3. Extrude boundaries into 3D mesh
// 4. Color-code municipalities by service performance
// 5. Add interactive hover/click with raycasting
```

### Mobile Performance Optimizations (CRITICAL)

**Canvas Resolution Scaling:**
```typescript
<Canvas dpr={[1, Math.min(window.devicePixelRatio, 2)]}>
```
- Cap DPR at 2 on mobile (many phones report 3x but 2x is visually identical)

**On-Demand Rendering:**
```typescript
<Canvas frameloop="demand">
```
- Only re-render when scene changes (interaction, animation). Huge battery savings.

**Low-Poly Geometry for Mobile:**
- Simplify GeoJSON with `topojson-simplify` before loading (reduce vertex count by 70%)
- Use `BufferGeometry` instead of `Geometry` (deprecated)
- Keep draw calls under 200

**GPU Tier Detection:**
```typescript
import { getGPUTier } from 'detect-gpu';
const gpuTier = await getGPUTier();
// tier: 0 (low), 1 (mid), 2 (high), 3 (ultra)
// Adjust geometry detail, shadow quality, post-processing based on tier
```

**Shader Precision:**
- Use `mediump` for colors/normals (2x faster than `highp` on mobile GPUs)
- Reserve `highp` for position calculations only

**LOD (Level of Detail):**
```typescript
import { Detailed } from '@react-three/drei';
<Detailed distances={[0, 50, 100]}>
  <HighDetailGlobe />
  <MediumDetailGlobe />
  <LowDetailGlobe />
</Detailed>
```

**Lazy Loading the 3D Scene:**
```typescript
const Globe3D = React.lazy(() => import('./Globe3D'));
// Only load Three.js when globe is in viewport
<Suspense fallback={<GlobeLoadingSkeleton />}>
  <Globe3D />
</Suspense>
```

**WebGPU (2026):** Safari 26+ supports WebGPU. All major browsers now support it. Consider `three/webgpu` renderer for improved mobile GPU performance. R3F supports it experimentally.

Sources: [R3F Scaling Performance](https://r3f.docs.pmnd.rs/advanced/scaling-performance), [100 Three.js Tips 2026](https://www.utsubo.com/blog/threejs-best-practices-100-tips), [three-globe npm](https://www.npmjs.com/package/three-globe)

---

## 5. Shared Design System Between Two Vite Apps

### Approach: Shared Package in Monorepo-lite

Since both apps are in the same repo but independent:

**Option A: Shared CSS Custom Properties (Recommended for tokens)**
```
shared/
  design-tokens.css    # CSS custom properties (colors, spacing, typography)
  animations.css       # Shared animation keyframes
  components/          # Shared React components (if any)
```

Both apps import: `import '../../shared/design-tokens.css'`

**Option B: TypeScript Token Constants**
```typescript
// shared/tokens.ts
export const colors = {
  navy: '#0A0E1A',
  navyLight: '#131829',
  navySurface: '#1A1F3A',
  coral: '#FF6B4A',
  coralHover: '#FF8566',
  teal: '#00D9A6',
  tealHover: '#00F0B8',
  white: '#FFFFFF',
  textPrimary: '#E8E8EC',
  textSecondary: '#9CA3AF',
  textMuted: '#6B7280',
  surfaceElevated: 'rgba(255,255,255,0.05)',
  surfaceHigher: 'rgba(255,255,255,0.08)',
  border: 'rgba(255,255,255,0.1)',
  borderHover: 'rgba(255,255,255,0.2)',
};

export const typography = {
  fontFamily: "'Inter', -apple-system, sans-serif",
  displayFont: "'Clash Display', 'Inter', sans-serif",  // For hero headings
};
```

**Recommendation:** Use BOTH — CSS custom properties for styling, TS constants for component logic. Put in `shared/` directory at repo root.

---

## 6. Dark Mode Dashboard Patterns

### Surface Elevation (Material Design 3 approach)
- **Background:** `#0A0E1A` (deepest navy)
- **Surface 1:** `rgba(255,255,255,0.05)` — cards, panels
- **Surface 2:** `rgba(255,255,255,0.08)` — elevated cards, dropdowns
- **Surface 3:** `rgba(255,255,255,0.11)` — modals, popovers

### Chart Colors for Dark Mode
Use the coral/teal palette with opacity variations:
- Primary series: `#FF6B4A` (coral)
- Secondary series: `#00D9A6` (teal)
- Tertiary: `#A78BFA` (violet accent)
- Quaternary: `#FBBF24` (amber accent)
- Grid lines: `rgba(255,255,255,0.06)`
- Axis text: `#9CA3AF`

### Contrast Requirements (WCAG AA)
- `#E8E8EC` text on `#0A0E1A` bg → 15.2:1 ratio (AAA)
- `#FF6B4A` on `#0A0E1A` → 5.4:1 ratio (AA large text)
- `#00D9A6` on `#0A0E1A` → 8.7:1 ratio (AAA)

### Glow Effects (Jungle-style)
```css
.card-glow {
  box-shadow: 0 0 20px rgba(255, 107, 74, 0.15),
              0 0 60px rgba(255, 107, 74, 0.05);
  border: 1px solid rgba(255, 107, 74, 0.2);
}

.teal-glow {
  box-shadow: 0 0 20px rgba(0, 217, 166, 0.15),
              0 0 60px rgba(0, 217, 166, 0.05);
}
```

---

## 7. anime.js for Micro-Interactions

### Use Cases
- Counter/number animations (stats counting up)
- SVG path morphing (icons, decorative elements)
- Staggered list/card reveal animations
- Loading skeleton pulse effects

```typescript
import anime from 'animejs';

// Counter animation for stats
anime({
  targets: '.stat-number',
  innerHTML: [0, 1247],
  round: 1,
  duration: 2000,
  easing: 'easeOutExpo',
});
```

**Note:** For scroll-driven animations, use GSAP (better ScrollTrigger integration). Use anime.js for standalone micro-interactions where its simpler API is an advantage.

---

## 8. Bundle Size Strategy

### Estimated Bundle Additions
| Package | Size (min+gzip) | Tree-shakeable |
|---------|-----------------|----------------|
| gsap + ScrollTrigger | ~30KB | Partial |
| @gsap/react | ~2KB | Yes |
| three (core) | ~150KB | Yes (import specific) |
| @react-three/fiber | ~40KB | Yes |
| @react-three/drei | Variable | Yes (import specific) |
| lenis | ~8KB | Yes |
| animejs | ~17KB | Yes |
| detect-gpu | ~3KB | Yes |
| **Total** | **~250KB** | — |

### Optimization Strategy
1. **Code-split the 3D globe** — `React.lazy()` + `Suspense`. Three.js only loads when user scrolls to globe section.
2. **Tree-shake Three.js** — Import only needed modules: `import { Mesh, BufferGeometry } from 'three'`
3. **Separate landing page chunk** — Landing page animations in their own chunk, dashboard in another
4. **Preload on idle** — Use `requestIdleCallback` to prefetch 3D assets after initial paint

---

## 9. Public Landing Page — Scroll Storytelling Sections

### Section Breakdown
1. **Hero** — Full-viewport, 3D SA globe slowly rotating, headline text animates in, coral gradient overlay
2. **Problem Statement** — Scroll-triggered text reveal: "Municipal services are broken. Citizens are unheard."
3. **Solution** — Split-screen: left = problem (faded), right = solution (bright). Scroll-linked transition.
4. **Features** — 3 feature cards stagger in: Report, Track, Transparency. Each with icon animation.
5. **Live Stats** — Counter animations: tickets resolved, municipalities onboarded, response time improvement
6. **Municipality Showcase** — Horizontal scroll carousel of pilot municipality cards with glow effects
7. **Dashboard Preview** — Scroll-linked zoom into the actual dashboard data (cross-fade to live dashboard below)

### Mobile Adaptations
- Hero: Globe renders at lower resolution, touch-to-rotate instead of auto-rotate
- Feature cards: Stack vertically instead of 3-column grid
- Horizontal scroll: Convert to vertical stacked cards
- Stats: Trigger counter on viewport enter (IntersectionObserver)

---

## 10. Municipal Dashboard Landing — Branded Login

### Layout
- Full-viewport dark background with subtle animated gradient mesh
- 3D globe (smaller, decorative) on left/background
- Login form (glass-morphism card) centered-right
- SALGA Trust Engine logo + tagline above form
- Supabase Auth form fields: email/phone + password, OTP option

### Animation Sequence
1. Page load: Gradient mesh fades in (0.5s)
2. Globe fades in and begins slow rotation (0.8s)
3. Login card slides up from bottom with slight bounce (1s)
4. Form fields stagger in (1.2s)

---

## RESEARCH COMPLETE

All 8 research areas covered. Key finding: **Replace Barba.js with GSAP page transitions** (Barba doesn't work well with React SPAs). Everything else proceeds as planned.
