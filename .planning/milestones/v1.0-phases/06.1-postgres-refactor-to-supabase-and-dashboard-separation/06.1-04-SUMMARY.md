---
phase: 06.1-postgres-refactor-to-supabase-and-dashboard-separation
plan: 04
subsystem: database-security
tags: [rls, row-level-security, supabase-auth, jwt, multi-tenancy, rbac]
dependency_graph:
  requires:
    - supabase-sdk-installed
    - supabase-client-module
    - supabase-auth-endpoints
    - supabase-jwt-verification
  provides:
    - auth-jwt-rls-policies
    - role-based-ticket-access
    - public-anon-views
    - gbv-database-firewall
  affects:
    - src/core/database.py
    - src/models/base.py
    - src/middleware/tenant_middleware.py
    - alembic/versions/2026_02_11_0915-29fc6e5ac39c_migrate_rls_to_supabase_auth.py
tech_stack:
  added: []
  patterns:
    - auth.jwt() -> app_metadata ->> tenant_id for RLS tenant isolation
    - Role-specific SELECT policies for tickets (manager, ward_councillor, citizen, field_worker, saps_liaison)
    - Public aggregation views for anon role with GBV exclusion
    - K-anonymity threshold >= 3 for heatmap privacy
    - Defense-in-depth: RLS + application-level tenant filter
key_files:
  created:
    - alembic/versions/2026_02_11_0915-29fc6e5ac39c_migrate_rls_to_supabase_auth.py
  modified:
    - src/core/database.py
    - src/models/base.py
    - src/middleware/tenant_middleware.py
decisions:
  - what: Migrate RLS policies from SET LOCAL to auth.jwt() pattern
    why: Supabase Auth injects tenant_id and role into JWT app_metadata via custom access token hook
    impact: All database queries tenant-isolated via JWT claims, no need for SET LOCAL session variables
  - what: Create role-specific ticket SELECT policies
    why: Different roles have different access levels (manager sees all, citizen sees own, SAPS sees GBV)
    impact: RBAC enforced at database level, not just application layer
  - what: Create public views for anon role instead of direct table access
    why: Public dashboard needs aggregated data without PII or GBV tickets
    impact: Anon role has zero direct table access, only to pre-filtered views
  - what: K-anonymity threshold >= 3 for heatmap
    why: Privacy protection per Phase 06-01 decision (prevents location re-identification)
    impact: Only grid cells with 3+ tickets shown on public heatmap
  - what: Keep application-level tenant filter as defense-in-depth
    why: FastAPI backend uses service_role key which bypasses RLS
    impact: Two layers of protection (RLS for client access, app filter for backend)
  - what: Tenant middleware simplified to optional X-Tenant-ID header
    why: With Supabase Auth, tenant context primarily comes from JWT via get_current_user
    impact: Header no longer required for authenticated endpoints, JWT is source of truth
metrics:
  duration_seconds: 316
  duration_minutes: 5.3
  completed_date: 2026-02-11
---

# Phase 06.1 Plan 04: RLS Migration to Supabase Auth Summary

**One-liner:** Migrated Row Level Security policies from SET LOCAL app.current_tenant to Supabase auth.jwt() -> app_metadata pattern, created role-specific ticket policies (manager, ward_councillor, citizen, field_worker, saps_liaison), added public views for anon role with GBV exclusion, removed SET LOCAL from database.py, and updated application-level tenant filter for defense-in-depth.

## Completed Tasks

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Create comprehensive RLS migration with auth.jwt() policies | c27d3a5 | src/core/database.py, alembic/versions/2026_02_11_0915-29fc6e5ac39c_migrate_rls_to_supabase_auth.py |
| 2 | Update application-level tenant filter and tenant middleware | 1991ced | src/models/base.py, src/middleware/tenant_middleware.py |

## What Was Built

### 1. Comprehensive RLS Migration (alembic/versions/2026_02_11_0915-29fc6e5ac39c)

**Migration scope:** 440 lines of SQL creating complete Supabase Auth-based RLS policies.

#### Old Pattern (Phase 1, SET LOCAL)

```sql
-- Set session variable on each transaction
SET LOCAL app.current_tenant = '123e4567-e89b-12d3-a456-426614174000';

-- RLS policy reads session variable
CREATE POLICY tenant_isolation_users ON users
USING (tenant_id = current_setting('app.current_tenant', TRUE));
```

**Problem:** Requires application code to set session variable before every query. Doesn't work with client-side Supabase access (e.g., dashboard using supabase-js).

#### New Pattern (Phase 06.1, auth.jwt())

```sql
-- No session variable needed - JWT is automatically available

-- RLS policy reads JWT app_metadata claims
CREATE POLICY "tenant_select_users" ON users
FOR SELECT TO authenticated
USING (
    tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
);
```

**Benefit:** Works automatically for all authenticated requests. JWT claims injected by custom access token hook (from Plan 01). Client-side and server-side access both work seamlessly.

#### Tenant-Aware Tables (Standard CRUD Policies)

For each of these tables, created SELECT, INSERT, UPDATE, DELETE policies:

- **users** - User accounts
- **consent_records** - POPIA consent tracking
- **media_attachments** - File upload metadata
- **teams** - Municipal service teams
- **ticket_assignments** - Ticket-to-user assignments

**Policy pattern:**
```sql
CREATE POLICY "tenant_select_{table}" ON {table}
FOR SELECT TO authenticated
USING (tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id')));

CREATE POLICY "tenant_insert_{table}" ON {table}
FOR INSERT TO authenticated
WITH CHECK (tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id')));

-- ... UPDATE and DELETE follow same pattern
```

#### Role-Specific Ticket Policies (RBAC at Database Level)

**Tickets table uses role-based SELECT policies** instead of a single tenant policy.

**1. Managers and Admins** - See all tickets in their tenant (except GBV if not admin):
```sql
CREATE POLICY "managers_all_tickets" ON tickets
FOR SELECT TO authenticated
USING (
    tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
    AND (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) IN ('manager', 'admin')
    AND (
        is_sensitive = false
        OR (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) = 'admin'
    )
);
```

**2. Ward Councillors** - See only their ward's tickets (ward filtering to be added when ward_id in JWT):
```sql
CREATE POLICY "ward_councillor_tickets" ON tickets
FOR SELECT TO authenticated
USING (
    tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
    AND (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) = 'ward_councillor'
    AND is_sensitive = false
);
```

**3. Citizens** - See only their own tickets (non-GBV):
```sql
CREATE POLICY "citizen_own_tickets" ON tickets
FOR SELECT TO authenticated
USING (
    tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
    AND (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) = 'citizen'
    AND created_by = (SELECT auth.uid()::text)
    AND is_sensitive = false
);
```

**4. Field Workers** - See tickets assigned to them:
```sql
CREATE POLICY "field_worker_assigned_tickets" ON tickets
FOR SELECT TO authenticated
USING (
    tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
    AND (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) = 'field_worker'
    AND is_sensitive = false
    AND id IN (
        SELECT ticket_id FROM ticket_assignments
        WHERE user_id = (SELECT auth.uid()::text)
        AND is_current = true
    )
);
```

**5. SAPS Liaison** - See only GBV tickets (SEC-05 firewall at DB level):
```sql
CREATE POLICY "saps_gbv_tickets" ON tickets
FOR SELECT TO authenticated
USING (
    is_sensitive = true
    AND tenant_id = (SELECT (auth.jwt() -> 'app_metadata' ->> 'tenant_id'))
    AND (SELECT (auth.jwt() -> 'app_metadata' ->> 'role')) IN ('saps_liaison', 'admin')
);
```

**Critical security:** GBV tickets (`is_sensitive = true`) are **only** accessible to `saps_liaison` and `admin` roles. All other roles are blocked at the database level.

### 2. Public Views for Anon Role

**Defense-in-depth approach:**
1. `REVOKE SELECT ON tickets FROM anon;` - No direct table access
2. Create aggregated views with GBV exclusion
3. `GRANT SELECT` on views only

#### public_ticket_stats (Aggregated, No PII)

```sql
CREATE OR REPLACE VIEW public.public_ticket_stats AS
SELECT
    t.tenant_id as municipality_id,
    m.name as municipality_name,
    t.category,
    t.status,
    t.created_at::date as report_date,
    CASE WHEN t.first_responded_at IS NOT NULL
        THEN EXTRACT(EPOCH FROM (t.first_responded_at - t.created_at)) / 3600
    END as response_hours,
    CASE WHEN t.resolved_at IS NOT NULL
        THEN EXTRACT(EPOCH FROM (t.resolved_at - t.created_at)) / 3600
    END as resolution_hours
FROM tickets t
JOIN municipalities m ON t.tenant_id = m.id::text
WHERE t.is_sensitive = false
    AND m.is_active = true;
```

**What's excluded:**
- GBV tickets (`is_sensitive = false` filter)
- Inactive municipalities
- All PII (citizen name, contact info, exact location, description)

**What's included:**
- Municipality name
- Category (pothole, water, electricity, etc.)
- Status (open, in_progress, resolved)
- Response time metrics
- Resolution time metrics

#### public_municipalities (Municipality List)

```sql
CREATE OR REPLACE VIEW public.public_municipalities AS
SELECT id, name, code, province
FROM municipalities
WHERE is_active = true;
```

**Purpose:** Dropdown/filter for public dashboard.

#### public_heatmap (K-Anonymity >= 3)

```sql
CREATE OR REPLACE VIEW public.public_heatmap AS
SELECT
    ST_Y(ST_SnapToGrid(t.location, 0.01, 0.01)) as lat,
    ST_X(ST_SnapToGrid(t.location, 0.01, 0.01)) as lng,
    COUNT(*) as intensity,
    t.tenant_id as municipality_id
FROM tickets t
JOIN municipalities m ON t.tenant_id = m.id::text
WHERE t.is_sensitive = false
    AND m.is_active = true
    AND t.location IS NOT NULL
GROUP BY ST_SnapToGrid(t.location, 0.01, 0.01), t.tenant_id
HAVING COUNT(*) >= 3;
```

**Privacy protection:**
- `ST_SnapToGrid(location, 0.01, 0.01)` - Snap to ~1km grid cells
- `HAVING COUNT(*) >= 3` - **K-anonymity threshold**
- GBV tickets excluded

**K-anonymity:** Only show grid cells with at least 3 tickets. Prevents location re-identification of individuals. Per Phase 06-01 decision.

### 3. RLS Policy Performance Indexes

**All RLS policy columns indexed:**
```sql
CREATE INDEX IF NOT EXISTS idx_tickets_tenant_id ON tickets(tenant_id);
CREATE INDEX IF NOT EXISTS idx_tickets_is_sensitive ON tickets(is_sensitive);
CREATE INDEX IF NOT EXISTS idx_tickets_created_by ON tickets(created_by);
CREATE INDEX IF NOT EXISTS idx_tickets_status ON tickets(status);
CREATE INDEX IF NOT EXISTS idx_users_tenant_id ON users(tenant_id);
CREATE INDEX IF NOT EXISTS idx_teams_tenant_id ON teams(tenant_id);
CREATE INDEX IF NOT EXISTS idx_consent_records_tenant_id ON consent_records(tenant_id);
CREATE INDEX IF NOT EXISTS idx_media_attachments_tenant_id ON media_attachments(tenant_id);
CREATE INDEX IF NOT EXISTS idx_ticket_assignments_tenant_id ON ticket_assignments(tenant_id);
```

**Performance:** RLS policies add WHERE clauses to every query. Indexes ensure these filters are fast.

### 4. Database.py SET LOCAL Removal

**Before:**
```python
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with AsyncSessionLocal() as session:
        try:
            tenant_id = get_tenant_context()
            if tenant_id:
                await session.execute(
                    text("SET LOCAL app.current_tenant = :tenant_id"),
                    {"tenant_id": tenant_id}
                )
            yield session
        finally:
            await session.close()
```

**After:**
```python
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """Dependency for getting async database sessions.

    With Supabase Auth, RLS policies read tenant_id and role directly from
    JWT claims via auth.jwt() -> 'app_metadata'. No need to set session variables.

    IMPORTANT: The FastAPI backend uses service_role key which bypasses RLS.
    Defense-in-depth tenant filtering happens at the application level in
    base.py add_tenant_filter (see src/models/base.py).

    For client-side access (e.g., dashboard using supabase-js), the anon key
    is used and RLS policies are enforced automatically.
    """
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()
```

**Key insight:** FastAPI backend uses `service_role` key (admin), which **bypasses RLS**. Application-level filtering in `base.py` is the defense-in-depth layer for backend queries.

### 5. Application-Level Tenant Filter Update (base.py)

**Updated SecurityError message** to reflect Supabase Auth flow:

```python
if tenant_id is None:
    raise SecurityError(
        "Tenant context not set for tenant-aware query - potential data leakage. "
        "This is a security violation. Ensure tenant_id is present in JWT "
        "app_metadata claims (for authenticated requests) or tenant context is "
        "set via get_current_user dependency."
    )
```

**Before:** Referenced `X-Tenant-ID` header.
**After:** References JWT `app_metadata` claims.

**Defense-in-depth maintained:** RLS policies + application-level filter.

### 6. Tenant Middleware Simplification

**Added phone OTP endpoints to excluded paths:**
```python
EXCLUDED_PATHS = {
    "/api/v1/auth/login",
    "/api/v1/auth/register",
    "/api/v1/auth/refresh",
    "/api/v1/auth/otp/send",      # NEW
    "/api/v1/auth/otp/verify",    # NEW
    "/health",
    "/docs",
    "/redoc",
    "/openapi.json",
}
```

**Updated middleware logic:**
- X-Tenant-ID header is now **optional** (backward compatibility)
- If header provided, validate and set context
- If header missing, tenant context set by `get_current_user` from JWT
- Cleanup tenant context after each request (prevents cross-request contamination)

**Updated docstring:**
```python
"""Middleware to manage tenant context for the request lifecycle.

With Supabase Auth, tenant_id primarily comes from JWT app_metadata claims
via get_current_user dependency (see src/api/deps.py). This middleware
provides backward compatibility and handles special cases:

1. For authenticated endpoints: tenant context set by get_current_user from JWT
2. For WhatsApp webhook: tenant resolved from phone-to-user lookup
3. For public endpoints: no tenant context required
4. Backward compatibility: Still reads X-Tenant-ID header if present
"""
```

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

All verification commands passed:

1. **Migration created:** `alembic heads` → `29fc6e5ac39c (head)`
2. **Database.py imports:** `python -c "from src.core.database import get_db; print('OK')"` → OK
3. **No SET LOCAL:** `grep -c "SET LOCAL" src/core/database.py` → 0
4. **Base.py imports:** `python -c "from src.models.base import TenantAwareModel; print('OK')"` → OK
5. **Tenant middleware imports:** `python -c "from src.middleware.tenant_middleware import TenantContextMiddleware; print('OK')"` → OK

## Security Architecture

### Two Access Patterns

**1. Client-Side Access (Dashboard using supabase-js)**
- Uses `anon` key
- RLS policies enforced automatically
- JWT contains `app_metadata` with `tenant_id` and `role`
- Database reads JWT claims directly via `auth.jwt()`
- No application code needed for tenant isolation

**2. Server-Side Access (FastAPI backend)**
- Uses `service_role` key (admin)
- **RLS is bypassed**
- Application-level filtering in `base.py` provides defense-in-depth
- Tenant context set by `get_current_user` from JWT
- ORM queries automatically filtered via `add_tenant_filter` event listener

### Defense-in-Depth Layers

1. **Database RLS policies** - First line of defense (client-side access)
2. **Application-level filtering** - Second line of defense (server-side access)
3. **RBAC at DB level** - Role-specific ticket policies
4. **GBV firewall at DB level** - `is_sensitive` filter in all non-SAPS policies
5. **Public views with GBV exclusion** - Anon role has zero direct table access

### SEC-05 GBV Firewall (Database Layer)

**All role policies exclude GBV tickets:**
- `managers_all_tickets`: `is_sensitive = false` (unless admin)
- `ward_councillor_tickets`: `is_sensitive = false`
- `citizen_own_tickets`: `is_sensitive = false`
- `field_worker_assigned_tickets`: `is_sensitive = false`

**Only SAPS and Admin see GBV tickets:**
- `saps_gbv_tickets`: `is_sensitive = true AND role IN ('saps_liaison', 'admin')`

**Result:** Even if application code has a bug, GBV tickets are inaccessible to non-SAPS roles at the database level.

## Impact on System

### Enables Client-Side Data Access

**Before:** Only FastAPI backend could query database (needed custom JWT + SET LOCAL).

**After:** Dashboard can query database directly using supabase-js client. RLS policies enforce tenant isolation and RBAC automatically.

**Benefit:** Real-time subscriptions, client-side filtering, reduced server load.

### Simplifies Authentication Flow

**Before:**
1. Get JWT from custom auth endpoint
2. Extract tenant_id from JWT
3. Set X-Tenant-ID header on every request
4. Backend calls `SET LOCAL app.current_tenant = tenant_id`
5. RLS policies read session variable

**After:**
1. Get JWT from Supabase Auth
2. JWT contains tenant_id and role in app_metadata
3. RLS policies read JWT claims directly
4. No session variable needed

**Benefit:** Fewer moving parts, less error-prone, works for client and server.

### Public Dashboard Ready

**Views created:**
- `public.public_ticket_stats` - Aggregated metrics
- `public.public_municipalities` - Municipality list
- `public.public_heatmap` - K-anonymity protected location data

**Anon role can:**
- View aggregated statistics
- See municipality performance
- View heatmap (with privacy protection)

**Anon role cannot:**
- Access raw ticket data
- See GBV tickets
- See PII (names, contact info, exact locations)

### RBAC Enforced at Database

**Before:** RBAC enforced in FastAPI endpoints only.

**After:** RBAC enforced at database level via role-specific SELECT policies.

**Benefit:** Even if application code bypasses endpoint checks, database enforces RBAC.

## Next Steps for Phase 06.1

- **Plan 05**: Dashboard refactor to use supabase-js client
- **Plan 06**: Remove FastAPI backend endpoints replaced by client-side queries
- **Plan 07**: Add Supabase Realtime subscriptions to dashboard
- **Plan 08**: Premium UI component library integration
- **Plan 09**: Dashboard visual design overhaul

## Self-Check: PASSED

**Created files exist:**
```
✓ FOUND: alembic/versions/2026_02_11_0915-29fc6e5ac39c_migrate_rls_to_supabase_auth.py
```

**Modified files exist:**
```
✓ FOUND: src/core/database.py
✓ FOUND: src/models/base.py
✓ FOUND: src/middleware/tenant_middleware.py
```

**Commits exist:**
```
✓ FOUND: c27d3a5 (feat(06.1-04): migrate RLS policies to Supabase auth.jwt() pattern)
✓ FOUND: 1991ced (feat(06.1-04): update application-level tenant filter for Supabase JWT)
```

All claims verified. Summary accurately reflects completed work.
