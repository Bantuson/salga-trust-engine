---
phase: 06-public-transparency-rollout
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/package.json
  - frontend/src/pages/PublicDashboardPage.tsx
  - frontend/src/components/public/ResponseTimeChart.tsx
  - frontend/src/components/public/ResolutionRateChart.tsx
  - frontend/src/components/public/HeatmapViewer.tsx
  - frontend/src/components/public/MunicipalitySelector.tsx
  - frontend/src/services/publicApi.ts
  - frontend/src/types/public.ts
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Public dashboard page is accessible via hash route without login"
    - "Public dashboard displays average response times per municipality as bar chart"
    - "Public dashboard displays resolution rates per municipality with trend lines"
    - "Public dashboard displays geographic heatmap of reported issues using Leaflet"
    - "User can filter by municipality using dropdown selector"
    - "Public dashboard shows system summary with total tickets (sensitive count is system-wide only)"
    - "No authentication token is sent with any public API request"
  artifacts:
    - path: "frontend/src/pages/PublicDashboardPage.tsx"
      provides: "Public dashboard page with all visualizations"
      min_lines: 50
    - path: "frontend/src/components/public/HeatmapViewer.tsx"
      provides: "Leaflet heatmap component with react-leaflet v5"
      contains: "MapContainer"
    - path: "frontend/src/components/public/ResponseTimeChart.tsx"
      provides: "Response time bar chart using Recharts"
      contains: "BarChart"
    - path: "frontend/src/components/public/ResolutionRateChart.tsx"
      provides: "Resolution rate chart with trends using Recharts"
      contains: "LineChart"
    - path: "frontend/src/services/publicApi.ts"
      provides: "API client for public endpoints (no auth headers)"
    - path: "frontend/src/types/public.ts"
      provides: "TypeScript interfaces for public metrics data"
  key_links:
    - from: "frontend/src/pages/PublicDashboardPage.tsx"
      to: "frontend/src/services/publicApi.ts"
      via: "fetch calls for public metrics"
      pattern: "publicApi"
    - from: "frontend/src/services/publicApi.ts"
      to: "/api/v1/public/*"
      via: "fetch to public API endpoints"
      pattern: "/api/v1/public/"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/PublicDashboardPage.tsx"
      via: "hash-based routing"
      pattern: "#public"
---

<objective>
Build the public transparency dashboard frontend with interactive charts and geographic heatmap.

Purpose: Citizens can view municipal performance metrics (TRNS-01, TRNS-02, TRNS-03) without login (TRNS-04) via response time charts, resolution rate trends, and a Leaflet heatmap. No sensitive data is displayed (TRNS-05).

Output: PublicDashboardPage with Recharts visualizations, Leaflet heatmap, municipality selector, and public API client.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-public-transparency-rollout/06-RESEARCH.md
@.planning/phases/06-public-transparency-rollout/06-01-SUMMARY.md

# Frontend patterns from Phase 5
@frontend/src/App.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install map dependencies, create public API client, types, and chart components</name>
  <files>
    frontend/package.json
    frontend/src/types/public.ts
    frontend/src/services/publicApi.ts
    frontend/src/components/public/MunicipalitySelector.tsx
    frontend/src/components/public/ResponseTimeChart.tsx
    frontend/src/components/public/ResolutionRateChart.tsx
  </files>
  <action>
**Step 1: Install Leaflet dependencies:**
```bash
cd frontend && npm install react-leaflet@5 leaflet@1.9 react-leaflet-heatmap-layer-v3 leaflet.heat @types/leaflet
```

**Step 2: Create TypeScript types** in `frontend/src/types/public.ts`:
```typescript
export interface Municipality {
  id: string;
  name: string;
  code: string;
  province: string;
}

export interface ResponseTimeData {
  municipality_id: string;
  municipality_name: string;
  avg_response_hours: number;
  ticket_count: number;
}

export interface MonthlyTrend {
  month: string;  // "2026-01"
  rate: number;
}

export interface ResolutionRateData {
  municipality_id: string;
  municipality_name: string;
  resolution_rate: number;
  total_tickets: number;
  resolved_tickets: number;
  trend: MonthlyTrend[];
}

export interface HeatmapPoint {
  lat: number;
  lng: number;
  intensity: number;
}

export interface SystemSummary {
  total_municipalities: number;
  total_tickets: number;
  total_sensitive_tickets: number;
}
```

**Step 3: Create public API client** in `frontend/src/services/publicApi.ts`:
- Use plain `fetch()` (NOT axios with auth interceptors).
- **Critical: NO Authorization header.** These are unauthenticated requests (TRNS-04).
- Base URL: `/api/v1/public`
- Functions: `getMunicipalities()`, `getResponseTimes(municipalityId?)`, `getResolutionRates(municipalityId?, months?)`, `getHeatmapData(municipalityId?)`, `getSystemSummary()`
- All return typed promises matching the types above.
- Handle errors gracefully (return empty arrays/default objects on failure, log to console).

**Step 4: Create MunicipalitySelector component** in `frontend/src/components/public/MunicipalitySelector.tsx`:
- Dropdown `<select>` element with "All Municipalities" as default option.
- Fetches municipality list from `publicApi.getMunicipalities()` on mount.
- Props: `selectedId: string | null`, `onChange: (id: string | null) => void`.
- Style consistently with existing dashboard components.

**Step 5: Create ResponseTimeChart** in `frontend/src/components/public/ResponseTimeChart.tsx`:
- Use Recharts `<BarChart>` (already in stack from Phase 5).
- X-axis: municipality name. Y-axis: average response hours.
- Props: `data: ResponseTimeData[]`, `isLoading: boolean`.
- Show "Loading..." state and "No data available" empty state.
- Color bars with gradient (lower is better: green for <24h, amber for 24-72h, red for >72h).

**Step 6: Create ResolutionRateChart** in `frontend/src/components/public/ResolutionRateChart.tsx`:
- Use Recharts `<BarChart>` for overall rates AND `<LineChart>` for monthly trends.
- Bar chart: X-axis municipality name, Y-axis resolution rate percentage.
- Line chart: X-axis month, Y-axis rate percentage (shown when single municipality selected).
- Props: `data: ResolutionRateData[]`, `isLoading: boolean`.
- Color coding: green >=80%, amber >=60%, red <60%.
  </action>
  <verify>
Run: `cd frontend && npm run build`
Build succeeds with no TypeScript errors. All new files exist and compile.
  </verify>
  <done>
Leaflet packages installed. TypeScript types defined for all public metrics. Public API client uses fetch without auth headers. MunicipalitySelector, ResponseTimeChart, and ResolutionRateChart components created with Recharts. Frontend builds successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HeatmapViewer component, PublicDashboardPage, and wire up routing</name>
  <files>
    frontend/src/components/public/HeatmapViewer.tsx
    frontend/src/pages/PublicDashboardPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
**Step 1: Create HeatmapViewer** in `frontend/src/components/public/HeatmapViewer.tsx`:
- Import `MapContainer`, `TileLayer` from `react-leaflet`.
- Import `HeatmapLayer` from `react-leaflet-heatmap-layer-v3`.
- Import Leaflet CSS: `import 'leaflet/dist/leaflet.css'` (critical for tiles to render).
- Props: `municipalityId?: string`.
- Fetch heatmap data from `publicApi.getHeatmapData(municipalityId)` on mount and when municipalityId changes.
- Map center: `[-29.0, 24.0]` (South Africa center), zoom: 6.
- TileLayer: OpenStreetMap tiles (free, no API key).
- HeatmapLayer config:
  - `longitudeExtractor: (p) => p.lng`
  - `latitudeExtractor: (p) => p.lat`
  - `intensityExtractor: (p) => p.intensity`
  - `radius: 25`, `blur: 15`, `max: 10`
  - Gradient: blue -> lime -> yellow -> red
- Show loading overlay while fetching.
- Show "No heatmap data available" when points array empty.
- Fixed height container (500px) for the map.

**Step 2: Create PublicDashboardPage** in `frontend/src/pages/PublicDashboardPage.tsx`:
- Layout: Header banner ("Municipal Transparency Dashboard"), system summary cards, municipality selector, then charts grid.
- On mount: fetch system summary and all metrics.
- State: `selectedMunicipality: string | null`, all data states.
- When municipality selection changes, re-fetch response times and resolution rates for that municipality.
- Section 1: **Summary Cards** — Total municipalities, total tickets, total sensitive (system-wide only per TRNS-05).
- Section 2: **MunicipalitySelector** dropdown.
- Section 3: **ResponseTimeChart** — Bar chart of avg response hours.
- Section 4: **ResolutionRateChart** — Bar chart + trend lines.
- Section 5: **HeatmapViewer** — Geographic heatmap.
- Style: Clean, professional, public-facing. Light background. Consistent with existing dashboard aesthetics.
- Include a footer note: "GBV/sensitive reports are excluded from this dashboard to protect victims' privacy."

**Step 3: Wire up App.tsx routing:**
- Import `PublicDashboardPage` in `App.tsx`.
- Add `#public` hash route alongside existing `#dashboard`, `#tickets`, `#report`.
- Add "Public Dashboard" nav link.
- Default to `#public` for the public-facing route (or keep `#dashboard` as default for authenticated users).
- Render `<PublicDashboardPage />` when hash is `#public`.
  </action>
  <verify>
Run: `cd frontend && npm run build`
Build succeeds. All components compile. No TypeScript errors.
Verify App.tsx includes #public route. Verify HeatmapViewer imports leaflet CSS.
  </verify>
  <done>
HeatmapViewer renders Leaflet map with heatmap layer. PublicDashboardPage assembles all visualizations with municipality selector. App.tsx has #public route. Frontend builds successfully. Public dashboard accessible without login.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` -- succeeds with no errors
2. All new components exist: PublicDashboardPage, HeatmapViewer, ResponseTimeChart, ResolutionRateChart, MunicipalitySelector
3. Public API client uses fetch without Authorization header
4. App.tsx routes to PublicDashboardPage on #public hash
5. Leaflet CSS imported for proper tile rendering
6. No sensitive data displayed — privacy note in footer
</verification>

<success_criteria>
- Frontend builds with zero TypeScript errors
- Public dashboard page displays response times, resolution rates, and heatmap
- All data fetched via unauthenticated public API endpoints
- Municipality selector allows filtering
- Heatmap uses Leaflet with OpenStreetMap tiles
- Privacy notice about GBV exclusion visible on page
</success_criteria>

<output>
After completion, create `.planning/phases/06-public-transparency-rollout/06-02-SUMMARY.md`
</output>
