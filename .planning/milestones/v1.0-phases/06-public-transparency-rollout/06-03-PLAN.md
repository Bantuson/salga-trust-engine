---
phase: 06-public-transparency-rollout
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - scripts/seed_pilot_municipalities.py
  - tests/test_gbv_firewall_public.py
  - tests/test_public_metrics_service.py
  - tests/test_public_api.py
autonomous: true

must_haves:
  truths:
    - "Pilot municipality seed script creates municipality, manager user, teams, and SLA configs"
    - "Seed script is idempotent (re-running does not create duplicates)"
    - "GBV/sensitive tickets are excluded from ALL public endpoints (verified by dedicated tests)"
    - "Full test suite passes across all 6 phases with no regressions"
    - "Public API endpoints return 200 without authentication token"
    - "Frontend builds successfully with all Phase 6 components"
  artifacts:
    - path: "scripts/seed_pilot_municipalities.py"
      provides: "Pilot municipality onboarding seed script"
      contains: "onboard_municipality"
    - path: "tests/test_gbv_firewall_public.py"
      provides: "Dedicated GBV exclusion tests for public dashboard"
      contains: "is_sensitive"
  key_links:
    - from: "scripts/seed_pilot_municipalities.py"
      to: "src/models/municipality.py"
      via: "Municipality model creation"
      pattern: "Municipality"
    - from: "tests/test_gbv_firewall_public.py"
      to: "src/services/public_metrics_service.py"
      via: "GBV firewall verification"
      pattern: "is_sensitive.*False"
---

<objective>
Create pilot municipality onboarding script, comprehensive GBV firewall tests for public dashboard, and full regression verification across all 6 phases.

Purpose: Complete Phase 6 by ensuring pilot municipalities can be onboarded (success criteria 5), GBV data exclusion is rigorously tested (TRNS-05), and full test suite passes with no regressions (success criteria 6).

Output: Seed script, GBV firewall test suite, full regression check passing.
</objective>

<execution_context>
@C:/Users/Bantu/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bantu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-public-transparency-rollout/06-RESEARCH.md
@.planning/phases/06-public-transparency-rollout/06-01-SUMMARY.md
@.planning/phases/06-public-transparency-rollout/06-02-SUMMARY.md

# Models and services to test against
@src/models/municipality.py
@src/models/ticket.py
@src/models/user.py
@src/services/public_metrics_service.py
@src/api/v1/public.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pilot municipality onboarding seed script</name>
  <files>scripts/seed_pilot_municipalities.py</files>
  <action>
Create `scripts/seed_pilot_municipalities.py` following the research pattern with these improvements:

**Idempotency:** Before creating, check if municipality with same `code` already exists. If so, print message and skip (do NOT raise error or create duplicate). Use `SELECT WHERE code = ?` check.

**CLI interface:**
```bash
python scripts/seed_pilot_municipalities.py --municipality "City of Cape Town" --code "CPT" --province "Western Cape" --contact "cpt@example.com"
```

Also support `--seed-all` flag that creates 5 pre-configured pilot municipalities:
1. City of Cape Town (CPT, Western Cape) - metro
2. eThekwini Municipality (ETH, KwaZulu-Natal) - metro
3. City of Tshwane (TSH, Gauteng) - metro
4. Msunduzi Local Municipality (MSZ, KwaZulu-Natal) - local
5. Drakenstein Municipality (DRK, Western Cape) - local

**For each municipality, create:**
1. Municipality record (name, code, province, is_active=True)
2. Default manager user: `manager@{code.lower()}.gov.za` with temporary password `ChangeMe123!` (Argon2 hashed)
3. Default teams: Water Services, Roads & Infrastructure, Electricity, Waste Management, Sanitation, General Services, SAPS GBV Liaison (with is_saps=True)
4. Default SLA configs (follow existing SLAConfig model patterns from Phase 4):
   - Water critical: 2h response, 24h resolution
   - Water high: 4h response, 48h resolution
   - Electricity critical: 1h response, 12h resolution
   - Roads high: 8h response, 72h resolution

**Import patterns:**
- Use `src.core.database.AsyncSessionLocal` for database connection.
- Use `src.core.security.get_password_hash` for Argon2 password hashing.
- Use `asyncio.run()` with Windows compatibility (WindowsSelectorEventLoopPolicy).

**Output:** Print summary of what was created, including manager credentials and next steps.

**Note:** This script is NOT tested automatically (it requires a real database). It is operational tooling for deployment. Include clear docstring and usage instructions.
  </action>
  <verify>
Run: `python -c "import scripts.seed_pilot_municipalities"` -- imports without error (validates syntax).
Or: `python -m py_compile scripts/seed_pilot_municipalities.py` -- compiles without error.
Verify script has --seed-all and single-municipality modes.
Verify idempotency check (SELECT before INSERT).
  </verify>
  <done>
Seed script creates municipality, manager, teams, and SLA configs. Idempotent (skips existing). Supports --seed-all for 5 pilot municipalities. Uses Argon2 password hashing. Prints summary with credentials and next steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GBV firewall public tests and run full regression suite</name>
  <files>tests/test_gbv_firewall_public.py</files>
  <action>
Create `tests/test_gbv_firewall_public.py` with dedicated GBV exclusion verification for public dashboard (following pattern from `tests/test_gbv_firewall.py` in Phase 4):

**Test cases for PublicMetricsService:**
1. `test_response_times_excludes_sensitive_tickets` — Mock db with both sensitive and non-sensitive tickets. Verify only non-sensitive included in avg response time calculation. Inspect query WHERE conditions for `is_sensitive == False`.
2. `test_resolution_rates_excludes_sensitive_tickets` — Same pattern for resolution rates.
3. `test_heatmap_excludes_sensitive_locations` — Verify sensitive ticket locations never appear in heatmap data.
4. `test_system_summary_sensitive_count_is_system_wide_only` — Verify sensitive count is a single number (system total), not broken down per municipality. This prevents inference of which municipalities have GBV reports.
5. `test_active_municipalities_no_contact_info` — Verify contact_email is NOT in public municipality response.

**Test cases for Public API endpoints:**
6. `test_public_endpoints_no_auth_required` — Hit all 5 public endpoints without Authorization header, verify 200 responses.
7. `test_response_times_endpoint_shape` — Verify response structure matches contract.
8. `test_heatmap_endpoint_shape` — Verify response structure matches contract.

**Test naming convention:** Prefix all with `test_gbv_firewall_public_` for clear audit trail.

**After writing tests, run full regression:**
```bash
python -m pytest tests/ -v --tb=short
```

Verify:
- All Phase 6 tests pass (test_public_metrics_service.py, test_public_api.py, test_gbv_firewall_public.py)
- All Phase 1-5 tests still pass (310 existing tests)
- Zero failures
- Count total tests

Also verify frontend builds:
```bash
cd frontend && npm run build
```
  </action>
  <verify>
Run: `python -m pytest tests/ -v --tb=short`
All tests pass. Zero failures. Count: 310 + new Phase 6 tests.

Run: `cd frontend && npm run build`
Build succeeds with no errors.

Verify: `grep -r "is_sensitive" tests/test_gbv_firewall_public.py` -- confirms GBV firewall tested.
  </verify>
  <done>
GBV firewall tested at all public layers (service and API). All public endpoints verified accessible without auth. Full regression suite passes across all 6 phases. Frontend builds. Phase 6 is COMPLETE.
  </done>
</task>

</tasks>

<verification>
1. `python -m py_compile scripts/seed_pilot_municipalities.py` -- compiles
2. `python -m pytest tests/test_gbv_firewall_public.py -v` -- all GBV tests pass
3. `python -m pytest tests/ -v --tb=short` -- full suite passes, zero failures
4. `cd frontend && npm run build` -- builds with no errors
5. Total test count >= 320 (310 existing + Phase 6 additions)
6. No regressions in Phase 1-5 tests
</verification>

<success_criteria>
- Seed script can onboard 5 pilot municipalities with teams, SLA configs, and manager accounts
- GBV firewall tests verify exclusion at public service and API layers
- Full test suite passes with zero failures
- Frontend builds successfully
- Phase 6 success criteria met: public dashboard, GBV exclusion, pilot onboarding ready
</success_criteria>

<output>
After completion, create `.planning/phases/06-public-transparency-rollout/06-03-SUMMARY.md`
</output>
